<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Complete Member Header Design</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: #f5f5f5;
            height: 100vh;
            display: flex;
            overflow-x: hidden;
            min-width: 0; /* Allow flex items to shrink */
        }

        /* Sidebar */
        .sidebar {
              width: 260px;
                background: #fff;
                color: #e0e0e0;
                display: flex;
                flex-direction: column;
                transition: width 0.3s ease;
                flex-shrink: 0;
                z-index: 1000;
                position: relative; /* Add this */
                border-right: 1px solid #d2d2d2;
        }
       
        .sidebar.collapsed {
            width: 80px;
        }

        .logo-area {
           display: flex;
            align-items: center;
            overflow: hidden;
            flex-grow: 1;
            padding-left: 4px; /* Small padding for alignment */
        }

           .sidebar.collapsed .logo-area {
            justify-content: center; /* This vertically aligns the logo */
            padding-left: 0;
        }

        .logo-img {
            height: 34px; /* Increased size for expanded view */
            width: auto;
            object-fit: contain;
            transition: all 0.3s ease;
            flex-shrink: 0;
        }

         .sidebar.collapsed .logo-img {
             height: 24px; /* Increased size for collapsed view */
            width: 24px;
        }
        .logo {
            width: 32px;
            height: 32px;
            background: white;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: #353182;
            font-size: 14px;
            flex-shrink: 0;
        }

        .logo-text {
            font-weight: 600;
            opacity: 1;
            transition: opacity 0.2s ease;
        }

         .sidebar.collapsed .logo-text {
            opacity: 0;
        }

        .toggle-sidebar-btn {
          background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: #353182;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: transform 0.3s ease, background-color 0.2s;
            flex-shrink: 0; /* This prevents the button from being squeezed */
        }
       
        .toggle-sidebar-btn:hover {
             background: rgba(255, 255, 255, 0.2);
        }

        .sidebar.collapsed .toggle-sidebar-btn {
            transform: rotate(180deg);
        }

        .user-profile {
            padding: 20px;
            display: flex;
            align-items: center;
            gap: 12px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            cursor: pointer;
            flex-shrink: 0;
        }
       
        .sidebar.collapsed .user-profile {
            justify-content: center;
        }
       
        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #e0e0e0;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #353182;
            font-weight: bold;
            flex-shrink: 0;
        }
       
        .user-details {
            flex: 1;
            overflow: hidden;
            white-space: nowrap;
            opacity: 1;
            transition: opacity 0.2s;
        }

        .sidebar.collapsed .user-details, .sidebar.collapsed .profile-arrow {
            display: none;
        }

        .user-name {
            font-weight: 600;
            color: white;
        }
       
        .user-role {
            font-size: 12px;
            opacity: 0.7;
        }

        .sidebar-nav {
            flex: 1;
            overflow-y: auto;
            padding: 10px 0;
        }

        .sidebar-nav::-webkit-scrollbar { width: 6px; }
        .sidebar-nav::-webkit-scrollbar-track { background: transparent; }
        .sidebar-nav::-webkit-scrollbar-thumb { background: rgba(255, 255, 255, 0.2); border-radius: 3px; }
        .sidebar-nav::-webkit-scrollbar-thumb:hover { background: rgba(255, 255, 255, 0.3); }
       
        .nav-item {
            display: flex;
            align-items: center;
            padding: 12px 20px;
            margin: 4px 10px;
            border-radius: 6px;
            cursor: pointer;
            transition: background-color 0.2s, color 0.2s;
            gap: 16px;
            font-size: 14px;
            font-weight: 400;
            white-space: nowrap;
            color: #353182;
            text-decoration: none;
        }
       
        .sidebar.collapsed .nav-item {
            justify-content: center;
        }

        .nav-icon {
            width: 16px;
            height: 16px;
            flex-shrink: 0;
        }

         .nav-text {
            opacity: 1;
            transition: opacity 0.2s;
            flex: 1;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
       
        .nav-text, .nav-arrow {
            opacity: 1;
            transition: opacity 0.2s;
            flex: 1;
        }

        .sidebar.collapsed .sidebar-header {
            flex-direction: column;
            align-items: center;
            gap: 12px;
            height: auto;
            padding-bottom: 12px;
        }

        .toggle-sidebar-btn .icon-collapse { display: block; }
        .toggle-sidebar-btn .icon-expand { display: none; }

        .sidebar.collapsed .toggle-sidebar-btn .icon-collapse { display: none; }
        .sidebar.collapsed .toggle-sidebar-btn .icon-expand { display: block; }

        /* Also, remove the transform from the collapsed button state */
        .sidebar.collapsed .toggle-sidebar-btn {
            transform: none; /* Remove the old rotation */
        }

        .sidebar.collapsed .nav-text, .sidebar.collapsed .nav-arrow {
            display: none;
        }

        .nav-item:hover {
            background-color: rgba(255, 255, 255, 0.1);
            color: white;
        }
        .nav-arrow { text-align: right; }
       
        .nav-item.active {
            background-color: white;
            color: #ff8c00; /* Orange color for active text */
        }
       
        .nav-item.active .nav-icon {
             color: #ff8c00; /* Orange color for active icon */
        }

        .nav-arrow {
            text-align: right;
        }
       
        .accordion-toggle {
            padding: 0;
            margin: 4px 10px;
        }
       
        .sub-menu {
             display: none;
            padding-left: 10px;
            margin: 0 10px;
            max-height: 240px; /* Sets a fixed height for the content area */
            overflow-y: auto; /* Adds a scrollbar only when needed */
        }

        .sub-menu::-webkit-scrollbar { width: 6px; }
        .sub-menu::-webkit-scrollbar-track { background: rgba(0,0,0,0.1); }
        .sub-menu::-webkit-scrollbar-thumb { background: rgba(255, 255, 255, 0.3); border-radius: 3px; }
        .sub-menu::-webkit-scrollbar-thumb:hover { background: rgba(255, 255, 255, 0.4); }

         .accordion-toggle.open > .nav-link .nav-arrow svg {
             transform: rotate(180deg);
        }

        .accordion-toggle.open .sub-menu { display: block; }
       
        .nav-item.open .sub-menu {
            display: block;
        }

        .nav-item.open > .nav-link .nav-arrow svg {
             transform: rotate(180deg);
        }
       
        .sub-menu .nav-item {
            padding-left: 36px;
            font-size: 13px;
            position: relative;
        }
       
        .sub-menu .nav-item:before { /* Connection line */
            content: '';
            position: absolute;
            left: 25px;
            top: -12px;
            height: 38px;
            border-left: 1px solid rgba(255,255,255,0.2);
        }
         .sub-menu .nav-item:first-child:before {
            top: 0;
            height: 20px;
         }

        .sidebar-footer {
            padding: 10px 0;
            border-top: 1px solid #d2d2d2;
            flex-shrink: 0;
        }

        .config-search-wrapper {
            padding: 10px 20px;
        }

        .config-search-input {
             width: 100%;
            background: rgba(0,0,0,0.2);
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 4px;
            padding: 8px 28px;
            color: white;
            font-size: 12px;
            outline: none;
        }
       
        .config-search-input::placeholder {
            color: rgba(255,255,255,0.5);
        }

        .sidebar-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 20px;
            height: 65px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            flex-shrink: 0;
            border-bottom: 1px solid #d2d2d2;
        }

        .nav-item {
            color: #353182; /* Makes icons visible */
            text-decoration: none;
        }

        .nav-item:hover, .nav-item.active {
            background-color: #353182;
            opacity: 1;
        }

        /* Main Content Area */
        /* Main Content Area */
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: #f5f5f5;
            min-width: 0;
            min-height: 0;
            overflow-y: auto;
            height: 100vh;
            box-sizing: border-box;
            transition: padding-right 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 1;
        }
        /* Push main content left when AI panel is open */
        body.ai-panel-open .main-content {
            padding-right: 440px;
        }
        .main-content > *:not(.app-header):not(.ai-copilot-panel):not(.ai-copilot-trigger) {
            box-sizing: border-box;
            max-width: 100%;
        }

        /* App Header */
        .app-header {
            background: white;
            border-bottom: 1px solid #e1e5e9;
            padding: 12px 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
        }

        .breadcrumb {
            font-size: 14px;
            color: #666;
        }

        .app-actions {
            display: flex;
            gap: 12px;
            align-items: center;
            font-size: 12px;
            color: #666;
        }

        /* === COMPLETE MEMBER HEADER === */
        .accordion-toggle .nav-arrow svg {
            transition: transform 0.3s ease;
        }

        .accordion-toggle.open .nav-arrow svg {
            transform: rotate(90deg);
        }
        .member-header-container {
            background: none;
            margin: 16px 0 0;
            padding: 0 16px;
            transition: all 0.3s ease;
            min-width: 0;
            box-sizing: border-box;
            width: 100%;
        }

        /* Scalable Alert Banner */
        .alert-banner {
            background: linear-gradient(90deg, #fff3cd 0%, #ffeaa7 100%);
            border: 1px solid #ffc107;
            padding: 10px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 12px;
            font-weight: 500;
            color: #856404;
            border-radius: 8px 8px 0 0;
            animation: pulse-subtle 3s infinite;
        }

        @keyframes pulse-subtle {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.9; }
        }

        .alert-content {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .alert-icon {
            width: 16px;
            height: 16px;
            color: #ffc107;
            flex-shrink: 0;
        }

        .alert-action-btn:hover {
            color: #2a2666;
        text-decoration: none;
        }

        /* Collapsed State */
        .member-header-collapsed {
            padding: 16px 20px;
            cursor: pointer;
            transition: background-color 0.2s;
            position: relative;
        }

        .member-header-content {
            align-items: flex-start;
            justify-content: space-between;
            gap: 16px;
            width: 100%;
            /* padding-right: 60px; */
        }

        .member-header-collapsed:hover {
            background: #fafbfc;
        }

        .member-header-container.expanded .member-header-collapsed {
            border-bottom: 1px solid #e9ecef;
            background: white;
        }

        .member-header-container.expanded .member-header-collapsed:hover {
            background: #fafbfc;
        }

        /* Primary Info - Better Structure */
        .member-primary {
             flex: 1;
            display: flex;
            flex-direction: column;
            gap: 12px;
            min-width: 0;
        }

        .member-name-row {
            display: flex;
            align-items: baseline;
            justify-content: space-between;
            /* margin-bottom: 24px; */
            width: 100%;
        }

        .member-name-section {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .member-identifiers {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
            color: #666;
            font-weight: 500;
        }

        .member-identifiers .separator {
            color: #ccc;
            font-weight: normal;
        }

        .member-notes-section {
            display: flex;
            align-items: center;
        }

        .member-name {
            font-size: 20px;
            font-weight: 600;
            color: #1a1a1a;
        }

        .member-age {
            color: #666;
        }

        .member-medicaid, .member-mrn {
            color: #333;
        }


        /* Status Items */
        .status-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .status-disabled {
            color: #999;
            font-style: italic;
            font-size: 12px;
        }

        .status-pending {
            color: #f59e0b;
        }

        .status-active {
            color: #10b981;
        }

        .status-completed {
            color: #3b82f6;
        }

        /* Risk Tier Badge */
        .risk-tier-badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .risk-tier-badge.tier-0 { background: #f3f4f6; color: #374151; }
        .risk-tier-badge.tier-1 { background: #fef3c7; color: #d97706; }
        .risk-tier-badge.tier-2 { background: #fed7aa; color: #ea580c; }
        .risk-tier-badge.tier-3 { background: #fecaca; color: #dc2626; }

        /* Tag Containers */
        .tag-container {
            display: flex;
            flex-wrap: wrap;
            gap: 4px;
        }

        .priority-tag, .program-tag {
            padding: 2px 6px;
            border-radius: 8px;
            font-size: 10px;
            font-weight: 500;
            text-decoration: none;
            cursor: pointer;
            transition: all 0.2s;
        }

        .priority-tag:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .priority-tag.diabetes { background: #dbeafe; color: #1d4ed8; }
        .priority-tag.frailty { background: #e0e7ff; color: #6366f1; }
        .priority-tag.hypertension { background: #fef3c7; color: #d97706; }

        .program-tag.tcm { background: #353182; color: white; }
        .program-tag.diabetes-mgmt { background: #dcfce7; color: #166534; }
        .program-tag.care-mgmt { background: #f3e8ff; color: #7c3aed; }

        /* Assessment and Care Plan Links */
        .assessment-link, .care-plan-link {
             color: #353182;
                text-decoration: none;
                font-weight: 500;
                font-size: 12px;
                border-bottom: 1px dashed #353182;
                max-width: 120px; /* Limit width */
                overflow: hidden;
                text-overflow: ellipsis;
                white-space: nowrap;
                display: inline-block;
                vertical-align: top;
        }

        .assessment-link:hover, .care-plan-link:hover {
            color: #2a2666;
            border-bottom-style: solid;
            /* Show full text on hover */
            overflow: visible;
            white-space: normal;
            max-width: 200px;
            z-index: 10;
            position: relative;
            background: white;
            padding: 2px 4px;
            border-radius: 4px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .multi-item-container {
            display: flex;
            flex-direction: column;
            gap: 3px;
        }

        .item-with-status {
             display: flex;
            align-items: center;
            justify-content: space-between;
            font-size: 12px;
            min-height: 20px; /* Ensure consistent height */
        }

        .status-badge {
            padding: 2px 6px;
            border-radius: 8px;
            font-size: 9px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .more-link {
            color: #353182;
            font-size: 11px;
            text-decoration: underline;
            cursor: pointer;
            font-weight: 500;
        }


        .more-link:hover {
                color: #2a2666;
                text-decoration: none;
            }

            /* Summary count styling */
            .summary-line {
                font-size: 11px;
                color: #666;
                font-weight: 600;
                margin-bottom: 4px;
            }

        .status-badge.in-progress { background: #fbbf24; color: #92400e; }
        .status-badge.completed { background: #10b981; color: white; }
        .status-badge.planned { background: #e5e7eb; color: #374151; }
        .status-badge.active { background: #3b82f6; color: white; }
        /* Aligned Key Info */
        .member-key-info {
            display: flex;
            flex-direction: column;
            gap: 16px;
            font-size: 12px;
            max-width: 820px;
            width: 100%;
        }

        .key-info-item {
             display: flex;
            flex-direction: column;
            gap: 2px;
            align-items: flex-start;
        }

        .key-info-item:hover .copy-icon {
            opacity: 1;
        }

        .key-info-label {
            text-transform: uppercase;
            letter-spacing: 0.3px;
            font-size: 12px;
            color: #666;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .key-info-value {
            display: flex;
            align-items: center;
            gap: 2px;
        }

        .copy-icon {
             width: 14px;
            height: 14px;
            color: #666;
            cursor: pointer;
            opacity: 0;
            transition: opacity 0.2s, color 0.2s;
            background: none;
            border: none;
            padding: 2px;
            border-radius: 3px;
            flex-shrink: 0;
        }
        .info-row:hover .copy-icon {
            opacity: 1;
        }
        .copy-icon:hover {
            color: #353182;
            background: #f1f3f4;
        }

        .copy-icon svg {
            width: 100%;
            height: 100%;
        }

        .copy-feedback {
            font-size: 10px;
            color: #28a745;
            font-weight: 500;
            opacity: 0;
            transition: opacity 0.2s;
            position: absolute;
            right: 0;
            top: 100%;
            white-space: nowrap;
        }

        .copy-feedback.show {
            opacity: 1;
        }
        /* Status Section - Only Consent Status */
        .member-status {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 8px;
            flex-shrink: 0; /* Prevent shrinking */
        }

        .status-badge {
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 10px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.3px;
        }

        .status-warning {
            background: #fff3cd;
            color: #856404;
            animation: pulse-warning 2s infinite;
        }

        @keyframes pulse-warning {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        /* Toggle Section */
        .member-toggle {
            position: absolute;
            top: 16px;
            right: 20px;
            z-index: 10;
        }

        .toggle-text {
            display: none; /* Remove the "Details" text */

        }

        .toggle-btn {
             background: none;
            border: none;
            color: #666;
            cursor: pointer;
            padding: 6px;
            border-radius: 4px;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }

        .toggle-btn:hover {
            background: #f1f3f4;
            color: #353182;
        }

        .member-header-container.key-info-hidden .toggle-btn::after {
            content: '';
            position: absolute;
            top: 2px;
            right: 2px;
            width: 4px;
            height: 4px;
            background: #ff8c00;
            border-radius: 50%;
        }


        .alert-view-toggle {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 4px 8px;
            font-size: 10px;
            cursor: pointer;
            color: #484581;
            margin-right: 8px;
            transition: all 0.2s;
        }

        .alert-view-toggle:hover {
            background: #e9ecef;
            border-color: #484581;
        }

        .toggle-icon {
            width: 18px;
            height: 18px;
            transition: transform 0.3s ease;
        }

        .member-header-container.expanded .toggle-icon {
            transform: rotate(180deg);
        }

        /* Expanded State */
        .member-header-expanded {
            display: none;
            padding: 20px;
        }

        .member-header-container.expanded .member-header-expanded {
            display: block;
        }

        /* Information Grid */
        .member-info-grid {
             display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 40px;
            margin-bottom: 20px;
        }

        .info-section {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .section-title {
            font-size: 13px;
            color: #353182;
            font-weight: 600;
            margin-bottom: 8px;
            padding-bottom: 6px;
            border-bottom: 2px solid #353182;
            text-transform: uppercase;
            letter-spacing: 0.3px;
        }

        .info-row {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 24px;
            align-items: start;
        }

        .info-row:last-child {
            border-bottom: none;
        }

        .info-label {
            font-size: 11px;
            color: #666;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.3px;
            min-width: 100px;
        }

        .info-value {
            font-size: 13px;
            color: #333;
            font-weight: 500;
            text-align: right;
            flex: 1;
        }

        .info-value.highlight {
            color: #ffc107;
            font-weight: 600;
        }
        .info-value-container {
            display: flex;
            align-items: center;
            gap: 8px;
            flex: 1;
            justify-content: flex-end;
        }
        .consent-status {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .consent-icon {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #ff8c00;
            flex-shrink: 0;
            margin-right: 6px;
        }

        .info-value.highlight {
             color: #ff8c00;
            font-weight: 600;
            display: flex;
            align-items: center;
        }


        .assign-manager-link {
            color: #353182;
            text-decoration: underline;
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
            background: none;
            border: none;
            padding: 0;
            transition: color 0.2s;
            text-align: left;
        }

        .assign-manager-link:hover {
            color: #2a2666;
            text-decoration: none;
        }

        /* Progress Indicators */
        .progress-section {
            margin-bottom: 20px;
            padding: 12px 16px;
            background: #f8f9fa;
            border-radius: 6px;
            border-left: 4px solid #353182;
        }

        .progress-title {
            font-size: 12px;
            color: #353182;
            font-weight: 600;
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 0.3px;
        }

        .progress-indicators {
            display: flex;
            gap: 16px;
            flex-wrap: wrap;
        }

        .progress-item {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 11px;
            font-weight: 500;
        }

        .progress-icon {
            width: 14px;
            height: 14px;
        }

        .progress-pending {
            color: #ffc107;
        }

        .progress-in-progress {
            color: #0066cc;
        }

        .progress-completed {
            color: #28a745;
        }

        /* Action Buttons */
        .member-actions {
            display: flex;
            justify-content: center;
            gap: 10px;
            padding: 16px 0 0;
            border-top: 1px solid #e9ecef;
        }

        .action-btn {
            padding: 8px 16px;
            border-radius: 5px;
            font-size: 12px;
            font-weight: 500;
            border: none;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .action-btn.primary {
            background: #353182;
            color: white;
        }

        .action-btn.primary:hover {
            background: #2a2666;
        }

        .action-btn.warning {
            background: #ffc107;
            color: #212529;
        }

        .action-btn.warning:hover {
            background: #e0a800;
        }

        .action-btn.secondary {
            background: white;
            color: #353182;
            border: 1px solid #d1d5db;
        }

        .action-btn.secondary:hover {
            border-color: #353182;
            background: #f9fafb;
        }

        .btn-icon {
            width: 14px;
            height: 14px;
        }

        .assign-manager-btn {
            background: #353182;
            color: white;
            border: none;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 10px;
            font-weight: 500;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .assign-manager-btn:hover {
            background: #2a2666;
        }

        .care-manager-section {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            gap: 4px;
        }

        /* Content Area */
        .page-content {
            flex: 1;
            background: white;
            margin: 16px 16px 16px;
            padding-bottom: 100px;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            border: 1px solid #e1e5e9;
            box-sizing: border-box;
        }

        .content-tabs {
            display: flex;
            border-bottom: 1px solid #e1e5e9;
            overflow-x: auto;
            border-radius: 8px;
        }

        .tab {
            padding: 12px 20px;
            font-size: 13px;
            font-weight: 500;
            color: #666;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            white-space: nowrap;
            transition: all 0.2s;
        }

        .tab.active {
            color: #353182;
            border-bottom-color: #353182;
            background: #f8f9fa;
        }

        .tab:hover:not(.active) {
            color: #353182;
            background: #fafbfc;
        }

        .tab-content {
            padding: 24px;
            min-height: 400px;
        }

        .content-placeholder {
            text-align: center;
            color: #666;
            padding: 40px 20px;
        }

        .care-manager-value {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .assign-manager-link {
            color: #353182;
            text-decoration: underline;
            cursor: pointer;
            font-size: 12px;
            font-weight: 500;
            background: none;
            border: none;
            padding: 0;
            transition: color 0.2s;
        }

        .assign-manager-link:hover {
            color: #2a2666;
            text-decoration: none;
        }

        .alert-banner-container {
            position: relative;
            border-radius: 8px 8px 0 0;
            overflow: hidden;
        }

        .alert-slider {
            display: flex;
            transition: transform 0.5s ease;
            width: 100%;
        }

        .alert-item {
            min-width: 100%;
            background: linear-gradient(90deg, #fff3cd 0%, #ffeaa7 100%);
            border: 1px solid #ffc107;
            padding: 10px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 12px;
            font-weight: 500;
            color: #856404;
            animation: pulse-subtle 3s infinite;
        }

        .alert-item.adt-event {
            background: linear-gradient(90deg, #d1ecf1 0%, #bee5eb 100%);
            border-color: #17a2b8;
            color: #0c5460;
        }

        .alert-item.priority-population {
            background: linear-gradient(90deg, #f8d7da 0%, #f5c6cb 100%);
            border-color: #dc3545;
            color: #721c24;
        }

        .alert-item.care-plan {
            background: linear-gradient(90deg, #d4edda 0%, #c3e6cb 100%);
            border-color: #28a745;
            color: #155724;
        }

        .alert-content {
            display: flex;
            align-items: center;
            gap: 8px;
            flex: 1;
        }

        .alert-icon {
            width: 16px;
            height: 16px;
            flex-shrink: 0;
        }

        .alert-actions {
             display: flex;
            align-items: center;
            gap: 12px;
           
            position: relative;
        }

        .alert-action-btn {
             color: #484581;
            text-decoration: underline;
            font-size: 11px;
            font-weight: 500;
            background: none;
            border: none;
            cursor: pointer;
            padding: 0;
            transition: color 0.2s;
        }

        /* Slider Controls */
        .slider-controls {
          display: flex;
        align-items: center;
        gap: 4px;
        margin-right: 10px;
        }

        .alert-banner-container:hover .slider-controls {
            opacity: 1;
        }

        .slider-nav {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.7);
            border: 1px solid rgba(0,0,0,0.2);
            color: inherit;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            font-size: 12px;
            font-weight: bold;
        }

        .slider-nav:hover {
            background: rgba(255, 255, 255, 0.9);
            transform: scale(1.1);
        }

        .slider-nav:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }


        /* Auto-slide animation */
        @keyframes slide-progress {
            0% { width: 0%; }
            100% { width: 100%; }
        }

        .slide-progress {
            position: absolute;
            bottom: 0;
            left: 0;
            height: 2px;
            background: rgba(255, 255, 255, 0.8);
            animation: slide-progress 5s linear infinite;
        }

        .app-search {
            display: flex;
            align-items: center;
            background: #f8f9fa;
            padding: 0px 12px;
            border-radius: 6px;
            border: 1px solid #e1e5e9;
            min-width: 300px;
            color: #666;
        }

        .notification-btn {
            position: relative;
            background: none;
            border: none;
            cursor: pointer;
            padding: 8px;
            border-radius: 6px;
            color: #666;
            transition: all 0.2s;
        }

        .notification-btn:hover {
            background: #f1f3f4;
            color: #353182;
        }

        .notification-count {
            position: absolute;
            top: 4px;
            right: 4px;
            background: #dc3545;
            color: white;
            border-radius: 50%;
            width: 16px;
            height: 16px;
            font-size: 10px;
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .breadcrumb-container {
            padding: 12px 24px;
            background: white;
            border-bottom: 1px solid #e1e5e9;
            font-size: 14px;
            color: #666;
        }

        /* Notification Drawer */
        .notification-drawer {
            position: fixed;
            top: 0;
            right: -400px;
            width: 400px;
            height: 100vh;
            background: white;
            box-shadow: -2px 0 10px rgba(0, 0, 0, 0.1);
            z-index: 1000;
            transition: right 0.3s ease;
            display: flex;
            flex-direction: column;
        }

        .notification-drawer.open {
            right: 0;
        }

        .notification-header {
            padding: 20px;
            border-bottom: 1px solid #e1e5e9;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .notification-list {
            flex: 1;
            overflow-y: auto;
        }

        .notification-item {
            padding: 16px 20px;
            border-bottom: 1px solid #f1f3f4;
            cursor: pointer;
            transition: background-color 0.2s;
            display: flex;
            gap: 12px;
        }

        .notification-item:hover {
            background: #f8f9fa;
        }

        .notification-item.unread {
            background: #f8f9ff;
            border-left: 3px solid #353182;
        }

        .notification-content {
            display: flex;
             flex: 1;
            gap: 12px;
        }

        .notification-icon {
            width: 32px;
            height: 32px;
            background: #e9ecef; /* Standard neutral background */
            border-radius: 50%;   /* Circular icon holder */
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            color: #353182;      /* Use primary color for the SVG icon */
        }

        .notification-text {
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .notification-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: auto; /* Pushes footer to the bottom */
            padding-top: 4px;
        }


        .notification-title {
            font-weight: 600;
            font-size: 13px;
            color: #333;
            margin-bottom: 4px;
        }

        .notification-desc {
            font-size: 12px;
            color: #666;
            margin-bottom: 6px;
        }

        .notification-time {
            font-size: 11px;
            color: #999;
        }

        .notification-item {
            padding: 16px 20px;
            border-bottom: 1px solid #f1f3f4;
            cursor: pointer;
            transition: background-color 0.2s;
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            gap: 12px;
        }

        .notification-content {
            display: flex;
            gap: 12px;
            flex: 1;
        }

        .notification-cta {
            background: none;
            color: #353182;
            border: none;
            padding: 0;
            font-size: 11px;
            font-weight: 600;
            cursor: pointer;
            text-decoration: underline;
            transition: color 0.2s;
        }

        .notification-cta:hover {
            color: #2a2666;
            text-decoration: none;
            background: none;
        }

        .notification-item.unread .notification-cta {
            color: #2a2666;
            font-weight: 600;
        }

        .notification-item.unread .notification-cta:hover {
            background: #c82333;
        }

        /* === ADD THIS CSS to your <style> tag === */
        .nav-item {
            color: #353182; /* Makes icons visible */
            text-decoration: none;
        }

        .accordion-toggle > .nav-link:hover {
            background-color: #353182;
            color: #fff;
        }

        .accordion-toggle > .nav-link {
             display: flex;
             align-items: center;
             width: 100%;
             gap: 16px;
             padding: 12px 20px;
             border-radius: 6px;
             transition: background-color 0.2s, color 0.2s;
             color: #353182;
             text-decoration: none;
             font-size: 14px;
             font-weight: 400;
        }

        .flyout-menu {
            position: absolute;
            left: 80px;
            background-color: white;
            color: #333;
            border-radius: 8px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            padding: 8px;
            z-index: 1001;
            display: none;
            border: 1px solid #e1e5e9;
            min-width: 220px;
            max-height: 80vh;
            overflow-y: auto;
        }

        .flyout-menu.show {
            display: block;
        }

        .flyout-menu .nav-item {
            color: #333;
            margin: 2px 0;
            padding: 10px 15px;
        }

        .flyout-menu .nav-item:hover {
            background-color: #f1f3f4;
            color: #353182;
        }
       
        .flyout-menu .config-search-input {
            background: #f1f3f4;
            border-color: #e1e5e9;
            color: #333;
        }
        .flyout-menu .config-search-input::placeholder {
            color: #666;
        }

         .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: #f5f5f5;
            min-width: 0;
            overflow: auto; /* Changed from hidden */
        }

        /* ADD these two new rules */
        .app-header {
            position: sticky;
            top: 0;
            z-index: 999;
        }
        .breadcrumb-container {
            position: sticky;
            top: 65px; /* Height of the app-header */
            z-index: 998;
        }

        /* Responsive */
        @media (max-width: 1200px) {
            .member-info-grid {
                grid-template-columns: 1fr 1fr;
                gap: 24px;
            }
        }

        @media (max-width: 1024px) {
            .member-primary {
                flex-direction: column;
                align-items: flex-start;
                gap: 8px;
            }
           
             .member-key-info {
                grid-template-columns: repeat(2, 1fr);
                grid-template-rows: repeat(3, auto);
                gap: 10px 16px;
            }
            .info-row {
                grid-template-columns: repeat(2, 1fr);
                gap: 20px;
            }
        }

        @media (max-width: 768px) {
            .member-info-grid {
                grid-template-columns: 1fr;
                gap: 16px;
            }
           
            .progress-indicators {
                justify-content: center;
            }

            .sidebar {
                width: 200px;
                min-width: 180px;
            }
           
           .member-key-info {
                grid-template-columns: 1fr;
                grid-template-rows: auto;
                gap: 8px;
            }
           
            .member-header-container {
                margin: 16px 0 0;
                padding: 0 12px;
            }

            .member-header-collapsed {
                flex-direction: column;
                align-items: flex-start;
                gap: 12px;
            }
           
            .member-toggle, .member-status {
                margin-top: 0;
                align-self: flex-end;
            }
            .info-row {
                grid-template-columns: 1fr;
                gap: 12px;
            }
        }

        /* === REPLACE your existing dashboard CSS with this block === */
       /* === REPLACE your existing dashboard CSS with this block === */
        .dashboard-grid {
            display: grid ;
            grid-template-columns: 1fr 1fr;
            gap: 24px;
         
        }

        .dashboard-widget {
            background: #fff;
            border: 1px solid #e1e5e9;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
            display: flex;
            flex-direction: column;
        }
       
        .dashboard-widget.full-width {
            grid-column: 1 / -1;
        }

        .widget-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 16px;
            border-bottom: 1px solid #e1e5e9;
        }
       
        .widget-header.dark {
            color: #000;
            border-bottom: 1px solid #484581;
            border-radius: 8px 8px 0 0;
            padding: 12px 16px;
        }
       
        .widget-content {
            padding: 16px;
            flex: 1;
        }
       
        .widget-header.dark + .widget-content {
            padding-top: 16;
        }
       
        .widget-content.scrollable {
            max-height: 250px;
            overflow-y: auto;
        }

        .actions-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        .actions-list a {
            color: #484581;
            text-decoration: none;
            font-size: 13px;
            font-weight: 500;
        }
        .actions-list a:hover {
            text-decoration: underline;
        }

        .info-message {
            background: #e9ecef;
            border-radius: 6px;
            padding: 16px;
            font-size: 13px;
            color: #495057;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .info-message svg {
            flex-shrink: 0;
            color: #6c757d;
        }

        .dashboard-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
        }

        .dashboard-table th, .dashboard-table td {
            padding: 12px 10px;
            text-align: left;
            border-bottom: 1px solid #e9ecef;
        }

        .dashboard-table thead {
            background: #f8f9fa;
        }
       
        .widget-header.dark + .widget-content .dashboard-table thead {
            background: #484581;
        }

        .dashboard-table th {
            font-weight: 600;
            font-size: 12px;
            color: #495057;
        }
       
        .widget-header.dark + .widget-content .dashboard-table th {
            color: #fff;
             border-bottom: none;
        }

        .dashboard-table a {
            color: #484581;
            text-decoration: none;
            font-weight: 500;
        }
        .dashboard-table a:hover {
            text-decoration: underline;
        }

        .pagination {
            display: flex;
            justify-content: flex-end;
            align-items: center;
            gap: 20px;
            font-size: 12px;
            color: #6c757d;
            padding-top: 16px;
        }
        .pagination button {
            background: #fff;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            width: 24px;
            height: 24px;
            cursor: pointer;
        }
        .pagination button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .vertical-tabs-widget .widget-content {
            padding: 0;
        }

        .vertical-tabs-container {
            display: flex;
            border-top: 1px solid #e1e5e9;
        }

        .vertical-tabs-nav {
            width: 200px;
            flex-shrink: 0;
            border-right: 1px solid #e1e5e9;
            padding: 16px 0;
        }

        .vertical-tab {
            padding: 10px 20px;
            font-size: 13px;
            font-weight: 500;
            color: #495057;
            cursor: pointer;
            border-left: 3px solid transparent;
        }

        .vertical-tab.active {
            background: #f8f9ff;
            color: #484581;
            border-left-color: #ff8c00;
        }
       
        .vertical-tabs-content {
            flex: 1;
            padding: 16px;
        }

        .tab-pane-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }
        .tab-pane-header h4 {
            font-size: 16px;
            font-weight: 600;
            color: #343a40;
        }

        .search-filter-area { display: flex; gap: 8px; }
        .search-box { position: relative; }
        .search-box input {
            border: 1px solid #ced4da;
            border-radius: 4px;
            padding: 6px 10px 6px 30px;
            font-size: 13px;
        }
        .search-box svg {
            position: absolute;
            left: 8px;
            top: 50%;
            transform: translateY(-50%);
            color: #6c757d;
        }
        .filter-btn, .clear-btn {
            border: 1px solid #ced4da;
            background: #fff;
            border-radius: 4px;
            padding: 6px 12px;
            font-size: 13px;
            cursor: pointer;
        }

        .filters-area {
            display: flex;
            align-items: center;
            gap: 8px;
            background: #f8f9fa;
            padding: 12px;
            border-radius: 6px;
            margin-bottom: 16px;
            font-size: 12px;
        }
       
        .filter-tag {
            background: #fff;
            border: 1px solid #ced4da;
            border-radius: 12px;
            padding: 4px 8px;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .filter-tag button {
            border: none;
            background: none;
            cursor: pointer;
            font-size: 14px;
            color: #6c757d;
        }


        /* === MEMBER DETAILS FORM STYLES === */
        .member-details-form {
            padding: 24px;
        }
        .form-section {
            border: 1px solid #e1e5e9;
            border-radius: 8px;
            margin-bottom: 24px;
            padding: 20px;
        }
        .form-section .section-title {
            font-size: 16px;
            font-weight: 600;
            color: #333;
            margin-bottom: 20px;
            padding-bottom: 24px;
            border-bottom: 1px solid #e1e5e9;
        }
        .form-section .section-title.secondary {
            margin-top: 24px;
            font-size: 14px;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 20px 30px;
        }
        .form-grid.cols-4 { grid-template-columns: repeat(4, 1fr); }
        .form-field {
            display: flex;
            flex-direction: column;
        }
        .form-field.col-span-2 { grid-column: span 2; }

        .form-field label, .form-grid > div > label {
            font-size: 12px;
            color: #666;
            margin-bottom: 6px;
            font-weight: 500;
        }
       
        .form-grid > div > span {
            font-size: 14px;
            font-weight: 500;
        }
       
        .form-field input, .form-field select {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #ced4da;
            border-radius: 4px;
            font-size: 14px;
        }
        .form-field input:disabled, .form-field select:disabled {
            background-color: #f1f3f4;
            cursor: not-allowed;
        }

        .multi-select-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            padding: 8px;
            border: 1px solid #ced4da;
            border-radius: 4px;
            min-height: 38px;
        }
        .multi-select-tags span {
            background-color: #e9ecef;
            border-radius: 4px;
            padding: 4px 8px;
            font-size: 13px;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .multi-select-tags button {
            border: none;
            background: none;
            cursor: pointer;
            font-size: 14px;
            color: #6c757d;
        }

        .consent-status-box {
            border: 1px solid #e1e5e9;
            border-radius: 6px;
            padding: 16px;
            margin-top: 20px;
            display: flex;
            justify-content: center;
            gap: 24px;
        }

        .radio-option {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
            cursor: pointer;
        }
        .radio-option input {
            width: 16px;
            height: 16px;
        }

        .link {
            color: #484581;
            text-decoration: none;
            font-size: 13px;
            font-weight: 500;
        }
        .link:hover { text-decoration: underline; }

        .form-actions {
            display: flex;
            justify-content: center;
            gap: 12px;
            padding-top: 20px;
            border-top: 1px solid #e1e5e9;
        }

        .btn {
            padding: 10px 24px;
            border-radius: 4px;
            font-size: 14px;
            font-weight: 600;
            border: 1px solid transparent;
            cursor: pointer;
        }
        .btn-primary {
            background-color: #484581;
            color: white;
        }
        .btn-secondary {
            background-color: white;
            color: #495057;
            border-color: #ced4da;
        }
        /* === ADD THIS CSS FOR NEW MEMBER DETAILS SECTIONS === */
        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .section-title.no-border {
            border-bottom: none;
            margin-bottom: 0;
            padding-bottom: 0;
        }

        .btn:disabled {
            background-color: #f1f3f4;
            border-color: #e1e5e9;
            color: #adb5bd;
            cursor: not-allowed;
        }
       
        .form-field textarea {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #ced4da;
            border-radius: 4px;
            font-size: 14px;
            font-family: inherit;
        }

        .security-tags-list {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }
        .tag-row {
            display: grid;
            grid-template-columns: 150px 1fr 2fr;
            align-items: center;
            font-size: 13px;
        }
        .tag-label {
            font-weight: 500;
            color: #666;
        }


        /* Option 2: Condensed Alert Strip */
        .alert-option-toggle {
            position: absolute;
            top: 50%;
            right: 20px;
            transform: translateY(-50%);
            background: rgba(255, 255, 255, 0.9);
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 4px 8px;
            font-size: 10px;
            cursor: pointer;
            z-index: 1003; /* Higher z-index to stay on top */
        }

        .notes-section-wrapper {
            margin-left: auto; /* Pushes the entire notes group to the right */
            display: flex;
            align-items: center;
            gap: 8px; /* Space between separator, text, and icon */
        }

        .separator {
            width: 1px;
            height: 24px;
            background-color: #dee2e6; /* A standard border color from your design */
            margin-right: 4px;
        }

        .notes-text-label {
            font-weight: 600;
            color: #666;
            font-size: 11px;
        }

        .alert-strip {
            display: flex;
            padding: 12px 20px;
            background: #fff8dc;
            border-bottom: 1px solid #f0e68c;
            gap: 12px;
            flex-wrap: wrap;
            align-items: center;
        }

        .alert-strip.active {
            display: flex;
        }

        .alert-chip {
            display: flex;
            align-items: center;
            gap: 6px;
            background: rgba(255, 255, 255, 0.8);
            border: 1px solid #ddd;
            border-radius: 16px;
            padding: 6px 12px;
            font-size: 11px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .alert-chip:hover {
            background: white;
            transform: translateY(-1px);
        }

        .alert-chip.expanded {
            background: #353182;
            color: white;
        }

        .alert-chip-icon {
            width: 16px !important;
            height: 16px !important;
            flex-shrink: 0;
            display: block;
            min-width: 16px;
            min-height: 16px;
            overflow: visible;
            transition: all 0.2s;
        }

        .expanded-content-wrapper {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
        }

        .expanded-text {
            flex: 1;
            padding-right: 20px;
            font-size: 12px;
        }

        .expanded-actions {
            display: flex;
            align-items: center;
            gap: 16px;
            flex-shrink: 0;
        }

        .alert-action-link {
            color: #484581;
            text-decoration: underline;
            font-size: 12px;
            font-weight: 500;
            background: none;
            border: none;
            cursor: pointer;
            transition: color 0.2s;
        }

        .alert-action-link:hover {
            color: #2a2666;
            text-decoration: none;
        }

        .alert-close-btn {
            background: none;
            border: none;
            font-size: 22px; /* Slightly larger for easier clicking */
            line-height: 1;
            cursor: pointer;
            color: #6c757d;
            padding: 4px;
            width: 28px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: all 0.2s;
            order: 2; /* Ensures it's the last item in the actions list */
        }

        .alert-close-btn:hover {
            color: #333;
            background: rgba(0,0,0,0.1);
        }

        .alert-expanded-content {
            display: none;
            padding: 16px 20px;
            background: #fff;
            border-bottom: 1px solid #e1e5e9;
            border-left: 4px solid #353182;
        }

        .alert-expanded-content.show {
            display: block;
        }

        /* Modified slider for option 1 */
        .alert-banner-container.option1 .alert-item {
            background: #fff8dc !important;
            border-color: #f0e68c !important;
            color: #8b7355 !important;
        }

        .alert-banner-container.option1 .alert-item.adt-event,
        .alert-banner-container.option1 .alert-item.priority-population,
        .alert-banner-container.option1 .alert-item.care-plan {
            background: #fff8dc !important;
            border-color: #f0e68c !important;
            color: #8b7355 !important;
        }

        /* Alert count indicator */
        .alert-count-indicator {
            position: absolute;
            top: 50%;
            right: 60px; /* Position next to arrow controls */
            transform: translateY(-50%);
            background: rgba(255, 255, 255, 0.9);
            border: 1px solid rgba(0,0,0,0.1);
            border-radius: 12px;
            padding: 4px 8px;
            font-size: 10px;
            font-weight: 600;
            color: #666;
            z-index: 10;
        }

        /* Read/Unread status indicator */
        .alert-status-indicator {
             width: 6px;
            height: 6px;
            border-radius: 50%;
            background: #ff8c00;
            position: absolute;
            top: 6px;
            left: 6px;
            transition: opacity 0.2s;
        }

        .alert-chip {
            position: relative;
            display: flex;
            align-items: center;
            gap: 8px;
            background: rgba(255, 255, 255, 0.8);
            border: 1px solid #ddd;
            border-radius: 16px;
            padding: 8px 12px 8px 20px;
            font-size: 11px;
            cursor: pointer;
            transition: all 0.2s;
            height: 32px; /* Fixed height for consistency */
            box-sizing: border-box;
        }

        .alert-close-btn {
            position: absolute;
            top: 18px;
            right: 110px;
            background: none;
            border: none;
            font-size: 18px;
            cursor: pointer;
            color: #666;
            padding: 0;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .alert-close-btn:hover {
            color: #333;
            background: rgba(0,0,0,0.1);
            border-radius: 50%;
        }
        .alert-chip.read .alert-status-indicator {
            opacity: 0;
        }

        .alert-chip.unread .alert-chip-icon {
            fill: #ff8c00;
        }

        .alert-chip.read .alert-chip-icon {
            fill: #9ca3af;
        }

        .alert-chip.unread .alert-status-indicator {
            opacity: 1;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* Adjust chip padding to accommodate indicator */
        .alert-chip {
            padding: 6px 12px 6px 20px; /* Added left padding for indicator */
        }


        /* Always visible navigation indicators */
        .slider-nav-hint {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            background: rgba(255, 255, 255, 0.8);
            border: 1px solid #ddd;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            color: #666;
            cursor: pointer;
            transition: all 0.2s;
        }

        .slider-nav-hint:hover {
            background: rgba(255, 255, 255, 0.95);
            transform: translateY(-50%) scale(1.1);
        }

        .slider-nav-hint.prev {
            left: 10px;
        }

        .slider-nav-hint.next {
            right: 10px;
        }

        .slider-nav-hint:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }

        /* Toggle button wrapper outside container */
        .alert-toggle-wrapper {
            margin: 8px 24px 0;
            display: flex;
            justify-content: flex-end;
            align-items: center;
        }

        .alert-view-toggle {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 6px 12px;
            font-size: 11px;
            cursor: pointer;
            color: #484581;
            transition: all 0.2s;
            font-weight: 500;
        }

        .alert-view-toggle:hover {
            background: #e9ecef;
            border-color: #484581;
        }

        /* Notes icon button */
        .notes-icon-btn {
             background: #f8f9fa;
            border: 1px solid #dee2e6;
            cursor: pointer;
            padding: 6px;
            border-radius: 6px;
            color: #666;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .notes-icon-btn:hover {
            background: #e9ecef;
            border-color: #353182;
            color: #353182;
        }

        .notes-icon {
           width: 16px;
            height: 16px;
            display: block;
        }

        /* Update member-name-row to accommodate notes icon */
        .member-name-row {
             display: flex;
            align-items: center;
            justify-content: space-between; /* This will push the icon to the right */
            gap: 12px;
            /* margin-bottom: 24px; */
            width: 100%;
        }

        /* Notes side panel */
        .notes-panel {
            position: fixed;
            top: 0;
            right: -400px;
            width: 400px;
            height: 100vh;
            background: white;
            box-shadow: -2px 0 10px rgba(0, 0, 0, 0.1);
            z-index: 1001;
            transition: right 0.3s ease;
            display: flex;
            flex-direction: column;
            border-left: 1px solid #e1e5e9;
        }

        .notes-panel.open {
            right: 0;
        }

        .notes-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(0, 0, 0, 0.3);
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }

        .notes-overlay.show {
            opacity: 1;
            visibility: visible;
        }

        /* Notes panel header */
        .notes-header {
             padding: 24px 20px 16px;
            border-bottom: 1px solid #e1e5e9;
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%);
        }

        .notes-title {
            font-size: 18px;
            font-weight: 600;
            color: #353182;
            margin: 0;
        }

        .notes-member {
            font-size: 14px;
            font-weight: 500;
            color: #495057;
        }

        .notes-description {
            font-size: 12px;
            line-height: 1.4;
            max-width: 100%;
            background: #EFF6FF;
            padding: 8px 12px;
            border-radius: 2px;
        }


        .notes-header-content {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }


        .notes-header h3 {
            font-size: 16px;
            font-weight: 600;
            color: #333;
            margin: 0;
        }

        .notes-close-btn {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #666;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: all 0.2s;
        }

        .notes-close-btn:hover {
            background: rgba(0, 0, 0, 0.1);
            color: #333;
        }

        /* Notes content area */
        .notes-content {
            flex: 1;
            padding: 24px 20px;
            display: flex;
            flex-direction: column;
            background: #fafbfc;
        }

        .notes-textarea {
           width: 100%;
            height: 100%;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            padding: 16px;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            font-size: 14px;
            line-height: 1.5;
            resize: none;
            outline: none;
            background: white;
            transition: border-color 0.2s;
        }

        .notes-textarea:focus {
            border-color: #353182;
            box-shadow: 0 0 0 2px rgba(53, 49, 130, 0.1);
        }

        .notes-textarea::placeholder {
            color: #999;
        }

        /* Notes footer */
        .notes-footer {
            padding: 16px 20px;
            border-top: 1px solid #e1e5e9;
            background: #f8f9fa;
        }

        .notes-save-indicator {
            font-size: 14px;
            color: #28a745;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .notes-save-indicator.show {
            opacity: 1;
        }


        .contextual-sidebar {
            position: fixed;
            top: 0;
            right: -320px;
            width: 320px;
            height: 100vh;
            background: white;
            box-shadow: -4px 0 20px rgba(0,0,0,0.15);
            transition: right 0.3s ease;
            z-index: 1000;
            display: flex;
            flex-direction: column;
        }

        .contextual-sidebar.active {
            right: 0;
        }

        /* Contextual Sidebar Trigger */
        .contextual-sidebar-trigger {
            position: fixed;
            right: 0;
            top: 50%;
            transform: translateY(-50%);
            background: linear-gradient(135deg, #5d4e8b 0%, #4c3d8a 100%);
            color: white;
            border: none;
            padding: 16px 8px;
            border-radius: 8px 0 0 8px;
            writing-mode: vertical-rl;
            text-orientation: mixed;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            box-shadow: -2px 0 8px rgba(93, 78, 139, 0.3);
            transition: all 0.3s ease;
            z-index: 999;
            letter-spacing: 1px;
        }

        .contextual-sidebar-trigger:hover {
            background: linear-gradient(135deg, #4c3d8a 0%, #3a2d6b 100%);
            box-shadow: -4px 0 12px rgba(93, 78, 139, 0.4);
            padding-left: 12px;
        }

        .contextual-sidebar-trigger.hidden {
            right: -40px;
            opacity: 0;
        }

        /* Sidebar Header */
        .contextual-sidebar-header {
            padding: 20px 24px;
            border-bottom: 1px solid #e1e5e9;
            background: #f8f9fa;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .contextual-sidebar-title {
            font-size: 18px;
            font-weight: 600;
            color: #2c3e50;
        }

        .close-contextual-sidebar {
            background: none;
            border: none;
            font-size: 20px;
            cursor: pointer;
            color: #6c757d;
            padding: 4px;
            border-radius: 4px;
            transition: background 0.2s;
        }

        .close-contextual-sidebar:hover {
            background: #e9ecef;
        }

        /* Context Banner */
        .context-banner {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 12px 24px;
            font-size: 14px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .context-info {
            display: flex;
            align-items: center;
        }

        .context-icon {
            width: 20px;
            height: 20px;
            background: rgba(255,255,255,0.2);
            border-radius: 4px;
            margin-right: 12px;
        }

        /* Quick Links List */
        .contextual-quick-links {
            flex: 1;
            padding: 0;
            overflow-y: auto;
        }

        .quick-links-section {
            border-bottom: 1px solid #e1e5e9;
        }

        .section-header {
            padding: 16px 24px;
            background: #f8f9fa;
            font-weight: 600;
            color: #495057;
            font-size: 14px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .section-count {
            background: #5d4e8b;
            color: white;
            font-size: 11px;
            padding: 2px 6px;
            border-radius: 10px;
            min-width: 16px;
            text-align: center;
        }

        .contextual-quick-link {
            display: flex;
            align-items: center;
            padding: 16px 24px;
            cursor: pointer;
            transition: background 0.2s;
            border: none;
            width: 100%;
            text-align: left;
            background: none;
            border-bottom: 1px solid #f1f3f4;
        }

        .contextual-quick-link:hover {
            background: #f8f9fa;
        }

        .contextual-quick-link:last-child {
            border-bottom: none;
        }

        .contextual-quick-link-icon {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            margin-right: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            font-weight: bold;
        }

        .contextual-quick-link-icon.member-details { background: #e3f2fd; color: #1976d2; }
        .contextual-quick-link-icon.diagnosis { background: #fff3e0; color: #f57c00; }
        .contextual-quick-link-icon.medications { background: #e8f5e8; color: #388e3c; }
        .contextual-quick-link-icon.care-team { background: #fce4ec; color: #c2185b; }
        .contextual-quick-link-icon.related-persons { background: #f3e5f5; color: #7b1fa2; }
        .contextual-quick-link-icon.service-notes { background: #e0f2f1; color: #00695c; }

        .contextual-quick-link-content {
            flex: 1;
        }

        .contextual-quick-link-title {
            font-size: 16px;
            font-weight: 400;
            color: #2c3e50;
            margin-bottom: 4px;
            line-height: 24px;
        }

        .contextual-quick-link-desc {
            font-size: 13px;
            color: #6c757d;
            line-height: 1.4;
        }

        .contextual-quick-link-badge {
            background: #e74c3c;
            color: white;
            font-size: 10px;
            padding: 3px 6px;
            border-radius: 10px;
            margin-left: 8px;
            font-weight: 600;
        }

        .contextual-quick-link-arrow {
            margin-left: 8px;
            color: #bdc3c7;
            font-size: 14px;
        }

        /* Slide-out Panel */
        .slide-panel {
            position: fixed;
            top: 0;
            right: 0;
            width: 65%;
            max-width: 900px;
            min-width: 600px;
            height: 100vh;
            background: white;
            box-shadow: -4px 0 20px rgba(0,0,0,0.15);
            transform: translateX(100%);
            transition: transform 0.3s ease;
            z-index: 1100;
            display: flex;
            flex-direction: column;
        }

        .slide-panel.active {
            transform: translateX(0);
        }

        .slide-panel-header {
            padding: 20px 24px;
            border-bottom: 1px solid #e1e5e9;
            background: #f8f9fa;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .slide-panel-title {
            font-size: 18px;
            font-weight: 600;
            color: #2c3e50;
        }

        .close-panel {
            background: none;
            border: none;
            font-size: 20px;
            cursor: pointer;
            color: #6c757d;
            padding: 4px;
        }

        .slide-panel-content {
            flex: 1;
            padding: 24px;
            overflow-y: auto;
        }

        .slide-panel-footer {
            padding: 20px 24px;
            border-top: 1px solid #e1e5e9;
            background: #f8f9fa;
            display: flex;
            gap: 12px;
            justify-content: flex-end;
        }
        .overlay.active {
            opacity: 1;
            visibility: visible;
        }

        /* Added Information Summary */
        .added-info-summary {
            background: #e8f5e8;
            border: 1px solid #c8e6c9;
            border-radius: 8px;
            padding: 16px;
            margin-top: 24px;
        }

        .summary-title {
            font-size: 14px;
            font-weight: 600;
            color: #2e7d32;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
        }

        .summary-list {
            list-style: none;
        }

        .summary-item {
            padding: 8px 0;
            border-bottom: 1px solid #e8f5e8;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .summary-item:last-child {
            border-bottom: none;
        }

        .summary-label {
            font-weight: 500;
            color: #1b5e20;
        }

        .summary-value {
            color: #2e7d32;
            font-size: 13px;
        }


        @media (max-width: 1024px) {
            .contextual-sidebar {
                width: 100%;
                max-width: 400px;
            }
           
            .slide-panel {
                width: 100%;
                max-width: 480px;
            }

            .assessment-content.sidebar-open {
                margin-right: 24px;
            }
        }
        /* Custom Modal Styles */
        .custom-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }

        .custom-modal.active {
            opacity: 1;
            visibility: visible;
        }

        .modal-content {
            background: white;
            border-radius: 12px;
            padding: 0;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.2);
            transform: scale(0.9);
            transition: transform 0.3s ease;
        }

        .custom-modal.active .modal-content {
            transform: scale(1);
        }

        .modal-header {
            padding: 24px 24px 16px;
            border-bottom: 1px solid #e1e5e9;
        }

        .modal-title {
            font-size: 20px;
            font-weight: 600;
            color: #2c3e50;
            margin: 0;
            display: flex;
            align-items: center;
        }

        .modal-icon {
            width: 24px;
            height: 24px;
            margin-right: 12px;
            font-size: 20px;
        }

        .modal-body {
            padding: 20px 24px;
        }

        .modal-message {
            font-size: 16px;
            color: #495057;
            line-height: 1.5;
            margin: 0;
        }

        .modal-footer {
            padding: 16px 24px 24px;
            display: flex;
            gap: 12px;
            justify-content: flex-end;
        }
        /* Utility Section Styles - New Design */
.utility-section {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
}

.utility-link {
    display: flex;
    align-items: center;
    padding: 16px 24px;
    cursor: pointer;
    transition: all 0.2s;
    border: none;
    width: 100%;
    text-align: left;
    background: none;
    border-bottom: 1px solid rgba(255,255,255,0.1);
    color: white;
}

.utility-link:hover {
    background: rgba(255,255,255,0.1);
    transform: translateX(4px);
}

.vida-copilot-link {
    background: rgba(255,255,255,0.05);
}

.help-link {
    background: rgba(255,255,255,0.02);
}

.utility-icon {
    width: 44px;
    height: 44px;
    border-radius: 12px;
    margin-right: 16px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 18px;
    font-weight: bold;
    background: rgba(255,255,255,0.15);
    color: white;
}

.leap-logo {
    font-size: 20px;
    font-weight: 700;
}

.utility-content {
    flex: 1;
}

.utility-title {
    font-size: 15px;
    font-weight: 600;
    color: white;
    margin-bottom: 2px;
}

.utility-subtitle {
    font-size: 12px;
    color: rgba(255,255,255,0.8);
}

.utility-status {
    color: #4ade80;
    font-size: 12px;
    margin-left: 8px;
}

        .modal-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s;
            min-width: 80px;
        }

        .modal-btn-secondary {
            background: #f8f9fa;
            color: #495057;
            border: 1px solid #dee2e6;
        }

        .modal-btn-secondary:hover {
            background: #e9ecef;
        }

        .modal-btn-primary {
            background: #5d4e8b;
            color: white;
        }

        .modal-btn-primary:hover {
            background: #4c3d8a;
        }
        /* Utility Section Styles - Icon Only Design */
        .utility-section {
       background: #f8f9fa; /* Lighter grey background */
        padding: 12px 16px;
        margin: 12px 16px;
        border-radius: 8px;
        border: 1px solid #e1e5e9;
        }
        .utility-buttons-row {
            display: flex;
            gap: 16px;
            justify-content: left;
        }

        .utility-icon-btn {
             width: 44px;
        height: 44px;
        border-radius: 8px;
        border: 1px solid #dee2e6;
        cursor: pointer;
        transition: all 0.2s;
        display: flex;
        align-items: center;
        justify-content: center;
        position: relative;
        background: #ffffff; /* White background for buttons */
        }

        .utility-icon-btn:hover {
           transform: translateY(-2px);
    box-shadow: 0 4px 10px rgba(0,0,0,0.1);
    border-color: #353182;
        }

        .vida-copilot-btn img {
            width: 28px;
        height: 28px;
        border-radius: 6px;
        }

        .utility-status-dot {
            position: absolute;
            top: 6px;
            right: 6px;
            width: 6px;
            height: 6px;
            background-color: #4ade80;
            border-radius: 50%;
            box-shadow: 0 0 4px rgba(74, 222, 128, 0.8);
        }

        .help-icon {
            color: #495057; /* Darker icon color */
            width: 24px;
            height: 24px;
        }
        .utility-section-title {
            padding-bottom: 12px;
            font-size: 13px;
            font-weight: 600;
            color: #495057; /* Darker text color */
            text-align: left;
            text-transform: none;
            letter-spacing: 0;
        }

        /* ADD THIS CSS FOR THE NEW HEADER BUTTONS */
        .header-action-btn {
            background: none;
            border: none;
            cursor: pointer;
            padding: 8px;
            border-radius: 6px;
            color: #666;
            transition: all 0.2s;
            display: flex; /* Helps center the icon */
            align-items: center; /* Helps center the icon */
        }

        .header-action-btn:hover {
            background: #f1f3f4;
            color: #353182;
        }

        .header-separator {
            width: 1px;
            height: 24px;
            background-color: #e1e5e9; /* A border color consistent with your design */
            margin: 0 4px; /* Adds a little space on either side of the line */
        }

        /* ADD THIS CSS FOR USER PROFILE DROPDOWN */
        .user-profile-menu {
            position: relative; /* Anchor for the dropdown */
        }

        .user-profile-trigger {
            display: flex;
            align-items: center;
            gap: 8px;
            background: none;
            border: none;
            cursor: pointer;
            padding: 4px 8px;
            border-radius: 6px;
            transition: background-color 0.2s;
        }

        .user-profile-trigger:hover {
            background-color: #f1f3f4;
        }

        .user-info {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
        }

        .user-role {
            font-size: 13px;
            color: #555;
            font-weight: 500;
        }

        .user-avatar-initials {
            width: 32px;
            height: 32px;
            background: #353182;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 14px;
        }

        .dropdown-arrow {
            width: 16px;
            height: 16px;
            color: #666;
        }

        .dropdown-menu {
            display: none; /* Hidden by default */
            position: absolute;
            top: 110%; /* Position below the trigger */
            right: 0;
            background-color: white;
            border: 1px solid #e1e5e9;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            min-width: 160px;
            z-index: 1010;
            overflow: hidden;
        }

        .dropdown-menu.show {
            display: block; /* Class to show the dropdown */
        }

        .dropdown-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 10px 15px;
            font-size: 14px;
            color: #333;
            text-decoration: none;
            transition: background-color 0.2s;
        }

        .dropdown-item:hover {
            background-color: #f8f9fa;
        }

        .dropdown-icon {
            width: 16px;
            height: 16px;
            color: #555;
        }
        /* === ADD THIS CSS FOR RECENT ITEMS DROPDOWN === */

.recent-items-menu {
    position: relative;
}

.dropdown-menu.recent-dropdown {
    min-width: 320px; /* Make it wider than the default dropdown */
}

.recent-dropdown {
    display: none; /* Hidden by default */
    position: absolute;
    top: 110%; /* Position below the trigger */
    right: 0;
    background-color: white;
    border: 1px solid #e1e5e9;
    border-radius: 8px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    min-width: 320px;
    z-index: 1010;
    overflow: hidden;
}

.recent-dropdown-header {
    padding: 10px 15px;
    font-size: 14px;
    font-weight: 600;
    color: #333;
    border-bottom: 1px solid #f1f3f4;
    background-color: #f8f9fa;
}

.recent-item {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 12px 15px;
    text-decoration: none;
    transition: background-color 0.2s;
    border-bottom: 1px solid #f1f3f4;
}

.recent-item:hover {
    background-color: #f8f9fa;
}

.recent-item:last-child {
    border-bottom: none;
}

.recent-item-icon {
    width: 20px;
    height: 20px;
    color: #555;
    flex-shrink: 0;
}

.recent-item-details {
    overflow: hidden;
}

.recent-item-title {
    font-size: 14px;
    font-weight: 500;
    color: #333;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

.recent-item-subtitle {
    font-size: 12px;
    color: #666;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

.recent-dropdown-footer {
    padding: 10px 15px;
    text-align: center;
    font-size: 13px;
    border-top: 1px solid #e1e5e9;
    background-color: #f8f9fa;
}

.recent-dropdown-footer a {
    color: #353182;
    text-decoration: none;
    font-weight: 500;
}

.recent-dropdown-footer a:hover {
    text-decoration: underline;
}

.no-recents {
    padding: 20px;
    text-align: center;
    font-size: 13px;
    color: #666;
}

        /* ADD THIS CSS FOR GLOBAL SEARCH RESULTS */
        .app-search {
            position: relative; /* Needed to position the results container */
        }

        .search-results-container {
            display: none; /* Hidden by default */
            position: absolute;
            top: 110%;
            left: 0;
            width: 100%;
            max-height: 400px;
            overflow-y: auto;
            background: white;
            border: 1px solid #e1e5e9;
            border-radius: 8px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            z-index: 1020;
        }

        .search-results-container.show {
            display: block; /* Show the container */
        }

        .search-result-category {
            padding: 8px 12px;
            font-size: 11px;
            font-weight: 600;
            color: #353182;
            background-color: #f8f9fa;
            text-transform: uppercase;
            border-bottom: 1px solid #e1e5e9;
        }

        .search-result-item {
            display: block;
            padding: 10px 12px;
            color: #333;
            text-decoration: none;
            border-bottom: 1px solid #f1f3f4;
            transition: background-color 0.2s;
        }

        .search-result-item:hover {
            background-color: #f1f3f4;
        }

        .search-result-item:last-child {
            border-bottom: none;
        }

        .result-title {
            font-weight: 500;
            font-size: 14px;
            margin-bottom: 2px;
        }

        .result-description {
            font-size: 12px;
            color: #666;
        }

        /* REPLACE the old .floating-action-btn CSS with this new version */
        .floating-action-btn {
            position: fixed;
            bottom: 30px;
            right: 15px; /* Positioned closer to the edge */
            width: 56px;
            height: 56px;
            background: #353182;
            border-radius: 50%;
            border: none;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 1000;
           
            /* --- The new retractable effect --- */
            opacity: 0.7; /* Make it less prominent by default */
            transform: translateX(28px); /* Moves the button 50% of its width to the right, hiding it */
            transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1); /* Smooth animation */
        }

        .floating-action-btn:hover {
            opacity: 1; /* Full opacity on hover */
            transform: translateX(0); /* Slides the button back into full view */
            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.25); /* A slightly larger shadow on hover */
        }

        .floating-action-btn img {
            width: 28px;
            height: 28px;
        }

        /* Timeline View Styles */
.timeline-view {
    background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
    padding: 20px;
    min-height: 600px;
}

.timeline-controls {
    display: flex;
    gap: 16px;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 24px;
    flex-wrap: wrap;
}

.timeline-filters {
    display: flex;
    gap: 12px;
    align-items: center;
}

.filter-item {
    display: flex;
    align-items: center;
    gap: 8px;
}

.filter-label {
    font-size: 14px;
    font-weight: 600;
    color: #374151;
}

.filter-input, .filter-select {
    padding: 8px 12px;
    border: 2px solid #e2e8f0;
    border-radius: 8px;
    font-size: 14px;
    outline: none;
    transition: all 0.3s ease;
}

.filter-input:focus, .filter-select:focus {
    border-color: #3b82f6;
    box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
}

.timeline-view-controls {
    display: flex;
    background: #f1f5f9;
    border-radius: 12px;
    padding: 4px;
    gap: 4px;
}

.timeline-view-btn {
    padding: 8px 16px;
    border: none;
    border-radius: 8px;
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
}

.timeline-view-btn.active {
    background: white;
    color: #3b82f6;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
}

.timeline-view-btn:not(.active) {
    background: transparent;
    color: #64748b;
}

.timeline-container {
    background: white;
    border-radius: 16px;
    box-shadow: 0 4px 24px rgba(0, 0, 0, 0.06);
    border: 1px solid rgba(226, 232, 240, 0.8);
    min-height: 500px;
    padding: 8px 24px;
}

/* Horizontal Timeline */
.horizontal-timeline {
    position: relative;
    padding: 40px 0;
    overflow-x: auto;
    overflow-y: hidden;
    min-height: 400px;
}

.timeline-track {
    position: relative;
    height: 140px;
    margin: 40px 0;
    min-width: max-content;
    top: 45px;
}

.timeline-line {
    position: absolute;
    top: 70px;
    left: 0;
    right: 0;
    height: 3px;
    background: linear-gradient(90deg, #e2e8f0 0%, #3b82f6 50%, #e2e8f0 100%);
    border-radius: 2px;
}

.timeline-events {
    display: flex;
    position: relative;
    gap: 80px;
    padding: 0 40px;
    min-width: max-content;
    height: 100%;
}

.timeline-event {
    position: relative;
    display: flex;
    flex-direction: column;
    align-items: center;
    min-width: 100px;
    cursor: pointer;
}

.event-marker {
    width: 24px;
    height: 24px;
    border-radius: 50%;
    border: 3px solid white;
    background: #3b82f6;
    position: absolute;
    top: 58px;
    z-index: 2;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    justify-content: center;
}

.event-marker:hover {
    transform: scale(1.3);
    box-shadow: 0 0 0 8px rgba(59, 130, 246, 0.2);
}

.event-marker.assignment { background: #10b981; }
.event-marker.consent { background: #8b5cf6; }
.event-marker.assessment { background: #f59e0b; }
.event-marker.care-plan { background: #ef4444; }
.event-marker.adt { background: #06b6d4; }
.event-marker.program { background: #84cc16; }
.event-marker.billing { background: #f97316; }
.event-marker.workflow { background: #6366f1; }
.event-marker.task { background: #ec4899; }
.event-marker.appointment { background: #14b8a6; }
.event-marker.callback { background: #f43f5e; }

.event-label {
    position: absolute;
    top: 25px;
    font-size: 12px;
    font-weight: 600;
    color: #374151;
    text-align: center;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    width: 100%;
}

.event-date {
    position: absolute;
    top: 95px;
    font-size: 11px;
    color: #64748b;
    text-align: center;
    width: 100%;
}

/* Event Popup */
.event-popup {
    position: absolute;
    top: -120px; /* Changed from 30px to move it higher above the marker */
    left: 50%;
    transform: translateX(-50%);
    background: white;
    border: 1px solid #e2e8f0;
    border-radius: 12px;
    padding: 20px;
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.15);
    min-width: 350px;
    max-width: 400px;
    opacity: 0;
    pointer-events: none;
    transition: all 0.3s ease;
    z-index: 1000;
}

.timeline-event:hover .event-popup {
    opacity: 1;
    pointer-events: auto;
    transform: translateX(-50%) translateY(-8px);
}


/* Fix first event popup cutoff */
.timeline-event:first-child .event-popup,
.timeline-event:nth-child(2) .event-popup {
    left: 0;
    transform: translateX(0);
}

/* Fix last event popup cutoff */
.timeline-event:last-child .event-popup,
.timeline-event:nth-last-child(2) .event-popup {
    left: auto;
    right: 0;
    transform: translateX(0);
}

/* Hover states */
.timeline-event:hover .event-popup {
    opacity: 1;
    pointer-events: auto;
    transform: translateX(-50%) translateY(-8px);
}

.timeline-event:first-child:hover .event-popup,
.timeline-event:nth-child(2):hover .event-popup {
    transform: translateX(0) translateY(-8px);
}

.timeline-event:last-child:hover .event-popup,
.timeline-event:nth-last-child(2):hover .event-popup {
    transform: translateX(0) translateY(-8px);
}

/* Add more top padding to timeline container */
.timeline-container {
   
}

.horizontal-timeline {
    overflow-y: visible; /* Allow popups to show above */
}

.event-popup::after {
    content: '';
    position: absolute;
    top: 100%;
    left: 50%;
    transform: translateX(-50%);
    border: 8px solid transparent;
    border-top-color: white;
}

.event-title {
    font-size: 14px;
    font-weight: 600;
    color: #0f172a;
    margin-bottom: 8px;
}

.event-meta {
    font-size: 12px;
    color: #64748b;
    margin-bottom: 8px;
}

.event-type-badge {
    display: inline-block;
    padding: 4px 8px;
    border-radius: 6px;
    font-size: 11px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.05em;
}

.event-type-badge.assignment { background: #dcfce7; color: #166534; }
.event-type-badge.consent { background: #ede9fe; color: #7c3aed; }
.event-type-badge.assessment { background: #fef3c7; color: #d97706; }
.event-type-badge.care-plan { background: #fee2e2; color: #dc2626; }
.event-type-badge.adt { background: #cffafe; color: #0891b2; }
.event-type-badge.program { background: #ecfccb; color: #65a30d; }
.event-type-badge.billing { background: #fed7aa; color: #ea580c; }
.event-type-badge.workflow { background: #e0e7ff; color: #4f46e5; }
.event-type-badge.task { background: #fce7f3; color: #be185d; }
.event-type-badge.appointment { background: #ccfbf1; color: #0f766e; }
.event-type-badge.callback { background: #fecdd3; color: #be123c; }

/* Grid View */
.grid-timeline, .list-timeline {
    display: none;
}

.grid-timeline.active, .list-timeline.active {
    display: block;
}

.events-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 20px;
}

.event-card {
    background: white;
    border: 1px solid #e2e8f0;
    border-radius: 16px;
    padding: 32px;
    transition: all 0.3s ease;
    position: relative;
    overflow: hidden;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
}

.event-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 4px;
    background: #3b82f6;
    transition: all 0.3s ease;
}

.event-card.assignment::before { background: #10b981; }
.event-card.consent::before { background: #8b5cf6; }
.event-card.assessment::before { background: #f59e0b; }
.event-card.care-plan::before { background: #ef4444; }
.event-card.adt::before { background: #06b6d4; }
.event-card.callback::before { background: #f43f5e; }

.event-card:hover {
    transform: translateY(-4px);
    box-shadow: 0 12px 32px rgba(0, 0, 0, 0.12);
}

.event-card-header {
    margin-bottom: 24px;
}

.event-card-title {
    font-size: 18px;
    font-weight: 700;
    color: #0f172a;
    margin-bottom: 8px;
    line-height: 1.4;
}

.event-card-date {
    font-size: 14px;
    color: #64748b;
    font-weight: 500;
    margin-bottom: 12px;
}

.event-card-details {
    margin-bottom: 24px;
}

.event-detail-row {
    display: flex;
    align-items: center;
    gap: 12px;
    margin-bottom: 12px;
    font-size: 14px;
    color: #475569;
    padding: 8px 0;
}

.event-card-actions {
    display: flex;
    gap: 8px;
}

.btn {
    padding: 10px 16px;
    border: none;
    border-radius: 10px;
    font-size: 13px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
    display: inline-flex;
    align-items: center;
    gap: 6px;
}

.btn-primary {
    background: #353182;
    color: white;
}

.btn-primary:hover {
    background: #2563eb;
    transform: translateY(-1px);
}

/* List View */
.events-list {
    space-y: 12px;
}

.event-list-item {
    background: white;
    border: 1px solid #e2e8f0;
    border-radius: 16px;
    padding: 28px 32px;
    display: flex;
    align-items: center;
    gap: 24px;
    transition: all 0.3s ease;
    margin-bottom: 16px;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
}

.event-list-item:hover {
    box-shadow: 0 8px 24px rgba(0, 0, 0, 0.08);
    transform: translateY(-2px);
    border-color: #cbd5e1;
}

.event-list-icon {
    width: 56px;
    height: 56px;
    border-radius: 16px;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-weight: 700;
    font-size: 18px;
    flex-shrink: 0;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
}

.event-list-content {
    flex: 1;
    min-width: 0;
}

.event-list-title {
    font-size: 18px;
    font-weight: 700;
    color: #0f172a;
    margin-bottom: 8px;
    line-height: 1.4;
}

.event-list-meta {
    display: flex;
    gap: 24px;
    font-size: 14px;
    color: #64748b;
    margin-bottom: 12px;
    flex-wrap: wrap;
}

.event-list-meta span {
    padding: 4px 0;
}

.event-list-description {
    font-size: 14px;
    color: #475569;
    line-height: 1.5;
}

.event-list-actions {
    flex-shrink: 0;
}
/* Print Styles */
@media print {
    * {
        -webkit-print-color-adjust: exact !important;
        color-adjust: exact !important;
    }
   
    body * {
        visibility: hidden;
    }
   
    .print-container, .print-container * {
        visibility: visible;
    }
   
    .print-container {
        position: absolute;
        left: 0;
        top: 0;
        width: 100%;
        font-size: 12px;
        line-height: 1.4;
        background: white !important;
        padding: 20px;
    }
   
    .print-header {
        text-align: center;
        margin-bottom: 30px;
        padding-bottom: 15px;
        border-bottom: 2px solid #333;
        background: white !important;
    }
   
    .print-title {
        font-size: 18px;
        font-weight: bold;
        margin-bottom: 8px;
        color: #000 !important;
    }
   
    .print-subtitle {
        font-size: 14px;
        color: #333 !important;
        margin-bottom: 12px;
    }
   
    .print-filters {
        font-size: 11px;
        color: #666 !important;
    }
   
    .print-events {
        margin-top: 25px;
        background: white !important;
    }
   
    .print-event {
        margin-bottom: 25px;
        padding: 20px;
        border: 2px solid #ddd;
        border-radius: 8px;
        break-inside: avoid;
        page-break-inside: avoid;
        background: white !important;
        box-shadow: none !important;
    }
   
    .print-event-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 15px;
        padding-bottom: 12px;
        border-bottom: 1px solid #eee;
        background: white !important;
    }
   
    .print-event-title {
        font-size: 14px;
        font-weight: bold;
        color: #000 !important;
        flex: 1;
        margin-right: 15px;
    }
   
    .print-event-type {
        background: white !important;
        border: 1px solid #ccc;
        padding: 4px 10px;
        border-radius: 4px;
        font-size: 10px;
        text-transform: uppercase;
        font-weight: bold;
        color: #333 !important;
    }
   
    .print-event-meta {
        margin-bottom: 15px;
        font-size: 11px;
        color: #444 !important;
        line-height: 1.6;
        background: white !important;
    }
   
    .print-event-meta span {
        display: inline-block;
        margin-right: 20px;
        margin-bottom: 5px;
    }
   
    .print-event-description {
        font-size: 12px;
        color: #222 !important;
        line-height: 1.6;
        margin-bottom: 12px;
        background: white !important;
    }
   
    .print-event-details {
        background: white !important;
        border: 1px solid #e0e0e0;
        padding: 12px;
        border-radius: 4px;
        font-size: 11px;
        color: #333 !important;
        line-height: 1.5;
    }
   
    .print-event-details div {
        margin-bottom: 5px;
    }
   
    /* Type-specific styling for print - using borders instead of backgrounds */
    .print-event.assignment { border-left: 4px solid #10b981; }
    .print-event.consent { border-left: 4px solid #8b5cf6; }
    .print-event.assessment { border-left: 4px solid #f59e0b; }
    .print-event.care-plan { border-left: 4px solid #ef4444; }
    .print-event.adt { border-left: 4px solid #06b6d4; }
    .print-event.appointment { border-left: 4px solid #14b8a6; }
    .print-event.callback { border-left: 4px solid #f43f5e; }
    .print-event.task { border-left: 4px solid #ec4899; }
    .print-event.workflow { border-left: 4px solid #6366f1; }
    .print-event.program { border-left: 4px solid #84cc16; }
   
    .print-footer {
        margin-top: 40px;
        text-align: center;
        font-size: 10px;
        color: #666 !important;
        border-top: 1px solid #ddd;
        padding-top: 15px;
        background: white !important;
    }
   
    /* Remove any default browser print margins */
    @page {
        margin: 0.5in;
        background: white;
    }
   
    /* Ensure no gray backgrounds anywhere */
    body, html, .timeline-view, .timeline-container {
        background: white !important;
    }
}


.btn-secondary {
    background: #f8fafc;
    color: #64748b;
    border: 2px solid #e2e8f0;
}

.btn-secondary:hover {
    background: #f1f5f9;
    border-color: #cbd5e1;
}

/* Member Consent Overview Styles */
.consent-section {
    margin-bottom: 32px;
}

.consent-subsection-title {
    font-size: 16px;
    font-weight: 600;
    color: #484581;
    margin-bottom: 16px;
    padding-bottom: 8px;
    border-bottom: 1px solid #f2f2f2;
}

.enrollment-info-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 24px;
}

.enrollment-info-item {
    display: flex;
    flex-direction: column;
    gap: 8px;
}

.enrollment-info-item label {
    font-size: 14px;
    color: #666;
    font-weight: 500;
}

.date-display {
    font-size: 16px;
    font-weight: 600;
    color: #333;
    display: flex;
    align-items: center;
    gap: 8px;
}

.consent-overview-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 24px;
}

.consent-status-item {
    display: flex;
    flex-direction: column;
    gap: 8px;
}

.consent-status-item label {
    font-size: 14px;
    color: #666;
    font-weight: 500;
}

.status-indicator {
    display: flex;
    align-items: center;
    gap: 8px;
}

.status-dot {
    width: 8px;
    height: 8px;
    border-radius: 50%;
}

.status-dot.orange {
    background-color: #ff8c00;
}

.status-text {
    font-size: 16px;
    font-weight: 600;
    color: #333;
}

.consent-history-table {
    background: white;
    border: 1px solid #e1e5e9;
    border-radius: 8px;
    overflow: hidden;
}

.consent-history-table table {
    width: 100%;
    border-collapse: collapse;
}

.consent-history-table th,
.consent-history-table td {
    padding: 12px;
    text-align: left;
    border-bottom: 1px solid #e1e5e9;
    font-size: 13px;
}

.consent-history-table th {
    background: #f8f9fa;
    font-weight: 600;
    color: #495057;
}

.consent-actions {
    display: flex;
    justify-content: flex-end;
    gap: 12px;
    margin-top: 16px;
}

.btn-secondary, .btn-danger, .btn-primary {
    padding: 10px 20px;
    border: none;
    border-radius: 6px;
    font-size: 14px;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s;
}

.btn-secondary {
    background: #f8f9fa;
    color: #495057;
    border: 1px solid #ced4da;
}

.btn-danger {
    background: #dc3545;
    color: white;
}

.btn-primary {
    background: #484581;
    color: white;
}

/* Updated Member Consent Overview Styles */
.consent-overview-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 24px;
}

.contact-attempts-link a {
    color: #484581;
    text-decoration: underline;
    font-size: 16px;
    font-weight: 600;
    cursor: pointer;
}

.contact-attempts-link a:hover {
    color: #2a2666;
    text-decoration: none;
}

/* Service Note Modal - Clean UI */
.service-note-modal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.5);
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 2000;
}

.service-note-modal.show {
    display: flex;
}

.service-note-content {
    background: white;
    border-radius: 8px;
    width: 95%;
    max-width: 1000px;
    max-height: 90vh;
    overflow-y: auto;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
}

.service-note-header {
    padding: 16px 20px;
    border-bottom: 1px solid #e1e5e9;
    display: flex;
    justify-content: space-between;
    align-items: center;
    background: #f8f9fa;
}

.service-note-title {
    font-size: 18px;
    font-weight: 600;
    color: #333;
    margin: 0;
}

.service-note-body {
    padding: 80px;
}

/* Compact form sections */
.service-note-section {
    margin-bottom: 24px;
}

.service-note-section-title {
    font-size: 14px;
    font-weight: 600;
    color: #484581;
    margin-bottom: 12px;
    padding-bottom: 6px;
    border-bottom: 1px solid #484581;
}

/* Improved form grid */
.form-row {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 16px;
    margin-bottom: 12px;
}

.form-row.two-col {
    grid-template-columns: repeat(2, 1fr);
}

.form-row.four-col {
    grid-template-columns: repeat(4, 1fr);
}

.form-group {
    display: flex;
    flex-direction: column;
    gap: 4px;
}

.form-group label {
    font-size: 12px;
    font-weight: 500;
    color: #555;
}

.form-group input,
.form-group select,
.form-group textarea {
    padding: 8px 10px;
    border: 1px solid #ddd;
    border-radius: 4px;
    font-size: 13px;
    min-height: 34px;
}

.form-group textarea {
    min-height: 80px;
    resize: vertical;
}

/* Compact checkbox */
.checkbox-group {
    display: flex;
    align-items: center;
    gap: 6px;
    margin-top: 4px;
}

.checkbox-group input {
    min-height: auto;
}

.checkbox-group label {
    font-size: 12px;
    margin: 0;
}

/* Clean billing section */
.billing-section {
    display: none;
}

.billing-section.show {
    display: flex;
    flex-direction: column;
    gap: 4px;
}

.status-dot.green {
    background-color: #28a745;
}

.status-dot.red {
    background-color: #dc3545;
}

.status-dot.orange {
    background-color: #ff8c00;
}
button.btn.btn-secondary.test {
    margin-top: -72px;
    float: right;
}
/* ADD THIS CSS FOR THE LOB SWITCHER */
.lob-selector {
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 12px;
    color: #666;
}

.lob-selector label {
    font-weight: 500;
}

.lob-selector select {
    border: 1px solid #e1e5e9;
    border-radius: 4px;
    padding: 2px 6px;
    font-size: 12px;
    background-color: #f8f9fa;
    cursor: pointer;
}

/* Member name and identifiers on same line */
.member-name-with-identifiers {
    display: flex;
    align-items: baseline;
    gap: 12px;
    flex-wrap: wrap;
    margin-bottom: 4px;
}

.member-name {
    font-size: 20px;
    font-weight: 600;
    color: #1a1a1a;
}

.member-identifiers {
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 14px;
    color: #666;
    font-weight: 500;
}

/* Show counts next to labels */
.key-info-label-with-count {
    display: flex;
    align-items: center;
    gap: 6px;
}

.count-badge {
    background: #f1f3f4;
    color: #666;
    padding: 2px 6px;
    border-radius: 10px;
    font-size: 10px;
    font-weight: 600;
}

/* Collapsible header functionality */
.member-header-container.mini-collapsed .member-key-info {
    display: none;
}

.member-header-container.mini-collapsed .member-primary {
    padding-bottom: 8px;
}

.member-header-container.mini-collapsed .minimize-icon {
    transform: rotate(180deg);
}

.toggle-buttons {
    display: flex;
    gap: 6px;
    align-items: center;
}

.mini-collapse-btn {
    background: none;
    border: none;
    color: #666;
    cursor: pointer;
    padding: 6px;
    border-radius: 4px;
    transition: all 0.2s;
    display: flex;
    align-items: center;
    justify-content: center;
}

.mini-collapse-btn:hover {
    background: #f1f3f4;
    color: #353182;
}

.minimize-icon {
    width: 16px;
    height: 16px;
}

.member-header-container.expanded .mini-collapse-btn {
    display: none;
}

.mini-collapse-icon {
    width: 16px;
    height: 16px;
    transition: transform 0.3s ease;
}

.member-header-container.mini-collapsed .mini-collapse-icon {
    transform: rotate(180deg);
}

/* Compact toggle in alert strip */
.compact-toggle-wrapper {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-left: auto;
    padding-right: 12px;
}

.compact-toggle-btn {
    display: flex;
    align-items: center;
    gap: 4px;
    background: rgba(255, 255, 255, 0.8);
    border: 1px solid #ddd;
    border-radius: 16px;
    padding: 4px 8px;
    font-size: 10px;
    cursor: pointer;
    transition: all 0.2s;
    color: #666;
}

.compact-toggle-btn:hover {
    background: white;
    border-color: #353182;
    color: #353182;
}

.compact-toggle-btn.active {
    background: #353182;
    border-color: #353182;
    color: white;
}

.compact-icon {
    width: 12px;
    height: 12px;
}

.compact-text {
    font-weight: 500;
}

/* Compact view styles */
.member-header-container.compact-view .member-key-info {
    display: none;
    Visibility: hidden !important;
}
.member-header-container.compact-view:not(.expanded) .member-header-expanded {
    display: none !important;
}

.member-header-container.compact-view .member-header-collapsed {
    padding: 12px 20px;
   
}

/* Remove the old toggle buttons approach */
.toggle-buttons {
    display: flex;
    gap: 6px;
    align-items: center;
}

/* Hide the minimize button we added earlier */
.mini-collapse-btn {
    display: none;
}
.member-view-controls {
    display: flex;
    justify-content: flex-end;
    align-items: center;
    margin-top: 8px;
    margin-right: 60px;
}

.view-toggle-wrapper {
    display: flex;
    align-items: center;
    gap: 8px;
}

.view-toggle-label {
    font-size: 11px;
    color: #666;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.3px;
}

.view-toggle-btn {
    display: flex;
    align-items: center;
    gap: 6px;
    background: #f8f9fa;
    border: 1px solid #dee2e6;
    border-radius: 16px;
    padding: 6px 12px;
    font-size: 11px;
    cursor: pointer;
    color: #666;
    transition: all 0.2s;
    font-weight: 500;
}

.view-toggle-btn:hover {
    background: #e9ecef;
    border-color: #353182;
    color: #353182;
}

.view-toggle-btn.active {
    background: #353182;
    border-color: #353182;
    color: white;
}

.view-toggle-icon {
    width: 14px;
    height: 14px;
}

.member-header-container.expanded .member-view-controls {
    display: none;
}

.key-info-header {
    display: flex;
    justify-content: flex-end;
    margin-bottom: 8px;
}

.key-info-toggle {
    background: none;
    border: 1px solid #dee2e6;
    border-radius: 4px;
    padding: 4px 8px;
    cursor: pointer;
    color: #666;
    transition: all 0.2s;
    display: flex;
    align-items: center;
}

.key-info-toggle:hover {
    background: #f1f3f4;
    border-color: #353182;
    color: #353182;
}



.key-info-collapsed .key-info-toggle-icon {
    transform: rotate(-90deg);
}

.key-info-collapsed .member-key-info {
    display: none;
}
.simple-toggle-wrapper {
    margin: 8px 0 4px 0;
    position: absolute;
    top: 16px;
    right: 60px; /* Position it to the left of the main arrow */
    z-index: 20;
}

.simple-toggle-btn {
    background: none;
    border: none;
    color: #666;
    font-size: 11px;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 4px;
    transition: color 0.2s;
    font-weight: 500;
    text-transform: uppercase;
    letter-spacing: 0.3px;
    padding: 4px 8px;
    border-radius: 4px;
    white-space: nowrap;
}

.simple-toggle-btn:hover {
    color: #353182;
        background: #f1f3f4;

}

.member-header-container.key-info-hidden .member-header-collapsed {
    padding-bottom: 12px;
}

.toggle-arrow {
    width: 14px;
    height: 14px;
    transition: transform 0.3s ease;
}

.key-info-hidden .toggle-arrow {
    transform: rotate(180deg);
}

.key-info-hidden .member-key-info {
    display: none;
}

.key-info-hidden .toggle-text::before {
    content: "Show Details";
}

.key-info-hidden .toggle-text {
    visibility: hidden;
}
/* Key Info Toggle Styles */
.key-info-toggle-wrapper {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-left: auto;
}






.key-info-toggle-icon {
    width: 14px;
    height: 14px;
    transition: transform 0.3s ease;
}

.member-header-container.key-info-collapsed .key-info-toggle-icon {
    transform: rotate(-180deg);
}

/* Main Expand Toggle Styles */
.main-expand-toggle {
    display: flex;
    justify-content: flex-end;
    padding-top: 12px;
    margin-top: 12px;
    border-top: 1px solid #d2d2d2;
}

.key-info-toggle-btn,
.main-toggle-btn {
    background: #f8f9fa;
    border: 1px solid #dee2e6;
    border-radius: 4px;
    padding: 6px 12px;
    cursor: pointer;
    color: #495057;
    transition: all 0.2s;
    display: flex;
    align-items: center;
    gap: 6px;
    font-size: 11px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    min-height: 32px;
    box-sizing: border-box;
}

.key-info-toggle-btn:hover,
.main-toggle-btn:hover {
    background: #e9ecef;
    border-color: #353182;
    color: #353182;
}

.toggle-label,
.expand-label {
    font-size: 11px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    color: inherit;
}

.key-info-toggle-icon,
.main-toggle-icon {
    width: 14px;
    height: 14px;
    transition: transform 0.3s ease;
    flex-shrink: 0;
}

.member-header-container.expanded .main-toggle-icon {
    transform: rotate(180deg);
}

.member-header-container.expanded .expand-label::before {
    content: "Less ";
}

/* Hide key info when collapsed */
.member-header-container.key-info-collapsed .member-key-info {
    display: none;
}

.member-header-container.key-info-collapsed .toggle-label::before {
    content: "Show ";
}
.alert-chip.service-notes .alert-chip-icon {
    color: #6366f1;
}

.alert-expanded-content#expandedAlert4 {
    border-left-color: #353182;
}

/* Configuration Drawer Styles */
.config-drawer {
    position: fixed;
    top: 65px;
    left: 60px;
    width: 290px;
    height: 100vh;
    background: white;
    box-shadow: 2px 0 10px rgba(0, 0, 0, 0.1);
    border-right: 1px solid #e1e5e9;
    z-index: 999;
    transform: translateX(-100%); /* Hidden by default */
    transition: transform 0.3s ease, left 0.3s ease;
    display: flex;
    flex-direction: column;
}

/* When sidebar is collapsed */
.sidebar.collapsed + .config-drawer,
.config-drawer.from-collapsed {
    left: 80px !important; /* Position next to collapsed sidebar */
}

.config-drawer.show {
    transform: translateX(0);
    left: 260px ;
}

.config-drawer-header {
    padding: 12px 20px;
    border-bottom: 1px solid #e1e5e9;
    background: #f8f9fa;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.config-drawer-title {
    font-size: 16px;
    font-weight: 600;
    color: #333;
}

.config-drawer-close {
    background: none;
    border: none;
    font-size: 24px;
    cursor: pointer;
    color: #666;
    padding: 4px;
    border-radius: 4px;
    transition: background 0.2s;
    width: 32px;
    height: 32px;
    display: flex;
    align-items: center;
    justify-content: center;
    line-height: 1;
}

.config-drawer-close:hover {
    background: #e9ecef;
    color: #333;
}

.config-drawer-content {
    flex: 1;
    overflow-y: auto;
    padding: 0;
    max-height: calc(100vh - 140px); /* Account for header height */
}

.config-categories {
    max-height: 100%;
    overflow-y: auto;
}

/* Add scrollbar styling for better UX */
.config-drawer-content::-webkit-scrollbar {
    width: 6px;
}

.config-drawer-content::-webkit-scrollbar-track {
    background: #f1f1f1;
}

.config-drawer-content::-webkit-scrollbar-thumb {
    background: #c1c1c1;
    border-radius: 3px;
}

.config-drawer-content::-webkit-scrollbar-thumb:hover {
    background: #a1a1a1;
}

.config-search-wrapper {
    padding: 16px 20px;
    border-bottom: 1px solid #e1e5e9;
    background: #f8f9fa;
    position: relative;
}
.config-search-input {
    padding-left: 32px;
}

.config-search-wrapper .search-icon {
    position: absolute;
    left: 28px;
    top: 50%;
    transform: translateY(-50%);
    width: 16px;
    height: 16px;
    color: #6c757d;
    pointer-events: none; /* Makes the icon non-interactive */
}

.config-search-input {
    width: 100%;
    background: white;
    border: 1px solid #dee2e6;
    border-radius: 4px;
    padding: 8px 12px;
    color: #333;
    font-size: 14px;
    outline: none;
}

/* Category Section Styles */
.config-category {
    border-bottom: 1px solid #f1f3f4;
}

.config-category-header {
    font-size: 14px;
    padding: 16px 20px;
    background: #fff;
    border-bottom: 1px solid #e1e5e9;
    cursor: pointer;
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-weight: 400;
    color: #495057;
    transition: background 0.2s;
}

.config-category-header:hover {
    background: #e9ecef;
}

.config-category-header.active {
    background: #e9ecef;
    color: #121212;
}

.config-category-arrow {
    transition: transform 0.3s ease;
}

.config-category.open .config-category-arrow {
    transform: rotate(180deg);
}

.config-category-items {
    display: none;
    background: white;
}

.config-category.open .config-category-items {
    display: block;
}

.config-subcategory {
    padding: 12px 20px 12px 40px;
    font-weight: 500;
    color: #666;
    border-bottom: 1px solid #f8f9fa;
    background: #fafbfc;
    font-size: 14px;
}

.config-item {
    padding: 10px 20px;
    cursor: pointer;
    color: #333;
    border-bottom: 1px solid #f1f3f4;
    transition: background 0.2s;
    display: flex;
    align-items: center;
    font-size: 14px;
    font-weight: 400;
}

.config-item:hover {
    background: #f8f9fa;
    color: #353182;
}

.config-item.sub-item {
    padding-left: 60px;
    font-size: 13px;
}

/* Overlay for drawer */
.config-drawer-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100vw;
    height: 100vh;
    background: rgba(0, 0, 0, 0.3);
    z-index: 999;
    opacity: 0;
    visibility: hidden;
    transition: all 0.3s ease;
}

.config-drawer-overlay.show {
    opacity: 1;
    visibility: visible;
}
.config-drawer-close {
    background: none;
    border: none;
    font-size: 20px;
    cursor: pointer;
    color: #666;
    padding: 4px;
    border-radius: 4px;
    transition: background 0.2s;
    width: 30px;
    height: 30px;
    display: flex;
    align-items: center;
    justify-content: center;
}

.config-drawer-close:hover {
    background: #e9ecef;
    color: #333;
}


/* === FINAL CORRECTED CSS FOR REDESIGNED MEMBER HEADER === */
.header-content-wrapper {
    display: flex;
    flex-direction: column;
    gap: 16px; /* Space between the two main cards */
}
.header-card {
    border: 1px solid #e1e5e9;

}
#identity-section {
    background: #ffffff;
}
#accordion-section {
    background: #fff; /* Light gray background for the second card */
}

/* Test Scenario Controls */
#headerTestControls {
    display: flex; flex-wrap: wrap; gap: 8px;
    padding-bottom: 16px;
    margin-bottom: 16px;
    border-bottom: 1px solid #e9ecef;
}
#headerTestControls button {
    background: #f1f3f4; border: 1px solid #dee2e6; padding: 6px 12px;
    font-size: 11px; border-radius: 4px; cursor: pointer; font-weight: 500;
}
#headerTestControls button:hover { background: #e9ecef; }
#headerTestControls button.active { background: #353182; color: white; border-color: #353182; }

/* Identity Bar */
.identity-bar {
    display: flex;
    align-items: center;
    gap: 16px;
    flex-wrap: wrap; 
    padding: 16px 16px 16px 16px;
}
.identity-bar .member-name {
    font-size: 18px; font-weight: 600; display: flex; align-items: center; gap: 8px;
}
.identity-bar .id-item {
    display: flex; align-items: center; gap: 6px; font-size: 13px; color: #555;
}
.identity-bar .id-item svg { width: 16px; height: 16px; color: #888; }
/* CORRECTED CSS for Identity Bar Buttons */
.identity-bar .more-ids-btn, .identity-bar .notes-btn {
    /* Shared styles - NO margin-left:auto here */
    color: #353182;
    background: #f0f0f0;
    border: 1px solid #dee2e6;
    border-radius: 4px;
    padding: 6px 12px;
    font-size: 12px;
    font-weight: 500;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 6px;
}

.identity-bar .notes-btn {
    margin-left: auto; /* Apply auto margin ONLY to the notes button */
}

/* Main Accordion for Cards */
.card-accordion-header {
    padding-right: 16px; cursor: pointer; display: flex;
    justify-content: space-between; align-items: center;
}
.card-accordion-title-group {
    display: flex; gap: 24px; font-size: 14px; font-weight: 600; color: #333;
    padding: 16px 16px;
}
.card-accordion-arrow { transition: transform 0.3s ease; }
.card-accordion-content {
    display: none; padding-top: 16px;
}
.card-accordion-section.open .card-accordion-content { display: grid;padding: 16px 16px; } /* Changed to grid */
.card-accordion-section.open .card-accordion-arrow { transform: rotate(180deg); }
.card-accordion-section .card-accordion-content {
    grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
    gap: 16px;
}

/* Context Cards */
.context-card {
    border: 1px solid #d1d5db; border-radius: 8px; background: white;
    display: none; /* JS will show the active one */
    height: 194px;
}
.context-card.active { display: block; }
.card-header {
    padding: 16px 16px; border-bottom: 1px solid #e9ecef; display: flex;
    justify-content: space-between; align-items: center;
    height: 56px;
}
.card-title { font-size: 13px; font-weight: 600; color: #1f2937; }
.card-nav { display: flex; gap: 4px; }
.card-nav-btn {
    width: 24px; height: 24px; border-radius: 50%; border: 1px solid #ccc;
    background: white; cursor: pointer; display: flex; align-items: center; justify-content: center;
}
.card-body { padding: 16px; }
.risk-category { font-size: 12px; color: #666; margin-bottom: 16px; }
.journey-item {
    display: grid; grid-template-columns: 20px 90px 1fr auto;
    align-items: center; gap: 8px; margin-bottom: 12px; font-size: 13px;
}
.journey-item .status-dot { width: 8px; height: 8px; border-radius: 50%; justify-self: center; }
.status-dot.green { background-color: #28a745; }
.status-dot.orange { background-color: #ff8c00; }
.journey-item .item-label { font-weight: 500; color: #555; }
.journey-item .item-value a { color: #353182; text-decoration: none; border-bottom: 1px dashed #353182; }
.journey-item .item-more { font-size: 11px; color: #353182; cursor: pointer; }
.journey-item .item-date { font-size: 11px; color: #777; justify-self: end; }
.journey-item .item-value.not-available { color: #999; font-style: italic; }

/* "Other Information" Accordion */
.other-info-accordion { margin-top: 12px; }
.other-info-accordion .accordion-header {
    padding: 16px 16px; border-top: 1px solid #d1d5db;
}

/* Generic Modal for Popups */
.items-modal-overlay {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(0,0,0,0.5); display: flex; align-items: center;
    justify-content: center; z-index: 5000;
}
.items-modal-content {
    background: white; border-radius: 8px; padding: 24px; max-width: 600px;
    width: 90%; max-height: 80vh; display: flex; flex-direction: column;
    box-shadow: 0 5px 15px rgba(0,0,0,0.3);
}
.items-modal-header {
    display: flex; justify-content: space-between; align-items: center;
    margin-bottom: 20px; border-bottom: 1px solid #eee; padding-bottom: 16px;
}
.items-modal-body { overflow-y: auto; flex-grow: 1; }
.items-modal-list-item {
    border: 1px solid #e1e5e9; border-radius: 8px; padding: 16px;
    display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 12px;
}
.items-modal-list-item a { color: #353182; text-decoration: none; font-weight: 600; }
.status-badge-modal {
    padding: 4px 8px; border-radius: 12px; font-size: 11px;
    font-weight: 600; text-transform: uppercase; color: white;
}
.status-badge-modal.completed { background-color: #28a745; }
.status-badge-modal.in-progress { background-color: #f59e0b; }
.status-badge-modal.planned { background-color: #6c757d; }


/* ADD THIS CSS for Other Info and ID Modal */
.other-info-accordion .accordion-header {
    border-top: 1px solid #d1d5db;
    border-bottom: none;
    width: 100%;
}
.other-info-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 24px 48px;
}
.other-info-title {
    font-size: 13px;
    color: #353182;
    font-weight: 600;
    margin-bottom: 16px;
    padding-bottom: 6px;
    border-bottom: 2px solid #353182;
    text-transform: uppercase;
}
.info-pair {
    display: flex;
    justify-content: space-between;
    font-size: 14px;
    padding: 8px 0;
    border-bottom: 1px solid #f0f0f0;
}
.info-pair .info-label {
    color: #666;
    font-weight: 500;
}
.info-pair .info-value {
    color: #333;
    font-weight: 500;
    text-align: right;
}

/* FINAL CSS for Risk Category Colors */
.risk-category {
    font-size: 12px;
    color: #666;
    margin-bottom: 16px;
    display: flex; /* This is the key change */
    align-items: center; /* This vertically aligns the text and dot */
    gap: 44px; /* This adds a small space */
}
.risk-category-display {
    display: flex;
    align-items: center;
    gap: 6px;
    font-weight: 500;
}
.risk-category-display::before {
    content: '';
    width: 8px;
    height: 8px;
    border-radius: 50%;
    display: inline-block;
}
.risk-low { color: #28a745; }
.risk-low::before { background-color: #28a745; }

.risk-medium { color: #ff8c00; }
.risk-medium::before { background-color: #ff8c00; }

.risk-high { color: #dc3545; }
.risk-high::before { background-color: #dc3545; }

/* === ADD THIS CSS FOR RECENT ITEMS FEATURE === */

/* Global Recents (Header Dropdown) */
.recent-items-menu {
    position: relative;
}



.recent-dropdown-header {
    padding: 10px 15px;
    font-size: 14px;
    font-weight: 600;
    color: #333;
    border-bottom: 1px solid #f1f3f4;
}

.recent-item {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 12px 15px;
    text-decoration: none;
    transition: background-color 0.2s;
    border-bottom: 1px solid #f1f3f4;
}

.recent-item:hover {
    background-color: #f8f9fa;
}

.recent-item-icon {
    width: 20px;
    height: 20px;
    color: #555;
    flex-shrink: 0;
}

.recent-item-details {
    overflow: hidden;
}

.recent-item-title {
    font-size: 14px;
    font-weight: 500;
    color: #333;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

.recent-item-subtitle {
    font-size: 12px;
    color: #666;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

.recent-dropdown-footer {
    padding: 10px 15px;
    text-align: center;
    font-size: 13px;
    border-top: 1px solid #e1e5e9;
    background-color: #f8f9fa;
}

.recent-dropdown-footer a {
    color: #353182;
    text-decoration: none;
    font-weight: 500;
}

.recent-dropdown-footer a:hover {
    text-decoration: underline;
}

.no-recents {
    padding: 20px;
    text-align: center;
    font-size: 13px;
    color: #666;
}

/* Member-Specific Recents (Dashboard Card) */
.activity-list {
    list-style: none;
    padding: 0;
    margin: 0;
    display: flex;
    flex-direction: column;
    gap: 16px;
    padding: 4px;
}

.activity-item {
    display: flex;
    align-items: center;
    gap: 10px;
    font-size: 13px;
    color: #444;
}

.activity-item-icon {
    width: 16px;
    height: 16px;
    color: #666;
    flex-shrink: 0;
}

.activity-item-text {
    flex-grow: 1;
}

.activity-item-time {
    font-size: 11px;
    color: #888;
    flex-shrink: 0;
}

.no-activity {
    font-size: 13px;
    color: #666;
    text-align: center;
    padding: 20px 0;
}


 .tab-content > .tab-pane {
    display: none; /* Hide all tab content panels by default */
 }

.tab-content > .tab-pane.active {
    display: block; /* Show only the one with the 'active' class */
 }  



 /* === NEW CSS FOR MEMBER LIST PAGE === */
.member-list-container {
    padding: 24px;
}

.table-controls {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
}

.search-bar {
    position: relative;
    display: flex;
    align-items: center;
}

.search-bar input {
    border: 1px solid #ced4da;
    border-radius: 4px;
    padding: 8px 12px 8px 34px;
    font-size: 14px;
    min-width: 300px;
}

.search-bar svg {
    position: absolute;
    left: 10px;
    top: 50%;
    transform: translateY(-50%);
    color: #6c757d;
    width: 16px;
    height: 16px;
}

.table-wrapper {
    width: 100%;
    overflow-x: auto;
    border: 1px solid #e1e5e9;
    border-radius: 8px;
}

.member-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 13px;
}

.member-table th, .member-table td {
    padding: 12px 15px;
    text-align: left;
    border-bottom: 1px solid #e9ecef;
    white-space: nowrap;
}

.member-table thead {
    background: #f8f9fa;
}

.member-table th {
    font-weight: 600;
    font-size: 12px;
    color: #495057;
    text-transform: uppercase;
}

.member-table tbody tr {
    cursor: pointer;
    transition: background-color 0.2s;
}

.member-table tbody tr:hover {
    background-color: #f1f3f4;
}

.member-table a {
    color: #353182;
    text-decoration: none;
    font-weight: 500;
}
.member-table a:hover {
    text-decoration: underline;
}

/* Filter Modal */
.filter-modal-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.5);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 4000;
}

.filter-modal-content {
    background: white;
    border-radius: 8px;
    padding: 24px;
    width: 90%;
    max-width: 600px;
}

.filter-modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
    padding-bottom: 16px;
    border-bottom: 1px solid #e1e5e9;
}

.filter-modal-body {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 20px;
}

.filter-modal-body .form-field {
    display: flex;
    flex-direction: column;
}

.filter-modal-body label {
    font-size: 12px;
    color: #666;
    margin-bottom: 6px;
    font-weight: 500;
}

.filter-modal-body select {
    width: 100%;
    padding: 8px 12px;
    border: 1px solid #ced4da;
    border-radius: 4px;
    font-size: 14px;
}

.filter-modal-footer {
    display: flex;
    justify-content: flex-end;
    gap: 12px;
    margin-top: 24px;
    padding-top: 16px;
    border-top: 1px solid #e1e5e9;
}

/* Back to List Button */
.back-to-list-btn {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    color: #353182;
    text-decoration: none;
    font-size: 14px;
    font-weight: 500;
    margin-right: 12px;
}
.back-to-list-btn:hover {
    text-decoration: underline;
}

.member-table tbody tr td:first-child {
    color: #353182;
    font-weight: 500;
    cursor: pointer;
}

/* ADD THIS CSS TO YOUR <style> TAG */

/* Main bar layout improvements */
.identity-bar {
    display: flex;
    align-items: center;
    gap: 16px;
    flex-wrap: wrap; /* Allows wrapping for smaller screens */
}

/* Group the IDs and the 'more' button together */
.id-group {
    display: flex;
    align-items: center;
    gap: 16px;
    flex-shrink: 1; /* Allows this group to shrink */
    min-width: 0;   /* CRITICAL: Allows shrinking below content size */
}

/* Ensure notes button is always on the right */
.identity-bar .notes-btn {
    margin-left: auto;
    flex-shrink: 0; /* Prevents the button itself from shrinking */
}

/* Truncation for long ID values */
.id-item > span {
   white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    max-width: 160px; /* Adjust this value if needed */
    display: inline-block; /* Necessary for overflow to work on a span */
    vertical-align: middle; /* Aligns text better with the icon */
}

/* ========== NEW: Search Dropdown Styles ========== */
.search-dropdown {
    position: absolute;
    top: 100%;
    left: 0;
    right: 0;
    background: white;
    border: 1px solid #e0e0e0;
    border-radius: 12px;
    margin-top: 8px;
    box-shadow: 0 8px 24px rgba(0, 0, 0, 0.12);
    max-height: 600px;
    overflow-y: auto;
    display: none;
    z-index: 9999;
    min-width: 500px; /* Ensure minimum width */
}

.search-helper-text {
    padding: 16px 20px 12px 20px;
    font-size: 13px;
    color: #555;
    background: white;
    border-bottom: none;
    font-weight: 400;
    line-height: 1.5;
}

.header-search-input {
    width: 100%;
    padding: 14px 12px 14px 12px;
    border: 2px solid #e0e0e0;
    border-radius: 10px;
    font-size: 15px;
    outline: none;
    transition: all 0.2s;
    font-weight: 400;
    border: none;
    background: #f8f9fa;
}

.header-search-container::before {
    content: "";
    position: absolute;
    left: 18px;
    top: 50%;
    transform: translateY(-50%);
    font-size: 18px;
    pointer-events: none;
    opacity: 0.5;
}

.header-search-container {
    position: relative;
    flex: 1;
    max-width: 600px;
    z-index: 10000;  /* <-- ADD THIS LINE if not present */
}

.search-dropdown.active {
    display: block;
}

.search-filters {
    padding: 12px 20px 16px 20px;
    border-bottom: 1px solid #f0f0f0;
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
    background: #fafafa;
    border-radius: 0;
}
.filter-chip {
    padding: 8px 16px;
    border: 1px solid #d0d0d0;
    border-radius: 20px;
    background: white;
    font-size: 13px;
    cursor: pointer;
    transition: all 0.2s;
    font-weight: 500;
    white-space: nowrap;
}

.filter-chip:hover {
    border-color: #4F46E5;
    background: #F0F0FF;
}

.filter-chip.active {
    background: #4F46E5;
    color: white;
    border-color: #4F46E5;
}

.search-results-header {
    padding: 16px 20px;
    font-size: 12px;
    color: #888;
    border-bottom: 1px solid #f0f0f0;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    background: #fafafa;
}

.search-result-item {
    padding: 16px 20px;
    border-bottom: 1px solid #f5f5f5;
    cursor: pointer;
    transition: all 0.2s;
}

.search-result-item:hover {
    background-color: #f8f9ff;
    border-left: 3px solid #4F46E5;
    padding-left: 17px;
}

.search-result-item:last-child {
    border-bottom: none;
}

.result-name {
    font-weight: 600;
    font-size: 15px;
    color: #1a1a1a;
    margin-bottom: 6px;
    display: flex;
    align-items: center;
    gap: 10px;
}

.result-details {
    font-size: 13px;
    color: #666;
    line-height: 1.8;
    display: flex;
    flex-wrap: wrap;
    gap: 12px;
}

.result-details::before {
    content: none;
}

.result-badge {
    display: inline-block;
    padding: 2px 8px;
    border-radius: 4px;
    font-size: 11px;
    font-weight: 600;
    margin-left: 8px;
}

.result-badge.high {
    background: #FEE2E2;
    color: #DC2626;
}

.result-badge.medium {
    background: #FEF3C7;
    color: #D97706;
}

.result-badge.low {
    background: #DBEAFE;
    color: #2563EB;
}

.search-no-results {
    padding: 48px 24px;
    text-align: center;
    color: #888;
}

.search-no-results p:first-child {
    font-size: 15px;
    font-weight: 500;
    color: #333;
    margin-bottom: 8px;
}

.result-detail-item {
    display: inline-flex;
    align-items: center;
    gap: 4px;
}

.result-detail-separator {
    color: #ddd;
    margin: 0 4px;
}

.search-loading {
    padding: 24px;
    text-align: center;
    color: #666;
}

.recent-searches-section {
    padding: 8px 0;
}

.recent-search-item {
    padding: 12px 16px;
    cursor: pointer;
    transition: background-color 0.2s;
    display: flex;
    align-items: center;
    gap: 10px;
}

.recent-search-item:hover {
    background-color: #f8f8f8;
}

.recent-icon {
    color: #999;
    font-size: 14px;
}

.recent-name {
    font-size: 14px;
    color: #333;
}


/* User Profile Wrapper */
.user-profile-menu {
    position: relative; /* CRITICAL: Anchors the dropdown to this button */
    /* margin-left: 12px;
    padding-left: 12px;
    border-left: 1px solid #e1e5e9; */
}

/* The Button Styling */
.user-profile-trigger {
    display: flex;
    align-items: center;
    gap: 8px; /* Reduced gap since avatar is gone */
    background: none;
    border: none;
    cursor: pointer;
    padding: 4px 8px;
    border-radius: 6px;
    text-align: right;
    transition: background-color 0.2s;
}

.user-profile-trigger:hover {
    background-color: #f1f3f4;
}

/* User Text Info */
.user-info {
    display: flex;
    flex-direction: column;
    align-items: flex-start;
    justify-content: center;
    line-height: 1.2;
}

.user-name-text {
    font-size: 14px;
    font-weight: 600;
    color: #333;
}

.user-role-text {
    font-size: 11px;
    color: #666;
    font-weight: 500;
    text-transform: uppercase;
    letter-spacing: 0.3px;
}

/* Dropdown Menu Box */
.dropdown-menu {
    display: none; /* Hidden by default */
    position: absolute;
    top: 100%;
    right: 0;
    background-color: white;
    border: 1px solid #e1e5e9;
    border-radius: 8px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    min-width: 160px;
    z-index: 1010;
    margin-top: 8px;
    overflow: hidden;
}

/* CRITICAL: This class makes it appear */
.dropdown-menu.show {
    display: block !important;
}

.dropdown-item {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 12px 16px;
    font-size: 14px;
    color: #333;
    text-decoration: none;
    transition: background-color 0.2s;
}

.dropdown-item:hover {
    background-color: #f8f9fa;
}

/* History Drawer Styles */
.history-list {
    display: flex;
    flex-direction: column;
    overflow-y: auto;
    height: 100%;
}

.history-item {
    padding: 16px 20px;
    border-bottom: 1px solid #f1f3f4;
    transition: background-color 0.2s;
    display: flex;
    flex-direction: column;
    gap: 4px;
    text-decoration: none; /* For the anchor tag */
}

.history-item:hover {
    background-color: #f8f9fa;
}

.history-title {
    font-size: 14px;
    font-weight: 600;
    color: #353182;
    line-height: 1.4;
}

.history-url {
    font-size: 11px;
    color: #888;
    font-family: monospace;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

.history-time {
    font-size: 11px;
    color: #666;
    margin-top: 4px;
    display: flex;
    align-items: center;
    gap: 4px;
}

.history-empty {
    padding: 30px;
    text-align: center;
    color: #666;
    font-size: 13px;
}

/* ========== END: Search Dropdown Styles ========== */



/* Floating Trigger Button */

.ai-error, .ai-simple {
    padding: 16px;
    text-align: center;
    color: #6b7280;
    font-size: 13px;
}



/* 
   AI CO-PILOT v2 - Airtable-Inspired Design
    */

/* TRIGGER BUTTON */
.ai-copilot-trigger {
    position: fixed;
    bottom: 24px;
    right: 24px;
    width: 52px;
    height: 52px;
    border-radius: 50%;
    background: linear-gradient(135deg, #2d2d52 0%, #222245 100%);
    border: none;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    box-shadow: 0 4px 16px rgba(45, 45, 82, 0.35), 0 1px 3px rgba(0,0,0,0.1);
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    z-index: 999;
}
.ai-copilot-trigger:hover {
    transform: scale(1.08);
    box-shadow: 0 6px 24px rgba(45, 45, 82, 0.45);
}
.ai-copilot-trigger svg { width: 26px; height: 26px; color: white; }
.ai-copilot-trigger .notification-dot {
    position: absolute; top: 6px; right: 6px; width: 10px; height: 10px;
    background: #ef4444; border-radius: 50%; border: 2px solid white;
}
.ai-copilot-trigger .keyboard-hint {
    position: absolute; right: 64px; background: #1e293b; color: white;
    padding: 6px 12px; border-radius: 6px; font-size: 12px; white-space: nowrap;
    opacity: 0; pointer-events: none; transition: opacity 0.2s;
}
.ai-copilot-trigger:hover .keyboard-hint { opacity: 1; }
.ai-copilot-trigger .keyboard-hint kbd {
    background: rgba(255,255,255,0.15); padding: 2px 6px; border-radius: 3px; margin-left: 6px;
}
body.ai-panel-open .ai-copilot-trigger { opacity: 0; pointer-events: none; }

/* PANEL */
.ai-copilot-panel {
    position: fixed; top: 0; right: 0; width: 440px; height: 100vh;
    background: #ffffff; border-left: 1px solid #e2e8f0;
    display: flex; flex-direction: column; z-index: 1001;
    transform: translateX(100%); transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1), width 0.3s cubic-bezier(0.4, 0, 0.2, 1), left 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
}
.ai-copilot-panel.open { transform: translateX(0); box-shadow: -8px 0 30px rgba(0,0,0,0.08); }
.ai-copilot-panel.closed { transform: translateX(100%); }
.ai-copilot-panel * { box-sizing: border-box; }

/* EXPANDED / FULL VIEW */
.ai-copilot-panel.expanded {
    width: 100vw; left: 0; right: 0;
    border-left: none;
    box-shadow: none;
}
.ai-copilot-panel.expanded .ai-copilot-header {
    padding: 14px 32px;
    max-width: 900px;
    margin: 0 auto;
    width: 100%;
}
.ai-copilot-panel.expanded .ai-copilot-messages {
    max-width: 900px;
    margin: 0 auto;
    width: 100%;
    padding-left: 16px;
    padding-right: 16px;
}
.ai-copilot-panel.expanded .ai-copilot-input {
    max-width: 900px;
    margin: 0 auto;
    width: 100%;
    padding: 12px 32px;
}
.ai-copilot-panel.expanded .ai-welcome-screen {
    padding-top: 80px;
}
.ai-copilot-panel.expanded .ai-welcome-heading {
    font-size: 26px;
}
.ai-copilot-panel.expanded .ai-data-table-wrap {
    max-height: none;
}
/* Expand button icon toggle */
.ai-expand-icon-expand { display: block; }
.ai-expand-icon-collapse { display: none; }
.ai-copilot-panel.expanded .ai-expand-icon-expand { display: none; }
.ai-copilot-panel.expanded .ai-expand-icon-collapse { display: block; }

/* HEADER */
.ai-copilot-header {
    padding: 14px 16px; display: flex; align-items: center; justify-content: space-between;
    border-bottom: 1px solid #e2e8f0; background: #fff; flex-shrink: 0;
}
.ai-copilot-header-left { display: flex; align-items: center; gap: 10px; }
.ai-copilot-avatar {
    width: 32px; height: 32px; border-radius: 8px; display: flex; align-items: center; justify-content: center;
    background: linear-gradient(135deg, #2d2d52, #222245); flex-shrink: 0;
}
.ai-copilot-avatar svg { width: 18px; height: 18px; color: white; }
.ai-copilot-title { font-size: 14px; font-weight: 600; color: #0f172a; }
.ai-copilot-subtitle { font-size: 11px; color: #64748b; }
.ai-copilot-header-actions { display: flex; gap: 4px; align-items: center; }
.ai-copilot-header-btn {
    background: transparent; border: none; color: #94a3b8; width: 32px; height: 32px;
    border-radius: 6px; cursor: pointer; display: flex; align-items: center; justify-content: center;
    transition: all 0.15s;
}
.ai-copilot-header-btn:hover { background: #f1f5f9; color: #475569; }
.ai-copilot-header-btn svg { width: 16px; height: 16px; }

/* MAIN CONTENT AREA */
.ai-copilot-messages {
    flex: 1; overflow-y: auto; overflow-x: hidden; display: flex; flex-direction: column;
}
.ai-copilot-messages::-webkit-scrollbar { width: 5px; }
.ai-copilot-messages::-webkit-scrollbar-track { background: transparent; }
.ai-copilot-messages::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }

/* WELCOME SCREEN */
.ai-welcome-screen { padding: 40px 24px 20px; text-align: center; }
.ai-welcome-dots {
    display: flex; justify-content: center; gap: 6px; margin-bottom: 20px;
}
.ai-welcome-dots .dot {
    width: 10px; height: 10px; border-radius: 50%; background: #2d2d52;
    transition: opacity 0.3s;
}
/* Static dots - no animation. Just a nice gradient of opacities */
.ai-welcome-dots .dot:nth-child(1) { opacity: 0.2; }
.ai-welcome-dots .dot:nth-child(2) { opacity: 0.35; }
.ai-welcome-dots .dot:nth-child(3) { opacity: 0.55; }
.ai-welcome-dots .dot:nth-child(4) { opacity: 1; }
.ai-welcome-dots .dot:nth-child(5) { opacity: 0.55; }
.ai-welcome-dots .dot:nth-child(6) { opacity: 0.35; }
.ai-welcome-dots .dot:nth-child(7) { opacity: 0.2; }
/* Only animate dots when .thinking class is added */
.ai-welcome-dots.thinking .dot {
    animation: aiDotPulse 1.8s ease-in-out infinite;
}
.ai-welcome-dots.thinking .dot:nth-child(1) { animation-delay: 0s; }
.ai-welcome-dots.thinking .dot:nth-child(2) { animation-delay: 0.15s; }
.ai-welcome-dots.thinking .dot:nth-child(3) { animation-delay: 0.3s; }
.ai-welcome-dots.thinking .dot:nth-child(4) { animation-delay: 0.45s; }
.ai-welcome-dots.thinking .dot:nth-child(5) { animation-delay: 0.6s; }
.ai-welcome-dots.thinking .dot:nth-child(6) { animation-delay: 0.75s; }
.ai-welcome-dots.thinking .dot:nth-child(7) { animation-delay: 0.9s; }
@keyframes aiDotPulse {
    0%, 100% { transform: scale(0.8); opacity: 0.3; }
    50% { transform: scale(1.2); opacity: 1; }
}
.ai-welcome-heading {
    font-size: 20px; font-weight: 600; color: #0f172a; margin-bottom: 4px;
}

/* TABS */
.ai-tabs-container {
    display: flex; gap: 0; padding: 0 20px; border-bottom: 1px solid #e2e8f0;
    background: #fff; flex-shrink: 0; overflow-x: auto;
}
.ai-tab-btn {
    padding: 10px 14px; border: none; background: none; cursor: pointer;
    font-size: 13px; font-weight: 500; color: #64748b; white-space: nowrap;
    border-bottom: 2px solid transparent; transition: all 0.2s; position: relative;
}
.ai-tab-btn:hover { color: #0f172a; }
.ai-tab-btn.active { color: #2d2d52; border-bottom-color: #2d2d52; font-weight: 600; }

/* QUESTIONS LIST */
.ai-questions-panel { padding: 8px 16px 16px; flex: 1; overflow-y: auto; }
.ai-question-item {
    display: block; width: 100%; text-align: left; padding: 11px 14px;
    border: none; background: none; cursor: pointer; font-size: 13px; color: #334155;
    border-bottom: 1px solid #f1f5f9; transition: all 0.15s; line-height: 1.4;
    font-family: inherit;
}
.ai-question-item:hover { background: #f8fafc; color: #2d2d52; }
.ai-question-item.smart {
    background: linear-gradient(135deg, #f8f7ff 0%, #f0f0f5 100%);
    color: #2d2d52; font-weight: 600; border-bottom: 1px solid #e4e4f0;
}
.ai-question-item.smart:hover { background: linear-gradient(135deg, #f0eeff 0%, #e8e8f4 100%); }
.ai-question-item:last-child { border-bottom: none; }

/*  SMART CONTEXTUAL QUESTIONS  */
.ai-smart-section { padding: 10px 14px 4px; border-bottom: 1px solid #e2e8f0; margin-bottom: 4px; }
.ai-smart-section-heading { font-size: 10px; font-weight: 700; color: #94a3b8; text-transform: uppercase; letter-spacing: 0.6px; margin-bottom: 8px; display: flex; align-items: center; gap: 5px; }
.ai-smart-section-heading::after { content: ''; flex: 1; height: 1px; background: #f1f5f9; }
.ai-smart-q { display: flex; align-items: flex-start; gap: 8px; padding: 9px 11px; margin-bottom: 5px; border-radius: 8px; border: 1px solid #e8e4f8; background: linear-gradient(135deg, #faf9ff 0%, #f4f2fc 100%); cursor: pointer; width: 100%; text-align: left; font-family: inherit; transition: all 0.15s; }
.ai-smart-q:hover { border-color: #2d2d52; background: linear-gradient(135deg, #f0eeff 0%, #e8e4f8 100%); transform: translateY(-1px); box-shadow: 0 2px 6px rgba(45,45,82,0.1); }
.ai-smart-q.urgency-critical { border-color: #fecaca; background: linear-gradient(135deg, #fff5f5 0%, #fff0f0 100%); }
.ai-smart-q.urgency-critical:hover { border-color: #ef4444; background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%); }
.ai-smart-q.urgency-high { border-color: #fed7aa; background: linear-gradient(135deg, #fffbf5 0%, #fff7ed 100%); }
.ai-smart-q.urgency-high:hover { border-color: #f97316; background: linear-gradient(135deg, #ffedd5 0%, #fed7aa 100%); }
.ai-smart-q-dot { width: 7px; height: 7px; border-radius: 50%; flex-shrink: 0; margin-top: 4px; }
.urgency-critical .ai-smart-q-dot { background: #ef4444; box-shadow: 0 0 0 2px rgba(239,68,68,0.2); }
.urgency-high .ai-smart-q-dot     { background: #f97316; box-shadow: 0 0 0 2px rgba(249,115,22,0.2); }
.urgency-normal .ai-smart-q-dot   { background: #8b5cf6; box-shadow: 0 0 0 2px rgba(139,92,246,0.2); }
.ai-smart-q-body { flex: 1; min-width: 0; }
.ai-smart-q-text { font-size: 12px; font-weight: 600; color: #1e293b; line-height: 1.4; margin-bottom: 2px; }
.ai-smart-q.urgency-critical .ai-smart-q-text { color: #991b1b; }
.ai-smart-q.urgency-high .ai-smart-q-text     { color: #9a3412; }
.ai-smart-q-reason { font-size: 10px; color: #64748b; line-height: 1.4; font-style: italic; }
.ai-smart-q-arrow { font-size: 13px; color: #cbd5e1; align-self: center; flex-shrink: 0; transition: color 0.15s; }
.ai-smart-q:hover .ai-smart-q-arrow { color: #2d2d52; }

/*  ACTIVITY PICKER  */
.ai-activity-picker { padding: 4px 0; }
.ai-picker-heading { font-size: 11px; font-weight: 700; color: #64748b; text-transform: uppercase; letter-spacing: 0.4px; margin-bottom: 10px; padding: 0 2px; }
.ai-picker-empty { padding: 24px 16px; text-align: center; background: #f8fafc; border-radius: 8px; border: 1px dashed #cbd5e1; margin-bottom: 12px; }
.ai-picker-empty .empty-icon { font-size: 22px; margin-bottom: 6px; }
.ai-picker-empty p { font-size: 12px; color: #64748b; margin: 0 0 12px; }
.ai-picker-item { display: flex; align-items: flex-start; gap: 10px; padding: 10px 12px; margin-bottom: 6px; border: 1px solid #e2e8f0; border-radius: 8px; background: #fff; cursor: pointer; transition: all 0.15s; width: 100%; text-align: left; font-family: inherit; }
.ai-picker-item:hover { border-color: #2d2d52; background: #f8f8fc; }
.ai-picker-item:hover .picker-arrow { opacity: 1; }
.ai-picker-badge { padding: 2px 7px; border-radius: 10px; font-size: 9px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.3px; flex-shrink: 0; margin-top: 1px; }
.badge-task    { background: #ede9fe; color: #6d28d9; }
.badge-consent { background: #fef3c7; color: #92400e; }
.badge-adt     { background: #fee2e2; color: #dc2626; }
.badge-appt    { background: #dcfce7; color: #166534; }
.picker-body { flex: 1; min-width: 0; }
.picker-title { font-size: 12px; font-weight: 600; color: #1e293b; margin-bottom: 2px; }
.picker-meta  { font-size: 11px; color: #64748b; }
.picker-arrow { font-size: 14px; color: #94a3b8; opacity: 0; transition: opacity 0.15s; align-self: center; }
.ai-picker-general-btn { width: 100%; padding: 9px 12px; margin-top: 4px; background: #f8fafc; border: 1px dashed #cbd5e1; border-radius: 8px; font-size: 11px; color: #64748b; cursor: pointer; font-family: inherit; transition: all 0.15s; }
.ai-picker-general-btn:hover { border-color: #94a3b8; color: #475569; background: #f1f5f9; }

/*  AI IMPROVE BUTTON  */
.ai-improve-section { display: flex; align-items: center; gap: 8px; margin: 4px 0 12px; }
.ai-improve-btn { display: inline-flex; align-items: center; gap: 5px; padding: 6px 12px; background: linear-gradient(135deg, #2d2d52 0%, #4c3d8f 100%); color: white; border: none; border-radius: 6px; font-size: 11px; font-weight: 600; cursor: pointer; font-family: inherit; transition: all 0.2s; box-shadow: 0 1px 4px rgba(45,45,82,0.25); }
.ai-improve-btn:hover { background: linear-gradient(135deg, #3d3d6b 0%, #5c4da0 100%); transform: translateY(-1px); }
.ai-improve-btn:disabled { opacity: 0.7; cursor: not-allowed; transform: none; }
.ai-improve-btn svg { flex-shrink: 0; }
.ai-improve-status { font-size: 11px; font-weight: 500; }
.ai-improve-spinner { display: inline-block; width: 10px; height: 10px; border: 2px solid rgba(255,255,255,0.3); border-top-color: white; border-radius: 50%; animation: ai-spin 0.7s linear infinite; }
@keyframes ai-spin { to { transform: rotate(360deg); } }

/*  INLINE DRAFT NOTE BUTTON  */
.task-draft-note-btn { display: inline-flex; align-items: center; gap: 3px; padding: 2px 7px; font-size: 10px; font-weight: 600; color: #2d2d52; background: #f0f0f8; border: 1px solid #c7c7e8; border-radius: 4px; cursor: pointer; font-family: inherit; transition: all 0.15s; white-space: nowrap; }
.task-draft-note-btn:hover { background: #2d2d52; color: white; border-color: #2d2d52; }

/*  FREE-TEXT CHAT RESPONSE STYLES  */
.ai-llm-response { font-size: 13px; color: #1e293b; line-height: 1.65; }
.ai-llm-response p   { margin: 0 0 10px; }
.ai-llm-response p:last-child { margin-bottom: 0; }
.ai-llm-response strong, .ai-llm-response b { color: #0f172a; font-weight: 600; }
.ai-llm-response ul, .ai-llm-response ol { margin: 6px 0 10px 16px; padding: 0; }
.ai-llm-response li  { margin-bottom: 4px; }
.ai-llm-response h3  { font-size: 13px; font-weight: 700; color: #0f172a; margin: 12px 0 6px; }
.ai-llm-response h4  { font-size: 12px; font-weight: 700; color: #334155; margin: 10px 0 4px; }
.ai-llm-response code { font-size: 11px; background: #f1f5f9; padding: 1px 5px; border-radius: 3px; font-family: monospace; color: #334155; }
.ai-llm-response hr  { border: none; border-top: 1px solid #e2e8f0; margin: 10px 0; }
.ai-chat-turn { margin-bottom: 2px; }
.ai-chat-turn + .ai-chat-turn { border-top: 1px solid #f1f5f9; padding-top: 2px; }

/*  CARE PLAN AI SCREENS  */
.ai-cp-summary-block { padding: 2px 0; }
.ai-cp-need-card { background: #fff; border: 1px solid #e2e8f0; border-radius: 8px; margin-bottom: 8px; overflow: hidden; }
.ai-cp-need-header { display: flex; align-items: center; gap: 8px; padding: 10px 12px; background: #f8fafc; border-bottom: 1px solid #e2e8f0; }
.ai-cp-need-badge { padding: 2px 8px; border-radius: 10px; font-size: 9px; font-weight: 700; text-transform: uppercase; }
.badge-cp-inprogress { background: #fff7ed; color: #c2410c; }
.badge-cp-identified { background: #ede9fe; color: #5b21b6; }
.badge-cp-met        { background: #dcfce7; color: #166534; }
.badge-cp-onhold     { background: #fee2e2; color: #dc2626; }
.ai-cp-need-title { font-size: 12px; font-weight: 600; color: #1e293b; flex: 1; }
.ai-cp-need-meta  { font-size: 10px; color: #64748b; }
.ai-cp-need-goals { padding: 8px 12px 10px; }
.ai-cp-goal-row { display: flex; align-items: flex-start; gap: 6px; padding: 4px 0; border-bottom: 1px solid #f1f5f9; font-size: 11px; }
.ai-cp-goal-row:last-child { border-bottom: none; }
.ai-cp-goal-text { flex: 1; color: #334155; line-height: 1.4; }
.ai-cp-goal-status { font-size: 10px; font-weight: 600; padding: 1px 6px; border-radius: 8px; white-space: nowrap; }
.goal-status-inprogress { background: #fff7ed; color: #c2410c; }
.goal-status-planned    { background: #ede9fe; color: #5b21b6; }
.goal-status-met        { background: #dcfce7; color: #166534; }
.goal-status-atrisk     { background: #fee2e2; color: #dc2626; }
.ai-cp-empty { padding: 24px; text-align: center; color: #64748b; font-size: 12px; background: #f8fafc; border-radius: 8px; border: 1px dashed #cbd5e1; }
.ai-cp-print-btn { display: inline-flex; align-items: center; gap: 5px; padding: 6px 12px; background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 6px; font-size: 11px; font-weight: 600; color: #334155; cursor: pointer; font-family: inherit; transition: all 0.15s; margin-bottom: 12px; }
.ai-cp-print-btn:hover { background: #f1f5f9; border-color: #cbd5e1; }
.ai-cp-stat-row { display: flex; gap: 8px; margin-bottom: 12px; }
.ai-cp-stat { flex: 1; background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 6px; padding: 8px 10px; text-align: center; }
.ai-cp-stat .num { font-size: 18px; font-weight: 700; color: #2d2d52; }
.ai-cp-stat .lbl { font-size: 10px; color: #64748b; margin-top: 2px; }
.ai-cp-action-form { padding: 4px 0; }
.ai-cp-need-row { display: flex; align-items: center; gap: 10px; padding: 9px 12px; border: 1px solid #e2e8f0; border-radius: 8px; margin-bottom: 6px; background: #fff; }
.ai-cp-need-row-label { flex: 1; font-size: 12px; color: #1e293b; }
.ai-cp-need-row-cat { font-size: 10px; color: #64748b; margin-top: 2px; }
.ai-cp-date-input { padding: 4px 8px; border: 1px solid #e2e8f0; border-radius: 5px; font-size: 11px; color: #1e293b; font-family: inherit; }
.ai-cp-suggest-card { border: 1px solid #e8e4f8; border-radius: 8px; background: linear-gradient(135deg, #faf9ff 0%, #f4f2fc 100%); margin-bottom: 6px; cursor: pointer; transition: all 0.15s; box-sizing: border-box; width: 100%; }
.ai-cp-suggest-card:hover { border-color: #2d2d52; background: linear-gradient(135deg, #f0eeff 0%, #e8e4f8 100%); }
.ai-cp-suggest-card input[type=radio] { margin-right: 8px; }
.ai-cp-suggest-title { font-size: 12px; font-weight: 600; color: #1e293b; }
.ai-cp-suggest-cat { font-size: 10px; color: #64748b; margin-top: 2px; }
.ai-cp-save-btn { padding: 8px 16px; background: linear-gradient(135deg, #2d2d52 0%, #4c3d8f 100%); color: white; border: none; border-radius: 6px; font-size: 12px; font-weight: 600; cursor: pointer; font-family: inherit; width: 100%; margin-top: 8px; transition: all 0.15s; }
.ai-cp-save-btn:hover { background: linear-gradient(135deg, #3d3d6b 0%, #5c4da0 100%); }
.ai-cp-save-btn:disabled { opacity: 0.6; cursor: not-allowed; }
.ai-cp-goal-select { padding: 3px 6px; border: 1px solid #e2e8f0; border-radius: 4px; font-size: 11px; font-family: inherit; }

@media print {
    body > *:not(#aiCpPrintArea) { display: none !important; }
    #aiCpPrintArea { display: block !important; padding: 20px; font-family: Arial, sans-serif; }
    #aiCpPrintArea .no-print { display: none !important; }
}

/* INPUT AREA */
.ai-copilot-input {
    padding: 12px 16px; border-top: 1px solid #e2e8f0; background: #fff; flex-shrink: 0;
}
.ai-input-wrapper {
    display: flex; align-items: center; gap: 8px; background: #f8fafc;
    border: 1px solid #e2e8f0; border-radius: 10px; padding: 4px 4px 4px 14px;
    transition: border-color 0.2s;
}
.ai-input-wrapper:focus-within { border-color: #2d2d52; background: #fff; }
.ai-input-field {
    flex: 1; border: none; background: none; font-size: 13px; color: #0f172a;
    outline: none; padding: 8px 0; font-family: inherit;
}
.ai-input-field::placeholder { color: #94a3b8; }
.ai-input-tools-row { display: flex; gap: 8px; padding-top: 8px; align-items: center; }
.ai-tools-btn {
    display: flex; align-items: center; gap: 4px; padding: 4px 10px;
    border: 1px solid #e2e8f0; border-radius: 6px; background: #fff;
    font-size: 11px; color: #64748b; cursor: pointer; transition: all 0.15s;
}
.ai-tools-btn:hover { border-color: #2d2d52; color: #2d2d52; }
.ai-tools-btn svg { width: 12px; height: 12px; }
.ai-send-btn {
    width: 34px; height: 34px; border-radius: 8px; border: none;
    background: #2d2d52; color: white; cursor: pointer;
    display: flex; align-items: center; justify-content: center;
    transition: all 0.15s; flex-shrink: 0;
}
.ai-send-btn:hover { background: #222245; }
.ai-send-btn:disabled { background: #e2e8f0; color: #94a3b8; cursor: default; }
.ai-send-btn svg { width: 16px; height: 16px; }

/* CONVERSATION MODE */
.ai-conv-user {
    padding: 8px 20px; display: flex; justify-content: flex-end;
}
.ai-conv-user-bubble {
    background: #2d2d52; color: white; padding: 10px 16px;
    border-radius: 14px 14px 4px 14px; max-width: 85%; font-size: 13px; line-height: 1.4;
}
.ai-conv-assistant { padding: 12px 20px; }

/* THINKING ANIMATION - Enhanced */
.ai-thinking-container {
    display: flex; align-items: center; gap: 12px; padding: 8px 20px 12px;
}
.ai-thinking-dots {
    display: flex; gap: 5px; align-items: center;
}
.ai-thinking-dots .tdot {
    width: 8px; height: 8px; border-radius: 50%; background: #2d2d52;
    animation: aiThinkWave 1.6s infinite ease-in-out;
}
.ai-thinking-dots .tdot:nth-child(1) { animation-delay: 0s; }
.ai-thinking-dots .tdot:nth-child(2) { animation-delay: 0.2s; }
.ai-thinking-dots .tdot:nth-child(3) { animation-delay: 0.4s; }
@keyframes aiThinkWave {
    0%, 60%, 100% { transform: translateY(0) scale(0.85); opacity: 0.35; }
    30% { transform: translateY(-8px) scale(1.1); opacity: 1; }
}
.ai-thinking-text { font-size: 13px; color: #2d2d52; font-weight: 500; }

/* Shimmer bar alternative for longer waits */
.ai-thinking-shimmer {
    height: 3px; background: #eeeef5; border-radius: 3px; overflow: hidden;
    margin: 0 20px 12px; position: relative;
}
.ai-thinking-shimmer::after {
    content: ''; position: absolute; top: 0; left: -40%;
    width: 40%; height: 100%; border-radius: 3px;
    background: linear-gradient(90deg, transparent, #2d2d52, transparent);
    animation: aiShimmerSlide 1.5s infinite ease-in-out;
}
@keyframes aiShimmerSlide {
    0% { left: -40%; }
    100% { left: 100%; }
}

/* RESPONSE AREA */
.ai-response-block { padding: 0 20px 8px; }
.ai-response-summary {
    font-size: 13px; color: #334155; line-height: 1.55; margin-bottom: 12px;
}
.ai-response-summary strong { color: #0f172a; }
.ai-record-count {
    display: inline-flex; align-items: center; gap: 6px;
    font-size: 12px; color: #64748b; margin-bottom: 10px;
    background: #f1f5f9; padding: 4px 10px; border-radius: 6px;
}
.ai-record-count .count-num { font-weight: 700; color: #2d2d52; }

/* DATA TABLE */
.ai-data-table-wrap {
    border: 1px solid #e2e8f0; border-radius: 8px; overflow-x: auto; overflow-y: hidden; margin-bottom: 12px;
    background: #fff; -webkit-overflow-scrolling: touch;
}
.ai-data-table {
    min-width: 500px; width: 100%; border-collapse: collapse; font-size: 12px;
}
.ai-data-table thead th {
    background: #f8fafc; padding: 8px 10px; text-align: left;
    font-weight: 600; color: #475569; border-bottom: 1px solid #e2e8f0;
    white-space: nowrap; font-size: 11px; text-transform: uppercase; letter-spacing: 0.3px;
    position: sticky; top: 0;
}
.ai-data-table tbody tr { border-bottom: 1px solid #f1f5f9; cursor: pointer; transition: background 0.1s; }
.ai-data-table tbody tr:hover { background: #f8fafc; }
.ai-data-table tbody tr:last-child { border-bottom: none; }
.ai-data-table tbody td {
    padding: 9px 10px; color: #334155; vertical-align: middle; white-space: nowrap;
}
.ai-data-table .td-name { font-weight: 500; color: #2d2d52; cursor: pointer; }
.ai-data-table .td-name:hover { text-decoration: underline; }
.ai-data-table .td-member { color: #2d2d52; cursor: pointer; }
.ai-data-table .td-member:hover { text-decoration: underline; }

/* Status/Priority badges in tables */
.ai-badge {
    display: inline-block; padding: 2px 8px; border-radius: 10px;
    font-size: 10px; font-weight: 600; white-space: nowrap;
}
.ai-badge.high, .ai-badge.critical { background: #fef2f2; color: #dc2626; }
.ai-badge.medium { background: #fefce8; color: #ca8a04; }
.ai-badge.low { background: #f0fdf4; color: #16a34a; }
.ai-badge.open { background: #eff6ff; color: #2563eb; }
.ai-badge.overdue { background: #fef2f2; color: #dc2626; }
.ai-badge.closed { background: #f1f5f9; color: #64748b; }
.ai-badge.in-progress { background: #fefce8; color: #ca8a04; }
.ai-badge.draft { background: #fef3c7; color: #d97706; }
.ai-badge.posted { background: #dcfce7; color: #166534; }
.ai-badge.risk-high { background: #fef2f2; color: #dc2626; }
.ai-badge.risk-medium { background: #fefce8; color: #ca8a04; }
.ai-badge.risk-low { background: #f0fdf4; color: #16a34a; }

/* SHOW THINKING SECTION */
.ai-show-thinking {
    margin: 4px 0 12px; font-size: 12px;
}
.ai-show-thinking-toggle {
    display: inline-flex; align-items: center; gap: 4px; cursor: pointer;
    color: #64748b; background: none; border: none; font-size: 12px;
    padding: 4px 0; transition: color 0.15s; font-family: inherit;
}
.ai-show-thinking-toggle:hover { color: #2d2d52; }
.ai-show-thinking-toggle .arrow { transition: transform 0.2s; font-size: 10px; }
.ai-show-thinking-toggle.open .arrow { transform: rotate(90deg); }
.ai-thinking-content {
    display: none; margin-top: 8px; padding: 10px 12px;
    background: #f8fafc; border-radius: 6px; border: 1px solid #e2e8f0;
    font-size: 12px; color: #64748b; line-height: 1.5;
}
.ai-thinking-content.visible { display: block; }

/* FEEDBACK */
.ai-feedback-row {
    display: flex; align-items: center; gap: 8px; margin: 4px 0 12px;
}
.ai-feedback-btn {
    background: none; border: none; cursor: pointer; padding: 4px;
    color: #94a3b8; transition: all 0.15s; border-radius: 4px;
}
.ai-feedback-btn:hover { color: #475569; background: #f1f5f9; }
.ai-feedback-btn svg { width: 14px; height: 14px; }

/* FOLLOW-UPS */
.ai-followups { margin-top: 8px; padding: 0 0 12px; }
.ai-followups-label {
    font-size: 11px; font-weight: 600; color: #94a3b8; text-transform: uppercase;
    letter-spacing: 0.5px; margin-bottom: 6px;
}
.ai-followup-item {
    display: block; width: 100%; text-align: left; padding: 8px 12px;
    border: none; background: #f8fafc; cursor: pointer; font-size: 12px; color: #334155;
    margin-bottom: 4px; border-radius: 6px; transition: all 0.15s;
    line-height: 1.3; font-family: inherit;
}
.ai-followup-item:hover { background: #eeeef5; color: #222245; }

/* BACK BUTTON */
.ai-back-row { padding: 8px 0 16px; }
.ai-back-btn {
    background: none; border: none; cursor: pointer; font-size: 12px;
    color: #64748b; padding: 6px 0; transition: color 0.15s; font-family: inherit;
}
.ai-back-btn:hover { color: #2d2d52; }

/* LOAD MORE */
.ai-load-more-btn {
    display: block; width: 100%; padding: 8px; border: 1px dashed #cbd5e1;
    background: none; border-radius: 6px; cursor: pointer; font-size: 12px;
    color: #64748b; margin-bottom: 12px; transition: all 0.15s; font-family: inherit;
}
.ai-load-more-btn:hover { border-color: #2d2d52; color: #2d2d52; background: #f0f0f5; }

/* EMPTY STATE */
.ai-empty-state {
    text-align: center; padding: 20px; color: #64748b;
}
.ai-empty-state .emoji { font-size: 32px; margin-bottom: 8px; }
.ai-empty-state .title { font-size: 14px; font-weight: 600; color: #166534; margin-bottom: 4px; }
.ai-empty-state .desc { font-size: 12px; }

/* AI APPOINTMENT FORM */
.ai-appt-form { padding: 0; }
.ai-appt-form .form-title {
    font-weight: 600; font-size: 12px; color: #1e293b;
    display: flex; align-items: center; gap: 6px;
    padding-bottom: 12px; margin-bottom: 16px; border-bottom: 1px solid #e2e8f0;
}
.ai-appt-form .form-title svg { width: 15px; height: 15px; color: #2d2d52; flex-shrink: 0; }

/* Smart AI suggestion banner */
.ai-appt-form .ai-smart-hint {
    background: linear-gradient(135deg, #f0f0f5 0%, #e8e8f4 100%);
    border: 1px solid #d4d4e8; border-left: 3px solid #2d2d52;
    border-radius: 0 6px 6px 0;
    padding: 10px 12px; margin-bottom: 20px;
    font-size: 11px; line-height: 1.5; color: #1e293b;
}
.ai-appt-form .ai-smart-hint .hint-label {
    font-size: 9px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px;
    color: #2d2d52; margin-bottom: 4px; display: flex; align-items: center; gap: 4px;
}
.ai-appt-form .ai-smart-hint .hint-label svg { width: 11px; height: 11px; }
.ai-appt-form .ai-smart-hint .hint-text { font-weight: 500; }
.ai-appt-form .ai-smart-hint .hint-reason { color: #64748b; font-size: 10px; margin-top: 3px; display: block; font-style: italic; }
.ai-appt-form .ai-smart-hint .hint-apply {
    display: inline-block; margin-top: 6px; padding: 3px 10px;
    background: #2d2d52; color: #fff; border: none; border-radius: 4px;
    font-size: 10px; font-weight: 600; cursor: pointer; font-family: inherit;
    transition: background 0.15s;
}
.ai-appt-form .ai-smart-hint .hint-apply:hover { background: #3d3d6b; }

.ai-appt-form .field-group { margin-bottom: 20px; }
.ai-appt-form .field-label {
    font-size: 10px; font-weight: 600; color: #64748b; text-transform: uppercase;
    letter-spacing: 0.4px; margin-bottom: 6px; display: block;
}
.ai-appt-form .field-label .req { color: #ef4444; margin-left: 1px; }
.ai-appt-form .field-label .opt { color: #94a3b8; font-weight: 400; text-transform: none; letter-spacing: 0; font-size: 9px; margin-left: 2px; }
.ai-appt-form input[type="text"],
.ai-appt-form input[type="date"],
.ai-appt-form input[type="datetime-local"],
.ai-appt-form textarea,
.ai-appt-form select {
    width: 100%; padding: 9px 10px; border: 1px solid #e2e8f0; border-radius: 6px;
    font-size: 12px; font-family: inherit; color: #1e293b; background: #fff;
    transition: border-color 0.15s, box-shadow 0.15s; box-sizing: border-box;
}
.ai-appt-form input:focus, .ai-appt-form textarea:focus, .ai-appt-form select:focus {
    outline: none; border-color: #2d2d52; box-shadow: 0 0 0 2px rgba(45,45,82,0.06);
}
.ai-appt-form textarea { resize: vertical; min-height: 44px; }
.ai-appt-form .datetime-row {
    display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 20px;
}
.ai-appt-form .datetime-row .field-group { margin-bottom: 0; }
.ai-appt-form input[type="datetime-local"],
.ai-appt-form input[type="date"] { font-size: 11px; padding: 9px 6px; }
.ai-appt-form select { padding: 9px 10px; appearance: auto; }
.ai-appt-form .form-divider { border: none; border-top: 1px solid #e2e8f0; margin: 4px 0 18px; }
.ai-appt-form .form-actions { display: flex; gap: 8px; }
.ai-appt-form .btn-create-appt {
    flex: 1; padding: 10px 14px; background: #2d2d52; color: #fff; border: none;
    border-radius: 6px; font-size: 12px; font-weight: 600; cursor: pointer;
    font-family: inherit; transition: background 0.15s;
}
.ai-appt-form .btn-create-appt:hover { background: #3d3d6b; }
.ai-appt-form .btn-create-appt:disabled { background: #94a3b8; cursor: not-allowed; }
.ai-appt-form .btn-cancel-appt {
    padding: 10px 14px; background: #f8fafc; color: #64748b; border: 1px solid #e2e8f0;
    border-radius: 6px; font-size: 12px; font-weight: 500; cursor: pointer;
    font-family: inherit; transition: all 0.15s;
}
.ai-appt-form .btn-cancel-appt:hover { background: #e2e8f0; color: #475569; }
.ai-appt-form .form-error { font-size: 10px; color: #ef4444; margin-top: 3px; display: none; }
.ai-appt-form .form-error.show { display: block; }
.ai-appt-confirm {
    padding: 14px; background: #f0fdf4; border: 1px solid #bbf7d0; border-radius: 8px;
}
.ai-appt-confirm .confirm-icon { font-size: 20px; margin-bottom: 4px; }
.ai-appt-confirm .confirm-title { font-weight: 600; font-size: 13px; color: #166534; margin-bottom: 8px; }
.ai-appt-confirm .confirm-detail { font-size: 11px; color: #1e293b; line-height: 1.8; }
.ai-appt-confirm .confirm-detail strong { color: #166534; }

/* Header appointment button */
.ai-header-appt-btn {
    display: none; align-items: center; gap: 4px; padding: 3px 8px;
    background: #f0f0f5; border: 1px solid #e2e8f0; border-radius: 4px;
    font-size: 10px; font-weight: 600; color: #2d2d52; cursor: pointer;
    font-family: inherit; transition: all 0.15s; white-space: nowrap;
}
.ai-header-appt-btn:hover { background: #e4e4f0; border-color: #2d2d52; }
.ai-header-appt-btn svg { width: 12px; height: 12px; }
.ai-header-appt-btn.visible { display: inline-flex; }

/* SMART AGENDA CARDS  matches ai-activity-card design */
.ai-agenda-list { display: flex; flex-direction: column; gap: 8px; margin-bottom: 12px; }
.ai-agenda-card {
    padding: 12px; border: 1px solid #e2e8f0; border-radius: 8px; background: #fff;
}
.ai-agenda-card-header {
    display: flex; align-items: center; gap: 8px; margin-bottom: 6px;
}
.ai-agenda-card-header .num {
    font-size: 11px; font-weight: 700; color: #64748b;
    min-width: 18px;
}
.ai-agenda-card-header .topic {
    font-size: 12px; font-weight: 600; color: #1e293b; flex: 1;
}
.ai-agenda-card .reason {
    font-size: 11px; color: #64748b; line-height: 1.5;
    padding-left: 26px; margin-bottom: 6px;
}
.ai-agenda-card .action {
    font-size: 11px; color: #334155; line-height: 1.5;
    padding: 8px 10px; background: #f8fafc; border-radius: 6px;
    margin-left: 26px;
}

/* ACTIVITY SUMMARY CARDS */
.ai-activity-grid {
    display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 12px;
}
.ai-activity-card {
    padding: 12px; border: 1px solid #e2e8f0; border-radius: 8px; background: #fff;
    transition: all 0.15s;
}
.ai-activity-card.clickable {
    cursor: pointer;
}
.ai-activity-card.clickable:hover {
    border-color: #2d2d52; background: #f8f8fc;
    box-shadow: 0 2px 8px rgba(45,45,82,0.08);
}
.ai-activity-card .label { font-size: 11px; color: #64748b; margin-bottom: 4px; }
.ai-activity-card .value { font-size: 20px; font-weight: 700; color: #0f172a; }
.ai-activity-card .sub { font-size: 11px; color: #94a3b8; margin-top: 2px; }
.ai-activity-card.clickable .sub { color: #2d2d52; opacity: 0.6; }
.ai-activity-card.clickable:hover .sub { opacity: 1; }

/* AUTOSUGGEST */
.ai-autosuggest {
    display: none; position: absolute; bottom: 100%; left: 16px; right: 16px;
    background: white; border: 1px solid #e2e8f0; border-radius: 8px;
    box-shadow: 0 -4px 12px rgba(0,0,0,0.08); max-height: 200px; overflow-y: auto;
    z-index: 10;
}
.ai-autosuggest-item {
    padding: 8px 12px; cursor: pointer; font-size: 12px; color: #334155;
    border-bottom: 1px solid #f1f5f9;
}
.ai-autosuggest-item:hover { background: #f0f0f5; color: #222245; }

/* QUESTIONS MODAL */
.questions-modal {
    display: none; position: absolute; top: 0; left: 0; right: 0; bottom: 0;
    background: white; z-index: 20; flex-direction: column;
}
.questions-modal.visible { display: flex; }
.questions-modal-header {
    padding: 14px 16px; display: flex; align-items: center; justify-content: space-between;
    border-bottom: 1px solid #e2e8f0;
}
.questions-modal-title { font-size: 14px; font-weight: 600; color: #0f172a; }
.questions-modal-close {
    background: none; border: none; cursor: pointer; color: #94a3b8;
    padding: 4px; border-radius: 4px;
}
.questions-modal-close:hover { color: #475569; background: #f1f5f9; }
.questions-modal-content { flex: 1; overflow-y: auto; padding: 16px; }

/* CONTEXT BAR */
.ai-copilot-context {
    display: none; /* Hidden by default, shown when context changes */
}


/* 
   TASK VIEW STYLES - Full functionality from task-bulk-assign-v2
    */

            /* Title Row - matches Screenshot 2 */
            .title-row {
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin-bottom: 16px;
            }

            .title-row-right {
                display: flex;
                align-items: center;
                gap: 12px;
            }

            /* Assign Action Button */
            .btn-assign-action {
                padding: 10px 20px;
                border-radius: 6px;
                border: 1px solid #494581;
                background: white;
                color: #494581;
                cursor: pointer;
                font-size: 14px;
                font-weight: 500;
                display: flex;
                align-items: center;
                gap: 8px;
                transition: all 0.2s;
            }

            .btn-assign-action:hover:not(:disabled) {
                background: #494581;
                color: white;
            }

            .btn-assign-action:disabled {
                border-color: #ccc;
                color: #999;
                cursor: not-allowed;
                background: #f5f5f5;
            }

            .btn-assign-action .btn-icon {
                font-size: 16px;
            }

            /* Top Controls */
            .top-controls {
                display: flex;
                align-items: center;
                gap: 12px;
                margin-bottom: 16px;
                flex-wrap: wrap;
            }

            .search-box {
                flex: 1;
                min-width: 300px;
                position: relative;
            }

            .search-box input {
                width: 100%;
                padding: 10px 40px 10px 16px;
                border: 1px solid #d0d0d0;
                border-radius: 6px;
                font-size: 14px;
            }

            .search-icon {
                position: absolute;
                right: 12px;
                top: 50%;
                transform: translateY(-50%);
                color: #666;
            }

            .btn {
                padding: 10px 20px;
                border-radius: 6px;
                border: 1px solid #d0d0d0;
                background: white;
                cursor: pointer;
                font-size: 14px;
                display: flex;
                align-items: center;
                gap: 8px;
                transition: all 0.2s;
            }

            .btn-link {
                padding: 10px 20px;
                border: none;
                background: transparent;
                cursor: pointer;
                font-size: 14px;
                color: #494581;
                text-decoration: underline;
                display: flex;
                align-items: center;
                gap: 8px;
                transition: all 0.2s;
            }

            .btn-link:hover {
                color: #494581;
                background: transparent;
            }

            .btn:hover {
                background: #f5f5f5;
            }

            .btn-primary {
                background: #494581;
                color: white;
                border-color: #494581;
            }

            .btn-primary:hover {
                background: #494581;
            }

            /* Quick Filters Row */
            .quick-filters-row {
                display: flex;
                align-items: center;
                gap: 16px;
                padding: 12px 0;
                border-top: 1px solid #e0e0e0;
                border-bottom: 1px solid #e0e0e0;
                margin-bottom: 16px;
                flex-wrap: nowrap;
                overflow-x: auto;
                overflow-y: visible;
                overflow: visible !important;
                justify-content: space-between;
            }

            .quick-filters-left {
                display: flex;
                align-items: center;
                gap: 16px;
                flex: 1;
            }

            .quick-filters-right {
                display: flex;
                align-items: center;
                margin-left: auto;
            }

            .filter-group {
                display: flex;
                align-items: center;
                gap: 6px;
                flex-shrink: 0;
            }

            .filter-group-label {
                font-size: 13px;
                color: #666;
                font-weight: 500;
                white-space: nowrap;
            }

            /* Dropdown Filters */
            .filter-dropdown {
                position: relative;
                z-index: 500;
            }

            .filter-dropdown-button {
                padding: 6px 12px;
                border-radius: 6px;
                border: 1px solid #d0d0d0;
                background: white;
                cursor: pointer;
                font-size: 14px;
                color: #333;
                display: flex;
                align-items: center;
                gap: 6px;
                transition: all 0.2s;
                white-space: nowrap;
                min-width: 100px;
            }

            .filter-dropdown-button.filter-select-style {
                min-width: 120px;
                padding: 8px 12px;
            }

            .filter-dropdown-button:hover {
                border-color: #494581;
            }

            .filter-dropdown-button.active {
                background: #494581;
                color: white;
                border-color: #494581;
            }

            .filter-dropdown-icon {
                margin-left: auto;
                font-size: 10px;
            }

            .filter-dropdown-menu {
                position: absolute;
                top: calc(100% + 4px);
                left: 0;
                background: white;
                border: 1px solid #d0d0d0;
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                padding: 8px;
                z-index: 501;
                min-width: 180px;
                display: none;
            }

            .filter-dropdown-menu.open {
                display: block;
            }

            .filter-dropdown-item {
                display: flex;
                align-items: center;
                gap: 8px;
                padding: 8px 12px;
                cursor: pointer;
                border-radius: 4px;
                font-size: 13px;
                transition: background 0.2s;
            }

            .filter-dropdown-item:hover {
                background: #f5f5f5;
            }

            .filter-dropdown-item input[type="checkbox"] {
                width: 16px;
                height: 16px;
                cursor: pointer;
            }

            .filter-dropdown-item-label {
                flex: 1;
            }

            .filter-dropdown-item-count {
                font-size: 11px;
                color: #666;
            }

            .filter-checkbox {
                display: flex;
                align-items: center;
                gap: 6px;
                cursor: pointer;
                font-size: 12px;
                color: #333;
                white-space: nowrap;
            }

            .filter-checkbox input[type="checkbox"] {
                width: 15px;
                height: 15px;
                cursor: pointer;
            }

            .filter-count-badge {
                font-size: 10px;
                opacity: 0.75;
            }

            /* Active Filters */
            .active-filters-row {
                display: flex;
                align-items: center;
                gap: 12px;
                margin-bottom: 16px;
                min-height: 36px;
            }

            .active-filters {
                display: flex;
                align-items: center;
                gap: 12px;
                margin-bottom: 16px;
                padding: 8px 0;
                justify-content: space-between;
            }

            .active-filters-left {
                display: flex;
                align-items: center;
                gap: 12px;
                flex: 1;
            }

            .active-filters-right {
                display: flex;
                align-items: center;
                margin-left: auto;
            }

            .active-filters-label {
                display: flex;
                align-items: center;
                gap: 8px;
                font-size: 14px;
                color: #333;
            }

            .filter-count {
                background: #ff6b35;
                color: white;
                border-radius: 50%;
                width: 20px;
                height: 20px;
                display: inline-flex;
                align-items: center;
                justify-content: center;
                font-size: 12px;
                font-weight: 600;
            }

            .filter-chip {
                display: inline-flex;
                align-items: center;
                gap: 8px;
                padding: 6px 12px;
                background: #f0f0f0;
                border-radius: 20px;
                font-size: 13px;
                color: #333;
            }

            .filter-chip-close {
                cursor: pointer;
                color: #666;
                font-size: 16px;
                line-height: 1;
            }

            .filter-chip-close:hover {
                color: #ff4444;
            }

            /* Date Picker Modal */
            .date-picker-modal {
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0,0,0,0.4);
                display: none;
                align-items: center;
                justify-content: center;
                z-index: 1001;
            }

            .date-picker-modal.open {
                display: flex;
            }

            .date-picker-container {
                background: white;
                border-radius: 8px;
                padding: 24px;
                box-shadow: 0 8px 24px rgba(0,0,0,0.2);
                max-width: 700px;
            }

            .date-picker-header {
                display: flex;
                gap: 16px;
                margin-bottom: 20px;
            }

            .date-input-group {
                flex: 1;
            }

            .date-input-label {
                font-size: 12px;
                color: #666;
                margin-bottom: 4px;
            }

            .date-input {
                width: 100%;
                padding: 10px 12px;
                border: 1px solid #d0d0d0;
                border-radius: 6px;
                font-size: 14px;
                background: white;
            }

            .date-picker-calendars {
                display: flex;
                gap: 24px;
                margin-bottom: 20px;
            }

            .calendar {
                flex: 1;
            }

            .calendar-header {
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin-bottom: 12px;
            }

            .calendar-nav {
                background: none;
                border: none;
                cursor: pointer;
                font-size: 18px;
                padding: 4px 8px;
                color: #666;
            }

            .calendar-nav:hover {
                color: #494581;
            }

            .calendar-title {
                font-size: 14px;
                font-weight: 600;
            }

            .calendar-grid {
                display: grid;
                grid-template-columns: repeat(7, 1fr);
                gap: 4px;
            }

            .calendar-day-header {
                text-align: center;
                font-size: 11px;
                color: #666;
                padding: 8px 4px;
                font-weight: 500;
            }

            .calendar-day {
                aspect-ratio: 1;
                display: flex;
                align-items: center;
                justify-content: center;
                border-radius: 50%;
                font-size: 13px;
                cursor: pointer;
                transition: all 0.2s;
            }

            .calendar-day:hover:not(.empty) {
                background: #f0f0f0;
            }

            .calendar-day.empty {
                cursor: default;
            }

            .calendar-day.selected {
                background: #494581;
                color: white;
            }

            .calendar-day.in-range {
                background: #e8edff;
                border-radius: 0;
            }

            .calendar-day.range-start {
                border-top-left-radius: 50%;
                border-bottom-left-radius: 50%;
            }

            .calendar-day.range-end {
                border-top-right-radius: 50%;
                border-bottom-right-radius: 50%;
            }

            .calendar-day.today {
                border: 2px solid #494581;
            }

            .date-picker-actions {
                display: flex;
                justify-content: flex-end;
                gap: 12px;
            }

            /* Table */
            .table-container {
                overflow-x: auto;
                border: 1px solid #e0e0e0;
                border-radius: 8px;
            }

            table {
                width: 100%;
                border-collapse: collapse;
                background: white;
            }

            thead {
                background: #2d2d52;
                color: white;
            }

            th {
                padding: 16px 12px;
                text-align: left;
                font-weight: 500;
                font-size: 13px;
                white-space: nowrap;
            }

            td {
                padding: 16px 12px;
                border-bottom: 1px solid #f0f0f0;
                font-size: 13px;
                color: #333;
            }

            tr:hover {
                background: #f9f9f9;
            }

            .task-name, .member-name {
                color: #494581;
                text-decoration: none;
                cursor: pointer;
            }

            .task-name:hover, .member-name:hover {
                text-decoration: underline;
            }

            .priority-badge {
                display: inline-flex;
                align-items: center;
                gap: 8px;
                padding: 4px 12px;
                border-radius: 12px;
                font-size: 12px;
                font-weight: 500;
            }

            .priority-high {
                background: #ffebee;
                color: #c62828;
            }

            .priority-medium {
                background: #fff3e0;
                color: #ef6c00;
            }

            .priority-low {
                background: #e8f5e9;
                color: #2e7d32;
            }

            .priority-dot {
                width: 8px;
                height: 8px;
                border-radius: 50%;
            }

            .priority-high .priority-dot {
                background: #c62828;
            }

            .priority-medium .priority-dot {
                background: #ef6c00;
            }

            .priority-low .priority-dot {
                background: #2e7d32;
            }

            .status-badge {
                padding: 4px 12px;
                border-radius: 12px;
                font-size: 12px;
                font-weight: 500;
            }

            .status-open {
                background: #e3f2fd;
                color: #1565c0;
            }

            .status-closed {
                background: #f5f5f5;
                color: #666;
            }

            .no-results {
                padding: 60px 20px;
                text-align: center;
                color: #666;
                font-size: 16px;
            }

            .pagination {
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin-top: 20px;
                padding-top: 20px;
                border-top: 1px solid #e0e0e0;
            }

            .page-info {
                color: #666;
                font-size: 14px;
            }

            .page-controls {
                display: flex;
                gap: 12px;
                align-items: center;
            }

            .page-input {
                width: 60px;
                padding: 8px;
                border: 1px solid #d0d0d0;
                border-radius: 4px;
                text-align: center;
            }

            /* Filter Panel (Sidebar) */
            .filter-panel {
                position: fixed;
                top: 0;
                right: -400px;
                width: 400px;
                height: 100vh;
                background: white;
                box-shadow: -2px 0 8px rgba(0,0,0,0.1);
                transition: right 0.3s ease;
                z-index: 1000;
                overflow-y: auto;
            }

            .filter-panel.open {
                right: 0;
            }

            .filter-panel-header {
                background: #5d5d8d;
                color: white;
                padding: 20px;
                display: flex;
                justify-content: space-between;
                align-items: center;
                position: sticky;
                top: 0;
                z-index: 10;
            }

            .filter-panel-title {
                font-size: 18px;
                font-weight: 600;
            }

            .close-panel {
                cursor: pointer;
                font-size: 20px;
                background: none;
                border: none;
                color: white;
                width: 32px;
                height: 32px;
                border-radius: 50%;
                display: flex;
                align-items: center;
                justify-content: center;
            }

            .close-panel:hover {
                background: rgba(255,255,255,0.1);
            }

            .filter-panel-content {
                padding: 24px;
            }

            .filter-section {
                margin-bottom: 24px;
            }

            .filter-section-label {
                font-size: 14px;
                font-weight: 500;
                color: #333;
                margin-bottom: 8px;
            }

            .filter-select {
                width: 100%;
                padding: 10px 12px;
                border: 1px solid #d0d0d0;
                border-radius: 6px;
                font-size: 14px;
                background: white;
                cursor: pointer;
            }

            .filter-panel-actions {
                position: sticky;
                bottom: 0;
                background: white;
                padding: 16px 24px;
                border-top: 1px solid #e0e0e0;
                display: flex;
                gap: 12px;
            }

            .filter-panel-actions .btn {
                flex: 1;
            }

            .overlay {
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0,0,0,0.3);
                display: none;
                z-index: 999;
            }

            .overlay.active {
                display: block;
            }

            /* Bulk Selection Styles */
            .task-checkbox {
                width: 18px;
                height: 18px;
                cursor: pointer;
                accent-color: #494581;
            }

            .header-checkbox {
                width: 18px;
                height: 18px;
                cursor: pointer;
                accent-color: #494581;
            }

            tr.selected {
                background: #e8edff !important;
            }

            tr.selected:hover {
                background: #dde4ff !important;
            }

            /* Assign Modal */
            .assign-modal {
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0,0,0,0.5);
                display: none;
                align-items: center;
                justify-content: center;
                z-index: 1100;
            }

            .assign-modal.open {
                display: flex;
            }

            .assign-modal-content {
                background: white;
                border-radius: 8px;
                width: 600px;
                max-width: 90%;
                box-shadow: 0 8px 32px rgba(0,0,0,0.2);
                animation: modalSlideIn 0.3s ease;
                overflow: visible;
            }

            @keyframes modalSlideIn {
                from {
                    opacity: 0;
                    transform: scale(0.95);
                }
                to {
                    opacity: 1;
                    transform: scale(1);
                }
            }

            .assign-modal-header {
                background: #2d2d52;
                color: white;
                padding: 16px 20px;
                display: flex;
                justify-content: space-between;
                align-items: center;
            }

            .assign-modal-header h3 {
                font-size: 16px;
                font-weight: 500;
                color: white;
                margin: 0;
            }

            .assign-modal-close {
                background: none;
                border: none;
                font-size: 20px;
                color: white;
                cursor: pointer;
                padding: 0;
                line-height: 1;
                opacity: 0.8;
            }

            .assign-modal-close:hover {
                opacity: 1;
            }

            .assign-modal-body {
                padding: 24px;
                overflow: visible;
            }

            .assign-summary {
                background: #f8f9fa;
                border-radius: 8px;
                padding: 16px;
                margin-bottom: 20px;
            }

            .assign-summary-title {
                font-size: 14px;
                font-weight: 600;
                color: #1a1a1a;
                margin-bottom: 12px;
                display: flex;
                align-items: center;
                gap: 8px;
            }

            .assign-summary-title .icon {
                font-size: 18px;
            }

            .assign-summary-details {
                font-size: 13px;
                color: #666;
            }

            .assign-summary-details .detail-item {
                display: flex;
                align-items: flex-start;
                gap: 8px;
                margin-bottom: 8px;
            }

            .assign-summary-details .detail-item:last-child {
                margin-bottom: 0;
            }

            .assign-summary-details .bullet {
                color: #494581;
                font-weight: bold;
            }

            .assign-summary-details .current-assignees {
                margin-left: 16px;
                color: #888;
                font-size: 12px;
            }

            .assign-form-row {
                display: flex;
                gap: 16px;
            }

            .assign-form-row .assign-form-group {
                flex: 1;
            }

            .assign-form-group {
                margin-bottom: 16px;
            }

            .assign-form-group label {
                display: block;
                font-size: 14px;
                font-weight: 500;
                color: #333;
                margin-bottom: 8px;
            }

            /* Custom Select Dropdown - Material UI Style */
            .custom-select {
                position: relative;
                width: 100%;
            }

            .custom-select-trigger {
                display: flex;
                align-items: center;
                justify-content: space-between;
                padding: 10px 12px;
                border: 1px solid #d0d0d0;
                border-radius: 6px;
                background: white;
                cursor: pointer;
                font-size: 14px;
                transition: all 0.2s;
            }

            .custom-select-trigger:hover {
                border-color: #494581;
            }

            .custom-select.open .custom-select-trigger {
                border-color: #494581;
                box-shadow: 0 0 0 3px rgba(76, 111, 255, 0.1);
            }

            .custom-select-value {
                color: #333;
                overflow: hidden;
                text-overflow: ellipsis;
                white-space: nowrap;
            }

            .custom-select-value.placeholder {
                color: #999;
            }

            .custom-select-arrow {
                font-size: 10px;
                color: #666;
                transition: transform 0.2s;
            }

            .custom-select.open .custom-select-arrow {
                transform: rotate(180deg);
            }

            .custom-select-options {
                position: absolute;
                top: 100%;
                left: 0;
                right: 0;
                margin-top: 4px;
                background: white;
                border: 1px solid #e0e0e0;
                border-radius: 6px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                max-height: 250px;
                overflow-y: auto;
                z-index: 1200;
                display: none;
            }

            .custom-select.open .custom-select-options {
                display: block;
            }

            .custom-select-option {
                padding: 10px 12px;
                cursor: pointer;
                font-size: 14px;
                color: #333;
                display: flex;
                align-items: center;
                gap: 8px;
                transition: background 0.15s;
            }

            .custom-select-option:hover {
                background: #f5f5f5;
            }

            .custom-select-option.selected {
                background: #e8edff;
                color: #494581;
                font-weight: 500;
            }

            .custom-select-option.unassign {
                border-bottom: 1px solid #e0e0e0;
            }

            .custom-select-option .check-icon {
                width: 16px;
                color: #494581;
            }

            .custom-select-divider {
                height: 1px;
                background: #e0e0e0;
                margin: 4px 0;
            }

            .assign-form-group label {
                display: block;
                font-size: 14px;
                font-weight: 500;
                color: #333;
                margin-bottom: 8px;
            }

            .assign-form-group label .required {
                color: #c62828;
            }

            .assign-select {
                width: 100%;
                padding: 10px 12px;
                border: 1px solid #d0d0d0;
                border-radius: 6px;
                font-size: 14px;
                background: white;
                cursor: pointer;
                appearance: none;
                background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%23666' d='M6 8L1 3h10z'/%3E%3C/svg%3E");
                background-repeat: no-repeat;
                background-position: right 12px center;
            }

            .assign-select:focus {
                outline: none;
                border-color: #494581;
                box-shadow: 0 0 0 3px rgba(76, 111, 255, 0.1);
            }

            .assign-select:disabled {
                background-color: #f5f5f5;
                cursor: not-allowed;
            }

            .assign-warning {
                display: flex;
                align-items: flex-start;
                gap: 8px;
                padding: 12px;
                background: #fff3e0;
                border-radius: 6px;
                font-size: 13px;
                color: #e65100;
                margin-top: 16px;
            }

            .assign-warning .warning-icon {
                font-size: 16px;
            }

            .assign-modal-footer {
                padding: 16px 20px;
                border-top: 1px solid #e0e0e0;
                display: flex;
                justify-content: flex-end;
                gap: 12px;
                background: #f8f9fa;
            }

            .assign-modal-footer .btn {
                padding: 10px 20px;
                border-radius: 6px;
                font-size: 14px;
                font-weight: 500;
                cursor: pointer;
                transition: all 0.2s;
            }

            .assign-modal-footer .btn-cancel {
                background: white;
                border: 1px solid #d0d0d0;
                color: #666;
            }

            .assign-modal-footer .btn-cancel:hover {
                background: #f5f5f5;
            }

            .assign-modal-footer .btn-confirm {
                background: #494581;
                border: 1px solid #494581;
                color: white;
            }

            .assign-modal-footer .btn-confirm:hover {
                background: #494581;
            }

            .assign-modal-footer .btn-confirm:disabled {
                background: #ccc;
                border-color: #ccc;
                cursor: not-allowed;
            }

            /* Success Toast */
            .toast {
                position: fixed;
                bottom: 30px;
                left: 50%;
                transform: translateX(-50%) translateY(100px);
                background: #2e7d32;
                color: white;
                padding: 14px 24px;
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.2);
                display: flex;
                align-items: center;
                gap: 10px;
                font-size: 14px;
                z-index: 1200;
                opacity: 0;
                transition: all 0.3s ease;
            }

            .toast.show {
                opacity: 1;
                transform: translateX(-50%) translateY(0);
            }

            .toast .toast-icon {
                font-size: 18px;
            }

            /* Three Dot Menu */
            .three-dot-menu {
                position: relative;
            }

            .three-dot-btn {
                background: none;
                border: none;
                cursor: pointer;
                padding: 4px 8px;
                font-size: 18px;
                color: #666;
                border-radius: 4px;
            }

            .three-dot-btn:hover {
                background: #f0f0f0;
            }

            .three-dot-dropdown {
                position: absolute;
                top: 100%;
                right: 0;
                background: white;
                border: 1px solid #e0e0e0;
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                min-width: 160px;
                z-index: 100;
                display: none;
            }

            .three-dot-dropdown.open {
                display: block;
            }

            .three-dot-dropdown-item {
                padding: 10px 16px;
                font-size: 13px;
                color: #333;
                cursor: pointer;
                display: flex;
                align-items: center;
                gap: 8px;
                transition: background 0.2s;
            }

            .three-dot-dropdown-item:hover {
                background: #f5f5f5;
            }

            .three-dot-dropdown-item:first-child {
                border-radius: 8px 8px 0 0;
            }

            .three-dot-dropdown-item:last-child {
                border-radius: 0 0 8px 8px;
            }

            .three-dot-dropdown-item .item-icon {
                font-size: 14px;
            }
            /* Add after line 215 (after .btn-primary styles) */

/* ==================== VIEW SELECTOR STYLES ==================== */
.title-section {
    display: flex;
    align-items: center;
    gap: 16px;
}


.view-selector {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    cursor: pointer;
    padding: 8px 12px;
    border-radius: 6px;
    transition: background 0.2s;
}

.view-selector:hover {
    background: #f5f5f5;
}

.view-name {
    font-size: 20px;
    font-weight: 600;
    color: #1a1a1a;
    text-decoration: underline;
}

.dropdown-arrow {
    font-size: 14px;
    color: #666;
    transition: transform 0.2s;
}

.view-selector.open .dropdown-arrow {
    transform: rotate(180deg);
}

/* View Action Buttons (Star & Delete) */
.view-action-btn {
    background: transparent;
    border: none;
    font-size: 20px;
    cursor: pointer;
    padding: 6px 10px;
    border-radius: 6px;
    transition: all 0.2s;
    display: inline-flex;
    align-items: center;
    justify-content: center;
}

.view-action-btn:hover {
    background: #f5f5f5;
}

.star-btn {
    color: #fbbf24;
}

.star-btn.favorited #starIcon {
    font-weight: bold;
}

.delete-btn {
    color: #ef4444;
}

.delete-btn:hover {
    background: #fee;
}

/* View Dropdown Menu */
.view-dropdown {
    position: absolute;
    top: calc(100% + 8px);
    left: 0;
    background: white;
    border: 1px solid #d0d0d0;
    border-radius: 8px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    min-width: 280px;
    max-height: 400px;
    overflow-y: auto;
    z-index: 1000;
    display: none;
}

.view-dropdown.open {
    display: block;
}

.view-item-actions {
    display: flex;
    gap: 4px;
    align-items: center;
}

.view-item-action-btn {
    padding: 4px;
    background: transparent;
    border: none;
    cursor: pointer;
    border-radius: 4px;
    transition: background 0.2s;
    display: flex;
    align-items: center;
    justify-content: center;
}

.view-item-action-btn:hover {
    background: #f0f0f0;
}

.view-item-action-btn svg {
    width: 16px;
    height: 16px;
    stroke: currentColor;
}

.view-item-action-btn.star-btn {
    color: #fbbf24;
}

.view-item-action-btn.delete-btn {
    color: #ef4444;
}

.view-item-action-btn.star-btn.active {
    fill: #fbbf24;
}

.view-dropdown-item {
    padding: 12px 16px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 12px;
    transition: background 0.2s;
    border-bottom: 1px solid #f0f0f0;
}

.view-dropdown-item:last-child {
    border-bottom: none;
}

.view-dropdown-item:hover {
    background: #f8f9fa;
}

.view-dropdown-item.active {
    background: #e8eeff;
    font-weight: 600;
}

.view-dropdown-item.system-default {
    color: #494581;
    font-weight: 500;
}

.view-item-name {
    flex: 1;
    font-size: 14px;
    color: #1a1a1a;
}

.view-item-star {
    font-size: 16px;
    color: #fbbf24;
    cursor: pointer;
    padding: 4px;
    border-radius: 4px;
    transition: background 0.2s;
}

.view-item-star:hover {
    background: #f5f5f5;
}

.view-item-star.filled {
    font-weight: bold;
}

.view-dropdown-divider {
    height: 1px;
    background: #e0e0e0;
    margin: 4px 0;
}

#savedViewsList:empty::after {
    content: 'No saved views';
    display: block;
    padding: 16px;
    text-align: center;
    color: #999;
    font-size: 14px;
    font-style: italic;
}

/* Save View Buttons */
.btn-save-view,
.btn-save-view-as {
    padding: 10px 16px;
    border-radius: 6px;
    border: 1px solid #494581;
    background: white;
    color: #494581;
    cursor: pointer;
    font-size: 14px;
    font-weight: 500;
    display: inline-flex;
    align-items: center;
    gap: 6px;
    transition: all 0.2s;
}

.btn-save-view:hover,
.btn-save-view-as:hover {
    background: #494581;
    color: white;
}

.btn-save-view-as {
    background: #494581;
    color: white;
}

.btn-save-view-as:hover {
    background: #494581;
}

/* Add this with other view selector styles */

.task-count-badge {
    display: inline-flex;
    align-items: center;
    padding: 4px 12px;
    background: #e8eeff;
    color: #494581;
    border-radius: 16px;
    font-size: 14px;
    font-weight: 500;
    margin-left: 12px;
}

.title-section {
    flex: 1;
}

.page-title {
    font-size: 24px;
    font-weight: 600;
    color: #1a1a1a;
    margin: 0;
}

/* ==================== VIEW SELECTOR STYLES ==================== */
.title-section {
    display: flex;
    align-items: center;
    gap: 16px;
}

.view-selector-container {
    display: flex;
    align-items: center;
    gap: 6px; /* Reduced gap */
}

.view-selector {
    position: relative;
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 8px 16px;
    border: 1px solid #d0d0d0;
    border-radius: 6px;
    cursor: pointer;
    background: white;
    transition: all 0.2s;
    min-width: 180px; /* Reduced width */
}

.view-selector:hover {
    background: #f5f5f5;
}

.view-name {
    font-size: 20px;
    font-weight: 600;
    color: #1a1a1a;
    text-decoration: underline;
}

.dropdown-arrow {
    font-size: 14px;
    color: #666;
    transition: transform 0.2s;
}

.view-selector.open .dropdown-arrow {
    transform: rotate(180deg);
}

/* View Action Buttons (Star & Delete) */
.view-action-btn {
    background: transparent;
    border: none;
    font-size: 20px;
    cursor: pointer;
    padding: 6px 10px;
    border-radius: 6px;
    transition: all 0.2s;
    display: inline-flex;
    align-items: center;
    justify-content: center;
}

.view-action-btn:hover {
    background: #f5f5f5;
}

.star-btn {
    color: #fbbf24;
}

.star-btn.favorited #starIcon {
    font-weight: bold;
}

.delete-btn {
    color: #ef4444;
}

.delete-btn:hover {
    background: #fee;
}

/* Task Count Badge */
.task-count-badge {
    display: inline-flex;
    align-items: center;
    padding: 4px 12px;
    background: #e8eeff;
    color: #494581;
    border-radius: 16px;
    font-size: 14px;
    font-weight: 500;
}

/* View Dropdown Menu */
.view-dropdown {
    position: absolute;
    top: calc(100% + 8px);
    left: 0;
    background: white;
    border: 1px solid #d0d0d0;
    border-radius: 8px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    min-width: 280px;
    max-height: 400px;
    overflow-y: auto;
    z-index: 1000;
    display: none;
}

.view-dropdown.open {
    display: block;
}

.view-dropdown-item {
    padding: 12px 16px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 12px;
    transition: background 0.2s;
    border-bottom: 1px solid #f0f0f0;
}

.view-dropdown-item:last-child {
    border-bottom: none;
}

.view-dropdown-item:hover {
    background: #f8f9fa;
}

.view-dropdown-item.active {
    background: #e8eeff;
    font-weight: 600;
}

.view-dropdown-item.system-default {
    color: #494581;
    font-weight: 500;
}

.view-item-name {
    flex: 1;
    font-size: 14px;
    color: #1a1a1a;
}

.view-item-star {
    font-size: 16px;
    color: #fbbf24;
    cursor: pointer;
    padding: 4px;
    border-radius: 4px;
    transition: background 0.2s;
}

.view-item-star:hover {
    background: #f5f5f5;
}

.view-item-star.filled {
    font-weight: bold;
}

.view-dropdown-divider {
    height: 1px;
    background: #e0e0e0;
    margin: 4px 0;
}

#savedViewsList:empty::after {
    content: 'No saved views';
    display: block;
    padding: 16px;
    text-align: center;
    color: #999;
    font-size: 14px;
    font-style: italic;
}

/* Save View Buttons */
.btn-save-view,
.btn-save-view-as {
    padding: 10px 16px;
    border-radius: 6px;
    border: 1px solid #494581;
    background: white;
    color: #494581;
    cursor: pointer;
    font-size: 14px;
    font-weight: 500;
    display: inline-flex;
    align-items: center;
    gap: 6px;
    transition: all 0.2s;
}

.btn-save-view:hover,
.btn-save-view-as:hover {
    background: #494581;
    color: white;
}

.btn-save-view-as {
    background: #494581;
    color: white;
}

.btn-save-view-as:hover {
    background: #494581;
}
/* New Filter Header Layout */
.filters-header-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: 16px;
    margin-bottom: 16px;
}

.filters-left-section {
    display: flex;
    gap: 12px;
    align-items: center;
    flex: 1;
}

.filters-right-section {
    display: flex;
    gap: 12px;
    align-items: center;
}

/* View Selector - New Design */
.view-selector-wrapper {
    position: relative;
}

.view-selector {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 8px 16px;
    border: 1px solid #d0d0d0;
    border-radius: 6px;
    cursor: pointer;
    background: white;
    transition: all 0.2s;
    min-width: 200px;
}

.view-selector:hover {
    border-color: #494581;
    background: #f8f9ff;
}

.view-selector.open {
    border-color: #494581;
    background: #f8f9ff;
}

.view-icon {
    color: #494581;
    flex-shrink: 0;
}

.view-name {
    font-size: 14px;
    font-weight: 500;
    color: #1a1a1a;
    flex: 1;
}

.dropdown-arrow {
    color: #666;
    flex-shrink: 0;
    transition: transform 0.2s;
}

.view-selector.open .dropdown-arrow {
    transform: rotate(180deg);
}

/* View Dropdown */
.view-dropdown {
    position: absolute;
    top: calc(100% + 8px);
    left: 0;
    right: 0;
    background: white;
    border: 1px solid #e0e0e0;
    border-radius: 8px;
    box-shadow: 0 4px 16px rgba(0,0,0,0.12);
    max-height: 320px;
    overflow-y: auto;
    z-index: 1000;
    display: none;
}

.view-dropdown.open {
    display: block;
}

/* Other Filters Button */
.btn-other-filters {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 8px 16px;
    border: 1px solid #d0d0d0;
    border-radius: 6px;
    background: white;
    cursor: pointer;
    font-size: 14px;
    font-weight: 500;
    color: #1a1a1a;
    transition: all 0.2s;
}

.btn-other-filters:hover {
    border-color: #494581;
    background: #f8f9ff;
    color: #494581;
}

.btn-other-filters svg {
    color: #666;
}

.btn-other-filters:hover svg {
    color: #494581;
}
/* Horizontal Section Divider */
.section-divider {
    width: 100%;
    height: 1px;
    background: #e0e0e0;
    margin: 16px 0;
}

/* Vertical Divider */
.vertical-divider {
    width: 1px;
    height: 24px;
    background: #d0d0d0;
    margin: 0 4px;
}

/* Search Container */
.search-container {
    position: relative;
    display: flex;
    align-items: center;
}

.search-input {
    width: 350px;
    padding: 10px 40px 10px 16px;
    border: 1px solid #d0d0d0;
    border-radius: 6px;
    font-size: 14px;
    transition: all 0.2s;
}

.search-input:focus {
    outline: none;
    border-color: #494581;
    box-shadow: 0 0 0 3px rgba(76, 111, 255, 0.1);
}

.search-input::placeholder {
    color: #999;
}

.search-icon {
    position: absolute;
    right: 12px;
    font-size: 18px;
    color: #666;
    pointer-events: none;
}

/* Bulk Edit Button */
.btn-bulk-edit {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 10px 20px;
    border: 1px solid #d0d0d0;
    border-radius: 6px;
    background: white;
    cursor: pointer;
    font-size: 14px;
    font-weight: 500;
    color: #666;
    transition: all 0.2s;
}

.btn-bulk-edit:disabled {
    opacity: 0.5;
    cursor: not-allowed;
}

.btn-bulk-edit:not(:disabled):hover {
    border-color: #fbbf24;
    background: #fffbeb;
    color: #f59e0b;
}

/* Add New Button */
.btn-add-new {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 10px 20px;
    border: none;
    border-radius: 6px;
    background: #494581;
    color: white;
    cursor: pointer;
    font-size: 14px;
    font-weight: 500;
    transition: all 0.2s;
}

.btn-add-new:hover {
    background: #3b5bdb;
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(76, 111, 255, 0.3);
}

.btn-add-new .btn-icon {
    font-size: 16px;
}

/* Remove old Assign Action button styles if they exist */
.btn-assign-action {
    display: none; /* Hide old button */
}

/* View Selector Container - holds selector + action buttons */


.view-selector {
    position: relative;
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 8px 16px;
    border: 1px solid #d0d0d0;
    border-radius: 6px;
    cursor: pointer;
    background: white;
    transition: all 0.2s;
    min-width: 200px;
}

/* Modified indicator (asterisk) */
.view-modified-indicator {
    color: #f59e0b;
    font-weight: bold;
    font-size: 18px;
    margin-left: -4px;
}

/* Save Action Buttons */
.view-save-actions {
    display: flex;
    align-items: center;
    gap: 4px;
}

.view-action-btn {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 32px; /* Reduced from 36px */
    height: 32px; /* Reduced from 36px */
    padding: 0;
    border: 1px solid #d0d0d0;
    border-radius: 6px;
    background: white;
    cursor: pointer;
    transition: all 0.2s;
}

.view-action-btn svg {
    width: 16px; /* Reduced from 18px */
    height: 16px;
}

.view-action-btn:hover {
    transform: translateY(-1px);
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.view-action-btn.save-btn {
    border-color: #10b981;
    color: #10b981;
}

.view-action-btn.save-btn:hover {
    background: #ecfdf5;
    border-color: #059669;
    color: #059669;
}

.view-action-btn.save-as-btn {
    border-color: #3b82f6;
    color: #3b82f6;
}

.view-action-btn.save-as-btn:hover {
    background: #eff6ff;
    border-color: #2563eb;
    color: #2563eb;
}

.view-action-btn.discard-btn {
    border-color: #ef4444;
    color: #ef4444;
}

.view-action-btn.discard-btn:hover {
    background: #fef2f2;
    border-color: #dc2626;
    color: #dc2626;
}

.view-action-btn:hover {
    transform: translateY(-1px);
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.view-action-btn.save-btn {
    border-color: #10b981;
    color: #10b981;
}

.view-action-btn.save-btn:hover {
    background: #ecfdf5;
    border-color: #059669;
    color: #059669;
}

.view-action-btn.save-as-btn {
    border-color: #3b82f6;
    color: #3b82f6;
}

.view-action-btn.save-as-btn:hover {
    background: #eff6ff;
    border-color: #2563eb;
    color: #2563eb;
}

.view-action-btn.discard-btn {
    border-color: #ef4444;
    color: #ef4444;
}

.view-action-btn.discard-btn:hover {
    background: #fef2f2;
    border-color: #dc2626;
    color: #dc2626;
}
#statusDropdown.active,
#priorityDropdown.active {
    background: #4c6fff;
    color: white;
    border-color: #4c6fff;
}

#statusDropdown.active .dropdown-label,
#priorityDropdown.active .dropdown-label {
    color: white;
}

#statusDropdown.active .dropdown-arrow,
#priorityDropdown.active .dropdown-arrow {
    stroke: white;
}

/* 
   SERVICE NOTES VIEW STYLES - Full functionality from service-notes-quick-filters
    */

    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif; background: #f5f5f5; }
        .container { display: flex; height: 100vh; }
        .sidebar { width: 185px; background: #2d2d52; color: white; padding: 20px 0; flex-shrink: 0; }
        .logo { padding: 0 20px 30px; display: flex; align-items: center; gap: 10px; }
        .logo-icon { width: 40px; height: 40px; background: linear-gradient(135deg, #f97316, #fbbf24); border-radius: 8px; }
        .logo-text { font-size: 16px; font-weight: 600; }
        .nav-item { padding: 12px 20px; color: #a0a0c0; cursor: pointer; transition: all 0.2s; }
        .nav-item:hover { background: rgba(255, 255, 255, 0.1); color: white; }
        .nav-item.active { background: rgba(255, 255, 255, 0.1); color: #fbbf24; }
        .main-content { flex: 1; background: #e8e8ed; overflow: auto; position: relative; }
        .content-wrapper { background: white; margin: 20px; border-radius: 8px; padding: 24px; }
        .breadcrumb { color: #666; margin-bottom: 20px; font-size: 14px; }
        .header { margin-bottom: 20px; }
        .title { font-size: 24px; font-weight: 600; color: #1a1a1a; margin-bottom: 16px; }
        .top-controls { display: flex; align-items: center; gap: 12px; margin-bottom: 16px; flex-wrap: wrap; }
        .search-box { flex: 1; min-width: 300px; position: relative; }
        .search-box input { width: 100%; padding: 10px 40px 10px 16px; border: 1px solid #d0d0d0; border-radius: 6px; font-size: 14px; }
        .search-icon { position: absolute; right: 12px; top: 50%; transform: translateY(-50%); color: #666; }
        .btn { padding: 10px 20px; border-radius: 6px; border: 1px solid #d0d0d0; background: white; cursor: pointer; font-size: 14px; display: flex; align-items: center; gap: 8px; transition: all 0.2s; }
        .btn:hover { background: #f5f5f5; }
        .btn-primary { background: #4c6fff; color: white; border-color: #4c6fff; }
        .btn-primary:hover { background: #3d5ce8; }
        .btn-link { padding: 10px 20px; border: none; background: transparent; cursor: pointer; font-size: 14px; color: #4c6fff; text-decoration: underline; transition: all 0.2s; }
        .btn-link:hover { color: #3d5ce8; background: transparent; }
        .quick-filters-row { display: flex; align-items: center; gap: 16px; padding: 12px 0; border-top: 1px solid #e0e0e0; border-bottom: 1px solid #e0e0e0; margin-bottom: 16px; overflow: visible !important; justify-content: space-between; flex-wrap: wrap; }
        .quick-filters-left { display: flex; align-items: center; gap: 16px; flex: 1; flex-wrap: wrap; }
        .quick-filters-right { display: flex; align-items: center; margin-left: auto; }
        .filter-group { display: flex; align-items: center; gap: 6px; flex-shrink: 0; }
        .filter-group-label { font-size: 13px; color: #666; font-weight: 500; white-space: nowrap; }
        .filter-dropdown { position: relative; z-index: 500; }
        .filter-dropdown-button { padding: 6px 12px; border-radius: 20px; border: 1px solid #d0d0d0; background: white; cursor: pointer; font-size: 12px; color: #333; display: flex; align-items: center; gap: 6px; transition: all 0.2s; white-space: nowrap; min-width: 120px; }
        .filter-dropdown-button:hover { border-color: #4c6fff; }
        .filter-dropdown-button.active { background: #4c6fff; color: white; border-color: #4c6fff; }
        .filter-dropdown-icon { margin-left: auto; font-size: 10px; }
        .filter-dropdown-menu { position: absolute; top: calc(100% + 4px); left: 0; background: white; border: 1px solid #d0d0d0; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); padding: 8px; z-index: 501; min-width: 250px; max-height: 400px; overflow-y: auto; display: none; }
        .filter-dropdown-menu.open { display: block; }
        .filter-dropdown-item { display: flex; align-items: center; gap: 8px; padding: 8px 12px; cursor: pointer; border-radius: 4px; font-size: 13px; transition: background 0.2s; }
        .filter-dropdown-item:hover { background: #f5f5f5; }
        .filter-dropdown-item input[type="checkbox"] { width: 16px; height: 16px; cursor: pointer; }
        .filter-dropdown-item-label { flex: 1; }
        .filter-dropdown-item-count { font-size: 11px; color: #666; }
        .date-range-group { display: flex; align-items: center; gap: 6px; }
        .date-range-inputs { display: flex; align-items: center; gap: 6px; }
        .date-input { padding: 6px 12px; border: 1px solid #d0d0d0; border-radius: 6px; font-size: 12px; cursor: pointer; }
        .date-input.active { border-color: #4c6fff; background: #f0f4ff; }
        .date-separator { font-size: 12px; color: #666; }
        .active-filters-row { display: flex; align-items: center; gap: 12px; margin-bottom: 16px; min-height: 36px; }
        .active-filters { display: flex; align-items: center; gap: 12px; margin-bottom: 16px; padding: 8px 0; justify-content: space-between; }
        .active-filters-left { display: flex; align-items: center; gap: 12px; flex: 1; flex-wrap: wrap; }
        .active-filters-right { display: flex; align-items: center; margin-left: auto; }
        .active-filters-label { display: flex; align-items: center; gap: 8px; font-size: 14px; color: #333; }
        .filter-count { background: #ff6b35; color: white; border-radius: 50%; width: 20px; height: 20px; display: inline-flex; align-items: center; justify-content: center; font-size: 12px; font-weight: 600; }
        .filter-chip { display: inline-flex; align-items: center; gap: 8px; padding: 6px 12px; background: #f0f0f0; border-radius: 20px; font-size: 13px; color: #333; }
        .filter-chip-close { cursor: pointer; color: #666; font-size: 16px; line-height: 1; }
        .filter-chip-close:hover { color: #ff4444; }
        .table-container { overflow-x: auto; border: 1px solid #e0e0e0; border-radius: 8px; }
        table { width: 100%; border-collapse: collapse; background: white; }
        thead { background: #2d2d52; color: white; }
        th { padding: 16px 12px; text-align: left; font-weight: 500; font-size: 13px; white-space: nowrap; }
        td { padding: 16px 12px; border-bottom: 1px solid #f0f0f0; font-size: 13px; color: #333; white-space: nowrap; }
        tr:hover { background: #f9f9f9; }
        .note-id { color: #4c6fff; text-decoration: none; cursor: pointer; }
        .note-id:hover { text-decoration: underline; }
        .member-name { color: #4c6fff; text-decoration: none; cursor: pointer; }
        .member-name:hover { text-decoration: underline; }
        .status-badge { padding: 4px 12px; border-radius: 12px; font-size: 12px; font-weight: 500; }
        .status-Draft { background: #fff3e0; color: #ef6c00; }
        .status-Posted { background: #e8f5e9; color: #2e7d32; }
        .no-results { padding: 60px 20px; text-align: center; color: #666; font-size: 16px; }
        .pagination { display: flex; justify-content: space-between; align-items: center; margin-top: 20px; padding-top: 20px; border-top: 1px solid #e0e0e0; }
        .page-info { color: #666; font-size: 14px; }
        .page-controls { display: flex; gap: 12px; align-items: center; }
        .page-input { width: 60px; padding: 8px; border: 1px solid #d0d0d0; border-radius: 4px; text-align: center; }
        .filter-panel { position: fixed; top: 0; right: -450px; width: 450px; height: 100vh; background: white; box-shadow: -2px 0 8px rgba(0,0,0,0.1); transition: right 0.3s ease; z-index: 1000; overflow-y: auto; }
        .filter-panel.open { right: 0; }
        .filter-panel-header { background: #5d5d8d; color: white; padding: 20px; display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 10; }
        .filter-panel-title { font-size: 18px; font-weight: 600; }
        .close-panel { cursor: pointer; font-size: 24px; background: none; border: none; color: white; width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; }
        .close-panel:hover { background: rgba(255,255,255,0.1); }
        .filter-panel-content { padding: 24px; }
        .filter-section { margin-bottom: 24px; }
        .filter-section-label { font-size: 14px; font-weight: 500; color: #333; margin-bottom: 8px; }
        .filter-select { width: 100%; padding: 10px 12px; border: 1px solid #d0d0d0; border-radius: 6px; font-size: 14px; background: white; cursor: pointer; }
        .filter-panel-actions { position: sticky; bottom: 0; background: white; padding: 16px 24px; border-top: 1px solid #e0e0e0; display: flex; gap: 12px; }
        .filter-panel-actions .btn { flex: 1; }
        .overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.3); display: none; z-index: 999; }
        .overlay.active { display: block; }
        .date-input-filter { width: 100%; padding: 10px 12px; border: 1px solid #d0d0d0; border-radius: 6px; font-size: 14px; }
/* ============================================
   TABLE OVERFLOW & RESPONSIVE FIXES
   ============================================ */

/* Fix table container to prevent overflow */
.task-table-wrapper,
.table-container,
.data-table-wrapper {
    width: 100%;
    overflow-x: auto;
    max-width: 100%;
}

/* Ensure tables respect container bounds */
.dashboard-table,
.data-table,
.task-table,
.screening-table,
.claims-table,
.health-table {
    width: 100%;
    table-layout: auto;      /*  Let columns size naturally */
    border-collapse: collapse;
    min-width: 600px;
}

/* Fix cell overflow */
.dashboard-table td,
.dashboard-table th,
.data-table td,
.data-table th {
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
    padding: 10px 12px;
    max-width: 200px;
}

/* Fix table overflow inside tab panes */
.tab-pane {
    overflow-x: auto;
    max-width: 100%;
}

.tab-pane .task-table-wrapper,
.tab-pane .data-table-wrapper {
    overflow-x: auto;
    max-width: 100%;
}

/* Allow wrapping for description columns */
.dashboard-table td.wrap-text,
.data-table td.wrap-text {
    white-space: normal;
    word-wrap: break-word;
}

/* Tab content area should not overflow */
.tab-content,
.sub-tab-content,
#memberTabContent,
.member-tab-content {
    width: 100%;
    overflow-x: hidden;
    max-width: 100%;
}

/* Fix nested containers */
.bps-container,
.screenings-container,
.insurance-container,
.cp-container,
.health-history-container,
.population-container,
.activity-container {
    width: 100%;
    max-width: 100%;
    overflow-x: hidden;
}

/* Ensure page container respects bounds */
#pageContainer,
.page-container {
    width: 100%;
    max-width: 100%;
    overflow-x: hidden;
}

/* Member header responsive */
.member-header-container {
    width: 100%;
    max-width: 100%;
    overflow-x: hidden;
}

/* Fix for assessment/screening tables */
.screening-table th,
.screening-table td {
    padding: 10px 12px;
}

.screening-table th:first-child {
    width: 60%;
}

.screening-table th:last-child {
    width: 60px;
}

/* Fix for health history tables */
.health-table {
    min-width: 500px;
}

.health-table th,
.health-table td {
    padding: 8px 10px;
    font-size: 13px;
}

/* Claims table specific */
.claims-table {
    min-width: 600px;
}

/* Responsive adjustments */
@media (max-width: 1200px) {
    .dashboard-table,
    .data-table {
        font-size: 12px;
    }
    
    .dashboard-table td,
    .dashboard-table th,
    .data-table td,
    .data-table th {
        padding: 8px 10px;
    }
}

/* Sub-tab button overflow fix */
.sub-tab-btn,
.bps-tab-btn,
.scr-tab-btn,
.cp-tab-btn {
    white-space: nowrap;
    flex-shrink: 0;
}

/* Tab container scroll */
.bps-container > div:first-child,
.cp-tabs,
.insurance-container > div:first-child {
    overflow-x: auto;
    display: flex;
    gap: 4px;
    padding-bottom: 2px;
}
    </style>
</head>
<body>
<!-- APP LOADER -->
<div id="appLoader" style="display:flex;position:fixed;inset:0;z-index:99999;background:#f8fafc;flex-direction:column;align-items:center;justify-content:center;gap:0;transition:opacity 0.4s ease;font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',sans-serif;">

    <!-- Logo -->
    <div style="display:flex;align-items:center;gap:10px;margin-bottom:36px;">
        <div style="width:40px;height:40px;background:#2d2d52;border-radius:10px;display:flex;align-items:center;justify-content:center;box-shadow:0 4px 12px rgba(45,45,82,0.25);">
            <svg viewBox="0 0 24 24" fill="white" width="20" height="20"><path d="M12 21.593c-5.63-5.539-11-10.297-11-14.402 0-3.791 3.068-5.191 5.281-5.191 1.312 0 4.151.501 5.719 4.457 1.59-3.968 4.464-4.447 5.726-4.447 2.54 0 5.274 1.621 5.274 5.181 0 4.069-5.136 8.625-11 14.402z"/></svg>
        </div>
        <div>
            <div style="font-size:22px;font-weight:800;color:#2d2d52;letter-spacing:-0.5px;">Sevida</div>
            <div style="font-size:11px;color:#94a3b8;font-weight:500;letter-spacing:0.05em;text-transform:uppercase;">Care Management Platform</div>
        </div>
    </div>

    <!-- ECG / Heartbeat line -->
    <div style="width:280px;height:56px;margin-bottom:32px;overflow:hidden;position:relative;">
        <svg viewBox="0 0 280 56" width="280" height="56" style="overflow:visible;">
            <polyline id="ecgLine" points="0,28 30,28 45,28 55,8 65,48 75,28 90,28 120,28 135,28 145,8 155,48 165,28 180,28 210,28 225,28 235,8 245,48 255,28 280,28"
                fill="none" stroke="#2d2d52" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"
                style="stroke-dasharray:600;stroke-dashoffset:600;animation:ecgDraw 2s ease-in-out infinite;"/>
            <!-- Travelling glow dot -->
            <circle r="4" fill="#ef4444" style="animation:ecgDot 2s ease-in-out infinite;opacity:0;">
                <animateMotion dur="2s" repeatCount="indefinite"
                    path="M0,28 L30,28 L45,28 L55,8 L65,48 L75,28 L90,28 L120,28 L135,28 L145,8 L155,48 L165,28 L180,28 L210,28 L225,28 L235,8 L245,48 L255,28 L280,28"/>
                <animate attributeName="opacity" values="0;0;1;1;1;0" dur="2s" repeatCount="indefinite"/>
            </circle>
        </svg>
    </div>

    <!-- Loading steps -->
    <div id="loaderSteps" style="display:flex;flex-direction:column;gap:10px;width:260px;margin-bottom:28px;">
        <div class="lstep" data-step="0" style="display:flex;align-items:center;gap:10px;opacity:0.3;transition:opacity 0.4s;">
            <div style="width:28px;height:28px;border-radius:50%;background:#e0e7ff;display:flex;align-items:center;justify-content:center;flex-shrink:0;">
                <svg viewBox="0 0 24 24" fill="none" stroke="#6366f1" stroke-width="2" width="14" height="14"><path d="M17 21v-2a4 4 0 00-4-4H5a4 4 0 00-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 00-3-3.87"/><path d="M16 3.13a4 4 0 010 7.75"/></svg>
            </div>
            <div style="flex:1;">
                <div style="font-size:12px;font-weight:600;color:#1e293b;">Loading member caseload</div>
                <div style="font-size:10px;color:#94a3b8;">33 members across 4 MCOs</div>
            </div>
            <div class="step-check" style="opacity:0;color:#10b981;font-size:16px;transition:opacity 0.3s;"></div>
        </div>
        <div class="lstep" data-step="1" style="display:flex;align-items:center;gap:10px;opacity:0.3;transition:opacity 0.4s;">
            <div style="width:28px;height:28px;border-radius:50%;background:#dcfce7;display:flex;align-items:center;justify-content:center;flex-shrink:0;">
                <svg viewBox="0 0 24 24" fill="none" stroke="#10b981" stroke-width="2" width="14" height="14"><path d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"/></svg>
            </div>
            <div style="flex:1;">
                <div style="font-size:12px;font-weight:600;color:#1e293b;">Building care plans & needs</div>
                <div style="font-size:10px;color:#94a3b8;">Goals, follow-ups, and reviews</div>
            </div>
            <div class="step-check" style="opacity:0;color:#10b981;font-size:16px;transition:opacity 0.3s;"></div>
        </div>
        <div class="lstep" data-step="2" style="display:flex;align-items:center;gap:10px;opacity:0.3;transition:opacity 0.4s;">
            <div style="width:28px;height:28px;border-radius:50%;background:#fef3c7;display:flex;align-items:center;justify-content:center;flex-shrink:0;">
                <svg viewBox="0 0 24 24" fill="none" stroke="#f59e0b" stroke-width="2" width="14" height="14"><path d="M22 12h-4l-3 9L9 3l-3 9H2"/></svg>
            </div>
            <div style="flex:1;">
                <div style="font-size:12px;font-weight:600;color:#1e293b;">Analyzing risk & ADT events</div>
                <div style="font-size:10px;color:#94a3b8;">Priority scores and alerts</div>
            </div>
            <div class="step-check" style="opacity:0;color:#10b981;font-size:16px;transition:opacity 0.3s;"></div>
        </div>
        <div class="lstep" data-step="3" style="display:flex;align-items:center;gap:10px;opacity:0.3;transition:opacity 0.4s;">
            <div style="width:28px;height:28px;border-radius:50%;background:#f0f1fb;display:flex;align-items:center;justify-content:center;flex-shrink:0;">
                <svg viewBox="0 0 24 24" fill="none" stroke="#2d2d52" stroke-width="2" width="14" height="14"><polygon points="12,2 15.09,8.26 22,9.27 17,14.14 18.18,21.02 12,17.77 5.82,21.02 7,14.14 2,9.27 8.91,8.26"/></svg>
            </div>
            <div style="flex:1;">
                <div style="font-size:12px;font-weight:600;color:#1e293b;">Initialising AI Co-pilot</div>
                <div style="font-size:10px;color:#94a3b8;">Context-aware questions ready</div>
            </div>
            <div class="step-check" style="opacity:0;color:#10b981;font-size:16px;transition:opacity 0.3s;"></div>
        </div>
    </div>

    <!-- Bottom tag -->
    <div style="font-size:11px;color:#cbd5e1;letter-spacing:0.04em;">Powered by Leap Metrics</div>
</div>

<style>
@keyframes ecgDraw {
    0%   { stroke-dashoffset: 600; opacity: 1; }
    70%  { stroke-dashoffset: 0;   opacity: 1; }
    85%  { stroke-dashoffset: 0;   opacity: 0.3; }
    100% { stroke-dashoffset: 600; opacity: 0.3; }
}
</style>

<script>
(function() {
    var steps = document.querySelectorAll('.lstep');
    var delay = 320;
    steps.forEach(function(step, i) {
        setTimeout(function() {
            step.style.opacity = '1';
            setTimeout(function() {
                var check = step.querySelector('.step-check');
                if (check) check.style.opacity = '1';
            }, 500);
        }, i * delay + 200);
    });
})();
</script>
    <!-- Sidebar -->
    <div class="sidebar collapsed" id="sidebar">
        <div class="sidebar-header">
            <div class="logo-area">
                <img src="https://web.dev.leapmetrics.io/img/sevida-icon.png" alt="Leap Metrics Logo" class="logo-img">
            </div>
            <button class="toggle-sidebar-btn" id="toggleSidebarBtn">
                <svg class="icon-collapse" xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                    <path fill-rule="evenodd" d="M11.354 1.646a.5.5 0 0 1 0 .708L5.707 8l5.647 5.646a.5.5 0 0 1-.708.708l-6-6a.5.5 0 0 1 0-.708l6-6a.5.5 0 0 1 .708 0z"/>
                </svg>
                <svg class="icon-expand" xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                    <path fill-rule="evenodd" d="M4.646 1.646a.5.5 0 0 1 .708 0l6 6a.5.5 0 0 1 0 .708l-6 6a.5.5 0 0 1-.708-.708L10.293 8 4.646 2.354a.5.5 0 0 1 0-.708z"/>
                </svg>
            </button>
        </div>
        <!-- <div class="user-profile">
            <div class="user-avatar">JS</div>
            <div class="user-details">
                <div class="user-name">John Smith</div>
                <div class="user-role">Operation Manager</div>
            </div>
            <div class="profile-arrow"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M1.646 4.646a.5.5 0 0 1 .708 0L8 10.293l5.646-5.647a.5.5 0 0 1 .708.708l-6 6a.5.5 0 0 1-.708 0l-6-6a.5.5 0 0 1 0-.708z"/></svg></div>
        </div> -->
        <nav class="sidebar-nav">
            <a href="#" class="nav-item" title="Recent Activity" id="navRecentActivity">
                <svg class="nav-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M12 6v6h4.5m4.5 0a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z" />
                </svg>
                <span class="nav-text">Recent Activity</span>
            </a>
            <a href="#" class="nav-item" title="Dashboard" id="navDashboard"><svg class="nav-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="m2.25 12 8.954-8.955c.44-.439 1.152-.439 1.591 0L21.75 12M4.5 9.75v10.125c0 .621.504 1.125 1.125 1.125H9.75v-4.875c0-.621.504-1.125 1.125-1.125h2.25c.621 0 1.125.504 1.125 1.125V21h4.125c.621 0 1.125-.504 1.125-1.125V9.75M8.25 21h7.5" /></svg><span class="nav-text">Dashboard</span></a>
            <a href="#" class="nav-item active" title="Members" id="navMembers">
                <svg class="nav-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M18 18.72a9.094 9.094 0 0 0 3.741-.479 3 3 0 0 0-4.682-2.72m-7.5-2.962A3.75 3.75 0 0 1 15 12a3.75 3.75 0 0 1-2.25 3.512m-3.75 2.25A3.75 3.75 0 0 1 9 15a3.75 3.75 0 0 1-2.25 3.512m0-11.25a2.25 2.25 0 0 1 2.25-2.25A2.25 2.25 0 0 1 13.5 6a2.25 2.25 0 0 1-2.25 2.25m0-11.25a2.25 2.25 0 0 0-2.25-2.25A2.25 2.25 0 0 0 6.75 6a2.25 2.25 0 0 0 2.25 2.25m0 0A2.25 2.25 0 0 1 13.5 6m-4.5 0A2.25 2.25 0 0 1 6.75 6m0 0a2.25 2.25 0 0 1 2.25 2.25m0 0a2.25 2.25 0 0 0 2.25 2.25m-4.5 0a2.25 2.25 0 0 0 2.25 2.25"></path></svg>
                <span class="nav-text">Members</span>
            </a>
            <a href="#" class="nav-item" title="Service Notes" id="navServiceNotes">
                    <svg class="nav-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M19.5 14.25v-2.625a3.375 3.375 0 0 0-3.375-3.375h-1.5A1.125 1.125 0 0 1 13.5 7.125v-1.5a3.375 3.375 0 0 0-3.375-3.375H8.25m0 12.75h7.5m-7.5 3H12M10.5 2.25H5.625c-.621 0-1.125.504-1.125 1.125v17.25c0 .621.504 1.125 1.125 1.125h12.75c.621 0 1.125-.504 1.125-1.125V11.25a9 9 0 0 0-9-9Z"></path></svg>
                <span class="nav-text">Service Notes</span>
            </a>
            <a href="#" class="nav-item" title="Task" id="navTask"><svg class="nav-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M8.25 6.75h7.5M8.25 12h7.5m-7.5 5.25h7.5M3.75 6.75h.007v.008H3.75V6.75Zm.375 0a.375.375 0 1 1-.75 0 .375.375 0 0 1 .75 0ZM3.75 12h.007v.008H3.75V12Zm.375 0a.375.375 0 1 1-.75 0 .375.375 0 0 1 .75 0Zm-.375 5.25h.007v.008H3.75v-.008Zm.375 0a.375.375 0 1 1-.75 0 .375.375 0 0 1 .75 0Z" /></svg><span class="nav-text">Task</span></a>
            <a href="#" class="nav-item" title="Exceptions" id="navExceptions"><svg class="nav-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m-9.303 3.376c-.866 1.5.217 3.374 1.948 3.374h14.71c1.73 0 2.813-1.874 1.948-3.374L13.949 3.378c-.866-1.5-3.032-1.5-3.898 0L2.697 16.126ZM12 15.75h.007v.008H12v-.008Z" /></svg><span class="nav-text">Exceptions</span></a>
            <a href="#" class="nav-item" title="Enrollment" id="navEnrollment"><svg class="nav-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="m16.862 4.487 1.687-1.688a1.875 1.875 0 1 1 2.652 2.652L10.582 16.07a4.5 4.5 0 0 1-1.897 1.13L6 18l.8-2.685a4.5 4.5 0 0 1 1.13-1.897l8.932-8.931Zm0 0L19.5 7.125M18 14v4.75A2.25 2.25 0 0 1 15.75 21H5.25A2.25 2.25 0 0 1 3 18.75V8.25A2.25 2.25 0 0 1 5.25 6H10" /></svg><span class="nav-text">Enrollment</span></a>
            <a href="#" class="nav-item" title="Change In Circumstance" id="navCircumstance"><svg class="nav-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M13.19 8.688a4.5 4.5 0 0 1 1.242 7.244l-4.5 4.5a4.5 4.5 0 0 1-6.364-6.364l1.757-1.757m13.35-.622 1.757-1.757a4.5 4.5 0 0 0-6.364-6.364l-4.5 4.5a4.5 4.5 0 0 0 1.242 7.244" /></svg><span class="nav-text">Change In Circumstance</span></a>
            <a href="#" class="nav-item" title="ADTs" id="navADTs"><svg class="nav-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M8.25 9V5.25A2.25 2.25 0 0 1 10.5 3h6A2.25 2.25 0 0 1 18.75 5.25v13.5A2.25 2.25 0 0 1 16.5 21h-6a2.25 2.25 0 0 1-2.25-2.25V15m-3 0-3-3m0 0 3-3m-3 3H15" /></svg><span class="nav-text">ADTs</span></a>
            <a href="#" class="nav-item" title="Attestation" id="navAttestation"><svg class="nav-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 6a3.75 3.75 0 1 1-7.5 0 3.75 3.75 0 0 1 7.5 0ZM4.501 20.118a7.5 7.5 0 0 1 14.998 0A17.933 17.933 0 0 1 12 21.75c-2.676 0-5.216-.584-7.499-1.632Z" /></svg><span class="nav-text">Attestation</span></a>
            <a href="#" class="nav-item" title="Alerts" id="navAlerts"><svg class="nav-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M14.857 17.082a23.848 23.848 0 0 0 5.454-1.31A8.967 8.967 0 0 1 18 9.75V9A6 6 0 0 0 6 9v.75a8.967 8.967 0 0 1-2.312 6.022c1.733.64 3.56 1.085 5.455 1.31m5.714 0a24.255 24.255 0 0 1-5.714 0m5.714 0a3 3 0 1 1-5.714 0" /></svg><span class="nav-text">Alerts</span></a>
            <div class="accordion-toggle" title="Provider Network" onclick="openGenericDrawer('Provider Network')">
                <a href="#" class="nav-link">
                    <svg class="nav-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M8.25 18.75a1.5 1.5 0 0 1-3 0m3 0a1.5 1.5 0 0 0-3 0m3 0h6m-9 0H3.375a1.125 1.125 0 0 1-1.125-1.125V14.25m17.25 4.5a1.5 1.5 0 0 1-3 0m3 0a1.5 1.5 0 0 0-3 0m3 0h1.125c.621 0 1.125-.504 1.125-1.125V14.25m-17.25 4.5v-1.875a3.375 3.375 0 0 1 3.375-3.375h9.75a3.375 3.375 0 0 1 3.375 3.375v1.875m-17.25 4.5a3.375 3.375 0 0 0 3.375-3.375V9.75A3.375 3.375 0 0 1 6.75 6.375h9.75a3.375 3.375 0 0 1 3.375 3.375v1.125m-17.25 4.5a1.5 1.5 0 0 1-3 0m3 0a1.5 1.5 0 0 0-3 0" /></svg>
                    <span class="nav-text">Provider Network</span>
                    <span class="nav-arrow"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4.646 1.646a.5.5 0 0 1 .708 0l6 6a.5.5 0 0 1 0 .708l-6 6a.5.5 0 0 1-.708-.708L10.293 8 4.646 2.354a.5.5 0 0 1 0-.708z"/></svg></span>
                </a>
            </div>
            <a href="#" class="nav-item" title="Message" id="navMessage"><svg class="nav-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M2.25 12.76c0 1.6 1.123 2.994 2.707 3.227 1.087.16 2.185.283 3.293.369V21l4.076-4.076a1.526 1.526 0 0 1 1.037-.443 48.282 48.282 0 0 0 5.68-.494c1.584-.233 2.707-1.626 2.707-3.228V6.741c0-1.602-1.123-2.995-2.707-3.228A48.394 48.394 0 0 0 12 3c-2.392 0-4.744.175-7.043.513C3.373 3.746 2.25 5.14 2.25 6.741v6.018Z" /></svg><span class="nav-text">Message</span></a>
            <a href="#" class="nav-item" title="Referrals" id="navReferrals"><svg class="nav-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M9 8.25H7.5a2.25 2.25 0 0 0-2.25 2.25v9a2.25 2.25 0 0 0 2.25 2.25h9a2.25 2.25 0 0 0 2.25-2.25v-9a2.25 2.25 0 0 0-2.25-2.25H15M9 12l3 3m0 0 3-3m-3 3V2.25" /></svg><span class="nav-text">Referrals</span></a>
            <a href="#" class="nav-item" title="Analytics" id="navAnalytics"><svg class="nav-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M3 13.125C3 12.504 3.504 12 4.125 12h2.25c.621 0 1.125.504 1.125 1.125v6.75C7.5 20.496 6.996 21 6.375 21h-2.25A1.125 1.125 0 0 1 3 19.875v-6.75ZM9.75 8.625c0-.621.504-1.125 1.125-1.125h2.25c.621 0 1.125.504 1.125 1.125v11.25c0 .621-.504 1.125-1.125 1.125h-2.25a1.125 1.125 0 0 1-1.125-1.125V8.625ZM16.5 4.125c0-.621.504-1.125 1.125-1.125h2.25C20.496 3 21 3.504 21 4.125v15.75c0 .621-.504 1.125-1.125 1.125h-2.25a1.125 1.125 0 0 1-1.125-1.125V4.125Z" /></svg><span class="nav-text">Analytics</span></a>
            <a href="#" class="nav-item" title="Schedule" id="navSchedule"><svg class="nav-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M6.75 3v2.25M17.25 3v2.25M3 18.75V7.5a2.25 2.25 0 0 1 2.25-2.25h13.5A2.25 2.25 0 0 1 21 7.5v11.25m-18 0A2.25 2.25 0 0 0 5.25 21h13.5A2.25 2.25 0 0 0 21 18.75m-18 0h18M12 14.25h.008v.008H12v-.008Z" /></svg><span class="nav-text">Schedule</span></a>
            <a href="#" class="nav-item" title="Reports" id="navReports">
                <svg class="nav-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                </svg>
                <span class="nav-text">Reports</span>
            </a>
            <a href="#" class="nav-item" title="Populations" id="navPopulations"><svg class="nav-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M15 19.128a9.38 9.38 0 0 0 2.625.372 9.337 9.337 0 0 0 4.121-.952 4.125 4.125 0 0 0-7.533-2.493M15 19.128v-.003c0-1.113-.285-2.16-.786-3.07M15 19.128v.106A12.318 12.318 0 0 1 8.624 21c-2.331 0-4.512-.645-6.374-1.766l-.001-.109a6.375 6.375 0 0 1 11.964-4.663M12 10.5h.008v.008H12v-.008Z" /></svg><span class="nav-text">Populations</span></a>
        </nav>
        <div class="sidebar-footer">
                <div class="accordion-toggle" title="Configurations">
                    <a href="#" class="nav-link">
                        <svg class="nav-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M9.594 3.94c.09-.542.56-.94 1.11-.94h2.593c.55 0 1.02.398 1.11.94l.213 1.281c.063.374.313.686.645.87.074.04.147.083.22.127.324.196.72.257 1.075.124l1.217-.456a1.125 1.125 0 0 1 1.37.49l1.296 2.247a1.125 1.125 0 0 1-.26 1.431l-1.003.827c-.293.24-.438.613-.438.995s.145.755.438.995l1.003.827c.424.35.534.954.26 1.431l-1.296 2.247a1.125 1.125 0 0 1-1.37.49l-1.217-.456c-.355-.133-.75-.072-1.076.124a6.57 6.57 0 0 1-.22.128c-.331.183-.581.495-.644.869l-.213 1.28c-.09.543-.56.941-1.11.941h-2.594c-.55 0-1.02-.398-1.11-.94l-.213-1.281c-.063-.374-.313-.686-.645-.87a6.52 6.52 0 0 1-.22-.127c-.324-.196-.72-.257-1.075-.124l-1.217.456a1.125 1.125 0 0 1-1.37-.49l-1.296-2.247a1.125 1.125 0 0 1 .26-1.431l1.004-.827c.292-.24.437-.613.437-.995s-.145-.755-.437-.995l-1.004-.827a1.125 1.125 0 0 1-.26-1.431l1.296-2.247a1.125 1.125 0 0 1 1.37-.49l1.217.456c.355.133.75.072 1.076-.124.072-.044.146-.087.22-.128.332-.183.582-.495.644-.869l.214-1.281Z" />
                            <path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 1 1-6 0 3 3 0 0 1 6 0Z" />
                        </svg>
                        <span class="nav-text">Configurations</span>
                        <span class="nav-arrow">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                                <path fill-rule="evenodd" d="M4.646 1.646a.5.5 0 0 1 .708 0l6 6a.5.5 0 0 1 0 .708l-6 6a.5.5 0 0 1-.708-.708L10.293 8 4.646 2.354a.5.5 0 0 1 0-.708z"/>
                            </svg>
                        </span>
                    </a>
                </div>
             <div class="accordion-toggle" title="Settings" onclick="openGenericDrawer('Settings')">
                <a href="#" class="nav-link">
                    <svg class="nav-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M10.5 6h9.75M10.5 6a1.5 1.5 0 1 1-3 0m3 0a1.5 1.5 0 1 0-3 0M3.75 6H7.5m3 12h9.75m-9.75 0a1.5 1.5 0 0 1-3 0m3 0a1.5 1.5 0 0 0-3 0m-3.75 0H7.5m9-6h3.75m-3.75 0a1.5 1.5 0 0 1-3 0m3 0a1.5 1.5 0 0 0-3 0m-9.75 0h9.75" />
                    </svg>
                    <span class="nav-text">Settings</span>
                    <span class="nav-arrow">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                            <path fill-rule="evenodd" d="M4.646 1.646a.5.5 0 0 1 .708 0l6 6a.5.5 0 0 1 0 .708l-6 6a.5.5 0 0 1-.708-.708L10.293 8 4.646 2.354a.5.5 0 0 1 0-.708z"/>
                        </svg>
                    </span>
                </a>
            </div>
            <div class="accordion-toggle" title="Set-up" onclick="openGenericDrawer('Set-up')">
                <a href="#" class="nav-link">
                    <svg class="nav-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M9.594 3.94c.09-.542.56-.94 1.11-.94h2.593c.55 0 1.02.398 1.11.94l.213 1.281c.063.374.313.686.645.87.074.04.147.083.22.127.324.196.72.257 1.075.124l1.217-.456a1.125 1.125 0 0 1 1.37.49l1.296 2.247a1.125 1.125 0 0 1-.26 1.431l-1.003.827c-.293.24-.438.613-.438.995s.145.755.438.995l1.003.827c.424.35.534.954.26 1.431l-1.296 2.247a1.125 1.125 0 0 1-1.37.49l-1.217-.456c-.355-.133-.75-.072-1.076.124a6.57 6.57 0 0 1-.22.128c-.331.183-.581.495-.644.869l-.213 1.28c-.09.543-.56.941-1.11.941h-2.594c-.55 0-1.02-.398-1.11-.94l-.213-1.281c-.063-.374-.313-.686-.645-.87a6.52 6.52 0 0 1-.22-.127c-.324-.196-.72-.257-1.075-.124l-1.217.456a1.125 1.125 0 0 1-1.37-.49l-1.296-2.247a1.125 1.125 0 0 1 .26-1.431l1.004-.827c.292-.24.437-.613.437-.995s-.145-.755-.437-.995l-1.004-.827a1.125 1.125 0 0 1-.26-1.431l1.296-2.247a1.125 1.125 0 0 1 1.37-.49l1.217.456c.355.133.75.072 1.076-.124.072-.044.146-.087.22-.128.332-.183.582-.495.644-.869l.214-1.281Z" />
                    </svg>
                    <span class="nav-text">Set-up</span>
                    <span class="nav-arrow">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                            <path fill-rule="evenodd" d="M4.646 1.646a.5.5 0 0 1 .708 0l6 6a.5.5 0 0 1 0 .708l-6 6a.5.5 0 0 1-.708-.708L10.293 8 4.646 2.354a.5.5 0 0 1 0-.708z"/>
                        </svg>
                    </span>
                </a>
            </div>
        </div>
    </div>
    <div class="flyout-menu" id="flyoutMenu"></div>
    <div class="config-drawer-overlay" id="configDrawerOverlay" onclick="closeConfigDrawer()"></div>
    <div class="config-drawer" id="configDrawer">
    <div class="config-drawer-header">
        <div class="config-drawer-title">Configuration Settings</div>
        <button class="config-drawer-close" onclick="closeConfigDrawer()">x</button>
    </div>
   
    <div class="config-drawer-content">
        <div class="config-search-wrapper">
            <svg class="search-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" d="m21 21-5.197-5.197m0 0A7.5 7.5 0 1 0 5.196 5.196a7.5 7.5 0 0 0 10.607 10.607Z" />
            </svg>
            <input type="text" class="config-search-input" placeholder="Search configurations..." id="configDrawerSearch">
        </div>
       
        <div class="config-categories" id="configCategories">
            <!-- Categories will be populated by JavaScript -->
        </div>
    </div>
</div>

    <!-- Main Content -->
    <div class="main-content">
        <!-- App Header - Clean -->
        <div class="app-header">
            <div class="app-search">
                <svg width="20" height="20" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clip-rule="evenodd"></path>
                </svg>
                <input type="text" 
                    class="header-search-input" 
                    id="globalSearchInput"
                    placeholder="Search by name or ID..." 
                    autocomplete="off">
                <div class="search-dropdown" id="searchDropdown">
                    <!-- Helper text -->
                    <div class="search-helper-text">
                        Search by member name, or filter by ID type below:
                    </div>
                    <!-- Search filters -->
                    <div class="search-filters" id="searchFilters">
                        <div class="filter-chip active" data-filter="all">All</div>
                        <div class="filter-chip" data-filter="name">Name</div>
                        <div class="filter-chip" data-filter="medicaid">Medicaid ID</div>
                        <div class="filter-chip" data-filter="medicare">Medicare ID</div>
                        <div class="filter-chip" data-filter="mrn">MRN</div>
                        <div class="filter-chip" data-filter="commercial">Commercial Insurance ID</div>
                    </div>
                    
                    <!-- Results container -->
                    <div id="searchResultsContainer"></div>
                </div>
               
                <div class="search-results-container" id="searchResults">
                    </div>
            </div>
                <button class="btn btn-secondary" onclick="MemberHeaderController.openTestScenarioModal()" style="font-size: 12px; padding: 6px 12px; margin-left: 16px;">Test Header Scenarios</button>
           
            <div class="app-actions">
                <button class="header-action-btn" id="headerQuickLinksBtn" onclick="toggleContextualSidebar()" title="Quick Links" style="display: none;">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-tabler icons-tabler-outline icon-tabler-link"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M9 15l6 -6" /><path d="M11 6l.463 -.536a5 5 0 0 1 7.071 7.072l-.534 .464" /><path d="M13 18l-.397 .534a5.068 5.068 0 0 1 -7.127 0a4.972 4.972 0 0 1 0 -7.071l.524 -.463" /></svg>
                </button>
                <div class="header-separator" id="quickLinksSeparator" style="display: none;"></div>
                <button class="header-action-btn" onclick="openHistoryPanel()" title="Recent History">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-tabler icons-tabler-outline icon-tabler-history"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M12 8l0 4l2 2" /><path d="M3.05 11a9 9 0 1 1 .5 4m-.5 5v-5h5" /></svg>
                </button>
                <div class="header-separator"></div>
                <button class="header-action-btn" onclick="openGeneralNotes()" title="General Notes">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-tabler icons-tabler-outline icon-tabler-note"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M13 20l7 -7" /><path d="M13 20v-6a1 1 0 0 1 1 -1h6v-7a2 2 0 0 0 -2 -2h-12a2 2 0 0 0 -2 2v12a2 2 0 0 0 2 2h7" /></svg>
                </button>
                <div class="header-separator"></div>
                <button class="header-action-btn" onclick="openHelp()" title="Help & Support">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-tabler icons-tabler-outline icon-tabler-help"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M12 12m-9 0a9 9 0 1 0 18 0a9 9 0 1 0 -18 0" /><path d="M12 17l0 .01" /><path d="M12 13.5a1.5 1.5 0 0 1 1 -1.5a2.6 2.6 0 1 0 -3 -4" /></svg>
                </button>
                <div class="header-separator"></div>
                <!-- <button class="notification-btn" onclick="toggleNotifications()">
                    <svg width="20" height="20" fill="currentColor" viewBox="0 0 20 20">
                        <path d="M10 2a6 6 0 00-6 6v3.586l-.707.707A1 1 0 004 14h12a1 1 0 00.707-1.707L16 11.586V8a6 6 0 00-6-6zM10 18a3 3 0 01-3-3h6a3 3 0 01-3 3z"></path>
                    </svg>
                    <span class="notification-count" id="notificationCount">3</span>
                </button> -->

                
                
                <!-- <div class="lob-selector">
                    <label for="lobSwitch">Line of Business:</label>
                    <select id="lobSwitch" onchange="switchLineOfBusiness(this)">
                        <option value="TCM" selected>TCM</option>
                        <option value="AMH">Playground AMH</option>
                    </select>
                </div> -->

                <div class="user-profile-menu">
                    <button class="user-profile-trigger" id="userProfileBtn">
                        <div class="user-info">
                            <span class="user-name-text">John Smith</span>
                            <span class="user-role-text">Care Manager</span>
                        </div>
                        
                        <svg class="dropdown-arrow" xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                            <path fill-rule="evenodd" d="M1.646 4.646a.5.5 0 0 1 .708 0L8 10.293l5.646-5.647a.5.5 0 0 1 .708.708l-6 6a.5.5 0 0 1-.708 0l-6-6a.5.5 0 0 1 0-.708z"/>
                        </svg>
                    </button>
                    
                    <div class="dropdown-menu" id="userDropdown">
                        <a href="#" class="dropdown-item">
                            <svg class="dropdown-icon" xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                                <path fill-rule="evenodd" d="M10 12.5a.5.5 0 0 1-.5.5h-8a.5.5 0 0 1-.5-.5v-9a.5.5 0 0 1 .5-.5h8a.5.5 0 0 1 .5.5v2a.5.5 0 0 0 1 0v-2A1.5 1.5 0 0 0 9.5 2h-8A1.5 1.5 0 0 0 0 3.5v9A1.5 1.5 0 0 0 1.5 14h8a1.5 1.5 0 0 0 1.5-1.5v-2a.5.5 0 0 0-1 0v2z"/>
                                <path fill-rule="evenodd" d="M15.854 8.354a.5.5 0 0 0 0-.708l-3-3a.5.5 0 0 0-.708.708L14.293 7.5H5.5a.5.5 0 0 0 0 1h8.793l-2.147 2.146a.5.5 0 0 0 .708.708l3-3z"/>
                            </svg>
                            <span>Logout</span>
                        </a>
                    </div>
                </div>
            </div>
        </div>

        <!-- Breadcrumb - Below Header -->
        <div class="breadcrumb-container">
            <div class="breadcrumb">
                Home > <a href="#" id="breadcrumbMembersLink" style="color: #353182; text-decoration: none;">Members</a> > Member Dashboard > Member Details
            </div>
        </div>
        <div id="pageContainer">
        <button id="vidaCopilotFab" class="floating-action-btn" title="Vida Co-pilot">
            <img src="https://web.dev.leapmetrics.io/img/sevida-icon.png" alt="Vida Co-pilot Icon" />
        </button>
    
        <!-- === COMPLETE MEMBER HEADER === -->
        <div class="member-header-container" id="memberHeader">

        <!-- Scalable Alert Banner Slider -->
        <!-- Scalable Alert Banner with Options -->
            <div class="alert-banner-container" id="alertContainer">            
                <div class="alert-strip" id="alertStrip">
                    <span style="font-weight: 600; color: #666; font-size: 11px;">Alerts:</span>
                    <div class="alert-chip unread" onclick="expandAlertChip(0)" data-alert-id="0">
                        <svg class="alert-chip-icon" fill="currentColor" viewBox="0 0 24 24">
                            <path d="M12 22c1.1 0 2-.9 2-2h-4c0 1.1.9 2 2 2zm6-6v-5c0-3.07-1.64-5.64-4.5-6.32V4c0-.83-.67-1.5-1.5-1.5s-1.5.67-1.5 1.5v.68C7.63 5.36 6 7.92 6 11v5l-2 2v1h16v-1l-2-2z"/>
                        </svg>
                        <span>Consent Required</span>
                    </div>
                    <div class="alert-chip unread" onclick="expandAlertChip(1)" data-alert-id="1">
                        <svg class="alert-chip-icon" fill="currentColor" viewBox="0 0 24 24">
                            <path d="M12 22c1.1 0 2-.9 2-2h-4c0 1.1.9 2 2 2zm6-6v-5c0-3.07-1.64-5.64-4.5-6.32V4c0-.83-.67-1.5-1.5-1.5s-1.5.67-1.5 1.5v.68C7.63 5.36 6 7.92 6 11v5l-2 2v1h16v-1l-2-2z"/>
                        </svg>
                        <span>New ADT Event</span>
                    </div>
                    <div class="alert-chip unread" onclick="expandAlertChip(2)" data-alert-id="2">
                        <svg class="alert-chip-icon" fill="currentColor" viewBox="0 0 24 24">
                            <path d="M12 22c1.1 0 2-.9 2-2h-4c0 1.1.9 2 2 2zm6-6v-5c0-3.07-1.64-5.64-4.5-6.32V4c0-.83-.67-1.5-1.5-1.5s-1.5.67-1.5 1.5v.68C7.63 5.36 6 7.92 6 11v5l-2 2v1h16v-1l-2-2z"/>
                        </svg>
                        <span>Priority Population</span>
                    </div>
                    <div class="alert-chip unread" onclick="expandAlertChip(3)" data-alert-id="3">
                        <svg class="alert-chip-icon" fill="currentColor" viewBox="0 0 24 24">
                            <path d="M12 22c1.1 0 2-.9 2-2h-4c0 1.1.9 2 2 2zm6-6v-5c0-3.07-1.64-5.64-4.5-6.32V4c0-.83-.67-1.5-1.5-1.5s-1.5.67-1.5 1.5v.68C7.63 5.36 6 7.92 6 11v5l-2 2v1h16v-1l-2-2z"/>
                        </svg>
                        <span>Care Plan Due</span>
                    </div>

                    <div class="alert-chip unread" onclick="expandAlertChip(4)" data-alert-id="4">
                        <svg class="alert-chip-icon" fill="currentColor" viewBox="0 0 24 24">
                            <path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-5 14H7v-2h7v2zm3-4H7v-2h10v2zm0-4H7V7h10v2z"/>
                        </svg>
                        <span>Service Notes</span>
                    </div>

                   
                     <!-- <div class="notes-section-wrapper">
                        <div class="separator"></div>
                        <span class="notes-text-label">Notes</span>
                        <button class="notes-icon-btn" onclick="event.stopPropagation(); event.preventDefault(); openMemberNotes();" title="Member Notes">
                            <svg class="notes-icon" fill="currentColor" viewBox="0 0 24 24">
                                <path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-5 14H7v-2h7v2zm3-4H7v-2h10v2zm0-4H7V7h10v2z"></path>
                            </svg>
                        </button>
                    </div> -->
                </div>

                <!-- Expanded Content Area for Option 2 with close buttons -->
                <div class="alert-expanded-content" id="expandedAlert0">
                    <div class="expanded-content-wrapper">
                        <div class="expanded-text">
                            <strong>Consent Required:</strong> Member consent needs to be obtained before proceeding with care plan
                        </div>
                        <div class="expanded-actions">
                            <button class="alert-close-btn" onclick="closeExpandedAlert()">&times;</button>
                            <a href="#" class="alert-action-link" onclick="goToConsent()">Go to Consent</a>
                        </div>
                    </div>
                </div>
                <div class="alert-expanded-content" id="expandedAlert1">
                    <div class="expanded-content-wrapper">
                        <div class="expanded-text">
                            <strong>New ADT Event:</strong> Member admitted to Regional Hospital - update care plan accordingly
                        </div>
                        <div class="expanded-actions">
                            <button class="alert-close-btn" onclick="closeExpandedAlert()">&times;</button>
                            <a href="#" class="alert-action-link" onclick="goToADT()">View ADT Events</a>
                        </div>
                    </div>
                </div>
                <div class="alert-expanded-content" id="expandedAlert2">
                    <div class="expanded-content-wrapper">
                        <div class="expanded-text">
                            <strong>Priority Population Added:</strong> Member assigned to High Risk Diabetes population - review care protocols
                        </div>
                        <div class="expanded-actions">
                            <button class="alert-close-btn" onclick="closeExpandedAlert()">&times;</button>
                            <a href="#" class="alert-action-link" onclick="goToBioPhyscho()">View Bio/Psycho/Social</a>
                        </div>
                    </div>
                </div>
                <div class="alert-expanded-content" id="expandedAlert3">
                    <div class="expanded-content-wrapper">
                        <div class="expanded-text">
                            <strong>Care Plan Review:</strong> Annual care plan review is due within 30 days
                        </div>
                        <div class="expanded-actions">
                            <button class="alert-close-btn" onclick="closeExpandedAlert()">&times;</button>
                            <a href="#" class="alert-action-link" onclick="goToCarePlan()">Update Care Plan</a>
                        </div>
                    </div>
                </div>

                <div class="alert-expanded-content" id="expandedAlert4">
                    <div class="expanded-content-wrapper">
                        <div class="expanded-text">
                            <strong>Draft Service Note:</strong> Contact attempt logged on 08/30/2025 - Follow-up required for consent status update
                        </div>
                        <div class="expanded-actions">
                            <button class="alert-close-btn" onclick="closeExpandedAlert()">&times;</button>
                            <a href="#" class="alert-action-link" onclick="goToServiceNote('draft-7733')">View Draft Note</a>
                        </div>
                    </div>
                </div>

                <!-- Expanded Content Area for Option 2 -->
                <div class="alert-expanded-content" id="expandedAlert0">
                    <strong>Consent Required:</strong> Member consent needs to be obtained before proceeding with care plan
                    <button class="alert-action-btn" onclick="goToConsent()" style="margin-left: 16px;">Go to Consent</button>
                </div>
                <div class="alert-expanded-content" id="expandedAlert1">
                    <strong>New ADT Event:</strong> Member admitted to Regional Hospital - update care plan accordingly
                    <button class="alert-action-btn" onclick="goToADT()" style="margin-left: 16px;">View ADT Events</button>
                </div>
                <div class="alert-expanded-content" id="expandedAlert2">
                    <strong>Priority Population Added:</strong> Member assigned to High Risk Diabetes population - review care protocols
                    <button class="alert-action-btn" onclick="goToBioPhyscho()" style="margin-left: 16px;">View Bio/Psycho/Social</button>
                </div>
                <div class="alert-expanded-content" id="expandedAlert3">
                    <strong>Care Plan Review:</strong> Annual care plan review is due within 30 days
                    <button class="alert-action-btn" onclick="goToCarePlan()" style="margin-left: 16px;">Update Care Plan</button>
                </div>
            </div>

            <div class="header-content-wrapper">
                <div id="identity-section" class="header-card">
                    </div>

                <div id="accordion-section" class="header-card">
                    </div>

            </div>
        <!-- Page Content -->
        <!-- Notification Drawer -->
        <div class="notification-drawer" id="notificationDrawer">
            <div class="notification-header">
                <h3>Notifications</h3>
                <button onclick="toggleNotifications()" style="background: none; border: none; font-size: 20px; cursor: pointer;">&times;</button>
            </div>
            <div class="notification-list">
            <div class="notification-item unread" onclick="markAsRead(this)">
                <div class="notification-content">
                    <div class="notification-icon">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                            <path d="M8 16a2 2 0 0 0 2-2H6a2 2 0 0 0 2 2zM8 1.918l-.797.161A4.002 4.002 0 0 0 4 6c0 .628-.134 2.197-.459 3.742-.16.767-.376 1.566-.663 2.258h10.244c-.287-.692-.502-1.49-.663-2.258C12.134 8.197 12 6.628 12 6a4.002 4.002 0 0 0-3.203-3.92L8 1.917zM14.22 12c.223.447.481.801.78 1H1c.299-.199.557-.553.78-1C2.68 10.2 3 6.88 3 6c0-2.42 1.72-4.44 4.005-4.901a1 1 0 1 1 1.99 0A5.002 5.002 0 0 1 13 6c0 .88.32 4.2 1.22 6z"/>
                        </svg>
                    </div>
                    <div class="notification-text">
                        <div class="notification-title">Consent Required - King Loreley</div>
                        <div class="notification-desc">Member consent needs to be obtained before proceeding with care plan</div>
                        <div class="notification-footer">
                            <span class="notification-time">2 hours ago</span>
                            <button class="notification-cta" onclick="goToMemberConsent('king-loreley'); event.stopPropagation();">Go to Consent</button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="notification-item unread" onclick="markAsRead(this)">
                <div class="notification-content">
                    <div class="notification-icon">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                            <path d="M8 16a2 2 0 0 0 2-2H6a2 2 0 0 0 2 2zM8 1.918l-.797.161A4.002 4.002 0 0 0 4 6c0 .628-.134 2.197-.459 3.742-.16.767-.376 1.566-.663 2.258h10.244c-.287-.692-.502-1.49-.663-2.258C12.134 8.197 12 6.628 12 6a4.002 4.002 0 0 0-3.203-3.92L8 1.917zM14.22 12c.223.447.481.801.78 1H1c.299-.199.557-.553.78-1C2.68 10.2 3 6.88 3 6c0-2.42 1.72-4.44 4.005-4.901a1 1 0 1 1 1.99 0A5.002 5.002 0 0 1 13 6c0 .88.32 4.2 1.22 6z"/>
                        </svg>
                    </div>
                    <div class="notification-text">
                        <div class="notification-title">New ADT Event - Sarah Martinez</div>
                        <div class="notification-desc">Emergency room visit recorded at General Hospital</div>
                        <div class="notification-footer">
                            <span class="notification-time">4 hours ago</span>
                            <button class="notification-cta" onclick="goToMemberADT('sarah-martinez'); event.stopPropagation();">View ADT Events</button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="notification-item unread" onclick="markAsRead(this)">
                <div class="notification-content">
                    <div class="notification-icon">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                           <path d="M8 16a2 2 0 0 0 2-2H6a2 2 0 0 0 2 2zM8 1.918l-.797.161A4.002 4.002 0 0 0 4 6c0 .628-.134 2.197-.459 3.742-.16.767-.376 1.566-.663 2.258h10.244c-.287-.692-.502-1.49-.663-2.258C12.134 8.197 12 6.628 12 6a4.002 4.002 0 0 0-3.203-3.92L8 1.917zM14.22 12c.223.447.481.801.78 1H1c.299-.199.557-.553.78-1C2.68 10.2 3 6.88 3 6c0-2.42 1.72-4.44 4.005-4.901a1 1 0 1 1 1.99 0A5.002 5.002 0 0 1 13 6c0 .88.32 4.2 1.22 6z"/>
                        </svg>
                    </div>
                    <div class="notification-text">
                        <div class="notification-title">Priority Population - Michael Thompson</div>
                        <div class="notification-desc">Added to High Risk Diabetes population - review care protocols</div>
                        <div class="notification-footer">
                             <span class="notification-time">6 hours ago</span>
                            <button class="notification-cta" onclick="goToMemberBioPhyscho('michael-thompson'); event.stopPropagation();">View Bio/Psycho</button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="notification-item" onclick="markAsRead(this)">
                 <div class="notification-content">
                    <div class="notification-icon">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                           <path d="M8 16a2 2 0 0 0 2-2H6a2 2 0 0 0 2 2zM8 1.918l-.797.161A4.002 4.002 0 0 0 4 6c0 .628-.134 2.197-.459 3.742-.16.767-.376 1.566-.663 2.258h10.244c-.287-.692-.502-1.49-.663-2.258C12.134 8.197 12 6.628 12 6a4.002 4.002 0 0 0-3.203-3.92L8 1.917zM14.22 12c.223.447.481.801.78 1H1c.299-.199.557-.553.78-1C2.68 10.2 3 6.88 3 6c0-2.42 1.72-4.44 4.005-4.901a1 1 0 1 1 1.99 0A5.002 5.002 0 0 1 13 6c0 .88.32 4.2 1.22 6z"/>
                        </svg>
                    </div>
                    <div class="notification-text">
                        <div class="notification-title">Assessment Complete - Lisa Johnson</div>
                        <div class="notification-desc">Annual assessment completed - care plan update required</div>
                         <div class="notification-footer">
                            <span class="notification-time">1 day ago</span>
                            <button class="notification-cta" onclick="goToMemberCarePlan('lisa-johnson'); event.stopPropagation();">Update Care Plan</button>
                        </div>
                    </div>
                </div>
            </div>
           
            <div class="notification-item" onclick="markAsRead(this)">
                <div class="notification-content">
                    <div class="notification-icon">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                            <path d="M8 16a2 2 0 0 0 2-2H6a2 2 0 0 0 2 2zM8 1.918l-.797.161A4.002 4.002 0 0 0 4 6c0 .628-.134 2.197-.459 3.742-.16.767-.376 1.566-.663 2.258h10.244c-.287-.692-.502-1.49-.663-2.258C12.134 8.197 12 6.628 12 6a4.002 4.002 0 0 0-3.203-3.92L8 1.917zM14.22 12c.223.447.481.801.78 1H1c.299-.199.557-.553.78-1C2.68 10.2 3 6.88 3 6c0-2.42 1.72-4.44 4.005-4.901a1 1 0 1 1 1.99 0A5.002 5.002 0 0 1 13 6c0 .88.32 4.2 1.22 6z"/>
                        </svg>
                    </div>
                    <div class="notification-text">
                        <div class="notification-title">Referral Update - David Chen</div>
                        <div class="notification-desc">Cardiology referral approved - appointment scheduled</div>
                        <div class="notification-footer">
                            <span class="notification-time">1 day ago</span>
                            <button class="notification-cta" onclick="goToMemberReferrals('david-chen'); event.stopPropagation();">View Referrals</button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="notification-item" onclick="markAsRead(this)">
                <div class="notification-content">
                    <div class="notification-icon">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                            <path d="M8 16a2 2 0 0 0 2-2H6a2 2 0 0 0 2 2zM8 1.918l-.797.161A4.002 4.002 0 0 0 4 6c0 .628-.134 2.197-.459 3.742-.16.767-.376 1.566-.663 2.258h10.244c-.287-.692-.502-1.49-.663-2.258C12.134 8.197 12 6.628 12 6a4.002 4.002 0 0 0-3.203-3.92L8 1.917zM14.22 12c.223.447.481.801.78 1H1c.299-.199.557-.553.78-1C2.68 10.2 3 6.88 3 6c0-2.42 1.72-4.44 4.005-4.901a1 1 0 1 1 1.99 0A5.002 5.002 0 0 1 13 6c0 .88.32 4.2 1.22 6z"/>
                        </svg>
                    </div>
                    <div class="notification-text">
                        <div class="notification-title">Care Plan Due - Jennifer Williams</div>
                        <div class="notification-desc">Annual care plan review is due within 15 days</div>
                        <div class="notification-footer">
                            <span class="notification-time">2 days ago</span>
                            <button class="notification-cta" onclick="goToMemberCarePlan('jennifer-williams'); event.stopPropagation();">Review Care Plan</button>
                        </div>
                    </div>
                </div>
            </div>
           
            <div class="notification-item" onclick="markAsRead(this)">
                <div class="notification-content">
                    <div class="notification-icon">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                            <path d="M8 16a2 2 0 0 0 2-2H6a2 2 0 0 0 2 2zM8 1.918l-.797.161A4.002 4.002 0 0 0 4 6c0 .628-.134 2.197-.459 3.742-.16.767-.376 1.566-.663 2.258h10.244c-.287-.692-.502-1.49-.663-2.258C12.134 8.197 12 6.628 12 6a4.002 4.002 0 0 0-3.203-3.92L8 1.917zM14.22 12c.223.447.481.801.78 1H1c.299-.199.557-.553.78-1C2.68 10.2 3 6.88 3 6c0-2.42 1.72-4.44 4.005-4.901a1 1 0 1 1 1.99 0A5.002 5.002 0 0 1 13 6c0 .88.32 4.2 1.22 6z"/>
                        </svg>
                    </div>
                    <div class="notification-text">
                        <div class="notification-title">Consent Required - King Loreley</div>
                        <div class="notification-desc">Member consent needs to be obtained before proceeding with care plan</div>
                        <div class="notification-footer">
                            <span class="notification-time">2 hours ago</span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="notification-item unread" onclick="markAsRead(this)">
                <div class="notification-content">
                    <div class="notification-icon">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                           <path d="M8 16a2 2 0 0 0 2-2H6a2 2 0 0 0 2 2zM8 1.918l-.797.161A4.002 4.002 0 0 0 4 6c0 .628-.134 2.197-.459 3.742-.16.767-.376 1.566-.663 2.258h10.244c-.287-.692-.502-1.49-.663-2.258C12.134 8.197 12 6.628 12 6a4.002 4.002 0 0 0-3.203-3.92L8 1.917zM14.22 12c.223.447.481.801.78 1H1c.299-.199.557-.553.78-1C2.68 10.2 3 6.88 3 6c0-2.42 1.72-4.44 4.005-4.901a1 1 0 1 1 1.99 0A5.002 5.002 0 0 1 13 6c0 .88.32 4.2 1.22 6z"/>
                        </svg>
                    </div>
                    <div class="notification-text">
                        <div class="notification-title">Contact Info Update - Maria Garcia</div>
                        <div class="notification-desc">Member's phone number returned as disconnected. Please update.</div>
                        <div class="notification-footer">
                             <span class="notification-time">8 hours ago</span>
                            <button class="notification-cta" onclick="goToMemberContact('maria-garcia'); event.stopPropagation();">Update Contact</button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="notification-item" onclick="markAsRead(this)">
                <div class="notification-content">
                    <div class="notification-icon">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                           <path d="M8 16a2 2 0 0 0 2-2H6a2 2 0 0 0 2 2zM8 1.918l-.797.161A4.002 4.002 0 0 0 4 6c0 .628-.134 2.197-.459 3.742-.16.767-.376 1.566-.663 2.258h10.244c-.287-.692-.502-1.49-.663-2.258C12.134 8.197 12 6.628 12 6a4.002 4.002 0 0 0-3.203-3.92L8 1.917zM14.22 12c.223.447.481.801.78 1H1c.299-.199.557-.553.78-1C2.68 10.2 3 6.88 3 6c0-2.42 1.72-4.44 4.005-4.901a1 1 0 1 1 1.99 0A5.002 5.002 0 0 1 13 6c0 .88.32 4.2 1.22 6z"/>
                        </svg>
                    </div>
                    <div class="notification-text">
                        <div class="notification-title">Assessment Due - Robert Smith</div>
                        <div class="notification-desc">Quarterly HRA assessment is due in 7 days.</div>
                         <div class="notification-footer">
                            <span class="notification-time">3 days ago</span>
                            <button class="notification-cta" onclick="goToMemberAssessment('robert-smith'); event.stopPropagation();">Start Assessment</button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="notification-item" onclick="markAsRead(this)">
                <div class="notification-content">
                    <div class="notification-icon">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                           <path d="M8 16a2 2 0 0 0 2-2H6a2 2 0 0 0 2 2zM8 1.918l-.797.161A4.002 4.002 0 0 0 4 6c0 .628-.134 2.197-.459 3.742-.16.767-.376 1.566-.663 2.258h10.244c-.287-.692-.502-1.49-.663-2.258C12.134 8.197 12 6.628 12 6a4.002 4.002 0 0 0-3.203-3.92L8 1.917zM14.22 12c.223.447.481.801.78 1H1c.299-.199.557-.553.78-1C2.68 10.2 3 6.88 3 6c0-2.42 1.72-4.44 4.005-4.901a1 1 0 1 1 1.99 0A5.002 5.002 0 0 1 13 6c0 .88.32 4.2 1.22 6z"/>
                        </svg>
                    </div>
                    <div class="notification-text">
                        <div class="notification-title">New Document - Emily Jones</div>
                        <div class="notification-desc">PCP visit summary from 08/20/2025 has been uploaded.</div>
                         <div class="notification-footer">
                            <span class="notification-time">4 days ago</span>
                            <button class="notification-cta" onclick="goToMemberDocs('emily-jones'); event.stopPropagation();">View Documents</button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="notification-item" onclick="markAsRead(this)">
                <div class="notification-content">
                    <div class="notification-icon">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                           <path d="M8 16a2 2 0 0 0 2-2H6a2 2 0 0 0 2 2zM8 1.918l-.797.161A4.002 4.002 0 0 0 4 6c0 .628-.134 2.197-.459 3.742-.16.767-.376 1.566-.663 2.258h10.244c-.287-.692-.502-1.49-.663-2.258C12.134 8.197 12 6.628 12 6a4.002 4.002 0 0 0-3.203-3.92L8 1.917zM14.22 12c.223.447.481.801.78 1H1c.299-.199.557-.553.78-1C2.68 10.2 3 6.88 3 6c0-2.42 1.72-4.44 4.005-4.901a1 1 0 1 1 1.99 0A5.002 5.002 0 0 1 13 6c0 .88.32 4.2 1.22 6z"/>
                        </svg>
                    </div>
                    <div class="notification-text">
                        <div class="notification-title">Appointment Reminder - James Brown</div>
                        <div class="notification-desc">Follow-up with cardiologist is scheduled for tomorrow.</div>
                         <div class="notification-footer">
                            <span class="notification-time">5 days ago</span>
                            <button class="notification-cta" onclick="goToMemberAppts('james-brown'); event.stopPropagation();">View Appointments</button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="notification-item" onclick="markAsRead(this)">
                <div class="notification-content">
                    <div class="notification-icon">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                           <path d="M8 16a2 2 0 0 0 2-2H6a2 2 0 0 0 2 2zM8 1.918l-.797.161A4.002 4.002 0 0 0 4 6c0 .628-.134 2.197-.459 3.742-.16.767-.376 1.566-.663 2.258h10.244c-.287-.692-.502-1.49-.663-2.258C12.134 8.197 12 6.628 12 6a4.002 4.002 0 0 0-3.203-3.92L8 1.917zM14.22 12c.223.447.481.801.78 1H1c.299-.199.557-.553.78-1C2.68 10.2 3 6.88 3 6c0-2.42 1.72-4.44 4.005-4.901a1 1 0 1 1 1.99 0A5.002 5.002 0 0 1 13 6c0 .88.32 4.2 1.22 6z"/>
                        </svg>
                    </div>
                    <div class="notification-text">
                        <div class="notification-title">Critical Lab Value - Patricia Miller</div>
                        <div class="notification-desc">High potassium level (6.2 mEq/L) reported. Immediate follow-up required.</div>
                         <div class="notification-footer">
                            <span class="notification-time">5 days ago</span>
                            <button class="notification-cta" onclick="goToMemberLabs('patricia-miller'); event.stopPropagation();">View Labs</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        </div>

        <!-- Member Notes Side Panel -->
        <div class="notes-panel" id="notesPanel">
           <div class="notes-header">
                <div class="notes-header-content">
                    <h3 class="notes-title">Quick Notes</h3>
                    <div class="notes-member">Member: King Loreley</div>
                    <div class="notes-description">These notes are specific to this member and can be accessed anytime for this member.</div>
                </div>
                <button class="notes-close-btn" onclick="closeMemberNotes()">x</button>
            </div>
            <div class="notes-content">
                <textarea id="notesTextArea" class="notes-textarea" placeholder="Add your notes for this member..."></textarea>
            </div>
            <div class="notes-footer">
                <span class="notes-save-indicator" id="saveIndicator">Notes saved automatically</span>
            </div>
        </div>
        <div class="notes-overlay" id="notesOverlay" onclick="closeMemberNotes()"></div>
        <div class="notes-overlay" id="generalNotesOverlay" onclick="closeGeneralNotes()"></div>
        </div>
                <div class="page-content">
            <div class="content-tabs">
                <div class="tab active" data-tab="dashboard">Member Dashboard</div>
                <div class="tab" data-tab="details">Member Details</div>
                <div class="tab" data-tab="timeline">Timeline View</div>
                <div class="tab" data-tab="insurance">Insurance Information</div>
                <div class="tab" data-tab="screenings">Screenings & Assessments</div>
                <div class="tab" data-tab="bio-psycho">Bio/Psycho/Social</div>
                <div class="tab" data-tab="history">Health History</div>
                <div class="tab" data-tab="population">Population Insights</div>
                <div class="tab" data-tab="activity">Activity History</div>
                <div class="tab" data-tab="careteam">Care Team</div>
                <div class="tab" data-tab="careplans">Care Plans</div>
                <div class="tab" data-tab="assignment-history">CM Assignment History</div>
            </div>
           
            <div class="tab-content">
                <div class="tab-pane active" data-pane="dashboard">
                    <div class="dashboard-grid">
                       <div class="dashboard-widget">
                        <div class="widget-header">
                            <h3 class="widget-title">ADTs(6)</h3>
                        </div>
                        <div class="widget-content scrollable">
                            <table class="dashboard-table">
                                <thead>
                                    <tr>
                                        <th>Event Date</th>
                                        <th>Event Type</th>
                                        <th>Facility</th>
                                        <th>Diagnosis</th>
                                        <th>Acknowledged</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td>12/3/2024<br>11:51 AM</td>
                                        <td><a href="#">PC3</a></td>
                                        <td>-</td>
                                        <td>-</td>
                                        <td>No</td>
                                    </tr>
                                    <tr>
                                        <td>12/3/2024<br>11:49 AM</td>
                                        <td><a href="#">PC2</a></td>
                                        <td>-</td>
                                        <td>-</td>
                                        <td>No</td>
                                    </tr>
                                    <tr>
                                        <td>12/3/2024<br>11:46 AM</td>
                                        <td><a href="#">PC1</a></td>
                                        <td>-</td>
                                        <td>-</td>
                                        <td>No</td>
                                    </tr>
                                    <tr>
                                        <td>10/28/2024<br>10:36 PM</td>
                                        <td><a href="#">A26</a></td>
                                        <td>HYRMC</td>
                                        <td>S3217XS - Hairline fracture on femur</td>
                                        <td>No</td>
                                    </tr>
                                    <tr>
                                        <td>10/25/2024<br>08:15 AM</td>
                                        <td><a href="#">D45</a></td>
                                        <td>HYRMC</td>
                                        <td>-</td>
                                        <td>Yes</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <div class="dashboard-widget">
                        <div class="widget-header">
                            <h3 class="widget-title">Actions</h3>
                        </div>
                        <div class="widget-content">
                            <div class="actions-list">
                                <a href="#">Create a new Service Note</a>
                                <a href="#">Create a new Appointment</a>
                                <a href="#">Open the Care Plan in a new tab</a>
                                <a href="#">Generate Member Profile</a>
                            </div>
                        </div>
                    </div>

                    <div class="dashboard-widget">
                        <div class="widget-header dark">
                            <h3 class="widget-title">Tasks (1)</h3>
                        </div>
                        <div class="widget-content">
                            <table class="dashboard-table">
                                <thead>
                                    <tr>
                                        <th>Name</th>
                                        <th>Member Name</th>
                                        <th>Medicaid ID</th>
                                        <th>Group</th>
                                        <th>Assignee</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td><a href="#">Test</a></td>
                                        <td>King Loreley</td>
                                        <td>LEAPAug2024DK11</td>
                                        <td>super_admin</td>
                                        <td></td>
                                    </tr>
                                </tbody>
                            </table>
                            <div class="pagination">
                                <span>Per Page: <strong>20</strong> </span>
                                <span>Page <strong>1</strong> of <strong>1</strong></span>
                                <div>
                                    <button disabled>&lt;</button>
                                    <button disabled>&gt;</button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="dashboard-widget">
                        <div class="widget-header">
                            <h3 class="widget-title">Upcoming Appointments (0)</h3>
                            <div class="widget-actions">
                                <button class="icon-btn"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M3.5 0a.5.5 0 0 1 .5.5V1h8V.5a.5.5 0 0 1 1 0V1h1a2 2 0 0 1 2 2v11a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2V3a2 2 0 0 1 2-2h1V.5a.5.5 0 0 1 .5-.5zM1 4v10a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1V4H1z"/></svg></button>
                                <button class="icon-btn"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M8 4a.5.5 0 0 1 .5.5v3h3a.5.5 0 0 1 0 1h-3v3a.5.5 0 0 1-1 0v-3h-3a.5.5 0 0 1 0-1h3v-3A.5.5 0 0 1 8 4z"/></svg></button>
                            </div>
                        </div>
                        <div class="widget-content">
                            <div class="info-message">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M8 16A8 8 0 1 0 8 0a8 8 0 0 0 0 16zm.93-9.412-1 4.705c-.07.34.029.533.304.533.194 0 .487-.07.686-.246l-.088.416c-.287.346-.92.598-1.465.598-.703 0-1.002-.422-.808-1.319l.738-3.468c.064-.293.006-.399-.287-.47l-.451-.081.082-.381 2.29-.287zM8 5.5a1 1 0 1 1 0-2 1 1 0 0 1 0 2z"/></svg>
                                There are no Upcoming Appointments for this Member that meet current criteria
                            </div>
                        </div>
                    </div>

                    <div class="dashboard-widget full-width">
                        <div class="widget-header">
                            <h3 class="widget-title">Open Service Notes (0)</h3>
                        </div>
                        <div class="widget-content">
                            <div class="info-message">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M8 16A8 8 0 1 0 8 0a8 8 0 0 0 0 16zm.93-9.412-1 4.705c-.07.34.029.533.304.533.194 0 .487-.07.686-.246l-.088.416c-.287.346-.92.598-1.465.598-.703 0-1.002-.422-.808-1.319l.738-3.468c.064-.293.006-.399-.287-.47l-.451-.081.082-.381 2.29-.287zM8 5.5a1 1 0 1 1 0-2 1 1 0 0 1 0 2z"/></svg>
                                There are no records that meet current criteria
                            </div>
                        </div>
                    </div>

                    <div class="dashboard-widget full-width vertical-tabs-widget">
                        <div class="widget-header">
                            <h3 class="widget-title">Care Gaps</h3>
                        </div>
                        <div class="widget-content">
                            <div class="vertical-tabs-container">
                                <div class="vertical-tabs-nav">
                                    <div class="vertical-tab active">NEEDS DUE (1)</div>
                                    <div class="vertical-tab">GOALS DUE (1)</div>
                                    <div class="vertical-tab">IDENTIFIED NEEDS NOT IN CARE PLAN (1)</div>
                                </div>
                                <div class="vertical-tabs-content">
                                    <div class="tab-pane-header">
                                        <h4>Needs Due (1)</h4>
                                        <div class="search-filter-area">
                                            <div class="search-box">
                                                <input type="text" placeholder="Search by Need Name">
                                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M11.742 10.344a6.5 6.5 0 1 0-1.397 1.398h-.001c.03.04.062.078.098.115l3.85 3.85a1 1 0 0 0 1.415-1.414l-3.85-3.85a1.007 1.007 0 0 0-.115-.1zM12 6.5a5.5 5.5 0 1 1-11 0 5.5 5.5 0 0 1 11 0z"/></svg>
                                            </div>
                                            <button class="filter-btn">Filter</button>
                                            <button class="clear-btn">Clear Filters</button>
                                        </div>
                                    </div>
                                    <div class="filters-area">
                                        <span>Active Filters:</span>
                                        <div class="filter-tag">Days Due: 30 <button>&times;</button></div>
                                        <div class="filter-tag">Need Status: Planned, Active <button>&times;</button></div>
                                    </div>
                                    <table class="dashboard-table">
                                        <thead>
                                            <tr>
                                                <th>Member</th>
                                                <th>Need ID</th>
                                                <th>Need Name</th>
                                                <th>Target Date</th>
                                                <th>Days Due </th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <tr>
                                                <td><a href="#">King Loreley</a></td>
                                                <td>1</td>
                                                <td><a href="#">Needs help understanding healthcare instructions from doctors</a></td>
                                                <td>3/31/2025</td>
                                                <td>-147</td>
                                            </tr>
                                        </tbody>
                                    </table>
                                    <div class="pagination">
                                        <span>Per Page: <strong>10</strong> </span>
                                        <span>Page <strong>1</strong> of <strong>1</strong></span>
                                        <div>
                                            <button disabled>&lt;</button>
                                            <button disabled>&gt;</button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="dashboard-widget full-width vertical-tabs-widget">
                        <div class="widget-header">
                            <h3 class="widget-title">Reference Center</h3>
                        </div>
                        <div class="widget-content">
                            <div class="vertical-tabs-container">
                                <div class="vertical-tabs-nav">
                                    <div class="vertical-tab active">DIAGNOSES</div>
                                    <div class="vertical-tab">CORE HEALTH INDICATORS</div>
                                    <div class="vertical-tab">NEEDS</div>
                                </div>
                                <div class="vertical-tabs-content">
                                    <div class="tab-pane-header">
                                        <h4>Diagnoses (0)</h4>
                                        <div class="widget-actions">
                                            <button class="icon-btn"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M8 4a.5.5 0 0 1 .5.5v3h3a.5.5 0 0 1 0 1h-3v3a.5.5 0 0 1-1 0v-3h-3a.5.5 0 0 1 0-1h3v-3A.5.5 0 0 1 8 4z"/></svg></button>
                                        </div>
                                    </div>
                                    <div class="info-message">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M8 16A8 8 0 1 0 8 0a8 8 0 0 0 0 16zm.93-9.412-1 4.705c-.07.34.029.533.304.533.194 0 .487-.07.686-.246l-.088.416c-.287.346-.92.598-1.465.598-.703 0-1.002-.422-.808-1.319l.738-3.468c.064-.293.006-.399-.287-.47l-.451-.081.082-.381 2.29-.287zM8 5.5a1 1 0 1 1 0-2 1 1 0 0 1 0 2z"/></svg>
                                        There are no Diagnoses for this Member that meet current criteria
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="tab-pane" data-pane="details" style="display: none;">
    <div class="member-details-form">
        <div class="form-section">
            <h3 class="section-title">Identity</h3>
            <div class="form-grid cols-4">
                <div class="form-field"><label>First Name *</label><input type="text" id="detailFirstName" disabled></div>
                <div class="form-field"><label>MRN</label><input type="text" id="detailMrn" disabled></div>
                <div class="form-field"><label>Middle Name</label><input type="text" id="detailMiddleName" disabled></div>
                <div class="form-field"><label>Medicaid ID</label><input type="text" id="detailMedicaidId" disabled></div>
                <div class="form-field"><label>Last Name *</label><input type="text" id="detailLastName" disabled></div>
                <div class="form-field"><label>DOB</label><input type="text" id="detailDob" disabled></div>
                <div class="form-field"><label>Preferred Name</label><input type="text" id="detailPreferredName" disabled></div>
                <div class="form-field"><label>DOD</label><input type="text" id="detailDod" disabled></div>
                <div class="form-field"><label>Age</label><input type="text" id="detailAge" disabled></div>
                <div class="form-field"><label>Member Status</label><input type="text" id="detailMemberStatus" disabled></div>
                <div class="form-field"><label>SSN</label><input type="text" value="***-**-****" disabled></div>
                <div class="form-field"><label>Care Manager</label><input type="text" id="detailCareManager" disabled></div>
                <div class="form-field"><label>CMA Start Date</label><input type="text" id="detailCmaStart" disabled></div>
                <div class="form-field"><label>CMA End Date</label><input type="text" id="detailCmaEnd" disabled></div>
            </div>
        </div>
        <div class="form-section">
            <h3 class="section-title">Diagnoses</h3>
            <div class="form-grid cols-4">
                <div class="form-field col-span-2"><label>Primary Diagnosis</label><input type="text" id="detailDxPrimary" disabled></div>
                <div class="form-field col-span-2"><label>Tertiary Diagnosis</label><input type="text" id="detailDxTertiary" disabled></div>
                <div class="form-field col-span-2"><label>Secondary Diagnosis</label><input type="text" id="detailDxSecondary" disabled></div>
                <div class="form-field col-span-2"><label>Additional Diagnosis</label><input type="text" id="detailDxAdditional" disabled></div>
            </div>
        </div>
        <div class="form-section" id="memberConsentOverviewSection">
            </div>
        <div class="form-section">
            <h3 class="section-title">Contact Information</h3>
            <div class="form-grid cols-4">
                <div class="form-field"><label>Home Phone</label><input type="text" id="detailHomePhone" disabled></div>
                <div class="form-field"><label>Street Address</label><input type="text" id="detailAddress" disabled></div>
                <div class="form-field"><label>Cell Phone</label><input type="text" id="detailCellPhone" disabled></div>
                <div class="form-field"><label>Line 2</label><input type="text" id="detailAddress2" placeholder="N/A" disabled></div>
                <div class="form-field"><label>Email</label><input type="text" id="detailEmail" disabled></div>
                <div class="form-field"><label>City</label><input type="text" id="detailCity" disabled></div>
                <div class="form-field"><label>Preferred Contact Method</label><input type="text" id="detailContactMethod" disabled></div>
                <div class="form-field"><label>Zip Code</label><input type="text" id="detailZip" disabled></div>
            </div>
        </div>
        <div class="form-section">
            <h3 class="section-title">Communication Method and Languages</h3>
            <div class="form-grid cols-4">
                <div class="form-field col-span-2"><label>Languages Spoken</label><div class="multi-select-tags" id="detailLanguages"></div></div>
                <div class="form-field col-span-2"><label>Preferred Language *</label><input type="text" id="detailPrefLang" disabled></div>
            </div>
        </div>
        <div class="form-section">
            <h3 class="section-title">Additional Information</h3>
            <div class="form-field"><label>Additional Information</label><textarea rows="3" id="detailAdditionalInfo" disabled></textarea></div>
        </div>
        <div class="form-section">
            <h3 class="section-title">Security Tags</h3>
            <div class="security-tags-list" id="detailSecurityTags">
                </div>
        </div>
        <div class="form-actions" id="detailFormActions">
            <button class="btn btn-secondary" id="backToListBtn">Back to List</button>
            <button class="btn btn-secondary" onclick="toggleEditMode()">Edit</button>
        </div>
    </div>
</div>
            </div>
        </div>
    </div>


    <!-- Service Note Modal -->
<div class="service-note-modal" id="serviceNoteModal">
    <div class="service-note-content">
        <div class="service-note-header">
            <h3 class="service-note-title" id="serviceNoteTitle">Create Service Note</h3>
            <button class="service-note-close" onclick="closeServiceNoteModal()">x</button>
        </div>
       
        <div class="service-note-body">
    <div class="service-note-section">
        <h4 class="service-note-section-title">Member Details</h4>
        <div class="form-row two-col">
            <div class="form-group"><label>Member Name</label><input type="text" value="King Loreley" disabled></div>
            <div></div> <div class="form-group"><label>Care Mgmt. Start Date</label><input type="text" value="12/10/2023" disabled></div>
            <div class="form-group"><label>Care Mgmt. End Date</label><input type="text" value="10/05/2026" disabled></div>
            <div class="form-group"><label>Medical Record Number</label><input type="text" value="" disabled></div>
            <div class="form-group"><label>Medicaid ID</label><input type="text" value="LEAPAug2024DK11" disabled></div>
            <div class="form-group"><label>Date of Birth</label><input type="text" value="03/12/2001" disabled></div>
            <div class="form-group"><label>Age</label><input type="text" value="24 Years" disabled></div>
        </div>
    </div>

    <div class="service-note-section" id="consentInfoSectionInModal">
        <h4 class="service-note-section-title">Consent Information</h4>
        <div class="form-row two-col">
            <div class="form-group"><label>Current Consent Status</label><input type="text" value="To Obtain Consent" disabled></div>
            <div class="form-group"><label>Status Recorded On</label><input type="text" value="12/25/2023" disabled></div>
        </div>
    </div>

    <div class="service-note-section">
        <h4 class="service-note-section-title">Activity</h4>
        <div class="form-row">
            <div class="form-group">
                <label>Is this a Billable Service Note?</label>
                <div style="display: flex; gap: 20px; margin-top: 5px;">
                    <label style="display:flex; align-items:center; gap:5px;"><input type="radio" name="billable_radio" value="yes" onchange="toggleBillingSection()"> Yes</label>
                    <label style="display:flex; align-items:center; gap:5px;"><input type="radio" name="billable_radio" value="no" onchange="toggleBillingSection()" checked> No</label>
                </div>
            </div>
        </div>
        <div class="form-row two-col">
            <div class="form-group">
                <label>Related Activity</label>
                <select><option>Consent Update</option></select>
            </div>
            <div class="form-group" id="billingCodeContainer" style="display: none;">
                <label>Billing Code</label>
                <select id="billingCodeSelect"><option>Select a Code</option></select>
            </div>
        </div>
    </div>

    <div class="service-note-section">
        <h4 class="service-note-section-title">Date/Time of Service</h4>
        <div class="form-row two-col">
            <div class="form-group"><label for="serviceDate">Date of Service</label><input type="date" id="serviceDate"></div>
            <div></div> <div class="form-group"><label for="startTime">Start Time</label><input type="time" id="startTime" onchange="calculateDuration()"></div>
            <div class="form-group"><label for="endTime">End Time</label><input type="time" id="endTime" onchange="calculateDuration()"></div>
            <div class="form-group"><label for="duration">Duration (Minutes)</label><input type="number" id="duration"></div>
            <div class="form-group" style="align-self: end;">
                <label style="display:flex; align-items:center; gap:5px;"><input type="checkbox" id="autoCalculate" onclick="calculateDuration()"> Auto-Calculate Time</label>
            </div>
        </div>
    </div>
   
    <div class="service-note-section">
        <h4 class="service-note-section-title">Contact Update</h4>
       
        <div class="form-row">
            <div class="form-group" id="changeConsentStatusGroup">
                <label for="changeConsentStatus">Change Consent Status To:</label>
                <select id="changeConsentStatus" required></select>
            </div>
        </div>

        <div class="form-row two-col">
            <div class="form-group">
                <label>Contact Method</label>
                <select id="contactMethodSelect" onchange="updateContactTypes()">
                    <option value="">Select Method</option>
                    <option value="phone">Phone Call</option>
                    <option value="in-person">In-Person Visit</option>
                    <option value="video">Video Conference</option>
                    <option value="email">Email</option>
                </select>
            </div>
            <div class="form-group"><label>Type of Contact</label><select id="contactTypeSelect"><option>Select</option></select></div>
            <div class="form-group">
                <label>Place of Service</label>
                <select>
                    <option value="home">Home</option>
                    <option value="office">Office</option>
                    <option value="hospital">Hospital</option>
                    <option value="nursing-facility">Nursing Facility</option>
                    <option value="assisted-living">Assisted Living</option>
                    <option value="community-center">Community Center</option>
                    <option value="telehealth">Telehealth</option>
                    <option value="phone">Phone</option>
                    <option value="other">Other</option>
                </select>
            </div>
            <div class="form-group">
                <label>Is Member Present</label>
                <div style="display: flex; gap: 20px; margin-top: 5px;">
                    <label style="display:flex; align-items:center; gap:5px;"><input type="radio" name="member_present" value="yes" checked> Yes</label>
                    <label style="display:flex; align-items:center; gap:5px;"><input type="radio" name="member_present" value="no"> No</label>
                </div>
            </div>
            <div class="form-group"><label>Attendees</label><textarea rows="2"></textarea></div>
            <div class="form-group"><label>Additional Attendees</label><input type="text"></div>
            <div class="form-group">
                <label>Contact Outcome</label>
                <select id="contactOutcome">
                    <option value="">Select Outcome</option>
                </select>
            </div>
            <div class="form-group">
                <label>Is Contact Successful?</label>
                <div style="display: flex; gap: 20px; margin-top: 5px;">
                    <label style="display:flex; align-items:center; gap:5px;"><input type="radio" name="contact_successful" value="yes"> Yes</label>
                    <label style="display:flex; align-items:center; gap:5px;"><input type="radio" name="contact_successful" value="no" checked> No</label>
                </div>
            </div>
        </div>
    </div>

    <div class="service-note-section" id="followUpAppointmentSection">
    <h4 class="service-note-section-title">Schedule Follow-Up Appointment</h4>
    <div class="form-row">
        <div class="form-group">
            <label>Schedule Follow-Up Appointment?</label>
            <div style="display: flex; gap: 20px; margin-top: 5px;">
                <label style="display:flex; align-items:center; gap:5px;">
                    <input type="radio" name="schedule_followup" value="yes" onchange="toggleFollowUpFields()"> Yes
                </label>
                <label style="display:flex; align-items:center; gap:5px;">
                    <input type="radio" name="schedule_followup" value="no" onchange="toggleFollowUpFields()" checked> No
                </label>
            </div>
        </div>
    </div>
   
    <!-- This section shows when "No" is selected -->
    <div id="noFollowUpSection" class="form-row">
        <div class="form-group col-span-2">
            <label>Please Provide Reason</label>
            <textarea rows="3" placeholder="Enter Reason"></textarea>
        </div>
    </div>
   
    <!-- This section shows when "Yes" is selected -->
    <div id="yesFollowUpSection" style="display: none;">
        <div class="form-row">
            <div class="form-group">
                <label>Title</label>
                <input type="text" placeholder="Scheduled Appt w/ Mock Client">
            </div>
        </div>
       
        <div class="form-row">
            <div class="form-group">
                <label>Follow-Up Date *</label>
                <input type="date" required>
            </div>
            <div class="form-group">
                <label>Start Time</label>
                <input type="time">
            </div>
            <div class="form-group">
                <label>Contact Method</label>
                <select>
                    <option value="">--Select--</option>
                    <option value="phone">Phone Call</option>
                    <option value="in-person">In-Person Visit</option>
                    <option value="video">Video Conference</option>
                    <option value="email">Email</option>
                </select>
            </div>
        </div>
       
        <div class="form-row">
            <div class="form-group">
                <label>End Time</label>
                <input type="time">
            </div>
            <div class="form-group">
                <label>Place of Service</label>
                <select>
                    <option value="">--Select--</option>
                    <option value="home">Home</option>
                    <option value="office">Office</option>
                    <option value="hospital">Hospital</option>
                    <option value="nursing-facility">Nursing Facility</option>
                </select>
            </div>
        </div>
       
        <div class="form-row">
            <div class="form-group">
                <div class="checkbox-group">
                    <input type="checkbox" id="addToTasks">
                    <label for="addToTasks">Add to My Tasks</label>
                </div>
            </div>
        </div>
       
        <div class="form-row">
            <div class="form-group">
                <label>Referred</label>
                <select>
                    <option value="no">No</option>
                    <option value="yes">Yes</option>
                </select>
            </div>
        </div>
       
        <div class="form-row">
            <div class="form-group col-span-2">
                <label>Next Steps</label>
                <textarea rows="3" placeholder="Enter Next Steps"></textarea>
            </div>
        </div>
    </div>
</div>

    <div class="service-note-section">
    <div style="display:flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
        <h4 class="service-note-section-title" style="border:0; margin:0;">Documents</h4>
        <div style="border-top: 1px solid #e1e5e9; margin: 24px 0;"></div>
        <button type="button" class="btn btn-secondary" onclick="document.getElementById('fileUpload').click()">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16" style="margin-right: 6px;">
                <path d="M8 4a.5.5 0 0 1 .5.5v3h3a.5.5 0 0 1 0 1h-3v3a.5.5 0 0 1-1 0v-3h-3a.5.5 0 0 1 0-1h3v-3A.5.5 0 0 1 8 4z"/>
            </svg>
            Add Document
        </button>
        <input type="file" id="fileUpload" style="display: none;" multiple onchange="handleFileUpload(event)">
    </div>
    <div id="documentsTableContainer" style="display: none;">
        <table class="dashboard-table">
            <thead>
                <tr>
                    <th style="width: 20px;"><input type="checkbox"></th>
                    <th>Document Name</th>
                    <th>Content Type</th>
                    <th>Added On</th>
                    <th>Added By</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody id="documentsTableBody">
            </tbody>
        </table>
    </div>
</div>

    <div class="service-note-section">
        <div style="display:flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
            <h4 class="service-note-section-title" style="border:0; margin:0;">Signature</h4>
            <a href="#" class="link" style="color: #dc3545;" onclick="clearSignature(); return false;">Remove Signature</a>
        </div>
        <div style="border: 1px solid #ddd; border-radius: 4px; padding: 10px;">
            <canvas id="signatureCanvas" style="width:100%; height:100px;"></canvas>
        </div>
        <div class="form-row three-col" style="margin-top: 10px; padding-top: 10px; border-top: 1px solid #eee;">
            <div class="form-group"><label>User Name</label><span>John.Manager.1</span></div>
            <div class="form-group"><label>Date Signed</label><span>09/02/2025</span></div>
            <div class="form-group"><label>Degree & Credential(s)</label><span>MS, BNSN-RN, CCM</span></div>
        </div>
    </div>
</div>
       
        <div class="service-note-footer" id="serviceNoteFooter">
            </div>
    </div>
</div>

</div> </div>

        <div class="notes-panel" id="generalNotesPanel">
        <div class="notes-header">
                <div class="notes-header-content">
                    <h3 class="notes-title">General Notes</h3>
                    <div class="notes-description">These are general-purpose notes, not tied to a specific member, and can be accessed at any time.</div>
                </div>
                <button class="notes-close-btn" onclick="closeGeneralNotes()">x</button>
            </div>
            <div class="notes-content">
                <textarea id="generalNotesTextArea" class="notes-textarea" placeholder="Add your general notes here..."></textarea>
            </div>
            <div class="notes-footer">
                <span class="notes-save-indicator" id="generalSaveIndicator">Notes saved automatically</span>
            </div>
        </div>



        <!-- Contextual Sidebar -->
    <div class="contextual-sidebar" id="contextualSidebar">
       
        <div class="contextual-sidebar-header">
            <div class="contextual-sidebar-title">Quick Links (6)</div>
            <button class="close-contextual-sidebar" id="closeContextualSidebar">x</button>
        </div>
       
        <div class="contextual-quick-links">
            <!-- Assistance Section - Moved to Top -->
            <!-- Quick Links Section -->
            <div class="quick-links-section">
                <div class="contextual-quick-links">

            <!-- Quick Links Section -->
            <div class="quick-links-section">
                <button class="contextual-quick-link" onclick="openSlidePanel('care-team')">
                    <div class="contextual-quick-link-icon care-team"></div>
                    <div class="contextual-quick-link-content">
                        <div class="contextual-quick-link-title">Add New Care Team Member</div>
                    </div>
                    <div class="contextual-quick-link-badge">New</div>
                    <div class="contextual-quick-link-arrow"></div>
                </button>
                <button class="contextual-quick-link" onclick="openSlidePanel('diagnosis')">
                    <div class="contextual-quick-link-icon diagnosis"></div>
                    <div class="contextual-quick-link-content">
                        <div class="contextual-quick-link-title">Add New Diagnosis</div>
                    </div>
                    <div class="contextual-quick-link-arrow"></div>
                </button>
                <button class="contextual-quick-link" onclick="openSlidePanel('medications')">
                    <div class="contextual-quick-link-icon medications"></div>
                    <div class="contextual-quick-link-content">
                        <div class="contextual-quick-link-title">Add New Medication</div>
                    </div>
                    <div class="contextual-quick-link-arrow"></div>
                </button>
                <button class="contextual-quick-link" onclick="openSlidePanel('related-persons')">
                    <div class="contextual-quick-link-icon related-persons"></div>
                    <div class="contextual-quick-link-content">
                        <div class="contextual-quick-link-title">Add New Related Person</div>
                    </div>
                    <div class="contextual-quick-link-arrow"></div>
                </button>
                <button class="contextual-quick-link" onclick="openSlidePanel('member-details')">
                    <div class="contextual-quick-link-icon member-details"></div>
                    <div class="contextual-quick-link-content">
                        <div class="contextual-quick-link-title">Member Details</div>
                    </div>
                    <div class="contextual-quick-link-arrow"></div>
                </button>
                <button class="contextual-quick-link" onclick="openSlidePanel('service-notes')">
                    <div class="contextual-quick-link-icon service-notes"></div>
                    <div class="contextual-quick-link-content">
                        <div class="contextual-quick-link-title">Service Notes</div>
                    </div>
                    <div class="contextual-quick-link-arrow"></div>
                </button>
            </div>
        </div>
            </div>
        </div>
    </div>

    <!-- Overlay -->
    <div class="overlay" id="overlay"></div>

    <!-- Slide Panel -->
    <div class="slide-panel" id="slidePanel">
        <div class="context-banner">
            <div class="context-info">
                <div class="context-icon"></div>
                <span>Adding information to: <strong>CNS-FinalUATV2 Assessment</strong></span>
            </div>
            <span>This will be included in the final report</span>
        </div>
       
        <div class="slide-panel-header">
            <div class="slide-panel-title" id="slidePanelTitle">Quick Link</div>
            <button class="close-panel" onclick="closeSlidePanel()">x</button>
        </div>
       
        <div class="slide-panel-content" id="slidePanelContent">
            <!-- Dynamic content will be loaded here -->
        </div>
       
        <div class="slide-panel-footer">
            <button class="btn btn-secondary" onclick="closeSlidePanel()">Cancel</button>
            <button class="btn btn-primary" onclick="saveQuickLinkData()">Save & Continue Assessment</button>
        </div>
    </div>
    <!-- Custom Modal -->
    <div class="custom-modal" id="customModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="modalTitle">
                    <span class="modal-icon" id="modalIcon"></span>
                    <span id="modalTitleText">Open Quick Link</span>
                </h3>
            </div>
            <div class="modal-body">
                <p class="modal-message" id="modalMessage">
                    You will be redirected to Member Details in a new tab. You can continue working on this assessment.
                </p>
            </div>
            <div class="modal-footer">
                <button class="modal-btn modal-btn-secondary" id="modalCancel">Cancel</button>
                <button class="modal-btn modal-btn-primary" id="modalConfirm">Continue</button>
            </div>
        </div>
    </div>


    <div class="notes-panel" id="historyPanel">
    <div class="notes-header">
        <div class="notes-header-content">
            <h3 class="notes-title">Recent History</h3>
            <div class="notes-description">A log of your last 20 visited pages and actions.</div>
        </div>
        <button class="notes-close-btn" onclick="closeHistoryPanel()">x</button>
    </div>
    <div class="notes-content" style="background: #fff; padding: 0;">
        <div id="historyListContainer" class="history-list">
            </div>
    </div>
</div>
<div class="notes-overlay" id="historyOverlay" onclick="closeHistoryPanel()"></div>



<button class="ai-copilot-trigger" id="aiCopilotTrigger" onclick="toggleAICopilot()">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
        <path d="M12 2L13.09 8.26L18 6L14.74 10.91L21 12L14.74 13.09L18 18L13.09 15.74L12 22L10.91 15.74L6 18L9.26 13.09L3 12L9.26 10.91L6 6L10.91 8.26L12 2Z"/>
    </svg>
    <span class="notification-dot" id="aiNotificationDot" style="display: none;"></span>
    <span class="keyboard-hint">AI Co-pilot <kbd>J</kbd></span>
</button>

<div class="ai-copilot-panel closed" id="aiCopilotPanel">
    <!-- Header -->
    <div class="ai-copilot-header">
        <div class="ai-copilot-header-left">
            <div class="ai-copilot-avatar">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M12 2L13.09 8.26L18 6L14.74 10.91L21 12L14.74 13.09L18 18L13.09 15.74L12 22L10.91 15.74L6 18L9.26 13.09L3 12L9.26 10.91L6 6L10.91 8.26L12 2Z"/>
                </svg>
            </div>
            <div>
                <div class="ai-copilot-title" id="aiPanelTitle">New chat</div>
                <div class="ai-copilot-subtitle">Sevida AI Co-pilot</div>
            </div>
        </div>
        <div class="ai-copilot-header-actions">
            <button class="ai-header-appt-btn" id="aiHeaderApptBtn" onclick="openAICopilotForAppointment()" title="Schedule Appointment">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/><path d="M12 14v4M10 16h4"/></svg>
                Appt
            </button>
            <button class="ai-copilot-header-btn" onclick="resetAICopilot()" title="New chat">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M12 5v14M5 12h14"/>
                </svg>
            </button>
            <button class="ai-copilot-header-btn" onclick="toggleAICopilotExpand()" title="Expand / Collapse" id="aiExpandBtn">
                <svg class="ai-expand-icon-expand" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M15 3h6v6M9 21H3v-6M21 3l-7 7M3 21l7-7"/>
                </svg>
                <svg class="ai-expand-icon-collapse" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M4 14h6v6M20 10h-6V4M10 14l-7 7M14 10l7-7"/>
                </svg>
            </button>
            <button class="ai-copilot-header-btn" onclick="toggleAICopilot()" title="Close">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M18 6L6 18M6 6l12 12"/>
                </svg>
            </button>
        </div>
    </div>

    <!-- Messages / Content Area -->
    <div class="ai-copilot-messages" id="aiMessages">
        <!-- Welcome screen with questions - rendered by JS -->
    </div>

    <!-- Input Area -->
    <div class="ai-copilot-input">
        <div class="ai-input-wrapper">
            <input type="text" class="ai-input-field" id="aiInputField"
                placeholder="Ask or build anything..."
                onkeypress="if(event.key==='Enter')sendAIMessage()"
                autocomplete="off" />
            <button class="ai-send-btn" id="aiSendBtn" onclick="sendAIMessage()">
                <svg viewBox="0 0 24 24" fill="currentColor"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/></svg>
            </button>
        </div>
    </div>
</div>

</div>
    <script>

        function toggleCompactView() {
        const header = document.getElementById('memberHeader');
        const toggleBtn = document.getElementById('compactToggle');
        if (!header || !toggleBtn) return;
        if (header.classList.contains('expanded')) { return; }
        header.classList.toggle('compact-view');
        toggleBtn.classList.toggle('active');
        const text = toggleBtn.querySelector('.view-toggle-text');
        if (text) {
            text.textContent = header.classList.contains('compact-view') ? 'Detailed' : 'Compact';
        }
    }

        function toggleKeyInfoView(event) {
        if (event) { event.preventDefault(); event.stopPropagation(); }
        const header = document.getElementById('memberHeader');
        const toggleBtn = document.getElementById('keyInfoToggle');
        if (!header || !toggleBtn) return;
        header.classList.toggle('compact-view');
        header.classList.remove('expanded');
        toggleBtn.classList.toggle('active');
        const text = toggleBtn.querySelector('.view-toggle-text');
        if (text) {
            text.textContent = header.classList.contains('compact-view') ? 'Detailed' : 'Compact';
        }
    }

        function toggleMemberHeader() {
        const header = document.getElementById('memberHeader');
        if (header.classList.contains('expanded')) {
            header.classList.remove('expanded');
        } else if (header.classList.contains('key-info-hidden')) {
            header.classList.remove('key-info-hidden');
            header.classList.add('expanded');
        } else {
            header.classList.add('key-info-hidden');
        }
    }

        function goToConsent() {
            // This would navigate to the consent tab/page
            alert('Navigate to Consent tab/page');
        }

        function goToAssessment() {
            // This would navigate to the assessment tab/page  
            alert('Navigate to Assessment tab/page');
        }
        function assignCareManager(event) {
            event.stopPropagation(); // Prevent accordion from opening
            // Show care manager assignment popup/modal
            showCareManagerModal();
        }

        function showCareManagerModal() {
            // This would show a modal with care manager list
            alert('Care Manager Assignment Modal\n\nSelect from available care managers:\n- John Manager\n- Sarah Wilson\n- Mike Davis\n\n(Member can only have one care manager)');
            // In real implementation, this would open a proper modal/dropdown
        }

        function copyToClipboard(text, iconElement) {
            event.stopPropagation(); // Prevent accordion from opening
           
            navigator.clipboard.writeText(text).then(function() {
                showCopyFeedback(iconElement);
            }).catch(function(err) {
                // Fallback for older browsers
                const textArea = document.createElement('textarea');
                textArea.value = text;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
                showCopyFeedback(iconElement);
            });
        }

        function showCopyFeedback(iconElement) {
            const keyInfoItem = iconElement.closest('.key-info-item');
            const feedback = keyInfoItem.querySelector('.copy-feedback');
           
            feedback.classList.add('show');
           
            setTimeout(() => {
                feedback.classList.remove('show');
            }, 2000);
        }

        let currentAlert = 0;
        let alertInterval;
        const alerts = document.querySelectorAll('.alert-item');
        const totalAlerts = alerts.length;

        function initializeSlider() {
            updateSlider();
            startAutoSlide();
        }

        function createDots() {
            const dotsContainers = document.querySelectorAll('.slider-dots');
            dotsContainers.forEach(container => {
                container.innerHTML = '';
                for (let i = 0; i < totalAlerts; i++) {
                    const dot = document.createElement('div');
                    dot.className = `slider-dot ${i === 0 ? 'active' : ''}`;
                    dot.onclick = () => goToAlert(i);
                    container.appendChild(dot);
                }
            });
        }

        function nextAlert() {
            if (currentAlert < totalAlerts - 1) {
                currentAlert++;
                updateSlider();
                restartAutoSlide();
            }
        }

        function previousAlert() {
            if (currentAlert > 0) {
                currentAlert--;
                updateSlider();
                restartAutoSlide();
            }
        }

        // function goToAlert(index) {
        //     currentAlert = index;
        //     updateSlider();
        //     restartAutoSlide();
        // }

        // function startAutoSlide() {
        //     alertInterval = setInterval(() => {
        //         if (currentAlert < totalAlerts - 1) {
        //             currentAlert++;
        //         } else {
        //             currentAlert = 0;
        //         }
        //         updateSlider();
        //     }, 5000); // Change every 5 seconds
        // }

        // function restartAutoSlide() {
        //     clearInterval(alertInterval);
        //     startAutoSlide();
        // }



        let membersViewHTML = '';
        let serviceNotesViewHTML = '';
        let dashboardContent = '';
        let detailsContent = '';
        let tabContents = {};
        let currentActiveTab = 'dashboard';
        let currentGlobalLOB = 'TCM';

    // --- 2. CORE FUNCTIONS ---

    // This function will set up all event listeners for the Members page.
    // We need to call it every time we load the Members view.
    function initializeMembersViewListeners() {
    const pageContent = document.querySelector('.page-content');
    if (!pageContent) return; 

    const tabs = pageContent.querySelectorAll('.content-tabs .tab');
    const tabContentContainer = pageContent.querySelector('.tab-content');

    if (!tabs.length || !tabContentContainer) {
        return;
    }

    // This is the new, robust function that runs on every tab click
    const switchTab = (tabEl) => {
        const tabKey = tabEl.dataset.tab;

        // 1. Update active class on the tab buttons themselves
        tabs.forEach(t => t.classList.remove('active'));
        tabEl.classList.add('active');

        // 2. Hide all existing content panes
        const allPanes = tabContentContainer.querySelectorAll('.tab-pane');
        allPanes.forEach(p => {
            p.style.display = 'none';
            p.classList.remove('active');
        });

        // 3. Find the target pane for the clicked tab
        let targetPane = tabContentContainer.querySelector(`.tab-pane[data-pane="${tabKey}"]`);

        if (!targetPane) {
            // Create new pane
            targetPane = document.createElement('div');
            targetPane.classList.add('tab-pane');
            targetPane.dataset.pane = tabKey;
            tabContentContainer.appendChild(targetPane);
        }

        // 4. Show the correct pane and render content from controllers
        if (targetPane) {
            targetPane.style.display = (tabKey === 'dashboard') ? 'grid' : 'block';
            targetPane.classList.add('active');

            // RENDER CONTENT FROM CONTROLLERS - USING MEMBER DATABASE
            const member = window.currentMember;
            if (member) {
                switch(tabKey) {
                    case 'dashboard':
                        if (typeof populateDashboard === 'function') populateDashboard(member);
                        break;
                    case 'details':
                        if (typeof populateDetailsForm === 'function') populateDetailsForm(member);
                        break;
                    case 'timeline':
                        if (typeof initializeTimelineFilters === 'function') setTimeout(initializeTimelineFilters, 100);
                        break;
                    case 'insurance':
                        if (typeof InsuranceController !== 'undefined') targetPane.innerHTML = InsuranceController.render(member);
                        break;
                    case 'screenings':
                        if (typeof ScreeningController !== 'undefined') targetPane.innerHTML = ScreeningController.render(member);
                        break;
                    case 'bio-psycho':
                        if (typeof BioPsychoSocialController !== 'undefined') targetPane.innerHTML = BioPsychoSocialController.render(member);
                        break;
                    case 'history':
                        if (typeof HealthHistoryController !== 'undefined') targetPane.innerHTML = HealthHistoryController.render(member);
                        break;
                    case 'population':
                        if (typeof PopulationInsightsController !== 'undefined') targetPane.innerHTML = PopulationInsightsController.render(member);
                        break;
                    case 'activity':
                        if (typeof ActivityHistoryController !== 'undefined') targetPane.innerHTML = ActivityHistoryController.render(member);
                        break;
                    case 'careteam':
                        if (typeof CareTeamController !== 'undefined') targetPane.innerHTML = CareTeamController.render(member);
                        break;
                    case 'careplans':
                        if (typeof CarePlanController !== 'undefined') targetPane.innerHTML = CarePlanController.render(member);
                        break;
                }
            }
            
            if (typeof MemberActivityManager !== 'undefined' && tabKey === 'dashboard') {
                MemberActivityManager.renderCard(member ? member.id : 'LEAPAug2024DK11');
            }
        } else {
            console.error(`Content panel for tab "${tabKey}" could not be found or created.`);
        }
    };

    // Attach a fresh, clean listener to each tab.
    tabs.forEach(tab => {
        tab.onclick = (e) => {
            e.preventDefault();
            switchTab(tab);
        };
    });

    // Finally, ensure the correct default tab is shown when this function runs.
    const activeTab = pageContent.querySelector('.content-tabs .tab.active') || tabs[0];
    if (activeTab) {
        // We use a small timeout to ensure the DOM is ready after being re-inserted.
        setTimeout(() => switchTab(activeTab), 0);
    }
}
   
    // Function to handle the active state in the sidebar
    function updateActiveNavItem(activeItemId) {
    // 1. Remove the 'active' class from ALL potential navigation elements first.
    document.querySelectorAll('.sidebar-nav .nav-item, .sidebar-nav .accordion-toggle').forEach(item => {
        item.classList.remove('active');
    });
    
    // 2. Add the 'active' class to the newly clicked item.
    const activeItem = document.getElementById(activeItemId);
    if (activeItem) {
        activeItem.classList.add('active');
    }
}

function updateBreadcrumbs(crumbs) {
    const breadcrumbEl = document.querySelector('.breadcrumb');
    if (!breadcrumbEl) return;

    // Handle string input (convert to array)
    if (typeof crumbs === 'string') {
        crumbs = crumbs.split(' > ').map(s => s.trim());
    }
    
    // Safety check
    if (!Array.isArray(crumbs)) return;

    let html = '';
    crumbs.forEach((crumb, index) => {
        if (index < crumbs.length - 1) {
            if (crumb === 'Members') {
                html += `<a href="#" id="breadcrumbMembersLink">${crumb}</a> &gt; `;
            } else {
                html += `${crumb} &gt; `;
            }
        } else {
            html += `<strong>${crumb}</strong>`;
        }
    });
    breadcrumbEl.innerHTML = html;
}

    // Configuration data structure
const configurationData = {
    "Admin - Rules": [
        "Rule Configuration",
        "Rule Sets"
    ],
    "Admin - Setup": [
        "Activity Status",
        "Claim Status",
        "Client Population",
        "Client Status",
        "County",
        "Department",
        "Diagnosis Status",
        "Episode Status",
        "Flag",
        "Flag Category",
        "Flag Icon",
        "Health Networks",
        "Legal Status",
        "Priority",
        "Priority Population",
        "Program",
        "Termination Reason",
        "Visit Type"
    ],
    "AI - Document Extraction": [
        "Document Extraction Schema Configuration"
    ],
    "Assessments - Forms": [
        "Assessments",
        "Assessment Type",
        "Assessment Sub Type",
        "Old Assessments"
    ],
    "Control Center": [
        "Client Cohorts",
        "Schedule Item Type"
    ],
    "Attestation": [
        "Attestation Artifact",
        "Attestation Content",
        "Attestation Reason Code"
    ],
    "Bio/Psycho/Social": {
        "Employment": [
            "Employment Status",
            "Employment Type"
        ],
        "Living Arrangements": [
            "Living Arrangement Category"
        ],
        "Volunteering": [
            "Volunteer Status",
            "Volunteer Type"
        ]
    },
    "Care Plans": {
        "Care Plan Category": [],
        "Care Plan Status": [],
        "Life Domain > Life Domain Narratives": [
            "Life Domain Category"
        ],
        "NGI": [
            "Goal Source",
            "Goal Source Subtype",
            "Goal Template",
            "Intervention Source",
            "Intervention Source Subtype",
            "Intervention Template",
            "Needs Outcome",
            "Needs Outcome Reason",
            "Need Template"
        ],
        "Plan Development > Crisis Plan Details": [
            "Plan Development Material"
        ],
        "Plan Development > Plan Medication & Allergies": [
            "Allergy Intolerance Criticality"
        ]
    },
    "Care Team": [
        "Care Team Outcome",
        "Care Team Outcome Reason",
        "Care Team Type"
    ],
    "Insurance Information": {
        "Plan Sub Type": [],
        "Plan Type": [],
        "Enrollment": [
            "Coverage Plan",
            "Insurance Company"
        ],
        "Risk Acuity": [
            "Risk Category",
            "Risk Type"
        ]
    },
    "Member Details": [
        "Ethnicity",
        "Race",
        "Marital Status",
        "Sexual Orientation"
    ],
    "Provider Management": [
        "External Directory Data Source",
        "Service Provider Category",
        "Provider Status",
        "Service Line",
        "Service Line Status"
    ],
    "Referral Management": [
        "Referral Status",
        "Request Type",
        "Reason for Referral"
    ],
    "Screenings & Assessments": {
        "Barriers and Strengths": [
            "BNS Source",
            "BNS Source Subtype",
            "BNS Template"
        ],
        "Identified Needs": [
            "Needs Category",
            "Needs Source",
            "Needs Status",
            "Needs Sensitivity"
        ]
    },
    "Service Notes": [
        "Billing Service",
        "Billing Service Category",
        "Coding",
        "Coding Category",
        "Coding System",
        "Note Activity",
        "Place of Service"
    ],
    "Tasks": [
        "Task Intent",
        "Task Status",
        "Task Type",
        "Task Templates"
    ]
};

// Open configuration drawer
function openConfigDrawer() {
    const drawer = document.getElementById('configDrawer');
    const overlay = document.getElementById('configDrawerOverlay');
    const sidebar = document.getElementById('sidebar');
   
    // Adjust position based on sidebar state
    if (sidebar.classList.contains('collapsed')) {
        drawer.classList.add('from-collapsed');
    } else {
        drawer.classList.remove('from-collapsed');
    }
   
    populateConfigCategories();
    drawer.classList.add('show');
    overlay.classList.add('show');
}

// Close configuration drawer
function closeConfigDrawer() {
    const drawer = document.getElementById('configDrawer');
    const overlay = document.getElementById('configDrawerOverlay');
   
    if (drawer) {
        drawer.classList.remove('show');
        drawer.classList.remove('from-collapsed');
        // This is the critical fix: Reset the owner when the drawer is closed
        if (drawer.dataset) {
            drawer.dataset.owner = ''; 
        }
    }
    if (overlay) {
        overlay.classList.remove('show');
    }
}


// Populate categories in drawer
function populateConfigCategories() {
    const container = document.getElementById('configCategories');
    const searchWrapper = document.querySelector('.config-search-wrapper');
    if (searchWrapper) {
        searchWrapper.style.display = 'block';
    }
    container.innerHTML = '';
   
    Object.keys(configurationData).forEach(categoryName => {
        const categoryDiv = document.createElement('div');
        categoryDiv.className = 'config-category';
       
        const headerDiv = document.createElement('div');
        headerDiv.className = 'config-category-header';
        headerDiv.onclick = () => toggleConfigCategory(categoryDiv);
       
        headerDiv.innerHTML = `
            <span>${categoryName}</span>
            <svg class="config-category-arrow" width="12" height="12" fill="currentColor" viewBox="0 0 16 16">
                <path fill-rule="evenodd" d="M1.646 4.646a.5.5 0 0 1 .708 0L8 10.293l5.646-5.647a.5.5 0 0 1 .708.708l-6 6a.5.5 0 0 1-.708 0l-6-6a.5.5 0 0 1 0-.708z"/>
            </svg>
        `;
       
        const itemsDiv = document.createElement('div');
        itemsDiv.className = 'config-category-items';
       
        const items = configurationData[categoryName];
       
        if (Array.isArray(items)) {
            // Simple array of items
            items.forEach(item => {
                const itemDiv = document.createElement('div');
                itemDiv.className = 'config-item';
                itemDiv.textContent = item;
                itemDiv.onclick = () => navigateToConfig(item);
                itemsDiv.appendChild(itemDiv);
            });
        } else {
            // Object with subcategories
            Object.keys(items).forEach(subCategoryName => {
                const subCatDiv = document.createElement('div');
                subCatDiv.className = 'config-subcategory';
                subCatDiv.textContent = subCategoryName;
                itemsDiv.appendChild(subCatDiv);
               
                items[subCategoryName].forEach(item => {
                    const itemDiv = document.createElement('div');
                    itemDiv.className = 'config-item sub-item';
                    itemDiv.textContent = item;
                    itemDiv.onclick = () => navigateToConfig(item);
                    itemsDiv.appendChild(itemDiv);
                });
            });
        }
       
        categoryDiv.appendChild(headerDiv);
        categoryDiv.appendChild(itemsDiv);
        container.appendChild(categoryDiv);
    });
}

// Toggle category open/close
function toggleConfigCategory(categoryDiv) {
    categoryDiv.classList.toggle('open');
    const header = categoryDiv.querySelector('.config-category-header');
    header.classList.toggle('active');
}

// Navigate to specific configuration
function navigateToConfig(configName) {
    console.log(`Navigate to configuration: ${configName}`);
    // Add your navigation logic here
    closeConfigDrawer();
}

// Update the existing accordion click handler for Configurations
document.addEventListener('DOMContentLoaded', function() {
    // Find and update the configurations accordion
    const configAccordion = document.querySelector('[title="Configurations"]');
    if (configAccordion) {
        const link = configAccordion.querySelector('.nav-link');
        if (link) {
            link.onclick = function(e) {
                e.preventDefault();
                e.stopPropagation();
                openConfigDrawer();
            };
        }
    }
});

    document.addEventListener('DOMContentLoaded', function() {
        // --- Store the initial HTML content for each view ---
        membersViewHTML = document.getElementById('pageContainer').innerHTML;

        // FIX: Define the content for the inner tabs
        dashboardContent = document.querySelector('.dashboard-grid')?.outerHTML || 'Dashboard content not found.';
        detailsContent = document.querySelector('.member-details-form')?.outerHTML || 'Details content not found.';
        tabContents = {
            dashboard: dashboardContent,
            details: detailsContent,
            timeline: `
            <div class="timeline-view">
        <div class="timeline-controls">
            <div class="timeline-filters">
                <div class="filter-item">
                    <label class="filter-label">From:</label>
                    <input type="date" class="filter-input" id="timelineStartDate">
                </div>
                <div class="filter-item">
                    <label class="filter-label">To:</label>
                    <input type="date" class="filter-input" id="timelineEndDate">
                </div>
                <div class="filter-item">
                    <label class="filter-label">Event Type:</label>
                    <select class="filter-select" id="timelineEventType">
                        <option value="all">All Events</option>
                        <option value="assignment">Assignment</option>
                        <option value="consent">Consent</option>
                        <option value="assessment">Assessment</option>
                        <option value="care-plan">Care Plan</option>
                        <option value="adt">ADT Events</option>
                        <option value="appointment">Appointments</option>
                        <option value="callback">Callbacks</option>
                        <option value="task">Tasks</option>
                        <option value="workflow">Workflows</option>
                        <option value="program">Programs</option>
                        <option value="billing">Billing</option>
                    </select>
                </div>
                <button class="btn btn-secondary" onclick="printTimeline()" style="margin-left: 12px;">
                    <svg style="width:16px;height:16px;margin-right:6px;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a1 1 0 001-1v-4a1 1 0 00-1-1H9a1 1 0 00-1 1v4a1 1 0 001 1zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z"></path>
                    </svg>
                    Print Timeline
                </button>
            </div>
            <div class="timeline-view-controls">
                <button class="timeline-view-btn active" onclick="switchTimelineView('horizontal')">Timeline</button>
                <button class="timeline-view-btn" onclick="switchTimelineView('grid')">Grid</button>
                <button class="timeline-view-btn" onclick="switchTimelineView('list')">List</button>
            </div>
        </div>
        <div class="timeline-container">
            <div class="horizontal-timeline" id="horizontalTimelineView">
                <div class="timeline-track">
                    <div class="timeline-line"></div>
                    <div class="timeline-events" id="timelineEventsContainer">
                        <div class="timeline-event" data-date="2024-01-15" data-type="assignment"><div class="event-label">Assignment</div><div class="event-marker assignment"><svg fill="none" stroke="currentColor" viewBox="0 0 24 24" style="width:12px;height:12px;color:white;"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path></svg></div><div class="event-date">01/15/2024</div><div class="event-popup"><div class="event-title">Member Assigned to Organization</div><div class="event-meta">Jan 15, 2024 at 09:30 AM &bull; By: Admin User</div><p>Member assigned to care team Alpha with high priority status.</p><div style="display: flex; justify-content: space-between; align-items: center; margin-top: 12px;"><span class="event-type-badge assignment">Assignment</span><button class="btn btn-primary" style="font-size: 12px; padding: 6px 12px;">View Details</button></div></div></div>
                        <div class="timeline-event" data-date="2024-01-15" data-type="task"><div class="event-label">Task</div><div class="event-marker task"><svg fill="none" stroke="currentColor" viewBox="0 0 24 24" style="width:12px;height:12px;color:white;"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v6a2 2 0 002 2h6a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4"></path></svg></div><div class="event-date">01/15/2024</div><div class="event-popup"><div class="event-title">Initial Contact Task Created</div><div class="event-meta">Jan 15, 2024 at 10:00 AM &bull; By: System</div><p>Automated task created for initial member outreach within 24 hours.</p><div style="display: flex; justify-content: space-between; align-items: center; margin-top: 12px;"><span class="event-type-badge task">Task</span><button class="btn btn-primary" style="font-size: 12px; padding: 6px 12px;">View Details</button></div></div></div>
                        <div class="timeline-event" data-date="2024-01-16" data-type="consent"><div class="event-label">Consent</div><div class="event-marker consent"><svg fill="none" stroke="currentColor" viewBox="0 0 24 24" style="width:12px;height:12px;color:white;"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg></div><div class="event-date">01/16/2024</div><div class="event-popup"><div class="event-title">Consent Forms Completed</div><div class="event-meta">Jan 16, 2024 at 02:15 PM &bull; By: King Loreley</div><p>HIPAA, treatment consent, and data sharing agreements signed.</p><div style="display: flex; justify-content: space-between; align-items: center; margin-top: 12px;"><span class="event-type-badge consent">Consent</span><button class="btn btn-primary" style="font-size: 12px; padding: 6px 12px;">View Details</button></div></div></div>
                        <div class="timeline-event" data-date="2024-01-18" data-type="assessment"><div class="event-label">Assessment</div><div class="event-marker assessment"><svg fill="none" stroke="currentColor" viewBox="0 0 24 24" style="width:12px;height:12px;color:white;"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v6a2 2 0 002 2h6a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path></svg></div><div class="event-date">01/18/2024</div><div class="event-popup"><div class="event-title">Comprehensive Health Assessment</div><div class="event-meta">Jan 18, 2024 at 10:00 AM &bull; By: Dr. Smith</div><p>Initial health assessment completed with risk stratification. Member identified as high-risk diabetes.</p><div style="display: flex; justify-content: space-between; align-items: center; margin-top: 12px;"><span class="event-type-badge assessment">Assessment</span><button class="btn btn-primary" style="font-size: 12px; padding: 6px 12px;">View Details</button></div></div></div>
                        <div class="timeline-event" data-date="2024-01-20" data-type="care-plan"><div class="event-label">Care Plan</div><div class="event-marker care-plan"><svg fill="none" stroke="currentColor" viewBox="0 0 24 24" style="width:12px;height:12px;color:white;"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"></path></svg></div><div class="event-date">01/20/2024</div><div class="event-popup"><div class="event-title">Initial Care Plan Created</div><div class="event-meta">Jan 20, 2024 at 03:45 PM &bull; By: Care Manager Jones</div><p>Comprehensive care plan developed with 6 interventions focusing on diabetes management and lifestyle modifications.</p><div style="display: flex; justify-content: space-between; align-items: center; margin-top: 12px;"><span class="event-type-badge care-plan">Care Plan</span><button class="btn btn-primary" style="font-size: 12px; padding: 6px 12px;">View Details</button></div></div></div>
                        <div class="timeline-event" data-date="2024-02-10" data-type="adt"><div class="event-label">ADT Event</div><div class="event-marker adt"><svg fill="none" stroke="currentColor" viewBox="0 0 24 24" style="width:12px;height:12px;color:white;"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1"></path></svg></div><div class="event-date">02/10/2024</div><div class="event-popup"><div class="event-title">Emergency Room Visit</div><div class="event-meta">Feb 10, 2024 at 06:30 PM &bull; By: System Integration</div><p>ED visit for chest pain - admitted for observation. Care team notified immediately.</p><div style="display: flex; justify-content: space-between; align-items: center; margin-top: 12px;"><span class="event-type-badge adt">ADT Event</span><button class="btn btn-primary" style="font-size: 12px; padding: 6px 12px;">View Details</button></div></div></div>
                        <div class="timeline-event" data-date="2024-05-15" data-type="consent"><div class="event-label">Consent</div><div class="event-marker" style="background: #ef4444;"><svg fill="none" stroke="currentColor" viewBox="0 0 24 24" style="width:12px;height:12px;color:white;"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg></div><div class="event-date">05/15/2024</div><div class="event-popup"><div class="event-title">Member Opted Out</div><div class="event-meta">May 15, 2024 at 01:20 PM &bull; By: King Loreley</div><p>Member withdrew consent for care management services. All active interventions suspended.</p><div style="display: flex; justify-content: space-between; align-items: center; margin-top: 12px;"><span class="event-type-badge" style="background: #fee2e2; color: #dc2626;">Consent Withdrawn</span><button class="btn btn-primary" style="font-size: 12px; padding: 6px 12px;">View Details</button></div></div></div>
                        <div class="timeline-event" data-date="2024-08-30" data-type="callback"><div class="event-label">Callback</div><div class="event-marker callback"><svg fill="none" stroke="currentColor" viewBox="0 0 24 24" style="width:12px;height:12px;color:white;"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"></path></svg></div><div class="event-date">08/30/2024</div><div class="event-popup"><div class="event-title">Follow-up Call Scheduled</div><div class="event-meta">Aug 30, 2024 at 09:47 AM &bull; By: System User</div><p>Real-time event update - Follow-up call scheduled to check on member status.</p><div style="display: flex; justify-content: space-between; align-items: center; margin-top: 12px;"><span class="event-type-badge callback">Callback</span><button class="btn btn-primary" style="font-size: 12px; padding: 6px 12px;">View Details</button></div></div></div>
                    </div>
                </div>
            </div>
            <div class="grid-timeline" id="gridTimelineView" style="display: none;"><div class="events-grid" id="eventsGridContainer"></div></div>
            <div class="list-timeline" id="listTimelineView" style="display: none;"><div class="events-list" id="eventsListContainer"></div></div>
        </div>
    </div>
    `,
    insurance: `insurance: '',`,
    history: `<div class="content-placeholder"><h3>Health History</h3><p>Content for this tab is not yet built.</p></div>`
        };

        serviceNotesViewHTML = `
    <div class="dashboard-widget full-width" style="margin: 24px;">
        <div class="widget-header">
            <h3 class="widget-title">List of Service Notes (4778)</h3>
            <div class="search-filter-area">
                <div class="search-box"><input type="text" placeholder="Search by Note ID, Member..."><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M11.742 10.344a6.5 6.5 0 1 0-1.397 1.398h-.001c.03.04.062.078.098.115l3.85 3.85a1 1 0 0 0 1.415-1.414l-3.85-3.85a1.007 1.007 0 0 0-.115-.1zM12 6.5a5.5 5.5 0 1 1-11 0 5.5 5.5 0 0 1 11 0z"/></svg></div>
                <button class="filter-btn">Filters</button><button class="clear-btn">Clear Filters</button><button class="btn btn-primary" style="padding: 6px 12px;">Add New</button>
            </div>
        </div>
        <div class="widget-content">
            <table class="dashboard-table">
                <thead><tr><th>Note ID</th><th>Member Name</th><th>Staff Member Type</th><th>Related Activity</th><th>Date of Service</th><th>Note Status</th></tr></thead>
                <tbody>
                    <tr><td><a href="#" data-note-id="7733">7733</a></td><td>Fay Blackwell</td><td>John Manager 1</td><td>Care Coordination</td><td>02/09/2025</td><td>Draft</td></tr>
                    <tr><td><a href="#" data-note-id="7732">7732</a></td><td>Jeffrey King</td><td>John Manager 1</td><td>Care Coordination</td><td>02/09/2025</td><td>Draft</td></tr>
                </tbody>
            </table>
            <div class="pagination"><span>Page <strong>1</strong> of <strong>192</strong></span></div>
        </div>
    </div>
`;
        
        // --- Sidebar Navigation Click Handlers ---
        document.getElementById('navServiceNotes').addEventListener('click', (event) => {
            event.preventDefault();
            document.getElementById('pageContainer').innerHTML = serviceNotesViewHTML;
            updateBreadcrumbs("Home > Service Notes");
            updateActiveNavItem('navServiceNotes');
        });

        document.getElementById('navMembers').addEventListener('click', (event) => {
            event.preventDefault();
            
            // Loads the blank table structure
            document.getElementById('pageContainer').innerHTML = membersListingViewHTML;
            
            updateBreadcrumbs("Home > Members");
            updateActiveNavItem('navMembers');

            // CORRECTED: Now calls your actual function to fill the table with data
            setTimeout(() => {
                // Make sure 'membersData' is available here
                renderMemberList(membersDB);
            }, 0);
        })

       // --- Initial Page Setup ---
        initializeMembersViewListeners(); 

        // All other initial event listeners that only need to be set once
        const sidebar = document.getElementById('sidebar');
        
        const userProfileBtn = document.getElementById('userProfileBtn');
        const userDropdown = document.getElementById('userDropdown');

        if (userProfileBtn && userDropdown) {
            userProfileBtn.addEventListener('click', function(event) {
                event.preventDefault();
                event.stopPropagation();
                userDropdown.classList.toggle('show');
            });
        }
        
        if (typeof RecentItemsManager !== 'undefined') {
            RecentItemsManager.init();
        }

        // Global click listener to close popups
        window.addEventListener('click', function(event) {
            const userDropdown = document.getElementById('userDropdown');
            const userProfileBtn = document.getElementById('userProfileBtn');
            const recentDropdown = document.getElementById('recentItemsDropdown');
            const recentBtn = document.getElementById('recentItemsBtn');
            
            // Close user dropdown if clicking outside
            if (userDropdown && userProfileBtn && !userProfileBtn.contains(event.target) && !userDropdown.contains(event.target)) {
                userDropdown.classList.remove('show');
            }
            
            // Close recent dropdown if clicking outside
            if (recentDropdown && recentBtn && !recentBtn.contains(event.target) && !recentDropdown.contains(event.target)) {
                recentDropdown.classList.remove('show');
            }
        });
    });
        

        function goToADT() {
            alert('Navigate to ADT Events page');
        }

        function goToBioPhyscho() {
            alert('Navigate to Bio/Psycho/Social tab');
        }

        function goToCarePlan() {
            alert('Navigate to Care Plan tab');
        }

        function toggleNotifications() {
            const drawer = document.getElementById('notificationDrawer');
            if(drawer) drawer.classList.toggle('open');
        }

        function markAsRead(item) {
            item.classList.remove('unread');
            updateNotificationCount();
        }

        function updateNotificationCount() {
            const unreadCount = document.querySelectorAll('.notification-item.unread').length;
            const countElement = document.getElementById('notificationCount');
           
            if (unreadCount === 0) {
                countElement.style.display = 'none';
            } else {
                countElement.style.display = 'flex';
                countElement.textContent = unreadCount;
            }
        }

        function goToMemberConsent(memberId) {
            // Navigate to specific member's consent tab
            window.location.href = `/members/${memberId}/consent`;
        }

        function goToMemberADT(memberId) {
            // Navigate to specific member's ADT events
            window.location.href = `/members/${memberId}/adt-events`;
        }

        function goToMemberBioPhyscho(memberId) {
            // Navigate to specific member's Bio/Psycho/Social tab
            window.location.href = `/members/${memberId}/bio-psycho-social`;
        }

        function goToMemberCarePlan(memberId) {
            // Navigate to specific member's Care Plan
            window.location.href = `/members/${memberId}/care-plan`;
        }

        function goToMemberReferrals(memberId) {
            // Navigate to specific member's referrals
            window.location.href = `/members/${memberId}/referrals`;
        }

        function goToMemberAssessment(memberId) {
            // Navigate to specific member's assessment
            window.location.href = `/members/${memberId}/assessment`;
        }

        function goToMemberContact(memberId) {
            // Navigate to update member contact info
            window.location.href = `/members/${memberId}/contact`;
        }

// --- ADD THIS ENTIRE BLOCK FOR RECENT ACTIVITY NAVIGATION ---
        document.body.addEventListener('click', function(event) {


            // Check if the clicked element is our new breadcrumb link
            if (event.target.id === 'breadcrumbMembersLink') {
                event.preventDefault(); // Prevent the link from navigating anywhere
                
                // Find the main "Members" link in the sidebar and programmatically click it.
                // This reuses your existing code for loading the members table view.
                const membersSidebarLink = document.getElementById('navMembers');
                if (membersSidebarLink) {
                    membersSidebarLink.click();
                }
            }
            // This handles clicks on individual recent items in the dropdown or the full page list
            const recentItemLink = event.target.closest('a[data-item-id]');
            if (recentItemLink) {
                event.preventDefault(); // Stop the default '#' link behavior
                const itemId = recentItemLink.dataset.itemId;
                if (!itemId) return;

                // Find the corresponding original navigation link in the sidebar
                const targetNavLink = document.getElementById(itemId);

                if (targetNavLink) {
                    console.log(`Programmatically clicking sidebar link: #${itemId}`);
                    targetNavLink.click(); // This triggers your existing, working navigation logic

                    // If the click came from the header dropdown, close it
                    const recentDropdown = document.getElementById('recentItemsDropdown');
                    if (recentDropdown && recentDropdown.contains(recentItemLink)) {
                        recentDropdown.classList.remove('show');
                    }
                } else {
                    console.warn(`Could not find a sidebar navigation element with ID: ${itemId}`);
                }
                return; // Stop further execution
            }

            // This specifically handles the "View All Activity" link in the dropdown footer
            const viewAllLink = event.target.closest('#viewAllActivityLink');
            if (viewAllLink) {
                event.preventDefault();
                const recentActivityNavLink = document.getElementById('navRecentActivity');
                if (recentActivityNavLink) {
                    recentActivityNavLink.click(); // Clicks the main "Recent Activity" sidebar icon
                }
                // Close the dropdown after navigating
                const recentDropdown = document.getElementById('recentItemsDropdown');
                if (recentDropdown) {
                    recentDropdown.classList.remove('show');
                }
            }
        });
        // --- END OF BLOCK TO ADD ---


        function handleConfigSearch() {
            const input = document.getElementById('configDrawerSearch');
            const filter = input.value.toLowerCase();
            const categories = document.querySelectorAll('#configCategories .config-category');

            categories.forEach(category => {
                const header = category.querySelector('.config-category-header');
                const items = category.querySelectorAll('.config-item, .config-subcategory');
                let categoryHasVisibleItem = false;

                // First, filter the items within the category
                items.forEach(item => {
                    const text = item.textContent.toLowerCase();
                    if (text.includes(filter)) {
                        item.style.display = 'flex'; // Or 'block' if that's the default
                        categoryHasVisibleItem = true;
                    } else {
                        item.style.display = 'none';
                    }
                });

                // Now, decide if the category itself should be visible
                const headerText = header.textContent.toLowerCase();
                if (categoryHasVisibleItem || headerText.includes(filter)) {
                    category.style.display = 'block';
                    // If there's a search term, expand the category to show the results
                    if (filter.length > 0) {
                        category.classList.add('open');
                        header.classList.add('active');
                    } else {
                        // If the search is cleared, collapse the category
                        category.classList.remove('open');
                        header.classList.remove('active');
                    }
                } else {
                    category.style.display = 'none';
                }
            });
        }

        // === NEW JAVASCRIPT FOR SIDEBAR ===
        document.addEventListener('DOMContentLoaded', function() {
            // --- 1. VARIABLE DECLARATIONS ---
            const sidebar = document.getElementById('sidebar');
            const toggleBtn = document.getElementById('toggleSidebarBtn');
            const accordionToggles = document.querySelectorAll('.accordion-toggle');
            const flyoutMenu = document.getElementById('flyoutMenu');
            const tabs = document.querySelectorAll('.tab');
            const tabContentContainer = document.querySelector('.tab-content');
            document.getElementById('configDrawerSearch').addEventListener('keyup', handleConfigSearch);

            // --- 2. TAB CONTENT STORAGE ---
            const dashboardContent = `
                <div class="dashboard-grid">
                   <div class="dashboard-widget">
                    <div class="widget-header">
                        <h3 class="widget-title">ADTs(6)</h3>
                    </div>
                    <div class="widget-content scrollable">
                        <table class="dashboard-table">
                            <thead>
                                <tr>
                                    <th>Event Date</th>
                                    <th>Event Type</th>
                                    <th>Facility</th>
                                    <th>Diagnosis</th>
                                    <th>Acknowledged</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>12/3/2024<br>11:51 AM</td>
                                    <td><a href="#">PC3</a></td>
                                    <td>-</td>
                                    <td>-</td>
                                    <td>No</td>
                                </tr>
                                <tr>
                                    <td>12/3/2024<br>11:49 AM</td>
                                    <td><a href="#">PC2</a></td>
                                    <td>-</td>
                                    <td>-</td>
                                    <td>No</td>
                                </tr>
                                <tr>
                                    <td>12/3/2024<br>11:46 AM</td>
                                    <td><a href="#">PC1</a></td>
                                    <td>-</td>
                                    <td>-</td>
                                    <td>No</td>
                                </tr>
                                <tr>
                                    <td>10/28/2024<br>10:36 PM</td>
                                    <td><a href="#">A26</a></td>
                                    <td>HYRMC</td>
                                    <td>S3217XS - Hairline fracture on femur</td>
                                    <td>No</td>
                                </tr>
                                <tr>
                                    <td>10/25/2024<br>08:15 AM</td>
                                    <td><a href="#">D45</a></td>
                                    <td>HYRMC</td>
                                    <td>-</td>
                                    <td>Yes</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <div class="dashboard-widget">
                    <div class="widget-header">
                        <h3 class="widget-title">
                            <a href="#" id="recentActivityTitleLink" style="color: inherit; text-decoration: none;" title="Go to Timeline View">Your Recent Activity</a>
                        </h3>
                    </div>
                    <div class="widget-content">
                        <ul class="activity-list" id="memberActivityList">
                            </ul>
                    </div>
                </div>
                <div class="dashboard-widget">
                    <div class="widget-header">
                        <h3 class="widget-title">Actions</h3>
                    </div>
                    <div class="widget-content">
                        <div class="actions-list">
                            <a href="#">Create a new Service Note</a>
                            <a href="#">Create a new Appointment</a>
                            <a href="#">Open the Care Plan in a new tab</a>
                            <a href="#">Generate Member Profile</a>
                        </div>
                    </div>
                </div>

                <div class="dashboard-widget">
                    <div class="widget-header dark">
                        <h3 class="widget-title">Tasks (1)</h3>
                    </div>
                    <div class="widget-content">
                        <table class="dashboard-table">
                            <thead>
                                <tr>
                                    <th>Name</th>
                                    <th>Member Name</th>
                                    <th>Medicaid ID</th>
                                    <th>Group</th>
                                    <th>Assignee</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td><a href="#">Test</a></td>
                                    <td>King Loreley</td>
                                    <td>LEAPAug2024DK11</td>
                                    <td>super_admin</td>
                                    <td></td>
                                </tr>
                            </tbody>
                        </table>
                        <div class="pagination">
                            <span>Per Page: <strong>20</strong> &acirc;&frac14;</span>
                            <span>Page <strong>1</strong> of <strong>1</strong></span>
                            <div>
                                <button disabled>&lt;</button>
                                <button disabled>&gt;</button>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="dashboard-widget">
                    <div class="widget-header">
                        <h3 class="widget-title">Upcoming Appointments (0)</h3>
                        <div class="widget-actions">
                            <button class="icon-btn"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M3.5 0a.5.5 0 0 1 .5.5V1h8V.5a.5.5 0 0 1 1 0V1h1a2 2 0 0 1 2 2v11a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2V3a2 2 0 0 1 2-2h1V.5a.5.5 0 0 1 .5-.5zM1 4v10a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1V4H1z"/></svg></button>
                            <button class="icon-btn"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M8 4a.5.5 0 0 1 .5.5v3h3a.5.5 0 0 1 0 1h-3v3a.5.5 0 0 1-1 0v-3h-3a.5.5 0 0 1 0-1h3v-3A.5.5 0 0 1 8 4z"/></svg></button>
                        </div>
                    </div>
                    <div class="widget-content">
                        <div class="info-message">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M8 16A8 8 0 1 0 8 0a8 8 0 0 0 0 16zm.93-9.412-1 4.705c-.07.34.029.533.304.533.194 0 .487-.07.686-.246l-.088.416c-.287.346-.92.598-1.465.598-.703 0-1.002-.422-.808-1.319l.738-3.468c.064-.293.006-.399-.287-.47l-.451-.081.082-.381 2.29-.287zM8 5.5a1 1 0 1 1 0-2 1 1 0 0 1 0 2z"/></svg>
                            There are no Upcoming Appointments for this Member that meet current criteria
                        </div>
                    </div>
                </div>

                <div class="dashboard-widget full-width">
                    <div class="widget-header">
                        <h3 class="widget-title">Open Service Notes (0)</h3>
                    </div>
                    <div class="widget-content">
                        <div class="info-message">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M8 16A8 8 0 1 0 8 0a8 8 0 0 0 0 16zm.93-9.412-1 4.705c-.07.34.029.533.304.533.194 0 .487-.07.686-.246l-.088.416c-.287.346-.92.598-1.465.598-.703 0-1.002-.422-.808-1.319l.738-3.468c.064-.293.006-.399-.287-.47l-.451-.081.082-.381 2.29-.287zM8 5.5a1 1 0 1 1 0-2 1 1 0 0 1 0 2z"/></svg>
                            There are no records that meet current criteria
                        </div>
                    </div>
                </div>

                <div class="dashboard-widget full-width vertical-tabs-widget">
                    <div class="widget-header">
                        <h3 class="widget-title">Care Gaps</h3>
                    </div>
                    <div class="widget-content">
                        <div class="vertical-tabs-container">
                            <div class="vertical-tabs-nav">
                                <div class="vertical-tab active">NEEDS DUE (1)</div>
                                <div class="vertical-tab">GOALS DUE (1)</div>
                                <div class="vertical-tab">IDENTIFIED NEEDS NOT IN CARE PLAN (1)</div>
                            </div>
                            <div class="vertical-tabs-content">
                                <div class="tab-pane-header">
                                    <h4>Needs Due (1)</h4>
                                    <div class="search-filter-area">
                                        <div class="search-box">
                                            <input type="text" placeholder="Search by Need Name">
                                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M11.742 10.344a6.5 6.5 0 1 0-1.397 1.398h-.001c.03.04.062.078.098.115l3.85 3.85a1 1 0 0 0 1.415-1.414l-3.85-3.85a1.007 1.007 0 0 0-.115-.1zM12 6.5a5.5 5.5 0 1 1-11 0 5.5 5.5 0 0 1 11 0z"/></svg>
                                        </div>
                                        <button class="filter-btn">Filter</button>
                                        <button class="clear-btn">Clear Filters</button>
                                    </div>
                                </div>
                                <div class="filters-area">
                                    <span>Active Filters:</span>
                                    <div class="filter-tag">Days Due: 30 <button>&times;</button></div>
                                    <div class="filter-tag">Need Status: Planned, Active <button>&times;</button></div>
                                </div>
                                <table class="dashboard-table">
                                    <thead>
                                        <tr>
                                            <th>Member</th>
                                            <th>Need ID</th>
                                            <th>Need Name</th>
                                            <th>Target Date</th>
                                            <th>Days Due &acirc;</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                            <td><a href="#">King Loreley</a></td>
                                            <td>1</td>
                                            <td><a href="#">Needs help understanding healthcare instructions from doctors</a></td>
                                            <td>3/31/2025</td>
                                            <td>-147</td>
                                        </tr>
                                    </tbody>
                                </table>
                                <div class="pagination">
                                    <span>Per Page: <strong>10</strong> &acirc;&frac14;</span>
                                    <span>Page <strong>1</strong> of <strong>1</strong></span>
                                    <div>
                                        <button disabled>&lt;</button>
                                        <button disabled>&gt;</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="dashboard-widget full-width vertical-tabs-widget">
                    <div class="widget-header">
                        <h3 class="widget-title">Reference Center</h3>
                    </div>
                    <div class="widget-content">
                        <div class="vertical-tabs-container">
                            <div class="vertical-tabs-nav">
                                <div class="vertical-tab active">DIAGNOSES</div>
                                <div class="vertical-tab">CORE HEALTH INDICATORS</div>
                                <div class="vertical-tab">NEEDS</div>
                            </div>
                            <div class="vertical-tabs-content">
                                <div class="tab-pane-header">
                                    <h4>Diagnoses (0)</h4>
                                    <div class="widget-actions">
                                        <button class="icon-btn"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M8 4a.5.5 0 0 1 .5.5v3h3a.5.5 0 0 1 0 1h-3v3a.5.5 0 0 1-1 0v-3h-3a.5.5 0 0 1 0-1h3v-3A.5.5 0 0 1 8 4z"/></svg></button>
                                    </div>
                                </div>
                                <div class="info-message">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M8 16A8 8 0 1 0 8 0a8 8 0 0 0 0 16zm.93-9.412-1 4.705c-.07.34.029.533.304.533.194 0 .487-.07.686-.246l-.088.416c-.287.346-.92.598-1.465.598-.703 0-1.002-.422-.808-1.319l.738-3.468c.064-.293.006-.399-.287-.47l-.451-.081.082-.381 2.29-.287zM8 5.5a1 1 0 1 1 0-2 1 1 0 0 1 0 2z"/></svg>
                                    There are no Diagnoses for this Member that meet current criteria
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                </div>`;

            const detailsContent = `
            <div class="member-details-form">
                <div class="form-section"><h3 class="section-title">Identity</h3><div class="form-grid cols-4"><div class="form-field"><label>First Name *</label><input type="text" value="King" disabled></div><div class="form-field"><label>MRN</label><input type="text" value="MRN67556" disabled></div><div class="form-field"><label>Middle Name</label><input type="text" value="K" disabled></div><div class="form-field"><label>Medicaid ID</label><input type="text" value="LEAPAug2024DK11" disabled></div><div class="form-field"><label>Last Name *</label><input type="text" value="Loreley" disabled></div><div class="form-field"><label>DOB</label><input type="text" value="03/12/2001" disabled></div><div class="form-field"><label>Preferred Name</label><input type="text" value="Loree" disabled></div><div class="form-field"><label>DOD</label><input type="text" value="06/01/2024" disabled></div><div class="form-field"><label>Age</label><input type="text" value="24" disabled></div><div class="form-field"><label>Member Status</label><select disabled><option>OnHold</option></select></div><div class="form-field"><label>SSN</label><input type="text" value="***-**-****" disabled></div><div class="form-field"><label>Care Manager</label><input type="text" value="John Manager 12" disabled></div><div class="form-field"><label>CMA Start Date</label><input type="text" value="3/1/2024" disabled></div><div class="form-field"><label>CMA End Date</label><input type="text" value="12/31/2025" disabled></div></div></div>
                <div class="form-section"><div class="section-header"><h3 class="section-title no-border">Diagnoses</h3><button class="btn btn-secondary" disabled>Select Diagnoses From Member Claims</button></div><div class="form-grid cols-4"><div class="form-field col-span-2"><label>Primary Diagnosis</label><input type="text" value="L89.209 - Frailty Diagnosis"></div><div class="form-field col-span-2"><label>Tertiary Diagnosis</label><input type="text" value="S72.031C - Hip Fractures"></div><div class="form-field col-span-2"><label>Secondary Diagnosis</label><input type="text" value="-"></div><div class="form-field col-span-2"><label>Additional Diagnosis</label><input type="text" value="-"></div></div></div>
                <div class="form-section" id="memberConsentOverviewSection"><h3 class="section-title">Member Consent Overview</h3><button class="btn btn-secondary test" onclick="openTestScenarioModal()" style="margin-left: 12px;">Test Scenarios</button><div class="consent-section"><h4 class="consent-subsection-title">Consent Overview</h4><div class="consent-overview-grid"><div class="consent-status-item"><label>Consent Status</label><div class="status-indicator"><span class="status-dot orange"></span><span class="status-text">To Obtain Consent</span></div></div><div class="consent-status-item"><label>Updated On</label><div class="date-display">" 12/25/2023</div></div><div class="consent-status-item"><label>Contact Attempts</label><div class="contact-attempts-link"><a href="#" onclick="showContactHistory()">8</a></div></div></div></div><div class="consent-section"><h4 class="consent-subsection-title">Consent History</h4><div class="consent-history-table"><table><thead><tr><th>Date</th><th>Contact Method</th><th>Contact Outcome</th><th>Contact Attempt</th><th>Status</th><th>User</th></tr></thead><tbody id="consentHistoryTableBody"><tr><td>01/28/2024</td><td>Placed a call</td><td>The call was not answered</td><td>1</td><td><span class="status-indicator"><span class="status-dot orange"></span>To Obtain Consent</span></td><td>John Manager 12</td></tr></tbody></table></div><div class="consent-actions" id="consentActions"><button class="btn-secondary" onclick="openServiceNoteModal('log-contact')">Log Contact for Consent</button><button class="btn-danger" onclick="openServiceNoteModal('opt-out')">Opt Out</button><button class="btn-primary" onclick="openServiceNoteModal('mark-consented')">Mark As Consented</button></div></div></div></div>
                <div class="form-section"><h3 class="section-title">Contact Information</h3><div class="form-grid cols-4"><div class="form-field"><label>Home Phone</label><input type="text" value="343-452-3454"></div><div class="form-field"><label>Street Address</label><input type="text" value="Hoodenee Street"></div><div class="form-field"><label>Cell Phone</label><input type="text" value="323-423-4555"></div><div class="form-field"><label>Line 2</label><input type="text" placeholder="Enter Street Address Information"></div><div class="form-field"><label>Email</label><input type="text" value="Loree2test.com"></div><div class="form-field"><label>City</label><input type="text" value="la"></div><div class="form-field"><label>Preferred Contact Method</label><select><option>Phone</option></select></div><div class="form-field"><label>Zip Code</label><input type="text" value="342542"></div></div></div>
                <div class="form-section"><h3 class="section-title">Communication Method and Languages</h3><div class="form-grid cols-4"><div class="form-field col-span-2"><label>Languages Spoken</label><div class="multi-select-tags"><span>Amharic <button>&times;</button></span><span>German <button>&times;</button></span></div></div><div class="form-field col-span-2"><label>Communication Method</label><select><option>Verbal</option></select></div><div class="form-field col-span-2"><label>Preferred Language *</label><select><option>German</option></select></div></div><h3 class="section-title secondary">Personal Details</h3><div class="form-grid cols-4"><div class="form-field col-span-2"><label>Race</label><div class="multi-select-tags"><span>White or Caucasian <button>&times;</button></span></div></div><div class="form-field col-span-2"><label>Highest Educational Level</label><select><option>Trade or Technical School</option></select></div><div class="form-field col-span-2"><label>Ethnicity</label><div class="multi-select-tags"><span>White <button>&times;</button></span></div></div><div class="form-field col-span-2"><label>Marital Status</label><select><option>Married</option></select></div><div class="form-field col-span-2"><label>Gender at Birth *</label><select><option>Female</option></select></div><div class="form-field col-span-2"><label>Religion</label><select><option>Christian</option></select></div><div class="form-field col-span-2"><label>Gender Identity</label><div class="multi-select-tags"><span>Female <button>&times;</button></span></div></div><div class="form-field col-span-2"><label>Denomination</label><select><option>Anglican</option></select></div></div></div>
                <div class="form-section"><h3 class="section-title">Additional Information</h3><div class="form-field"><label>Additional Information</label><textarea rows="3">Additional information added here</textarea></div></div>
                <div class="form-section"><h3 class="section-title">Security Tags</h3><div class="security-tags-list"><div class="tag-row"><div class="tag-label">OPERATIONS *</div><div class="tag-value"><strong>Tag:</strong> ALL</div><div class="tag-hierarchy"><strong>Tag Hierarchy:</strong> ALL(0)</div></div><div class="tag-row"><div class="tag-label"></div><div class="tag-value"><strong>Tag:</strong> AFS Referral Manager</div><div class="tag-hierarchy"><strong>Tag Hierarchy:</strong> ALL(0), AFS Referral Manager(10)</div></div><div class="tag-row"><div class="tag-label"></div><div class="tag-value"><strong>Tag:</strong> AYN_Referral_Manager</div><div class="tag-hierarchy"><strong>Tag Hierarchy:</strong> ALL(0), AYN_Referral_Manager(20)</div></div></div></div>
                <div class="form-actions"><button class="btn btn-secondary">Back</button><button class="btn btn-secondary">Edit</button><button class="btn btn-primary">Save</button></div>
            </div>`;
           
            const tabContents = {
                dashboard: dashboardContent,
                details: detailsContent,
                timeline: `
                <div class="timeline-view">
                    <div class="timeline-controls">
                        <div class="timeline-filters">
                            <div class="filter-item">
                                <label class="filter-label">From:</label>
                                <input type="date" class="filter-input" id="timelineStartDate">
                            </div>
                            <div class="filter-item">
                                <label class="filter-label">To:</label>
                                <input type="date" class="filter-input" id="timelineEndDate">
                            </div>
                            <div class="filter-item">
                                <label class="filter-label">Event Type:</label>
                                <select class="filter-select" id="timelineEventType">
                                    <option value="all">All Events</option>
                                    <option value="assignment">Assignment</option>
                                    <option value="consent">Consent</option>
                                    <option value="assessment">Assessment</option>
                                    <option value="care-plan">Care Plan</option>
                                    <option value="adt">ADT Events</option>
                                    <option value="appointment">Appointments</option>
                                    <option value="callback">Callbacks</option>
                                    <option value="task">Tasks</option>
                                    <option value="workflow">Workflows</option>
                                    <option value="program">Programs</option>
                                    <option value="billing">Billing</option>
                                </select>
                            </div>
                            <button class="btn btn-secondary" onclick="printTimeline()" style="margin-left: 12px;">
                                <svg style="width:16px;height:16px;margin-right:6px;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a1 1 0 001-1v-4a1 1 0 00-1-1H9a1 1 0 00-1 1v4a1 1 0 001 1zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z"></path>
                                </svg>
                                Print Timeline
                            </button>
                        </div>
                        <div class="timeline-view-controls">
                            <button class="timeline-view-btn active" onclick="switchTimelineView('horizontal')">Timeline</button>
                            <button class="timeline-view-btn" onclick="switchTimelineView('grid')">Grid</button>
                            <button class="timeline-view-btn" onclick="switchTimelineView('list')">List</button>
                        </div>
                    </div>
                    <div class="timeline-container">
                        <!-- Horizontal Timeline View -->
                        <!-- Horizontal Timeline View -->
                <div class="horizontal-timeline" id="horizontalTimelineView">
                    <div class="timeline-track">
                        <div class="timeline-line"></div>
                        <div class="timeline-events" id="timelineEventsContainer">
                            <!-- Member Assignment -->
                            <div class="timeline-event" data-date="2024-01-15" data-type="assignment">
                                <div class="event-label">Assignment</div>
                                <div class="event-marker assignment">
                                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" style="width:12px;height:12px;color:white;">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                                    </svg>
                                </div>
                                <div class="event-date">01/15/2024</div>
                                <div class="event-popup">
                                    <div class="event-title">Member Assigned to Organization</div>
                                    <div class="event-meta">Jan 15, 2024 at 09:30 AM  By: Admin User</div>
                                    <p>Member assigned to care team Alpha with high priority status.</p>
                                    <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 12px;">
                                        <span class="event-type-badge assignment">Assignment</span>
                                        <button class="btn btn-primary" style="font-size: 12px; padding: 6px 12px;">View Details</button>
                                    </div>
                                </div>
                            </div>

                            <!-- Initial Task Assignment -->
                            <div class="timeline-event" data-date="2024-01-15" data-type="task">
                                <div class="event-label">Task</div>
                                <div class="event-marker task">
                                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" style="width:12px;height:12px;color:white;">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v6a2 2 0 002 2h6a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4"></path>
                                    </svg>
                                </div>
                                <div class="event-date">01/15/2024</div>
                                <div class="event-popup">
                                    <div class="event-title">Initial Contact Task Created</div>
                                    <div class="event-meta">Jan 15, 2024 at 10:00 AM  By: System</div>
                                    <p>Automated task created for initial member outreach within 24 hours.</p>
                                    <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 12px;">
                                        <span class="event-type-badge task">Task</span>
                                        <button class="btn btn-primary" style="font-size: 12px; padding: 6px 12px;">View Details</button>
                                    </div>
                                </div>
                            </div>

                            <!-- Workflow Initiated -->
                            <div class="timeline-event" data-date="2024-01-15" data-type="workflow">
                                <div class="event-label">Workflow</div>
                                <div class="event-marker workflow">
                                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" style="width:12px;height:12px;color:white;">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                                    </svg>
                                </div>
                                <div class="event-date">01/15/2024</div>
                                <div class="event-popup">
                                    <div class="event-title">Onboarding Workflow Initiated</div>
                                    <div class="event-meta">Jan 15, 2024 at 10:15 AM  By: System</div>
                                    <p>Automated onboarding workflow started - includes consent collection, assessment scheduling.</p>
                                    <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 12px;">
                                        <span class="event-type-badge workflow">Workflow</span>
                                        <button class="btn btn-primary" style="font-size: 12px; padding: 6px 12px;">View Details</button>
                                    </div>
                                </div>
                            </div>

                            <!-- Initial Consent -->
                            <div class="timeline-event" data-date="2024-01-16" data-type="consent">
                                <div class="event-label">Consent</div>
                                <div class="event-marker consent">
                                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" style="width:12px;height:12px;color:white;">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                    </svg>
                                </div>
                                <div class="event-date">01/16/2024</div>
                                <div class="event-popup">
                                    <div class="event-title">Consent Forms Completed</div>
                                    <div class="event-meta">Jan 16, 2024 at 02:15 PM  By: King Loreley</div>
                                    <p>HIPAA, treatment consent, and data sharing agreements signed.</p>
                                    <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 12px;">
                                        <span class="event-type-badge consent">Consent</span>
                                        <button class="btn btn-primary" style="font-size: 12px; padding: 6px 12px;">View Details</button>
                                    </div>
                                </div>
                            </div>

                            <!-- Assessment Scheduled -->
                            <div class="timeline-event" data-date="2024-01-17" data-type="appointment">
                                <div class="event-label">Appointment</div>
                                <div class="event-marker appointment">
                                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" style="width:12px;height:12px;color:white;">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                                    </svg>
                                </div>
                                <div class="event-date">01/17/2024</div>
                                <div class="event-popup">
                                    <div class="event-title">Assessment Appointment Scheduled</div>
                                    <div class="event-meta">Jan 17, 2024 at 11:00 AM  By: Care Coordinator</div>
                                    <p>Comprehensive health assessment appointment scheduled for Jan 18th.</p>
                                    <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 12px;">
                                        <span class="event-type-badge appointment">Appointment</span>
                                        <button class="btn btn-primary" style="font-size: 12px; padding: 6px 12px;">View Details</button>
                                    </div>
                                </div>
                            </div>

                            <!-- Assessment Completed -->
                            <div class="timeline-event" data-date="2024-01-18" data-type="assessment">
                                <div class="event-label">Assessment</div>
                                <div class="event-marker assessment">
                                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" style="width:12px;height:12px;color:white;">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v6a2 2 0 002 2h6a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path>
                                    </svg>
                                </div>
                                <div class="event-date">01/18/2024</div>
                                <div class="event-popup">
                                    <div class="event-title">Comprehensive Health Assessment</div>
                                    <div class="event-meta">Jan 18, 2024 at 10:00 AM  By: Dr. Smith</div>
                                    <p>Initial health assessment completed with risk stratification. Member identified as high-risk diabetes.</p>
                                    <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 12px;">
                                        <span class="event-type-badge assessment">Assessment</span>
                                        <button class="btn btn-primary" style="font-size: 12px; padding: 6px 12px;">View Details</button>
                                    </div>
                                </div>
                            </div>

                            <!-- Care Plan Development -->
                            <div class="timeline-event" data-date="2024-01-20" data-type="care-plan">
                                <div class="event-label">Care Plan</div>
                                <div class="event-marker care-plan">
                                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" style="width:12px;height:12px;color:white;">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"></path>
                                    </svg>
                                </div>
                                <div class="event-date">01/20/2024</div>
                                <div class="event-popup">
                                    <div class="event-title">Initial Care Plan Created</div>
                                    <div class="event-meta">Jan 20, 2024 at 03:45 PM  By: Care Manager Jones</div>
                                    <p>Comprehensive care plan developed with 6 interventions focusing on diabetes management and lifestyle modifications.</p>
                                    <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 12px;">
                                        <span class="event-type-badge care-plan">Care Plan</span>
                                        <button class="btn btn-primary" style="font-size: 12px; padding: 6px 12px;">View Details</button>
                                    </div>
                                </div>
                            </div>

                            <!-- Program Enrollment -->
                            <div class="timeline-event" data-date="2024-01-25" data-type="program">
                                <div class="event-label">Program</div>
                                <div class="event-marker program">
                                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" style="width:12px;height:12px;color:white;">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197m13.5-9a2.5 2.5 0 11-5 0 2.5 2.5 0 015 0z"></path>
                                    </svg>
                                </div>
                                <div class="event-date">01/25/2024</div>
                                <div class="event-popup">
                                    <div class="event-title">Diabetes Management Program Enrollment</div>
                                    <div class="event-meta">Jan 25, 2024 at 11:20 AM  By: Program Coordinator</div>
                                    <p>Enrolled in specialized diabetes management program with weekly monitoring.</p>
                                    <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 12px;">
                                        <span class="event-type-badge program">Program</span>
                                        <button class="btn btn-primary" style="font-size: 12px; padding: 6px 12px;">View Details</button>
                                    </div>
                                </div>
                            </div>

                            <!-- Follow-up Callback -->
                            <div class="timeline-event" data-date="2024-02-01" data-type="callback">
                                <div class="event-label">Callback</div>
                                <div class="event-marker callback">
                                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" style="width:12px;height:12px;color:white;">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"></path>
                                    </svg>
                                </div>
                                <div class="event-date">02/01/2024</div>
                                <div class="event-popup">
                                    <div class="event-title">Follow-up Wellness Check</div>
                                    <div class="event-meta">Feb 1, 2024 at 02:30 PM  By: Care Coordinator</div>
                                    <p>Routine follow-up call to check medication adherence and overall wellness.</p>
                                    <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 12px;">
                                        <span class="event-type-badge callback">Callback</span>
                                        <button class="btn btn-primary" style="font-size: 12px; padding: 6px 12px;">View Details</button>
                                    </div>
                                </div>
                            </div>

                            <!-- ADT Event -->
                            <div class="timeline-event" data-date="2024-02-10" data-type="adt">
                                <div class="event-label">ADT Event</div>
                                <div class="event-marker adt">
                                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" style="width:12px;height:12px;color:white;">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1"></path>
                                    </svg>
                                </div>
                                <div class="event-date">02/10/2024</div>
                                <div class="event-popup">
                                    <div class="event-title">Emergency Room Visit</div>
                                    <div class="event-meta">Feb 10, 2024 at 06:30 PM  By: System Integration</div>
                                    <p>ED visit for chest pain - admitted for observation. Care team notified immediately.</p>
                                    <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 12px;">
                                        <span class="event-type-badge adt">ADT Event</span>
                                        <button class="btn btn-primary" style="font-size: 12px; padding: 6px 12px;">View Details</button>
                                    </div>
                                </div>
                            </div>

                            <!-- Hospital Discharge -->
                            <div class="timeline-event" data-date="2024-02-12" data-type="adt">
                                <div class="event-label">ADT Event</div>
                                <div class="event-marker adt">
                                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" style="width:12px;height:12px;color:white;">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path>
                                    </svg>
                                </div>
                                <div class="event-date">02/12/2024</div>
                                <div class="event-popup">
                                    <div class="event-title">Hospital Discharge</div>
                                    <div class="event-meta">Feb 12, 2024 at 02:00 PM  By: System Integration</div>
                                    <p>Discharged to home with follow-up instructions and medication changes.</p>
                                    <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 12px;">
                                        <span class="event-type-badge adt">ADT Event</span>
                                        <button class="btn btn-primary" style="font-size: 12px; padding: 6px 12px;">View Details</button>
                                    </div>
                                </div>
                            </div>

                            <!-- Member Opts Out (Consent Withdrawn) -->
                            <div class="timeline-event" data-date="2024-05-15" data-type="consent">
                                <div class="event-label">Consent</div>
                                <div class="event-marker" style="background: #ef4444;">
                                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" style="width:12px;height:12px;color:white;">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                    </svg>
                                </div>
                                <div class="event-date">05/15/2024</div>
                                <div class="event-popup">
                                    <div class="event-title">Member Opted Out</div>
                                    <div class="event-meta">May 15, 2024 at 01:20 PM  By: King Loreley</div>
                                    <p>Member withdrew consent for care management services. All active interventions suspended.</p>
                                    <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 12px;">
                                        <span class="event-type-badge" style="background: #fee2e2; color: #dc2626;">Consent Withdrawn</span>
                                        <button class="btn btn-primary" style="font-size: 12px; padding: 6px 12px;">View Details</button>
                                    </div>
                                </div>
                            </div>

                            <!-- Workflow Suspended -->
                            <div class="timeline-event" data-date="2024-05-15" data-type="workflow">
                                <div class="event-label">Workflow</div>
                                <div class="event-marker" style="background: #94a3b8;">
                                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" style="width:12px;height:12px;color:white;">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 9v6m4-6v6m7-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                    </svg>
                                </div>
                                <div class="event-date">05/15/2024</div>
                                <div class="event-popup">
                                    <div class="event-title">Care Management Workflow Suspended</div>
                                    <div class="event-meta">May 15, 2024 at 01:25 PM  By: System</div>
                                    <p>All active workflows and tasks suspended due to consent withdrawal.</p>
                                    <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 12px;">
                                        <span class="event-type-badge" style="background: #f1f5f9; color: #64748b;">Workflow Suspended</span>
                                        <button class="btn btn-primary" style="font-size: 12px; padding: 6px 12px;">View Details</button>
                                    </div>
                                </div>
                            </div>

                            <!-- Member Re-consents -->
                            <div class="timeline-event" data-date="2024-08-20" data-type="consent">
                                <div class="event-label">Consent</div>
                                <div class="event-marker consent">
                                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" style="width:12px;height:12px;color:white;">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                    </svg>
                                </div>
                                <div class="event-date">08/20/2024</div>
                                <div class="event-popup">
                                    <div class="event-title">Member Re-consented</div>
                                    <div class="event-meta">Aug 20, 2024 at 10:45 AM  By: King Loreley</div>
                                    <p>Member provided consent again for care management services. Reactivation process initiated.</p>
                                    <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 12px;">
                                        <span class="event-type-badge consent">Consent</span>
                                        <button class="btn btn-primary" style="font-size: 12px; padding: 6px 12px;">View Details</button>
                                    </div>
                                </div>
                            </div>

                            <!-- Workflow Reactivated -->
                            <div class="timeline-event" data-date="2024-08-20" data-type="workflow">
                                <div class="event-label">Workflow</div>
                                <div class="event-marker workflow">
                                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" style="width:12px;height:12px;color:white;">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                                    </svg>
                                </div>
                                <div class="event-date">08/20/2024</div>
                                <div class="event-popup">
                                    <div class="event-title">Care Management Reactivated</div>
                                    <div class="event-meta">Aug 20, 2024 at 11:00 AM  By: System</div>
                                    <p>Care management workflows reactivated. Updated assessment scheduled.</p>
                                    <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 12px;">
                                        <span class="event-type-badge workflow">Workflow</span>
                                        <button class="btn btn-primary" style="font-size: 12px; padding: 6px 12px;">View Details</button>
                                    </div>
                                </div>
                            </div>

                            <!-- Recent Task -->
                            <div class="timeline-event" data-date="2024-08-25" data-type="task">
                                <div class="event-label">Task</div>
                                <div class="event-marker task">
                                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" style="width:12px;height:12px;color:white;">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v6a2 2 0 002 2h6a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"></path>
                                    </svg>
                                </div>
                                <div class="event-date">08/25/2024</div>
                                <div class="event-popup">
                                    <div class="event-title">Reassessment Task Created</div>
                                    <div class="event-meta">Aug 25, 2024 at 09:15 AM  By: Care Manager</div>
                                    <p>Task created for comprehensive reassessment following consent reactivation.</p>
                                    <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 12px;">
                                        <span class="event-type-badge task">Task</span>
                                        <button class="btn btn-primary" style="font-size: 12px; padding: 6px 12px;">View Details</button>
                                    </div>
                                </div>
                            </div>

                            <!-- Recent Callback -->
                            <div class="timeline-event" data-date="2024-08-30" data-type="callback">
                                <div class="event-label">Callback</div>
                                <div class="event-marker callback">
                                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" style="width:12px;height:12px;color:white;">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"></path>
                                    </svg>
                                </div>
                                <div class="event-date">08/30/2024</div>
                                <div class="event-popup">
                                    <div class="event-title">Follow-up Call Scheduled</div>
                                    <div class="event-meta">Aug 30, 2024 at 09:47 AM  By: System User</div>
                                    <p>Real-time event update - Follow-up call scheduled to check on member status.</p>
                                    <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 12px;">
                                        <span class="event-type-badge callback">Callback</span>
                                        <button class="btn btn-primary" style="font-size: 12px; padding: 6px 12px;">View Details</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- Grid View -->
                    <div class="grid-timeline" id="gridTimelineView">
                        <div class="events-grid" id="eventsGridContainer">
                            <!-- Grid events will be populated by JavaScript -->
                        </div>
                    </div>
                   
                    <!-- List View -->
                    <div class="list-timeline" id="listTimelineView">
                        <div class="events-list" id="eventsListContainer">
                            <!-- List events will be populated by JavaScript -->
                        </div>
                    </div>
                </div>
            </div>`,
                insurance: `<div class="content-placeholder"><h3>Insurance Information</h3><p>Content for this tab is not yet built.</p></div>`,
                screenings: `''`,
                'bio-psycho': '',
                history: '', 
                population: '<div class="content-placeholder"><h3>Population Insights</h3><p>Content for this tab is not yet built.</p></div>',
                activity: '<div class="content-placeholder"><h3>Activity History</h3><p>Content for this tab is not yet built.</p></div>',
                careteam: '<div class="content-placeholder"><h3>Care Team</h3><p>Content for this tab is not yet built.</p></div>',
                careplans: '<div class="content-placeholder"><h3>Care Plans</h3><p>Content for this tab is not yet built.</p></div>'
            };
           

// DISABLED:             // --- 3. TAB CLICK HANDLING (NEW LOGIC) ---
// DISABLED:             // Update the existing tab click handling to include button updates
// DISABLED:             // --- 3. TAB CLICK HANDLING (MODIFIED LOGIC) ---
// DISABLED:             tabs.forEach(tab => {
// DISABLED:                 tab.addEventListener('click', () => {
// DISABLED:                     tabs.forEach(t => t.classList.remove('active'));
// DISABLED:                     tab.classList.add('active');
// DISABLED:                     const tabKey = tab.dataset.tab;
// DISABLED:                     if (tabContentContainer) {
// DISABLED:                         // 1. Re-render the tab content as before
// DISABLED:                         tabContentContainer.innerHTML = tabContents[tabKey];
// DISABLED: 
// DISABLED:                         // 2. ADDED: Re-apply the Line of Business visibility rules immediately after rendering
// DISABLED:                         // This ensures the consent section stays hidden if AMH is selected.
// DISABLED:                         const lobSelect = document.getElementById('lobSwitch');
// DISABLED:                         if (lobSelect) {
// DISABLED:                             switchLineOfBusiness(lobSelect);
// DISABLED:                         }
// DISABLED:                        
// DISABLED:                         // 3. Keep the rest of the original logic
// DISABLED:                         if (tabKey === 'details') {
// DISABLED:                             requestAnimationFrame(() => {
// DISABLED:                                 setTimeout(() => {
// DISABLED:                                     const actionsContainer = document.getElementById('consentActions');
// DISABLED:                                     if (actionsContainer) {
// DISABLED:                                         if (window.pendingConsentStatus) {
// DISABLED:                                             updateConsentActionButtons(window.pendingConsentStatus);
// DISABLED:                                             window.pendingConsentStatus = null;
// DISABLED:                                         } else {
// DISABLED:                                             const currentStatus = getCurrentConsentStatus();
// DISABLED:                                             updateConsentActionButtons(currentStatus);
// DISABLED:                                         }
// DISABLED:                                     }
// DISABLED:                                 }, 50);
// DISABLED:                             });
// DISABLED:                         }
// DISABLED:                     }
// DISABLED:                    
// DISABLED:                     if (tabKey === 'timeline') {
// DISABLED:                         setTimeout(() => {
// DISABLED:                             initializeTimelineFilters();
// DISABLED:                         }, 100);
// DISABLED:                     }
// DISABLED:                 });
// DISABLED:             });
// DISABLED:             // Set initial content on page load
// DISABLED:             if (tabContentContainer) {
// DISABLED:                  tabContentContainer.innerHTML = tabContents.dashboard;
// DISABLED:             }

            // --- 4. SIDEBAR LOGIC (EXISTING) ---
           if (toggleBtn) {
                toggleBtn.addEventListener('click', () => {
                    sidebar.classList.toggle('collapsed');
                    flyoutMenu.classList.remove('show');
                   
                    // Update drawer position if it's open
                    const drawer = document.getElementById('configDrawer');
                    if (drawer && drawer.classList.contains('show')) {
                        if (sidebar.classList.contains('collapsed')) {
                            drawer.classList.add('from-collapsed');
                        } else {
                            drawer.classList.remove('from-collapsed');
                        }
                    }
                });
            }

            accordionToggles.forEach(toggle => {
                const link = toggle.querySelector('.nav-link');
                if (link) {
                    link.addEventListener('click', (e) => {
                        e.preventDefault();
                        e.stopPropagation();

                        const drawer = document.getElementById('configDrawer');
                        const title = toggle.getAttribute('title');
                        
                        // --- New, Unified Drawer Logic ---
                        // This section handles all items that are meant to open a drawer.
                        const isDrawerTrigger = ['Configurations', 'Provider Network', 'Settings', 'Set-up'].includes(title);

                        if (isDrawerTrigger) {
                            // Check if the drawer is already open for the item that was just clicked
                            const isDrawerCurrentlyOpenForThisItem = drawer.classList.contains('show') && drawer.dataset.owner === title;

                            // First, always close any open drawer and remove the 'open' class from all toggles.
                            // This ensures only one can be active at a time.
                            closeConfigDrawer();
                            document.querySelectorAll('.accordion-toggle.open').forEach(t => t.classList.remove('open'));

                            // If we didn't just close the drawer (i.e., it was closed or a different item was open),
                            // then we should open the new one.
                            if (!isDrawerCurrentlyOpenForThisItem) {
                                if (title === 'Configurations') {
                                    openConfigurationDrawer();
                                } else {
                                    openGenericDrawer(title);
                                }
                                toggle.classList.add('open'); // Add class to trigger arrow animation
                                drawer.dataset.owner = title; // Mark which item opened the drawer
                            }
                            return; // Stop execution since we've handled the drawer action
                        }


                        // --- Fallback for other types of accordions (with sub-menus) ---
                        // This is your original logic for handling accordions that are not drawers.
                        if (!sidebar.classList.contains('collapsed')) {
                            const wasOpen = toggle.classList.contains('open');
                            document.querySelectorAll('.accordion-toggle.open').forEach(t => t.classList.remove('open'));
                            if (!wasOpen) {
                                toggle.classList.add('open');
                            }
                        } else {
                            const isCurrentlyOpen = flyoutMenu.classList.contains('show') && flyoutMenu.dataset.owner === toggle.title;
                            flyoutMenu.classList.remove('show');
                            if (isCurrentlyOpen) return;

                            const subMenu = toggle.querySelector('.sub-menu');
                            if (subMenu) {
                                flyoutMenu.innerHTML = subMenu.innerHTML;
                                flyoutMenu.dataset.owner = toggle.title;
                        
                                const iconRect = link.getBoundingClientRect();
                                const windowHeight = window.innerHeight;
                        
                                flyoutMenu.style.visibility = 'hidden';
                                flyoutMenu.classList.add('show');
                                const flyoutHeight = flyoutMenu.offsetHeight;
                                flyoutMenu.classList.remove('show');
                                flyoutMenu.style.visibility = 'visible';

                                let topPosition = iconRect.top;
                                if (topPosition + flyoutHeight > windowHeight) {
                                    topPosition = windowHeight - flyoutHeight - 10;
                                }
                                if (topPosition < 10) {
                                    topPosition = 10;
                                }
                                flyoutMenu.style.top = `${topPosition}px`;
                                flyoutMenu.classList.add('show');
                        
                                const flyoutSearch = flyoutMenu.querySelector('.config-search-input');
                                if (flyoutSearch) {
                                    flyoutSearch.addEventListener('keyup', handleSearch);
                                }
                            }
                        }
                    });
                }
            });

            document.addEventListener('click', function(event) {
                    const flyoutMenu = document.getElementById('flyoutMenu');
                    const configDrawer = document.getElementById('configDrawer');
                    const configOverlay = document.getElementById('configDrawerOverlay');
                   
                    // Close flyout menu
                    if (flyoutMenu && flyoutMenu.classList.contains('show') && !flyoutMenu.contains(event.target) && !event.target.closest('.accordion-toggle')) {
                        flyoutMenu.classList.remove('show');
                    }
                   
                    // Close config drawer if clicking overlay
                    if (configOverlay && event.target === configOverlay) {
                        closeConfigDrawer();
                    }
                });

            const handleSearch = (e) => {
                e.stopPropagation();
                const input = e.target;
                const filter = input.value.toLowerCase();
                const menu = input.closest('.sub-menu, .flyout-menu');
                const items = menu.querySelectorAll('a.nav-item');
                items.forEach(item => {
                    item.style.display = item.textContent.toLowerCase().includes(filter) ? 'flex' : 'none';
                });
            };

            const mainSearchInput = document.getElementById('configSearch');
            if(mainSearchInput) {
                mainSearchInput.addEventListener('keyup', handleSearch);
            }
            updateConsentActionButtons('to-obtain-consent');
        });

        function resetDrawerState() {
            const drawer = document.getElementById('configDrawer');
            const overlay = document.getElementById('configDrawerOverlay');

            // This 'if' check is the fix. It prevents the error if the drawer is not found.
            if (drawer) {
                drawer.classList.remove('show', 'from-collapsed');
                drawer.style.transform = '';
            }

            // This 'if' check is the fix for the overlay.
            if (overlay) {
                overlay.classList.remove('show');
            }

            console.log('Drawer state reset');
        }


        function openConfigurationDrawer() {
            console.log('openConfigurationDrawer called');
           
            const drawer = document.getElementById('configDrawer');
            const overlay = document.getElementById('configDrawerOverlay');
            const drawerTitle = document.querySelector('.config-drawer-title');
            const sidebar = document.getElementById('sidebar');
           
            // Ensure drawer is in reset state first
            drawer.classList.remove('show', 'from-collapsed');
           
            // Force hidden state first
            drawer.style.transform = 'translateX(-100%)';
           
            // Adjust position based on sidebar state
            if (sidebar.classList.contains('collapsed')) {
                drawer.classList.add('from-collapsed');
            }
           
            // Set the title
            if (drawerTitle) {
                drawerTitle.textContent = 'Configuration Settings';
            }
           
            // Show search bar for configurations
            const searchWrapper = document.querySelector('.config-search-wrapper');
            if (searchWrapper) {
                searchWrapper.style.display = 'block';
            }
           
            // Populate content
            populateConfigCategories();
           
            // Force a reflow
            drawer.offsetHeight;
           
            // Remove inline style to let CSS take over, then add show class
            drawer.style.transform = '';
            drawer.classList.add('show');
            overlay.classList.add('show');
           
            console.log('Drawer opened, classes:', drawer.classList.toString());
           
            // Check final transform after a short delay
            setTimeout(() => {
                console.log('Final transform:', window.getComputedStyle(drawer).transform);
            }, 100);
        }

        // Alert Option Toggle and Management
        let isChipMode = false;
        let expandedChip = null;

        function toggleAlertOption() {
            const container = document.getElementById('alertContainer');
            const slider = document.getElementById('sliderWrapper');
            const strip = document.getElementById('alertStrip');
            const toggleText = document.getElementById('toggleButtonText');
           
            if (isChipMode) {
                // Switch to slider
                container.className = 'alert-banner-container option1';
                slider.style.display = 'block';
                strip.classList.remove('active');
                toggleText.textContent = 'Switch to Chips';
                hideAllExpandedAlerts();
                isChipMode = false;
            } else {
                // Switch to chips
                container.className = 'alert-banner-container option2';
                slider.style.display = 'none';
                strip.classList.add('active');
                toggleText.textContent = 'Switch to Slider';
                isChipMode = true;
            }
        }

        function closeExpandedAlert() {
            hideAllExpandedAlerts();
        }

        function goToServiceNote(noteId) {
            // Check the note status and redirect accordingly
            if (noteId.includes('draft')) {
                openServiceNoteModal('view-full', 'full');
            } else {
                // For completed notes, could redirect to a read-only view
                console.log(`Navigate to completed service note: ${noteId}`);
                alert(`Opening service note ${noteId}`);
            }
        }


        function expandAlertChip(index) {
            const chips = document.querySelectorAll('.alert-chip');
            const currentExpanded = document.getElementById(`expandedAlert${index}`);
            const clickedChip = chips[index];
       
            // Mark as read when clicked
            clickedChip.classList.remove('unread');
            clickedChip.classList.add('read');
       
            // If clicking the same chip and it's already expanded, collapse it
            if (expandedChip === index && currentExpanded.classList.contains('show')) {
                clickedChip.classList.remove('expanded');
                currentExpanded.classList.remove('show');
                expandedChip = null;
                return;
            }
       
            // Hide all other expanded alerts
            hideAllExpandedAlerts();
       
            // Show selected alert
            clickedChip.classList.add('expanded');
            currentExpanded.classList.add('show');
            expandedChip = index;
           
            // For service notes chip, you could dynamically load the latest service note info
            if (index === 4) {
                updateServiceNoteContent();
            }
        }


        function updateServiceNoteContent() {
            // This function can dynamically update the service note content
            // based on actual data from your backend
            const serviceNoteContent = document.querySelector('#expandedAlert4 .expanded-text');
           
            // Example of dynamic content - replace with actual data fetching
            const latestNote = {
                status: 'draft',
                date: '08/30/2025',
                type: 'Contact attempt',
                id: 'draft-7733'
            };
           
            if (latestNote.status === 'draft') {
                serviceNoteContent.innerHTML = `
                    <strong>Draft Service Note:</strong> ${latestNote.type} logged on ${latestNote.date} - Follow-up required for consent status update
                `;
            } else {
                serviceNoteContent.innerHTML = `
                    <strong>Completed Service Note:</strong> ${latestNote.type} completed on ${latestNote.date} - Review available
                `;
            }
        }


        // Add function to reset all alerts to unread (for testing)
        function resetAlertsToUnread() {
            document.querySelectorAll('.alert-chip').forEach(chip => {
                chip.classList.remove('read');
                chip.classList.add('unread');
            });
        }
       

        function hideAllExpandedAlerts() {
            document.querySelectorAll('.alert-chip').forEach(chip => chip.classList.remove('expanded'));
            document.querySelectorAll('.alert-expanded-content').forEach(content => content.classList.remove('show'));
            expandedChip = null;
        }

        // Update existing slider functions to remove auto-slide and update counter
        function updateSlider() {
            const slider = document.getElementById('alertSlider');
            if (!slider) return; //  ADD THIS LINE
            slider.style.transform = `translateX(-${currentAlert * 100}%)`;
           
            // Update counter
            const counter = document.getElementById('alertCounter');
            if (counter) {
                counter.textContent = `${currentAlert + 1} of ${totalAlerts}`;
            }
           
            // Update navigation buttons
            const prevBtns = document.querySelectorAll('#prevBtn');
            const nextBtns = document.querySelectorAll('#nextBtn');
           
            prevBtns.forEach(btn => btn.disabled = currentAlert === 0);
            nextBtns.forEach(btn => btn.disabled = currentAlert === totalAlerts - 1);
        }

        // Remove the auto-slide initialization
        function initializeSlider() {
            updateSlider();
            // Removed startAutoSlide() call
        }

       // Member notes functionality
        let memberNotes = {}; // Store notes in memory
        // Removed the hardcoded 'currentMemberId' variable

        let notesTimeout;

        function openMemberNotes() {
            const panel = document.getElementById('notesPanel');
            const overlay = document.getElementById('notesOverlay');
            const textarea = document.getElementById('notesTextArea');
            // Select the specific element that holds the "Member: Name" text
            const memberNameSpan = document.querySelector('.notes-panel .notes-member');
            
            // SAFETY CHECK: Ensure a member is actually selected
            if (!window.currentMember) {
                console.error("No member is currently selected.");
                return;
            }

            // 1. FIX: Dynamically update the name in the header
            if (memberNameSpan) {
                memberNameSpan.textContent = `Member: ${window.currentMember.name}`;
            }
            
            // 2. FIX: Load notes using the CURRENT member's ID as the key
            if (textarea) {
                textarea.value = memberNotes[window.currentMember.id] || '';
            }
            
            // Show panel and overlay
            if (overlay) {
                overlay.classList.add('show');
            }
            if (panel) {
                panel.classList.add('open');
            }
            
            // Focus on textarea
            setTimeout(() => {
                if (textarea) {
                    textarea.focus();
                }
            }, 300);
            
            // Add auto-save listener
            if (textarea) {
                textarea.addEventListener('input', autoSaveNotes);
            }
        }

        function closeMemberNotes() {
            const panel = document.getElementById('notesPanel');
            const overlay = document.getElementById('notesOverlay');
            const textarea = document.getElementById('notesTextArea');
            
            // Save notes before closing
            saveCurrentNotes();
            
            // Hide panel and overlay
            panel.classList.remove('open');
            overlay.classList.remove('show');
            
            // Remove event listener
            if (textarea) {
                textarea.removeEventListener('input', autoSaveNotes);
            }
            
            // Show save confirmation
            showSaveIndicator();
        }

        function autoSaveNotes() {
            // Clear existing timeout
            clearTimeout(notesTimeout);
            
            // Set new timeout for auto-save
            notesTimeout = setTimeout(() => {
                saveCurrentNotes();
                showSaveIndicator();
            }, 1000); // Auto-save after 1 second of inactivity
        }

        function saveCurrentNotes() {
            const textarea = document.getElementById('notesTextArea');
            // 3. FIX: Save using the CURRENT member's ID
            if (window.currentMember && textarea) {
                memberNotes[window.currentMember.id] = textarea.value;
            }
        }

        function showSaveIndicator() {
            const indicator = document.getElementById('saveIndicator');
            if (indicator) {
                indicator.classList.add('show');
                setTimeout(() => {
                    indicator.classList.remove('show');
                }, 2000);
            }
        }

        // Close panel when pressing Escape key
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape') {
                const panel = document.getElementById('notesPanel');
                if (panel.classList.contains('open')) {
                    closeMemberNotes();
                }
            }
        });

        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', initializeSlider);

        // Tab functionality
        document.querySelectorAll('.tab').forEach(tab => {
            tab.addEventListener('click', function() {
                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                this.classList.add('active');
            });
        });

         // Contextual Sidebar functionality

        const contextualSidebar = document.getElementById('contextualSidebar');
        const closeContextualSidebar = document.getElementById('closeContextualSidebar');
        const assessmentContent = document.getElementById('assessmentContent');
        const slidePanel = document.getElementById('slidePanel');
        const overlay = document.getElementById('overlay');
        const addedInfoSummary = document.getElementById('addedInfoSummary');
        const summaryList = document.getElementById('summaryList');


        let isSidebarOpen = false;
        let currentQuickLink = null;
        let addedInformation = [];


        // Toggle contextual sidebar
        

        // Close contextual sidebar
        closeContextualSidebar.addEventListener('click', () => {
            isSidebarOpen = false;
            contextualSidebar.classList.remove('active');
            assessmentContent.classList.remove('sidebar-open');
            contextualTrigger.classList.remove('hidden');
        });

        // Auto-hide trigger when sidebar is open


        // REPLACE WITH THIS FUNCTION:

        function resetSidebarState() {
            isSidebarOpen = false;
            const contextualSidebar = document.getElementById('contextualSidebar');
            // Removed assessmentContent reference as it might not exist in all views
            const slidePanel = document.getElementById('slidePanel');
            const overlay = document.getElementById('overlay');

            if (contextualSidebar) contextualSidebar.classList.remove('active');
            
            // We removed contextualTrigger reference here because the button is deleted
            
            const modal = document.getElementById('customModal');
            if (modal) modal.classList.remove('active');
            
            if (slidePanel) slidePanel.classList.remove('active');
            if (overlay) overlay.classList.remove('active');
        }
        // Quick link content templates (same as original)
        // Quick link content templates - Direct Links Version
        const quickLinkContent = {
            'member-details': {
                title: 'Member Details',
                url: 'https://web.dev.leapmetrics.io/client/c304ce53-ea66-4c8e-aa88-4f6d68663a92/client-details',
                description: 'Update member contact information, demographics, and personal details'
            },
            'diagnosis': {
                title: 'Add New Diagnosis',
                url: 'https://web.dev.leapmetrics.io/client/56aea809-5359-481b-ab0b-06d387ce4bc6/health-history/diagnosis/new',
                description: 'Add diagnosis information with ICD-10 codes and clinical details'
            },
            'medications': {
                title: 'Add New Medication',
                url: 'https://web.dev.leapmetrics.io/client/56aea809-5359-481b-ab0b-06d387ce4bc6/health-history/client-medications/new',
                description: 'Add medication information including dosage, frequency, and prescriber details'
            },
            'care-team': {
                title: 'Add New Care Team Member',
                url: 'https://web.dev.leapmetrics.io/client/56aea809-5359-481b-ab0b-06d387ce4bc6/care-team/members/new',
                description: 'Add care team members with roles and permissions'
            },
            'related-persons': {
                title: 'Add New Related Person',
                url: 'https://web.dev.leapmetrics.io/client/56aea809-5359-481b-ab0b-06d387ce4bc6/care-team/related-persons/new',
                description: 'Add family members and emergency contacts with relationship details'
            },
            'service-notes': {
                title: 'Add New Service Note',
                url: 'https://web.dev.leapmetrics.io/service-notes',
                description: 'Document service activities and interventions'
            }
        };

        // Open slide panel - Updated for direct links
        function openSlidePanel(linkType) {
            const linkData = quickLinkContent[linkType];
           
            if (linkData && linkData.url) {
                // Show confirmation modal with very clear message
                showCustomModal(
                    `Open ${linkData.title}`,
                    `This will open a new tab to add/edit ${linkData.title.toLowerCase()}. You won't lose your current assessment progress.`,
                    () => {
                        // Only open the link if user confirms
                        window.open(linkData.url, '_blank');
                        showSuccessMessage(`${linkData.title} opened in new tab`);
                       
                        // Close sidebar and reset state after opening link
                        setTimeout(() => {
                            resetSidebarState();
                        }, 1000);
                    }
                );
            }
           
            // Close contextual sidebar immediately
            isSidebarOpen = false;
            contextualSidebar.classList.remove('active');
            assessmentContent.classList.remove('sidebar-open');
            contextualTrigger.classList.remove('hidden');
        }

        // Close slide panel
        function closeSlidePanel() {
            slidePanel.classList.remove('active');
            overlay.classList.remove('active');
            currentQuickLink = null;
        }

        // Save quick link data
        function saveQuickLinkData() {
            if (!currentQuickLink) return;
           
            const content = quickLinkContent[currentQuickLink];
            const timestamp = new Date().toLocaleString();
           
            // Add to summary
            addedInformation.push({
                type: content.title,
                timestamp: timestamp,
                linkType: currentQuickLink
            });
           
            updateSummary();
            closeSlidePanel();
           
            // Show success message
            showSuccessMessage(`${content.title} information saved successfully!`);
        }

        // Update summary display
        function updateSummary() {
            // This check is the fix. It prevents the error if the elements are missing.
            if (!addedInfoSummary || !summaryList) {
                return;
            }

            if (addedInformation.length > 0) {
                addedInfoSummary.style.display = 'block';

                summaryList.innerHTML = addedInformation.map(info => `
                    <li class="summary-item">
                        <span class="summary-label">${info.type}</span>
                        <span class="summary-value">Added ${info.timestamp}</span>
                    </li>
                `).join('');
            } else {
                addedInfoSummary.style.display = 'none';
            }
        }

        // Show success message
        function showSuccessMessage(message) {
            const successDiv = document.createElement('div');
            successDiv.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: #28a745;
                color: white;
                padding: 12px 20px;
                border-radius: 6px;
                box-shadow: 0 4px 12px rgba(40, 167, 69, 0.3);
                z-index: 2000;
                font-size: 14px;
                font-weight: 500;
                opacity: 0;
                transform: translateX(100%);
                transition: all 0.3s ease;
            `;
            successDiv.textContent = message;
           
            document.body.appendChild(successDiv);
           
            setTimeout(() => {
                successDiv.style.opacity = '1';
                successDiv.style.transform = 'translateX(0)';
            }, 100);
           
            setTimeout(() => {
                successDiv.style.opacity = '0';
                successDiv.style.transform = 'translateX(100%)';
                setTimeout(() => {
                    document.body.removeChild(successDiv);
                }, 300);
            }, 3000);
        }
        // Show custom modal
        function showCustomModal(title, message, onConfirm) {
            const modal = document.getElementById('customModal');
            const modalTitleText = document.getElementById('modalTitleText');
            const modalMessage = document.getElementById('modalMessage');
            const modalConfirm = document.getElementById('modalConfirm');
            const modalCancel = document.getElementById('modalCancel');
           
            // Set content
            modalTitleText.textContent = title;
            modalMessage.textContent = message;
           
            // Show modal
            modal.classList.add('active');
           
            // Handle confirm
            const handleConfirm = () => {
                modal.classList.remove('active');
                if (onConfirm) onConfirm();
                cleanup();
            };
           
            // Handle cancel
            const handleCancel = () => {
                modal.classList.remove('active');
                cleanup();
            };
           
            // Handle outside click
            const handleOutsideClick = (e) => {
                if (e.target === modal) {
                    handleCancel();
                }
            };
           
            // Handle escape key
            const handleEscape = (e) => {
                if (e.key === 'Escape') {
                    handleCancel();
                }
            };
           
            // Add event listeners
            modalConfirm.addEventListener('click', handleConfirm);
            modalCancel.addEventListener('click', handleCancel);
            modal.addEventListener('click', handleOutsideClick);
            document.addEventListener('keydown', handleEscape);
           
            // Cleanup function
            function cleanup() {
                modalConfirm.removeEventListener('click', handleConfirm);
                modalCancel.removeEventListener('click', handleCancel);
                modal.removeEventListener('click', handleOutsideClick);
                document.removeEventListener('keydown', handleEscape);
            }
        }
        // Close overlay on click
        overlay.addEventListener('click', closeSlidePanel);

        // Handle escape key
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                if (slidePanel.classList.contains('active')) {
                    closeSlidePanel();
                } else if (isSidebarOpen) {
                    closeContextualSidebar.click();
                }
            }
        });

        // Prevent panel from closing when clicking inside
        contextualSidebar.addEventListener('click', (e) => {
            e.stopPropagation();
        });

        slidePanel.addEventListener('click', (e) => {
            e.stopPropagation();
        });

        // Demo: Add some sample data for demonstration
        setTimeout(() => {
            // Simulate user having already added some information
            addedInformation = [
                {
                    type: 'Care Team',
                    timestamp: '7/26/2025, 2:15 PM',
                    linkType: 'care-team'
                }
            ];
            updateSummary();
        }, 2000);
        document.addEventListener('visibilitychange', function() {
            if (!document.hidden) {
                // Page is now visible (user returned)
                resetSidebarState();
            }
        });

        // Reset sidebar state when window regains focus
        window.addEventListener('focus', function() {
            resetSidebarState();
        });

        // Reset sidebar state when page loads
        window.addEventListener('load', function() {
            resetSidebarState();
        });
        // Initialize

        // === ADD THIS JAVASCRIPT FOR GENERAL NOTES FUNCTIONALITY ===

        let generalNotes = ''; // Stores general notes content
        let generalNotesTimeout; // Timer for auto-saving

        function openGeneralNotes() {
            const panel = document.getElementById('generalNotesPanel');
            const overlay = document.getElementById('generalNotesOverlay');
            const textarea = document.getElementById('generalNotesTextArea');
           
            if (textarea) textarea.value = generalNotes || '';
           
            if (overlay) overlay.classList.add('show');
            if (panel) panel.classList.add('open');
           
            setTimeout(() => { if (textarea) textarea.focus(); }, 300);
           
            if (textarea) textarea.addEventListener('input', autoSaveGeneralNotes);
        }

        function closeGeneralNotes() {
            const panel = document.getElementById('generalNotesPanel');
            const overlay = document.getElementById('generalNotesOverlay');
            const textarea = document.getElementById('generalNotesTextArea');
           
            saveCurrentGeneralNotes();
            showGeneralSaveIndicator();
           
            if (panel) panel.classList.remove('open');
            if (overlay) overlay.classList.remove('show');
           
            if (textarea) textarea.removeEventListener('input', autoSaveGeneralNotes);
        }

        function autoSaveGeneralNotes() {
            clearTimeout(generalNotesTimeout);
            generalNotesTimeout = setTimeout(() => {
                saveCurrentGeneralNotes();
                showGeneralSaveIndicator();
            }, 1000);
        }

        function saveCurrentGeneralNotes() {
            const textarea = document.getElementById('generalNotesTextArea');
            if (textarea) generalNotes = textarea.value;
        }

        function showGeneralSaveIndicator() {
            const indicator = document.getElementById('generalSaveIndicator');
            if(indicator) {
                indicator.classList.add('show');
                setTimeout(() => { indicator.classList.remove('show'); }, 2000);
            }
        }

        // ADD THIS SCRIPT FOR DROPDOWN FUNCTIONALITY
        window.addEventListener('load', function() {
    console.log('Page loaded, initializing dropdowns...');

    // --- Event listener for User Profile Dropdown ---
    const userProfileBtn = document.getElementById('userProfileBtn');
    const userDropdown = document.getElementById('userDropdown');
    
    console.log('User Profile Button:', userProfileBtn);
    console.log('User Dropdown:', userDropdown);

    if (userProfileBtn && userDropdown) {
        userProfileBtn.addEventListener('click', function(event) {
            console.log('User profile button clicked');
            event.stopPropagation();
            userDropdown.classList.toggle('show');
            console.log('Dropdown classes:', userDropdown.className);
        });
    } else {
        console.error('User profile elements not found!');
    }

    // --- Initialize Recent Activity Dropdown ---
    const recentBtn = document.getElementById('recentItemsBtn');
    const recentDropdown = document.getElementById('recentItemsDropdown');
    
    console.log('Recent Button:', recentBtn);
    console.log('Recent Dropdown:', recentDropdown);
    
    if (typeof RecentItemsManager !== 'undefined') {
         console.log('RecentItemsManager defined...');
    } else {
        console.error('RecentItemsManager not defined!');
    }

    // --- Global click listener to close open dropdowns ---
    window.addEventListener('click', function(event) {
        if (userDropdown && userProfileBtn && !userProfileBtn.contains(event.target) && !userDropdown.contains(event.target)) {
            userDropdown.classList.remove('show');
        }

        if (recentDropdown && recentBtn && !recentBtn.contains(event.target) && !recentDropdown.contains(event.target)) {
            recentDropdown.classList.remove('show');
        }
    });

    // Other initialization code...
    if (typeof MemberHeaderController !== 'undefined') {
        MemberHeaderController.init();
    }
});

        // ADD THIS SCRIPT FOR GLOBAL SEARCH FUNCTIONALITY
        // document.addEventListener('DOMContentLoaded', function() {
        //     const searchInput = document.getElementById('globalSearchInput');
        //     const searchResultsContainer = document.getElementById('searchResults');

        //     // Debounce function to prevent API calls on every keystroke
        //     const debounce = (func, delay) => {
        //         let timeoutId;
        //         return (...args) => {
        //             clearTimeout(timeoutId);
        //             timeoutId = setTimeout(() => {
        //                 func.apply(this, args);
        //             }, delay);
        //         };
        //     };

        //     const performSearch = async (query) => {
        //         const searchResultsContainer = document.getElementById('searchResults');

        //         // Hide results if the query is too short
        //         if (query.length < 2) {
        //             searchResultsContainer.classList.remove('show');
        //             return;
        //         }

        //         try {
        //             // This is the dynamic API call to your server.
        //             // The server must be set up to handle this request.
        //             const response = await fetch(`/api/global-search?q=${encodeURIComponent(query)}`);
                   
        //             if (!response.ok) {
        //                 throw new Error('Search request failed');
        //             }

        //             const results = await response.json();
                   
        //             // The existing displayResults function will render the data from the server.
        //             displayResults(results);

        //         } catch (error) {
        //             console.error("Search Error:", error);
        //             searchResultsContainer.classList.remove('show'); // Hide on error
        //         }
        //     };

        //     const displayResults = (results) => {
        //         searchResultsContainer.innerHTML = ''; // Clear previous results
               
        //         if (Object.keys(results).length === 0) {
        //             searchResultsContainer.classList.remove('show');
        //             return;
        //         }

        //         for (const category in results) {
        //             const categoryDiv = document.createElement('div');
        //             categoryDiv.className = 'search-result-category';
        //             categoryDiv.textContent = category;
        //             searchResultsContainer.appendChild(categoryDiv);

        //             results[category].forEach(item => {
        //                 const itemLink = document.createElement('a');
        //                 itemLink.href = item.url;
        //                 itemLink.className = 'search-result-item';
        //                 itemLink.innerHTML = `
        //                     <div class="result-title">${item.title}</div>
        //                     <div class="result-description">${item.description}</div>
        //                 `;
        //                 searchResultsContainer.appendChild(itemLink);
        //             });
        //         }
               
        //         searchResultsContainer.classList.add('show');
        //     };

        //     searchInput.addEventListener('input', debounce(e => performSearch(e.target.value), 300));

        //     // Close results when clicking outside
        //     window.addEventListener('click', function(e) {
        //         if (!searchResultsContainer.contains(e.target) && !searchInput.contains(e.target)) {
        //             searchResultsContainer.classList.remove('show');
        //         }
        //     });
        // });

      let allTimelineEvents = [];
    let filteredTimelineEvents = [];

// Timeline view switching function
function switchTimelineView(viewType) {
    document.querySelectorAll('.timeline-view-btn').forEach(btn => {
        btn.classList.remove('active');
    });
   
    document.getElementById('horizontalTimelineView').style.display = 'none';
    document.getElementById('gridTimelineView').style.display = 'none';
    document.getElementById('listTimelineView').style.display = 'none';
   
    if (viewType === 'horizontal') {
        document.getElementById('horizontalTimelineView').style.display = 'block';
        document.querySelector('[onclick="switchTimelineView(\'horizontal\')"]').classList.add('active');
    } else if (viewType === 'grid') {
        document.getElementById('gridTimelineView').style.display = 'block';
        document.querySelector('[onclick="switchTimelineView(\'grid\')"]').classList.add('active');
        populateGridView();
    } else if (viewType === 'list') {
        document.getElementById('listTimelineView').style.display = 'block';
        document.querySelector('[onclick="switchTimelineView(\'list\')"]').classList.add('active');
        populateListView();
    }
}

function populateGridView() {
    const gridContainer = document.getElementById('eventsGridContainer');
    if (!gridContainer) return;
   
    gridContainer.innerHTML = `
        <div class="event-card assignment">
            <div class="event-card-header">
                <div class="event-card-title">Member Assigned to Organization</div>
                <div class="event-card-date">Jan 15, 2024 at 09:30 AM</div>
                <span class="event-type-badge assignment">Assignment</span>
            </div>
            <div class="event-card-details">
                <p style="margin-top: 12px; color: #475569; font-size: 14px;">Member assigned to care team Alpha with high priority status.</p>
            </div>
            <div class="event-card-actions">
                <button class="btn btn-primary">View Details</button>
            </div>
        </div>
       
        <div class="event-card task">
            <div class="event-card-header">
                <div class="event-card-title">Initial Contact Task Created</div>
                <div class="event-card-date">Jan 15, 2024 at 10:00 AM</div>
                <span class="event-type-badge task">Task</span>
            </div>
            <div class="event-card-details">
                <p style="margin-top: 12px; color: #475569; font-size: 14px;">Automated task created for initial member outreach within 24 hours.</p>
            </div>
            <div class="event-card-actions">
                <button class="btn btn-primary">View Details</button>
            </div>
        </div>
       
        <div class="event-card workflow">
            <div class="event-card-header">
                <div class="event-card-title">Onboarding Workflow Initiated</div>
                <div class="event-card-date">Jan 15, 2024 at 10:15 AM</div>
                <span class="event-type-badge workflow">Workflow</span>
            </div>
            <div class="event-card-details">
                <p style="margin-top: 12px; color: #475569; font-size: 14px;">Automated onboarding workflow started - includes consent collection, assessment scheduling.</p>
            </div>
            <div class="event-card-actions">
                <button class="btn btn-primary">View Details</button>
            </div>
        </div>
       
        <div class="event-card consent">
            <div class="event-card-header">
                <div class="event-card-title">Consent Forms Completed</div>
                <div class="event-card-date">Jan 16, 2024 at 02:15 PM</div>
                <span class="event-type-badge consent">Consent</span>
            </div>
            <div class="event-card-details">
                <p style="margin-top: 12px; color: #475569; font-size: 14px;">HIPAA, treatment consent, and data sharing agreements signed.</p>
            </div>
            <div class="event-card-actions">
                <button class="btn btn-primary">View Details</button>
            </div>
        </div>
       
        <div class="event-card appointment">
            <div class="event-card-header">
                <div class="event-card-title">Assessment Appointment Scheduled</div>
                <div class="event-card-date">Jan 17, 2024 at 11:00 AM</div>
                <span class="event-type-badge appointment">Appointment</span>
            </div>
            <div class="event-card-details">
                <p style="margin-top: 12px; color: #475569; font-size: 14px;">Comprehensive health assessment appointment scheduled for Jan 18th.</p>
            </div>
            <div class="event-card-actions">
                <button class="btn btn-primary">View Details</button>
            </div>
        </div>
       
        <div class="event-card assessment">
            <div class="event-card-header">
                <div class="event-card-title">Comprehensive Health Assessment</div>
                <div class="event-card-date">Jan 18, 2024 at 10:00 AM</div>
                <span class="event-type-badge assessment">Assessment</span>
            </div>
            <div class="event-card-details">
                <p style="margin-top: 12px; color: #475569; font-size: 14px;">Initial health assessment completed with risk stratification.</p>
            </div>
            <div class="event-card-actions">
                <button class="btn btn-primary">View Details</button>
            </div>
        </div>
       
        <div class="event-card care-plan">
            <div class="event-card-header">
                <div class="event-card-title">Initial Care Plan Created</div>
                <div class="event-card-date">Jan 20, 2024 at 03:45 PM</div>
                <span class="event-type-badge care-plan">Care Plan</span>
            </div>
            <div class="event-card-details">
                <p style="margin-top: 12px; color: #475569; font-size: 14px;">Comprehensive care plan developed with 6 interventions.</p>
            </div>
            <div class="event-card-actions">
                <button class="btn btn-primary">View Details</button>
            </div>
        </div>
       
        <div class="event-card adt">
            <div class="event-card-header">
                <div class="event-card-title">Emergency Room Visit</div>
                <div class="event-card-date">Feb 10, 2024 at 06:30 PM</div>
                <span class="event-type-badge adt">ADT Event</span>
            </div>
            <div class="event-card-details">
                <p style="margin-top: 12px; color: #475569; font-size: 14px;">ED visit for chest pain - admitted for observation.</p>
            </div>
            <div class="event-card-actions">
                <button class="btn btn-primary">View Details</button>
            </div>
        </div>
       
        <div class="event-card" style="border-top-color: #ef4444;">
            <div class="event-card-header">
                <div class="event-card-title">Member Opted Out</div>
                <div class="event-card-date">May 15, 2024 at 01:20 PM</div>
                <span class="event-type-badge" style="background: #fee2e2; color: #dc2626;">Consent Withdrawn</span>
            </div>
            <div class="event-card-details">
                <p style="margin-top: 12px; color: #475569; font-size: 14px;">Member withdrew consent for care management services.</p>
            </div>
            <div class="event-card-actions">
                <button class="btn btn-primary">View Details</button>
            </div>
        </div>
       
        <div class="event-card consent">
            <div class="event-card-header">
                <div class="event-card-title">Member Re-consented</div>
                <div class="event-card-date">Aug 20, 2024 at 10:45 AM</div>
                <span class="event-type-badge consent">Consent</span>
            </div>
            <div class="event-card-details">
                <p style="margin-top: 12px; color: #475569; font-size: 14px;">Member provided consent again for care management services.</p>
            </div>
            <div class="event-card-actions">
                <button class="btn btn-primary">View Details</button>
            </div>
        </div>
       
        <div class="event-card callback">
            <div class="event-card-header">
                <div class="event-card-title">Follow-up Call Scheduled</div>
                <div class="event-card-date">Aug 30, 2024 at 09:47 AM</div>
                <span class="event-type-badge callback">Callback</span>
            </div>
            <div class="event-card-details">
                <p style="margin-top: 12px; color: #475569; font-size: 14px;">Real-time event update - Follow-up call scheduled.</p>
            </div>
            <div class="event-card-actions">
                <button class="btn btn-primary">View Details</button>
            </div>
        </div>
    `;
}

function populateListView() {
    const listContainer = document.getElementById('eventsListContainer');
    if (!listContainer) return;
   
    listContainer.innerHTML = `
        <div class="event-list-item">
            <div class="event-list-icon" style="background: #10b981;">A</div>
            <div class="event-list-content">
                <div class="event-list-title">Member Assigned to Organization</div>
                <div class="event-list-meta">
                    <span>Jan 15, 2024 at 09:30 AM</span>
                    <span>By: Admin User</span>
                    <span>Priority: high</span>
                </div>
                <div class="event-list-description">Member assigned to care team Alpha with high priority status.</div>
            </div>
            <div class="event-list-actions">
                <button class="btn btn-primary">View Details</button>
            </div>
        </div>
       
        <div class="event-list-item">
            <div class="event-list-icon" style="background: #ec4899;">T</div>
            <div class="event-list-content">
                <div class="event-list-title">Initial Contact Task Created</div>
                <div class="event-list-meta">
                    <span>Jan 15, 2024 at 10:00 AM</span>
                    <span>By: System</span>
                    <span>Status: completed</span>
                </div>
                <div class="event-list-description">Automated task created for initial member outreach within 24 hours.</div>
            </div>
            <div class="event-list-actions">
                <button class="btn btn-primary">View Details</button>
            </div>
        </div>
       
        <div class="event-list-item">
            <div class="event-list-icon" style="background: #6366f1;">W</div>
            <div class="event-list-content">
                <div class="event-list-title">Onboarding Workflow Initiated</div>
                <div class="event-list-meta">
                    <span>Jan 15, 2024 at 10:15 AM</span>
                    <span>By: System</span>
                    <span>Status: completed</span>
                </div>
                <div class="event-list-description">Automated onboarding workflow started - includes consent collection, assessment scheduling.</div>
            </div>
            <div class="event-list-actions">
                <button class="btn btn-primary">View Details</button>
            </div>
        </div>
       
        <div class="event-list-item">
            <div class="event-list-icon" style="background: #8b5cf6;">C</div>
            <div class="event-list-content">
                <div class="event-list-title">Consent Forms Completed</div>
                <div class="event-list-meta">
                    <span>Jan 16, 2024 at 02:15 PM</span>
                    <span>By: King Loreley</span>
                </div>
                <div class="event-list-description">HIPAA, treatment consent, and data sharing agreements signed.</div>
            </div>
            <div class="event-list-actions">
                <button class="btn btn-primary">View Details</button>
            </div>
        </div>
       
        <div class="event-list-item">
            <div class="event-list-icon" style="background: #14b8a6;">A</div>
            <div class="event-list-content">
                <div class="event-list-title">Assessment Appointment Scheduled</div>
                <div class="event-list-meta">
                    <span>Jan 17, 2024 at 11:00 AM</span>
                    <span>By: Care Coordinator</span>
                </div>
                <div class="event-list-description">Comprehensive health assessment appointment scheduled for Jan 18th.</div>
            </div>
            <div class="event-list-actions">
                <button class="btn btn-primary">View Details</button>
            </div>
        </div>
       
        <div class="event-list-item">
            <div class="event-list-icon" style="background: #f59e0b;">A</div>
            <div class="event-list-content">
                <div class="event-list-title">Comprehensive Health Assessment</div>
                <div class="event-list-meta">
                    <span>Jan 18, 2024 at 10:00 AM</span>
                    <span>By: Dr. Smith</span>
                    <span>Priority: high</span>
                </div>
                <div class="event-list-description">Initial health assessment completed with risk stratification.</div>
            </div>
            <div class="event-list-actions">
                <button class="btn btn-primary">View Details</button>
            </div>
        </div>
       
        <div class="event-list-item">
            <div class="event-list-icon" style="background: #ef4444;">C</div>
            <div class="event-list-content">
                <div class="event-list-title">Initial Care Plan Created</div>
                <div class="event-list-meta">
                    <span>Jan 20, 2024 at 03:45 PM</span>
                    <span>By: Care Manager Jones</span>
                </div>
                <div class="event-list-description">Comprehensive care plan developed with 6 interventions.</div>
            </div>
            <div class="event-list-actions">
                <button class="btn btn-primary">View Details</button>
            </div>
        </div>
       
        <div class="event-list-item">
            <div class="event-list-icon" style="background: #06b6d4;">E</div>
            <div class="event-list-content">
                <div class="event-list-title">Emergency Room Visit</div>
                <div class="event-list-meta">
                    <span>Feb 10, 2024 at 06:30 PM</span>
                    <span>By: System Integration</span>
                    <span>Priority: high</span>
                </div>
                <div class="event-list-description">ED visit for chest pain - admitted for observation.</div>
            </div>
            <div class="event-list-actions">
                <button class="btn btn-primary">View Details</button>
            </div>
        </div>
       
        <div class="event-list-item">
            <div class="event-list-icon" style="background: #ef4444;">O</div>
            <div class="event-list-content">
                <div class="event-list-title">Member Opted Out</div>
                <div class="event-list-meta">
                    <span>May 15, 2024 at 01:20 PM</span>
                    <span>By: King Loreley</span>
                    <span>Status: withdrawn</span>
                </div>
                <div class="event-list-description">Member withdrew consent for care management services.</div>
            </div>
            <div class="event-list-actions">
                <button class="btn btn-primary">View Details</button>
            </div>
        </div>
       
        <div class="event-list-item">
            <div class="event-list-icon" style="background: #8b5cf6;">R</div>
            <div class="event-list-content">
                <div class="event-list-title">Member Re-consented</div>
                <div class="event-list-meta">
                    <span>Aug 20, 2024 at 10:45 AM</span>
                    <span>By: King Loreley</span>
                </div>
                <div class="event-list-description">Member provided consent again for care management services.</div>
            </div>
            <div class="event-list-actions">
                <button class="btn btn-primary">View Details</button>
            </div>
        </div>
       
        <div class="event-list-item">
            <div class="event-list-icon" style="background: #f43f5e;">F</div>
            <div class="event-list-content">
                <div class="event-list-title">Follow-up Call Scheduled</div>
                <div class="event-list-meta">
                    <span>Aug 30, 2024 at 09:47 AM</span>
                    <span>By: System User</span>
                    <span>Status: completed</span>
                </div>
                <div class="event-list-description">Real-time event update - Follow-up call scheduled.</div>
            </div>
            <div class="event-list-actions">
                <button class="btn btn-primary">View Details</button>
            </div>
        </div>
    `;
}

// Initialize timeline when timeline tab is clicked

function initializeTimelineFilters() {
    // Set up event listeners for filters
    const startDateInput = document.getElementById('timelineStartDate');
    const endDateInput = document.getElementById('timelineEndDate');
    const eventTypeSelect = document.getElementById('timelineEventType');
   
    if (startDateInput) startDateInput.addEventListener('change', applyTimelineFilters);
    if (endDateInput) endDateInput.addEventListener('change', applyTimelineFilters);
    if (eventTypeSelect) eventTypeSelect.addEventListener('change', applyTimelineFilters);
   
    // --- NEW LOGIC TO POPULATE THE DROPDOWN ---
    if (eventTypeSelect) {
        // Collect all unique event types from the currently displayed timeline
        const eventElements = document.querySelectorAll('.timeline-event[data-type]');
        const eventTypes = new Set();
        eventElements.forEach(el => {
            // Capitalize and format the type for display
            const type = el.dataset.type;
            const formattedType = type.split('-').map(word => word.charAt(0).toUpperCase() + word.slice(1)).join(' ');
            eventTypes.add(formattedType);
        });

        // Clear existing options (except the first "All Events")
        while (eventTypeSelect.options.length > 1) {
            eventTypeSelect.remove(1);
        }

        // Add the new options to the dropdown
        eventTypes.forEach(type => {
            const option = new Option(type, type.toLowerCase().replace(' ', '-'));
            eventTypeSelect.add(option);
        });
    }
    // --- END OF NEW LOGIC ---

    // Initialize events array from DOM and apply any default filters
    collectTimelineEvents();
    applyTimelineFilters();
}

// Collect all events from DOM
function collectTimelineEvents() {
    const eventElements = document.querySelectorAll('.timeline-event[data-date]');
    allTimelineEvents = Array.from(eventElements).map(element => ({
        element: element,
        date: element.getAttribute('data-date'),
        type: element.getAttribute('data-type'),
        title: element.querySelector('.event-title')?.textContent || element.querySelector('.event-label')?.textContent || '',
        dateObj: new Date(element.getAttribute('data-date'))
    }));
   
    // Sort events by date
    allTimelineEvents.sort((a, b) => a.dateObj - b.dateObj);
}

// Apply filters to timeline
function applyTimelineFilters() {
    if (!allTimelineEvents.length) return;
   
    const startDate = document.getElementById('timelineStartDate')?.value;
    const endDate = document.getElementById('timelineEndDate')?.value;
    const eventType = document.getElementById('timelineEventType')?.value;
   
    filteredTimelineEvents = allTimelineEvents.filter(event => {
        let passesDateFilter = true;
        let passesTypeFilter = true;
       
        // Date filtering
        if (startDate && event.dateObj < new Date(startDate)) {
            passesDateFilter = false;
        }
        if (endDate && event.dateObj > new Date(endDate)) {
            passesDateFilter = false;
        }
       
        // Event type filtering
        if (eventType && eventType !== 'all' && event.type !== eventType) {
            passesTypeFilter = false;
        }
       
        return passesDateFilter && passesTypeFilter;
    });
   
    updateTimelineDisplay();
}

function toggleKeyInfoOnly(event) {
    if (event) {
        event.preventDefault();
        event.stopPropagation();
    }
   
    const header = document.getElementById('memberHeader');
    header.classList.toggle('key-info-collapsed');
}

function toggleMemberHeaderExpanded() {
    const header = document.getElementById('memberHeader');
    header.classList.toggle('expanded');
}

// Update timeline display based on filters
function updateTimelineDisplay() {
    const horizontalContainer = document.getElementById('timelineEventsContainer');
    const gridContainer = document.getElementById('gridTimelineView');
    const listContainer = document.getElementById('listTimelineView');
   
    if (horizontalContainer) {
        // Show/hide horizontal timeline events
        allTimelineEvents.forEach(event => {
            const shouldShow = filteredTimelineEvents.includes(event);
            event.element.style.display = shouldShow ? 'flex' : 'none';
        });
    }
   
    // Update grid view
    if (gridContainer) {
        updateGridView();
    }
   
    // Update list view
    if (listContainer) {
        updateListView();
    }
}

// Update grid view with filtered events
function updateGridView() {
    const gridContainer = document.querySelector('#gridTimelineView .events-grid');
    if (!gridContainer) return;
   
    gridContainer.innerHTML = '';
   
    filteredTimelineEvents.forEach(event => {
        const eventCard = createEventCard(event);
        gridContainer.appendChild(eventCard);
    });
}

// Update list view with filtered events
function updateListView() {
    const listContainer = document.querySelector('#listTimelineView .events-list');
    if (!listContainer) return;
   
    listContainer.innerHTML = '';
   
    filteredTimelineEvents.forEach(event => {
        const listItem = createEventListItem(event);
        listContainer.appendChild(listItem);
    });
}

// Create event card for grid view
function createEventCard(event) {
    const card = document.createElement('div');
    card.className = `event-card ${event.type}`;
   
    const popup = event.element.querySelector('.event-popup');
    const title = popup?.querySelector('.event-title')?.textContent || event.title;
    const meta = popup?.querySelector('.event-meta')?.textContent || '';
    const description = popup?.querySelector('p')?.textContent || '';
   
    card.innerHTML = `
        <div class="event-card-header">
            <div class="event-card-title">${title}</div>
            <div class="event-card-date">${formatEventDate(event.date)}</div>
            <span class="event-type-badge ${event.type}">${event.type.replace('-', ' ')}</span>
        </div>
        <div class="event-card-details">
            <p style="margin-top: 12px; color: #475569; font-size: 14px;">${description}</p>
        </div>
        <div class="event-card-actions">
            <button class="btn btn-primary">View Details</button>
        </div>
    `;
   
    return card;
}

// Create list item for list view
function createEventListItem(event) {
    const listItem = document.createElement('div');
    listItem.className = 'event-list-item';
   
    const popup = event.element.querySelector('.event-popup');
    const title = popup?.querySelector('.event-title')?.textContent || event.title;
    const meta = popup?.querySelector('.event-meta')?.textContent || '';
    const description = popup?.querySelector('p')?.textContent || '';
   
    const iconColors = {
        assignment: '#10b981', consent: '#8b5cf6', assessment: '#f59e0b',
        'care-plan': '#ef4444', adt: '#06b6d4', program: '#84cc16',
        billing: '#f97316', workflow: '#6366f1', task: '#ec4899',
        appointment: '#14b8a6', callback: '#f43f5e'
    };
   
    listItem.innerHTML = `
        <div class="event-list-icon" style="background: ${iconColors[event.type] || '#3b82f6'}">
            ${event.type.charAt(0).toUpperCase()}
        </div>
        <div class="event-list-content">
            <div class="event-list-title">${title}</div>
            <div class="event-list-meta">
                <span>${formatEventDate(event.date)}</span>
            </div>
            <div class="event-list-description">${description}</div>
        </div>
        <div class="event-list-actions">
            <button class="btn btn-primary">View Details</button>
        </div>
    `;
   
    return listItem;
}

// Format date for display
function formatEventDate(dateString) {
    const date = new Date(dateString);
    return date.toLocaleDateString('en-US', {
        year: 'numeric',
        month: 'short',
        day: 'numeric'
    });
}

// Print timeline function
function printTimeline() {
    // Get current view
    const currentView = getCurrentActiveView();
   
    // Get filter values
    const startDate = document.getElementById('timelineStartDate')?.value || '';
    const endDate = document.getElementById('timelineEndDate')?.value || '';
    const eventType = document.getElementById('timelineEventType')?.value || 'all';
   
    // Create print container
    createPrintContainer(currentView, startDate, endDate, eventType);
   
    // Print
    const originalTitle = document.title;
    document.title = `Member Timeline - King Loreley - ${new Date().toLocaleDateString()}`;
   
    setTimeout(() => {
        window.print();
        document.title = originalTitle;
        // Clean up print container
        const printContainer = document.getElementById('printContainer');
        if (printContainer) {
            printContainer.remove();
        }
    }, 500);
}


function getCurrentActiveView() {
    if (document.getElementById('horizontalTimelineView').style.display !== 'none') return 'timeline';
    if (document.getElementById('gridTimelineView').style.display !== 'none') return 'grid';
    if (document.getElementById('listTimelineView').style.display !== 'none') return 'list';
    return 'timeline';
}

function createPrintContainer(viewType, startDate, endDate, eventType) {
    // Remove existing print container
    const existingContainer = document.getElementById('printContainer');
    if (existingContainer) {
        existingContainer.remove();
    }
   
    // Create new print container
    const printContainer = document.createElement('div');
    printContainer.id = 'printContainer';
    printContainer.className = 'print-container';
   
    // Get events data
    const events = getAllEventData();
   
    // Filter events if needed
    const filteredEvents = filterEventsForPrint(events, startDate, endDate, eventType);
   
    // Create print content
    printContainer.innerHTML = `
        <div class="print-header">
            <div class="print-title">Member Timeline Report</div>
            <div class="print-subtitle">Member: King Loreley | Medicaid ID: LEAPAug2024DK11</div>
            <div class="print-filters">
                View: ${viewType.charAt(0).toUpperCase() + viewType.slice(1)} |
                Date Range: ${startDate || 'All'} - ${endDate || 'All'} |
                Event Type: ${eventType === 'all' ? 'All Events' : eventType.replace('-', ' ')} |
                Generated: ${new Date().toLocaleString()}
            </div>
        </div>
       
        <div class="print-events">
            ${filteredEvents.map(event => createPrintEventHtml(event)).join('')}
        </div>
       
        <div class="print-footer">
            Total Events: ${filteredEvents.length} | Page 1 of 1 | Member Timeline Report
        </div>
    `;
   
    document.body.appendChild(printContainer);
}

function getAllEventData() {
    return [
        {
            type: 'assignment',
            title: 'Member Assigned to Organization',
            date: '2024-01-15',
            time: '09:30 AM',
            performedBy: 'Admin User',
            priority: 'high',
            description: 'Member assigned to care team Alpha with high priority status.',
            details: 'Assignment includes initial onboarding workflow activation and care manager notification.'
        },
        {
            type: 'task',
            title: 'Initial Contact Task Created',
            date: '2024-01-15',
            time: '10:00 AM',
            performedBy: 'System',
            priority: 'high',
            status: 'completed',
            description: 'Automated task created for initial member outreach within 24 hours.',
            details: 'Task automatically assigned to primary care coordinator for initial member contact and welcome orientation.'
        },
        {
            type: 'workflow',
            title: 'Onboarding Workflow Initiated',
            date: '2024-01-15',
            time: '10:15 AM',
            performedBy: 'System',
            priority: 'medium',
            status: 'completed',
            description: 'Automated onboarding workflow started - includes consent collection, assessment scheduling.',
            details: 'Comprehensive workflow including consent forms, initial assessment scheduling, and care team notifications.'
        },
        {
            type: 'consent',
            title: 'Consent Forms Completed',
            date: '2024-01-16',
            time: '02:15 PM',
            performedBy: 'King Loreley',
            priority: 'high',
            description: 'HIPAA, treatment consent, and data sharing agreements signed.',
            details: 'All required consent forms completed including HIPAA authorization, treatment consent, and care coordination agreements.'
        },
        {
            type: 'appointment',
            title: 'Assessment Appointment Scheduled',
            date: '2024-01-17',
            time: '11:00 AM',
            performedBy: 'Care Coordinator',
            priority: 'medium',
            description: 'Comprehensive health assessment appointment scheduled for Jan 18th.',
            details: 'Initial comprehensive health assessment scheduled with Dr. Smith for complete health evaluation and risk stratification.'
        },
        {
            type: 'assessment',
            title: 'Comprehensive Health Assessment',
            date: '2024-01-18',
            time: '10:00 AM',
            performedBy: 'Dr. Smith',
            priority: 'high',
            description: 'Initial health assessment completed with risk stratification. Member identified as high-risk diabetes.',
            details: 'Complete health evaluation including medical history, current conditions, medications, and social determinants assessment.'
        },
        {
            type: 'care-plan',
            title: 'Initial Care Plan Created',
            date: '2024-01-20',
            time: '03:45 PM',
            performedBy: 'Care Manager Jones',
            priority: 'high',
            description: 'Comprehensive care plan developed with 6 interventions focusing on diabetes management and lifestyle modifications.',
            details: 'Individualized care plan including medication management, lifestyle modifications, education, and monitoring protocols.'
        },
        {
            type: 'program',
            title: 'Diabetes Management Program Enrollment',
            date: '2024-01-25',
            time: '11:20 AM',
            performedBy: 'Program Coordinator',
            priority: 'medium',
            description: 'Enrolled in specialized diabetes management program with weekly monitoring.',
            details: 'Enrollment in comprehensive diabetes management program including education, monitoring, and lifestyle support services.'
        },
        {
            type: 'callback',
            title: 'Follow-up Wellness Check',
            date: '2024-02-01',
            time: '02:30 PM',
            performedBy: 'Care Coordinator',
            priority: 'medium',
            description: 'Routine follow-up call to check medication adherence and overall wellness.',
            details: 'Structured wellness check including medication adherence, symptom monitoring, and care plan compliance review.'
        },
        {
            type: 'adt',
            title: 'Emergency Room Visit',
            date: '2024-02-10',
            time: '06:30 PM',
            performedBy: 'System Integration',
            priority: 'high',
            description: 'ED visit for chest pain - admitted for observation. Care team notified immediately.',
            details: 'Emergency department admission for chest pain evaluation with 24-hour observation and cardiac monitoring.'
        },
        {
            type: 'adt',
            title: 'Hospital Discharge',
            date: '2024-02-12',
            time: '02:00 PM',
            performedBy: 'System Integration',
            priority: 'high',
            description: 'Discharged to home with follow-up instructions and medication changes.',
            details: 'Discharge to home with updated medication regimen and scheduled follow-up appointments with cardiologist and primary care.'
        },
        {
            type: 'consent',
            title: 'Member Opted Out',
            date: '2024-05-15',
            time: '01:20 PM',
            performedBy: 'King Loreley',
            priority: 'high',
            description: 'Member withdrew consent for care management services. All active interventions suspended.',
            details: 'Voluntary withdrawal from care management program with suspension of all active interventions and workflows.'
        },
        {
            type: 'workflow',
            title: 'Care Management Workflow Suspended',
            date: '2024-05-15',
            time: '01:25 PM',
            performedBy: 'System',
            priority: 'medium',
            status: 'suspended',
            description: 'All active workflows and tasks suspended due to consent withdrawal.',
            details: 'Systematic suspension of all active care management workflows, tasks, and scheduled interventions.'
        },
        {
            type: 'consent',
            title: 'Member Re-consented',
            date: '2024-08-20',
            time: '10:45 AM',
            performedBy: 'King Loreley',
            priority: 'high',
            description: 'Member provided consent again for care management services. Reactivation process initiated.',
            details: 'Member re-enrolled in care management program with updated consent forms and reactivation of care protocols.'
        },
        {
            type: 'workflow',
            title: 'Care Management Reactivated',
            date: '2024-08-20',
            time: '11:00 AM',
            performedBy: 'System',
            priority: 'high',
            status: 'active',
            description: 'Care management workflows reactivated. Updated assessment scheduled.',
            details: 'Systematic reactivation of care management workflows with updated assessment and care plan review scheduled.'
        },
        {
            type: 'task',
            title: 'Reassessment Task Created',
            date: '2024-08-25',
            time: '09:15 AM',
            performedBy: 'Care Manager',
            priority: 'high',
            status: 'pending',
            description: 'Task created for comprehensive reassessment following consent reactivation.',
            details: 'Comprehensive reassessment task created to update care plan and evaluate current health status and needs.'
        },
        {
            type: 'callback',
            title: 'Follow-up Call Scheduled',
            date: '2024-08-30',
            time: '09:47 AM',
            performedBy: 'System User',
            priority: 'medium',
            status: 'completed',
            description: 'Real-time event update - Follow-up call scheduled to check on member status.',
            details: 'Scheduled follow-up call to assess current health status, medication adherence, and care plan effectiveness.'
        }
    ];
}

function filterEventsForPrint(events, startDate, endDate, eventType) {
    return events.filter(event => {
        let passesDateFilter = true;
        let passesTypeFilter = true;
       
        if (startDate && new Date(event.date) < new Date(startDate)) {
            passesDateFilter = false;
        }
        if (endDate && new Date(event.date) > new Date(endDate)) {
            passesDateFilter = false;
        }
        if (eventType !== 'all' && event.type !== eventType) {
            passesTypeFilter = false;
        }
       
        return passesDateFilter && passesTypeFilter;
    }).sort((a, b) => new Date(a.date + ' ' + a.time) - new Date(b.date + ' ' + b.time));
}

function createPrintEventHtml(event) {
    const formattedDate = new Date(event.date).toLocaleDateString('en-US', {
        year: 'numeric', month: 'short', day: 'numeric'
    });
   
    return `
        <div class="print-event ${event.type}">
            <div class="print-event-header">
                <div class="print-event-title">${event.title}</div>
                <div class="print-event-type">${event.type.replace('-', ' ')}</div>
            </div>
            <div class="print-event-meta">
                <span><strong>Date:</strong> ${formattedDate} at ${event.time}</span>
                <span><strong>Performed By:</strong> ${event.performedBy}</span>
                ${event.priority ? `<span><strong>Priority:</strong> ${event.priority}</span>` : ''}
                ${event.status ? `<span><strong>Status:</strong> ${event.status}</span>` : ''}
            </div>
            <div class="print-event-description">${event.description}</div>
            <div class="print-event-details">
                <strong>Additional Details:</strong> ${event.details}
            </div>
        </div>
    `;
}

// Initialize timeline when the tab becomes active
document.addEventListener('DOMContentLoaded', function() {
    // Update the existing tab click handler to initialize timeline
    const tabs = document.querySelectorAll('.tab');
    tabs.forEach(tab => {
        tab.addEventListener('click', () => {
            if (tab.dataset.tab === 'timeline') {
                setTimeout(() => {
                    initializeTimelineFilters();
                }, 100);
            }
        });
    });
});


// Data structure to hold the dynamic options for Contact Outcome
const contactOutcomeOptions = {
    'phone': [
        { value: 'answered', text: 'Call Answered' },
        { value: 'not-answered', text: 'Call Not Answered' },
        { value: 'voicemail', text: 'Left Voicemail' },
        { value: 'busy-signal', text: 'Busy Signal' },
        { value: 'disconnected', text: 'Number Disconnected' }
    ],
    'email': [
        { value: 'email-delivered', text: 'Email Delivered' },
        { value: 'email-opened', text: 'Email Opened' },
        { value: 'email-replied', text: 'Email Replied' },
        { value: 'email-bounced', text: 'Email Bounced' }
    ],
    'in-person': [
        { value: 'meeting-completed', text: 'Meeting Completed' },
        { value: 'no-show', text: 'No Show' },
        { value: 'rescheduled', text: 'Meeting Rescheduled' }
    ],
    'video-call': [
        { value: 'meeting-completed', text: 'Meeting Completed' },
        { value: 'no-show', text: 'No Show' },
        { value: 'technical-issues', text: 'Technical Issues' },
        { value: 'rescheduled', text: 'Meeting Rescheduled' }
    ],
    'text-message': [
        { value: 'message-sent', text: 'Message Sent' },
        { value: 'message-delivered', text: 'Message Delivered' },
        { value: 'message-replied', text: 'Message Replied' },
        { value: 'message-failed', text: 'Message Failed' }
    ]
};

// New function to update the Contact Outcome dropdown
function updateContactOutcomes() {
    const methodSelect = document.getElementById('contactMethod');
    const outcomeSelect = document.getElementById('contactOutcome');
    const selectedMethod = methodSelect.value;

    // Clear current options, keeping the placeholder
    outcomeSelect.innerHTML = '<option value="">Select Outcome</option>';

    // Populate with new options if a method is selected
    if (selectedMethod && contactOutcomeOptions[selectedMethod]) {
        const options = contactOutcomeOptions[selectedMethod];
        options.forEach(opt => {
            const optionElement = document.createElement('option');
            optionElement.value = opt.value;
            optionElement.textContent = opt.text;
            outcomeSelect.appendChild(optionElement);
        });
    }
}

function logContactForConsent() {
    alert('Open Log Contact for Consent modal/form');
    // Here you would open a modal or navigate to a form
}

function optOut() {
    if (confirm('Are you sure you want to mark this member as opted out?')) {
        alert('Member marked as opted out');
        // Update the consent status
    }
}

function markAsConsented() {
    if (confirm('Are you sure you want to mark this member as consented?')) {
        alert('Member marked as consented');
        // Update the consent status
    }
}

let currentModalAction = '';
let signaturePad = null;
let uploadedFilesList = [];
let currentConsentStatus = 'to-obtain-consent';

function openServiceNoteModal(action) {
    currentModalAction = action;
    const modal = document.getElementById('serviceNoteModal');
   
    if (!modal) {
        alert('Service note modal not found. Modal HTML needs to be added.');
        return;
    }
   
    const title = document.getElementById('serviceNoteTitle');
    if (title) {
        const titles = {
            'mark-consented': 'Mark Member as Consented',
            'opt-out': 'Mark Member as Opted Out',
            'log-contact': 'Log Contact for Consent',
            'log-care-mgmt': 'Log Contact for Care Management'
        };
        title.textContent = titles[action] || 'Create Service Note';
    }
   
    modal.classList.add('show');
    updateContactOutcomes();
}


function updateConsentActionButtons(status = null) {
    const currentStatus = status || currentConsentStatus;
    const actionsContainer = document.getElementById('consentActions');

    if (!actionsContainer) {
        console.log('consentActions element not found - will update when Details tab is loaded');
        return; // This line is the fix.
    }

    console.log('Updating buttons for status:', currentStatus);

    if (currentStatus === 'consented') {
        actionsContainer.innerHTML = `
            <button class="btn-secondary" onclick="openServiceNoteModal('log-care-mgmt')">Log Contact for Care Mgmt</button>
            <button class="btn-danger" onclick="openServiceNoteModal('opt-out')">Opt Out</button>
        `;
    } else if (currentStatus === 'opted-out') {
        actionsContainer.innerHTML = `
            <button class="btn-primary" onclick="reactivateMember()">Reactivate this Member</button>
        `;
    } else if (currentStatus === 're-consent-required') {
        actionsContainer.innerHTML = `
            <button class="btn-secondary" onclick="openServiceNoteModal('log-care-mgmt')">Log Contact for Care Mgmt</button>
            <button class="btn-secondary" onclick="openServiceNoteModal('log-contact')">Log Contact for Consent</button>
            <button class="btn-danger" onclick="openServiceNoteModal('opt-out')">Opt Out</button>
            <button class="btn-primary" onclick="openServiceNoteModal('mark-re-consented')">Mark As Re-consented</button>
        `;
    } else if (currentStatus === 'care-mgmt-ended') {
        actionsContainer.innerHTML = `
            <button class="btn-danger" onclick="openServiceNoteModal('opt-out')">Opt Out</button>
            <button class="btn-primary" onclick="reactivateMember()">Reactivate this Member</button>
        `;
    } else { // to-obtain-consent (default)
        actionsContainer.innerHTML = `
            <button class="btn-secondary" onclick="openServiceNoteModal('log-contact')">Log Contact for Consent</button>
            <button class="btn-danger" onclick="openServiceNoteModal('opt-out')">Opt Out</button>
            <button class="btn-primary" onclick="openServiceNoteModal('mark-consented')">Mark As Consented</button>
        `;
    }
}

function openTestScenarioModal() {
    const modal = document.createElement('div');
    modal.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 3000;
    `;
   
    modal.innerHTML = `
        <div style="background: white; border-radius: 8px; padding: 24px; max-width: 400px; width: 90%;">
            <h3 style="margin-bottom: 20px;">Test Consent Status Scenarios</h3>
            <div style="display: flex; flex-direction: column; gap: 12px;">
                <button onclick="testScenario('to-obtain-consent')" class="btn btn-secondary" style="width: 100%;">To Obtain Consent</button>
                <button onclick="testScenario('consented')" class="btn btn-primary" style="width: 100%;">Consented</button>
                <button onclick="testScenario('opted-out')" class="btn btn-danger" style="width: 100%;">Opted Out</button>
                <button onclick="testScenario('re-consent-required')" class="btn btn-secondary" style="width: 100%;">Re-consent Required (11 months old)</button>
                <button onclick="testScenario('care-mgmt-ended')" class="btn btn-danger" style="width: 100%;">Care Management Ended</button>
            </div>
            <button onclick="closeTestModal()" style="margin-top: 20px; width: 100%; padding: 8px; background: #f8f9fa; border: 1px solid #ddd; border-radius: 4px;">Close</button>
        </div>
    `;
   
    modal.id = 'testScenarioModal';
    document.body.appendChild(modal);
}

function testScenario(status) {
    // 1. Create a data object for the history table
    const historyData = {
        contactMethod: 'Test Scenario',
        contactOutcome: `Status manually set to '${getStatusText(status)}'`,
        changeConsentStatus: status
    };

    // 2. Call the function to add the new row to the history table
    updateConsentHistory(historyData);

    // 3. Call the existing function to update the main status display
    updateConsentStatus(status);

    // 4. Close the modal and show the confirmation alert
    closeTestModal();
    // (Optional) The alert is removed for a smoother user experience, but you can keep it if you like.
    // alert(`Status changed to: ${getStatusText(status)}\nButtons and history updated.`);
}

function closeTestModal() {
    const modal = document.getElementById('testScenarioModal');
    if (modal) {
        document.body.removeChild(modal);
    }
}

function checkCareMgmtDates() {
    // Get CMA start date from the form (you'll need to parse this from your data)
    const cmaStartDateString = "3/1/2024"; // This should come from your member data
    const cmaStartDate = new Date(cmaStartDateString);
    const currentDate = new Date();
   
    // Calculate months difference
    const monthsDiff = (currentDate.getFullYear() - cmaStartDate.getFullYear()) * 12 +
                      (currentDate.getMonth() - cmaStartDate.getMonth());
   
    if (monthsDiff >= 11 && currentConsentStatus === 'consented') {
        // Automatically update to re-consent required
        updateConsentStatus('re-consent-required');
       
        // Add entry to consent history
        const formData = {
            contactMethod: 'System Check',
            contactOutcome: 'Care Management 11 months old',
            changeConsentStatus: 're-consent-required'
        };
        updateConsentHistory(formData);
    }
}

// Call this function periodically or when the page loads
document.addEventListener('DOMContentLoaded', function() {
    setTimeout(checkCareMgmtDates, 2000); // Check after page loads
});

function setupConsentStatusDropdown(action) {
    const dropdown = document.getElementById('changeConsentStatus');
    dropdown.innerHTML = '';
   
    if (action === 'mark-consented' || action === 'mark-re-consented') {
        dropdown.innerHTML = '<option value="consented">Consented</option>';
        dropdown.disabled = true;
    } else if (action === 'opt-out') {
        dropdown.innerHTML = '<option value="opted-out">Opted Out</option>';
        dropdown.disabled = true;
    } else if (action === 'reactivate-member') {
        // For reactivation, only allow consented or opted out
        dropdown.innerHTML = `
            <option value="consented" selected>Consented</option>
            <option value="opted-out">Opted Out</option>
        `;
        dropdown.disabled = false;
        dropdown.required = true;
    } else if (action === 'log-contact') {
        dropdown.innerHTML = `
            <option value="">Select Status</option>
            <option value="consented">Consented</option>
            <option value="opted-out">Opted Out</option>
            <option value="to-obtain-consent">To Obtain Consent</option>
            <option value="re-consent-required">Re-consent Required</option>
            <option value="care-mgmt-ended">Care Management Ended</option>
        `;
        dropdown.disabled = false;
        dropdown.required = true;
    } else if (action === 'log-care-mgmt') {
        const currentStatus = getCurrentConsentStatus();
        dropdown.innerHTML = `
            <option value="consented" ${currentStatus === 'consented' ? 'selected' : ''}>Consented</option>
            <option value="opted-out" ${currentStatus === 'opted-out' ? 'selected' : ''}>Opted Out</option>
            <option value="to-obtain-consent" ${currentStatus === 'to-obtain-consent' ? 'selected' : ''}>To Obtain Consent</option>
            <option value="re-consent-required" ${currentStatus === 're-consent-required' ? 'selected' : ''}>Re-consent Required</option>
            <option value="care-mgmt-ended" ${currentStatus === 'care-mgmt-ended' ? 'selected' : ''}>Care Management Ended</option>
        `;
        dropdown.disabled = false;
    }
}

function getCurrentConsentStatus() {
    // Try to get status from multiple sources
    let statusText = '';
   
    // First try from the main status indicator
    const mainStatusText = document.querySelector('.status-text');
    if (mainStatusText) {
        statusText = mainStatusText.textContent.toLowerCase();
    }
   
    // Fallback to consent overview section
    if (!statusText) {
        const overviewStatusText = document.querySelector('.consent-status-item .status-text');
        if (overviewStatusText) {
            statusText = overviewStatusText.textContent.toLowerCase();
        }
    }
   
    // Map text to status values
    if (statusText.includes('consented') && !statusText.includes('to obtain')) return 'consented';
    if (statusText.includes('opted out')) return 'opted-out';
    if (statusText.includes('re-consent required')) return 're-consent-required';
    if (statusText.includes('care management ended')) return 'care-mgmt-ended';
   
    // Default fallback
    return 'to-obtain-consent';
}

function closeServiceNoteModal() {
    const modal = document.getElementById('serviceNoteModal');
    const saveBtn = document.getElementById('saveAndPostBtn');
   
    if (saveBtn) {
        saveBtn.disabled = false;
        saveBtn.textContent = 'Save & Post';
    }
   
    if (modal) {
        modal.classList.remove('show');
    }
   
    currentModalAction = '';
}

function toggleBillingSection() {
    const isBillable = document.querySelector('input[name="billable_radio"]:checked').value;
    const billingContainer = document.getElementById('billingCodeContainer');
    const billingSelect = document.getElementById('billingCodeSelect');

    if (isBillable === 'yes') {
        billingContainer.style.display = 'block';
        // If the dropdown is empty, populate it with values
        if (billingSelect.options.length <= 1) {
            const codes = [
                { value: '99204', text: '99204 - Office/outpatient visit new' },
                { value: 'G2212', text: 'G2212 - Prolonged office/outpatient E/M' },
                { value: '99490', text: '99490 - Chronic care management' },
                { value: 'T1016', text: 'T1016 - Case management, each 15 minutes' }
            ];
            codes.forEach(code => {
                billingSelect.add(new Option(code.text, code.value));
            });
        }
    } else {
        billingContainer.style.display = 'none';
    }
}

function calculateDuration() {
    const autoCheckbox = document.getElementById('autoCalculate');
    const durationInput = document.getElementById('duration');
    const startTimeInput = document.getElementById('startTime');
    const endTimeInput = document.getElementById('endTime');

    if (autoCheckbox.checked) {
        durationInput.disabled = true;
        const startTime = startTimeInput.value;
        const endTime = endTimeInput.value;

        if (startTime && endTime) {
            const start = new Date(`1970-01-01T${startTime}`);
            const end = new Date(`1970-01-01T${endTime}`);
            const diff = (end - start) / 1000 / 60; // Difference in minutes

            if (diff > 0) {
                durationInput.value = Math.round(diff);
            } else {
                durationInput.value = ''; // Clear if end time is before start time
            }
        }
    } else {
        durationInput.disabled = false;
    }
}

function updateContactTypes() {
    const contactTypeMap = {
        'phone': ['Incoming Call', 'Outgoing Call', 'Conference Call'],
        'email': ['Incoming Email', 'Outgoing Email', 'Email Thread'],
        'in-person': ['Home Visit', 'Office Visit', 'Community Setting', 'Hospital Visit'],
        'video': ['Telehealth Video Call', 'Video Conference', 'Virtual Meeting']
    };

    const contactOutcomeMap = {
        'phone': [
            { value: 'call-answered', text: 'Call Answered' },
            { value: 'call-not-answered', text: 'Call Not Answered' },
            { value: 'voicemail-left', text: 'Left Voicemail' },
            { value: 'busy-signal', text: 'Busy Signal' },
            { value: 'disconnected', text: 'Number Disconnected' },
            { value: 'call-completed', text: 'Call Completed Successfully' }
        ],
        'email': [
            { value: 'email-sent', text: 'Email Sent' },
            { value: 'email-delivered', text: 'Email Delivered' },
            { value: 'email-opened', text: 'Email Opened' },
            { value: 'email-replied', text: 'Email Replied' },
            { value: 'email-bounced', text: 'Email Bounced' }
        ],
        'in-person': [
            { value: 'meeting-completed', text: 'Meeting Completed' },
            { value: 'member-not-available', text: 'Member Not Available' },
            { value: 'no-show', text: 'No Show' },
            { value: 'rescheduled', text: 'Meeting Rescheduled' }
        ],
        'video': [
            { value: 'meeting-completed', text: 'Video Meeting Completed' },
            { value: 'no-show', text: 'Member No Show' },
            { value: 'technical-issues', text: 'Technical Issues' },
            { value: 'rescheduled', text: 'Meeting Rescheduled' }
        ]
    };

    const methodSelect = document.getElementById('contactMethodSelect');
    const typeSelect = document.getElementById('contactTypeSelect');
    const outcomeSelect = document.getElementById('contactOutcome');
    const selectedMethod = methodSelect.value;

    // Update contact types
    if (typeSelect) {
        typeSelect.innerHTML = '<option>Select Type</option>';
        if (contactTypeMap[selectedMethod]) {
            contactTypeMap[selectedMethod].forEach(type => {
                typeSelect.add(new Option(type, type));
            });
        }
    }

    // Update contact outcomes
    if (outcomeSelect) {
        outcomeSelect.innerHTML = '<option value="">Select Outcome</option>';
        if (contactOutcomeMap[selectedMethod]) {
            contactOutcomeMap[selectedMethod].forEach(outcome => {
                const option = new Option(outcome.text, outcome.value);
                outcomeSelect.appendChild(option);
            });
        }
    }
}


function updateContactSuccessBasedOnPresence() {
    const memberPresentRadios = document.querySelectorAll('input[name="member_present"]');
    const contactSuccessRadios = document.querySelectorAll('input[name="contact_successful"]');
   
    memberPresentRadios.forEach(radio => {
        radio.addEventListener('change', function() {
            if (this.value === 'no') {
                // Pre-fill as not successful but allow user to change
                contactSuccessRadios.forEach(successRadio => {
                    if (successRadio.value === 'no') {
                        successRadio.checked = true;
                    }
                });
            } else if (this.value === 'yes') {
                // Pre-fill as successful but allow user to change
                contactSuccessRadios.forEach(successRadio => {
                    if (successRadio.value === 'yes') {
                        successRadio.checked = true;
                    }
                });
            }
        });
    });
}

// REPLACE all of your old 'DOMContentLoaded' listeners with this single, complete block
//  REPLACE your entire 'DOMContentLoaded' block with this final, corrected version.

//  REPLACE your entire 'DOMContentLoaded' block with this final, stable version.

// === FINAL MERGED SCRIPT INITIALIZATION ===

document.addEventListener('DOMContentLoaded', () => {
    // --- 1. SETUP & TEMPLATES ---
    const pageContainer = document.getElementById('pageContainer');
        if (pageContainer) {
            pageContainer.addEventListener('click', function(event) {
                // Check if a service note link was clicked
                const noteLink = event.target.closest('a[data-note-id]');
                if (noteLink) {
                    event.preventDefault();
                    const noteId = noteLink.dataset.noteId;
                    openServiceNoteFromTable(noteId);
                }
            });
        }
    
    // MODIFIED: The initial HTML is now saved as the DETAIL page template
    memberDetailViewHTML = pageContainer.innerHTML;
    let currentView = 'list'; // State management: 'list' or 'details'
    let selectedMemberId = null;
    if (typeof RecentItemsManager !== 'undefined') {
        RecentItemsManager.init();
    }

    // This logic for other pages is preserved
    serviceNotesViewHTML = `
    <div class="dashboard-widget full-width" style="margin: 24px;">
        <div class="widget-header">
            <h3 class="widget-title">List of Service Notes (4778)</h3>
            <div class="search-filter-area">
                <div class="search-box"><input type="text" placeholder="Search by Note ID, Member..."><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M11.742 10.344a6.5 6.5 0 1 0-1.397 1.398h-.001c.03.04.062.078.098.115l3.85 3.85a1 1 0 0 0 1.415-1.414l-3.85-3.85a1.007 1.007 0 0 0-.115-.1zM12 6.5a5.5 5.5 0 1 1-11 0 5.5 5.5 0 0 1 11 0z"/></svg></div>
                <button class="filter-btn">Filters</button><button class="clear-btn">Clear Filters</button><button class="btn btn-primary" style="padding: 6px 12px;">Add New</button>
            </div>
        </div>
        <div class="widget-content">
            <table class="dashboard-table">
                <thead><tr><th>Note ID</th><th>Member Name</th><th>Staff Member Type</th><th>Related Activity</th><th>Date of Service</th><th>Note Status</th></tr></thead>
                <tbody>
                    <tr><td><a href="#" data-note-id="7733">7733</a></td><td>Fay Blackwell</td><td>John Manager 1</td><td>Care Coordination</td><td>02/09/2025</td><td>Draft</td></tr>
                    <tr><td><a href="#" data-note-id="7732">7732</a></td><td>Jeffrey King</td><td>John Manager 1</td><td>Care Coordination</td><td>02/09/2025</td><td>Draft</td></tr>
                </tbody>
            </table>
            <div class="pagination"><span>Page <strong>1</strong> of <strong>192</strong></span></div>
        </div>
    </div>
`;


    // --- 2. CORE NAVIGATION & VIEW RENDERING (Unchanged) ---
    function initializeMemberList() {
        currentView = 'list';
        toggleQuickLinksButton(false);
        selectedMemberId = null;
        currentMember = null;
        window.currentMember = null;
        
        // Reset AI copilot context when leaving member details
        if (typeof updateAICopilotContext === 'function') {
            updateAICopilotContext();
        }
        
        const pageContainer = document.getElementById('pageContainer');
        if(pageContainer) {
            pageContainer.innerHTML = getMemberListHTML();
            updateBreadcrumbs(['Home', 'Members']);
            renderMemberList(membersDB); 
            setupMemberListControls();
        }
    }

    // --- 3. EVENT LISTENERS (MODIFIED) ---
    const sidebarNav = document.querySelector('.sidebar-nav');
    if (sidebarNav) {
        sidebarNav.addEventListener('click', (event) => {
            const navLink = event.target.closest('a.nav-item');
            if (!navLink) return;
            
            event.preventDefault();
            const navId = navLink.id;
            // Improved title fetching for reliability
            const navTitle = navLink.title || navLink.querySelector('.nav-text').textContent.trim();

            if (navId !== 'navRecentActivity' && typeof RecentItemsManager !== 'undefined') {
                RecentItemsManager.add({ id: navId, title: navTitle, subtitle: 'Navigated to page', url: '#', timestamp: new Date().toISOString() });
            }

            // This switch handles all navigation clicks in one place, fixing the bugs
            switch (navId) {
                case 'navMembers':
                    initializeMemberList();
                    break;
                case 'navServiceNotes':
                    toggleQuickLinksButton(false);
                    // Use the new service notes page generator function
                    document.getElementById('pageContainer').innerHTML = generateServiceNotesPageHTML();
                    setTimeout(initializeServiceNotesPage, 0);
                    updateBreadcrumbs(["Home", "Service Notes"]);
                    break;
                case 'navTask':
                    toggleQuickLinksButton(false);
                    // Use the new task page generator function
                    document.getElementById('pageContainer').innerHTML = generateTaskPageHTML();
                    setTimeout(initializeTaskPage, 0);
                    updateBreadcrumbs(["Home", "Tasks"]);
                    break;
                case 'navRecentActivity':
                    toggleQuickLinksButton(false);
                    showAllActivityPage();
                    break;
                case 'navReports':
                    toggleQuickLinksButton(false);
                    navigateToReports();
                    break;
                default:
                    toggleQuickLinksButton(false);
                    // This is the generic handler for all other placeholder pages
                    pageContainer.innerHTML = createPlaceholderHTML(navTitle);
                    updateBreadcrumbs(['Home', navTitle]);
                    break;
            }

            // Always update the active class at the end
            updateActiveNavItem(navId);
            // Clear member context on any sidebar navigation (member pages set it themselves)
            if (navId !== 'navMembers') {
                window.currentMember = null;
            }
            // AI Co-pilot context update
            if (typeof updateAICopilotContext === 'function') {
                updateAICopilotContext();
            }
        });
    }

    // Your other listeners remain untouched
    const userProfileBtn = document.getElementById('userProfileBtn');
    if (userProfileBtn) {
        userProfileBtn.addEventListener('click', (event) => {
            event.stopPropagation();
            document.getElementById('recentItemsDropdown')?.classList.remove('show');
            document.getElementById('userDropdown')?.classList.toggle('show');
        });
    }

    window.addEventListener('click', (event) => {
        if (!event.target.closest('.recent-items-menu')) {
            document.getElementById('recentItemsDropdown')?.classList.remove('show');
        }
        if (!event.target.closest('.user-profile-menu')) {
            document.getElementById('userDropdown')?.classList.remove('show');
        }
    });
    
    // Helper function (moved inside for encapsulation)
    function updateBreadcrumbs(crumbs) {
        const breadcrumbEl = document.querySelector('.breadcrumb');
        if (!breadcrumbEl) return;
        let html = '';
        crumbs.forEach((crumb, index) => {
            if (index < crumbs.length - 1) {
                html += `${crumb} > `;
            } else {
                html += `<strong>${crumb}</strong>`;
            }
        });
        breadcrumbEl.innerHTML = html;
    }


    // --- Activity Tracking Integration (Unchanged) ---
    const navRecentActivity = document.getElementById('navRecentActivity');
    if (navRecentActivity) {
        navRecentActivity.addEventListener('click', (event) => {
            event.preventDefault();
            if (typeof ActivityTracker !== 'undefined') ActivityTracker.showActivityPage();
        });
    }

    document.querySelectorAll('.sidebar-nav .nav-item').forEach(item => {
        if (item.id === 'navRecentActivity') return;
        item.addEventListener('click', () => {
            const title = item.title || item.querySelector('.nav-text')?.textContent || 'Unknown Page';
            if (typeof ActivityTracker !== 'undefined') {
                ActivityTracker.track({
                    type: 'navigation',
                    title: `Viewed ${title}`,
                    handler: { type: 'sidebarClick', targetid: item.id }
                });
            }
        });
    });

    document.body.addEventListener('click', function(event) {
        const recentItem = event.target.closest('.recent-item');
        if (recentItem && typeof ActivityTracker !== 'undefined') {
            event.preventDefault();
            ActivityTracker.handleItemClick(recentItem);
        }
    });

    // --- 5. INITIALIZATION ---
    // Show loader immediately, then init member list
    const loaderEl = document.getElementById('appLoader');
    if (loaderEl) loaderEl.style.display = 'flex';
    setTimeout(() => {
        initializeMemberList();
        if (loaderEl) {
            loaderEl.style.opacity = '0';
            setTimeout(() => { loaderEl.style.display = 'none'; }, 350);
        }
    }, 100);
});


function toggleAutoCalculate() {
    const autoCalculate = document.getElementById('autoCalculate').checked;
    const durationInput = document.getElementById('duration');
   
    if (autoCalculate) {
        durationInput.disabled = true;
        calculateDuration();
    } else {
        durationInput.disabled = false;
    }
}

function validateContactSuccess() {
    const memberPresent = document.getElementById('memberPresent').value;
    const contactSuccessful = document.getElementById('contactSuccessful');
   
    if (memberPresent === 'no') {
        contactSuccessful.value = 'no';
        // Show warning but keep it editable
        console.log('Warning: Contact cannot be successful if member is not present');
    }
}

function handleFileUpload(event) {
    const files = Array.from(event.target.files);
    const tableContainer = document.getElementById('documentsTableContainer');
    const tableBody = document.getElementById('documentsTableBody');
   
    files.forEach(file => {
        uploadedFilesList.push(file);
       
        const row = document.createElement('tr');
        const currentDate = new Date().toLocaleDateString();
        const currentUser = 'John Manager 12';
       
        row.innerHTML = `
            <td><input type="checkbox"></td>
            <td>${file.name}</td>
            <td>${file.type || 'Unknown'}</td>
            <td>${currentDate}</td>
            <td>${currentUser}</td>
            <td>
                <button class="btn btn-secondary" onclick="previewFile('${file.name}')" style="margin-right: 8px; padding: 4px 8px; font-size: 11px;">Preview</button>
                <button class="btn btn-danger" onclick="removeFile('${file.name}')" style="padding: 4px 8px; font-size: 11px;">Remove</button>
            </td>
        `;
        tableBody.appendChild(row);
    });
   
    if (uploadedFilesList.length > 0) {
        tableContainer.style.display = 'block';
    }
}

function removeFile(filename) {
    uploadedFilesList = uploadedFilesList.filter(file => file.name !== filename);
   
    // Refresh the table
    const uploadedFilesBody = document.getElementById('uploadedFilesBody');
    uploadedFilesBody.innerHTML = '';
   
    uploadedFilesList.forEach(file => {
        const row = document.createElement('tr');
        row.innerHTML = `
            <td>${file.name}</td>
            <td>${(file.size / 1024).toFixed(1)} KB</td>
            <td>${file.type || 'Unknown'}</td>
            <td><button class="btn-secondary" onclick="previewFile('${file.name}')">Preview</button></td>
            <td><button class="btn-danger" onclick="removeFile('${file.name}')">Remove</button></td>
        `;
        uploadedFilesBody.appendChild(row);
    });
   
    if (uploadedFilesList.length === 0) {
        document.getElementById('uploadedFiles').classList.add('hidden');
    }
}

function previewFile(filename) {
    // Simple preview - in real implementation, you'd show actual file preview
    alert(`Preview for: ${filename}`);
}

function initializeSignaturePad() {
    const canvas = document.getElementById('signatureCanvas');
    const ctx = canvas.getContext('2d');
   
    // Set canvas size
    canvas.width = canvas.offsetWidth;
    canvas.height = canvas.offsetHeight;
   
    let isDrawing = false;
    let hasSignature = false;
   
    canvas.addEventListener('mousedown', startDrawing);
    canvas.addEventListener('mousemove', draw);
    canvas.addEventListener('mouseup', stopDrawing);
    canvas.addEventListener('mouseout', stopDrawing);
   
    function startDrawing(e) {
        isDrawing = true;
        const rect = canvas.getBoundingClientRect();
        ctx.beginPath();
        ctx.moveTo(e.clientX - rect.left, e.clientY - rect.top);
    }
   
    function draw(e) {
        if (!isDrawing) return;
       
        const rect = canvas.getBoundingClientRect();
        ctx.lineWidth = 2;
        ctx.lineCap = 'round';
        ctx.strokeStyle = '#000';
        ctx.lineTo(e.clientX - rect.left, e.clientY - rect.top);
        ctx.stroke();
       
        hasSignature = true;
        updateSignatureStatus();
    }
   
    function stopDrawing() {
        isDrawing = false;
        ctx.beginPath();
    }
   
    function updateSignatureStatus() {
        const status = document.getElementById('signatureStatus');
        const addBtn = document.getElementById('addSignatureBtn');
       
        if (hasSignature) {
            status.textContent = 'Signature added';
            status.style.color = '#28a745';
            addBtn.textContent = 'Update Signature';
        } else {
            status.textContent = 'No signature added';
            status.style.color = '#666';
            addBtn.textContent = 'Add Signature';
        }
    }
   
    // Store reference for external use
    signaturePad = {
        clear: function() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            hasSignature = false;
            updateSignatureStatus();
        },
        hasSignature: function() {
            return hasSignature;
        }
    };
}

function toggleKeyInfoSimple(event) {
    if (event) {
        event.preventDefault();
        event.stopPropagation();
    }
   
    const header = document.getElementById('memberHeader');
    const toggleBtn = document.querySelector('.simple-toggle-btn');
    const toggleText = toggleBtn.querySelector('.toggle-text');
   
    header.classList.toggle('key-info-hidden');
   
    if (header.classList.contains('key-info-hidden')) {
        toggleText.textContent = 'Show Details';
    } else {
        toggleText.textContent = 'Hide Details';
    }
}

function clearSignature() {
    if (signaturePad) {
        signaturePad.clear();
    }
}

function addSignature() {
    // In a real implementation, this might open a more sophisticated signature dialog
    alert('Signature pad is ready. Draw your signature on the canvas above.');
}

function getNewStatusFromAction() {
    switch(currentModalAction) {
        case 'mark-consented': return 'consented';
        case 'opt-out': return 'opted-out';
        default: return 'to-obtain-consent';
    }
}

function saveAndPost() {
    // Show loading state
    const saveBtn = document.getElementById('saveAndPostBtn');
    if (saveBtn) {
        saveBtn.disabled = true;
        saveBtn.textContent = 'Saving...';
    }
   
    try {
        // Get form data
        const formData = {
            action: currentModalAction,
            contactMethod: document.getElementById('contactMethod')?.value || 'Phone',
            contactOutcome: document.getElementById('contactOutcome')?.value || 'Call Answered',
            changeConsentStatus: document.getElementById('changeConsentStatus')?.value || getNewStatusFromAction()
        };
       
        // Update consent history
        updateConsentHistory(formData);
       
        // Update consent status
        updateConsentStatus(formData.changeConsentStatus);
       
        // Close modal and show success
        closeServiceNoteModal();
        alert('Service note saved successfully!');
       
    } catch (error) {
        console.error('Error saving service note:', error);
       
        // Reset button state on error
        if (saveBtn) {
            saveBtn.disabled = false;
            saveBtn.textContent = 'Save & Post';
        }
       
        alert('Error saving service note. Please try again.');
    }
}

function updateConsentHistory(data) {
    const tbody = document.getElementById('consentHistoryTableBody');
    if (!tbody) return;
   
    const newRow = document.createElement('tr');
    const currentDate = new Date().toLocaleDateString('en-US');
    const currentUser = 'John Manager 12';
   
    // Get current contact attempts and increment
    const attemptsElement = document.querySelector('.contact-attempts-link a');
    const currentAttempts = attemptsElement ? parseInt(attemptsElement.textContent) : 0;
    const newAttempts = currentAttempts + 1;
   
    newRow.innerHTML = `
        <td>${currentDate}</td>
        <td>${data.contactMethod}</td>
        <td>${data.contactOutcome}</td>
        <td>${newAttempts}</td>
        <td><span class="status-indicator"><span class="status-dot ${getStatusColor(data.changeConsentStatus)}"></span>${getStatusText(data.changeConsentStatus)}</span></td>
        <td>${currentUser}</td>
    `;
   
    tbody.insertBefore(newRow, tbody.firstChild);
   
    // Update contact attempts counter
    if (attemptsElement) {
        attemptsElement.textContent = newAttempts;
    }
}

function getStatusColor(status) {
    const colors = {
        'consented': 'green',
        'opted-out': 'red',
        'to-obtain-consent': 'orange',
        're-consent-required': 'orange',
        'care-mgmt-ended': 'red'
    };
    return colors[status] || 'orange';
}

function getStatusText(status) {
    const texts = {
        'consented': 'Consented',
        'opted-out': 'Opted Out',
        'to-obtain-consent': 'To Obtain Consent',
        're-consent-required': 'Re-consent Required',
        'care-mgmt-ended': 'Care Management Ended'
    };
    return texts[status] || 'To Obtain Consent';
}


let isEditMode = false;

// ========== NEW: Global Search Functionality ==========
let searchTimeout;
let activeFilter = 'all';
let recentSearches = JSON.parse(localStorage.getItem('recentSearches') || '[]');

function initializeGlobalSearch() {

    const searchInput = document.getElementById('globalSearchInput');
    const searchDropdown = document.getElementById('searchDropdown');
    const filterChips = document.querySelectorAll('.filter-chip');

    if (!searchInput) return;
    
    // Handle search input
    searchInput.addEventListener('input', function(e) {
        const query = e.target.value.trim();
        
        clearTimeout(searchTimeout);
        
        if (query.length === 0) {
            showRecentSearches();
            searchDropdown.classList.add('active');
        } else if (query.length >= 2) {
            searchDropdown.classList.add('active');
            showSearchLoading();
            
            searchTimeout = setTimeout(() => {
                performSearch(query);
            }, 300);
        } else {
            searchDropdown.classList.remove('active');
        }
    });
    
    // Handle search focus - show recent searches
    searchInput.addEventListener('focus', function() {
        if (searchInput.value.trim().length === 0) {
            showRecentSearches();
            searchDropdown.classList.add('active');
        }
    });
    
    // Handle filter chip clicks
    filterChips.forEach(chip => {
        chip.addEventListener('click', function() {
            filterChips.forEach(c => c.classList.remove('active'));
            this.classList.add('active');
            activeFilter = this.dataset.filter;
            
            // Re-run search if there's a query
            const query = searchInput.value.trim();
            if (query.length >= 2) {
                performSearch(query);
            }
        });
    });
    
    // Close dropdown when clicking outside
    document.addEventListener('click', function(e) {
        if (!searchInput.contains(e.target) && !searchDropdown.contains(e.target)) {
            searchDropdown.classList.remove('active');
        }
    });
}

function performSearch(query) {
    const results = searchMembers(query, activeFilter);
    displaySearchResults(results, query);
}

function searchMembers(query, filter) {
    const searchQuery = query.toLowerCase().replace(/[-\s]/g, '');
    
    // Get actual members from the membersDB array
    const membersToSearch = membersDB || [];
    
    return membersToSearch.filter(member => {
        // Get name for searching
        const fullName = member.name || (member.firstName + ' ' + member.lastName) || '';
        const nameMatch = fullName.toLowerCase().includes(query.toLowerCase());
        
        // If "Name" filter is selected, ONLY search names
        if (filter === 'name') {
            return nameMatch;
        }
        
        // If "All" filter is selected, search both name AND all IDs
        if (filter === 'all') {
            if (nameMatch) return true;
            
            const idMatch = member.id && member.id.toLowerCase().replace(/[-\s]/g, '').includes(searchQuery);
            const mrnMatch = member.mrn && member.mrn.toLowerCase().replace(/[-\s]/g, '').includes(searchQuery);
            const medicareMatch = member.medicare && member.medicare.toLowerCase().replace(/[-\s]/g, '').includes(searchQuery);
            const commercialMatch = member.mco && member.mco.toLowerCase().replace(/[-\s]/g, '').includes(searchQuery);
            
            return idMatch || medicareMatch || mrnMatch || commercialMatch;
        }
        
        // For specific ID filters, search name OR that specific ID
        if (nameMatch) {
            return true;
        }
        
        // Check specific ID fields based on filter
        if (filter === 'medicaid') {
            return member.id && member.id.toLowerCase().replace(/[-\s]/g, '').includes(searchQuery);
        } else if (filter === 'medicare') {
            return member.medicare && member.medicare.toLowerCase().replace(/[-\s]/g, '').includes(searchQuery);
        } else if (filter === 'mrn') {
            return member.mrn && member.mrn.toLowerCase().replace(/[-\s]/g, '').includes(searchQuery);
        } else if (filter === 'commercial') {
            return member.mco && member.mco.toLowerCase().replace(/[-\s]/g, '').includes(searchQuery);
        }
        
        return false;
    });
}

function displaySearchResults(results, query) {
    const container = document.getElementById('searchResultsContainer');
    
    if (results.length === 0) {
        container.innerHTML = `
            <div class="search-no-results">
                <p>No members found matching "${query}"</p>
                <p style="font-size: 12px; margin-top: 8px; color: #999;">Try different keywords or check filters</p>
            </div>
        `;
        return;
    }
    
    let html = `<div class="search-results-header">Results (${results.length})</div>`;
    
    results.forEach(member => {
        const ids = [];
        if (member.medicaidId) ids.push(`Medicaid: ${member.medicaidId}`);
        if (member.medicareId && member.medicareId !== '-') ids.push(`Medicare: ${member.medicareId}`);
        if (member.mrn) ids.push(`MRN: ${member.mrn}`);
        if (member.commercialInsuranceId) ids.push(`Commercial: ${member.commercialInsuranceId}`);
        
        const idsText = ids.join(', ');
        const riskBadge = member.riskCategory ? `<span class="result-badge ${member.riskCategory.toLowerCase()}">${member.riskCategory} Risk</span>` : '';
        
        html += `
            <div class="search-result-item" onclick="selectMemberFromSearch('${member.id}', '${member.name}')">
                <div class="result-name">${member.name}${riskBadge}</div>
                <div class="result-details">
                    ${idsText}  Age ${member.age}  ${member.consentStatus}
                </div>
            </div>
        `;
    });
    
    container.innerHTML = html;
}

function showRecentSearches() {
    const container = document.getElementById('searchResultsContainer');
    
    if (recentSearches.length === 0) {
        container.innerHTML = `
            <div class="search-no-results">
                <p style="color: #999;">Start typing to search for members</p>
            </div>
        `;
        return;
    }
    
    let html = `<div class="search-results-header">Recent</div><div class="recent-searches-section">`;
    
    recentSearches.slice(0, 5).forEach(search => {
        html += `
            <div class="recent-search-item" onclick="selectMemberFromSearch('${search.id}', '${search.name}')">
                <span class="recent-icon"></span>
                <span class="recent-name">${search.name}</span>
            </div>
        `;
    });
    
    html += `</div>`;
    container.innerHTML = html;
}

function showSearchLoading() {
    const container = document.getElementById('searchResultsContainer');
    container.innerHTML = `
        <div class="search-loading">
            <p>Searching...</p>
        </div>
    `;
}

function selectMemberFromSearch(memberId, memberName) {
    // Add to recent searches
    addToRecentSearches(memberId, memberName);
    
    // Close dropdown
    document.getElementById('searchDropdown').classList.remove('active');
    
    // Clear search input
    document.getElementById('globalSearchInput').value = '';
    
    // Navigate to member (using correct function)
    navigateToDetails(memberId);
}

function addToRecentSearches(memberId, memberName) {
    // Remove if already exists
    recentSearches = recentSearches.filter(item => item.id !== memberId);
    
    // Add to beginning
    recentSearches.unshift({ id: memberId, name: memberName });
    
    // Keep only last 5
    recentSearches = recentSearches.slice(0, 5);
    
    // Save to localStorage
    localStorage.setItem('recentSearches', JSON.stringify(recentSearches));
}
// ========== END: Global Search Functionality ==========

function toggleEditMode() {
    isEditMode = !isEditMode;
    const allInputs = document.querySelectorAll('.service-note-body input, .service-note-body select, .service-note-body textarea');
    const footer = document.getElementById('serviceNoteFooter');
   
    if (isEditMode) {
        // Enable editing
        allInputs.forEach(input => {
            input.disabled = false;
            input.style.backgroundColor = 'white';
        });
       
        // Update footer buttons
        footer.innerHTML = `
            <div style="position: fixed; bottom: 0; left: 0; right: 0; background: white; padding: 16px 20px; border-top: 1px solid #e1e5e9; display: flex; justify-content: flex-end; gap: 12px; z-index: 2001; box-shadow: 0 -2px 10px rgba(0,0,0,0.1);">
                <button class="btn btn-secondary" onclick="cancelEdit()">Cancel</button>
                <button class="btn btn-primary" onclick="saveServiceNote()">Save</button>
            </div>
        `;
    } else {
        // Disable editing
        allInputs.forEach(input => {
            input.disabled = true;
            input.style.backgroundColor = '#f8f9fa';
        });
       
        // Reset footer buttons
        footer.innerHTML = `
            <div style="position: fixed; bottom: 0; left: 0; right: 0; background: white; padding: 16px 20px; border-top: 1px solid #e1e5e9; display: flex; justify-content: flex-end; gap: 12px; z-index: 2001; box-shadow: 0 -2px 10px rgba(0,0,0,0.1);">
                <button class="btn btn-secondary" onclick="closeServiceNoteModal()">Close</button>
                <button class="btn btn-secondary" onclick="toggleEditMode()">Edit</button>
                <button class="btn btn-primary">Continue</button>
            </div>
        `;
    }
}

function cancelEdit() {
    isEditMode = false;
    // Revert to view mode (disables fields and resets buttons)
    toggleEditMode();
    // Close the modal
    closeServiceNoteModal();
}


function saveServiceNote() {
    // Get the consent status value from the dropdown
    const consentStatusSelect = document.getElementById('changeConsentStatus');
    if (consentStatusSelect && consentStatusSelect.value) {
        updateConsentStatus(consentStatusSelect.value);
    }
   
    // Logic to exit edit mode and show a success message
    isEditMode = false;
    toggleEditMode(); // This will disable fields and reset buttons
    showSuccessMessage('Service note saved successfully!');
   
    // ADDED: Close the modal after saving
    closeServiceNoteModal();
}


function updateConsentStatus(newStatus) {
    console.log('updateConsentStatus called with:', newStatus);
   
    // Store the status globally
    currentConsentStatus = newStatus;
   
    // Update ALL consent status indicators across the interface
   
    // 1. Update main consent status indicator in collapsed header
    const statusText = document.querySelector('.status-text');
    const statusDot = document.querySelector('.status-dot');
   
    if (statusText && statusDot) {
        statusText.textContent = getStatusText(newStatus);
        statusDot.className = `status-dot ${getStatusColor(newStatus)}`;
    }
   
    // 2. Update status in the Member Details tab consent overview grid
    const consentStatusTexts = document.querySelectorAll('.consent-status-item .status-text');
    const consentStatusDots = document.querySelectorAll('.consent-status-item .status-dot');
   
    consentStatusTexts.forEach(text => {
        text.textContent = getStatusText(newStatus);
    });
   
    consentStatusDots.forEach(dot => {
        dot.className = `status-dot ${getStatusColor(newStatus)}`;
    });
   
    // 3. Update the status indicator in the expanded member header
    const expandedStatusText = document.querySelector('.info-value.highlight');
    if (expandedStatusText && expandedStatusText.textContent.includes('Consent')) {
        expandedStatusText.innerHTML = `
            <span class="consent-icon"></span>
            ${getStatusText(newStatus)}
        `;
    }
   
    // 4. Update any service note modals that might be open
    const serviceNoteConsentSelect = document.getElementById('changeConsentStatus');
    if (serviceNoteConsentSelect) {
        serviceNoteConsentSelect.value = newStatus;
    }
   
    // 5. Update the collapsed header key info section
    const collapsedConsentValue = document.querySelector('#consentStatusCollapsed .key-info-value');
    if (collapsedConsentValue) {
        collapsedConsentValue.innerHTML = `
            <span class="consent-icon"></span>
            ${getStatusText(newStatus)}
        `;
    }
   
    // 6. Update date displays to current date
    const dateDisplays = document.querySelectorAll('.date-display');
    const today = new Date().toLocaleDateString('en-US', {
        month: '2-digit',
        day: '2-digit',
        year: 'numeric'
    });
   
    dateDisplays.forEach(dateDisplay => {
        if (dateDisplay.textContent.includes('12/25/2023') || dateDisplay.textContent.includes('')) {
            dateDisplay.textContent = ` ${today}`;
        }
    });
   
    // 7. Update action buttons
    updateConsentActionButtons(newStatus);
}

function populateSetupContent() {
    const container = document.getElementById('configCategories');
    const searchWrapper = document.querySelector('.config-search-wrapper');
    if (searchWrapper) {
        searchWrapper.style.display = 'none';
    }
    container.innerHTML = `
        <div class="config-category">
            <div class="config-category-header" onclick="toggleConfigCategory(this.parentElement)">
                <span>AI Models</span>
                <svg class="config-category-arrow" width="12" height="12" fill="currentColor" viewBox="0 0 16 16">
                    <path fill-rule="evenodd" d="M1.646 4.646a.5.5 0 0 1 .708 0L8 10.293l5.646-5.647a.5.5 0 0 1 .708.708l-6 6a.5.5 0 0 1-.708 0l-6-6a.5.5 0 0 1 0-.708z"/>
                </svg>
            </div>
            <div class="config-category-items">
                <div class="config-item">Model Configuration</div>
                <div class="config-item">Training Settings</div>
            </div>
        </div>
        <div class="config-category">
            <div class="config-category-header" onclick="toggleConfigCategory(this.parentElement)">
                <span>Analytics</span>
                <svg class="config-category-arrow" width="12" height="12" fill="currentColor" viewBox="0 0 16 16">
                    <path fill-rule="evenodd" d="M1.646 4.646a.5.5 0 0 1 .708 0L8 10.293l5.646-5.647a.5.5 0 0 1 .708.708l-6 6a.5.5 0 0 1-.708 0l-6-6a.5.5 0 0 1 0-.708z"/>
                </svg>
            </div>
            <div class="config-category-items">
                <div class="config-item">Dashboard Settings</div>
                <div class="config-item">Report Configuration</div>
            </div>
        </div>
        <div class="config-category">
            <div class="config-category-header" onclick="toggleConfigCategory(this.parentElement)">
                <span>Companies</span>
                <svg class="config-category-arrow" width="12" height="12" fill="currentColor" viewBox="0 0 16 16">
                    <path fill-rule="evenodd" d="M1.646 4.646a.5.5 0 0 1 .708 0L8 10.293l5.646-5.647a.5.5 0 0 1 .708.708l-6 6a.5.5 0 0 1-.708 0l-6-6a.5.5 0 0 1 0-.708z"/>
                </svg>
            </div>
            <div class="config-category-items">
                <div class="config-item">Company Profiles</div>
                <div class="config-item">Organization Settings</div>
            </div>
        </div>
        <div class="config-category">
            <div class="config-category-header" onclick="toggleConfigCategory(this.parentElement)">
                <span>Employee</span>
                <svg class="config-category-arrow" width="12" height="12" fill="currentColor" viewBox="0 0 16 16">
                    <path fill-rule="evenodd" d="M1.646 4.646a.5.5 0 0 1 .708 0L8 10.293l5.646-5.647a.5.5 0 0 1 .708.708l-6 6a.5.5 0 0 1-.708 0l-6-6a.5.5 0 0 1 0-.708z"/>
                </svg>
            </div>
            <div class="config-category-items">
                <div class="config-item">User Management</div>
                <div class="config-item">Role Assignments</div>
            </div>
        </div>
        <div class="config-category">
            <div class="config-category-header" onclick="toggleConfigCategory(this.parentElement)">
                <span>Locations</span>
                <svg class="config-category-arrow" width="12" height="12" fill="currentColor" viewBox="0 0 16 16">
                    <path fill-rule="evenodd" d="M1.646 4.646a.5.5 0 0 1 .708 0L8 10.293l5.646-5.647a.5.5 0 0 1 .708.708l-6 6a.5.5 0 0 1-.708 0l-6-6a.5.5 0 0 1 0-.708z"/>
                </svg>
            </div>
            <div class="config-category-items">
                <div class="config-item">Facility Management</div>
                <div class="config-item">Location Settings</div>
            </div>
        </div>
        <div class="config-category">
            <div class="config-category-header" onclick="toggleConfigCategory(this.parentElement)">
                <span>Organizations</span>
                <svg class="config-category-arrow" width="12" height="12" fill="currentColor" viewBox="0 0 16 16">
                    <path fill-rule="evenodd" d="M1.646 4.646a.5.5 0 0 1 .708 0L8 10.293l5.646-5.647a.5.5 0 0 1 .708.708l-6 6a.5.5 0 0 1-.708 0l-6-6a.5.5 0 0 1 0-.708z"/>
                </svg>
            </div>
            <div class="config-category-items">
                <div class="config-item">Org Structure</div>
                <div class="config-item">Hierarchy Settings</div>
            </div>
        </div>
    `;
}

function openGenericDrawer(title) {
    const drawer = document.getElementById('configDrawer');
    const overlay = document.getElementById('configDrawerOverlay');
    const drawerTitle = document.querySelector('.config-drawer-title');
    const sidebar = document.getElementById('sidebar');
   
    // If drawer is already open with the same title, close it
    if (drawer.classList.contains('show') && drawerTitle.textContent === title) {
        closeConfigDrawer();
        return;
    }
   
    // If drawer is open with different title, close it first then reopen with new content
    if (drawer.classList.contains('show') && drawerTitle.textContent !== title) {
        closeConfigDrawer();
        // Add small delay to ensure clean transition
        setTimeout(() => {
            openGenericDrawer(title);
        }, 100);
        return;
    }
   
    // Adjust position based on sidebar state
    if (sidebar.classList.contains('collapsed')) {
        drawer.classList.add('from-collapsed');
    } else {
        drawer.classList.remove('from-collapsed');
    }
   
    // Set the title BEFORE populating content
    if (drawerTitle) {
        drawerTitle.textContent = title;
    }
   
    // Show appropriate content based on title
    if (title === 'Provider Network') {
        populateProviderNetworkContent();
    } else if (title === 'Settings') {
        populateSettingsContent();
    } else if (title === 'Set-up') {
        populateSetupContent();
    }
   
    drawer.classList.add('show');
    overlay.classList.add('show');
}

        function toggleConfigurationDrawer() {
    console.log('toggleConfigurationDrawer called');
   
    const drawer = document.getElementById('configDrawer');
    const overlay = document.getElementById('configDrawerOverlay');
    const drawerTitle = document.querySelector('.config-drawer-title');
    const sidebar = document.getElementById('sidebar');
   
    console.log('Drawer state before toggle:', drawer.classList.contains('show'));
   
    if (drawer.classList.contains('show')) {
        console.log('Drawer is open, closing it');
        closeConfigDrawer();
    } else {
        console.log('Drawer is closed, opening it');
       
        // Adjust position based on sidebar state
        if (sidebar.classList.contains('collapsed')) {
            drawer.classList.add('from-collapsed');
        } else {
            drawer.classList.remove('from-collapsed');
        }
       
        // Set the title
        if (drawerTitle) {
            drawerTitle.textContent = 'Configuration Settings';
        }
       
        // Show search bar for configurations
        const searchWrapper = document.querySelector('.config-search-wrapper');
        if (searchWrapper) {
            searchWrapper.style.display = 'block';
        }
       
        populateConfigCategories();
        drawer.classList.add('show');
        overlay.classList.add('show');
    }
}

function populateProviderNetworkContent() {
    const container = document.getElementById('configCategories');
   
    // Hide search bar for simple content
    const searchWrapper = document.querySelector('.config-search-wrapper');
    if (searchWrapper) {
        searchWrapper.style.display = 'none';
    }
   
    container.innerHTML = `
        <div class="config-category">
            <div class="config-item">External Directory</div>
        </div>
        <div class="config-category">
            <div class="config-item">Internal Provider Directory</div>
        </div>
        <div class="config-category">
            <div class="config-item">Manage my Network</div>
        </div>
    `;
}

function populateSettingsContent() {
    const container = document.getElementById('configCategories');
   
    // Hide search bar for simple content
    const searchWrapper = document.querySelector('.config-search-wrapper');
    if (searchWrapper) {
        searchWrapper.style.display = 'none';
    }
   
    container.innerHTML = `
        <div class="config-category">
            <div class="config-item">User Preferences</div>
        </div>
        <div class="config-category">
            <div class="config-item">System Settings</div>
        </div>
        <div class="config-category">
            <div class="config-item">Security Settings</div>
        </div>
    `;
}

function showContactHistory() {
    // This function could expand the history table or show it in a modal
    alert('Contact history will be displayed here. This could open a detailed modal with all contact attempts.');
}

// Add CSS for additional status colors
const additionalCSS = `
.status-dot.green {
    background-color: #28a745;
}

.status-dot.red {
    background-color: #dc3545;
}

.status-dot.orange {
    background-color: #ff8c00;
}

.btn-danger {
    background-color: #dc3545;
    color: white;
    border: none;
    padding: 10px 20px;
    border-radius: 6px;
    font-size: 14px;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s;
}

.btn-danger:hover {
    background-color: #c82333;
}

/* Drag and drop styles */
.file-upload-area.dragover {
    border-color: #484581 !important;
    background: #f0f8ff !important;
}

/* Validation styles */
.form-group input.error,
.form-group select.error {
    border-color: #dc3545 !important;
    box-shadow: 0 0 0 0.2rem rgba(220, 53, 69, 0.25);
}

/* File preview styles */
.file-preview {
    max-width: 100px;
    max-height: 100px;
    object-fit: cover;
    border-radius: 4px;
}

/* Signature canvas styles */
.signature-canvas {
    border: 1px dashed #ddd;
    cursor: crosshair;
}

.signature-canvas:hover {
    border-color: #484581;
}
`;

// Add the additional CSS to the document
const styleSheet = document.createElement('style');
styleSheet.textContent = additionalCSS;
document.head.appendChild(styleSheet);

// Enhanced file handling with drag and drop
function setupDragAndDrop() {
    const fileUploadArea = document.querySelector('.file-upload-area');
   
    if (fileUploadArea) {
        fileUploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            fileUploadArea.classList.add('dragover');
        });
       
        fileUploadArea.addEventListener('dragleave', (e) => {
            e.preventDefault();
            fileUploadArea.classList.remove('dragover');
        });
       
        fileUploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            fileUploadArea.classList.remove('dragover');
           
            const files = Array.from(e.dataTransfer.files);
            handleFileUpload({ target: { files: files } });
        });
    }
}

// Initialize drag and drop when modal opens
function initializeModalFeatures() {
    setupDragAndDrop();
    initializeSignaturePad();
    updateContactSuccessBasedOnPresence();
    updateContactTypes(); // Initialize contact types and outcomes
}

// Enhanced form validation
function validateForm() {
    const form = document.querySelector('.service-note-body');
    const requiredFields = form.querySelectorAll('[required]');
    let isValid = true;
    let firstInvalidField = null;
   
    requiredFields.forEach(field => {
        if (!field.value.trim()) {
            field.classList.add('error');
            if (!firstInvalidField) {
                firstInvalidField = field;
            }
            isValid = false;
        } else {
            field.classList.remove('error');
        }
    });
   
    // Validate billing code if billable is yes
    const billable = document.getElementById('billable');
    const billingCode = document.getElementById('billingCode');
   
    if (billable.value === 'yes' && !billingCode.value) {
        billingCode.classList.add('error');
        isValid = false;
        if (!firstInvalidField) {
            firstInvalidField = billingCode;
        }
    }
   
    // Focus on first invalid field
    if (firstInvalidField) {
        firstInvalidField.focus();
        firstInvalidField.scrollIntoView({ behavior: 'smooth', block: 'center' });
    }
   
    return isValid;
}

// Update the saveAndPost function to use enhanced validation
function saveAndPost() {
    // Show loading state
    const saveBtn = document.getElementById('saveAndPostBtn');
    if (saveBtn) {
        saveBtn.disabled = true;
        saveBtn.textContent = 'Saving...';
    }
   
    try {
        // Get form data
        const formData = {
            action: currentModalAction,
            contactMethod: document.getElementById('contactMethod')?.value || 'Phone',
            contactOutcome: document.getElementById('contactOutcome')?.value || 'Call Answered',
            changeConsentStatus: document.getElementById('changeConsentStatus')?.value || getNewStatusFromAction()
        };
       
        // Update consent history
        updateConsentHistory(formData);
       
        // Update consent status with proper status value
        updateConsentStatus(formData.changeConsentStatus);
       
        // Close modal and show success
        closeServiceNoteModal();
        alert('Service note saved successfully!');
       
    } catch (error) {
        console.error('Error saving service note:', error);
       
        // Reset button state on error
        if (saveBtn) {
            saveBtn.disabled = false;
            saveBtn.textContent = 'Save & Post';
        }
       
        alert('Error saving service note. Please try again.');
    }
}

function collectFormData() {
    return {
        action: currentModalAction,
        activityType: document.getElementById('activityType').value,
        serviceDateTime: document.getElementById('serviceDateTime').value,
        startTime: document.getElementById('startTime').value,
        endTime: document.getElementById('endTime').value,
        duration: document.getElementById('duration').value,
        contactMethod: document.getElementById('contactMethod').value,
        contactOutcome: document.getElementById('contactOutcome').value,
        memberPresent: document.getElementById('memberPresent').value,
        contactSuccessful: document.getElementById('contactSuccessful').value,
        changeConsentStatus: document.getElementById('changeConsentStatus').value,
        contactNotes: document.getElementById('contactNotes').value,
        billable: document.getElementById('billable').value,
        billingCode: document.getElementById('billingCode').value,
        uploadedFiles: uploadedFilesList,
        hasSignature: signaturePad ? signaturePad.hasSignature() : false
    };
}

function showLoadingState() {
    const saveBtn = document.getElementById('saveAndPostBtn');
    saveBtn.disabled = true;
    saveBtn.textContent = 'Saving...';
}

function hideLoadingState() {
    const saveBtn = document.getElementById('saveAndPostBtn');
    saveBtn.disabled = false;
    saveBtn.textContent = 'Save & Post';
}

function showErrorMessage(message) {
    // Create a temporary error message
    const errorDiv = document.createElement('div');
    errorDiv.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: #dc3545;
        color: white;
        padding: 12px 20px;
        border-radius: 6px;
        box-shadow: 0 4px 12px rgba(220, 53, 69, 0.3);
        z-index: 3000;
        font-size: 14px;
        font-weight: 500;
    `;
    errorDiv.textContent = message;
   
    document.body.appendChild(errorDiv);
   
    setTimeout(() => {
        document.body.removeChild(errorDiv);
    }, 5000);
}

function showSuccessMessage(message) {
    const successDiv = document.createElement('div');
    successDiv.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: #28a745;
        color: white;
        padding: 12px 20px;
        border-radius: 6px;
        box-shadow: 0 4px 12px rgba(40, 167, 69, 0.3);
        z-index: 3000;
        font-size: 14px;
        font-weight: 500;
    `;
    successDiv.textContent = message;
   
    document.body.appendChild(successDiv);
   
    setTimeout(() => {
        document.body.removeChild(successDiv);
    }, 3000);
}

function openServiceNoteFromTable(noteId) {
    console.log(`Opening full service note for ID: ${noteId}`);
    openServiceNoteModal('view-full', 'full');
}

// Initialize features when modal opens
function openServiceNoteModal(action, viewType = 'consent') {
    currentModalAction = action;
    const modal = document.getElementById('serviceNoteModal');
    if (!modal) return;

    // MODIFIED: Check the global variable instead of the DOM element
    const selectedLOB = currentGlobalLOB;
   
    const consentInfoSection = document.getElementById('consentInfoSectionInModal');
    const changeConsentGroup = document.getElementById('changeConsentStatusGroup');

    if (selectedLOB === 'AMH') {
        if (consentInfoSection) consentInfoSection.style.display = 'none';
        if (changeConsentGroup) changeConsentGroup.style.display = 'none';
    } else {
        if (consentInfoSection) consentInfoSection.style.display = 'block';
        if (changeConsentGroup) changeConsentGroup.style.display = 'block';
    }

    const title = document.getElementById('serviceNoteTitle');
    const footer = document.getElementById('serviceNoteFooter');
   
    if (viewType === 'full') {
        title.textContent = 'Service Note Details';
        footer.innerHTML = `
            <div style="position: fixed; bottom: 0; left: 0; right: 0; background: white; padding: 16px 20px; border-top: 1px solid #e1e5e9; display: flex; justify-content: flex-end; gap: 12px; z-index: 2001; box-shadow: 0 -2px 10px rgba(0,0,0,0.1);">
                <button class="btn btn-secondary" onclick="closeServiceNoteModal()">Close</button>
                <button class="btn btn-secondary" onclick="toggleEditMode()">Edit</button>
                <button class="btn btn-primary">Continue</button>
            </div>
        `;
       
        document.querySelectorAll('.service-note-section').forEach(sec => sec.style.display = 'block');
        const followUpSection = document.getElementById('followUpAppointmentSection');
        if (followUpSection) followUpSection.style.display = 'block';
       
        setTimeout(() => {
            const consentStatusSelect = document.getElementById('changeConsentStatus');
            if (consentStatusSelect) {
                consentStatusSelect.innerHTML = `
                    <option value="to-obtain-consent">To Obtain Consent</option>
                    <option value="consented">Consented</option>
                    <option value="opted-out">Opted Out</option>
                    <option value="re-consent-required">Re-consent Required</option>
                    <option value="care-mgmt-ended">Care Management Ended</option>
                `;
                const currentStatus = getCurrentConsentStatus();
                consentStatusSelect.value = currentStatus;
            }
           
            const allInputs = document.querySelectorAll('.service-note-body input, .service-note-body select, .service-note-body textarea');
            allInputs.forEach(input => {
                input.disabled = true;
                input.style.backgroundColor = '#f8f9fa';
            });
            isEditMode = false;
        }, 100);

    } else {
        const titles = {
            'mark-consented': 'Mark Member as Consented',
            'opt-out': 'Mark Member as Opted Out',
            'log-contact': 'Log Contact Attempt',
            'reactivate-member': 'Reactivate Member'
        };
        title.textContent = titles[action] || 'Create Service Note';
        footer.innerHTML = `
            <div style="position: fixed; bottom: 0; left: 0; right: 0; background: white; padding: 16px 20px; border-top: 1px solid #e1e5e9; display: flex; justify-content: flex-end; gap: 12px; z-index: 2001; box-shadow: 0 -2px 10px rgba(0,0,0,0.1);">
                <button class="btn btn-secondary" onclick="closeServiceNoteModal()">Cancel</button>
                <button class="btn btn-primary" onclick="saveAndPost()" id="saveAndPostBtn">Save & Post</button>
            </div>
        `;
       
        const followUpSection = document.getElementById('followUpAppointmentSection');
        if (followUpSection) followUpSection.style.display = 'none';
       
        setupConsentStatusDropdown(action);
    }

    modal.classList.add('show');
   
    setTimeout(() => {
        initializeModalFeatures();
    }, 100);
}



function toggleFollowUpFields() {
    const scheduleRadios = document.querySelectorAll('input[name="schedule_followup"]');
    const noSection = document.getElementById('noFollowUpSection');
    const yesSection = document.getElementById('yesFollowUpSection');
   
    let selectedValue = '';
    scheduleRadios.forEach(radio => {
        if (radio.checked) {
            selectedValue = radio.value;
        }
    });
   
    if (selectedValue === 'yes') {
        yesSection.style.display = 'block';
        noSection.style.display = 'none';
    } else {
        yesSection.style.display = 'none';
        noSection.style.display = 'block';
    }
}



function reactivateMember() {
    // Open service note modal for reactivation
    openServiceNoteModal('reactivate-member');
}

// ADD THIS NEW FUNCTION TO YOUR SCRIPT TAG
function switchLineOfBusiness(selectElement) {
    const selectedLOB = selectElement.value;
   
    // ADDED: Update the global variable with the new selection
    currentGlobalLOB = selectedLOB;

    // Get references to all consent-related elements
    const consentCollapsed = document.getElementById('consentStatusCollapsed');
    const consentExpanded = document.getElementById('consentStatusExpanded');
    const consentOverviewSection = document.getElementById('memberConsentOverviewSection');

    if (selectedLOB === 'AMH') {
        // Hide all consent-related elements for Playground AMH
        if (consentCollapsed) consentCollapsed.style.display = 'none';
        if (consentExpanded) consentExpanded.style.display = 'none';
        if (consentOverviewSection) consentOverviewSection.style.display = 'none';
    } else {
        // Show all consent-related elements for TCM
        if (consentCollapsed) consentCollapsed.style.display = 'flex';
        if (consentExpanded) consentExpanded.style.display = 'grid';
        if (consentOverviewSection) consentOverviewSection.style.display = 'block';
    }
}

// Member Header Dynamic Logic
class MemberHeaderManager {
    constructor() {
        this.memberData = {
            consentStatus: 'to-obtain-consent',
            assessments: [],
            carePlans: [],
            riskTier: 2,
            priorityPopulations: ['diabetes', 'frailty'],
            programs: ['tcm', 'diabetes-mgmt']
        };
    }

    testScenario(scenario) {
        switch(scenario) {
            case 'no-consent':
                this.memberData.consentStatus = 'to-obtain-consent';
                this.memberData.assessments = [];
                this.memberData.carePlans = [];
                break;
            case 'consented-no-assessments':
                this.memberData.consentStatus = 'consented';
                this.memberData.assessments = [];
                this.memberData.carePlans = [];
                break;
            case 'single-assessment-active':
                this.memberData.consentStatus = 'consented';
                this.memberData.assessments = [
                    { id: 'hra-1', name: 'Health Risk Assessment', shortName: 'HRA', status: 'in-progress' }
                ];
                this.memberData.carePlans = [];
                break;
            case 'multiple-assessments':
                this.memberData.consentStatus = 'consented';
                this.memberData.assessments = [
                    { id: 'hra-1', name: 'Health Risk Assessment', shortName: 'HRA', status: 'completed' },
                    { id: 'mhsa-1', name: 'Mental Health Screening', shortName: 'MHSA', status: 'in-progress' },
                    { id: 'falls-1', name: 'Falls Risk Assessment', shortName: 'Falls Risk', status: 'planned' }
                ];
                this.memberData.carePlans = [
                    { id: 'dm-plan', name: 'Diabetes Management Plan', shortName: 'Diabetes Plan', status: 'active' },
                    { id: 'wellness-plan', name: 'Wellness Care Plan', shortName: 'Wellness Plan', status: 'planned' }
                ];
                break;
        }
        this.updateDisplay();
    }

    updateDisplay() {
        this.updateConsentStatus();
        this.updateAssessments();
        this.updateCarePlans();
    }

    updateConsentStatus() {
        const display = document.getElementById('consentStatusDisplay');
        if (!display) return;

        const statusConfig = {
            'to-obtain-consent': { text: 'To Obtain Consent', icon: 'orange' },
            'consented': { text: 'Consented', icon: 'green' },
            'opted-out': { text: 'Opted Out', icon: 'red' }
        };
       
        const config = statusConfig[this.memberData.consentStatus];
        display.innerHTML = `
            <span class="status-indicator">
                <span class="status-dot ${config.icon}"></span>
                ${config.text}
            </span>
        `;
    }

}

function toggleMiniCollapse() {
    const header = document.getElementById('memberHeader');
    // Only mini-collapse if we're not already fully expanded
    if (!header.classList.contains('expanded')) {
        header.classList.toggle('mini-collapsed');
    }
}

MemberHeaderManager.prototype.updateAssessments = function() {
    const display = document.getElementById('assessmentsDisplay');
    const countBadge = document.getElementById('assessmentsCount');
   
    if (!display) return;

    if (this.memberData.consentStatus !== 'consented') {
        display.innerHTML = '<span class="status-disabled">Consent Required</span>';
        if (countBadge) countBadge.style.display = 'none';
        return;
    }

    if (this.memberData.assessments.length === 0) {
        display.innerHTML = '<span class="status-disabled">None Started</span>';
        if (countBadge) countBadge.style.display = 'none';
        return;
    }

    // Show count badge
    if (countBadge) {
        countBadge.textContent = this.memberData.assessments.length;
        countBadge.style.display = 'inline-block';
    }

    if (this.memberData.assessments.length === 1) {
        const assessment = this.memberData.assessments[0];
        display.innerHTML = `
            <div class="item-with-status">
                <a href="#" class="assessment-link" title="${assessment.name}" onclick="goToAssessment('${assessment.id}')">${this.truncateName(assessment.name, 15)}</a>
                <span class="status-badge ${assessment.status}">${assessment.status}</span>
            </div>
        `;
    } else {
        display.innerHTML = `
            <div class="multi-item-container">
                ${this.memberData.assessments.slice(0, 2).map(assessment => `
                    <div class="item-with-status">
                        <a href="#" class="assessment-link" title="${assessment.name}" onclick="goToAssessment('${assessment.id}')">${this.truncateName(assessment.name, 12)}</a>
                        <span class="status-badge ${assessment.status}">${assessment.status}</span>
                    </div>
                `).join('')}
                ${this.memberData.assessments.length > 2 ? `<a href="#" class="more-link" onclick="showAllAssessments()">+${this.memberData.assessments.length - 2} more</a>` : ''}
            </div>
        `;
    }
};

MemberHeaderManager.prototype.truncateName = function(name, maxLength) {
    if (name.length <= maxLength) return name;
    return name.substring(0, maxLength) + '...';
};

MemberHeaderManager.prototype.testScenario = function(scenario) {
    switch(scenario) {
        case 'no-consent':
            this.memberData.consentStatus = 'to-obtain-consent';
            this.memberData.assessments = [];
            this.memberData.carePlans = [];
            break;
        case 'consented-no-assessments':
            this.memberData.consentStatus = 'consented';
            this.memberData.assessments = [];
            this.memberData.carePlans = [];
            break;
        case 'single-assessment-active':
            this.memberData.consentStatus = 'consented';
            this.memberData.assessments = [
                { id: 'comprehensive-1', name: 'ComprehensiveFinalUatv1', shortName: 'ComprehensiveFinalUatv1', status: 'in-progress' }
            ];
            this.memberData.carePlans = [];
            break;
        case 'multiple-assessments':
            this.memberData.consentStatus = 'consented';
            this.memberData.assessments = [
                { id: 'comprehensive-1', name: 'ComprehensiveFinalUatv1', shortName: 'ComprehensiveFinalUatv1', status: 'completed' },
                { id: '1915i-1', name: '1915i Assessment', shortName: '1915i Assessment', status: 'in-progress' },
                { id: 'cns-final', name: 'CNS-FinalUATV2', shortName: 'CNS-FinalUATV2', status: 'planned' },
                { id: 'headss', name: 'HEADSS for Adolescents', shortName: 'HEADSS for Adolescents', status: 'completed' },
                { id: 'transitional', name: 'Transitional Care Assessment', shortName: 'Transitional Care Assessment', status: 'in-progress' }
            ];
            this.memberData.carePlans = [
                { id: 'tailored-2', name: 'Tailored Plan 2', shortName: 'Tailored Plan 2', status: 'active' },
                { id: 'comprehensive-care', name: 'Comprehensive Diabetes and Wellness Care Plan', shortName: 'Comprehensive Diabetes and Wellness Care Plan', status: 'planned' },
                { id: 'behavioral-health', name: 'Behavioral Health Integration Plan', shortName: 'Behavioral Health Integration Plan', status: 'active' }
            ];
            break;
    }
    this.updateDisplay();
};

MemberHeaderManager.prototype.updateCarePlans = function() {
    const display = document.getElementById('carePlansDisplay');
    const countBadge = document.getElementById('carePlansCount');
   
    if (!display) return;

    if (this.memberData.consentStatus !== 'consented') {
        display.innerHTML = '<span class="status-disabled">Consent Required</span>';
        if (countBadge) countBadge.style.display = 'none';
        return;
    }

    const hasCompletedAssessment = this.memberData.assessments.some(a => a.status === 'completed');
    if (!hasCompletedAssessment) {
        display.innerHTML = '<span class="status-disabled">Assessment Required</span>';
        if (countBadge) countBadge.style.display = 'none';
        return;
    }

    if (this.memberData.carePlans.length === 0) {
        display.innerHTML = '<span class="status-disabled">None Started</span>';
        if (countBadge) countBadge.style.display = 'none';
        return;
    }

    // Show count badge
    if (countBadge) {
        countBadge.textContent = this.memberData.carePlans.length;
        countBadge.style.display = 'inline-block';
    }

    if (this.memberData.carePlans.length === 1) {
        const plan = this.memberData.carePlans[0];
        display.innerHTML = `
            <div class="item-with-status">
                <a href="#" class="care-plan-link" title="${plan.name}" onclick="goToCarePlan('${plan.id}')">${this.truncateName(plan.name, 15)}</a>
                <span class="status-badge ${plan.status}">${plan.status}</span>
            </div>
        `;
    } else {
        display.innerHTML = `
            <div class="multi-item-container">
                ${this.memberData.carePlans.slice(0, 2).map(plan => `
                    <div class="item-with-status">
                        <a href="#" class="care-plan-link" title="${plan.name}" onclick="goToCarePlan('${plan.id}')">${this.truncateName(plan.name, 12)}</a>
                        <span class="status-badge ${plan.status}">${plan.status}</span>
                    </div>
                `).join('')}
                ${this.memberData.carePlans.length > 2 ? `<a href="#" class="more-link" onclick="showAllCarePlans()">+${this.memberData.carePlans.length - 2} more</a>` : ''}
            </div>
        `;
    }
};

// Initialize the manager



// ADD THIS NEW BLOCK to your script inside the DOMContentLoaded listener

// --- Placeholder Page Handlers ---
function createPlaceholderHTML(pageTitle) {
    // This function creates the placeholder content
    return `
        <div class="page-content" style="margin: 0; display: flex; align-items: center; justify-content: center; height: calc(100vh - 128px);">
            <div class="content-placeholder">
                <h3>${pageTitle}</h3>
                <p>Content for this page is not yet built.</p>
            </div>
        </div>
    `;
}

// Define the pages that will use the placeholder
const placeholderPages = [
    { id: 'navDashboard', name: 'Dashboard' },
    { id: 'navExceptions', name: 'Exceptions' },
    { id: 'navEnrollment', name: 'Enrollment' },
    { id: 'navCircumstance', name: 'Change In Circumstance' },
    { id: 'navADTs', name: 'ADTs' },
    { id: 'navAttestation', name: 'Attestation' },
    { id: 'navAlerts', name: 'Alerts' },
    { id: 'navMessage', name: 'Message' },
    { id: 'navReferrals', name: 'Referrals' },
    { id: 'navAnalytics', name: 'Analytics' },
    { id: 'navSchedule', name: 'Schedule' },
    { id: 'navPopulations', name: 'Populations' }
];

// Loop through and attach a generic click event listener to each
placeholderPages.forEach(page => {
    const navElement = document.getElementById(page.id);
    if (navElement) {
        navElement.addEventListener('click', (event) => {
            event.preventDefault();
            document.getElementById('pageContainer').innerHTML = createPlaceholderHTML(page.name);
            updateBreadcrumbs(`Home > ${page.name}`);
            updateActiveNavItem(page.id);
        });
    }
});

function toggleKeyInfo() {
    const header = document.getElementById('memberHeader');
    const keyInfoSection = document.getElementById('memberKeyInfo');
   
    if (header.classList.contains('key-info-collapsed')) {
        header.classList.remove('key-info-collapsed');
        keyInfoSection.style.display = 'flex';
    } else {
        header.classList.add('key-info-collapsed');
        keyInfoSection.style.display = 'none';
    }
}


// ADD THIS NEW FUNCTION
function toggleRecentActivityDropdown() {
    const dropdown = document.getElementById('recentItemsDropdown');
    if (!dropdown) return;

    // If the dropdown is about to be shown, render its content first
    if (!dropdown.classList.contains('show')) {
        RecentItemsManager.renderDropdown();
    }
    
    // Now, toggle the 'show' class to make it appear or disappear
    dropdown.classList.toggle('show');

    // Also, ensure the user profile dropdown is closed
    document.getElementById('userDropdown')?.classList.remove('show');
}

// Navigation functions
function goToAssessment(assessmentId) {
    console.log(`Navigate to assessment: ${assessmentId}`);
}

function goToCarePlan(planId) {
    console.log(`Navigate to care plan: ${planId}`);
}

function goToPriorityPop(popId) {
    console.log(`Navigate to priority population: ${popId}`);
}

function goToProgram(programId) {
    console.log(`Navigate to program: ${programId}`);
}

function showAllAssessments() {
    const assessments = headerManager.memberData.assessments;
    showDetailModal('All Assessments', assessments, 'assessment');
}

function showAllCarePlans() {
    const carePlans = headerManager.memberData.carePlans;
    showDetailModal('All Care Plans', carePlans, 'care-plan');
}

function showDetailModal(title, items, type) {
    const modal = document.createElement('div');
    modal.style.cssText = `
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0, 0, 0, 0.5); display: flex; align-items: center; justify-content: center; z-index: 3000;
    `;
   
    modal.innerHTML = `
        <div style="background: white; border-radius: 8px; padding: 24px; max-width: 600px; width: 90%; max-height: 80vh; overflow-y: auto;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 1px solid #eee; padding-bottom: 16px;">
                <h3 style="margin: 0; color: #333;">${title} (${items.length})</h3>
                <button onclick="closeDetailModal()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: #666;">&times;</button>
            </div>
            <div style="display: flex; flex-direction: column; gap: 16px;">
                ${items.map(item => `
                    <div style="border: 1px solid #e1e5e9; border-radius: 8px; padding: 16px; display: flex; justify-content: space-between; align-items: flex-start;">
                        <div style="flex: 1;">
                            <div style="font-weight: 600; color: #333; margin-bottom: 4px;">
                                <a href="#" style="color: #353182; text-decoration: none;" onclick="${type === 'assessment' ? `goToAssessment('${item.id}')` : `goToCarePlan('${item.id}')`}">${item.name}</a>
                            </div>
                            <div style="font-size: 12px; color: #666;">
                                ID: ${item.id}  Last Updated: ${getRandomDate()}
                            </div>
                        </div>
                        <div style="margin-left: 16px;">
                            <span class="status-badge ${item.status}" style="padding: 4px 8px; border-radius: 12px; font-size: 11px; font-weight: 600; text-transform: uppercase;">${item.status}</span>
                        </div>
                    </div>
                `).join('')}
            </div>
            <div style="margin-top: 20px; display: flex; justify-content: flex-end; gap: 12px;">
                <button onclick="closeDetailModal()" style="padding: 8px 16px; background: #f8f9fa; border: 1px solid #ddd; border-radius: 4px; cursor: pointer;">Close</button>
            </div>
        </div>
    `;
   
    modal.id = 'detailModal';
    document.body.appendChild(modal);
}

function closeDetailModal() {
    const modal = document.getElementById('detailModal');
    if (modal) document.body.removeChild(modal);
}

function printAllAssessments() {
    console.log('Export assessments list');
    alert('Would export/print assessments list');
    closeDetailModal();
}

function printAllCarePlans() {
    console.log('Export care plans list');
    alert('Would export/print care plans list');
    closeDetailModal();
}


function getRandomDate() {
    const dates = ['12/15/2024', '01/20/2025', '02/10/2025', '03/05/2025'];
    return dates[Math.floor(Math.random() * dates.length)];
}

let headerManager = new MemberHeaderManager();

function openHeaderTestModal() {
    const modal = document.createElement('div');
    modal.style.cssText = `
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0, 0, 0, 0.5); display: flex; align-items: center; justify-content: center; z-index: 3000;
    `;
   
    modal.innerHTML = `
        <div style="background: white; border-radius: 8px; padding: 24px; max-width: 500px; width: 90%;">
            <h3 style="margin-bottom: 20px;">Test Header Scenarios</h3>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                <button onclick="headerManager.testScenario('no-consent'); closeHeaderTestModal();" class="btn btn-secondary">No Consent</button>
                <button onclick="headerManager.testScenario('consented-no-assessments'); closeHeaderTestModal();" class="btn btn-primary">Consented - No Assessments</button>
                <button onclick="headerManager.testScenario('single-assessment-active'); closeHeaderTestModal();" class="btn btn-secondary">Single Assessment Active</button>
                <button onclick="headerManager.testScenario('multiple-assessments'); closeHeaderTestModal();" class="btn btn-primary">Multiple Assessments & Plans</button>
            </div>
            <button onclick="closeHeaderTestModal()" style="margin-top: 20px; width: 100%; padding: 8px; background: #f8f9fa; border: 1px solid #ddd; border-radius: 4px;">Close</button>
        </div>
    `;
   
    modal.id = 'headerTestModal';
    document.body.appendChild(modal);
}

function closeHeaderTestModal() {
    const modal = document.getElementById('headerTestModal');
    if (modal) document.body.removeChild(modal);
}


function openHeaderTestModal() {
    const modal = document.createElement('div');
    modal.style.cssText = `
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0, 0, 0, 0.5); display: flex; align-items: center; justify-content: center; z-index: 3000;
    `;
   
    modal.innerHTML = `
        <div style="background: white; border-radius: 8px; padding: 24px; max-width: 500px; width: 90%;">
            <h3 style="margin-bottom: 20px;">Test Header Scenarios</h3>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                <button onclick="headerManager.testScenario('no-consent')" class="btn btn-secondary">No Consent</button>
                <button onclick="headerManager.testScenario('consented-no-assessments')" class="btn btn-primary">Consented - No Assessments</button>
                <button onclick="headerManager.testScenario('single-assessment-active')" class="btn btn-secondary">Single Assessment Active</button>
                <button onclick="headerManager.testScenario('multiple-assessments')" class="btn btn-primary">Multiple Assessments & Plans</button>
            </div>
            <button onclick="closeHeaderTestModal()" style="margin-top: 20px; width: 100%; padding: 8px; background: #f8f9fa; border: 1px solid #ddd; border-radius: 4px;">Close</button>
        </div>
    `;
   
    modal.id = 'headerTestModal';
    document.body.appendChild(modal);
}

// Ensure toggle button is clickable after page load
document.addEventListener('DOMContentLoaded', function() {
    const sidebar = document.getElementById('sidebar');
    const flyoutMenu = document.getElementById('flyoutMenu');
    const toggleBtn = document.querySelector('.member-toggle .toggle-btn');
    if (toggleBtn) {
    toggleBtn.addEventListener('click', () => {
        sidebar.classList.toggle('collapsed');
        flyoutMenu.classList.remove('show');

        // Update drawer position if it's open
        const drawer = document.getElementById('configDrawer');
        if (drawer && drawer.classList.contains('show')) {
            if (sidebar.classList.contains('collapsed')) {
                drawer.classList.add('from-collapsed');
            } else {
                drawer.classList.remove('from-collapsed');
            }
        }
    });
}
});





// === FINAL SCRIPT (VERSION 2) ===

// Standalone function to create and show the test modal
function openTestScenarioModal() {
    // Remove existing modal if it's there
    const existingModal = document.getElementById('test-scenario-modal');
    if (existingModal) existingModal.remove();

    const modal = document.createElement('div');
    modal.id = 'test-scenario-modal';
    modal.className = 'items-modal-overlay';
    
    modal.innerHTML = `
    <div class="items-modal-content" style="max-width: 400px;">
        <div class="items-modal-header">
            <h3 style="margin:0;">Test Header Scenarios</h3>
            <button onclick="this.closest('.items-modal-overlay').remove()" style="background:none; border:none; font-size: 24px; cursor:pointer;">&times;</button>
        </div>
        <div class="items-modal-body" style="display: flex; flex-direction: column; gap: 12px;">
            <button class="btn btn-secondary" data-scenario="lob_only">LOB Only</button>
            <button class="btn btn-secondary" data-scenario="lob_programs">LOB + Programs</button>
            <button class="btn btn-primary" data-scenario="lob_programs_pops">LOB + Programs + Pops</button>
        </div>
    </div>`;

    document.body.appendChild(modal);

    modal.querySelectorAll('button[data-scenario]').forEach(btn => {
        btn.addEventListener('click', (e) => {
            const scenario = e.target.dataset.scenario;
            MemberHeaderController.render(scenario);
            modal.remove(); // Close modal on selection
        });
    });
}






// === FINAL SCRIPT (VERSION 11 - FULLY CONSOLIDATED) ===

const MemberHeaderController = {
    // --- STATE & SCENARIOS ---
    displayedMedicaidId: 'Medicaid ID: LEAPAug2024DK11',
    memberScenarios: {
        '1_lob_only': { lob: [{ name: 'Covered Lives', risk: 'Low', consent: { status: 'Consented', date: '09/26/2025' }, assessments: [{ id: 'hra-1', name: 'Health Risk Assessment (HRA)', status: 'in-progress'}], carePlans: [{ id: 'scp-1', name: 'Standard Care Plan', status: 'active' }] }], programs: [], populations: [] },
        'just_1_prog': { lob: [], programs: [ { name: 'Chronic Care Management', risk: 'Medium', consent: null, assessments: [{ id: 'ccma-1', name: 'CCM Initial Assessment', status: 'in-progress' }], carePlans: [] } ], populations: [] },
        'just_2_pop': { lob: [], programs: [], populations: [ { name: 'High Risk Pregnancy', risk: 'High', consent: { status: 'Consented', date: '09/01/2025' }, assessments: [{ id: 'pr-assess', name: 'Prenatal Risk Assessment', status: 'completed'}], carePlans: [{id: 'mcp-1', name: 'Maternal Care Plan', status: 'active'}] }, { name: 'NICU', risk: 'High', consent: null, assessments: [{ id: 'nicu-screen', name: 'NICU Discharge Screening', status: 'planned'}], carePlans: [] } ] },
        '1_lob_3_prog': { lob: [ { name: 'Healthy Blue', risk: 'Low', consent: { status: 'Consented', date: '07/01/2025' }, assessments: [{ id: 'hbwv-1', name: 'Healthy Blue Wellness Visit', status: 'completed' }, { id: 'hbwv-2', name: 'HB Follow-up', status: 'in-progress'}], carePlans: [{ id: 'hbp-1', name: 'Healthy Blue Plan of Care', status: 'active' }] } ], programs: [ { name: 'Remote Patient Monitoring', risk: 'Medium', consent: null, assessments: [{ id: 'rpm-setup-1', name: 'RPM Device Setup Review', status: 'completed' }], carePlans: [{ id: 'rpm-cp-1', name: 'RPM Monitoring Plan', status: 'active' }, { id: 'rpm-cp-2', name: 'RPM Adherence Plan', status: 'planned'}] }, { name: 'Behavioral Health Integration', risk: 'Medium', consent: { status: 'To Obtain Consent' }, assessments: [], carePlans: [] }, { name: 'Chronic Care Management', risk: 'Medium', consent: null, assessments: [{ id: 'ccma-1', name: 'CCM Initial Assessment', status: 'in-progress' }], carePlans: [] } ], populations: [] },
        '2_lob_1_prog_2_pop': { lob: [ { name: 'AMH', risk: 'Medium', consent: { status: 'To Obtain Consent' }, assessments: [{ id: 'amh-initial', name: 'AMH Initial Screening', status: 'completed'}], carePlans: [{ id: 'amh-cp', name: 'AMH Treatment Plan', status: 'active'}]}, { name: 'Uncovered Lives', risk: 'Low', consent: { status: 'Consented', date: '09/26/2025' }, assessments: [{ id: 'ul-hra', name: 'UL Health Risk Assessment', status: 'in-progress'}], carePlans: [] }, ], programs: [ { name: 'Behavioral Health Integration', risk: 'Medium', consent: { status: 'Consented', date: '09/20/2025' }, assessments: [{ id: 'phq9-1', name: 'PHQ-9 Depression Screening', status: 'completed' }, {id: 'gad7-1', name: 'GAD-7 Anxiety Screening', status: 'completed'}, {id: 'audit-1', name: 'AUDIT-C Screening', status: 'in-progress'}], carePlans: [{ id: 'bhip-2', name: 'Behavioral Health Action Plan', status: 'active' }] } ], populations: [ { name: 'Substance Abuse', risk: 'High', consent: null, assessments: [{ id: 'dast-10', name: 'DAST-10 Screening', status: 'in-progress'}], carePlans: [] }, { name: 'High Risk Pregnancy', risk: 'High', consent: { status: 'Consented', date: '09/01/2025' }, assessments: [{ id: 'pr-assess', name: 'Prenatal Risk Assessment', status: 'completed'}], carePlans: [{id: 'mcp-1', name: 'Maternal Care Plan', status: 'active'}] } ] },
        '3_lob_2_prog_3_pop': { lob: [ { name: 'North Carolina', risk: 'Low', consent: { status: 'Consented', date: '08/15/2025' }, assessments: [{ id: 'ncsa-1', name: 'NC State Assessment', status: 'completed' }], carePlans: [{ id: 'nctp-1', name: 'NC Tailored Care Plan', status: 'active' }] }, { name: 'Covered Lives', risk: 'Low', consent: { status: 'Consented', date: '09/26/2025' }, assessments: [{ id: 'hra-1', name: 'Health Risk Assessment (HRA)', status: 'in-progress'}], carePlans: [{ id: 'scp-1', name: 'Standard Care Plan', status: 'active' }] }, { name: 'Healthy Blue', risk: 'Medium', consent: { status: 'To Obtain Consent' }, assessments: [], carePlans: [] } ], programs: [ { name: 'Remote Patient Monitoring', risk: 'Medium', consent: null, assessments: [{ id: 'rpm-setup-1', name: 'RPM Device Setup Review', status: 'completed' }], carePlans: [{ id: 'rpm-cp-1', name: 'RPM Monitoring Plan', status: 'active' }] }, { name: 'Behavioral Health Integration', risk: 'Medium', consent: { status: 'To Obtain Consent' }, assessments: [], carePlans: [] } ], populations: [ { name: 'Multi-chronic Conditions', risk: 'High', consent: null, assessments: [{ id: 'mcc-assess', name: 'MCC Comprehensive Assessment', status: 'planned' }], carePlans: [] }, { name: 'NICU', risk: 'High', consent: null, assessments: [{ id: 'nicu-screen', name: 'NICU Discharge Screening', status: 'planned'}, {id: 'nicu-followup', name: 'NICU Follow-Up', status: 'planned'}], carePlans: [] }, { name: 'Substance Abuse', risk: 'High', consent: null, assessments: [{ id: 'audit-c', name: 'AUDIT-C Screening', status: 'in-progress'}], carePlans: [] } ] }
    },

    init: function() {
        // This is intentionally left blank. Rendering is triggered by `MapsToDetails`.
    },


     // Add this new property at the top of the MemberHeaderController object
    displayedIds: null, 

    // Add this new helper function inside the MemberHeaderController object
    _reRenderIdentityBar: function() {
        // This function assumes 'currentMember' is accessible in the window scope
        // when a member's detail page is loaded.
        const member = window.currentMember; 
        if (!member) return;

        const identityBarContainer = document.getElementById('identity-section');
        if (identityBarContainer) {
            identityBarContainer.innerHTML = this._buildIdentityBarHTML(member);
        }
    },  

    openTestScenarioModal: function() {
        const existingModal = document.getElementById('test-scenario-modal');
        if (existingModal) existingModal.remove();
        const modal = document.createElement('div');
        modal.id = 'test-scenario-modal';
        modal.className = 'items-modal-overlay';
        let buttonsHtml = '';
        for (const key in this.memberScenarios) {
            const label = key.replace(/_/g, ' ').replace('lob', 'LOB').replace('prog', 'Prog').replace('pop', 'Pop');
            buttonsHtml += `<button class="btn btn-secondary" data-scenario="${key}" style="text-transform: capitalize;">${label}</button>`;
        }
        modal.innerHTML = `<div class="items-modal-content" style="max-width: 500px;"><div class="items-modal-header"><h3 style="margin:0;">Test Header Scenarios</h3><button onclick="this.closest('.items-modal-overlay').remove()" style="background:none; border:none; font-size: 24px; cursor:pointer;">&times;</button></div><div class="items-modal-body" style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">${buttonsHtml}</div></div>`;
        document.body.appendChild(modal);
        modal.querySelectorAll('button[data-scenario]').forEach(btn => {
            btn.addEventListener('click', (e) => {
                const scenario = e.target.dataset.scenario;
                const memberData = membersDB.find(m => m.id === selectedMemberId);
                if (memberData) {
                    memberData.headerData = this.memberScenarios[scenario];
                    populateHeader(memberData);
                }
                modal.remove();
            });
        });
    },
    

    // Replace the _buildIdentityBarHTML function inside the MemberHeaderController object

_buildIdentityBarHTML: function(member) {
    const allIds = [
        { type: 'Medicaid ID', value: member.id },
        { type: 'Medicare ID (MBI)', value: '4TE5-G67-JK89' },
        { type: 'MRN', value: member.mrn },
        { type: 'HICN (Old Medicare)', value: '123456789A' },
        { type: 'Commercial Member ID', value: '789456123' },
        { type: 'Commercial Group ID', value: 'GRP-UHC-9876' },
        { type: 'State Client ID (CIN)', value: 'NC-45-678-9012' },
        { type: 'SSN', value: '***-**-5678' }
    ];

    if (!this.displayedIds) {
        this.displayedIds = allIds.slice(0, 3).map(id => `${id.type}: ${id.value}`);
    }

    let displayedIdsHtml = this.displayedIds.map(idString => {
        // Add the title attribute for the hover tooltip
        return `
        <div class="id-item">
            <svg fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M5 4a3 3 0 00-3 3v6a3 3 0 003 3h10a3 3 0 003-3V7a3 3 0 00-3-3H5zm-1 9v-1h5v2H5a1 1 0 01-1-1zm7 1h4a1 1 0 001-1v-1h-5v2zm0-4h5V8h-5v2zM4 8h5v2H4V8z" clip-rule="evenodd"></path></svg>
            <span title="${idString}">${idString}</span>
        </div>
        `;
    }).join('');

    return `
    <div class="identity-bar">
        <div class="member-name"><svg fill="currentColor" viewBox="0 0 20 20" style="width:20px;height:20px;"><path fill-rule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" clip-rule="evenodd"></path></svg>${member.name}</div><div class="header-separator"></div>
        <div class="id-item"><svg fill="currentColor" viewBox="0 0 20 20"><path d="M13 6a3 3 0 11-6 0 3 3 0 016 0zM18 8a2 2 0 11-4 0 2 2 0 014 0zM14 15a4 4 0 00-8 0v3h8v-3zM6 8a2 2 0 11-4 0 2 2 0 014 0zM16 18v-3a5.972 5.972 0 00-.75-2.906A3.005 3.005 0 0119 15v3h-3zM4.75 12.094A5.973 5.973 0 004 15v3H1v-3a3 3 0 013.75-2.906z"></path></svg>Care Manager: ${member.careManager || 'John Manager 12'}</div>
        <div class="header-separator"></div>
        <div class="id-group">
            ${displayedIdsHtml}
            <button class="more-ids-btn" onclick="MemberHeaderController.showIdsModal()">+${allIds.length - this.displayedIds.length} more</button>
        </div>
        
        <button class="notes-btn" onclick="openMemberNotes()"><svg fill="currentColor" viewBox="0 0 20 20" style="width:16px;height:16px;"><path d="M17.414 2.586a2 2 0 00-2.828 0L7 10.172V13h2.828l7.586-7.586a2 2 0 000-2.828z"></path><path fill-rule="evenodd" d="M2 6a2 2 0 012-2h4a1 1 0 010 2H4v10h10v-4a1 1 0 112 0v4a2 2 0 01-2 2H4a2 2 0 01-2-2V6z" clip-rule="evenodd"></path></svg>Member Notes</button>
    </div>`;
},
    
    _buildMainCardAccordionHTML: function(headerData) {
        const sections = [
            { title: 'Line of Business', data: headerData.lob, key: 'lob' },
            { title: 'Programs', data: headerData.programs, key: 'programs' },
            { title: 'Priority Populations', data: headerData.populations, key: 'populations' }
        ].filter(s => s.data && s.data.length > 0);
        
        if (sections.length === 0) return '<div style="padding: 16px; color: #666;">No LOB, Program, or Population data for this member.</div>';
        
        return `<div class="card-accordion-section open"><div class="card-accordion-header"><div class="card-accordion-title-group">${sections.map(s => `<span>${s.title} (${s.data.length})</span>`).join('')}</div><svg class="card-accordion-arrow" width="20" height="20" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd"></path></svg></div><div class="card-accordion-content">${sections.map(s => `<div class="card-group" data-group="${s.key}" data-current-index="0">${s.data.map(item => this._buildCardHTML(item, s.title, s.key, s.data)).join('')}</div>`).join('')}</div></div>`;
    },

    _buildCardHTML: function(item, groupTitle, groupKey, allItems) {
        // Handle strings (programs, populations) vs objects (lob)
        const isString = typeof item === 'string';
        const itemName = isString ? item : (item.name || 'Unknown');
        const itemRisk = isString ? null : (item.risk || null);
        
        let consentHtml = '';
        if (!isString && item.consent) {
            const consentColor = item.consent.status === 'Consented' ? 'green' : (item.consent.status === 'Re-consent Required' ? 'orange' : (item.consent.status === 'To Obtain Consent' ? 'orange' : 'red'));
            const consentValue = `<span style="font-weight: 500; color: ${consentColor === 'green' ? '#28a745' : (consentColor === 'orange' ? '#ff8c00' : '#dc3545')}">${item.consent.status}</span>`;
            consentHtml = this._buildJourneyItem('Consent', consentValue, [], item.consent.date, consentColor);
        }
        
        const riskHtml = itemRisk ? `<div class="risk-category">Risk Category: <span class="risk-category-display risk-${itemRisk.toLowerCase()}">${itemRisk} Risk</span></div>` : '';
        const assessmentsHtml = !isString && item.assessments ? this._buildJourneyItem('Assessments', null, item.assessments, null, 'orange') : '';
        const carePlansHtml = !isString && item.carePlans ? this._buildJourneyItem('Care Plans', null, item.carePlans, null, 'orange') : '';
        
        return `
        <div class="context-card">
            <div class="card-header"><span class="card-title">${groupTitle}: ${itemName}</span><div class="card-nav" data-group="${groupKey}" style="${allItems.length > 1 ? '' : 'display:none;'}"><button class="card-nav-btn prev">&lt;</button> <button class="card-nav-btn next">&gt;</button></div></div>
            <div class="card-body">
                ${riskHtml}
                ${consentHtml}
                ${assessmentsHtml}
                ${carePlansHtml}
            </div>
        </div>`;
    },
    _buildOtherInfoAccordionHTML: function(member) {
    // Helper to format the languages array into a string
    const languages = member.communication.languages ? member.communication.languages.join(', ') : 'N/A';

    return `
    <div class="other-info-accordion">
        <div class="accordion-header">
            <span class="accordion-title">Other Information</span>
            <svg class="accordion-arrow" width="20" height="20" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd"></path>
            </svg>
        </div>
        <div class="accordion-content" style="display:none; padding: 16px;">
            <div class="other-info-grid">
                
                <div>
                    <h4 class="other-info-title">MEMBER DETAILS</h4>
                    <div class="info-pair"><span class="info-label">DOB</span><span class="info-value">${member.dob || 'N/A'}</span></div>
                    <div class="info-pair"><span class="info-label">DOD</span><span class="info-value">${member.dod || 'N/A'}</span></div>
                    <div class="info-pair"><span class="info-label">PHONE NUMBER</span><span class="info-value">${member.cellPhone || member.homePhone || 'N/A'}</span></div>
                    <div class="info-pair"><span class="info-label">EMAIL</span><span class="info-value">${member.email || 'N/A'}</span></div>
                    <div class="info-pair"><span class="info-label">ADDRESS</span><span class="info-value">${member.address || ''}, ${member.city || ''}</span></div>
                </div>
                
                <div>
                    <h4 class="other-info-title">CARE TEAM & PCP</h4>
                    <div class="info-pair"><span class="info-label">CARE MANAGER</span><span class="info-value">${member.careManager || 'Unassigned'}</span></div>
                    <div class="info-pair"><span class="info-label">ASSIGNED DATE</span><span class="info-value">${member.careMgmtStart ? new Date(member.careMgmtStart).toLocaleDateString() : 'N/A'}</span></div>
                    <div class="info-pair"><span class="info-label">PCP</span><span class="info-value">WAYNE HEART & INTERNAL MEDICINE</span></div>
                    <div class="info-pair"><span class="info-label">PRIMARY DIAGNOSIS</span><span class="info-value">${member.diagnoses.primary || 'N/A'}</span></div>
                </div>

                <div>
                    <h4 class="other-info-title">INSURANCE & ENROLLMENT</h4>
                    <div class="info-pair"><span class="info-label">CONSENT STATUS</span><span class="info-value">${member.consentStatus || 'N/A'}</span></div>
                    <div class="info-pair"><span class="info-label">ENROLLMENT STATUS</span><span class="info-value">${member.memberStatus || 'N/A'}</span></div>
                    <div class="info-pair"><span class="info-label">INSURANCE COMPANY</span><span class="info-value">${member.mco || 'N/A'}</span></div>
                    <div class="info-pair"><span class="info-label">PLAN NAME</span><span class="info-value">Tailored Plan</span></div>
                    <div class="info-pair"><span class="info-label">PLAN SUB TYPE</span><span class="info-value">PHBP</span></div>
                </div>

                <div>
                    <h4 class="other-info-title">COMMUNICATION & PREFERENCES</h4>
                    <div class="info-pair"><span class="info-label">LANGUAGE PREFERENCE</span><span class="info-value">${member.communication.preferredLanguage || 'N/A'}</span></div>
                    <div class="info-pair"><span class="info-label">LANGUAGES SPOKEN</span><span class="info-value">${languages}</span></div>
                    <div class="info-pair"><span class="info-label">COMMUNICATION METHOD</span><span class="info-value">${member.communication.method || 'N/A'}</span></div>
                    <div class="info-pair"><span class="info-label">RACE/ETHNICITY</span><span class="info-value">${member.race || 'N/A'}</span></div>
                    <div class="info-pair"><span class="info-label">MARITAL STATUS</span><span class="info-value">Married</span></div>
                </div>

            </div>

            <!-- Care Management Details sub-section -->
            <div id="cm-details-in-other-info" style="margin-top:16px;border-top:1px solid #e2e8f0;padding-top:16px;"></div>

        </div>
    </div>`;
},

    _buildJourneyItem: function(label, directValue, allItems, date, dotColor) {
        const items = allItems || [];
        const hasItems = items.length > 0;
        let valueHtml = directValue;
        if (!directValue) {
            valueHtml = hasItems ? `<a href="#" onclick="return false;">${items[0].name}</a>` : 'Not Available';
        }
        const moreCount = hasItems && items.length > 1 ? items.length - 1 : 0;
        return `<div class="journey-item"><div class="status-dot ${dotColor || 'grey'}"></div><div class="item-label">${label}:</div><div class="item-value ${valueHtml === 'Not Available' ? 'not-available' : ''}">${valueHtml}</div>${date ? `<div class="item-date">Consent date: ${date}</div>` : ''}${moreCount > 0 ? `<div class="item-more" onclick="MemberHeaderController.showItemsModal('${label}', '${btoa(JSON.stringify(items))}')">+${moreCount} more</div>` : ''}</div>`;
    },
    
    _addEventListeners: function() {
        document.querySelectorAll('.card-accordion-header, .other-info-accordion .accordion-header').forEach(header => {
            header.addEventListener('click', (e) => {
                const section = e.currentTarget.parentElement;
                section.classList.toggle('open');
                const content = section.querySelector('.card-accordion-content, .accordion-content');
                if (content) content.style.display = section.classList.contains('open') ? (content.classList.contains('card-accordion-content') ? 'grid' : 'block') : 'none';
            });
        });
        document.querySelectorAll('.card-group').forEach(group => {
            const firstCard = group.querySelector('.context-card');
            if (firstCard) firstCard.classList.add('active');
        });
        document.querySelectorAll('.card-nav-btn').forEach(button => {
            button.addEventListener('click', (e) => {
                e.stopPropagation();
                const groupDiv = e.target.closest('.card-group');
                if (!groupDiv) return;
                const cards = groupDiv.querySelectorAll('.context-card');
                let currentIndex = parseInt(groupDiv.dataset.currentIndex);
                cards[currentIndex].classList.remove('active');
                if (e.target.classList.contains('next')) { currentIndex = (currentIndex + 1) % cards.length; } 
                else { currentIndex = (currentIndex - 1 + cards.length) % cards.length; }
                cards[currentIndex].classList.add('active');
                groupDiv.dataset.currentIndex = currentIndex;
            });
        });
    },

    showItemsModal: function(title, itemsData) {
        const items = JSON.parse(atob(itemsData));
        const existingModal = document.getElementById('items-modal-overlay'); if (existingModal) existingModal.remove();
        const modal = document.createElement('div'); modal.id = 'items-modal-overlay'; modal.className = 'items-modal-overlay'; modal.onclick = (e) => { if (e.target.id === 'items-modal-overlay') modal.remove(); };
        modal.innerHTML = `<div class="items-modal-content"><div class="items-modal-header"><h3 style="margin:0;">All ${title} (${items.length})</h3><button onclick="document.getElementById('items-modal-overlay').remove()" style="background:none; border:none; font-size: 24px; cursor:pointer;">&times;</button></div><div class="items-modal-body">${items.map(item => `<div class="items-modal-list-item"><div><a href="#" onclick="return false;">${item.name}</a><div style="font-size: 12px; color: #666; margin-top: 4px;">ID: ${item.id} | Last Updated: 09/15/2025</div></div><span class="status-badge-modal ${item.status || 'completed'}">${item.status || 'completed'}</span></div>`).join('')}</div></div>`;
        document.body.appendChild(modal);
    },

    showIdsModal: function() {
        const existingModal = document.getElementById('ids-modal-overlay');
        if (existingModal) existingModal.remove();

        const member = window.currentMember; // Assumes currentMember is accessible
        if (!member) {
            console.error("Current member data not found.");
            return;
        }

        const allIds = [
            { type: 'Medicaid ID', value: member.id },
            { type: 'Medicare ID (MBI)', value: '4TE5-G67-JK89' },
            { type: 'MRN', value: member.mrn },
            { type: 'HICN (Old Medicare)', value: '123456789A' },
            { type: 'Commercial Member ID', value: '789456123' },
            { type: 'Commercial Group ID', value: 'GRP-UHC-9876' },
            { type: 'State Client ID (CIN)', value: 'NC-45-678-9012' },
            { type: 'SSN', value: '***-**-5678' }
        ];

        const modal = document.createElement('div');
        modal.id = 'ids-modal-overlay';
        modal.className = 'items-modal-overlay';

        let optionsHtml = allIds.map(id => {
            const fullIdString = `${id.type}: ${id.value}`;
            const isChecked = this.displayedIds.includes(fullIdString);
            return `<label style="display: block; padding: 10px; border: 1px solid #ddd; border-radius: 4px; margin-bottom: 8px; cursor: pointer;">
                        <input type="checkbox" name="displayed-id-chk" value="${fullIdString}" ${isChecked ? 'checked' : ''}> 
                        <strong>${id.type}:</strong> ${id.value}
                    </label>`;
        }).join('');

        modal.innerHTML = `
            <div class="items-modal-content" style="max-width: 500px;">
                <div class="items-modal-header">
                    <h3 style="margin:0;">Select up to 3 IDs to Display</h3>
                    <button onclick="this.closest('.items-modal-overlay').remove()" style="background:none; border:none; font-size: 24px; cursor:pointer;">&times;</button>
                </div>
                <div class="items-modal-body">${optionsHtml}</div>
                <div style="margin-top: 16px; text-align: right;">
                    <button id="update-id-btn" class="btn btn-primary">Update</button>
                </div>
            </div>`;

        document.body.appendChild(modal);

        // Add event listener to limit checkbox selection to 3
        const checkboxes = modal.querySelectorAll('input[name="displayed-id-chk"]');
        checkboxes.forEach(checkbox => {
            checkbox.addEventListener('change', (e) => {
                const checkedCount = modal.querySelectorAll('input[name="displayed-id-chk"]:checked').length;
                if (checkedCount > 3) {
                    e.target.checked = false;
                    alert('You can only select up to 3 IDs to display.');
                }
            });
        });

        // Update button logic
        document.getElementById('update-id-btn').addEventListener('click', () => {
            const selectedCheckboxes = modal.querySelectorAll('input[name="displayed-id-chk"]:checked');
            
            // Validate selection
            if (selectedCheckboxes.length > 3 || selectedCheckboxes.length === 0) {
                alert('Please select between 1 and 3 IDs.');
                return;
            }

            // Update the stored list of displayed IDs
            this.displayedIds = Array.from(selectedCheckboxes).map(cb => cb.value);
            
            // Re-render the header to show the changes
            this._reRenderIdentityBar(); 
            modal.remove();
        });
    },
};


// Function to toggle the sidebar from the header icon
// Function to toggle the sidebar from the new header icon
function toggleContextualSidebar() {
    const sidebar = document.getElementById('contextualSidebar');
    // Removed assessmentContent reference to prevent errors
    
    if (sidebar) {
        sidebar.classList.toggle('active');
    }
}


// Helper function to Show/Hide the Quick Links button
function toggleQuickLinksButton(show) {
    const btn = document.getElementById('headerQuickLinksBtn'); 
    const sep = document.getElementById('quickLinksSeparator'); // Get the separator
    const sidebar = document.getElementById('contextualSidebar');
    
    if (btn) {
        btn.style.display = show ? 'flex' : 'none';
    }

    // Toggle the separator visibility to match the button
    if (sep) {
        sep.style.display = show ? 'block' : 'none';
    }
    
    // Force close sidebar if we are hiding the button (navigating away)
    if (!show && sidebar && sidebar.classList.contains('active')) {
        sidebar.classList.remove('active');
    }
}


    // REPLACE your old RecentItemsManager with this one
// REPLACE your old RecentItemsManager with this one


// ADD these new functions for the All Activity page
function showAllActivityPage() {
    const pageContainer = document.getElementById('pageContainer');
    if (!pageContainer) return;

    // FIX: Changed RecentItemsManager to ActivityTracker
    const allItems = ActivityTracker.get();
    let contentHTML = '';

    if (allItems.length === 0) {
        contentHTML = `<div class="info-message" style="margin-top: 24px;">There is no recent activity to display.</div>`;
    } else {
        contentHTML = `
            <div class="filters-area" style="margin-bottom: 20px;">
                <strong>Filters:</strong>
                <input type="date" id="filterDateFrom" style="padding: 6px; border: 1px solid #ced4da; border-radius: 4px;" placeholder="dd/mm/yyyy">
                <input type="date" id="filterDateTo" style="padding: 6px; border: 1px solid #ced4da; border-radius: 4px;" placeholder="dd/mm/yyyy">
            </div>
            <div class="table-wrapper">
                <table class="member-table">
                    <thead><tr><th style="width: 70%;">Event</th><th>Date & Time</th></tr></thead>
                    <tbody id="activityTableBody"></tbody>
                </table>
            </div>
        `;
    }

    const pageHTML = `
        <div class="page-content" style="margin: 0; padding: 24px;">
            <h2 style="font-size: 24px; font-weight: 600; margin-bottom: 24px;">Recent Activity</h2>
            ${contentHTML}
        </div>`;

    pageContainer.innerHTML = pageHTML;

    if (allItems.length > 0) {
        // FIX: Changed to call methods on the correct object
        ActivityTracker.populateActivityTable(allItems);
        document.getElementById('filterDateFrom').addEventListener('change', () => ActivityTracker.filterActivityTable());
        document.getElementById('filterDateTo').addEventListener('change', () => ActivityTracker.filterActivityTable());

        // This adds the missing click handler for the links
        const activityTableBody = document.getElementById('activityTableBody');
        if (activityTableBody) {
            activityTableBody.addEventListener('click', (event) => {
                const link = event.target.closest('a[data-handler-type]');
                if (link) {
                    event.preventDefault();
                    ActivityTracker.handleItemClick(link);
                }
            });
        }
    }

    updateBreadcrumbs(["Home", "Recent Activity"]);
    updateActiveNavItem('navRecentActivity');
}

function populateActivityTable(items) {
    const tableBody = document.getElementById('activityTableBody');
    const eventTypeFilter = document.getElementById('filterEventType');
    const eventTypes = new Set();
    if (!tableBody || !eventTypeFilter) return;
    tableBody.innerHTML = '';
    items.forEach(item => {
        const row = document.createElement('tr');
        row.dataset.timestamp = item.timestamp;
        row.dataset.eventType = item.title;
        // Safety check for timestamp before formatting
        const formattedDate = item.timestamp && !isNaN(new Date(item.timestamp).getTime())
            ? new Date(item.timestamp).toLocaleString('en-US', { year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit' })
            : 'Invalid Date';
        row.innerHTML = `<td><a href="${item.url}" data-item-id="${item.id}">${item.title}</a></td><td>${formattedDate}</td>`;
        tableBody.appendChild(row);
        eventTypes.add(item.title);
    });
    eventTypeFilter.innerHTML = '<option value="">All Event Types</option>';
    eventTypes.forEach(type => {
        const option = document.createElement('option');
        option.value = type;
        option.textContent = type;
        eventTypeFilter.appendChild(option);
    });
}

function filterActivityTable() {
    const fromDate = document.getElementById('filterDateFrom').value;
    const toDate = document.getElementById('filterDateTo').value;
    const eventType = document.getElementById('filterEventType').value;
    const rows = document.querySelectorAll('#activityTableBody tr');
    const fromTimestamp = fromDate ? new Date(fromDate).getTime() : 0;
    const toTimestamp = toDate ? new Date(toDate).setHours(23, 59, 59, 999) : Infinity;
    rows.forEach(row => {
        const rowTimestamp = new Date(row.dataset.timestamp).getTime();
        const rowEventType = row.dataset.eventType;
        const dateMatch = rowTimestamp >= fromTimestamp && rowTimestamp <= toTimestamp;
        const typeMatch = !eventType || rowEventType === eventType;
        row.style.display = (dateMatch && typeMatch) ? '' : 'none';
    });
}


// Replace your entire ActivityTracker object with this one

// Global variable for history (Resets on every page refresh)
let sessionHistory = [];

const ActivityTracker = {
    MAX_ITEMS: 20, // Limit to last 20 logs

    track(item) {
        if (!item) return;
        
        const timestamp = new Date().toISOString();

        // --- 1. Identify Context for Deduplication (The Fix) ---
        // We create a unique ID for the "Entity" being viewed.
        // If it's a member, the ID is the MemberID (ignoring tabs).
        // If it's a page, it's the PageID.
        let dedupKey = null;

        if (item.handler) {
            if (item.handler.memberid) {
                // All tabs for "Robert Thompson" share this key
                dedupKey = 'member_' + item.handler.memberid;
            } else if (item.handler.targetid) {
                // "Dashboard", "Service Notes" etc.
                dedupKey = 'page_' + item.handler.targetid;
            }
        }
        // Fallback using title if no handler (unlikely in your setup)
        if (!dedupKey) dedupKey = item.title;

        // --- 2. Remove ANY existing entry for this specific Member/Page ---
        // This ensures "Robert / Timeline" replaces "Robert / Dashboard"
        sessionHistory = sessionHistory.filter(historyItem => historyItem.dedupKey !== dedupKey);

        // --- 3. Construct Display Title ---
        let displayTitle = item.historyTitle;

        if (!displayTitle && item.title) {
            displayTitle = item.title.replace('Viewed ', '');
            displayTitle = displayTitle.replace(' > ', ' / ');
        }

        if (!displayTitle) return;

        // --- 4. Generate the internal Pseudo-URL ---
        let baseUrl = window.location.href.split('?')[0];
        let pseudoUrl = baseUrl;

        if (item.handler) {
            if (item.handler.type === 'navigateToMemberSubtab') {
                pseudoUrl = `${baseUrl}?member=${item.handler.memberid}&tab=${item.handler.tabid}`;
            } else if (item.handler.type === 'navigateToMember') {
                pseudoUrl = `${baseUrl}?member=${item.handler.memberid}`;
            } else if (item.handler.type === 'sidebarClick') {
                pseudoUrl = `${baseUrl}?page=${item.handler.targetid}`;
            }
        }

        // --- 5. Add New Item to Top ---
        const historyItem = {
            ...item,
            historyTitle: displayTitle,
            url: pseudoUrl,
            timestamp: timestamp,
            dedupKey: dedupKey // Store key for future filtering
        };

        sessionHistory.unshift(historyItem); 
        sessionHistory = sessionHistory.slice(0, this.MAX_ITEMS);
    },

    get() {
        return sessionHistory;
    },

    // --- Navigation Handling ---
    handleItemClick(element) {
        const handler = element.dataset;
        if (handler.handlerType === 'sidebarClick') {
            const el = document.getElementById(handler.handlerTargetid);
            if(el) el.click();
            updateActiveNavItem(handler.handlerTargetid);
        } else if (handler.handlerType === 'navigateToMember') {
            navigateToDetails(handler.handlerMemberid);
            updateActiveNavItem('navMembers');
        } else if (handler.handlerType === 'navigateToMemberSubtab') {
            navigateToDetails(handler.handlerMemberid, handler.handlerTabid);
            updateActiveNavItem('navMembers');
        }
    },

    // --- Activity Page Functions (Unchanged) ---
    showActivityPage() {
        const pageContainer = document.getElementById('pageContainer');
        if (!pageContainer) return;
        const allItems = this.get();
        let contentHTML = '';
        if (allItems.length === 0) {
            contentHTML = `<div class="info-message" style="margin-top: 24px;">There is no recent activity to display.</div>`;
        } else {
            contentHTML = `
                <div class="filters-area" style="margin-bottom: 20px;">
                    <strong>Filters:</strong>
                    <input type="date" id="filterDateFrom" style="padding: 6px; border: 1px solid #ced4da; border-radius: 4px;">
                    <input type="date" id="filterDateTo" style="padding: 6px; border: 1px solid #ced4da; border-radius: 4px;">
                </div>
                <div class="table-wrapper">
                    <table class="member-table">
                        <thead><tr><th style="width: 70%;">Event</th><th>Date & Time</th></tr></thead>
                        <tbody id="activityTableBody"></tbody>
                    </table>
                </div>
            `;
        }
        const pageHTML = `<div class="page-content" style="margin: 0; padding: 24px;"><h2 style="font-size: 24px; font-weight: 600; margin-bottom: 24px;">Recent Activity</h2>${contentHTML}</div>`;
        pageContainer.innerHTML = pageHTML;
        if (allItems.length > 0) {
            this.populateActivityTable(allItems);
            const body = document.getElementById('activityTableBody');
            if(body) body.addEventListener('click', (e) => {
                const link = e.target.closest('a[data-handler-type]');
                if(link) { e.preventDefault(); this.handleItemClick(link); }
            });
        }
        updateBreadcrumbs(["Home", "Recent Activity"]);
        updateActiveNavItem('navRecentActivity');
    },

    populateActivityTable(items) {
        const tableBody = document.getElementById('activityTableBody');
        if (!tableBody) return;
        tableBody.innerHTML = '';
        items.forEach(item => {
            const row = document.createElement('tr');
            const dateObj = new Date(item.timestamp);
            const dateStr = dateObj.toLocaleString('en-US', { month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' });
            
            const handlerAttrs = item.handler ? Object.entries(item.handler).map(([key, value]) => `data-handler-${key}="${value}"`).join(' ') : '';
            
            row.innerHTML = `<td><a href="#" ${handlerAttrs} style="font-weight: 500; color: #353182; text-decoration: none;">${item.historyTitle}</a></td><td>${dateStr}</td>`;
            tableBody.appendChild(row);
        });
    },
    
    filterActivityTable() { /* existing filter logic */ }
};

// Dummy navigation function - REPLACE with your actual navigation logic
function navigateToMemberDetailsPage(memberId, tabId = 'dashboard') {
    console.log(`Navigating to member ${memberId}, tab ${tabId}`);
    // This is where your logic to load the member detail page goes.
    // For this demo, we'll just simulate a click on the main Members link.
    document.getElementById('navMembers').click();
    
    // After the page loads, we would programmatically click the correct tab.
    // This requires a more advanced setup, but this shows the intent.
    setTimeout(() => {
        const tabToClick = document.querySelector(`.tab[data-tab="${tabId}"]`);
        if(tabToClick) tabToClick.click();
    }, 200); // Wait for content to render
}


// --- History Drawer Functions ---

function openHistoryPanel() {
    const panel = document.getElementById('historyPanel');
    const overlay = document.getElementById('historyOverlay');
    
    // Render the list before showing
    renderHistoryList();

    if (overlay) overlay.classList.add('show');
    if (panel) panel.classList.add('open');
}

function closeHistoryPanel() {
    const panel = document.getElementById('historyPanel');
    const overlay = document.getElementById('historyOverlay');

    if (panel) panel.classList.remove('open');
    if (overlay) overlay.classList.remove('show');
}




function renderHistoryList() {
    const container = document.getElementById('historyListContainer');
    if (!container) return;

    const items = ActivityTracker.get();

    if (items.length === 0) {
        container.innerHTML = '<div class="history-empty">No recent history.</div>';
        return;
    }

    container.innerHTML = items.map(item => {
        const dateObj = new Date(item.timestamp);
        const timeStr = dateObj.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        const dateStr = dateObj.toLocaleDateString();
        
        // Use the generated URL
        const linkUrl = item.url || '#';

        // TARGET="_BLANK" ADDED HERE
        return `
            <a href="${linkUrl}" target="_blank" class="history-item" onclick="closeHistoryPanel()">
                <div class="history-item-header">
                    <div class="history-title">${item.historyTitle}</div>
                </div>
                <div class="history-time">
                    <svg width="12" height="12" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                    ${dateStr} at ${timeStr}
                </div>
            </a>
        `;
    }).join('');
}

// Helper to handle the drawer link click
function handleHistoryClick(event, element) {
    event.preventDefault();
    closeHistoryPanel(); // Close the drawer
    ActivityTracker.handleItemClick(element); // Perform navigation
}



        // START: ADD THIS NEW FUNCTION
       function showGlobalRecentActivityPage() {
    // Moved this line to the top to run BEFORE the page content is replaced.
    resetDrawerState(); 

    const pageContainer = document.getElementById('pageContainer');
    if (!pageContainer) return;
    const allItems = RecentItemsManager.get();
    const newPageHTML = `
        <div class="breadcrumb-container" style="position: sticky; top: 65px; z-index: 998;">
            <div class="breadcrumb">Home &gt; Recent Activity</div>
        </div>
        <div class="page-content" style="margin: 0;">
            <div style="padding: 24px;">
                <h2 style="font-size: 24px; font-weight: 600; color: #333; margin-bottom: 24px; border-bottom: 1px solid #e1e5e9; padding-bottom: 16px;">
                    Recent Activity
                </h2>
                <div>
                    ${allItems.length > 0 ? allItems.map(item => RecentItemsManager.createItemHTML(item)).join('') : '<div class="no-recents" style="padding: 40px 0;">You have no recent activity.</div>'}
                </div>
            </div>
        </div>
    `;
    pageContainer.innerHTML = newPageHTML;
    document.querySelectorAll('.sidebar-nav .nav-item.active').forEach(item => item.classList.remove('active'));
}
        // END: ADD THIS NEW FUNCTION




    // === NEW DATA SOURCE: MEMBER DATABASE ===
    // === 2. UPDATED HTML TEMPLATE FOR MEMBER DETAILS ===
// === THIS IS THE CORRECT AND COMPLETE HTML LAYOUT FOR THE MEMBER DETAILS PAGE ===
// === PLEASE REPLACE YOUR OLD 'memberDetailViewHTML' VARIABLE WITH THIS ONE. ===
let memberDetailViewHTML = `
<div class="page-content">
    <div class="content-tabs">
        <div class="tab active" data-tab="dashboard">Member Dashboard</div>
        <div class="tab" data-tab="details">Member Details</div>
        <div class="tab" data-tab="timeline">Timeline View</div>
        <div class="tab" data-tab="insurance">Insurance Information</div>
        <div class="tab" data-tab="screenings">Screenings & Assessments</div>
        <div class="tab" data-tab="bio-psycho">Bio/Psycho/Social</div>
        <div class="tab" data-tab="history">Health History</div>
        <div class="tab" data-tab="population">Population Insights</div>
        <div class="tab" data-tab="activity">Activity History</div>
        <div class="tab" data-tab="careteam">Care Team</div>
        <div class="tab" data-tab="careplans">Care Plans</div>
        <div class="tab" data-tab="assignment-history">CM Assignment History</div>
    </div>
    <div class="tab-content">
        <div class="tab-pane active" data-pane="dashboard">
            <div class="dashboard-grid">
                </div>
        </div>
        <div class="tab-pane" data-pane="details" style="display: none;">
            <div class="member-details-form">
                <div class="form-section">
                    <h3 class="section-title">Identity</h3>
                    <div class="form-grid cols-4">
                        <div class="form-field"><label>First Name *</label><input type="text" id="detailFirstName" disabled></div>
                        <div class="form-field"><label>MRN</label><input type="text" id="detailMrn" disabled></div>
                        <div class="form-field"><label>Middle Name</label><input type="text" id="detailMiddleName" disabled></div>
                        <div class="form-field"><label>Medicaid ID</label><input type="text" id="detailMedicaidId" disabled></div>
                        <div class="form-field"><label>Last Name *</label><input type="text" id="detailLastName" disabled></div>
                        <div class="form-field"><label>DOB</label><input type="text" id="detailDob" disabled></div>
                        <div class="form-field"><label>Preferred Name</label><input type="text" id="detailPreferredName" disabled></div>
                        <div class="form-field"><label>DOD</label><input type="text" id="detailDod" disabled></div>
                        <div class="form-field"><label>Age</label><input type="text" id="detailAge" disabled></div>
                        <div class="form-field"><label>Member Status</label><input type="text" id="detailMemberStatus" disabled></div>
                        <div class="form-field"><label>SSN</label><input type="text" value="***-**-****" disabled></div>
                        <div class="form-field"><label>Care Manager</label><input type="text" id="detailCareManager" disabled></div>
                        <div class="form-field"><label>CMA Start Date</label><input type="text" id="detailCmaStart" disabled></div>
                        <div class="form-field"><label>CMA End Date</label><input type="text" id="detailCmaEnd" disabled></div>
                    </div>
                </div>
                <div class="form-section">
                    <h3 class="section-title">Diagnoses</h3>
                    <div class="form-grid cols-4">
                        <div class="form-field col-span-2"><label>Primary Diagnosis</label><input type="text" id="detailDxPrimary" disabled></div>
                        <div class="form-field col-span-2"><label>Tertiary Diagnosis</label><input type="text" id="detailDxTertiary" disabled></div>
                        <div class="form-field col-span-2"><label>Secondary Diagnosis</label><input type="text" id="detailDxSecondary" disabled></div>
                        <div class="form-field col-span-2"><label>Additional Diagnosis</label><input type="text" id="detailDxAdditional" disabled></div>
                    </div>
                </div>
                <div class="form-section" id="memberConsentOverviewSection">
                    </div>
                <div class="form-section">
                    <h3 class="section-title">Contact Information</h3>
                    <div class="form-grid cols-4">
                        <div class="form-field"><label>Home Phone</label><input type="text" id="detailHomePhone" disabled></div>
                        <div class="form-field"><label>Street Address</label><input type="text" id="detailAddress" disabled></div>
                        <div class="form-field"><label>Cell Phone</label><input type="text" id="detailCellPhone" disabled></div>
                        <div class="form-field"><label>Line 2</label><input type="text" id="detailAddress2" placeholder="N/A" disabled></div>
                        <div class="form-field"><label>Email</label><input type="text" id="detailEmail" disabled></div>
                        <div class="form-field"><label>City</label><input type="text" id="detailCity" disabled></div>
                        <div class="form-field"><label>Preferred Contact Method</label><input type="text" id="detailContactMethod" disabled></div>
                        <div class="form-field"><label>Zip Code</label><input type="text" id="detailZip" disabled></div>
                    </div>
                </div>
                <div class="form-section">
                    <h3 class="section-title">Communication Method and Languages</h3>
                    <div class="form-grid cols-4">
                        <div class="form-field col-span-2"><label>Languages Spoken</label><div class="multi-select-tags" id="detailLanguages"></div></div>
                        <div class="form-field col-span-2"><label>Preferred Language *</label><input type="text" id="detailPrefLang" disabled></div>
                    </div>
                </div>
                <div class="form-section">
                    <h3 class="section-title">Additional Information</h3>
                    <div class="form-field"><label>Additional Information</label><textarea rows="3" id="detailAdditionalInfo" disabled></textarea></div>
                </div>
                <div class="form-section">
                    <h3 class="section-title">Security Tags</h3>
                    <div class="security-tags-list" id="detailSecurityTags">
                        </div>
                </div>
                <div class="form-actions" id="detailFormActions">
                    <button class="btn btn-secondary" id="backToListBtn">Back to List</button>
                    <button class="btn btn-secondary" onclick="toggleEditMode()">Edit</button>
                </div>
            </div>
        </div>
    </div>
</div>
`;


// 
// ENRICHED MEMBERS DATABASE - COMPREHENSIVE CARE MANAGEMENT DATA
// 
// This file contains enriched member data with:
// - Service Notes (8-10 per member, mix of draft/completed)
// - Rich Timeline Events
// - Detailed Consent History
// - All existing LOB/Programs/Populations PRESERVED
// 

// ============================================
// COMPREHENSIVE MEMBER DATABASE WITH LOGICAL DATA
// Version 9 - Journey-Stage Aware
// ============================================

// ============================================
// JOURNEY STAGE DEFINITIONS
// ============================================
const JOURNEY_STAGES = {
    NEW_ENROLLMENT: {
        id: 1,
        name: 'New Enrollment - To Obtain Consent',
        consentStatus: 'To Obtain Consent',
        hasAssessments: false,
        hasCarePlan: false,
        hasHealthHistory: false,  // View only claims/ADTs that came with enrollment
        hasBioPsychoSocial: false
    },
    DECLINED: {
        id: 2,
        name: 'Consent Declined',
        consentStatus: 'Declined',
        hasAssessments: false,
        hasCarePlan: false,
        hasHealthHistory: false,
        hasBioPsychoSocial: false
    },
    CONSENTED_NO_ASSESSMENT: {
        id: 3,
        name: 'Consented - Awaiting Assessment',
        consentStatus: 'Consented',
        hasAssessments: false,  // Library available, no activity yet
        hasCarePlan: false,
        hasHealthHistory: true,  // Can now view
        hasBioPsychoSocial: true
    },
    ASSESSMENT_IN_PROGRESS: {
        id: 4,
        name: 'Consented - Assessment In Progress',
        consentStatus: 'Consented',
        hasAssessments: 'in-progress',
        hasCarePlan: false,
        hasHealthHistory: true,
        hasBioPsychoSocial: true
    },
    ASSESSMENT_DONE_CP_BUILDING: {
        id: 5,
        name: 'Assessment Complete - Care Plan Building',
        consentStatus: 'Consented',
        hasAssessments: 'completed',
        hasCarePlan: 'in-progress',
        hasHealthHistory: true,
        hasBioPsychoSocial: true
    },
    FULLY_ACTIVE: {
        id: 6,
        name: 'Fully Active',
        consentStatus: 'Consented',
        hasAssessments: 'completed',
        hasCarePlan: 'active',
        hasHealthHistory: true,
        hasBioPsychoSocial: true
    },
    RECONSENT_REQUIRED: {
        id: 7,
        name: 'Re-consent Required',
        consentStatus: 'Re-consent Required',
        hasAssessments: 'historical',  // Can view but not add new
        hasCarePlan: 'paused',
        hasHealthHistory: true,
        hasBioPsychoSocial: true
    }
};

// ============================================
// REFERENCE DATA
// ============================================
const CARE_MANAGERS = [
    { id: 'aziz.gida', name: 'Aziz Gida', supervisor: 'Sarah Mitchell' },
    { id: 'jennifer.wilson', name: 'Jennifer Wilson', supervisor: 'Sarah Mitchell' },
    { id: 'michael.chen', name: 'Michael Chen', supervisor: 'David Brown' },
    { id: 'sarah.johnson', name: 'Sarah Johnson', supervisor: 'David Brown' }
];

const MCOS = ['Healthy Blue', 'Cigna HealthSpring', 'WellCare', 'AmeriHealth Caritas', 'UnitedHealthcare'];

const PROGRAMS = ['CCM', 'TCM', 'BHI', 'RPM', 'CHW', 'Care Coordination'];

const PRIORITY_POPULATIONS = ['High Risk Pregnancy', 'NICU', 'Frequent ED Utilizer', 'Post-Discharge', 'Behavioral Health'];

const DIAGNOSES_LIBRARY = [
    { code: 'I50.9', desc: 'Heart failure, unspecified' },
    { code: 'E11.65', desc: 'Type 2 diabetes with hyperglycemia' },
    { code: 'I10', desc: 'Essential hypertension' },
    { code: 'J44.9', desc: 'COPD, unspecified' },
    { code: 'F32.9', desc: 'Major depressive disorder' },
    { code: 'E78.5', desc: 'Hyperlipidemia, unspecified' },
    { code: 'M54.5', desc: 'Low back pain' },
    { code: 'F41.1', desc: 'Generalized anxiety disorder' },
    { code: 'N18.3', desc: 'Chronic kidney disease, stage 3' },
    { code: 'G47.33', desc: 'Obstructive sleep apnea' }
];

const FACILITIES = [
    'Duke University Hospital',
    'WakeMed Health',
    'UNC Medical Center',
    'Vidant Medical Center',
    'Novant Health Presbyterian'
];

const FIRST_NAMES_MALE = ['William', 'James', 'Robert', 'Michael', 'David', 'John', 'Richard', 'Thomas', 'Charles', 'Daniel', 'Marcus', 'Anthony', 'Kevin', 'Brian', 'Steven'];
const FIRST_NAMES_FEMALE = ['Mary', 'Patricia', 'Jennifer', 'Linda', 'Elizabeth', 'Barbara', 'Susan', 'Jessica', 'Sarah', 'Karen', 'Lisa', 'Nancy', 'Betty', 'Margaret', 'Dorothy'];
const LAST_NAMES = ['Jacobson', 'Fox', 'Martinez', 'Thompson', 'Garcia', 'Anderson', 'Wilson', 'Taylor', 'Moore', 'Jackson', 'Martin', 'Lee', 'Perez', 'White', 'Harris', 'Clark', 'Lewis', 'Robinson', 'Walker', 'Young', 'Allen', 'King', 'Wright', 'Scott', 'Torres', 'Hill', 'Green', 'Adams', 'Baker', 'Nelson', 'Carter', 'Mitchell', 'Roberts'];

const NC_CITIES = [
    { city: 'Raleigh', county: 'Wake', zip: '27601' },
    { city: 'Durham', county: 'Durham', zip: '27701' },
    { city: 'Charlotte', county: 'Mecklenburg', zip: '28202' },
    { city: 'Greensboro', county: 'Guilford', zip: '27401' },
    { city: 'Cary', county: 'Wake', zip: '27513' },
    { city: 'Wilmington', county: 'New Hanover', zip: '28401' },
    { city: 'Fayetteville', county: 'Cumberland', zip: '28301' },
    { city: 'Asheville', county: 'Buncombe', zip: '28801' }
];

// ============================================
// MEMBER SEED DATA - 33 Members with Journey Stages
// ============================================
const MEMBER_SEEDS = [
    // Stage 1: To Obtain Consent (6 members)
    { id: 'MEM-001', stage: 'NEW_ENROLLMENT', riskTier: 4, gender: 'Male', ageRange: [60, 75], mcoIdx: 0, hasSafetyConcern: false, hasADT: true },
    { id: 'MEM-002', stage: 'NEW_ENROLLMENT', riskTier: 3, gender: 'Female', ageRange: [45, 60], mcoIdx: 1, hasSafetyConcern: false, hasADT: false },
    { id: 'MEM-003', stage: 'NEW_ENROLLMENT', riskTier: 2, gender: 'Male', ageRange: [30, 45], mcoIdx: 2, hasSafetyConcern: false, hasADT: false },
    { id: 'MEM-004', stage: 'NEW_ENROLLMENT', riskTier: 4, gender: 'Female', ageRange: [70, 85], mcoIdx: 3, hasSafetyConcern: true, hasADT: true },
    { id: 'MEM-005', stage: 'NEW_ENROLLMENT', riskTier: 3, gender: 'Male', ageRange: [50, 65], mcoIdx: 4, hasSafetyConcern: false, hasADT: false },
    { id: 'MEM-006', stage: 'NEW_ENROLLMENT', riskTier: 2, gender: 'Female', ageRange: [25, 40], mcoIdx: 0, hasSafetyConcern: false, hasADT: false },

    // Stage 2: Declined (3 members)
    { id: 'MEM-007', stage: 'DECLINED', riskTier: 3, gender: 'Male', ageRange: [55, 70], mcoIdx: 1, hasSafetyConcern: false, hasADT: false },
    { id: 'MEM-008', stage: 'DECLINED', riskTier: 2, gender: 'Female', ageRange: [40, 55], mcoIdx: 2, hasSafetyConcern: false, hasADT: false },
    { id: 'MEM-009', stage: 'DECLINED', riskTier: 1, gender: 'Male', ageRange: [35, 50], mcoIdx: 3, hasSafetyConcern: false, hasADT: false },

    // Stage 3: Consented - No Assessment Yet (4 members)
    { id: 'MEM-010', stage: 'CONSENTED_NO_ASSESSMENT', riskTier: 3, gender: 'Female', ageRange: [45, 60], mcoIdx: 4, hasSafetyConcern: false, hasADT: false },
    { id: 'MEM-011', stage: 'CONSENTED_NO_ASSESSMENT', riskTier: 2, gender: 'Male', ageRange: [50, 65], mcoIdx: 0, hasSafetyConcern: false, hasADT: true },
    { id: 'MEM-012', stage: 'CONSENTED_NO_ASSESSMENT', riskTier: 4, gender: 'Female', ageRange: [65, 80], mcoIdx: 1, hasSafetyConcern: false, hasADT: false },
    { id: 'MEM-013', stage: 'CONSENTED_NO_ASSESSMENT', riskTier: 3, gender: 'Male', ageRange: [40, 55], mcoIdx: 2, hasSafetyConcern: false, hasADT: false },

    // Stage 4: Assessment In Progress (5 members)
    { id: 'MEM-014', stage: 'ASSESSMENT_IN_PROGRESS', riskTier: 4, gender: 'Female', ageRange: [55, 70], mcoIdx: 3, hasSafetyConcern: false, hasADT: true },
    { id: 'MEM-015', stage: 'ASSESSMENT_IN_PROGRESS', riskTier: 3, gender: 'Male', ageRange: [60, 75], mcoIdx: 4, hasSafetyConcern: false, hasADT: false },
    { id: 'MEM-016', stage: 'ASSESSMENT_IN_PROGRESS', riskTier: 2, gender: 'Female', ageRange: [35, 50], mcoIdx: 0, hasSafetyConcern: false, hasADT: false },
    { id: 'MEM-017', stage: 'ASSESSMENT_IN_PROGRESS', riskTier: 4, gender: 'Male', ageRange: [70, 85], mcoIdx: 1, hasSafetyConcern: true, hasADT: true },
    { id: 'MEM-018', stage: 'ASSESSMENT_IN_PROGRESS', riskTier: 3, gender: 'Female', ageRange: [45, 60], mcoIdx: 2, hasSafetyConcern: false, hasADT: false },

    // Stage 5: Assessment Done, Care Plan Building (5 members)
    { id: 'MEM-019', stage: 'ASSESSMENT_DONE_CP_BUILDING', riskTier: 4, gender: 'Male', ageRange: [65, 80], mcoIdx: 3, hasSafetyConcern: false, hasADT: false },
    { id: 'MEM-020', stage: 'ASSESSMENT_DONE_CP_BUILDING', riskTier: 3, gender: 'Female', ageRange: [50, 65], mcoIdx: 4, hasSafetyConcern: false, hasADT: true },
    { id: 'MEM-021', stage: 'ASSESSMENT_DONE_CP_BUILDING', riskTier: 2, gender: 'Male', ageRange: [40, 55], mcoIdx: 0, hasSafetyConcern: false, hasADT: false },
    { id: 'MEM-022', stage: 'ASSESSMENT_DONE_CP_BUILDING', riskTier: 4, gender: 'Female', ageRange: [75, 90], mcoIdx: 1, hasSafetyConcern: true, hasADT: true },
    { id: 'MEM-023', stage: 'ASSESSMENT_DONE_CP_BUILDING', riskTier: 3, gender: 'Male', ageRange: [55, 70], mcoIdx: 2, hasSafetyConcern: false, hasADT: false },

    // Stage 6: Fully Active (7 members)
    { id: 'MEM-024', stage: 'FULLY_ACTIVE', riskTier: 4, gender: 'Female', ageRange: [60, 75], mcoIdx: 3, hasSafetyConcern: false, hasADT: false, hasPriorityPop: true },
    { id: 'MEM-025', stage: 'FULLY_ACTIVE', riskTier: 3, gender: 'Male', ageRange: [50, 65], mcoIdx: 4, hasSafetyConcern: false, hasADT: true, hasPriorityPop: false },
    { id: 'MEM-026', stage: 'FULLY_ACTIVE', riskTier: 4, gender: 'Female', ageRange: [70, 85], mcoIdx: 0, hasSafetyConcern: false, hasADT: false, hasPriorityPop: true },
    { id: 'MEM-027', stage: 'FULLY_ACTIVE', riskTier: 2, gender: 'Male', ageRange: [35, 50], mcoIdx: 1, hasSafetyConcern: false, hasADT: false, hasPriorityPop: false },
    { id: 'MEM-028', stage: 'FULLY_ACTIVE', riskTier: 4, gender: 'Female', ageRange: [55, 70], mcoIdx: 2, hasSafetyConcern: true, hasADT: true, hasPriorityPop: true },
    { id: 'MEM-029', stage: 'FULLY_ACTIVE', riskTier: 3, gender: 'Male', ageRange: [65, 80], mcoIdx: 3, hasSafetyConcern: false, hasADT: false, hasPriorityPop: false },
    { id: 'MEM-030', stage: 'FULLY_ACTIVE', riskTier: 4, gender: 'Female', ageRange: [45, 60], mcoIdx: 4, hasSafetyConcern: false, hasADT: true, hasPriorityPop: true },

    // Stage 7: Re-consent Required (3 members)
    { id: 'MEM-031', stage: 'RECONSENT_REQUIRED', riskTier: 3, gender: 'Male', ageRange: [55, 70], mcoIdx: 0, hasSafetyConcern: false, hasADT: false },
    { id: 'MEM-032', stage: 'RECONSENT_REQUIRED', riskTier: 4, gender: 'Female', ageRange: [60, 75], mcoIdx: 1, hasSafetyConcern: false, hasADT: true },
    { id: 'MEM-033', stage: 'RECONSENT_REQUIRED', riskTier: 2, gender: 'Male', ageRange: [40, 55], mcoIdx: 2, hasSafetyConcern: false, hasADT: false }
];

// ============================================
// HELPER FUNCTIONS
// ============================================
function getRandomInt(min, max) {
    return Math.floor(Math.random() * (max - min + 1)) + min;
}

function getRandomElement(arr) {
    return arr[Math.floor(Math.random() * arr.length)];
}

function generateDOB(ageRange) {
    const age = getRandomInt(ageRange[0], ageRange[1]);
    const year = new Date().getFullYear() - age;
    const month = String(getRandomInt(1, 12)).padStart(2, '0');
    const day = String(getRandomInt(1, 28)).padStart(2, '0');
    return { dob: `${month}/${day}/${year}`, age };
}

function generatePhone() {
    return `919-555-${getRandomInt(1000, 9999)}`;
}

function formatDate(date) {
    return date.toISOString().split('T')[0];
}

function getPastDate(daysAgo) {
    const d = new Date();
    d.setDate(d.getDate() - daysAgo);
    return formatDate(d);
}

function getFutureDate(daysAhead) {
    const d = new Date();
    d.setDate(d.getDate() + daysAhead);
    return formatDate(d);
}

function getRiskCategory(tier) {
    if (tier >= 4) return 'High';
    if (tier >= 3) return 'Medium';
    if (tier >= 2) return 'Low';
    return 'Minimal';
}

// ============================================
// MEMBER GENERATION FUNCTION
// ============================================
function generateMember(seed, index) {
    const stage = JOURNEY_STAGES[seed.stage];
    const { dob, age } = generateDOB(seed.ageRange);
    const location = getRandomElement(NC_CITIES);
    const careManager = CARE_MANAGERS[index % CARE_MANAGERS.length];
    const mco = MCOS[seed.mcoIdx];
    
    // Generate name based on gender
    const firstName = seed.gender === 'Male' 
        ? FIRST_NAMES_MALE[index % FIRST_NAMES_MALE.length]
        : FIRST_NAMES_FEMALE[index % FIRST_NAMES_FEMALE.length];
    const lastName = LAST_NAMES[index % LAST_NAMES.length];
    const name = `${firstName} ${lastName}`;
    
    // Generate diagnoses based on risk tier
    const numDiagnoses = seed.riskTier >= 3 ? getRandomInt(3, 5) : getRandomInt(1, 3);
    const memberDiagnoses = [];
    for (let i = 0; i < numDiagnoses; i++) {
        memberDiagnoses.push(DIAGNOSES_LIBRARY[i % DIAGNOSES_LIBRARY.length]);
    }

    // Build the member object
    const member = {
        id: seed.id,
        name: name,
        dob: dob,
        age: age,
        gender: seed.gender,
        riskCategory: getRiskCategory(seed.riskTier),
        riskTier: seed.riskTier,
        journeyStage: stage.id,
        journeyStageName: stage.name,
        address: `${getRandomInt(100, 999)} ${getRandomElement(['Oak', 'Pine', 'Maple', 'Cedar', 'Elm'])} ${getRandomElement(['Street', 'Avenue', 'Lane', 'Drive', 'Road'])}`,
        zipCode: location.zip,
        county: location.county,
        city: location.city,
        state: 'NC',
        email: `${firstName.toLowerCase()}.${lastName.toLowerCase()}@email.com`,
        cellPhone: generatePhone(),
        homePhone: generatePhone(),
        ethnicity: getRandomElement(['Not Hispanic or Latino', 'Hispanic or Latino']),
        mrn: `MRN${10000 + index}`,
        race: getRandomElement(['White', 'Black or African American', 'Asian', 'Other']),
        medicaidId: `${getRandomInt(500000000, 599999999)}${getRandomElement(['N', 'M', 'P'])}`,
        careMgmtStart: '2025-01-01',
        careMgmtEnd: '2025-12-31',
        memberStatus: stage.consentStatus === 'Declined' ? 'Inactive' : (stage.consentStatus === 'To Obtain Consent' ? 'OnHold' : 'Active'),
        consentStatus: stage.consentStatus,
        mco: mco,
        careManager: careManager.name,
        careManagerId: careManager.id,
        diagnoses: {
            primary: memberDiagnoses[0] ? `${memberDiagnoses[0].code} - ${memberDiagnoses[0].desc}` : '',
            secondary: memberDiagnoses[1] ? `${memberDiagnoses[1].code} - ${memberDiagnoses[1].desc}` : '',
            tertiary: memberDiagnoses[2] ? `${memberDiagnoses[2].code} - ${memberDiagnoses[2].desc}` : '',
            additional: memberDiagnoses[3] ? `${memberDiagnoses[3].code} - ${memberDiagnoses[3].desc}` : ''
        },
        
        // Consent Details - varies by stage
        consentDetails: generateConsentDetails(stage, careManager.name),
        
        // Communication
        communication: {
            languages: ['English'],
            preferredLanguage: 'English',
            method: getRandomElement(['Phone', 'Email', 'Text', 'Mail'])
        },
        
        // Insurance
        insurance: {
            mco: mco,
            planName: 'NC MEDICAID MANAGED CARE - TAILORED PLAN',
            planType: 'Medicaid',
            memberId: `${getRandomInt(500000000, 599999999)}${getRandomElement(['N', 'M', 'P'])}`,
            groupNumber: 'NCMED001',
            effectiveDate: '2025-01-01',
            termDate: '2026-01-01',
            county: location.county,
            pcpName: `Dr. ${getRandomElement(['Smith', 'Johnson', 'Williams', 'Brown', 'Jones'])}`,
            pcpPhone: generatePhone(),
            pcpLastVisit: getPastDate(getRandomInt(7, 90))
        },
        
        // Enrollment
        enrollment: [{
            insuranceCompany: mco,
            insuranceType: 'Medicaid Managed Care',
            planName: 'NC MEDICAID MANAGED CARE - TAILORED PLAN',
            county: location.county,
            planType: 'Tailored Plan',
            startDate: '01/01/2025',
            endDate: '12/31/2025',
            createdOn: '12/15/2024',
            status: 'Active'
        }],
        
        // Care Spans
        careSpans: [{
            spanType: 'Care Management',
            insurance: mco,
            planName: 'NC MEDICAID MANAGED CARE - TAILORED PLAN',
            planType: 'Tailored Plan',
            startDate: '01/01/2025',
            endDate: '12/31/2025',
            status: stage.consentStatus === 'Declined' ? 'Closed' : 'Active',
            careManager: careManager.name,
            program: getRandomElement(PROGRAMS),
            assignmentDate: '12/15/2024'
        }],
        
        // Risk Acuity
        riskAcuity: {
            currentTier: seed.riskTier,
            riskScore: seed.riskTier * 20 + getRandomInt(5, 15),
            lastAssessment: getPastDate(getRandomInt(7, 30)),
            history: [
                { date: getPastDate(60), tier: Math.max(1, seed.riskTier - 1), score: (seed.riskTier - 1) * 20 + getRandomInt(5, 15) },
                { date: getPastDate(30), tier: seed.riskTier, score: seed.riskTier * 20 + getRandomInt(5, 15) }
            ]
        },
        
        // Safety Concern
        safetyConcern: {
            hasConcern: seed.hasSafetyConcern,
            details: seed.hasSafetyConcern ? 'Member has documented fall risk. Use caution during home visits.' : null,
            lastReviewed: seed.hasSafetyConcern ? getPastDate(14) : null
        },
        
        // Dashboard Data - Stage-aware
        dashboardData: generateDashboardData(seed, stage, careManager.name),
        
        // Service Notes - Stage-aware
        serviceNotes: generateServiceNotes(seed, stage, careManager.name),
        
        // Timeline Events - Stage-aware
        timelineEvents: generateTimelineEvents(seed, stage, careManager.name),
        
        // Assessment Library (always available)
        assessmentLibrary: [
            { title: 'Health Risk Assessment (HRA)', version: 'v2.0' },
            { title: 'PHQ-9 Depression Screening', version: 'v1.0' },
            { title: 'GAD-7 Anxiety Screening', version: 'v1.0' },
            { title: 'AUDIT-C Alcohol Use', version: 'v1.0' },
            { title: 'Falls Risk Assessment', version: 'v1.5' },
            { title: 'Social Determinants of Health', version: 'v2.1' },
            { title: 'Medication Adherence Scale', version: 'v1.0' },
            { title: 'Utilization Needs Assessment', version: 'v3.0' }
        ],
        
        // Assessment Activity - Stage-aware
        assessmentActivity: generateAssessmentActivity(seed, stage, careManager.name),
        
        // Bio/Psycho/Social - Stage-aware (empty arrays for non-consented)
        livingArrangements: stage.hasBioPsychoSocial ? generateLivingArrangements(seed) : [],
        education: stage.hasBioPsychoSocial ? generateEducation(seed, age) : [],
        employment: stage.hasBioPsychoSocial ? generateEmployment(seed, age) : [],
        volunteering: stage.hasBioPsychoSocial ? generateVolunteering(seed) : [],
        
        // Health History - Stage-aware
        healthHistory: generateHealthHistoryData(seed, stage, memberDiagnoses),
        
        // Activity Log - Stage-aware (simple log)
        activityLog: generateActivityLog(seed, stage, careManager.name),
        
        // Activity History - structured for ActivityHistoryController
        activityHistory: generateActivityHistoryData(seed, stage, careManager.name),
        
        // Care Plan Data - Stage-aware
        carePlanData: generateCarePlanDataForMember(seed, stage, careManager.name),
        
        // Population Data - generate proper object arrays for controllers
        populationData: (function() {
            const progName = getRandomElement(PROGRAMS);
            const activeStatus = '<span style="background:#dcfce7; color:#166534; padding:2px 8px; border-radius:12px; font-size:11px;">Active</span>';
            const result = {
                lob: [{
                    name: mco,
                    primary: true,
                    status: activeStatus,
                    source: 'State Enrollment File',
                    identified: '01/01/2025',
                    effective: '01/01/2025',
                    end: '12/31/2025'
                }],
                programs: [{
                    name: progName,
                    identified: '01/15/2025',
                    effective: '01/15/2025',
                    end: '12/31/2025',
                    status: activeStatus
                }],
                priority: []
            };
            if (seed.hasPriorityPop) {
                const ppName = getRandomElement(PRIORITY_POPULATIONS);
                result.priority.push({
                    name: ppName,
                    source: 'Clinical Review',
                    identified: getPastDate(getRandomInt(30, 90)),
                    effective: getPastDate(getRandomInt(30, 90)),
                    end: getFutureDate(180),
                    status: activeStatus,
                    updated: getPastDate(getRandomInt(1, 14)),
                    updatedBy: careManager.name,
                    created: getPastDate(getRandomInt(30, 90))
                });
            }
            return result;
        })(),
        
        // Header Data
        headerData: generateHeaderData(seed, stage, mco),
        
        // Care Team - full structure for CareTeamController
        careTeamData: (function() {
            const pcpLastName = getRandomElement(['Smith', 'Johnson', 'Williams', 'Brown', 'Jones']);
            const pcpName = 'Dr. ' + pcpLastName;
            const relFirstName = getRandomElement(['Maria', 'Robert', 'James', 'Patricia', 'Linda']);
            const relLastName = getRandomElement(['Thompson', 'Garcia', 'Martinez', 'Anderson', 'Taylor']);
            return {
                primary: careManager.name,
                supervisor: careManager.supervisor,
                pcp: {
                    groupName: pcpLastName + ' Medical Group',
                    source: 'State Assignment',
                    startDate: '01/01/2025',
                    endDate: '12/31/2025',
                    providerName: pcpName,
                    address: getRandomInt(100, 999) + ' Medical Plaza, ' + location.city + ', NC ' + location.zip,
                    phone: generatePhone()
                },
                members: [
                    {
                        sourceType: 'Internal',
                        name: careManager.name,
                        type: 'Care Manager',
                        status: '<span style="background:#dcfce7; color:#166534; padding:2px 6px; border-radius:12px; font-size:11px;">Active</span>',
                        start: '01/01/2025',
                        end: '12/31/2025',
                        incept: '01/01/2025'
                    },
                    {
                        sourceType: 'Internal',
                        name: careManager.supervisor,
                        type: 'Supervisor',
                        status: '<span style="background:#dcfce7; color:#166534; padding:2px 6px; border-radius:12px; font-size:11px;">Active</span>',
                        start: '01/01/2025',
                        end: '12/31/2025',
                        incept: '01/01/2025'
                    },
                    {
                        sourceType: 'External',
                        name: pcpName,
                        type: 'Primary Care Physician',
                        status: '<span style="background:#dcfce7; color:#166534; padding:2px 6px; border-radius:12px; font-size:11px;">Active</span>',
                        start: '01/01/2025',
                        end: '12/31/2025',
                        incept: '12/15/2024'
                    }
                ],
                relatedPersons: [
                    {
                        name: relFirstName + ' ' + relLastName,
                        relationship: getRandomElement(['Spouse', 'Child', 'Sibling', 'Parent']),
                        responsible: getRandomElement(['Yes', 'No']),
                        guardian: 'No',
                        emergency: 'Yes',
                        primary: 'Yes',
                        language: 'English',
                        phone: generatePhone(),
                        modifiedOn: getPastDate(getRandomInt(7, 60)),
                        modifiedBy: careManager.name
                    }
                ],
                covenants: stage.consentStatus === 'Consented' || stage.consentStatus === 'Re-consent Required' ? [
                    {
                        name: 'Verbal Consent Agreement',
                        description: 'Member verbal consent for care management participation',
                        status: stage.consentStatus === 'Re-consent Required' ? '<span style="background:#fef3c7; color:#d97706; padding:2px 6px; border-radius:12px; font-size:11px;">Expiring</span>' : '<span style="background:#dcfce7; color:#166534; padding:2px 6px; border-radius:12px; font-size:11px;">Active</span>',
                        type: 'Consent',
                        created: getPastDate(getRandomInt(30, 90)),
                        start: getPastDate(getRandomInt(30, 90)),
                        end: getFutureDate(stage.consentStatus === 'Re-consent Required' ? 0 : 270)
                    }
                ] : []
            };
        })(),
        
        // Security Tags
        securityTags: [{
            group: 'OPERATIONS *',
            tag: 'ALL',
            hierarchy: 'ALL(0)'
        }]
    };
    
    return member;
}

// ============================================
// STAGE-SPECIFIC DATA GENERATORS
// ============================================

function generateConsentDetails(stage, careManagerName) {
    const details = {
        statusText: stage.consentStatus,
        updatedOn: '',
        contactAttempts: 0,
        history: []
    };
    
    if (stage.consentStatus === 'To Obtain Consent') {
        const attempts = getRandomInt(2, 5);
        details.contactAttempts = attempts;
        details.updatedOn = getPastDate(7);
        for (let i = 0; i < attempts; i++) {
            details.history.push({
                date: getPastDate((attempts - i) * 7),
                method: 'Phone Call',
                outcome: i === attempts - 1 ? 'Left voicemail' : getRandomElement(['No answer', 'Left voicemail', 'Wrong number']),
                attempt: i + 1,
                status: 'To Obtain Consent',
                user: careManagerName
            });
        }
    } else if (stage.consentStatus === 'Declined') {
        details.contactAttempts = getRandomInt(3, 6);
        details.updatedOn = getPastDate(14);
        details.history.push({
            date: getPastDate(14),
            method: 'Phone Call',
            outcome: 'Member declined participation',
            attempt: details.contactAttempts,
            status: 'Declined',
            user: careManagerName
        });
    } else if (stage.consentStatus === 'Consented') {
        details.contactAttempts = 1;
        details.updatedOn = getPastDate(getRandomInt(30, 90));
        details.history.push({
            date: details.updatedOn,
            method: 'Phone Call',
            outcome: 'Verbal consent obtained',
            attempt: 1,
            status: 'Consented',
            user: careManagerName
        });
    } else if (stage.consentStatus === 'Re-consent Required') {
        details.contactAttempts = 2;
        details.updatedOn = getPastDate(7);
        details.history = [
            {
                date: getPastDate(365),
                method: 'Phone Call',
                outcome: 'Verbal consent obtained',
                attempt: 1,
                status: 'Consented',
                user: careManagerName
            },
            {
                date: getPastDate(7),
                method: 'System',
                outcome: 'Annual re-consent required',
                attempt: 2,
                status: 'Re-consent Required',
                user: 'System'
            }
        ];
    }
    
    return details;
}

function generateDashboardData(seed, stage, careManagerName) {
    const data = {
        adts: [],
        tasks: [],
        careGaps: {}
    };
    
    // ADTs based on seed
    if (seed.hasADT) {
        data.adts.push({
            date: getPastDate(getRandomInt(1, 14)),
            type: getRandomElement(['A01 - Admission', 'A03 - Discharge', 'A04 - ED Visit']),
            facility: getRandomElement(FACILITIES),
            diagnosis: getRandomElement(DIAGNOSES_LIBRARY).desc,
            acknowledged: 'No'
        });
    }
    
    // Tasks based on stage
    if (stage.consentStatus === 'To Obtain Consent') {
        data.tasks.push({
            id: `T-${seed.id}-001`,
            title: 'Obtain Member Consent',
            type: 'Member Consent',
            status: 'Open',
            dueDate: getFutureDate(7),
            priority: 'High',
            assignedTo: careManagerName,
            group: 'Care Management Team A'
        });
    } else if (stage.consentStatus === 'Declined') {
        data.tasks.push({
            id: `T-${seed.id}-001`,
            title: 'Re-engagement Outreach',
            type: 'Outreach',
            status: 'Open',
            dueDate: getFutureDate(30),
            priority: 'Low',
            assignedTo: careManagerName,
            group: 'Care Management Team A'
        });
    } else if (stage.consentStatus === 'Re-consent Required') {
        data.tasks.push({
            id: `T-${seed.id}-001`,
            title: 'Obtain Re-consent',
            type: 'Member Consent',
            status: 'Open',
            dueDate: getFutureDate(14),
            priority: 'High',
            assignedTo: careManagerName,
            group: 'Care Management Team A'
        });
    } else if (stage.id === 3) { // Consented, no assessment
        data.tasks.push({
            id: `T-${seed.id}-001`,
            title: 'Schedule Initial Assessment',
            type: 'Assessment',
            status: 'Open',
            dueDate: getFutureDate(14),
            priority: 'High',
            assignedTo: careManagerName,
            group: 'Care Management Team A'
        });
    } else if (stage.id === 4) { // Assessment in progress
        data.tasks.push({
            id: `T-${seed.id}-001`,
            title: 'Complete Health Risk Assessment',
            type: 'Assessment',
            status: 'In Progress',
            dueDate: getFutureDate(7),
            priority: 'High',
            assignedTo: careManagerName,
            group: 'Care Management Team A'
        });
    } else if (stage.id === 5) { // Care plan building
        data.tasks.push({
            id: `T-${seed.id}-001`,
            title: 'Develop Care Plan Goals',
            type: 'Care Plan',
            status: 'In Progress',
            dueDate: getFutureDate(14),
            priority: 'Medium',
            assignedTo: careManagerName,
            group: 'Care Management Team A'
        });
    } else if (stage.id === 6) { // Fully active
        data.tasks.push({
            id: `T-${seed.id}-001`,
            title: 'Monthly Check-in Call',
            type: 'Care Management',
            status: 'Open',
            dueDate: getFutureDate(7),
            priority: 'Medium',
            assignedTo: careManagerName,
            group: 'Care Management Team A'
        });
        if (seed.riskTier >= 3) {
            data.tasks.push({
                id: `T-${seed.id}-002`,
                title: 'Medication Reconciliation Review',
                type: 'Care Management',
                status: 'Open',
                dueDate: getFutureDate(14),
                priority: 'Medium',
                assignedTo: careManagerName,
                group: 'Care Management Team A'
            });
        }
    }
    
    // Add ADT follow-up task if there's an unacknowledged ADT
    if (seed.hasADT && stage.consentStatus === 'Consented') {
        data.tasks.push({
            id: `T-${seed.id}-ADT`,
            title: 'ADT Follow-up Required',
            type: 'ADT',
            status: 'Open',
            dueDate: getFutureDate(3),
            priority: 'High',
            assignedTo: careManagerName,
            group: 'Care Management Team A'
        });
    }
    
    return data;
}

function generateServiceNotes(seed, stage, careManagerName) {
    const notes = [];
    
    if (stage.consentStatus === 'To Obtain Consent') {
        // Only consent outreach notes
        const attempts = getRandomInt(2, 4);
        for (let i = 0; i < attempts; i++) {
            notes.push({
                id: `SN-${seed.id}-${String(i + 1).padStart(3, '0')}`,
                date: getPastDate((attempts - i) * 7),
                time: `${getRandomInt(9, 17)}:${String(getRandomInt(0, 59)).padStart(2, '0')} ${getRandomInt(9, 11) < 12 ? 'AM' : 'PM'}`,
                type: 'Phone Call - Outbound',
                activity: 'Outreach for Consent',
                duration: `${getRandomInt(3, 10)} min`,
                status: 'Posted',
                author: careManagerName,
                supervisor: 'Sarah Mitchell',
                summary: `Attempted to reach member for consent. ${getRandomElement(['Left voicemail.', 'No answer.', 'Spoke briefly, member will call back.'])}`,
                outcome: getRandomElement(['Left voicemail', 'No answer', 'Callback requested'])
            });
        }
    } else if (stage.consentStatus === 'Declined') {
        notes.push({
            id: `SN-${seed.id}-001`,
            date: getPastDate(14),
            time: '10:30 AM',
            type: 'Phone Call - Outbound',
            activity: 'Consent Discussion',
            duration: '12 min',
            status: 'Posted',
            author: careManagerName,
            supervisor: 'Sarah Mitchell',
            summary: 'Spoke with member about care management program. Member declined participation at this time, stating they prefer to manage their care independently.',
            outcome: 'Member Declined'
        });
    } else if (stage.id >= 3) { // Consented or Re-consent Required
        // Consent obtained note
        notes.push({
            id: `SN-${seed.id}-001`,
            date: getPastDate(getRandomInt(60, 90)),
            time: '11:15 AM',
            type: 'Phone Call - Outbound',
            activity: 'Consent Obtained',
            duration: '18 min',
            status: 'Posted',
            author: careManagerName,
            supervisor: 'Sarah Mitchell',
            summary: 'Called member to discuss care management program. Explained benefits and services. Member verbally consented to participation.',
            outcome: 'Consent Obtained'
        });
        
        if (stage.id >= 4) { // Assessment in progress or beyond
            notes.push({
                id: `SN-${seed.id}-002`,
                date: getPastDate(getRandomInt(30, 45)),
                time: '2:00 PM',
                type: 'Phone Call - Outbound',
                activity: 'Initial Assessment',
                duration: '35 min',
                status: 'Posted',
                author: careManagerName,
                supervisor: 'Sarah Mitchell',
                summary: 'Conducted initial health risk assessment with member. Reviewed medical history, current medications, and social support systems.',
                outcome: 'Assessment Started'
            });
        }
        
        if (stage.id >= 5) { // Care plan building or beyond
            notes.push({
                id: `SN-${seed.id}-003`,
                date: getPastDate(getRandomInt(14, 25)),
                time: '10:00 AM',
                type: 'Phone Call - Outbound',
                activity: 'Care Plan Discussion',
                duration: '28 min',
                status: 'Posted',
                author: careManagerName,
                supervisor: 'Sarah Mitchell',
                summary: 'Discussed care plan goals with member. Identified key health priorities and established initial goals for chronic disease management.',
                outcome: 'Goals Established'
            });
        }
        
        if (stage.id === 6) { // Fully active - regular check-ins
            notes.push({
                id: `SN-${seed.id}-004`,
                date: getPastDate(7),
                time: '3:30 PM',
                type: 'Phone Call - Outbound',
                activity: 'Care Management Check-in',
                duration: '22 min',
                status: 'Posted',
                author: careManagerName,
                supervisor: 'Sarah Mitchell',
                summary: 'Monthly check-in call. Member reports doing well with medication adherence. Discussed upcoming PCP appointment.',
                outcome: 'Successful'
            });
            notes.push({
                id: `SN-${seed.id}-005`,
                date: getPastDate(1),
                time: '9:45 AM',
                type: 'Phone Call - Inbound',
                activity: 'Member Inquiry',
                duration: '15 min',
                status: 'Draft',
                author: careManagerName,
                supervisor: 'Sarah Mitchell',
                summary: 'Member called with questions about prescription refill process. Provided guidance and confirmed pharmacy information.',
                outcome: 'Issue Resolved'
            });
        }
        
        if (stage.consentStatus === 'Re-consent Required') {
            notes.push({
                id: `SN-${seed.id}-REC`,
                date: getPastDate(3),
                time: '11:00 AM',
                type: 'Phone Call - Outbound',
                activity: 'Re-consent Outreach',
                duration: '8 min',
                status: 'Posted',
                author: careManagerName,
                supervisor: 'Sarah Mitchell',
                summary: 'Attempted to reach member for annual re-consent. Left voicemail explaining the need for updated consent.',
                outcome: 'Left voicemail'
            });
        }
    }
    
    return notes;
}

function generateTimelineEvents(seed, stage, careManagerName) {
    const events = [];
    
    // All members get assignment event
    events.push({
        date: '2025-01-01',
        type: 'workflow',
        title: 'Member Assignment',
        details: `Member assigned to ${careManagerName}`,
        user: 'System',
        time: '09:00 AM'
    });
    
    if (stage.consentStatus !== 'To Obtain Consent') {
        events.push({
            date: getPastDate(getRandomInt(60, 90)),
            type: 'consent',
            title: stage.consentStatus === 'Declined' ? 'Consent Declined' : 'Consent Obtained',
            details: stage.consentStatus === 'Declined' ? 'Member declined program participation' : 'Member provided verbal consent',
            user: careManagerName,
            time: '11:15 AM'
        });
    }
    
    if (stage.id >= 4 && stage.consentStatus === 'Consented') {
        events.push({
            date: getPastDate(getRandomInt(30, 45)),
            type: 'assessment',
            title: 'Assessment Started',
            details: 'Health Risk Assessment initiated',
            user: careManagerName,
            time: '2:00 PM'
        });
    }
    
    if (stage.id >= 5 && stage.consentStatus === 'Consented') {
        events.push({
            date: getPastDate(getRandomInt(20, 30)),
            type: 'assessment',
            title: 'Assessment Completed',
            details: 'Health Risk Assessment completed',
            user: careManagerName,
            time: '10:30 AM'
        });
        events.push({
            date: getPastDate(getRandomInt(14, 20)),
            type: 'careplan',
            title: 'Care Plan Created',
            details: 'Initial care plan created based on assessment findings',
            user: careManagerName,
            time: '3:00 PM'
        });
    }
    
    if (seed.hasADT) {
        events.push({
            date: getPastDate(getRandomInt(1, 14)),
            type: 'adt',
            title: 'ADT Event Received',
            details: `${getRandomElement(['Hospital admission', 'ED visit', 'Discharge'])} notification received`,
            user: 'System',
            time: '08:00 AM'
        });
    }
    
    return events.sort((a, b) => new Date(b.date) - new Date(a.date));
}

function generateAssessmentActivity(seed, stage, careManagerName) {
    if (stage.id < 4 || stage.consentStatus === 'Declined') {
        return []; // No assessment activity for early stages or declined
    }
    
    const activity = [];
    
    if (stage.id === 4) { // In progress
        activity.push({
            id: `ASS-${seed.id}-001`,
            title: 'Health Risk Assessment (HRA)',
            status: 'In Progress',
            date: getPastDate(getRandomInt(7, 14)),
            score: '-',
            user: careManagerName
        });
    } else if (stage.id >= 5) { // Completed
        activity.push({
            id: `ASS-${seed.id}-001`,
            title: 'Health Risk Assessment (HRA)',
            status: 'Completed',
            date: getPastDate(getRandomInt(20, 40)),
            score: `${getRandomInt(15, 35)}/40`,
            user: careManagerName
        });
        activity.push({
            id: `ASS-${seed.id}-002`,
            title: 'PHQ-9 Depression Screening',
            status: 'Completed',
            date: getPastDate(getRandomInt(15, 30)),
            score: `${getRandomInt(2, 12)}/27`,
            user: careManagerName
        });
        
        if (stage.id === 6) { // Fully active - more assessments
            activity.push({
                id: `ASS-${seed.id}-003`,
                title: 'Falls Risk Assessment',
                status: 'Completed',
                date: getPastDate(getRandomInt(10, 20)),
                score: seed.riskTier >= 3 ? 'High Risk' : 'Low Risk',
                user: careManagerName
            });
            activity.push({
                id: `ASS-${seed.id}-004`,
                title: 'Social Determinants of Health',
                status: 'Completed',
                date: getPastDate(getRandomInt(5, 15)),
                score: `${getRandomInt(12, 24)}/30`,
                user: careManagerName
            });
        }
    }
    
    return activity;
}

function generateLivingArrangements(seed) {
    const options = [
        { cat: 'Private Home - alone', stable: 'Yes', desc: 'Owns home, lives independently' },
        { cat: 'Private Home - with family', stable: 'Yes', desc: 'Lives with spouse/children' },
        { cat: 'Rented Apartment', stable: 'Yes', desc: '1-year lease' },
        { cat: 'Assisted Living', stable: 'Yes', desc: 'Facility provides daily support' }
    ];
    
    const opt = getRandomElement(options);
    return [{
        id: `liv-${seed.id}-0`,
        category: opt.cat,
        stable: opt.stable,
        description: opt.desc,
        recordedDate: getPastDate(getRandomInt(30, 90)),
        endDate: ''
    }];
}

function generateEducation(seed, age) {
    const levels = ['High School Diploma', 'Associate Degree', 'Bachelor\'s Degree', 'GED', 'Some College'];
    return [{
        id: `edu-${seed.id}-0`,
        status: 'Completed',
        level: getRandomElement(levels),
        description: 'Verified via self-report',
        recordedDate: getPastDate(getRandomInt(30, 90)),
        endDate: ''
    }];
}

function generateEmployment(seed, age) {
    const options = age >= 65 
        ? [{ status: 'Retired', type: 'Retired', desc: 'Retired' }]
        : [
            { status: 'Current', type: 'Full-time', desc: 'Employed full-time' },
            { status: 'Current', type: 'Part-time', desc: 'Employed part-time' },
            { status: 'Unemployed', type: 'Unemployed', desc: 'Currently seeking employment' }
        ];
    
    const opt = getRandomElement(options);
    return [{
        id: `emp-${seed.id}-0`,
        status: opt.status,
        type: opt.type,
        description: opt.desc,
        recordedDate: getPastDate(getRandomInt(30, 90)),
        endDate: ''
    }];
}

function generateVolunteering(seed) {
    if (Math.random() > 0.4) {
        return [{
            id: `vol-${seed.id}-0`,
            status: 'Active',
            type: 'Weekly',
            description: getRandomElement(['Church volunteer', 'Community center', 'Food bank']),
            recordedDate: getPastDate(getRandomInt(30, 60)),
            endDate: ''
        }];
    }
    return [];
}

function generateHealthHistoryData(seed, stage, memberDiagnoses) {
    // Non-consented members get empty health history
    if (!stage.hasHealthHistory) {
        return {
            adts: [],
            claims: { institutional: [], professional: [] },
            diagnoses: [],
            coreHealth: [],
            medications: [],
            allergies: [],
            labs: [],
            immunizations: []
        };
    }
    
    const history = {
        adts: [],
        claims: { institutional: [], professional: [] },
        diagnoses: [],
        coreHealth: [],
        medications: [],
        allergies: [],
        labs: [],
        immunizations: []
    };
    
    // ADTs
    if (seed.hasADT) {
        history.adts.push({
            date: getPastDate(getRandomInt(1, 14)),
            type: getRandomElement(['Emergency', 'Inpatient']),
            facility: getRandomElement(FACILITIES),
            diagnosis: memberDiagnoses[0]?.desc || 'General illness',
            status: 'Discharged'
        });
    }
    // Add some historical ADTs for high-risk members
    if (seed.riskTier >= 3) {
        history.adts.push({
            date: getPastDate(getRandomInt(60, 120)),
            type: 'Emergency',
            facility: getRandomElement(FACILITIES),
            diagnosis: memberDiagnoses[0]?.desc || 'General illness',
            status: 'Discharged'
        });
    }
    
    // Claims
    const numClaims = seed.riskTier >= 3 ? 3 : 1;
    for (let i = 0; i < numClaims; i++) {
        history.claims.institutional.push({
            id: `INST-${seed.id}-${1000 + i}`,
            provider: getRandomElement(FACILITIES),
            dates: `${getPastDate(90 + i * 30)} - ${getPastDate(88 + i * 30)}`,
            total: `$${(getRandomInt(1000, 5000)).toFixed(2)}`,
            status: 'Paid'
        });
        history.claims.professional.push({
            id: `PROF-${seed.id}-${5000 + i}`,
            provider: `Dr. ${getRandomElement(['Smith', 'Johnson', 'Williams'])}`,
            dates: getPastDate(60 + i * 20),
            total: `$${(getRandomInt(50, 200)).toFixed(2)}`,
            status: 'Paid'
        });
    }
    
    // Diagnoses
    memberDiagnoses.forEach((dx, i) => {
        history.diagnoses.push({
            code: dx.code,
            desc: dx.desc,
            type: i === 0 ? 'Principal' : 'Secondary',
            date: getPastDate(getRandomInt(30, 180)),
            source: 'Claims'
        });
    });
    
    // Core Health (Vitals)
    for (let i = 0; i < 3; i++) {
        history.coreHealth.push({
            date: getPastDate(i * 30 + 7),
            bp: `${getRandomInt(110, 140)}/${getRandomInt(70, 90)}`,
            bmi: (getRandomInt(220, 320) / 10).toFixed(1),
            weight: `${getRandomInt(140, 220)} lbs`,
            pulse: getRandomInt(65, 85)
        });
    }
    
    // Medications based on diagnoses
    const meds = [
        { name: 'Metformin', dose: '500mg', freq: 'Twice daily' },
        { name: 'Lisinopril', dose: '10mg', freq: 'Daily' },
        { name: 'Atorvastatin', dose: '20mg', freq: 'Daily' },
        { name: 'Metoprolol', dose: '25mg', freq: 'Twice daily' }
    ];
    const numMeds = Math.min(seed.riskTier, meds.length);
    for (let i = 0; i < numMeds; i++) {
        history.medications.push({
            name: meds[i].name,
            dose: meds[i].dose,
            freq: meds[i].freq,
            provider: `Dr. ${getRandomElement(['Smith', 'Johnson', 'Williams'])}`,
            pharmacy: `CVS #${getRandomInt(1000, 9999)}`,
            filled: getPastDate(getRandomInt(7, 30))
        });
    }
    
    // Allergies
    const allergies = [
        { name: 'Penicillin', reaction: 'Hives', severity: 'Moderate' },
        { name: 'No Known Drug Allergies', reaction: 'N/A', severity: 'N/A' }
    ];
    history.allergies.push(Math.random() > 0.7 ? allergies[0] : allergies[1]);
    
    // Labs
    const labs = [
        { test: 'Hemoglobin A1c', result: `${(getRandomInt(55, 85) / 10).toFixed(1)}%`, range: '< 5.7%' },
        { test: 'Lipid Panel', result: `Cholesterol ${getRandomInt(160, 220)}`, range: '< 200' },
        { test: 'CBC with Diff', result: 'Normal', range: 'N/A' }
    ];
    labs.forEach(lab => {
        history.labs.push({
            ...lab,
            date: getPastDate(getRandomInt(14, 90)),
            provider: 'LabCorp'
        });
    });
    
    // Immunizations
    history.immunizations = [
        { name: 'Influenza (Flu)', date: '10/15/2024', provider: 'Walgreens', status: 'Completed' },
        { name: 'COVID-19 Booster', date: '11/02/2024', provider: 'CVS', status: 'Completed' }
    ];
    
    return history;
}

function generateActivityLog(seed, stage, careManagerName) {
    const log = [];
    
    log.push({
        date: '2025-01-01',
        action: 'Member Assigned',
        details: `Member assigned to ${careManagerName}`,
        user: 'System'
    });
    
    if (stage.consentStatus !== 'To Obtain Consent') {
        log.push({
            date: getPastDate(getRandomInt(60, 90)),
            action: stage.consentStatus === 'Declined' ? 'Consent Declined' : 'Consent Obtained',
            details: stage.consentStatus === 'Declined' ? 'Member declined participation' : 'Verbal consent documented',
            user: careManagerName
        });
    }
    
    if (stage.id >= 4 && stage.consentStatus === 'Consented') {
        log.push({
            date: getPastDate(getRandomInt(30, 45)),
            action: 'Assessment Started',
            details: 'HRA assessment initiated',
            user: careManagerName
        });
    }
    
    if (stage.id >= 5 && stage.consentStatus === 'Consented') {
        log.push({
            date: getPastDate(getRandomInt(20, 30)),
            action: 'Assessment Completed',
            details: 'HRA assessment completed',
            user: careManagerName
        });
        log.push({
            date: getPastDate(getRandomInt(14, 20)),
            action: 'Care Plan Created',
            details: 'Initial care plan established',
            user: careManagerName
        });
    }
    
    return log;
}

function generateActivityHistoryData(seed, stage, careManagerName) {
    const data = {
        serviceNotes: [],
        events: [],
        referrals: []
    };
    
    // Service Notes based on journey stage
    if (stage.consentStatus === 'To Obtain Consent') {
        const attempts = getRandomInt(2, 5);
        for (let i = 0; i < attempts; i++) {
            data.serviceNotes.push({
                id: 'SN-' + seed.id + '-' + (1000 + i),
                staff: careManagerName,
                type: 'Phone Call',
                activity: 'Consent Outreach',
                duration: getRandomInt(5, 15) + ' min',
                date: getPastDate((attempts - i) * 7),
                submitted: getPastDate((attempts - i) * 7),
                status: '<span style="background:#dcfce7; color:#166534; padding:2px 6px; border-radius:12px; font-size:11px;">Completed</span>',
                version: '1.0',
                purpose: 'Consent Outreach'
            });
        }
    } else if (stage.consentStatus === 'Declined') {
        data.serviceNotes.push({
            id: 'SN-' + seed.id + '-1000',
            staff: careManagerName,
            type: 'Phone Call',
            activity: 'Consent Outreach',
            duration: '10 min',
            date: getPastDate(14),
            submitted: getPastDate(14),
            status: '<span style="background:#fee2e2; color:#991b1b; padding:2px 6px; border-radius:12px; font-size:11px;">Declined</span>',
            version: '1.0',
            purpose: 'Consent - Declined'
        });
    } else if (stage.consentStatus === 'Consented' || stage.consentStatus === 'Re-consent Required') {
        // Consent call
        data.serviceNotes.push({
            id: 'SN-' + seed.id + '-1000',
            staff: careManagerName,
            type: 'Phone Call',
            activity: 'Consent Obtained',
            duration: '12 min',
            date: getPastDate(getRandomInt(60, 90)),
            submitted: getPastDate(getRandomInt(60, 90)),
            status: '<span style="background:#dcfce7; color:#166534; padding:2px 6px; border-radius:12px; font-size:11px;">Completed</span>',
            version: '1.0',
            purpose: 'Initial Consent'
        });
        
        if (stage.id >= 4) {
            // Assessment-related notes
            data.serviceNotes.push({
                id: 'SN-' + seed.id + '-1001',
                staff: careManagerName,
                type: 'Phone Call',
                activity: 'Assessment',
                duration: '45 min',
                date: getPastDate(getRandomInt(30, 45)),
                submitted: getPastDate(getRandomInt(30, 45)),
                status: '<span style="background:#dcfce7; color:#166534; padding:2px 6px; border-radius:12px; font-size:11px;">Completed</span>',
                version: '1.0',
                purpose: 'Health Risk Assessment'
            });
        }
        
        if (stage.id >= 5) {
            data.serviceNotes.push({
                id: 'SN-' + seed.id + '-1002',
                staff: careManagerName,
                type: 'Phone Call',
                activity: 'Care Plan Review',
                duration: '30 min',
                date: getPastDate(getRandomInt(14, 20)),
                submitted: getPastDate(getRandomInt(14, 20)),
                status: '<span style="background:#dcfce7; color:#166534; padding:2px 6px; border-radius:12px; font-size:11px;">Completed</span>',
                version: '1.0',
                purpose: 'Care Plan Development'
            });
        }
        
        if (stage.id === 6) {
            // Ongoing follow-up notes
            for (let i = 0; i < getRandomInt(2, 4); i++) {
                data.serviceNotes.push({
                    id: 'SN-' + seed.id + '-' + (1010 + i),
                    staff: careManagerName,
                    type: getRandomElement(['Phone Call', 'Home Visit', 'Video Call']),
                    activity: getRandomElement(['Follow-up', 'Care Coordination', 'Medication Review', 'Wellness Check']),
                    duration: getRandomInt(10, 45) + ' min',
                    date: getPastDate(getRandomInt(1, 30)),
                    submitted: getPastDate(getRandomInt(1, 30)),
                    status: '<span style="background:#dcfce7; color:#166534; padding:2px 6px; border-radius:12px; font-size:11px;">Completed</span>',
                    version: '1.0',
                    purpose: 'Ongoing Care Management'
                });
            }
        }
    }
    
    // Events based on journey stage
    if (stage.id >= 3) {
        data.events.push({
            name: 'Initial Outreach - Consent Obtained',
            owner: careManagerName,
            status: '<span style="background:#dcfce7; color:#166534; padding:2px 6px; border-radius:12px; font-size:11px;">Completed</span>',
            priority: 'High',
            deadline: getPastDate(getRandomInt(60, 90)),
            start: getPastDate(getRandomInt(60, 90))
        });
    }
    if (stage.id >= 4) {
        data.events.push({
            name: 'Complete Health Risk Assessment',
            owner: careManagerName,
            status: stage.id === 4 ? '<span style="background:#fef3c7; color:#d97706; padding:2px 6px; border-radius:12px; font-size:11px;">In Progress</span>' : '<span style="background:#dcfce7; color:#166534; padding:2px 6px; border-radius:12px; font-size:11px;">Completed</span>',
            priority: 'High',
            deadline: getPastDate(getRandomInt(20, 40)),
            start: getPastDate(getRandomInt(30, 45))
        });
    }
    if (stage.id >= 5) {
        data.events.push({
            name: 'Develop Care Plan',
            owner: careManagerName,
            status: stage.id === 5 ? '<span style="background:#fef3c7; color:#d97706; padding:2px 6px; border-radius:12px; font-size:11px;">In Progress</span>' : '<span style="background:#dcfce7; color:#166534; padding:2px 6px; border-radius:12px; font-size:11px;">Completed</span>',
            priority: 'Medium',
            deadline: getPastDate(getRandomInt(7, 14)),
            start: getPastDate(getRandomInt(14, 20))
        });
    }
    if (stage.id === 6) {
        data.events.push({
            name: 'Monthly Follow-up Call',
            owner: careManagerName,
            status: '<span style="background:#dbeafe; color:#1d4ed8; padding:2px 6px; border-radius:12px; font-size:11px;">Scheduled</span>',
            priority: 'Medium',
            deadline: getFutureDate(getRandomInt(7, 14)),
            start: getFutureDate(getRandomInt(7, 14))
        });
        data.events.push({
            name: 'Quarterly Care Plan Review',
            owner: careManagerName,
            status: '<span style="background:#dbeafe; color:#1d4ed8; padding:2px 6px; border-radius:12px; font-size:11px;">Scheduled</span>',
            priority: 'Low',
            deadline: getFutureDate(getRandomInt(30, 60)),
            start: getFutureDate(getRandomInt(30, 60))
        });
    }
    if (stage.consentStatus === 'To Obtain Consent') {
        data.events.push({
            name: 'Obtain Member Consent',
            owner: careManagerName,
            status: '<span style="background:#fef3c7; color:#d97706; padding:2px 6px; border-radius:12px; font-size:11px;">Pending</span>',
            priority: 'High',
            deadline: getFutureDate(getRandomInt(3, 7)),
            start: getPastDate(getRandomInt(7, 14))
        });
    }
    
    // Referrals based on journey stage
    if (stage.id >= 5 && seed.riskTier >= 3) {
        data.referrals.push({
            id: 'REF-' + seed.id + '-001',
            type: 'Internal',
            reason: getRandomElement(['Behavioral Health Consultation', 'Nutrition Counseling', 'Social Work Assessment', 'Pharmacy Consultation']),
            recipient: 'Dr. ' + getRandomElement(['Smith', 'Johnson', 'Williams', 'Brown']),
            status: '<span style="background:#dcfce7; color:#166534; padding:2px 6px; border-radius:12px; font-size:11px;">Accepted</span>',
            sentDate: getPastDate(getRandomInt(7, 30))
        });
    }
    if (stage.id === 6 && seed.riskTier >= 4) {
        data.referrals.push({
            id: 'REF-' + seed.id + '-002',
            type: 'External',
            reason: getRandomElement(['Specialist Consultation', 'DME Request', 'Home Health Services', 'Transportation Assistance']),
            recipient: getRandomElement(['Duke Specialty Clinic', 'WakeMed Outpatient', 'UNC Referral Center', 'Community Health Center']),
            status: '<span style="background:#fef3c7; color:#d97706; padding:2px 6px; border-radius:12px; font-size:11px;">Pending</span>',
            sentDate: getPastDate(getRandomInt(1, 14))
        });
    }
    
    return data;
}

function generateCarePlanDataForMember(seed, stage, careManagerName) {
    // Non-consented or early stage members get empty care plan
    if (stage.id < 5 || stage.consentStatus === 'Declined') {
        return {
            needs: [],
            activity: [],
            barriers: [],
            gaps: []
        };
    }
    
    const data = {
        needs: [],
        activity: [],
        barriers: [],
        gaps: []
    };
    
    // Generate needs with goals and interventions
    const needsLibrary = [
        { cat: 'Care Coordination', text: 'Member needs assistance coordinating care between multiple providers' },
        { cat: 'Chronic Disease Management', text: 'Member needs support managing chronic health conditions' },
        { cat: 'Medication Management', text: 'Member needs help with medication adherence and reconciliation' },
        { cat: 'Social Support', text: 'Member needs connection to community resources and support services' }
    ];
    
    const numNeeds = stage.id === 6 ? getRandomInt(2, 4) : 1;
    
    for (let n = 0; n < numNeeds; n++) {
        const template = needsLibrary[n % needsLibrary.length];
        const needId = `need-${seed.id}-${n}`;
        
        const need = {
            id: needId,
            text: template.text,
            category: template.cat,
            status: stage.id === 6 ? 'In Progress' : 'Identified',
            startDate: getPastDate(getRandomInt(14, 30)),
            daysToFollowUp: getRandomInt(7, 21),
            followUpDate: getFutureDate(getRandomInt(7, 21)),
            goals: []
        };
        
        // Add goals
        const numGoals = stage.id === 6 ? getRandomInt(1, 2) : 1;
        for (let g = 0; g < numGoals; g++) {
            const goalId = `${needId}-goal-${g}`;
            const goal = {
                id: goalId,
                text: `Improve ${template.cat.toLowerCase()} outcomes through targeted interventions`,
                status: stage.id === 6 ? 'In Progress' : 'Planned',
                startDate: getPastDate(getRandomInt(10, 20)),
                targetDate: getFutureDate(60),
                completedDate: '-',
                outcome: stage.id === 6 ? 'On Track' : '-',
                interventions: []
            };
            
            // Add interventions
            const numInterventions = stage.id === 6 ? getRandomInt(2, 3) : 1;
            for (let i = 0; i < numInterventions; i++) {
                goal.interventions.push({
                    id: `${goalId}-int-${i}`,
                    text: `Coordinate with healthcare team regarding ${template.cat.toLowerCase()}`,
                    status: getRandomElement(['Planned', 'In Progress', 'Completed']),
                    owner: careManagerName,
                    dueDate: getFutureDate(14 + i * 14)
                });
            }
            
            need.goals.push(goal);
        }
        
        data.needs.push(need);
    }
    
    // Activity log for care plan
    if (data.needs.length > 0) {
        data.activity = [
            { name: 'Care Plan Created', status: 'Done', date: getPastDate(20), updatedBy: careManagerName },
            { name: 'Needs Assessment', status: 'Done', date: getPastDate(15), updatedBy: careManagerName }
        ];
        if (stage.id === 6) {
            data.activity.push({ name: 'Goal Review', status: 'Done', date: getPastDate(7), updatedBy: careManagerName });
        }
    }
    
    // Barriers for some members
    if (seed.riskTier >= 3 && stage.id === 6) {
        data.barriers = [
            { category: 'Social', name: 'Transportation', description: 'Limited access to reliable transportation', status: 'Active' }
        ];
    }
    
    // Care gaps for high-risk members
    if (seed.riskTier >= 3 && stage.id === 6) {
        data.gaps = [
            { measure: 'HbA1c', desc: 'Diabetes monitoring needed', status: 'Open', identified: getPastDate(14) }
        ];
    }
    
    return data;
}

function generateHeaderData(seed, stage, mco) {
    const data = {
        alerts: [],
        lob: [],
        programs: [],
        populations: []
    };
    
    // Alerts based on status
    if (stage.consentStatus === 'To Obtain Consent') {
        data.alerts.push({ type: 'Consent', text: 'Member consent needs to be obtained.' });
    }
    if (stage.consentStatus === 'Re-consent Required') {
        data.alerts.push({ type: 'Consent', text: 'Annual re-consent required.' });
    }
    if (seed.hasADT) {
        data.alerts.push({ type: 'ADT Event', text: 'Unacknowledged ADT event.' });
    }
    if (seed.hasSafetyConcern) {
        data.alerts.push({ type: 'Safety', text: 'Member has documented safety concern.' });
    }
    
    // LOB
    const lobAssessments = [];
    const lobCarePlans = [];
    
    if (stage.id >= 4 && stage.consentStatus === 'Consented') {
        lobAssessments.push({
            id: 'hra-1',
            name: 'Health Risk Assessment',
            shortName: 'HRA',
            status: stage.id === 4 ? 'in-progress' : 'completed'
        });
    }
    if (stage.id >= 5 && stage.consentStatus === 'Consented') {
        lobCarePlans.push({
            id: 'cp-1',
            name: 'Standard Care Plan',
            status: stage.id === 5 ? 'in-progress' : 'active'
        });
    }
    
    data.lob.push({
        name: mco,
        risk: getRiskCategory(seed.riskTier),
        consent: {
            status: stage.consentStatus,
            date: stage.consentStatus === 'Consented' ? getPastDate(getRandomInt(30, 90)) : null
        },
        assessments: lobAssessments,
        carePlans: lobCarePlans
    });
    
    // Programs
    data.programs.push(getRandomElement(PROGRAMS));
    
    // Priority populations
    if (seed.hasPriorityPop) {
        data.populations.push(getRandomElement(PRIORITY_POPULATIONS));
    }
    
    return data;
}

// ============================================
// GENERATE ALL MEMBERS
// ============================================
const membersDB = MEMBER_SEEDS.map((seed, index) => generateMember(seed, index));

//  MULTI-PLAN OVERRIDES 
// Give 3 fully-active members realistic multi-plan setups so the AI plan picker
// can be tested directly from the member list without needing Test Header Scenarios.
// 
(function applyMultiPlanOverrides() {
    // MEM-024: 3 plans  Active CCM plan + Planned BH plan + Completed Wellness plan
    const m24 = membersDB.find(m => m.id === 'MEM-024');
    if (m24 && m24.lob && m24.lob[0]) {
        m24.lob[0].carePlans = [
            { id: 'ccm-cp-24',     name: 'Chronic Care Management Plan',  status: 'active' },
            { id: 'bh-cp-24',      name: 'Behavioral Health Action Plan',  status: 'planned' },
            { id: 'wellness-cp-24',name: 'Wellness Care Plan',             status: 'completed' },
        ];
        // Tag existing carePlanData needs to the active CCM plan
        if (m24.carePlanData?.needs) {
            m24.carePlanData.needs.forEach(n => { if (!n.planId) n.planId = 'ccm-cp-24'; });
        }
    }

    // MEM-025: 2 plans  Active Standard plan + Active RPM Monitoring plan
    const m25 = membersDB.find(m => m.id === 'MEM-025');
    if (m25 && m25.lob && m25.lob[0]) {
        m25.lob[0].carePlans = [
            { id: 'std-cp-25', name: 'Standard Care Plan',       status: 'active' },
            { id: 'rpm-cp-25', name: 'RPM Monitoring Plan',       status: 'active' },
        ];
        if (m25.carePlanData?.needs) {
            m25.carePlanData.needs.forEach(n => { if (!n.planId) n.planId = 'std-cp-25'; });
        }
    }

    // MEM-028: 3 plans  Active Diabetes plan + In Progress Transitional plan + Planned BH plan
    const m28 = membersDB.find(m => m.id === 'MEM-028');
    if (m28 && m28.lob && m28.lob[0]) {
        m28.lob[0].carePlans = [
            { id: 'dm-cp-28',   name: 'Diabetes Management Plan',   status: 'active' },
            { id: 'tc-cp-28',   name: 'Transitional Care Plan',      status: 'in-progress' },
            { id: 'bh-cp-28',   name: 'Behavioral Health Plan',      status: 'planned' },
        ];
        if (m28.carePlanData?.needs) {
            m28.carePlanData.needs.forEach(n => { if (!n.planId) n.planId = 'dm-cp-28'; });
        }
    }
})();
// 

// Export
if (typeof module !== 'undefined' && module.exports) {
    module.exports = membersDB;
}

// Export for use (if needed)
if (typeof module !== 'undefined' && module.exports) {
    module.exports = membersDB;
}


// ============================================================================
// CM ASSIGNMENT HISTORY  AB TEST (OPTIONS 1, 2, 3)
// Broadstep / Trillium Audit Requirement  Feb 2026
// ADDITIVE ONLY  no existing code modified
// ============================================================================

//  DATA GENERATION 
function _fmtAssignDate(d) {
    if (!d || !(d instanceof Date) || isNaN(d)) return '';
    return (d.getMonth()+1).toString().padStart(2,'0') + '/' + d.getDate().toString().padStart(2,'0') + '/' + d.getFullYear();
}
function _addMonths(d, n) { const r = new Date(d); r.setMonth(r.getMonth()+n); return r; }
function _addDays(d, n)   { const r = new Date(d); r.setDate(r.getDate()+n);   return r; }

function generateCMAssignmentHistory(seed, member) {
    const SUPERVISORS = ['Erica Richardson','James Whitfield','Linda Patel','David Brown','Sarah Mitchell'];
    const HIST_CMS    = ['Lucille Barberian','Madeline Patrick','Jazimyn Williams','Aziz Gida','Jennifer Wilson','Michael Chen','Sarah Johnson','Tara Evans'];
    const ASSIGNED_BY = ['Admin User','Erica Richardson','James Whitfield','System Auto-assign','Sarah Mitchell'];
    const n = seed.id || 0;

    const sup1 = SUPERVISORS[n % SUPERVISORS.length];
    const sup2 = SUPERVISORS[(n+2) % SUPERVISORS.length];
    const cm1  = HIST_CMS[n % HIST_CMS.length];
    const cm2  = HIST_CMS[(n+2) % HIST_CMS.length];
    const cm3  = member.careManager || HIST_CMS[(n+4) % HIST_CMS.length];
    const sup3 = (cm3 === 'Michael Chen' || cm3 === 'Sarah Johnson') ? 'David Brown' : 'Sarah Mitchell';
    const by   = (x) => ASSIGNED_BY[x % ASSIGNED_BY.length];

    const base     = new Date(2023, n % 6, 1 + (n % 20));
    const consent1 = _addMonths(base, 1);
    const cm1End   = _addMonths(base, 4 + (n % 4));
    const cm2Start = _addDays(cm1End, 3);
    const hasOptOut = (n % 3 === 0);
    const optOutDate = hasOptOut ? _addMonths(cm2Start, 2) : null;
    const cm2End   = hasOptOut ? optOutDate : _addMonths(cm2Start, 5 + (n % 4));
    const cm3Start = _addDays(cm2End, hasOptOut ? 30 : 5);
    const sup1EndDate = _addDays(cm2End, 0);

    const records = [];

    //  Row 1: Initial Assignment 
    records.push({
        supervisorName:         sup1,
        supervisorAssignedDate: _fmtAssignDate(base),
        supervisorEndDate:      _fmtAssignDate(sup1EndDate),
        careManagerName:        cm1,
        careManagerAssignedDate:_fmtAssignDate(base),
        careManagerEndDate:     _fmtAssignDate(cm1End),
        consentStatus:          'Consented',
        consentDate:            _fmtAssignDate(consent1),
        optOutDate:             '',
        assignedBy:             by(n),
        notes:                  'Initial enrollment. Member enrolled and consented.',
        isCurrent:              false
    });

    //  Row 2: Reassignment 
    records.push({
        supervisorName:         sup1,
        supervisorAssignedDate: _fmtAssignDate(base),
        supervisorEndDate:      _fmtAssignDate(sup1EndDate),
        careManagerName:        cm2,
        careManagerAssignedDate:_fmtAssignDate(cm2Start),
        careManagerEndDate:     _fmtAssignDate(cm2End),
        consentStatus:          hasOptOut ? 'Opted Out' : 'Consented',
        consentDate:            _fmtAssignDate(cm2Start),
        optOutDate:             hasOptOut ? _fmtAssignDate(optOutDate) : '',
        assignedBy:             by(n+1),
        notes:                  hasOptOut ? 'Member requested opt-out. Assignment suspended.' : 'Reassignment  previous CM departed organization.',
        isCurrent:              false
    });

    //  Row 3: Current Assignment (re-consent if opted out) 
    records.push({
        supervisorName:         sup3,
        supervisorAssignedDate: _fmtAssignDate(cm3Start),
        supervisorEndDate:      '',
        careManagerName:        cm3,
        careManagerAssignedDate:_fmtAssignDate(cm3Start),
        careManagerEndDate:     '',
        consentStatus:          'Consented',
        consentDate:            hasOptOut ? _fmtAssignDate(cm3Start) : '',
        optOutDate:             '',
        assignedBy:             by(n+2),
        notes:                  hasOptOut ? 'Member re-consented. New supervisor and CM assigned.' : 'Current assignment.',
        isCurrent:              true
    });

    return records;
}

// Inject into all members (additive, no modification to generateMember)
(function injectCMAssignmentHistory() {
    if (typeof membersDB === 'undefined') return;
    membersDB.forEach(function(member, index) {
        if (!member.cmAssignmentHistory) {
            const seed = (typeof MEMBER_SEEDS !== 'undefined' && MEMBER_SEEDS[index]) ? MEMBER_SEEDS[index] : { id: index };
            member.cmAssignmentHistory = generateCMAssignmentHistory(seed, member);
        }
    });
})();


//  CONTROLLER 
const CMAssignmentHistoryController = {

    // Shared table renderer used by all 3 options
    renderTable: function(member) {
        // Sanitise  resolve any undefined values before rendering
        const SUPERVISORS_FB = ['Erica Richardson','Sarah Mitchell','David Brown','James Whitfield','Linda Patel'];
        const CMS_FB = ['Jennifer Wilson','Michael Chen','Sarah Johnson','Jazimyn Williams','Lucille Barberian'];
        const memberIdx = parseInt((member.id || '0').replace(/\D/g,'').slice(-2) || '0', 10);
        const fbSup = member.careTeamData?.supervisor || member.supervisor || SUPERVISORS_FB[memberIdx % SUPERVISORS_FB.length];
        const fbCM  = member.careTeamData?.primary   || member.careManager  || CMS_FB[memberIdx % CMS_FB.length];
        const clean = function(v, fallback) {
            return (!v || v === 'undefined' || v === 'null') ? fallback : v;
        };

        const rows = (member.cmAssignmentHistory || []).map(function(r) {
            return Object.assign({}, r, {
                supervisorName:          clean(r.supervisorName, fbSup),
                careManagerName:         clean(r.careManagerName, fbCM),
                supervisorAssignedDate:  clean(r.supervisorAssignedDate, ''),
                supervisorEndDate:       clean(r.supervisorEndDate, ''),
                careManagerAssignedDate: clean(r.careManagerAssignedDate, ''),
                careManagerEndDate:      clean(r.careManagerEndDate, ''),
            });
        });
        const tbody = rows.map(function(r) {
            const statusBadge = r.consentStatus === 'Opted Out'
                ? '<span style="background:#fee2e2;color:#dc2626;padding:2px 8px;border-radius:12px;font-size:11px;font-weight:600;">Opted Out</span>'
                : r.consentStatus === 'Consented'
                    ? '<span style="background:#dcfce7;color:#166534;padding:2px 8px;border-radius:12px;font-size:11px;font-weight:600;">Consented</span>'
                    : '<span style="background:#fef9c3;color:#854d0e;padding:2px 8px;border-radius:12px;font-size:11px;font-weight:600;">' + r.consentStatus + '</span>';
            const currentBadge = r.isCurrent ? ' <span style="background:#e0e7ff;color:#4338ca;padding:1px 6px;border-radius:8px;font-size:10px;margin-left:4px;">Current</span>' : '';
            return '<tr style="' + (r.isCurrent ? 'background:#f8faff;' : '') + '">'
                + '<td>' + (member.medicaidId || '') + '</td>'
                + '<td>' + r.supervisorName + '</td>'
                + '<td>' + r.supervisorAssignedDate + '</td>'
                + '<td>' + r.supervisorEndDate + '</td>'
                + '<td>' + r.careManagerName + currentBadge + '</td>'
                + '<td>' + r.careManagerAssignedDate + '</td>'
                + '<td>' + r.careManagerEndDate + '</td>'
                + '<td>' + statusBadge + '</td>'
                + '<td>' + (r.consentDate || '') + '</td>'
                + '<td>' + (r.optOutDate || '') + '</td>'
                + '<td style="color:#64748b;font-size:12px;">' + (r.notes || '') + '</td>'
                + '</tr>';
        }).join('');

        return '<div class="task-table-wrapper" style="overflow-x:auto;">'
            + '<table class="dashboard-table act-table" style="min-width:1100px;">'
            + '<thead><tr>'
            + '<th>Medicaid ID</th>'
            + '<th>Supervisor Name</th>'
            + '<th>Supervisor Assigned Date</th>'
            + '<th>Supervisor End Date</th>'
            + '<th>Care Manager Name</th>'
            + '<th>CM Assigned Date</th>'
            + '<th>CM End Date</th>'
            + '<th>Consent Status</th>'
            + '<th>Consent Date</th>'
            + '<th>Opt Out Date</th>'
            + '<th>Notes / Reason</th>'
            + '</tr></thead>'
            + '<tbody>' + tbody + '</tbody>'
            + '</table></div>'
            + '<div class="pagination" style="margin-top:12px;"><span>Showing ' + rows.length + ' of ' + rows.length + ' records</span></div>';
    },

    // OPTION 2: Full tab render with summary strip + export
    render: function(member) {
        const current = (member.cmAssignmentHistory || []).find(function(r) { return r.isCurrent; }) || {};
        const totalRecords = (member.cmAssignmentHistory || []).length;
        const isConsented = member.consentStatus && member.consentStatus.toLowerCase().includes('consent') && !member.consentStatus.toLowerCase().includes('opt');

        return '<div style="padding:24px;">'
            //  Current Assignment Strip 
            + '<div style="background:#f0f1fb;border:1px solid #d0d3f0;border-radius:8px;padding:16px 20px;margin-bottom:24px;display:flex;flex-wrap:wrap;gap:24px;align-items:center;">'
            + '<div><div style="font-size:10px;font-weight:700;color:#6b7280;text-transform:uppercase;letter-spacing:.05em;margin-bottom:4px;">Medicaid ID</div>'
            + '<div style="font-size:14px;font-weight:600;color:#1e293b;">' + (member.medicaidId || '') + '</div></div>'
            + '<div><div style="font-size:10px;font-weight:700;color:#6b7280;text-transform:uppercase;letter-spacing:.05em;margin-bottom:4px;">Current Supervisor</div>'
            + '<div style="font-size:14px;font-weight:600;color:#1e293b;">' + (current.supervisorName || '') + '</div></div>'
            + '<div><div style="font-size:10px;font-weight:700;color:#6b7280;text-transform:uppercase;letter-spacing:.05em;margin-bottom:4px;">Current Care Manager</div>'
            + '<div style="font-size:14px;font-weight:600;color:#1e293b;">' + (current.careManagerName || member.careManager || '') + '</div></div>'
            + '<div><div style="font-size:10px;font-weight:700;color:#6b7280;text-transform:uppercase;letter-spacing:.05em;margin-bottom:4px;">Currently Consented?</div>'
            + '<div style="font-size:14px;font-weight:600;color:' + (isConsented ? '#166534' : '#dc2626') + ';">' + (isConsented ? 'Yes' : 'No') + '</div></div>'
            + '<div style="margin-left:auto;">'
            + '<button class="btn btn-primary" onclick="CMAssignmentHistoryController.exportCSV(window.currentMember)" style="display:flex;align-items:center;gap:6px;">'
            + '<svg width="14" height="14" fill="currentColor" viewBox="0 0 16 16"><path d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5z"/><path d="M7.646 11.854a.5.5 0 0 0 .708 0l3-3a.5.5 0 0 0-.708-.708L8.5 10.293V1.5a.5.5 0 0 0-1 0v8.793L5.354 8.146a.5.5 0 1 0-.708.708l3 3z"/></svg>'
            + 'Export CSV</button></div>'
            + '</div>'
            //  Table header row 
            + '<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;">'
            + '<h3 style="font-size:16px;font-weight:600;color:#1e293b;margin:0;">CM Assignment History <span style="font-size:13px;color:#64748b;font-weight:400;">(' + totalRecords + ' records)</span></h3>'
            + '<div style="font-size:12px;color:#64748b;background:#fef9c3;border:1px solid #fde68a;padding:4px 10px;border-radius:6px;">Broadstep / Trillium Audit Report</div>'
            + '</div>'
            + CMAssignmentHistoryController.renderTable(member)
            + '</div>';
    },

    // Inline sub-section rendered inside Other Information accordion
    renderCMDetailsSection: function(member) {
        var current = (member.cmAssignmentHistory || []).find(function(r) { return r.isCurrent; }) || {};
        var isConsented = member.consentStatus && member.consentStatus.toLowerCase().includes('consent') && !member.consentStatus.toLowerCase().includes('opt');
        var totalRecords = (member.cmAssignmentHistory || []).length;

        return '<div style="display:grid;grid-template-columns:1fr 1fr;gap:0 32px;">'
            // Left col
            + '<div><h4 class="other-info-title" style="margin-bottom:8px;">CARE MANAGEMENT DETAILS</h4>'
            + '<div class="info-pair"><span class="info-label">CURRENT SUPERVISOR</span><span class="info-value" style="font-weight:500;">' + (current.supervisorName || '') + '</span></div>'
            + '<div class="info-pair"><span class="info-label">ASSIGNED TO SUPERVISOR</span><span class="info-value">' + (current.supervisorAssignedDate || '') + '</span></div>'
            + '<div class="info-pair"><span class="info-label">CURRENT CARE MANAGER</span><span class="info-value" style="font-weight:500;">' + (current.careManagerName || member.careManager || '') + '</span></div>'
            + '<div class="info-pair"><span class="info-label">ASSIGNED TO CM</span><span class="info-value">' + (current.careManagerAssignedDate || '') + '</span></div>'
            + '</div>'
            // Right col
            + '<div><h4 class="other-info-title" style="margin-bottom:8px;">&nbsp;</h4>'
            + '<div class="info-pair"><span class="info-label">CONSENT STATUS</span><span class="info-value" style="color:' + (isConsented ? '#166534' : '#dc2626') + ';font-weight:600;">' + (member.consentStatus || '') + '</span></div>'
            + '<div class="info-pair"><span class="info-label">CURRENTLY CONSENTED?</span><span class="info-value" style="font-weight:600;color:' + (isConsented ? '#166534' : '#dc2626') + ';">' + (isConsented ? 'Yes' : 'No') + '</span></div>'
            + '</div>'
            + '</div>'
            // History strip
            + '<div style="display:flex;justify-content:space-between;align-items:center;margin-top:12px;padding-top:10px;border-top:1px solid #f1f5f9;">'
            + '<span style="font-size:12px;font-weight:600;color:#374151;">Full Assignment History <span style="font-weight:400;color:#64748b;">(' + totalRecords + ' records)</span></span>'
            + '<button class="btn btn-secondary" style="font-size:11px;padding:4px 10px;" onclick="CMAssignmentHistoryController.exportCSV(window.currentMember)"> Export CSV</button>'
            + '</div>'
            + '<div style="margin-top:10px;">' + CMAssignmentHistoryController.renderTable(member) + '</div>';
    },

    // OPTION 1: Compact card for Other Information accordion (kept for reference)
    renderOption1Card: function(member) {
        const current = (member.cmAssignmentHistory || []).find(function(r) { return r.isCurrent; }) || {};
        const isConsented = member.consentStatus && member.consentStatus.toLowerCase().includes('consent') && !member.consentStatus.toLowerCase().includes('opt');
        const totalRecords = (member.cmAssignmentHistory || []).length;

        return '<div class="other-info-accordion cm-mgmt-details-option1" style="margin-top:12px;">'
            + '<div class="accordion-header" style="cursor:pointer;" onclick="this.parentElement.classList.toggle(\'open\');var c=this.nextElementSibling;c.style.display=c.style.display===\'none\'?\'block\':\'none\';">'
            + '<span class="accordion-title" style="color:#2d2d52;font-weight:600;">Care Management Details</span>'
            + '<span style="font-size:11px;color:#6366f1;background:#e0e7ff;padding:2px 8px;border-radius:10px;margin-left:8px;">Option 1</span>'
            + '<svg class="accordion-arrow" width="20" height="20" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd"></path></svg>'
            + '</div>'
            + '<div class="accordion-content" style="display:none;padding:16px;">'

            // Summary fields
            + '<div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-bottom:16px;">'
            + '<div><div class="info-pair"><span class="info-label">CURRENT SUPERVISOR</span><span class="info-value" style="font-weight:500;">' + (current.supervisorName || '') + '</span></div>'
            + '<div class="info-pair"><span class="info-label">ASSIGNED TO SUPERVISOR</span><span class="info-value">' + (current.supervisorAssignedDate || '') + '</span></div></div>'
            + '<div><div class="info-pair"><span class="info-label">CURRENT CARE MANAGER</span><span class="info-value" style="font-weight:500;">' + (current.careManagerName || member.careManager || '') + '</span></div>'
            + '<div class="info-pair"><span class="info-label">ASSIGNED TO CM</span><span class="info-value">' + (current.careManagerAssignedDate || '') + '</span></div></div>'
            + '<div><div class="info-pair"><span class="info-label">CONSENT STATUS</span><span class="info-value" style="color:' + (isConsented ? '#166534' : '#dc2626') + ';font-weight:600;">' + (member.consentStatus || '') + '</span></div></div>'
            + '<div><div class="info-pair"><span class="info-label">CURRENTLY CONSENTED?</span><span class="info-value" style="font-weight:600;color:' + (isConsented ? '#166534' : '#dc2626') + ';">' + (isConsented ? 'Yes' : 'No') + '</span></div></div>'
            + '</div>'

            // Full history table (collapsed by default)
            + '<div style="border-top:1px solid #e2e8f0;padding-top:12px;">'
            + '<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;">'
            + '<span style="font-size:12px;font-weight:600;color:#374151;">Full Assignment History (' + totalRecords + ' records)</span>'
            + '<button class="btn btn-secondary" style="font-size:11px;padding:4px 10px;" onclick="CMAssignmentHistoryController.exportCSV(window.currentMember)"> Export CSV</button>'
            + '</div>'
            + CMAssignmentHistoryController.renderTable(member)
            + '</div>'
            + '</div>'
            + '</div>';
    },

    // OPTION 3: Just the table content for the sub-tab inside Activity History
    renderOption3: function(member) {
        const totalRecords = (member.cmAssignmentHistory || []).length;
        return '<div style="padding:0 0 24px;">'
            + '<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;">'
            + '<h3 style="font-size:16px;font-weight:400;color:#333;margin:0;">CM Assignment History (' + totalRecords + ')</h3>'
            + '<button class="btn btn-primary" onclick="CMAssignmentHistoryController.exportCSV(window.currentMember)" style="display:flex;align-items:center;gap:6px;font-size:12px;">'
            + '<svg width="13" height="13" fill="currentColor" viewBox="0 0 16 16"><path d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5z"/><path d="M7.646 11.854a.5.5 0 0 0 .708 0l3-3a.5.5 0 0 0-.708-.708L8.5 10.293V1.5a.5.5 0 0 0-1 0v8.793L5.354 8.146a.5.5 0 1 0-.708.708l3 3z"/></svg>Export CSV</button>'
            + '</div>'
            + CMAssignmentHistoryController.renderTable(member)
            + '</div>';
    },

    // CSV Export
    exportCSV: function(member) {
        if (!member || !member.cmAssignmentHistory) return;
        const headers = ['Medicaid ID','Supervisor Name','Supervisor Assigned Date','Supervisor End Date','Care Manager Name','CM Assigned Date','CM End Date','Consent Status','Consent Date','Opt Out Date','Notes'];
        const rows = member.cmAssignmentHistory.map(function(r) {
            return [member.medicaidId, r.supervisorName, r.supervisorAssignedDate, r.supervisorEndDate,
                    r.careManagerName, r.careManagerAssignedDate, r.careManagerEndDate,
                    r.consentStatus, r.consentDate, r.optOutDate, r.notes]
                .map(function(v) { return '"' + (v||'').replace(/"/g,'""') + '"'; }).join(',');
        });
        const csv = [headers.join(',')].concat(rows).join('\n');
        const a = document.createElement('a');
        a.href = 'data:text/csv;charset=utf-8,' + encodeURIComponent(csv);
        a.download = 'cm_assignment_history_' + (member.id||'member') + '.csv';
        a.click();
    }
};


//  EVENT DELEGATION: tab click + sub-tab inject 
document.addEventListener('click', function(e) {

    // OPTION 2  main tab "CM Assignment History" clicked
    var tab2 = e.target.closest('.tab[data-tab="assignment-history"]');
    if (tab2 && window.currentMember) {
        setTimeout(function() {
            var pane = document.querySelector('.tab-pane[data-pane="assignment-history"]');
            if (pane && typeof CMAssignmentHistoryController !== 'undefined') {
                pane.innerHTML = CMAssignmentHistoryController.render(window.currentMember);
            }
        }, 15);
        return;
    }

    // OPTION 3  activity tab clicked  inject Assignment History sub-tab button
    var actTab = e.target.closest('.tab[data-tab="activity"]');
    if (actTab) {
        setTimeout(function() {
            var actTabs = document.querySelector('.act-tabs');
            if (actTabs && !actTabs.querySelector('.act-tab-btn-assignhist')) {
                var btn = document.createElement('button');
                btn.className = 'act-tab-btn act-tab-btn-assignhist';
                btn.textContent = 'Assignment History';
                btn.style.cssText = 'background:#6da0d8;color:white;border:none;border-radius:4px;padding:8px 16px;cursor:pointer;font-size:13px;font-weight:500;transition:all .2s;';
                btn.addEventListener('click', function() {
                    document.querySelectorAll('.act-tab-btn').forEach(function(b) { b.classList.remove('active'); b.style.background = '#6da0d8'; });
                    btn.classList.add('active');
                    btn.style.background = '#353182';
                    var area = document.getElementById('actContentArea');
                    if (area && window.currentMember) {
                        area.innerHTML = CMAssignmentHistoryController.renderOption3(window.currentMember);
                    }
                });
                actTabs.appendChild(btn);
            }
        }, 80);
        return;
    }
});


//  MUTATION OBSERVER: Option 1  populate accordion when member loads 
(function initCMOption1Observer() {
    var observer = new MutationObserver(function(mutations) {
        for (var i = 0; i < mutations.length; i++) {
            var m = mutations[i];
            if (m.target && m.target.id === 'accordion-section' && m.type === 'childList') {
                var slot = document.getElementById('cm-details-in-other-info');
                if (slot && window.currentMember && typeof CMAssignmentHistoryController !== 'undefined') {
                    slot.innerHTML = CMAssignmentHistoryController.renderCMDetailsSection(window.currentMember);
                }
                break;
            }
        }
    });
    observer.observe(document.body, { childList: true, subtree: true });
})();


// === NEW HTML TEMPLATES ===

/**
 * Returns the HTML structure for the main member list page.
 */
function getMemberListHTML() {
    return `
    <div class="member-list-container">
        <div class="table-controls">
            <div class="search-bar">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                    <path fill-rule="evenodd" d="M9 3.5a5.5 5.5 0 100 11 5.5 5.5 0 000-11zM2 9a7 7 0 1112.452 4.391l3.328 3.329a.75.75 0 11-1.06 1.06l-3.329-3.328A7 7 0 012 9z" clip-rule="evenodd" />
                </svg>
                <input type="text" id="memberSearchInput" placeholder="Search by Name, MRN, or Medicaid ID...">
            </div>
            <button class="btn btn-secondary" id="openFilterModalBtn">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16" style="margin-right: 6px;"><path d="M6 10.5a.5.5 0 0 1 .5-.5h3a.5.5 0 0 1 0 1h-3a.5.5 0 0 1-.5-.5zm-2-3a.5.5 0 0 1 .5-.5h7a.5.5 0 0 1 0 1h-7a.5.5 0 0 1-.5-.5zm-2-3a.5.5 0 0 1 .5-.5h11a.5.5 0 0 1 0 1h-11a.5.5 0 0 1-.5-.5z"/></svg>
                Filters
            </button>
        </div>
        <div class="table-wrapper">
            <table class="member-table">
                <thead>
                    <tr>
                        <th>Name</th>
                        <th>Medicaid ID</th>
                        <th>MRN</th>
                        <th>Risk Category</th>
                        <th>Consent Status</th>
                        <th>Member Status</th>
                        <th>Age</th>
                        <th>Gender</th>
                        <th>MCO</th>
                        <th>Address</th>
                        <th>City</th>
                        <th>State</th>
                        <th>Zip Code</th>
                        <th>County</th>
                        <th>Email</th>
                        <th>Cell Phone</th>
                        <th>Home Phone</th>
                        <th>Ethnicity</th>
                        <th>Race</th>
                        <th>Care Mgmt. Start</th>
                        <th>Care Mgmt. End</th>
                    </tr>
                </thead>
                <tbody id="member-table-body">
                    </tbody>
            </table>
        </div>
    </div>
    `;
}

/**
 * Returns the HTML structure for the filter modal.
 */
function getFilterModalHTML() {
    return `
    <div class="filter-modal-overlay" id="filterModal">
        <div class="filter-modal-content">
            <div class="filter-modal-header">
                <h3 style="margin:0;">Filter Members</h3>
                <button onclick="document.getElementById('filterModal').remove()" style="background:none; border:none; font-size: 24px; cursor:pointer;">&times;</button>
            </div>
            <div class="filter-modal-body">
                <div class="form-field">
                    <label for="filterConsentStatus">Consent Status</label>
                    <select id="filterConsentStatus">
                        <option value="">All</option>
                        <option value="To Obtain Consent">To Obtain Consent</option>
                        <option value="Consented">Consented</option>
                        <option value="Opted Out">Opted Out</option>
                        <option value="Re-consent Required">Re-consent Required</option>
                        <option value="Care Management Ended">Care Management Ended</option>
                    </select>
                </div>
                <div class="form-field">
                    <label for="filterMemberStatus">Member Status</label>
                    <select id="filterMemberStatus">
                        <option value="">All</option>
                        <option value="Active">Active</option>
                        <option value="OnHold">OnHold</option>
                        <option value="New">New</option>
                        <option value="Care Management Ended">Care Management Ended</option>
                    </select>
                </div>
                <div class="form-field">
                    <label for="filterRiskCategory">Risk Category</label>
                    <select id="filterRiskCategory">
                        <option value="">All</option>
                        <option value="Low">Low</option>
                        <option value="Medium">Medium</option>
                        <option value="High">High</option>
                    </select>
                </div>
                <div class="form-field">
                    <label for="filterMCO">MCO</label>
                    <select id="filterMCO">
                        <option value="">All</option>
                        <option value="United Healthcare">United Healthcare</option>
                        <option value="Blue Cross NC">Blue Cross NC</option>
                        <option value="WellCare">WellCare</option>
                    </select>
                </div>
            </div>
            <div class="filter-modal-footer">
                <button class="btn btn-secondary" id="clearFiltersBtn">Clear Filters</button>
                <button class="btn btn-primary" id="applyFiltersBtn">Apply Filters</button>
            </div>
        </div>
    </div>
    `;
}


// === NEW: MEMBER LIST RENDERING & INTERACTION LOGIC ===

/**
 * Renders the member data into the table.
 * @param {Array} membersData - The array of member objects to display.
 */
function renderMemberList(membersData) {
    const tableBody = document.getElementById('member-table-body');
    if (!tableBody) return;

    tableBody.innerHTML = '';

    if (membersData.length === 0) {
        tableBody.innerHTML = '<tr><td colspan="21" style="text-align: center; padding: 40px;">No members found.</td></tr>';
        return;
    }

    membersData.forEach(member => {
        const row = document.createElement('tr');
        row.setAttribute('data-member-id', member.id);
        
        row.addEventListener('click', (e) => {
            // Don't navigate if click was inside the three-dot menu
            if (e.target.closest('.three-dot-menu')) return;
            // CORRECTED: The subtitle now correctly uses member.id
            ActivityTracker.track({
                type: 'member',
                title: `Viewed ${member.name}`,
                subtitle: `Medicaid ID: ${member.id}`,
                handler: { type: 'navigateToMember', memberid: member.id }
            });
            navigateToDetails(member.id); 
        });
        row.innerHTML = `
            <td>
                <a href="#" onclick="event.preventDefault();navigateToDetails('${member.id}')" style="color:#353182;font-weight:500;text-decoration:none;">${member.name}</a>
            </td>
            <td>${member.medicaidId}</td>
            <td>${member.mrn}</td>
            <td>${member.riskCategory}</td>
            <td>${member.consentStatus}</td>
            <td>${member.memberStatus}</td>
            <td>${member.age}</td>
            <td>${member.gender}</td>
            <td>${member.mco}</td>
            <td>${member.address}</td>
            <td>${member.city}</td>
            <td>${member.state}</td>
            <td>${member.zipCode}</td>
            <td>${member.county}</td>
            <td>${member.email}</td>
            <td>${member.cellPhone}</td>
            <td>${member.homePhone}</td>
            <td>${member.ethnicity}</td>
            <td>${member.race}</td>
            <td>${member.careMgmtStart}</td>
            <td>${member.careMgmtEnd}</td>
            <td style="width:44px;text-align:center;position:relative;">
                <div class="three-dot-menu" style="display:inline-block;position:relative;">
                    <button class="three-dot-btn" onclick="event.stopPropagation();toggleMemberRowMenu(this,'${member.id}')" title="Actions">
                        <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor"><circle cx="8" cy="3" r="1.5"/><circle cx="8" cy="8" r="1.5"/><circle cx="8" cy="13" r="1.5"/></svg>
                    </button>
                    <div class="three-dot-dropdown" id="row-menu-${member.id}" style="min-width:220px;right:0;left:auto;">
                        <div class="three-dot-dropdown-item" onclick="event.stopPropagation();openReassignModal('${member.id}')">
                            <span class="item-icon">
                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 21v-2a4 4 0 00-4-4H5a4 4 0 00-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 00-3-3.87"/><path d="M16 3.13a4 4 0 010 7.75"/></svg>
                            </span>
                            Re-assign Supervisor / Care Manager
                        </div>
                        <div class="three-dot-dropdown-item" style="opacity:0.4;cursor:not-allowed;" onclick="event.stopPropagation();">
                            <span class="item-icon">
                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg>
                            </span>
                            View
                        </div>
                        <div class="three-dot-dropdown-item" style="opacity:0.4;cursor:not-allowed;" onclick="event.stopPropagation();">
                            <span class="item-icon">
                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 4H4a2 2 0 00-2 2v14a2 2 0 002 2h14a2 2 0 002-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 013 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>
                            </span>
                            Create Priority Population
                        </div>
                        <div class="three-dot-dropdown-item" style="opacity:0.4;cursor:not-allowed;" onclick="event.stopPropagation();">
                            <span class="item-icon">
                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><polyline points="14,2 14,8 20,8"/></svg>
                            </span>
                            Add New Service Note
                        </div>
                        <div class="three-dot-dropdown-item" style="opacity:0.4;cursor:not-allowed;" onclick="event.stopPropagation();">
                            <span class="item-icon">
                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg>
                            </span>
                            New Change In Circumstance
                        </div>
                    </div>
                </div>
            </td>
        `;
        tableBody.appendChild(row);
    });
}

const membersListingViewHTML = `
    <div class="page-content" style="margin: 0;">
        <div style="padding: 24px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
                <div class="app-search" style="min-width: 400px;">
                    <svg width="20" height="20" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clip-rule="evenodd"></path>
                    </svg>
                    <input type="text" placeholder="Search by Name, MRN, or Medicaid ID..." style="border: none; outline: none; background: transparent; flex: 1; margin-left: 8px;">
                </div>
                <button class="btn btn-secondary">
                    <svg fill="currentColor" viewBox="0 0 20 20" style="width:16px; height:16px; margin-right: 6px;"><path d="M3 3a1 1 0 011-1h12a1 1 0 011 1v3a1 1 0 01-.293.707L12 12.414V17a1 1 0 01-1 1h-2a1 1 0 01-1-1v-4.586L3.293 6.707A1 1 0 013 6V3z"></path></svg>
                    Filters
                </button>
            </div>
            <div class="dashboard-widget full-width">
                <div class="widget-content" style="padding: 0;">
                    <table class="dashboard-table member-table">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Medicaid ID</th>
                                <th>MRN</th>
                                <th>Risk Category</th>
                                <th>Consent Status</th>
                                <th>Member Status</th>
                                <th>Age</th>
                                <th>Gender</th>
                                <th>MCO</th>
                                <th>Address</th>
                                <th>City</th>
                            </tr>
                        </thead>
                        <tbody id="membersTableBody">
                            </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
`;

/**
 * Sets up event listeners for the search bar and filter button.
 */
function setupMemberListControls() {
    const searchInput = document.getElementById('memberSearchInput');
    const filterBtn = document.getElementById('openFilterModalBtn');

    if (searchInput) {
        // Debounce search input to avoid filtering on every keystroke
        let searchTimeout;
        searchInput.addEventListener('keyup', () => {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(filterAndRender, 300);
        });
    }

    if (filterBtn) {
        filterBtn.addEventListener('click', openFilterModal);
    }
}

/**
 * Opens and injects the filter modal into the page.
 */
function openFilterModal() {
    // Remove any existing modal first
    const existingModal = document.getElementById('filterModal');
    if (existingModal) {
        existingModal.remove();
    }

    document.body.insertAdjacentHTML('beforeend', getFilterModalHTML());

    // Attach event listeners to the new modal's buttons
    document.getElementById('applyFiltersBtn').addEventListener('click', applyFiltersFromModal);
    document.getElementById('clearFiltersBtn').addEventListener('click', clearFiltersAndRender);
}

/**
 * Reads filter values from the modal and re-renders the table.
 */
function applyFiltersFromModal() {
    filterAndRender();
    const modal = document.getElementById('filterModal');
    if (modal) {
        modal.remove();
    }
}

/**
 * Clears filter inputs in the modal and re-renders the table.
 */
function clearFiltersAndRender() {
    document.getElementById('filterConsentStatus').value = '';
    document.getElementById('filterMemberStatus').value = '';
    document.getElementById('filterRiskCategory').value = '';
    document.getElementById('filterMCO').value = '';
    applyFiltersFromModal();
}

/**
 * Central function to apply all filters and search, then re-render the list.
 */
function filterAndRender() {
    const searchQuery = document.getElementById('memberSearchInput')?.value.toLowerCase() || '';
    
    // Get filter values, checking if the modal exists
    const consentStatus = document.getElementById('filterConsentStatus')?.value || '';
    const memberStatus = document.getElementById('filterMemberStatus')?.value || '';
    const riskCategory = document.getElementById('filterRiskCategory')?.value || '';
    const mco = document.getElementById('filterMCO')?.value || '';

    let filteredMembers = membersDB.filter(member => {
        const matchesSearch = searchQuery === '' ||
            member.name.toLowerCase().includes(searchQuery) ||
            member.mrn.toLowerCase().includes(searchQuery) ||
            member.id.toLowerCase().includes(searchQuery);

        const matchesConsent = consentStatus === '' || member.consentStatus === consentStatus;
        const matchesStatus = memberStatus === '' || member.memberStatus === memberStatus;
        const matchesRisk = riskCategory === '' || member.riskCategory === riskCategory;
        const matchesMCO = mco === '' || member.mco === mco;

        return matchesSearch && matchesConsent && matchesStatus && matchesRisk && matchesMCO;
    });

    renderMemberList(filteredMembers);
}



let currentMember = null;
let currentView = 'list';
let selectedMemberId = null;
function navigateToList() {
    // AI Co-pilot: Clear member context
    window.currentMember = null;
    if (typeof aiCopilotState !== 'undefined') {
        aiCopilotState.currentMember = null;
        aiCopilotState.currentContext = 'dashboard';
        aiCopilotState.isInConversation = false;
        if (typeof renderWelcomeScreen === 'function') {
            renderWelcomeScreen();
        }
    }
    // This re-uses the function from our main DOMContentLoaded listener
    initializeMemberList();
}

/**
 * Renders the detail page for a specific member.
 * @param {string} memberId - The ID of the member to display.
 */
/**
 * Renders the detail page for a specific member.
 * Updated to sync with AI Co-pilot State.
 */

function generateDashboardHTML(member) {
    const data = member.dashboardData || {};
    const adts = data.adts || [];
    const tasks = data.tasks || [];
    
    const adtRows = adts.length > 0 
        ? adts.map(adt => `
            <tr>
                <td>${adt.date}</td>
                <td><a href="#">${adt.type} - ${adt.typeDesc || ''}</a></td>
                <td>${adt.facility}</td>
                <td>${adt.diagnosis}</td>
                <td><span class="${adt.acknowledged === 'Yes' ? 'status-active' : 'status-pending'}">${adt.acknowledged}</span></td>
            </tr>`).join('')
        : '<tr><td colspan="5" style="text-align: center; color: #666;">No ADT events for this member.</td></tr>';
    
    const taskRows = tasks.length > 0
        ? tasks.map(task => `
            <tr>
                <td><a href="#" onclick="alert('Task: ${task.title}')">${task.title}</a></td>
                <td>${member.name}</td>
                <td>${member.medicaidId || member.id}</td>
                <td>${task.type || 'General'}</td>
                <td>${task.assignedTo || member.careManager}</td>
            </tr>`).join('')
        : '<tr><td colspan="5" style="text-align: center; color: #666;">No tasks for this member.</td></tr>';
    
    const serviceNotes = member.serviceNotes || [];
    const recentActivityHTML = serviceNotes.length > 0
        ? serviceNotes.slice(0, 3).map(note => `
            <div class="activity-item" style="padding: 12px; border-bottom: 1px solid #eee;">
                <div style="font-weight: 500;">${note.activity}</div>
                <div style="font-size: 12px; color: #666;">${note.date} - ${note.author}</div>
            </div>`).join('')
        : '<div style="padding: 20px; text-align: center; color: #666;">No recent activity</div>';

    return `
    <div class="dashboard-grid">
        <div class="dashboard-widget">
            <div class="widget-header">
                <h3 class="widget-title">ADTs(${adts.length})</h3>
            </div>
            <div class="widget-content scrollable">
                <table class="dashboard-table">
                    <thead>
                        <tr>
                            <th>Event Date</th>
                            <th>Event Type</th>
                            <th>Facility</th>
                            <th>Diagnosis</th>
                            <th>Acknowledged</th>
                        </tr>
                    </thead>
                    <tbody>${adtRows}</tbody>
                </table>
            </div>
        </div>

        <div class="dashboard-widget">
            <div class="widget-header">
                <h3 class="widget-title">Your Recent Activity</h3>
            </div>
            <div class="widget-content">${recentActivityHTML}</div>
        </div>

        <div class="dashboard-widget">
            <div class="widget-header">
                <h3 class="widget-title">Actions</h3>
            </div>
            <div class="widget-content">
                <div class="actions-list">
                    <a href="#" onclick="event.preventDefault(); openAICopilotForServiceNote()">Create a new Service Note</a>
                    <a href="#" onclick="event.preventDefault(); openAICopilotForAppointment()">Create a new Appointment</a>
                    <a href="#" onclick="alert('Open Care Plan')">Open the Care Plan in a new tab</a>
                    <a href="#" onclick="alert('Generate Profile')">Generate Member Profile</a>
                </div>
            </div>
        </div>

        <div class="dashboard-widget">
            <div class="widget-header dark">
                <h3 class="widget-title">Tasks (${tasks.length})</h3>
            </div>
            <div class="widget-content">
                <table class="dashboard-table">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Member Name</th>
                            <th>Medicaid ID</th>
                            <th>Group</th>
                            <th>Assignee</th>
                        </tr>
                    </thead>
                    <tbody>${taskRows}</tbody>
                </table>
            </div>
        </div>

        <div class="dashboard-widget">
            <div class="widget-header">
                <h3 class="widget-title">Upcoming Appointments (${(member.appointments || []).filter(a => new Date(a.startDate) >= new Date()).length})</h3>
            </div>
            <div class="widget-content" id="dashApptWidgetContent">
                ${buildApptWidgetHTML(member)}
            </div>
        </div>

        <div class="dashboard-widget">
            <div class="widget-header">
                <h3 class="widget-title">Open Service Notes (${(member.serviceNotes || []).filter(n => n.status === 'Draft').length})</h3>
            </div>
            <div class="widget-content" id="dashSNWidgetContent">
                ${buildServiceNotesWidgetHTML(member)}
            </div>
        </div>
    </div>`;
}

function navigateToDetails(memberId, tabId = 'dashboard') {
    const member = membersDB.find(m => m.id === memberId);
    if (!member) {
        console.error(`Member with ID ${memberId} not found.`);
        return;
    }

    // 1. Set Global State
    currentView = 'details';
    selectedMemberId = memberId;
    window.currentMember = member;

    // --- NEW AI CONTEXT LOGIC STARTS HERE ---
    if (typeof aiCopilotState !== 'undefined') {
        aiCopilotState.currentMember = member;
        aiCopilotState.currentContext = 'memberDetails';
        aiCopilotState.isInConversation = false;
        
        // CRITICAL FIX: Clear history so old chats don't persist on new page
        aiCopilotState.conversationHistory = []; 
        const messagesContainer = document.getElementById('aiMessages');
        if(messagesContainer) {
            // Remove old messages, keep welcome
            messagesContainer.querySelectorAll('.ai-message:not(#aiWelcomeMessage)').forEach(m => m.remove());
        }

        if (aiCopilotState.isOpen) {
            initializeAIWelcome(); 
        }
    }
    // --- NEW AI CONTEXT LOGIC ENDS HERE ---

    // 3. UI Updates
    toggleQuickLinksButton(true);
    tabContents.timeline = generateTimelineHTML(member);

    const pageContainer = document.getElementById('pageContainer');
    pageContainer.innerHTML = memberDetailViewHTML;

    // Clean up any baked-in pollution from captured DOM
    const innerForm = pageContainer.querySelector('.member-details-form');
    if (innerForm) {
        innerForm.classList.remove('tab-pane');
        if (innerForm.dataset.pane) delete innerForm.dataset.pane;
        innerForm.style.removeProperty('display');
    }
    const innerGrid = pageContainer.querySelector('.dashboard-grid');
    if (innerGrid) {
        innerGrid.classList.remove('tab-pane');
        if (innerGrid.dataset.pane) delete innerGrid.dataset.pane;
    }

    // DYNAMIC DASHBOARD INJECTION - Replaces static content with member-specific data
    const dashboardGrid = pageContainer.querySelector('.dashboard-grid');
    if (dashboardGrid) {
        dashboardGrid.outerHTML = generateDashboardHTML(member);
    }

    updateBreadcrumbs(['Home', 'Members', member.name]);
    populateHeader(member);
    // populateDashboard(member);
    
    if (typeof MemberActivityManager !== 'undefined') MemberActivityManager.renderCard(memberId);
    
    initializeMemberSubTabs(); 
    initializeGlobalSearch();

    const backButton = document.getElementById('backToListBtn');
    if (backButton) {
        backButton.addEventListener('click', navigateToList);
    }
    
    const breadcrumbLink = document.getElementById('breadcrumbMembersLink');
    if (breadcrumbLink) {
        breadcrumbLink.addEventListener('click', (e) => {
            e.preventDefault();
            navigateToList();
        });
    }

    // 5. Tab Navigation
    setTimeout(() => {
        const tabToClick = document.querySelector(`.tab[data-tab="${tabId}"]`);
        if(tabToClick) {
            tabToClick.click();
        } else {
            const dashboardTab = document.querySelector('.tab[data-tab="dashboard"]');
            if (dashboardTab) dashboardTab.click();
        }
    }, 50);
}

function generateTimelineHTML(member) {
    let eventsHTML = '';

    if (member.timelineEvents && member.timelineEvents.length > 0) {
        // Sort events by date just in case they are not in order
        const sortedEvents = member.timelineEvents.sort((a, b) => new Date(a.date) - new Date(b.date));

        sortedEvents.forEach(event => {
            const eventDate = new Date(event.date);
            const displayDate = eventDate.toLocaleDateString('en-US');

            // Special handling for Opted Out status to show a different marker
            let markerClass = event.type;
            let markerStyle = '';
            if (event.status === 'Opted Out') {
                markerClass = 'consent'; // Keep the color category but change the icon/style
                markerStyle = 'background: #ef4444;'; // Red for opted out
            }

            eventsHTML += `
                <div class="timeline-event" data-date="${event.date}" data-type="${event.type}">
                    <div class="event-label">${event.type.replace('-', ' ')}</div>
                    <div class="event-marker ${markerClass}" style="${markerStyle}"></div>
                    <div class="event-date">${displayDate}</div>
                    <div class="event-popup">
                        <div class="event-title">${event.title}</div>
                        <div class="event-meta">${displayDate} at ${event.time} &bull; By: ${event.user}</div>
                        <p>${event.details}</p>
                        <div style="margin-top: 12px;">
                           <span class="event-type-badge ${event.type}">${event.status || event.type}</span>
                        </div>
                    </div>
                </div>
            `;
        });
    } else {
        eventsHTML = `<div style="text-align: center; color: #666; padding: 40px;">No timeline events found for this member.</div>`;
    }

    // Return the complete timeline view structure with the dynamic events
    return `
        <div class="timeline-view">
            <div class="timeline-controls">
                <div class="timeline-filters">
                    <div class="filter-item"><label class="filter-label">From:</label><input type="date" class="filter-input" id="timelineStartDate"></div>
                    <div class="filter-item"><label class="filter-label">To:</label><input type="date" class="filter-input" id="timelineEndDate"></div>
                    <div class="filter-item"><label class="filter-label">Event Type:</label><select class="filter-select" id="timelineEventType"><option value="all">All Events</option></select></div>
                </div>
                <div class="timeline-view-controls">
                    <button class="timeline-view-btn active" onclick="switchTimelineView('horizontal')">Timeline</button>
                    <button class="timeline-view-btn" onclick="switchTimelineView('grid')">Grid</button>
                    <button class="timeline-view-btn" onclick="switchTimelineView('list')">List</button>
                </div>
            </div>
            <div class="timeline-container">
                <div class="horizontal-timeline" id="horizontalTimelineView">
                    <div class="timeline-track">
                        <div class="timeline-line"></div>
                        <div class="timeline-events" id="timelineEventsContainer">${eventsHTML}</div>
                    </div>
                </div>
                <div class="grid-timeline" id="gridTimelineView" style="display: none;"><div class="events-grid" id="eventsGridContainer"></div></div>
                <div class="list-timeline" id="listTimelineView" style="display: none;"><div class="events-list" id="eventsListContainer"></div></div>
            </div>
        </div>
    `;
}

/**
 * Populates the dynamic two-card member header.
 * @param {Object} member - The full member object.
 */
function populateHeader(member) {
    // 1. Populate Alerts
    const alertContainer = document.getElementById('alertContainer');
    if (alertContainer) {
        const alerts = member.headerData.alerts || [];

        if (alerts.length === 0) {
            // Display the "No alerts" message
            alertContainer.style.display = 'block';
            alertContainer.innerHTML = `
                <div class="alert-strip" style="background: #fff8dc; border: 1px solid #e1e5e9; color: #121212; font-size: 14px; justify-content: left;">
                    No alerts for this member.
                </div>
            `;
        } else {
            // Build and display the alert chips and content
            alertContainer.style.display = 'block';
            let alertStripHTML = '<div class="alert-strip" id="alertStrip"><span style="font-weight: 600; color: #666; font-size: 11px;">Alerts:</span>';
            let expandedContentHTML = '';

            alerts.forEach((alert, index) => {
                const chipTitle = alert.type.charAt(0).toUpperCase() + alert.type.slice(1).replace('-', ' ');

                alertStripHTML += `
                    <div class="alert-chip unread" onclick="expandAlertChip(${index})" data-alert-id="${index}">
                        <svg class="alert-chip-icon" fill="currentColor" viewBox="0 0 24 24"><path d="M12 22c1.1 0 2-.9 2-2h-4c0 1.1.9 2 2 2zm6-6v-5c0-3.07-1.64-5.64-4.5-6.32V4c0-.83-.67-1.5-1.5-1.5s-1.5.67-1.5 1.5v.68C7.63 5.36 6 7.92 6 11v5l-2 2v1h16v-1l-2-2z"/></svg>
                        <span>${chipTitle}</span>
                    </div>
                `;
                expandedContentHTML += `
                    <div class="alert-expanded-content" id="expandedAlert${index}">
                        <div class="expanded-content-wrapper">
                            <div class="expanded-text"><strong>${chipTitle}:</strong> ${alert.text}</div>
                            <div class="expanded-actions">
                                <button class="alert-close-btn" onclick="closeExpandedAlert()">&times;</button>
                                <a href="#" class="alert-action-link" onclick="${alert.action}">${alert.actionText}</a>
                            </div>
                        </div>
                    </div>
                `;
            });
            alertStripHTML += '</div>';
            alertContainer.innerHTML = alertStripHTML + expandedContentHTML;
        }
    }

    // 2. Populate Identity Bar (remains the same)
    const identitySection = document.getElementById('identity-section');
    if (identitySection) {
        identitySection.innerHTML = MemberHeaderController._buildIdentityBarHTML(member);
    }

    // 3. Populate Accordion Cards (remains the same)
    const accordionSection = document.getElementById('accordion-section');
    if (accordionSection) {
        accordionSection.innerHTML = MemberHeaderController._buildMainCardAccordionHTML(member.headerData) + MemberHeaderController._buildOtherInfoAccordionHTML(member);
        MemberHeaderController._addEventListeners(); // Re-attach event listeners for the new content
    }
}

/**
 * Populates the dashboard tab with member-specific data.
 * @param {Object} member - The full member object.
 */
function populateDashboard(member) {
    const data = member.dashboardData;
    if (!data) return;

    // Populate ADTs table
    const adtTableBody = document.querySelector('.dashboard-widget .dashboard-table tbody');
    if (adtTableBody) {
        if (data.adts && data.adts.length > 0) {
            adtTableBody.innerHTML = data.adts.map(adt => `
                <tr>
                    <td>${adt.date && adt.date.replace(' ', '<br>')}</td>
                    <td><a href="#">${adt.type}</a></td>
                    <td>${adt.facility}</td>
                    <td>${adt.diagnosis}</td>
                    <td>${adt.acknowledged}</td>
                </tr>
            `).join('');
        } else {
            adtTableBody.innerHTML = '<tr><td colspan="5" style="text-align: center;">No ADT events for this member.</td></tr>';
        }
    }

    // Populate Tasks table
// Populate Tasks table in Member Dashboard
    const taskTableBody = document.querySelectorAll('.dashboard-widget .dashboard-table tbody')[1];
    if (taskTableBody) {
        if (data.tasks && data.tasks.length > 0) {
            taskTableBody.innerHTML = data.tasks.map(task => `
                <tr>
                    <td><a href="#" onclick="alert('Task: ${task.title}')">${task.title}</a></td>
                    <td>${member.name}</td>
                    <td>${member.medicaidId || member.id}</td>
                    <td>${task.type || 'General'}</td>
                    <td>${task.assignedTo || member.careManager}</td>
                </tr>
            `).join('');
        } else {
            taskTableBody.innerHTML = '<tr><td colspan="5" style="text-align: center;">No tasks for this member.</td></tr>';
        }
    }
     // NOTE: We are populating only the most visible widgets for this mockup.
    // In a real app, you would continue this pattern for Care Gaps, Reference Center, etc.
}


/**
 * Generates fresh Member Details form HTML dynamically.
 * This avoids all captured-DOM pollution issues.
 */
function generateMemberDetailsFormHTML() {
    return `
    <div class="member-details-form">
        <div class="form-section">
            <h3 class="section-title">Identity</h3>
            <div class="form-grid cols-4">
                <div class="form-field"><label>First Name *</label><input type="text" id="detailFirstName" disabled></div>
                <div class="form-field"><label>MRN</label><input type="text" id="detailMrn" disabled></div>
                <div class="form-field"><label>Middle Name</label><input type="text" id="detailMiddleName" disabled></div>
                <div class="form-field"><label>Medicaid ID</label><input type="text" id="detailMedicaidId" disabled></div>
                <div class="form-field"><label>Last Name *</label><input type="text" id="detailLastName" disabled></div>
                <div class="form-field"><label>DOB</label><input type="text" id="detailDob" disabled></div>
                <div class="form-field"><label>Preferred Name</label><input type="text" id="detailPreferredName" disabled></div>
                <div class="form-field"><label>DOD</label><input type="text" id="detailDod" disabled></div>
                <div class="form-field"><label>Age</label><input type="text" id="detailAge" disabled></div>
                <div class="form-field"><label>Member Status</label><input type="text" id="detailMemberStatus" disabled></div>
                <div class="form-field"><label>SSN</label><input type="text" value="***-**-****" disabled></div>
                <div class="form-field"><label>Care Manager</label><input type="text" id="detailCareManager" disabled></div>
                <div class="form-field"><label>CMA Start Date</label><input type="text" id="detailCmaStart" disabled></div>
                <div class="form-field"><label>CMA End Date</label><input type="text" id="detailCmaEnd" disabled></div>
            </div>
        </div>
        <div class="form-section">
            <h3 class="section-title">Diagnoses</h3>
            <div class="form-grid cols-4">
                <div class="form-field col-span-2"><label>Primary Diagnosis</label><input type="text" id="detailDxPrimary" disabled></div>
                <div class="form-field col-span-2"><label>Tertiary Diagnosis</label><input type="text" id="detailDxTertiary" disabled></div>
                <div class="form-field col-span-2"><label>Secondary Diagnosis</label><input type="text" id="detailDxSecondary" disabled></div>
                <div class="form-field col-span-2"><label>Additional Diagnosis</label><input type="text" id="detailDxAdditional" disabled></div>
            </div>
        </div>
        <div class="form-section" id="memberConsentOverviewSection"></div>
        <div class="form-section">
            <h3 class="section-title">Contact Information</h3>
            <div class="form-grid cols-4">
                <div class="form-field"><label>Home Phone</label><input type="text" id="detailHomePhone" disabled></div>
                <div class="form-field"><label>Street Address</label><input type="text" id="detailAddress" disabled></div>
                <div class="form-field"><label>Cell Phone</label><input type="text" id="detailCellPhone" disabled></div>
                <div class="form-field"><label>Line 2</label><input type="text" id="detailAddress2" placeholder="N/A" disabled></div>
                <div class="form-field"><label>Email</label><input type="text" id="detailEmail" disabled></div>
                <div class="form-field"><label>City</label><input type="text" id="detailCity" disabled></div>
                <div class="form-field"><label>Preferred Contact Method</label><input type="text" id="detailContactMethod" disabled></div>
                <div class="form-field"><label>Zip Code</label><input type="text" id="detailZip" disabled></div>
            </div>
        </div>
        <div class="form-section">
            <h3 class="section-title">Communication Method and Languages</h3>
            <div class="form-grid cols-4">
                <div class="form-field col-span-2"><label>Languages Spoken</label><div class="multi-select-tags" id="detailLanguages"></div></div>
                <div class="form-field col-span-2"><label>Preferred Language *</label><input type="text" id="detailPrefLang" disabled></div>
            </div>
        </div>
        <div class="form-section">
            <h3 class="section-title">Additional Information</h3>
            <div class="form-field"><label>Additional Information</label><textarea rows="3" id="detailAdditionalInfo" disabled></textarea></div>
        </div>
        <div class="form-section">
            <h3 class="section-title">Security Tags</h3>
            <div class="security-tags-list" id="detailSecurityTags"></div>
        </div>
        <div class="form-actions" id="detailFormActions">
            <button class="btn btn-secondary" id="backToListBtn">Back to List</button>
            <button class="btn btn-secondary" onclick="toggleEditMode()">Edit</button>
        </div>
    </div>`;
}

/**
 * Populates the Member Details form with member-specific data.
 * @param {Object} member - The full member object.
 */
function populateDetailsForm(member) {
    if (!member) return;
    const setValue = (id, value) => {
        const el = document.getElementById(id);
        if (el) el.value = value || '';
    };

    const nameParts = member.name.split(' ');
    setValue('detailFirstName', nameParts[0]);
    setValue('detailLastName', nameParts.slice(1).join(' '));
    setValue('detailMrn', member.mrn);
    setValue('detailMedicaidId', member.medicaidId);
    setValue('detailDob', member.dob);
    setValue('detailAge', member.age);
    setValue('detailMemberStatus', member.memberStatus);
    setValue('detailCareManager', member.careManager);
    setValue('detailCmaStart', member.careMgmtStart);
    setValue('detailCmaEnd', member.careMgmtEnd);
    setValue('detailHomePhone', member.homePhone);
    setValue('detailCellPhone', member.cellPhone);
    setValue('detailEmail', member.email);
    setValue('detailAddress', member.address);
    setValue('detailCity', member.city);
    setValue('detailZip', member.zipCode);
    setValue('detailContactMethod', member.communication.method);
    setValue('detailDxPrimary', member.diagnoses.primary);
    setValue('detailDxSecondary', member.diagnoses.secondary);
    setValue('detailDxTertiary', member.diagnoses.tertiary);
    setValue('detailDxAdditional', member.diagnoses.additional);
    setValue('detailAdditionalInfo', member.additionalInfo);
    setValue('detailPrefLang', member.communication.preferredLanguage);

    const langContainer = document.getElementById('detailLanguages');
    if (langContainer && member.communication.languages) {
        langContainer.innerHTML = member.communication.languages.map(lang => `<span>${lang}</span>`).join('');
    }

    const tagsContainer = document.getElementById('detailSecurityTags');
    if (tagsContainer && member.securityTags) {
        tagsContainer.innerHTML = member.securityTags.map(tag => `
            <div class="tag-row">
                <div class="tag-label">${tag.group}</div>
                <div class="tag-value"><strong>Tag:</strong> ${tag.tag}</div>
                <div class="tag-hierarchy"><strong>Tag Hierarchy:</strong> ${tag.hierarchy}</div>
            </div>
        `).join('');
    }
    
    populateConsentOverview(member);
}

function populateConsentOverview(member) {
    const container = document.getElementById('memberConsentOverviewSection');
    if (!container || !member.consentDetails) return;

    const statusColor = member.consentStatus === 'Consented' ? 'green' : (member.consentStatus === 'Opted Out' || member.consentStatus === 'Care Management Ended' ? 'red' : 'orange');

    let actionButtonsHTML = '';
    switch (member.consentStatus) {
        case 'Consented':
            actionButtonsHTML = `<button class="btn-danger" onclick="alert('Opt Out process started.')">Opt Out</button>`;
            break;
        case 'Opted Out':
        case 'Care Management Ended':
            actionButtonsHTML = `<button class="btn-primary" onclick="alert('Reactivation process started.')">Reactivate this Member</button>`;
            break;
        default: // To Obtain Consent, Re-consent Required
            actionButtonsHTML = `
                <button class="btn-secondary" onclick="alert('Log Contact modal opened.')">Log Contact for Consent</button>
                <button class="btn-danger" onclick="alert('Opt Out process started.')">Opt Out</button>
                <button class="btn-primary" onclick="alert('Mark as Consented process started.')">Mark As Consented</button>
            `;
    }

    container.innerHTML = `
        <h3 class="section-title">Member Consent Overview</h3>
        <div class="consent-section">
            <div class="consent-overview-grid">
                <div class="consent-status-item">
                    <label>Consent Status</label>
                    <div class="status-indicator">
                        <span class="status-dot ${statusColor}"></span>
                        <span class="status-text">${member.consentDetails.statusText}</span>
                    </div>
                </div>
                <div class="consent-status-item">
                    <label>Updated On</label>
                    <div class="date-display"> ${member.consentDetails.updatedOn}</div>
                </div>
                <div class="consent-status-item">
                    <label>Contact Attempts</label>
                    <div class="contact-attempts-link">
                        <a href="#" onclick="alert('Showing detailed contact history...')">${member.consentDetails.contactAttempts}</a>
                    </div>
                </div>
            </div>
        </div>
        <div class="consent-section">
            <h4 class="consent-subsection-title">Consent History</h4>
            <div class="consent-history-table">
                <table>
                    <thead><tr><th>Date</th><th>Contact Method</th><th>Contact Outcome</th><th>Attempt #</th><th>Status</th><th>User</th></tr></thead>
                    <tbody>
                        ${member.consentDetails.history.map(item => `
                            <tr>
                                <td>${item.date}</td>
                                <td>${item.method}</td>
                                <td>${item.outcome}</td>
                                <td>${item.attempt}</td>
                                <td>${item.status}</td>
                                <td>${item.user}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            </div>
            <div class="consent-actions">${actionButtonsHTML}</div>
        </div>
    `;
}

function initializeMemberSubTabs() {
    const tabs = document.querySelectorAll('.page-content .content-tabs .tab');
    const tabContentContainer = document.querySelector('.page-content .tab-content');
    if (!tabs.length || !tabContentContainer) return;

    tabs.forEach(tab => {
        // Remove existing listeners by cloning
        const newTab = tab.cloneNode(true);
        tab.parentNode.replaceChild(newTab, tab);

        newTab.addEventListener('click', function() {
            const tabKey = this.dataset.tab;
            const tabName = this.textContent.trim();

            // Update active state
            document.querySelectorAll('.page-content .content-tabs .tab').forEach(t => t.classList.remove('active'));
            this.classList.add('active');
            
            // Hide all panes
            tabContentContainer.querySelectorAll('.tab-pane').forEach(p => {
                p.style.display = 'none';
                p.classList.remove('active');
            });

            // BULLETPROOF FIX: For details tab, always remove old pane so a fresh one is created
            if (tabKey === 'details') {
                const oldDetailsPane = tabContentContainer.querySelector('[data-pane="details"]');
                if (oldDetailsPane) oldDetailsPane.remove();
            }

            // Find or create pane
            let targetPane = tabContentContainer.querySelector(`[data-pane="${tabKey}"]`);
            if (!targetPane) {
                targetPane = document.createElement('div');
                targetPane.classList.add('tab-pane');
                targetPane.dataset.pane = tabKey;
                tabContentContainer.appendChild(targetPane);
            }
            
            // Show pane
            targetPane.style.display = 'block';
            targetPane.classList.add('active');

            // RENDER CONTENT FROM CONTROLLERS - USING MEMBER DATABASE
            const member = window.currentMember;
            if (member) {
                switch(tabKey) {
                    case 'dashboard':
                        if (typeof populateDashboard === 'function') {
                            populateDashboard(member);
                        }
                        break;
                    case 'details':
                        if (typeof generateMemberDetailsFormHTML === 'function') {
                            targetPane.innerHTML = generateMemberDetailsFormHTML();
                        }
                        if (typeof populateDetailsForm === 'function') {
                            populateDetailsForm(member);
                        }
                        break;
                    case 'timeline':
                        if (typeof generateTimelineHTML === 'function') {
                            targetPane.innerHTML = generateTimelineHTML(member);
                            if (typeof initializeTimelineFilters === 'function') {
                                setTimeout(initializeTimelineFilters, 100);
                            }
                        }
                        break;
                    case 'insurance':
                        if (typeof InsuranceController !== 'undefined') {
                            targetPane.innerHTML = InsuranceController.render(member);
                        }
                        break;
                    case 'screenings':
                        if (typeof ScreeningController !== 'undefined') {
                            targetPane.innerHTML = ScreeningController.render(member);
                        }
                        break;
                    case 'bio-psycho':
                        if (typeof BioPsychoSocialController !== 'undefined') {
                            targetPane.innerHTML = BioPsychoSocialController.render(member);
                        }
                        break;
                    case 'history':
                        if (typeof HealthHistoryController !== 'undefined') {
                            targetPane.innerHTML = HealthHistoryController.render(member);
                        }
                        break;
                    case 'population':
                        if (typeof PopulationInsightsController !== 'undefined') {
                            targetPane.innerHTML = PopulationInsightsController.render(member);
                        }
                        break;
                    case 'activity':
                        if (typeof ActivityHistoryController !== 'undefined') {
                            targetPane.innerHTML = ActivityHistoryController.render(member);
                        }
                        break;
                    case 'careteam':
                        if (typeof CareTeamController !== 'undefined') {
                            targetPane.innerHTML = CareTeamController.render(member);
                        }
                        break;
                    case 'careplans':
                        if (typeof CarePlanController !== 'undefined') {
                            targetPane.innerHTML = CarePlanController.render(member);
                        }
                        break;
                }
                
                // Update breadcrumbs
                if (typeof updateBreadcrumbs === 'function') {
                    updateBreadcrumbs(['Home', 'Members', member.name, tabName]);
                }
            }
        });
    });
}


let originalFormValues = {};

function toggleEditMode() {
    isEditMode = !isEditMode;
    const form = document.querySelector('.member-details-form');
    const fields = form.querySelectorAll('input:not(#detailMedicaidId):not(#detailMrn), select, textarea');
    const actionsContainer = document.getElementById('detailFormActions');

    if (isEditMode) {
        originalFormValues = {};
        fields.forEach(field => {
            originalFormValues[field.id] = field.value; // Store original values
            field.disabled = false;
        });
        actionsContainer.innerHTML = `
            <button class="btn btn-secondary" onclick="handleCancel()">Cancel</button>
            <button class="btn btn-primary" onclick="handleSave()">Save</button>
        `;
    } else {
        fields.forEach(field => {
            field.disabled = true;
        });
        actionsContainer.innerHTML = `
            <button class="btn btn-secondary" id="backToListBtn">Back to List</button>
            <button class="btn btn-secondary" onclick="toggleEditMode()">Edit</button>
        `;
    }
}

function handleSave() {
    alert('Member details saved! (This is a mockup, data is not permanently stored)');
    // In a real app, you would collect form data and send it to a server.
    // For now, we just exit edit mode.
    toggleEditMode();
}

function handleCancel() {
    // Restore original values from before editing
    Object.keys(originalFormValues).forEach(id => {
        const field = document.getElementById(id);
        if (field) field.value = originalFormValues[id];
    });
    alert('Changes discarded.');
    toggleEditMode();
}

function handleBackButton() {
    navigateToList();
}


(function() {
    if (typeof initializeGlobalSearch === 'function') {
        
        initializeGlobalSearch();
    } else {
        console.error('initializeGlobalSearch function not found!');
    }
})();


// --- DEEP LINKING: Handle URL Parameters on New Tab Load ---
document.addEventListener('DOMContentLoaded', () => {
    // 1. Read URL Parameters
    const params = new URLSearchParams(window.location.search);
    const memberId = params.get('member');
    const tabId = params.get('tab');
    const pageId = params.get('page');

    // 2. Route based on parameters
    if (memberId) {
        // If viewing a member
        setTimeout(() => {
            navigateToDetails(memberId); // Load Member Details
            
            // If a specific tab was requested (e.g., Timeline)
            if (tabId) {
                setTimeout(() => {
                    const tabButton = document.querySelector(`.tab[data-tab="${tabId}"]`);
                    if (tabButton) tabButton.click();
                }, 300); // Small delay to allow Member Details to render first
            }
        }, 100);
    } 
    else if (pageId) {
        // If viewing a generic page (Service Notes, Dashboard, etc.)
        const navItem = document.getElementById(pageId); 
        if (navItem) {
            navItem.click();
        }
    }
});



// 
// AI CO-PILOT v2  Airtable-Inspired, Data-Driven Intelligence
// 

const aiCopilotState = {
    isOpen: false,
    isExpanded: false,
    currentContext: 'dashboard',
    currentMember: null,
    conversationHistory: [],
    activeTab: 'tasks',
    isInConversation: false
};

// 
// QUESTION DEFINITIONS (from mind map)
// 
const AI_TABS = {
    tasks: {
        label: 'Tasks',
        questions: [
            { id: 'task_overdue', text: 'Show me my overdue tasks', handler: 'qOverdueTasks', followUps: ['task_hp_overdue','task_overdue_hr','task_today'] },
            { id: 'task_today', text: 'Tasks due today', handler: 'qTasksDueToday', followUps: ['task_hp','task_week','task_overdue'] },
            { id: 'task_week', text: 'Tasks due this week', handler: 'qTasksDueWeek', followUps: ['task_today','task_hp','task_consent'] },
            { id: 'task_hp', text: 'High priority tasks', handler: 'qHighPriorityTasks', followUps: ['task_hp_overdue','task_today','task_overdue_hr'] },
            { id: 'task_hp_overdue', text: 'High priority overdue tasks', handler: 'qHPTasksOverdue', followUps: ['task_overdue_hr','task_overdue','task_hp'] },
            { id: 'task_overdue_hr', text: 'Overdue tasks for high-risk members', handler: 'qOverdueTasksHR', followUps: ['mem_hr_overdue','task_hp_overdue','task_overdue'] },
            { id: 'task_consent', text: 'Show me consent tasks pending', handler: 'qConsentTasksPending', followUps: ['task_assessment','task_careplan','task_overdue'] },
            { id: 'task_assessment', text: 'Show me assessment tasks pending', handler: 'qAssessmentTasksPending', followUps: ['task_consent','task_careplan','task_week'] },
            { id: 'task_careplan', text: 'Show me care plan tasks pending', handler: 'qCarePlanTasksPending', followUps: ['task_consent','task_assessment','task_week'] },
        ]
    },
    members: {
        label: 'Members',
        questions: [
            { id: 'mem_caseload', text: 'Show my caseload summary', handler: 'qCaseloadSummary', followUps: ['mem_high_risk','mem_overdue_tasks','mem_risk_breakdown'] },
            { id: 'mem_high_risk', text: 'Show me high-risk members', handler: 'qHighRiskMembers', followUps: ['mem_hr_overdue','mem_hr_today','mem_hr_adt'] },
            { id: 'mem_risk_breakdown', text: 'Show members by risk breakdown', handler: 'qCaseloadByRisk', followUps: ['mem_high_risk','mem_overdue_tasks','mem_safety'] },
            { id: 'mem_overdue_tasks', text: 'Members with overdue tasks', handler: 'qMembersWithOverdueTasks', followUps: ['mem_hr_overdue','task_hp_overdue','task_overdue_hr'] },
            { id: 'mem_hr_overdue', text: 'High-risk members with overdue tasks', handler: 'qHROverdue', followUps: ['task_overdue_hr','mem_hr_adt','mem_hr_today'] },
            { id: 'mem_hr_today', text: 'High-risk members with tasks due today', handler: 'qHRToday', followUps: ['task_today','task_hp','mem_hr_overdue'] },
            { id: 'mem_adt', text: 'Members with recent ADT events', handler: 'qADTMembers', followUps: ['mem_hr_adt','mem_safety','mem_overdue_tasks'] },
            { id: 'mem_hr_adt', text: 'High-risk members with recent ADT', handler: 'qHRADT', followUps: ['mem_safety','mem_hr_overdue','mem_high_risk'] },
            { id: 'mem_safety', text: 'Members with safety concerns', handler: 'qSafetyConcernMembers', followUps: ['mem_hr_overdue','mem_adt','mem_hr_adt'] },
            { id: 'mem_hp_tasks', text: 'Members with high priority tasks', handler: 'qMembersWithHPTasks', followUps: ['task_hp_overdue','task_hp','mem_hr_overdue'] },
        ]
    },
    notes: {
        label: 'Notes',
        questions: [
            { id: 'sn_draft', text: 'My draft notes to finalize', handler: 'qDraftNotes', followUps: ['sn_all_week','task_today'] },
            { id: 'sn_all_week', text: 'All service notes this week', handler: 'qNotesThisWeek', followUps: ['sn_draft','mem_caseload'] },
        ]
    },
    documents: {
        label: 'Documents',
        questions: [
            { id: 'doc_recent', text: 'Recent document uploads', handler: 'qRecentDocs', followUps: ['mem_caseload','task_today'] },
        ]
    }
};

// Follow-up question definitions
const FOLLOWUP_QUESTIONS = {
    //  TASK FOLLOW-UPS 
    task_overdue_hp: { text: 'Show me high priority overdue tasks', handler: 'qHPTasksOverdue' },
    task_overdue_hr: { text: 'Overdue tasks for high-risk members', handler: 'qOverdueTasksHR' },
    task_today: { text: 'Tasks due today', handler: 'qTasksDueToday' },
    task_hp_overdue: { text: 'High priority overdue tasks', handler: 'qHPTasksOverdue' },
    task_hp: { text: 'High priority tasks', handler: 'qHighPriorityTasks' },
    task_week: { text: 'Tasks due this week', handler: 'qTasksDueWeek' },
    task_overdue: { text: 'Show me my overdue tasks', handler: 'qOverdueTasks' },
    task_consent: { text: 'Show me consent tasks pending', handler: 'qConsentTasksPending' },
    task_assessment: { text: 'Show me assessment tasks pending', handler: 'qAssessmentTasksPending' },
    task_careplan: { text: 'Show me care plan tasks pending', handler: 'qCarePlanTasksPending' },

    //  MEMBER FOLLOW-UPS 
    mem_caseload: { text: 'Show my caseload summary', handler: 'qCaseloadSummary' },
    mem_high_risk: { text: 'Show me high-risk members', handler: 'qHighRiskMembers' },
    mem_risk_breakdown: { text: 'Show members by risk breakdown', handler: 'qCaseloadByRisk' },
    mem_overdue_tasks: { text: 'Members with overdue tasks', handler: 'qMembersWithOverdueTasks' },
    mem_hr_overdue: { text: 'High-risk members with overdue tasks', handler: 'qHROverdue' },
    mem_hr_today: { text: 'High-risk members with tasks due today', handler: 'qHRToday' },
    mem_adt: { text: 'Members with recent ADT events', handler: 'qADTMembers' },
    mem_hr_adt: { text: 'High-risk members with recent ADT', handler: 'qHRADT' },
    mem_safety: { text: 'Members with safety concerns', handler: 'qSafetyConcernMembers' },
    mem_hp_tasks: { text: 'Members with high priority tasks', handler: 'qMembersWithHPTasks' },

    //  NOTES FOLLOW-UPS 
    sn_draft: { text: 'My draft notes to finalize', handler: 'qDraftNotes' },
    sn_all_week: { text: 'All service notes this week', handler: 'qNotesThisWeek' },

    //  DOCUMENT FOLLOW-UPS 
    doc_recent: { text: 'Recent document uploads', handler: 'qRecentDocs' },
};

let currentAIQuestion = null; // Track current question for follow-ups

// 
// DATA LAYER  Gather all tasks from membersDB
// 
function getAllTasks() {
    if (typeof membersDB === 'undefined') return [];
    const today = new Date(); today.setHours(0,0,0,0);
    const tasks = [];

    membersDB.forEach(m => {
        // From dashboardData.tasks
        (m.dashboardData?.tasks || []).forEach(t => {
            const due = parseAnyDate(t.dueDate);
            tasks.push({
                ...t,
                memberName: m.name,
                memberId: m.id,
                memberRisk: m.riskCategory,
                memberRiskTier: m.riskTier,
                memberConsent: m.consentStatus,
                memberSafety: m.safetyConcern?.hasConcern || false,
                dueParsed: due,
                isOverdue: due && due < today,
                isDueToday: due && due.toDateString() === today.toDateString(),
                isDueThisWeek: due && due >= today && due <= new Date(today.getTime() + 7*86400000),
                isConsent: (t.type || t.title || t.name || '').toLowerCase().includes('consent'),
                isAssessment: (t.type || t.title || t.name || '').toLowerCase().includes('assessment'),
                isCarePlan: (t.type || t.title || t.name || '').toLowerCase().includes('care plan'),
            });
        });
        // From member.tasks (generated by generateMemberTasks)
        (m.tasks || []).forEach(t => {
            const due = parseAnyDate(t.dueDate);
            if (tasks.some(existing => existing.id === t.id)) return; // skip dupes
            tasks.push({
                ...t,
                title: t.name || t.title,
                memberName: t.memberName || m.name,
                memberId: m.id,
                memberRisk: m.riskCategory,
                memberRiskTier: m.riskTier,
                memberConsent: m.consentStatus,
                memberSafety: m.safetyConcern?.hasConcern || false,
                dueParsed: due,
                isOverdue: due && due < today,
                isDueToday: due && due.toDateString() === today.toDateString(),
                isDueThisWeek: due && due >= today && due <= new Date(today.getTime() + 7*86400000),
                isConsent: (t.type || t.name || '').toLowerCase().includes('consent'),
                isAssessment: (t.type || t.name || '').toLowerCase().includes('assessment'),
                isCarePlan: (t.type || t.name || '').toLowerCase().includes('care plan'),
            });
        });
    });
    return tasks;
}

function parseAnyDate(str) {
    if (!str) return null;
    // Handle DD/MM/YYYY
    if (/^\d{2}\/\d{2}\/\d{4}$/.test(str)) {
        const [d, m, y] = str.split('/');
        return new Date(+y, +m - 1, +d);
    }
    // Handle YYYY-MM-DD
    const d = new Date(str);
    return isNaN(d.getTime()) ? null : d;
}

function fmtDate(d) {
    if (!d) return '';
    if (typeof d === 'string') d = parseAnyDate(d);
    if (!d || isNaN(d.getTime())) return '';
    return d.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
}

function getServiceNotes() {
    if (typeof membersDB === 'undefined') return [];
    const notes = [];
    membersDB.forEach(m => {
        (m.serviceNotes || []).forEach(n => {
            notes.push({ ...n, memberName: m.name, memberId: m.id });
        });
    });
    return notes;
}

// 
// UI RENDERING
// 
function renderWelcomeScreen() {
    const container = document.getElementById('aiMessages');
    if (!container) return;
    aiCopilotState.isInConversation = false;

    const member = window.currentMember;

    //  MEMBER DETAIL CONTEXT 
    if (member) {
        const activeSubTab = getActiveMemberSubTab();
        const memberQuestions = getMemberContextQuestions(member, activeSubTab);

        container.innerHTML = `
            <div class="ai-welcome-screen">
                <div class="ai-welcome-dots">
                    <div class="dot"></div><div class="dot"></div><div class="dot"></div>
                    <div class="dot"></div><div class="dot"></div><div class="dot"></div>
                    <div class="dot"></div>
                </div>
                <div class="ai-welcome-heading">${member.name}</div>
                <div style="text-align:center;font-size:12px;color:#64748b;margin-top:4px;">${activeSubTab.replace(/-/g,' ').replace(/\b\w/g,c=>c.toUpperCase())}</div>
            </div>
            <div class="ai-questions-panel" id="aiQuestionsPanel">
                ${memberQuestions.map(q =>
                    `<button class="ai-question-item${q.text.startsWith('') ? ' smart' : ''}" onclick="handleAIQuestion('${q.id}')">${q.text}</button>`
                ).join('')}
            </div>
        `;
        document.getElementById('aiPanelTitle').textContent = member.name;
        // Show appointment header button on member pages
        const apptBtn = document.getElementById('aiHeaderApptBtn');
        if (apptBtn) apptBtn.classList.add('visible');
        return;
    }

    //  DEFAULT DASHBOARD CONTEXT 
    // Hide appointment header button on dashboard
    const apptBtnDash = document.getElementById('aiHeaderApptBtn');
    if (apptBtnDash) apptBtnDash.classList.remove('visible');
    const activeTab = aiCopilotState.activeTab;
    const tabsHTML = Object.entries(AI_TABS).map(([key, tab]) =>
        `<button class="ai-tab-btn ${key === activeTab ? 'active' : ''}" onclick="switchAITab('${key}')">${tab.label}</button>`
    ).join('');

    const questionsHTML = AI_TABS[activeTab].questions.map(q =>
        `<button class="ai-question-item" onclick="handleAIQuestion('${q.id}')">${q.text}</button>`
    ).join('');

    container.innerHTML = `
        <div class="ai-welcome-screen">
            <div class="ai-welcome-dots">
                <div class="dot"></div><div class="dot"></div><div class="dot"></div>
                <div class="dot"></div><div class="dot"></div><div class="dot"></div>
                <div class="dot"></div>
            </div>
            <div class="ai-welcome-heading">How can I help?</div>
        </div>
        <div class="ai-tabs-container">${tabsHTML}</div>
        <div class="ai-questions-panel" id="aiQuestionsPanel">${questionsHTML}</div>
    `;
    document.getElementById('aiPanelTitle').textContent = 'New chat';
}

function getActiveMemberSubTab() {
    const activeTab = document.querySelector('.page-content .content-tabs .tab.active');
    return activeTab ? activeTab.dataset.tab : 'dashboard';
}

function getMemberContextQuestions(member, subTab) {
    //  COMMON QUESTIONS (appear on ALL tabs) 
    const common = [
        { id: 'mx_next_focus', text: ' What should I focus on next contact?', handler: 'qNextContactFocus' },
        { id: 'mx_draft_note', text: ' Draft a service note', handler: 'qDraftServiceNote' },
        { id: 'mx_previsit', text: 'Generate pre-visit summary', handler: 'qPreVisitSummary' },
        { id: 'mx_attention', text: 'What needs my attention?', handler: 'qMemberAttention' },
        { id: 'mx_recent_updates', text: 'Show recent updates & changes', handler: 'qMemberRecentUpdates' },
        { id: 'mx_open_tasks', text: 'Show open tasks for this member', handler: 'qMemberOpenTasks' },
        { id: 'mx_create_appt', text: 'Schedule an appointment', handler: 'qCreateAppointment' },
    ];

    //  TAB-SPECIFIC QUESTIONS 
    const tabSpecific = {
        'dashboard': [
            { id: 'mx_adt_summary', text: 'Summarize recent ADT events', handler: 'qMemberADTSummary' },
            { id: 'mx_care_gaps', text: 'What are the care gaps for this member?', handler: 'qMemberCareGaps' },
            { id: 'mx_risk_acuity', text: 'Show risk factors & acuity history', handler: 'qMemberRiskAcuity' },
            { id: 'mx_recent_notes', text: 'Summarize last 5 service notes', handler: 'qMemberRecentNotes' },
        ],
        'details': [
            { id: 'mx_demographics', text: 'Summarize demographics & contact info', handler: 'qMemberDemographics' },
            { id: 'mx_enrollment', text: 'Show program & LOB enrollment', handler: 'qMemberEnrollment' },
            { id: 'mx_comm_prefs', text: 'Show communication preferences', handler: 'qMemberCommPrefs' },
        ],
        'timeline': [
            { id: 'mx_milestones', text: 'Summarize key journey milestones', handler: 'qMemberMilestones' },
            { id: 'mx_since_last', text: 'What happened since last contact?', handler: 'qMemberSinceLastContact' },
            { id: 'mx_engagement_gaps', text: 'Show gaps in member engagement', handler: 'qMemberEngagementGaps' },
        ],
        'insurance': [
            { id: 'mx_coverage_pcp', text: 'Summarize coverage & PCP info', handler: 'qMemberCoveragePCP' },
            { id: 'mx_enroll_history', text: 'Show enrollment & care span history', handler: 'qMemberEnrollHistory' },
            { id: 'mx_term_date', text: 'When is coverage term date?', handler: 'qMemberTermDate' },
        ],
        'screenings': [
            { id: 'mx_assess_due', text: 'What assessments are due or overdue?', handler: 'qMemberAssessDue' },
            { id: 'mx_assess_completed', text: 'Summarize completed assessments', handler: 'qMemberAssessCompleted' },
            { id: 'mx_assess_missing', text: 'What screenings are missing?', handler: 'qMemberScreeningsMissing' },
            { id: 'mx_assess_timeline', text: 'Show assessment completion timeline', handler: 'qMemberAssessTimeline' },
        ],
        'bio-psycho': [
            { id: 'mx_sdoh', text: 'Summarize social determinants', handler: 'qMemberSDOH' },
            { id: 'mx_barriers', text: 'What barriers to care exist?', handler: 'qMemberBarriers' },
            { id: 'mx_housing', text: 'Show housing & support situation', handler: 'qMemberHousing' },
        ],
        'history': [
            { id: 'mx_diagnoses', text: 'Summarize diagnoses & conditions', handler: 'qMemberDiagnoses' },
            { id: 'mx_medications', text: 'Show current medications', handler: 'qMemberMedications' },
            { id: 'mx_labs', text: 'Show recent labs with flags', handler: 'qMemberLabs' },
            { id: 'mx_allergies_vitals', text: 'Allergies & vital signs summary', handler: 'qMemberAllergiesVitals' },
        ],
        'population': [
            { id: 'mx_lob_programs', text: 'Show LOB & program details', handler: 'qMemberLOBPrograms' },
            { id: 'mx_risk_trend', text: 'Show risk score breakdown & trend', handler: 'qMemberRiskTrend' },
            { id: 'mx_priority_pop', text: 'What priority populations apply?', handler: 'qMemberPriorityPop' },
        ],
        'activity': [
            { id: 'mx_recent_contacts', text: 'Summarize recent contacts', handler: 'qMemberRecentContacts' },
            { id: 'mx_last_successful', text: 'When was last successful contact?', handler: 'qMemberLastContact' },
            { id: 'mx_contact_breakdown', text: 'Show contact attempts breakdown', handler: 'qMemberContactBreakdown' },
        ],
        'careteam': [
            { id: 'mx_full_team', text: 'Show full care team', handler: 'qMemberCareTeam' },
            { id: 'mx_pcp_info', text: 'PCP info & last visit', handler: 'qMemberPCPInfo' },
            { id: 'mx_coord_needs', text: 'Any care coordination needs?', handler: 'qMemberCoordNeeds' },
        ],
        'careplans': [
            { id: 'mx_cp_summary', text: 'Summarize active care plan', handler: 'qMemberCarePlanSummary' },
            { id: 'mx_cp_goals', text: 'What goals are overdue or at risk?', handler: 'qMemberGoalsAtRisk' },
            { id: 'mx_cp_interventions', text: 'Show care plan interventions', handler: 'qMemberInterventions' },
            { id: 'mx_cp_review', text: 'When is next care plan review?', handler: 'qMemberCPReview' },
        ],
    };

    return [...common, ...(tabSpecific[subTab] || tabSpecific['dashboard'])];
}

// Collect ALL member context question IDs for search (used by handleAIQuestion)
function getAllMemberContextQuestions(member) {
    const allQs = [];
    const tabs = ['dashboard','details','timeline','insurance','screenings','bio-psycho','history','population','activity','careteam','careplans'];
    const seen = new Set();
    tabs.forEach(tab => {
        getMemberContextQuestions(member, tab).forEach(q => {
            if (!seen.has(q.id)) { seen.add(q.id); allQs.push(q); }
        });
    });
    return allQs;
}

// Listen for member sub-tab changes to refresh AI questions
document.addEventListener('click', function(e) {
    const tab = e.target.closest('.page-content .content-tabs .tab');
    if (tab && window.currentMember && aiCopilotState.isOpen) {
        // Always reset conversation state and refresh when switching tabs
        setTimeout(() => {
            aiCopilotState.isInConversation = false;
            renderWelcomeScreen();
        }, 200);
    }
});

function switchAITab(tabKey) {
    aiCopilotState.activeTab = tabKey;
    // Re-render just the tabs and questions
    const tabBtns = document.querySelectorAll('.ai-tab-btn');
    tabBtns.forEach(btn => btn.classList.toggle('active', btn.textContent === AI_TABS[tabKey].label));

    const panel = document.getElementById('aiQuestionsPanel');
    if (panel) {
        panel.innerHTML = AI_TABS[tabKey].questions.map(q =>
            `<button class="ai-question-item" onclick="handleAIQuestion('${q.id}')">${q.text}</button>`
        ).join('');
    }
}

// 
// QUESTION HANDLING
// 
function handleAIQuestion(questionId) {
    // Find question from tabs
    let question = null;
    for (const tab of Object.values(AI_TABS)) {
        question = tab.questions.find(q => q.id === questionId);
        if (question) break;
    }
    // Check follow-ups
    if (!question && FOLLOWUP_QUESTIONS[questionId]) {
        question = FOLLOWUP_QUESTIONS[questionId];
        question.id = questionId;
    }
    // Check member context questions (search ALL tabs, not just current)
    if (!question && window.currentMember) {
        const allMemberQs = getAllMemberContextQuestions(window.currentMember);
        question = allMemberQs.find(q => q.id === questionId);
    }
    if (!question) return;

    currentAIQuestion = question;
    aiCopilotState.isInConversation = true;

    // Update panel title
    const titleEl = document.getElementById('aiPanelTitle');
    if (titleEl) titleEl.textContent = question.text.substring(0, 35) + (question.text.length > 35 ? '...' : '');

    const container = document.getElementById('aiMessages');
    if (!container) return;

    // Show user message + thinking
    container.innerHTML = `
        <div class="ai-conv-user"><div class="ai-conv-user-bubble">${question.text}</div></div>
        <div class="ai-thinking-container" id="aiThinking">
            <div class="ai-thinking-dots"><div class="tdot"></div><div class="tdot"></div><div class="tdot"></div></div>
            <div class="ai-thinking-text">Thinking...</div>
        </div>
        <div class="ai-thinking-shimmer" id="aiThinkingShimmer"></div>
    `;

    // Process after delay for UX
    setTimeout(() => {
        const thinkEl = document.getElementById('aiThinking');
        if (thinkEl) thinkEl.remove();
        const shimmerEl = document.getElementById('aiThinkingShimmer');
        if (shimmerEl) shimmerEl.remove();

        const handler = window[question.handler];
        if (typeof handler === 'function') {
            const result = handler();
            if (result && result._customHTML) {
                container.innerHTML += `<div class="ai-conv-assistant">${result._customHTML}</div>`;
            } else {
                const responseHTML = renderResponse(result, question);
                container.innerHTML += `<div class="ai-conv-assistant">${responseHTML}</div>`;
            }
        } else {
            container.innerHTML += `<div class="ai-conv-assistant"><div class="ai-response-block"><div class="ai-response-summary">Unable to process this query.</div></div></div>`;
        }
        container.scrollTop = 0;
    }, 800);
}

function handleFollowUpQuestion(fuId) {
    handleAIQuestion(fuId);
}

function sendAIMessage() {
    const input = document.getElementById('aiInputField');
    if (!input) return;
    const text = input.value.trim();
    if (!text) return;
    input.value = '';

    // Try to match to a known question
    const allQs = [];
    Object.values(AI_TABS).forEach(tab => allQs.push(...tab.questions));
    Object.entries(FOLLOWUP_QUESTIONS).forEach(([id, q]) => allQs.push({ ...q, id }));
    // Include member context questions if on member page
    if (window.currentMember) {
        getAllMemberContextQuestions(window.currentMember).forEach(q => allQs.push(q));
    }

    const match = allQs.find(q => q.text.toLowerCase() === text.toLowerCase());
    if (match) {
        handleAIQuestion(match.id);
    } else {
        // Fuzzy match
        const fuzzy = allQs.find(q => text.toLowerCase().includes(q.text.toLowerCase().split(' ').slice(2).join(' ')));
        if (fuzzy) {
            handleAIQuestion(fuzzy.id);
        } else {
            // Generic - go to first matching tab question
            const container = document.getElementById('aiMessages');
            if (container) {
                aiCopilotState.isInConversation = true;
                container.innerHTML = `
                    <div class="ai-conv-user"><div class="ai-conv-user-bubble">${escapeHtml(text)}</div></div>
                    <div class="ai-conv-assistant"><div class="ai-response-block">
                        <div class="ai-response-summary">I can help with specific queries about your caseload. Please select a question from the categories, or try typing one of the suggested questions.</div>
                        <div class="ai-back-row"><button class="ai-back-btn" onclick="resetAICopilot()"> Back to questions</button></div>
                    </div></div>
                `;
            }
        }
    }
}

function escapeHtml(t) { const d = document.createElement('div'); d.textContent = t; return d.innerHTML; }

// 
// RESPONSE RENDERER
// 
function renderResponse(result, question) {
    if (!result) return '<div class="ai-response-block"><div class="ai-response-summary">No data available.</div></div>';

    let html = '<div class="ai-response-block">';

    // Summary text
    if (result.summary) {
        html += `<div class="ai-response-summary">${result.summary}</div>`;
    }

    // Record count
    if (result.count !== undefined) {
        html += `<div class="ai-record-count"><span class="count-num">${result.count}</span> ${result.countLabel || 'records found'}</div>`;
    }

    // Activity summary grid
    if (result.activityGrid) {
        html += '<div class="ai-activity-grid">';
        result.activityGrid.forEach(card => {
            const clickable = card.action ? 'clickable' : '';
            const onclick = card.action ? `onclick="handleAIQuestion('${card.action}')"` : '';
            html += `<div class="ai-activity-card ${clickable}" ${onclick}>
                <div class="label">${card.label}</div>
                <div class="value">${card.value}</div>
                ${card.sub ? `<div class="sub">${card.sub}</div>` : ''}
            </div>`;
        });
        html += '</div>';
    }

    // Custom cards section (e.g., agenda cards)
    if (result._cardsHTML) {
        html += result._cardsHTML;
    }

    // Data table
    if (result.table && result.table.rows.length > 0) {
        const showRows = result.table.rows.slice(0, 8);
        const remaining = result.table.rows.length - 8;
        html += '<div class="ai-data-table-wrap"><table class="ai-data-table"><thead><tr>';
        html += result.table.columns.map(c => `<th>${c}</th>`).join('');
        html += '</tr></thead><tbody>';
        showRows.forEach(row => {
            html += '<tr>' + row.map(cell => `<td>${cell}</td>`).join('') + '</tr>';
        });
        html += '</tbody></table></div>';
        if (remaining > 0) {
            html += `<button class="ai-load-more-btn" onclick="this.style.display='none';document.getElementById('aiMoreRows').style.display='block'">Show ${remaining} more</button>`;
            html += '<div id="aiMoreRows" style="display:none"><div class="ai-data-table-wrap"><table class="ai-data-table"><tbody>';
            result.table.rows.slice(8).forEach(row => {
                html += '<tr>' + row.map(cell => `<td>${cell}</td>`).join('') + '</tr>';
            });
            html += '</tbody></table></div></div>';
        }
    }

    // Empty state
    if (result.count === 0 || (result.table && result.table.rows.length === 0)) {
        html += `<div class="ai-empty-state"><div class="emoji"></div><div class="title">All clear!</div><div class="desc">${result.emptyMsg || 'No matching records found.'}</div></div>`;
    }

    // Show thinking
    if (result.thinking) {
        const tid = 'think_' + Math.random().toString(36).substr(2, 6);
        html += `<div class="ai-show-thinking">
            <button class="ai-show-thinking-toggle" onclick="toggleThinking('${tid}', this)">
                <span class="arrow"></span> Show thinking
            </button>
            <div class="ai-thinking-content" id="${tid}">${result.thinking}</div>
        </div>`;
    }

    // Feedback
    html += `<div class="ai-feedback-row">
        <button class="ai-feedback-btn" onclick="this.style.color='#2d2d52'" title="Helpful">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 9V5a3 3 0 00-3-3l-4 9v11h11.28a2 2 0 002-1.7l1.38-9a2 2 0 00-2-2.3H14z"/></svg>
        </button>
        <button class="ai-feedback-btn" onclick="this.style.color='#ef4444'" title="Not helpful">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M10 15v4a3 3 0 003 3l4-9V2H5.72a2 2 0 00-2 1.7l-1.38 9a2 2 0 002 2.3H10z"/></svg>
        </button>
    </div>`;

    // Follow-ups
    if (question && question.followUps && question.followUps.length > 0) {
        html += '<div class="ai-followups"><div class="ai-followups-label">Follow-ups</div>';
        question.followUps.forEach(fuId => {
            const fu = FOLLOWUP_QUESTIONS[fuId];
            if (fu) {
                html += `<button class="ai-followup-item" onclick="handleFollowUpQuestion('${fuId}')">${fu.text}</button>`;
            }
        });
        html += '</div>';
    }

    // Back button
    html += '<div class="ai-back-row"><button class="ai-back-btn" onclick="resetAICopilot()"> Back to questions</button></div>';

    html += '</div>';
    return html;
}

function toggleThinking(id, btn) {
    const el = document.getElementById(id);
    if (!el) return;
    el.classList.toggle('visible');
    btn.classList.toggle('open');
}

function badgeHTML(text, type) {
    return `<span class="ai-badge ${type}">${text}</span>`;
}

// 
// TOGGLE & INIT
// 
function toggleAICopilotExpand() {
    const panel = document.getElementById('aiCopilotPanel');
    if (!panel) return;
    panel.classList.toggle('expanded');
    aiCopilotState.isExpanded = panel.classList.contains('expanded');
}

function toggleAICopilot() {
    const panel = document.getElementById('aiCopilotPanel');
    if (!panel) return;
    aiCopilotState.isOpen = !aiCopilotState.isOpen;
    if (aiCopilotState.isOpen) {
        panel.classList.add('open'); panel.classList.remove('closed');
        document.body.classList.add('ai-panel-open');
        if (!aiCopilotState.isInConversation) renderWelcomeScreen();
    } else {
        panel.classList.remove('open','expanded'); panel.classList.add('closed');
        document.body.classList.remove('ai-panel-open');
        aiCopilotState.isExpanded = false;
    }
}

function closeAICopilot() {
    const panel = document.getElementById('aiCopilotPanel');
    if (panel) { panel.classList.remove('open','expanded'); panel.classList.add('closed'); document.body.classList.remove('ai-panel-open'); aiCopilotState.isOpen = false; aiCopilotState.isExpanded = false; }
}

function resetAICopilot() {
    aiCopilotState.isInConversation = false;
    aiCopilotState.activeTab = 'tasks';
    currentAIQuestion = null;
    renderWelcomeScreen();
}

function clearAIChat() { resetAICopilot(); }
function handleAIInputChange() {} // placeholder

function initAICopilot() {
    // Keyboard shortcut
    document.addEventListener('keydown', function(e) {
        if ((e.metaKey || e.ctrlKey) && e.key === 'j') { e.preventDefault(); toggleAICopilot(); }
        if (e.key === 'Escape' && aiCopilotState.isOpen) {
            e.preventDefault();
            if (aiCopilotState.isExpanded) {
                toggleAICopilotExpand(); // collapse first
            } else {
                toggleAICopilot(); // then close
            }
        }
    });
    const panel = document.getElementById('aiCopilotPanel');
    if (panel) {
        aiCopilotState.isOpen = panel.classList.contains('open');
        if (aiCopilotState.isOpen) renderWelcomeScreen();
    }
}

function initAICopilotListeners() {}

if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initAICopilot);
} else {
    initAICopilot();
}

// Auto-navigate to member if URL has #memberNav=ID (from new tab links)
(function() {
    function checkMemberHash() {
        const hash = window.location.hash;
        if (hash.startsWith('#memberNav=')) {
            const id = hash.replace('#memberNav=', '');
            if (id && typeof navigateToDetails === 'function') {
                setTimeout(() => {
                    navigateToDetails(id);
                    window.location.hash = ''; // Clean up
                }, 500);
            }
        }
    }
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', checkMemberHash);
    } else {
        setTimeout(checkMemberHash, 500);
    }
})();


// 
// QUERY HANDLERS  Every function queries membersDB directly
// 

//  TASK TABLE HELPER 
function taskTableResult(tasks, label, thinkingNote) {
    const sorted = tasks.sort((a, b) => {
        const po = { High: 0, Medium: 1, Low: 2 };
        return (po[a.priority] || 2) - (po[b.priority] || 2);
    });
    const byType = {};
    tasks.forEach(t => { byType[t.type || t.title || 'Other'] = (byType[t.type || t.title || 'Other'] || 0) + 1; });
    const breakdown = Object.entries(byType).map(([k, v]) => `${v} ${k}`).join(', ');

    return {
        summary: `<strong>${tasks.length} ${label}</strong> across your caseload.${breakdown ? ' Breakdown: ' + breakdown + '.' : ''}`,
        count: tasks.length,
        countLabel: label,
        table: {
            columns: ['Task Name', 'Member', 'Due Date', 'Priority', 'Status'],
            rows: sorted.map(t => [
                `<span class="td-name">${t.title || t.name || ''}</span>`,
                `<span class="td-member" onclick="handleMemberCardClick('${t.memberId}')">${t.memberName || ''}</span>`,
                fmtDate(t.dueDate),
                badgeHTML(t.priority || '', (t.priority || '').toLowerCase()),
                badgeHTML(t.status || '', (t.status || '').toLowerCase().replace(/\s/g, '-'))
            ])
        },
        thinking: thinkingNote || `Scanned all ${membersDB.length} members. Found ${tasks.length} tasks matching "${label}". Sorted by priority (High  Low).`,
        emptyMsg: `No ${label} found  you're all caught up!`
    };
}

//  MEMBER TABLE HELPER 
function memberTableResult(members, label, thinkingNote) {
    return {
        summary: `<strong>${members.length} ${label}</strong> in your caseload.`,
        count: members.length,
        countLabel: label,
        table: {
            columns: ['Member Name', 'Risk Level', 'Open Tasks', 'Consent', 'Last Contact'],
            rows: members.map(m => {
                const tasks = (m.dashboardData?.tasks || []).concat(m.tasks || []);
                const openTasks = tasks.filter(t => t.status !== 'Closed').length;
                const notes = m.serviceNotes || [];
                const lastNote = notes.length > 0 ? notes[notes.length - 1] : null;
                const lastContact = lastNote ? fmtDate(lastNote.date) : 'No contact';
                return [
                    `<span class="td-name" onclick="handleMemberCardClick('${m.id}')">${m.name}</span>`,
                    badgeHTML(m.riskCategory || '', 'risk-' + (m.riskCategory || '').toLowerCase()),
                    openTasks.toString(),
                    badgeHTML(m.consentStatus || '', m.consentStatus === 'Consented' ? 'posted' : (m.consentStatus === 'Declined' ? 'closed' : 'draft')),
                    lastContact
                ];
            })
        },
        thinking: thinkingNote || `Queried membersDB (${membersDB.length} members). Found ${members.length} matching "${label}".`,
        emptyMsg: `No ${label} found.`
    };
}

// 
// TASK QUERIES
// 

function qOverdueTasks() {
    const all = getAllTasks();
    const tasks = all.filter(t => t.isOverdue && t.status !== 'Closed');
    return taskTableResult(tasks, 'overdue tasks',
        `Scanned ${all.length} total tasks across ${membersDB.length} members. Filtered where dueDate < today AND status  Closed. Found ${tasks.length} overdue.`);
}

function qOverdueTasksHP() {
    const all = getAllTasks();
    const tasks = all.filter(t => t.isOverdue && t.status !== 'Closed' && t.priority === 'High');
    return taskTableResult(tasks, 'overdue high-priority tasks',
        `Filtered overdue tasks where priority = "High". Found ${tasks.length} of ${all.filter(t => t.isOverdue && t.status !== 'Closed').length} overdue tasks are high priority.`);
}

function qOverdueTasksHR() {
    const all = getAllTasks();
    const tasks = all.filter(t => t.isOverdue && t.status !== 'Closed' && t.memberRisk === 'High');
    return taskTableResult(tasks, 'overdue tasks for high-risk members',
        `Filtered overdue tasks where member riskCategory = "High". Found ${tasks.length}.`);
}

function qOverdueConsent() {
    const all = getAllTasks();
    const tasks = all.filter(t => t.isOverdue && t.status !== 'Closed' && t.isConsent);
    return taskTableResult(tasks, 'overdue consent tasks',
        `Filtered overdue tasks where type includes "Consent". Found ${tasks.length}.`);
}

function qTasksDueToday() {
    const all = getAllTasks();
    const tasks = all.filter(t => t.isDueToday && t.status !== 'Closed');
    return taskTableResult(tasks, 'tasks due today',
        `Checked all tasks for dueDate matching today (${new Date().toLocaleDateString()}). Found ${tasks.length}.`);
}

function qTasksTodayHP() {
    const all = getAllTasks();
    const tasks = all.filter(t => t.isDueToday && t.status !== 'Closed' && t.priority === 'High');
    return taskTableResult(tasks, 'high-priority tasks due today');
}

function qTasksTodayHR() {
    const all = getAllTasks();
    const tasks = all.filter(t => t.isDueToday && t.status !== 'Closed' && t.memberRisk === 'High');
    return taskTableResult(tasks, 'tasks due today for high-risk members');
}

function qConsentTasksToday() {
    const all = getAllTasks();
    const tasks = all.filter(t => t.isDueToday && t.status !== 'Closed' && t.isConsent);
    return taskTableResult(tasks, 'consent tasks due today');
}

function qTasksDueWeek() {
    const all = getAllTasks();
    const tasks = all.filter(t => t.isDueThisWeek && t.status !== 'Closed');
    return taskTableResult(tasks, 'tasks due this week',
        `Filtered for tasks with dueDate within next 7 days. Found ${tasks.length}.`);
}

function qTasksWeekHP() {
    const all = getAllTasks();
    const tasks = all.filter(t => t.isDueThisWeek && t.status !== 'Closed' && t.priority === 'High');
    return taskTableResult(tasks, 'high-priority tasks due this week');
}

function qTasksWeekHR() {
    const all = getAllTasks();
    const tasks = all.filter(t => t.isDueThisWeek && t.status !== 'Closed' && t.memberRisk === 'High');
    return taskTableResult(tasks, 'tasks due this week for high-risk members');
}

function qConsentTasksWeek() {
    const all = getAllTasks();
    const tasks = all.filter(t => t.isDueThisWeek && t.status !== 'Closed' && t.isConsent);
    return taskTableResult(tasks, 'consent tasks due this week');
}

function qHighPriorityTasks() {
    const all = getAllTasks();
    const tasks = all.filter(t => t.priority === 'High' && t.status !== 'Closed');
    return taskTableResult(tasks, 'high-priority tasks',
        `Filtered all tasks where priority = "High" AND status  Closed. Found ${tasks.length}.`);
}

function qHPTasksOverdue() {
    const all = getAllTasks();
    const tasks = all.filter(t => t.priority === 'High' && t.isOverdue && t.status !== 'Closed');
    return taskTableResult(tasks, 'high-priority overdue tasks');
}

function qHPTasksToday() {
    const all = getAllTasks();
    const tasks = all.filter(t => t.priority === 'High' && t.isDueToday && t.status !== 'Closed');
    return taskTableResult(tasks, 'high-priority tasks due today');
}

function qHPTasksWeek() {
    const all = getAllTasks();
    const tasks = all.filter(t => t.priority === 'High' && t.isDueThisWeek && t.status !== 'Closed');
    return taskTableResult(tasks, 'high-priority tasks due this week');
}

function qHPTasksHR() {
    const all = getAllTasks();
    const tasks = all.filter(t => t.priority === 'High' && t.status !== 'Closed' && t.memberRisk === 'High');
    return taskTableResult(tasks, 'high-priority tasks for high-risk members');
}

function qConsentTasksPending() {
    const all = getAllTasks();
    const tasks = all.filter(t => t.isConsent && t.status !== 'Closed');
    return taskTableResult(tasks, 'pending consent tasks',
        `Filtered all tasks where type/name includes "Consent" AND status  Closed. Found ${tasks.length}.`);
}

function qAssessmentTasksPending() {
    const all = getAllTasks();
    const tasks = all.filter(t => t.isAssessment && t.status !== 'Closed');
    return taskTableResult(tasks, 'pending assessment tasks',
        `Filtered all tasks where type/name includes "Assessment" AND status  Closed. Found ${tasks.length}.`);
}

function qCarePlanTasksPending() {
    const all = getAllTasks();
    const tasks = all.filter(t => t.isCarePlan && t.status !== 'Closed');
    return taskTableResult(tasks, 'pending care plan tasks',
        `Filtered all tasks where type/name includes "Care Plan" AND status  Closed. Found ${tasks.length}.`);
}

// 
// MEMBER QUERIES
// 

function qHighRiskMembers() {
    const members = membersDB.filter(m => m.riskCategory === 'High');
    return memberTableResult(members, 'high-risk members',
        `Filtered membersDB where riskCategory = "High" (riskTier >= 4). Found ${members.length} of ${membersDB.length} total members.`);
}

function qCaseloadSummary() {
    const byRisk = {};
    membersDB.forEach(m => {
        const risk = m.riskCategory || 'Unknown';
        byRisk[risk] = (byRisk[risk] || 0) + 1;
    });
    const byConsent = {};
    membersDB.forEach(m => {
        const cs = m.consentStatus || 'Unknown';
        byConsent[cs] = (byConsent[cs] || 0) + 1;
    });
    const allTasks = getAllTasks();
    const openTasks = allTasks.filter(t => t.status !== 'Closed').length;
    const overdueTasks = allTasks.filter(t => t.isOverdue && t.status !== 'Closed').length;
    const safetyCount = membersDB.filter(m => m.safetyConcern?.hasConcern).length;
    const adtCount = membersDB.filter(m => m.dashboardData?.adts?.length > 0).length;
    const hpTasks = allTasks.filter(t => t.priority === 'High' && t.status !== 'Closed').length;
    const consentTasks = allTasks.filter(t => t.isConsent && t.status !== 'Closed').length;
    const assessmentTasks = allTasks.filter(t => t.isAssessment && t.status !== 'Closed').length;
    const carePlanTasks = allTasks.filter(t => t.isCarePlan && t.status !== 'Closed').length;

    // Build "Needs Attention" table  members who need action
    const attentionRows = [];
    membersDB.forEach(m => {
        const mTasks = allTasks.filter(t => t.memberId === m.id && t.status !== 'Closed');
        const mOverdue = mTasks.filter(t => t.isOverdue).length;
        const mHP = mTasks.filter(t => t.priority === 'High').length;
        const hasSafety = m.safetyConcern?.hasConcern;
        const hasADT = m.dashboardData?.adts?.length > 0;
        const needsConsent = m.consentStatus === 'To Obtain Consent';
        // Only show members that need some action
        if (mOverdue > 0 || hasSafety || hasADT) {
            const flags = [];
            if (mOverdue > 0) flags.push(`${mOverdue} overdue`);
            if (hasSafety) flags.push('Safety');
            if (hasADT) flags.push('ADT');
            if (needsConsent) flags.push('Consent');
            attentionRows.push({
                sortScore: (hasSafety ? 100 : 0) + (mOverdue * 10) + (hasADT ? 5 : 0),
                row: [
                    `<span class="td-name" onclick="openMemberNewTab('${m.id}')">${m.name}</span>`,
                    badgeHTML(m.riskCategory || '', 'risk-' + (m.riskCategory || '').toLowerCase()),
                    mTasks.length.toString(),
                    mOverdue > 0 ? badgeHTML(`${mOverdue} overdue`, 'overdue') : '0',
                    flags.map(f => {
                        const cls = f === 'Safety' ? 'critical' : f === 'ADT' ? 'open' : f === 'Consent' ? 'draft' : 'overdue';
                        return badgeHTML(f, cls);
                    }).join(' ')
                ]
            });
        }
    });
    attentionRows.sort((a, b) => b.sortScore - a.sortScore);

    return {
        summary: `<strong>Caseload summary</strong>: ${membersDB.length} members, ${openTasks} open tasks, ${overdueTasks} overdue. ${safetyCount} safety concerns, ${adtCount} recent ADTs.`,
        activityGrid: [
            { label: 'Total Members', value: membersDB.length, sub: 'in caseload', action: 'mem_risk_breakdown' },
            { label: 'High Risk', value: byRisk['High'] || 0, sub: 'need close monitoring ', action: 'mem_high_risk' },
            { label: 'Overdue Tasks', value: overdueTasks, sub: 'need immediate action ', action: 'mem_overdue_tasks' },
            { label: 'Safety Concerns', value: safetyCount, sub: 'flagged members ', action: 'mem_safety' },
            { label: 'Recent ADT', value: adtCount, sub: 'respond to events ', action: 'mem_adt' },
            { label: 'High Priority Tasks', value: hpTasks, sub: 'focus items ', action: 'mem_hp_tasks' },
        ],
        table: attentionRows.length > 0 ? {
            columns: ['Member Name', 'Risk', 'Open Tasks', 'Overdue', 'Flags'],
            rows: attentionRows.map(r => r.row)
        } : null,
        count: attentionRows.length,
        countLabel: 'members need attention',
        thinking: `Full caseload analysis: ${membersDB.length} members. Risk: ${Object.entries(byRisk).map(([k,v])=>k+':'+v).join(', ')}. Consent: ${Object.entries(byConsent).map(([k,v])=>k+':'+v).join(', ')}. Tasks: ${openTasks} open, ${overdueTasks} overdue, ${hpTasks} high priority. By type: ${consentTasks} consent, ${assessmentTasks} assessment, ${carePlanTasks} care plan. Safety: ${safetyCount}. ADT: ${adtCount}. Attention list: ${attentionRows.length} members need action.`,
    };
}

function qMembersWithOverdueTasks() {
    const allTasks = getAllTasks();
    const members = membersDB.filter(m =>
        allTasks.some(t => t.memberId === m.id && t.isOverdue && t.status !== 'Closed')
    );
    return memberTableResult(members, 'members with overdue tasks',
        `Cross-referenced membersDB with tasks where isOverdue = true AND status  Closed. Found ${members.length} members.`);
}

function qMembersWithHPTasks() {
    const allTasks = getAllTasks();
    const members = membersDB.filter(m =>
        allTasks.some(t => t.memberId === m.id && t.priority === 'High' && t.status !== 'Closed')
    );
    return memberTableResult(members, 'members with high priority tasks',
        `Cross-referenced membersDB with tasks where priority = "High" AND status  Closed. Found ${members.length} members.`);
}

function qHRADT() {
    const members = membersDB.filter(m => m.riskCategory === 'High' && m.dashboardData?.adts?.length > 0);
    const result = memberTableResult(members, 'high-risk members with recent ADT',
        `Filtered membersDB where riskCategory = "High" AND has ADT events. Found ${members.length}.`);
    result.table = {
        columns: ['Member Name', 'Risk Level', 'ADT Type', 'Facility', 'Date', 'Acknowledged'],
        rows: []
    };
    members.forEach(m => {
        (m.dashboardData.adts || []).forEach(adt => {
            result.table.rows.push([
                `<span class="td-name" onclick="handleMemberCardClick('${m.id}')">${m.name}</span>`,
                badgeHTML(m.riskCategory || '', 'risk-' + (m.riskCategory || '').toLowerCase()),
                adt.type || '',
                `<span>${adt.facility || ''}</span>`,
                fmtDate(adt.date),
                badgeHTML(adt.acknowledged || '', adt.acknowledged === 'No' ? 'overdue' : 'posted')
            ]);
        });
    });
    result.count = result.table.rows.length;
    result.countLabel = 'ADT events for high-risk members';
    return result;
}

function qHROverdue() {
    const allTasks = getAllTasks();
    const members = membersDB.filter(m => {
        if (m.riskCategory !== 'High') return false;
        return allTasks.some(t => t.memberId === m.id && t.isOverdue && t.status !== 'Closed');
    });
    return memberTableResult(members, 'high-risk members with overdue tasks');
}

function qHRToday() {
    const allTasks = getAllTasks();
    const members = membersDB.filter(m => {
        if (m.riskCategory !== 'High') return false;
        return allTasks.some(t => t.memberId === m.id && t.isDueToday && t.status !== 'Closed');
    });
    return memberTableResult(members, 'high-risk members with tasks due today');
}

function qHRConsent() {
    const members = membersDB.filter(m =>
        m.riskCategory === 'High' && ['To Obtain Consent', 'Re-consent Required'].includes(m.consentStatus)
    );
    return memberTableResult(members, 'high-risk members needing consent',
        `Filtered for riskCategory = "High" AND consentStatus  ["To Obtain Consent", "Re-consent Required"]. Found ${members.length}.`);
}

function qSafetyConcernMembers() {
    const members = membersDB.filter(m => m.safetyConcern?.hasConcern);
    return memberTableResult(members, 'members with Safety Concern',
        `Filtered membersDB where safetyConcern.hasConcern = true. Found ${members.length} of ${membersDB.length}.`);
}

function qSCOverdue() {
    const allTasks = getAllTasks();
    const members = membersDB.filter(m => {
        if (!m.safetyConcern?.hasConcern) return false;
        return allTasks.some(t => t.memberId === m.id && t.isOverdue && t.status !== 'Closed');
    });
    return memberTableResult(members, 'Safety Concern members with overdue tasks');
}

function qSCToday() {
    const allTasks = getAllTasks();
    const members = membersDB.filter(m => {
        if (!m.safetyConcern?.hasConcern) return false;
        return allTasks.some(t => t.memberId === m.id && t.isDueToday && t.status !== 'Closed');
    });
    return memberTableResult(members, 'Safety Concern members with tasks due today');
}

function qSCConsent() {
    const members = membersDB.filter(m =>
        m.safetyConcern?.hasConcern && ['To Obtain Consent', 'Re-consent Required'].includes(m.consentStatus)
    );
    return memberTableResult(members, 'Safety Concern members needing consent');
}

function qSCWeek() {
    const allTasks = getAllTasks();
    const members = membersDB.filter(m => {
        if (!m.safetyConcern?.hasConcern) return false;
        return allTasks.some(t => t.memberId === m.id && t.isDueThisWeek && t.status !== 'Closed');
    });
    return memberTableResult(members, 'Safety Concern members with tasks due this week');
}

function qADTMembers() {
    const members = membersDB.filter(m => m.dashboardData?.adts?.length > 0);
    const result = memberTableResult(members, 'members with recent ADT events',
        `Filtered membersDB where dashboardData.adts array has entries. Found ${members.length}.`);
    // Override table to show ADT-specific columns
    result.table = {
        columns: ['Member Name', 'ADT Type', 'Facility', 'Date', 'Acknowledged'],
        rows: []
    };
    members.forEach(m => {
        (m.dashboardData.adts || []).forEach(adt => {
            result.table.rows.push([
                `<span class="td-name" onclick="handleMemberCardClick('${m.id}')">${m.name}</span>`,
                adt.type || '',
                `<span>${adt.facility || ''}</span>`,
                fmtDate(adt.date),
                badgeHTML(adt.acknowledged || '', adt.acknowledged === 'No' ? 'overdue' : 'posted')
            ]);
        });
    });
    result.count = result.table.rows.length;
    result.countLabel = 'ADT events';
    return result;
}

function qADTUnack() {
    const members = membersDB.filter(m =>
        m.dashboardData?.adts?.some(a => a.acknowledged === 'No')
    );
    const result = memberTableResult(members, 'members with unacknowledged ADT events');
    result.table = {
        columns: ['Member Name', 'ADT Type', 'Facility', 'Date'],
        rows: []
    };
    members.forEach(m => {
        (m.dashboardData.adts || []).filter(a => a.acknowledged === 'No').forEach(adt => {
            result.table.rows.push([
                `<span class="td-name" onclick="handleMemberCardClick('${m.id}')">${m.name}</span>`,
                adt.type || '',
                `<span>${adt.facility || ''}</span>`,
                fmtDate(adt.date)
            ]);
        });
    });
    result.count = result.table.rows.length;
    result.countLabel = 'unacknowledged ADT events';
    return result;
}

function qADT48h() {
    const cutoff = new Date(Date.now() - 48 * 60 * 60 * 1000);
    const members = membersDB.filter(m =>
        m.dashboardData?.adts?.some(a => {
            const t = a.type || '';
            if (!t.toLowerCase().includes('discharge') && !t.includes('A03')) return false;
            const d = parseAnyDate(a.date);
            return d && d >= cutoff;
        })
    );
    const result = memberTableResult(members, 'members discharged in last 48 hours',
        `Filtered ADT events for type containing "Discharge" or "A03" with date >= 48 hours ago. Found ${members.length}.`);
    result.table = {
        columns: ['Member Name', 'ADT Type', 'Facility', 'Date', 'Risk Level'],
        rows: []
    };
    members.forEach(m => {
        (m.dashboardData.adts || []).forEach(adt => {
            result.table.rows.push([
                `<span class="td-name" onclick="handleMemberCardClick('${m.id}')">${m.name}</span>`,
                adt.type || '',
                `<span>${adt.facility || ''}</span>`,
                fmtDate(adt.date),
                badgeHTML(m.riskCategory || '', 'risk-' + (m.riskCategory || '').toLowerCase())
            ]);
        });
    });
    result.count = result.table.rows.length;
    return result;
}

function qADTOpenTasks() {
    const allTasks = getAllTasks();
    const members = membersDB.filter(m => {
        if (!m.dashboardData?.adts?.length) return false;
        return allTasks.some(t => t.memberId === m.id && t.status !== 'Closed');
    });
    return memberTableResult(members, 'members with ADT events and open tasks',
        `Cross-referenced ADT members with open tasks. Found ${members.length}.`);
}

// 
// SERVICE NOTES QUERIES
// 

function qDraftNotes() {
    const notes = getServiceNotes().filter(n =>
        (n.status || '').toLowerCase() === 'draft' || (n.status || '').toLowerCase() !== 'posted'
    );
    // Since the data generator marks all notes as "Posted", show recent notes instead
    const allNotes = getServiceNotes();
    return {
        summary: `<strong>${allNotes.length} service notes</strong> across your caseload. Showing most recent notes.`,
        count: allNotes.length,
        countLabel: 'service notes',
        table: {
            columns: ['Date', 'Member', 'Activity', 'Type', 'Status'],
            rows: allNotes.slice(-10).reverse().map(n => [
                fmtDate(n.date),
                `<span class="td-member" onclick="handleMemberCardClick('${n.memberId}')">${n.memberName || ''}</span>`,
                n.activity || n.subject || '',
                n.type || '',
                badgeHTML(n.status || '', (n.status || '').toLowerCase())
            ])
        },
        thinking: `Queried serviceNotes across all ${membersDB.length} members. Total notes: ${allNotes.length}. In this demo dataset, all notes are marked "Posted". Showing 10 most recent.`,
        emptyMsg: 'No service notes found.'
    };
}

function qDraftNotesWeek() {
    const weekAgo = new Date(Date.now() - 7 * 86400000);
    const notes = getServiceNotes().filter(n => {
        const d = parseAnyDate(n.date);
        return d && d >= weekAgo;
    });
    return {
        summary: `<strong>${notes.length} service notes</strong> created this week.`,
        count: notes.length,
        countLabel: 'notes this week',
        table: {
            columns: ['Date', 'Member', 'Activity', 'Type', 'Duration'],
            rows: notes.reverse().map(n => [
                fmtDate(n.date),
                `<span class="td-member" onclick="handleMemberCardClick('${n.memberId}')">${n.memberName || ''}</span>`,
                n.activity || '',
                n.type || '',
                n.duration || ''
            ])
        },
        thinking: `Filtered service notes where date >= ${weekAgo.toLocaleDateString()}. Found ${notes.length}.`,
        emptyMsg: 'No service notes created this week.'
    };
}

function qDraftNotesToday() {
    const today = new Date(); today.setHours(0, 0, 0, 0);
    const notes = getServiceNotes().filter(n => {
        const d = parseAnyDate(n.date);
        return d && d.toDateString() === today.toDateString();
    });
    return {
        summary: `<strong>${notes.length} service notes</strong> created today.`,
        count: notes.length,
        countLabel: 'notes today',
        table: {
            columns: ['Time', 'Member', 'Activity', 'Type', 'Duration'],
            rows: notes.map(n => [
                n.time || '',
                `<span class="td-member" onclick="handleMemberCardClick('${n.memberId}')">${n.memberName || ''}</span>`,
                n.activity || '',
                n.type || '',
                n.duration || ''
            ])
        },
        thinking: `Filtered service notes where date = today (${today.toLocaleDateString()}). Found ${notes.length}.`,
        emptyMsg: 'No service notes created today.'
    };
}

// 
// DOCUMENT QUERIES
// 

function qRecentDocs() {
    // Documents are not directly in membersDB, so we simulate from activity logs
    const docs = [];
    membersDB.forEach(m => {
        (m.activityLog || []).forEach(a => {
            if ((a.action || a.type || '').toLowerCase().includes('document') || (a.action || a.type || '').toLowerCase().includes('upload')) {
                docs.push({ ...a, memberName: m.name, memberId: m.id });
            }
        });
    });
    if (docs.length === 0) {
        return {
            summary: '<strong>Document uploads</strong> are tracked in the Documents module. No uploads found in current activity logs.',
            count: 0,
            countLabel: 'document uploads',
            thinking: `Searched activityLog across all members for entries containing "document" or "upload". Found ${docs.length}. The demo dataset doesn't include document upload entries.`,
            emptyMsg: 'No document uploads found in activity logs.'
        };
    }
    return {
        summary: `<strong>${docs.length} document uploads</strong> found.`,
        count: docs.length, countLabel: 'documents',
        table: {
            columns: ['Date', 'Member', 'Type', 'Details'],
            rows: docs.slice(0, 10).map(d => [
                fmtDate(d.date), `<span class="td-member" onclick="handleMemberCardClick('${d.memberId}')">${d.memberName}</span>`, d.type || '', d.action || d.details || ''
            ])
        },
        thinking: `Searched activity logs for document-related entries. Found ${docs.length}.`
    };
}

function qDocsWeek() { return qRecentDocs(); }
function qDocsToday() { return qRecentDocs(); }

// 
// ACTIVITY SUMMARY QUERIES
// 

function qActivityToday() {
    const allTasks = getAllTasks();
    const allNotes = getServiceNotes();
    const today = new Date(); today.setHours(0,0,0,0);

    const tasksDueToday = allTasks.filter(t => t.isDueToday && t.status !== 'Closed').length;
    const overdueTasks = allTasks.filter(t => t.isOverdue && t.status !== 'Closed').length;
    const highPriority = allTasks.filter(t => t.priority === 'High' && t.status !== 'Closed').length;
    const notesToday = allNotes.filter(n => { const d = parseAnyDate(n.date); return d && d.toDateString() === today.toDateString(); }).length;
    const consentPending = membersDB.filter(m => ['To Obtain Consent', 'Re-consent Required'].includes(m.consentStatus)).length;
    const safetyConcerns = membersDB.filter(m => m.safetyConcern?.hasConcern).length;

    return {
        summary: `Here's your <strong>activity summary for today</strong> (${today.toLocaleDateString('en-US', {weekday: 'long', month: 'long', day: 'numeric'})}).`,
        activityGrid: [
            { label: 'Tasks Due Today', value: tasksDueToday, sub: `${highPriority} high priority` },
            { label: 'Overdue Tasks', value: overdueTasks, sub: 'need attention' },
            { label: 'Notes Today', value: notesToday, sub: 'service notes logged' },
            { label: 'Consent Pending', value: consentPending, sub: 'members awaiting' },
            { label: 'Safety Concerns', value: safetyConcerns, sub: 'active concerns' },
            { label: 'Total Caseload', value: membersDB.length, sub: 'members assigned' }
        ],
        thinking: `Computed today's activity summary from membersDB (${membersDB.length} members). Tasks due today: ${tasksDueToday}. Overdue: ${overdueTasks}. High priority: ${highPriority}. Service notes today: ${notesToday}. Consent pending: ${consentPending}. Safety concerns: ${safetyConcerns}.`
    };
}

function qActivityWeek() {
    const allTasks = getAllTasks();
    const allNotes = getServiceNotes();
    const weekAgo = new Date(Date.now() - 7 * 86400000);

    const tasksDueWeek = allTasks.filter(t => t.isDueThisWeek && t.status !== 'Closed').length;
    const overdueTasks = allTasks.filter(t => t.isOverdue && t.status !== 'Closed').length;
    const notesWeek = allNotes.filter(n => { const d = parseAnyDate(n.date); return d && d >= weekAgo; }).length;
    const consentPending = membersDB.filter(m => ['To Obtain Consent', 'Re-consent Required'].includes(m.consentStatus)).length;

    return {
        summary: `Here's your <strong>activity summary for this week</strong>.`,
        activityGrid: [
            { label: 'Tasks Due This Week', value: tasksDueWeek, sub: 'upcoming deadlines' },
            { label: 'Overdue Tasks', value: overdueTasks, sub: 'carry-over backlog' },
            { label: 'Notes This Week', value: notesWeek, sub: 'service notes logged' },
            { label: 'Consent Pending', value: consentPending, sub: 'members awaiting' },
            { label: 'High Risk Members', value: membersDB.filter(m => m.riskCategory === 'High').length, sub: 'need monitoring' },
            { label: 'Total Caseload', value: membersDB.length, sub: 'members assigned' }
        ],
        thinking: `Weekly summary from membersDB. Tasks due this week: ${tasksDueWeek}. Overdue: ${overdueTasks}. Notes this week: ${notesWeek}. Consent pending: ${consentPending}.`
    };
}

function qActivity7Days() { return qActivityWeek(); }

function qActivityConsent() {
    const allTasks = getAllTasks();
    const consentTasks = allTasks.filter(t => t.isConsent && t.status !== 'Closed');
    const consentMembers = membersDB.filter(m => ['To Obtain Consent', 'Re-consent Required'].includes(m.consentStatus));

    const toObtain = consentMembers.filter(m => m.consentStatus === 'To Obtain Consent').length;
    const reConsent = consentMembers.filter(m => m.consentStatus === 'Re-consent Required').length;

    return {
        summary: `<strong>Consent activity summary</strong>: ${consentMembers.length} members need consent action.`,
        activityGrid: [
            { label: 'To Obtain Consent', value: toObtain, sub: 'new enrollments' },
            { label: 'Re-consent Required', value: reConsent, sub: 'expiring/expired' },
            { label: 'Consent Tasks', value: consentTasks.length, sub: 'open tasks' },
            { label: 'Total Caseload', value: membersDB.length, sub: 'members' }
        ],
        table: consentMembers.length > 0 ? {
            columns: ['Member Name', 'Consent Status', 'Risk Level', 'Contact Attempts', 'Last Contact'],
            rows: consentMembers.map(m => {
                const attempts = m.consentDetails?.contactAttempts || 0;
                const notes = m.serviceNotes || [];
                const lastNote = notes.length > 0 ? notes[notes.length - 1] : null;
                return [
                    `<span class="td-name" onclick="handleMemberCardClick('${m.id}')">${m.name}</span>`,
                    badgeHTML(m.consentStatus, 'draft'),
                    badgeHTML(m.riskCategory || '', 'risk-' + (m.riskCategory || '').toLowerCase()),
                    attempts.toString(),
                    lastNote ? fmtDate(lastNote.date) : 'No contact'
                ];
            })
        } : undefined,
        thinking: `Queried membersDB for consent status  ["To Obtain Consent", "Re-consent Required"]. Found ${consentMembers.length}: ${toObtain} new consent, ${reConsent} re-consent. Also found ${consentTasks.length} open consent-related tasks.`,
        emptyMsg: 'All members have active consent!'
    };
}

// 
// NOTES  Additional Handlers
// 

function qNotesThisWeek() {
    const weekAgo = new Date(Date.now() - 7 * 86400000);
    const notes = getServiceNotes().filter(n => {
        const d = parseAnyDate(n.date);
        return d && d >= weekAgo;
    });
    return {
        summary: `<strong>${notes.length} service notes</strong> logged this week.`,
        count: notes.length, countLabel: 'notes this week',
        table: {
            columns: ['Date', 'Member', 'Activity', 'Type', 'Duration'],
            rows: notes.sort((a,b) => (parseAnyDate(b.date)||0) - (parseAnyDate(a.date)||0)).slice(0,15).map(n => [
                fmtDate(n.date),
                `<span class="td-member" onclick="handleMemberCardClick('${n.memberId}')">${n.memberName || ''}</span>`,
                n.activity || n.subject || '',
                n.type || '',
                n.duration || ''
            ])
        },
        thinking: `Filtered all service notes where date >= ${weekAgo.toLocaleDateString()}. Found ${notes.length} across ${membersDB.length} members.`,
        emptyMsg: 'No service notes logged this week.'
    };
}

function qNotesByType() {
    const notes = getServiceNotes();
    const byType = {};
    notes.forEach(n => {
        const t = n.type || n.activity || 'Other';
        byType[t] = (byType[t] || 0) + 1;
    });
    const sorted = Object.entries(byType).sort((a,b) => b[1] - a[1]);
    return {
        summary: `<strong>${notes.length} total service notes</strong> across ${Object.keys(byType).length} types.`,
        count: notes.length, countLabel: 'service notes',
        table: {
            columns: ['Note Type', 'Count', 'Percentage'],
            rows: sorted.map(([type, count]) => [
                `<span class="td-name">${type}</span>`,
                count.toString(),
                `${Math.round(count / notes.length * 100)}%`
            ])
        },
        thinking: `Aggregated all ${notes.length} service notes by type. Found ${Object.keys(byType).length} distinct types.`,
        emptyMsg: 'No service notes found.'
    };
}

function qMembersNoRecentNotes() {
    const sevenDaysAgo = new Date(Date.now() - 7 * 86400000);
    const members = membersDB.filter(m => {
        if (m.memberStatus === 'Inactive' || m.consentStatus === 'Declined') return false;
        const notes = m.serviceNotes || [];
        if (notes.length === 0) return true;
        const lastDate = parseAnyDate(notes[notes.length - 1].date);
        return !lastDate || lastDate < sevenDaysAgo;
    });
    return memberTableResult(members, 'active members without recent notes (7 days)',
        `Filtered active members where last service note > 7 days ago or no notes at all. Found ${members.length}.`);
}

function qNotesHighRisk() {
    const notes = getServiceNotes().filter(n => {
        const m = membersDB.find(mem => mem.id === n.memberId);
        return m && m.riskCategory === 'High';
    });
    return {
        summary: `<strong>${notes.length} service notes</strong> for high-risk members.`,
        count: notes.length, countLabel: 'high-risk member notes',
        table: {
            columns: ['Date', 'Member', 'Activity', 'Type', 'Status'],
            rows: notes.sort((a,b) => (parseAnyDate(b.date)||0) - (parseAnyDate(a.date)||0)).slice(0,15).map(n => [
                fmtDate(n.date),
                `<span class="td-member" onclick="handleMemberCardClick('${n.memberId}')">${n.memberName || ''}</span>`,
                n.activity || '',
                n.type || '',
                badgeHTML(n.status || '', (n.status || '').toLowerCase())
            ])
        },
        thinking: `Filtered service notes where member riskCategory = "High". Found ${notes.length}.`,
        emptyMsg: 'No service notes for high-risk members.'
    };
}

function qNoRecentNotesHR() {
    const sevenDaysAgo = new Date(Date.now() - 7 * 86400000);
    const members = membersDB.filter(m => {
        if (m.riskCategory !== 'High') return false;
        const notes = m.serviceNotes || [];
        if (notes.length === 0) return true;
        const lastDate = parseAnyDate(notes[notes.length - 1].date);
        return !lastDate || lastDate < sevenDaysAgo;
    });
    return memberTableResult(members, 'high-risk members without recent notes',
        `Filtered riskCategory = "High" members where last note > 7 days ago. Found ${members.length}.`);
}

function qNoRecentNotesConsent() {
    const sevenDaysAgo = new Date(Date.now() - 7 * 86400000);
    const members = membersDB.filter(m => {
        if (!['To Obtain Consent', 'Re-consent Required'].includes(m.consentStatus)) return false;
        const notes = m.serviceNotes || [];
        if (notes.length === 0) return true;
        const lastDate = parseAnyDate(notes[notes.length - 1].date);
        return !lastDate || lastDate < sevenDaysAgo;
    });
    return memberTableResult(members, 'consent-pending members without recent notes',
        `Filtered consent-pending members where last note > 7 days ago. Found ${members.length}.`);
}

// 
// DOCUMENTS  Additional Handlers
// 

function qConsentStatus() {
    const consented = membersDB.filter(m => m.consentStatus === 'Consented').length;
    const toObtain = membersDB.filter(m => m.consentStatus === 'To Obtain Consent').length;
    const declined = membersDB.filter(m => m.consentStatus === 'Declined').length;
    const reconsent = membersDB.filter(m => m.consentStatus === 'Re-consent Required').length;
    return {
        summary: `<strong>Consent status</strong> across your caseload of ${membersDB.length} members.`,
        activityGrid: [
            { label: 'Consented', value: consented, sub: `${Math.round(consented/membersDB.length*100)}% of caseload` },
            { label: 'To Obtain', value: toObtain, sub: 'awaiting first consent' },
            { label: 'Declined', value: declined, sub: 'opted out' },
            { label: 'Re-consent', value: reconsent, sub: 'needs renewal' }
        ],
        table: {
            columns: ['Member Name', 'Consent Status', 'Risk Level', 'Member Status'],
            rows: membersDB.sort((a,b) => {
                const order = {'To Obtain Consent':0,'Re-consent Required':1,'Declined':2,'Consented':3};
                return (order[a.consentStatus]||9) - (order[b.consentStatus]||9);
            }).map(m => [
                `<span class="td-name" onclick="handleMemberCardClick('${m.id}')">${m.name}</span>`,
                badgeHTML(m.consentStatus || '', m.consentStatus === 'Consented' ? 'posted' : (m.consentStatus === 'Declined' ? 'closed' : 'draft')),
                badgeHTML(m.riskCategory || '', 'risk-' + (m.riskCategory || '').toLowerCase()),
                m.memberStatus || ''
            ])
        },
        thinking: `Queried all ${membersDB.length} members. Consented: ${consented}, To Obtain: ${toObtain}, Declined: ${declined}, Re-consent: ${reconsent}.`,
    };
}

function qConsentPending() {
    const members = membersDB.filter(m => m.consentStatus === 'To Obtain Consent');
    return memberTableResult(members, 'members with consent pending',
        `Filtered for consentStatus = "To Obtain Consent". Found ${members.length}.`);
}

function qReconsentMembers() {
    const members = membersDB.filter(m => m.consentStatus === 'Re-consent Required');
    return memberTableResult(members, 'members needing re-consent',
        `Filtered for consentStatus = "Re-consent Required". Found ${members.length}.`);
}

function qMembersNeedAssessment() {
    const members = membersDB.filter(m =>
        m.journeyStage === 'CONSENTED_NO_ASSESSMENT' || m.journeyStage === 'ASSESSMENT_IN_PROGRESS'
    );
    return memberTableResult(members, 'members needing assessments',
        `Filtered for journey stages CONSENTED_NO_ASSESSMENT or ASSESSMENT_IN_PROGRESS. Found ${members.length}.`);
}

function qAssessmentHR() {
    const members = membersDB.filter(m =>
        (m.journeyStage === 'CONSENTED_NO_ASSESSMENT' || m.journeyStage === 'ASSESSMENT_IN_PROGRESS') &&
        m.riskCategory === 'High'
    );
    return memberTableResult(members, 'high-risk members needing assessments');
}

function qAssessmentOverdue() {
    const allTasks = getAllTasks();
    const tasks = allTasks.filter(t =>
        t.isOverdue && t.status !== 'Closed' &&
        ((t.type || '').toLowerCase().includes('assessment') || (t.title || '').toLowerCase().includes('assessment'))
    );
    return taskTableResult(tasks, 'overdue assessment tasks',
        `Filtered overdue tasks containing "assessment" in type or title. Found ${tasks.length}.`);
}

function qMembersNeedCarePlan() {
    const members = membersDB.filter(m =>
        m.journeyStage === 'ASSESSMENT_DONE_CP_BUILDING'
    );
    return memberTableResult(members, 'members needing care plans',
        `Filtered for journeyStage = "ASSESSMENT_DONE_CP_BUILDING". Found ${members.length}.`);
}

function qCarePlanHR() {
    const members = membersDB.filter(m =>
        m.journeyStage === 'ASSESSMENT_DONE_CP_BUILDING' && m.riskCategory === 'High'
    );
    return memberTableResult(members, 'high-risk members needing care plans');
}

// 
// ACTIVITY  Additional Handlers
// 

function qCaseloadOverview() {
    const byStage = {};
    membersDB.forEach(m => {
        const stage = m.journeyStage || 'Unknown';
        byStage[stage] = (byStage[stage] || 0) + 1;
    });
    const byRisk = {};
    membersDB.forEach(m => {
        const risk = m.riskCategory || 'Unknown';
        byRisk[risk] = (byRisk[risk] || 0) + 1;
    });
    const allTasks = getAllTasks();
    const openTasks = allTasks.filter(t => t.status !== 'Closed').length;
    const overdue = allTasks.filter(t => t.isOverdue && t.status !== 'Closed').length;

    return {
        summary: `<strong>Caseload overview</strong>: ${membersDB.length} members, ${openTasks} open tasks.`,
        activityGrid: [
            { label: 'Total Members', value: membersDB.length, sub: 'in caseload' },
            { label: 'Open Tasks', value: openTasks, sub: `${overdue} overdue` },
            { label: 'High Risk', value: byRisk['High'] || 0, sub: 'need close monitoring' },
            { label: 'Safety Concerns', value: membersDB.filter(m => m.safetyConcern?.hasConcern).length, sub: 'flagged members' },
            { label: 'Consent Pending', value: membersDB.filter(m => ['To Obtain Consent','Re-consent Required'].includes(m.consentStatus)).length, sub: 'action needed' },
            { label: 'Fully Active', value: membersDB.filter(m => m.journeyStage === 'FULLY_ACTIVE').length, sub: 'engaged members' }
        ],
        table: {
            columns: ['Journey Stage', 'Count', 'Percentage'],
            rows: Object.entries(byStage).sort((a,b) => b[1] - a[1]).map(([stage, count]) => [
                `<span class="td-name">${stage.replace(/_/g, ' ')}</span>`,
                count.toString(),
                `${Math.round(count / membersDB.length * 100)}%`
            ])
        },
        thinking: `Full caseload analysis: ${membersDB.length} members across ${Object.keys(byStage).length} journey stages. Risk breakdown: ${Object.entries(byRisk).map(([k,v])=>k+':'+v).join(', ')}. Tasks: ${openTasks} open, ${overdue} overdue.`,
    };
}

function qCaseloadByRisk() {
    const byRisk = {};
    membersDB.forEach(m => {
        const risk = m.riskCategory || 'Unknown';
        if (!byRisk[risk]) byRisk[risk] = [];
        byRisk[risk].push(m);
    });
    const rows = [];
    ['High','Medium','Low','Minimal','Unknown'].forEach(risk => {
        const members = byRisk[risk] || [];
        if (members.length === 0) return;
        const allTasks = getAllTasks();
        const openTasks = allTasks.filter(t => members.some(m => m.id === t.memberId) && t.status !== 'Closed').length;
        rows.push([
            badgeHTML(risk, 'risk-' + risk.toLowerCase()),
            members.length.toString(),
            `${Math.round(members.length / membersDB.length * 100)}%`,
            openTasks.toString()
        ]);
    });
    return {
        summary: `<strong>Caseload by risk level</strong>: ${membersDB.length} members.`,
        count: membersDB.length, countLabel: 'members',
        table: { columns: ['Risk Level', 'Members', 'Percentage', 'Open Tasks'], rows },
        thinking: `Grouped ${membersDB.length} members by riskCategory with task counts.`,
    };
}

function qCaseloadByStage() {
    const byStage = {};
    membersDB.forEach(m => {
        const stage = m.journeyStage || 'Unknown';
        if (!byStage[stage]) byStage[stage] = [];
        byStage[stage].push(m);
    });
    const rows = Object.entries(byStage).sort((a,b) => b[1].length - a[1].length).map(([stage, members]) => [
        `<span class="td-name">${stage.replace(/_/g, ' ')}</span>`,
        members.length.toString(),
        `${Math.round(members.length / membersDB.length * 100)}%`,
        members.filter(m => m.riskCategory === 'High').length.toString()
    ]);
    return {
        summary: `<strong>Caseload by journey stage</strong>: ${membersDB.length} members across ${Object.keys(byStage).length} stages.`,
        count: membersDB.length, countLabel: 'members',
        table: { columns: ['Journey Stage', 'Members', 'Percentage', 'High Risk'], rows },
        thinking: `Grouped ${membersDB.length} members by journeyStage. Found ${Object.keys(byStage).length} distinct stages.`,
    };
}

// 
// MEMBER CONTEXT HANDLERS  Dynamic, data-driven per-member queries
// 

// 
// SMART QUESTION #1: "What should I focus on in my next contact?"
// Cross-references ALL member data to build a prioritized call agenda
// 
function qNextContactFocus() {
    const m = window.currentMember;
    if (!m) return { summary: 'No member selected.', emptyMsg: 'Navigate to a member page.' };

    const agenda = [];
    const dd = m.dashboardData || {};
    const hh = m.healthHistory || {};
    const cpd = m.carePlanData || {};
    const safety = m.safetyConcern || {};
    const notes = m.serviceNotes || [];
    const lastNote = notes.length > 0 ? notes[notes.length - 1] : null;
    const daysSinceContact = lastNote ? Math.floor((Date.now() - (parseAnyDate(lastNote.date) || 0)) / 86400000) : 999;
    const tasks = (dd.tasks || []).concat(m.tasks || []);
    const openTasks = tasks.filter(t => t.status !== 'Closed');
    const overdueTasks = openTasks.filter(t => { const d = parseAnyDate(t.dueDate); return d && d < new Date(); });
    const adts = (dd.adts || []).concat(hh.adts || []);
    const unackedADTs = adts.filter(a => a.acknowledged === 'No');
    const assessAct = m.assessmentActivity || [];
    const assessLib = m.assessmentLibrary || [];
    const completedAssess = assessAct.filter(a => a.status === 'Completed');
    const inProgressAssess = assessAct.filter(a => a.status === 'In Progress');
    const completedTitles = completedAssess.map(a => a.title);
    const missingAssess = assessLib.filter(a => !completedTitles.includes(a.title));
    const needs = cpd.needs || [];
    const allGoals = needs.flatMap(n => (n.goals || []).map(g => ({ ...g, needArea: n.category })));
    const atRiskGoals = allGoals.filter(g => {
        const targetDate = parseAnyDate(g.targetDate);
        return (targetDate && targetDate < new Date() && g.status !== 'Completed' && g.status !== 'Met')
            || g.outcome === 'At Risk' || (g.status === 'Planned' && targetDate && targetDate < new Date());
    });
    const labs = hh.labs || [];
    const abnormalLabs = labs.filter(l => {
        if (!l.range || !l.result) return false;
        const parts = l.range.split('-').map(Number);
        const val = parseFloat(l.result);
        return parts.length === 2 && !isNaN(val) && (val < parts[0] || val > parts[1]);
    });
    const meds = hh.medications || [];
    const allergies = hh.allergies || [];
    const severeAllergies = allergies.filter(a => a.severity === 'Severe');
    const diagnoses = m.diagnoses || [];
    const living = m.livingArrangements || {};
    const enrollment = m.enrollment || [];
    const coverageEnd = enrollment.length > 0 ? enrollment[enrollment.length - 1] : null;
    const termDate = coverageEnd ? parseAnyDate(coverageEnd.endDate || coverageEnd.termDate) : null;
    const daysToTerm = termDate ? Math.floor((termDate - Date.now()) / 86400000) : 999;
    const pcpInfo = m.pcp || (dd.pcp) || {};
    const pcpLastVisit = pcpInfo.lastVisit ? parseAnyDate(pcpInfo.lastVisit) : null;
    const daysSincePCP = pcpLastVisit ? Math.floor((Date.now() - pcpLastVisit) / 86400000) : 999;

    //  PRIORITY 1: URGENT (safety, post-discharge) 

    if (safety.hasConcern) {
        agenda.push({
            level: 'urgent',
            topic: 'Address active safety concern',
            reason: `A safety flag is active: ${safety.details || safety.type || 'review needed'}. This takes priority over all other discussion topics.`,
            action: 'Assess current safety status, update safety plan, and determine if immediate intervention or referral is needed.'
        });
    }

    if (unackedADTs.length > 0) {
        const latest = unackedADTs[0];
        const adtDate = fmtDate(latest.date);
        agenda.push({
            level: 'urgent',
            topic: `Follow up on ${latest.type || 'hospital'} event (${adtDate})`,
            reason: `${unackedADTs.length} unacknowledged ADT event${unackedADTs.length > 1 ? 's' : ''}  ${latest.type || 'Admission'} at ${latest.facility || 'facility'}${latest.diagnosis ? ', Dx: ' + latest.diagnosis : ''}.`,
            action: 'Confirm discharge status, review discharge instructions, assess medication changes, and schedule PCP follow-up within 7 days.'
        });
    }

    //  PRIORITY 2: HIGH (consent, overdue tasks, stalled assessments) 

    if (['To Obtain Consent', 'Re-consent Required'].includes(m.consentStatus)) {
        agenda.push({
            level: 'high',
            topic: 'Obtain member consent',
            reason: `Consent status is "${m.consentStatus}"  care management services cannot fully proceed without consent.`,
            action: 'Explain care management benefits, address concerns, and document consent decision. If declined, document reason and schedule re-outreach in 30 days.'
        });
    }

    if (overdueTasks.length > 0) {
        const highPriOverdue = overdueTasks.filter(t => t.priority === 'High');
        const taskList = overdueTasks.slice(0, 3).map(t => t.name || t.type || 'Task').join(', ');
        agenda.push({
            level: 'high',
            topic: `Resolve ${overdueTasks.length} overdue task${overdueTasks.length > 1 ? 's' : ''}`,
            reason: `${highPriOverdue.length > 0 ? highPriOverdue.length + ' are high priority. ' : ''}Tasks: ${taskList}${overdueTasks.length > 3 ? ', and ' + (overdueTasks.length - 3) + ' more' : ''}.`,
            action: 'Review each overdue item, complete or reschedule, and update task status in the system.'
        });
    }

    if (inProgressAssess.length > 0) {
        const ip = inProgressAssess[0];
        agenda.push({
            level: 'high',
            topic: `Complete in-progress: ${ip.title || 'Assessment'}`,
            reason: `Started ${fmtDate(ip.date)} but not yet completed. ${inProgressAssess.length > 1 ? (inProgressAssess.length - 1) + ' other assessment(s) also in progress.' : ''}`,
            action: 'Continue assessment where left off. If member was unavailable, attempt to complete remaining sections.'
        });
    }

    //  PRIORITY 3: MEDIUM (care plan gaps, goal progress, labs, engagement) 

    if (completedAssess.length > 0 && needs.length === 0 && m.consentStatus === 'Consented') {
        agenda.push({
            level: 'medium',
            topic: 'Initiate care plan development',
            reason: `Assessment${completedAssess.length > 1 ? 's are' : ' is'} completed but no care plan has been created yet. This is the logical next step in the care management workflow.`,
            action: 'Review assessment findings, identify top 2-3 priority needs, and create initial care plan with member input on goals.'
        });
    }

    if (atRiskGoals.length > 0) {
        const goalNames = atRiskGoals.slice(0, 2).map(g => g.needArea || 'Goal').join(', ');
        agenda.push({
            level: 'medium',
            topic: `Review ${atRiskGoals.length} care plan goal${atRiskGoals.length > 1 ? 's' : ''} at risk`,
            reason: `Goal areas: ${goalNames}${atRiskGoals.length > 2 ? ' and ' + (atRiskGoals.length - 2) + ' more' : ''}. Target dates have passed or goals are flagged as at risk.`,
            action: 'Discuss barriers with member, adjust target dates if needed, and update interventions to better support goal achievement.'
        });
    }

    if (abnormalLabs.length > 0) {
        const labNames = abnormalLabs.slice(0, 3).map(l => l.test).join(', ');
        agenda.push({
            level: 'medium',
            topic: `Discuss ${abnormalLabs.length} abnormal lab result${abnormalLabs.length > 1 ? 's' : ''}`,
            reason: `Out-of-range: ${labNames}. ${abnormalLabs.some(l => l.test && (l.test.includes('A1c') || l.test.includes('Glucose'))) ? 'Includes metabolic markers  review diabetes management.' : 'Review with member and confirm PCP awareness.'}`,
            action: 'Ask if member has discussed results with PCP. If not, recommend scheduling a visit. Check medication adherence related to these results.'
        });
    }

    if (daysSinceContact > 30 && m.consentStatus === 'Consented') {
        agenda.push({
            level: 'medium',
            topic: `Re-engage  ${daysSinceContact} days since last contact`,
            reason: `Last contact was ${lastNote ? fmtDate(lastNote.date) : 'unknown'}. Members with gaps over 30 days are at higher risk of disengagement.`,
            action: 'Check in on member\'s wellbeing, ask about any changes since last contact, and confirm care management is still meeting their needs.'
        });
    }

    if (daysSincePCP > 90 && m.consentStatus === 'Consented') {
        agenda.push({
            level: 'medium',
            topic: `Encourage PCP visit  ${daysSincePCP} days overdue`,
            reason: `Last PCP visit: ${pcpLastVisit ? fmtDate(pcpLastVisit) : 'unknown'}. ${pcpInfo.name ? 'PCP: ' + pcpInfo.name + '.' : ''} Regular PCP contact helps prevent ER utilization.`,
            action: 'Ask if member has an upcoming PCP appointment. Offer to help schedule one if needed. Note any barriers to accessing care.'
        });
    }

    if (m.consentStatus === 'Consented' && completedAssess.length === 0 && inProgressAssess.length === 0) {
        agenda.push({
            level: 'medium',
            topic: 'Schedule initial assessment (HRA)',
            reason: `Member is consented but no assessments have been started. Health Risk Assessment should be completed within 30 days of consent.`,
            action: 'Schedule HRA appointment. If telephonic, confirm member has 30-45 minutes available. If home visit, confirm address and preferred time.'
        });
    }

    if (living.stable === false || living.stability === 'Unstable') {
        agenda.push({
            level: 'medium',
            topic: 'Check on housing stability',
            reason: `Housing is flagged as unstable: ${living.type || living.setting || 'details unknown'}. Unstable housing impacts medication adherence, follow-up attendance, and overall health outcomes.`,
            action: 'Ask about current living situation, whether it has changed, and if member needs referral to housing assistance or community resources.'
        });
    }

    //  PRIORITY 4: ROUTINE (check-ins, coverage, wellness) 

    if (daysToTerm > 0 && daysToTerm <= 60) {
        agenda.push({
            level: 'routine',
            topic: `Coverage ending in ${daysToTerm} days`,
            reason: `Insurance term date: ${fmtDate(coverageEnd.endDate || coverageEnd.termDate)}. Member may need help with re-enrollment or transition planning.`,
            action: 'Confirm member is aware of upcoming coverage end date. Assist with re-enrollment if eligible, or begin transition planning.'
        });
    }

    if (severeAllergies.length > 0 && meds.length > 0) {
        agenda.push({
            level: 'routine',
            topic: 'Verify medication safety',
            reason: `${severeAllergies.length} severe allergy/allergies on file (${severeAllergies.map(a => a.name).join(', ')}). Currently on ${meds.length} medications. Worth confirming no adverse reactions.`,
            action: 'Ask member about any new side effects or reactions. Confirm medication list is current and all prescribers are aware of allergies.'
        });
    }

    if (needs.length > 0 && atRiskGoals.length === 0 && agenda.length < 5) {
        const activeNeeds = needs.filter(n => n.status !== 'Closed' && n.status !== 'Met');
        if (activeNeeds.length > 0) {
            const needArea = activeNeeds[0].category || 'care plan';
            agenda.push({
                level: 'routine',
                topic: `Review progress on ${needArea} goals`,
                reason: `${activeNeeds.length} active need area${activeNeeds.length > 1 ? 's' : ''} in care plan. Regular progress check supports goal achievement.`,
                action: 'Review interventions and ask member about progress since last contact. Celebrate wins and identify any new barriers.'
            });
        }
    }

    if (missingAssess.length > 0 && completedAssess.length > 0 && agenda.length < 6) {
        agenda.push({
            level: 'routine',
            topic: `${missingAssess.length} additional screening${missingAssess.length > 1 ? 's' : ''} available`,
            reason: `Completed: ${completedAssess.length}. Not yet started: ${missingAssess.slice(0, 3).map(a => a.title).join(', ')}${missingAssess.length > 3 ? '...' : ''}.`,
            action: 'Determine if additional screenings are appropriate based on member\'s needs. Schedule if relevant to current care plan goals.'
        });
    }

    // Build output
    const levelOrder = { urgent: 0, high: 1, medium: 2, routine: 3 };
    agenda.sort((a, b) => levelOrder[a.level] - levelOrder[b.level]);
    const topItems = agenda.slice(0, 6);

    const urgentCount = topItems.filter(i => i.level === 'urgent').length;
    const highCount = topItems.filter(i => i.level === 'high').length;

    const levelBadge = { urgent: 'critical', high: 'draft', medium: 'open', routine: 'closed' };
    const levelLabel = { urgent: 'Urgent', high: 'High', medium: 'Medium', routine: 'Routine' };

    let priorityNote = '';
    if (urgentCount > 0) priorityNote = ` ${urgentCount} urgent  reach out today.`;
    else if (highCount > 0) priorityNote = `${highCount} high priority  schedule this week.`;
    else priorityNote = 'Routine check-in  no critical items.';

    const contactInfo = lastNote ? `${fmtDate(lastNote.date)} (${daysSinceContact}d ago)` : 'No record';
    const thinkText = `Built contact agenda for ${m.name}: analyzed safety(${safety.hasConcern?'YES':'no'}), ADTs(${unackedADTs.length} unacked), consent(${m.consentStatus}), tasks(${openTasks.length} open, ${overdueTasks.length} overdue), assessments(${completedAssess.length} done, ${inProgressAssess.length} in-progress, ${missingAssess.length} missing), care plan(${needs.length} needs, ${atRiskGoals.length} goals at risk), labs(${abnormalLabs.length} abnormal), contact gap(${daysSinceContact}d), PCP(${daysSincePCP}d since visit), housing(${living.stable===false?'unstable':'ok'}), coverage(${daysToTerm}d to term). Generated ${agenda.length} items, showing top ${topItems.length}.`;

    if (topItems.length === 0) {
        return {
            summary: `<strong>All clear</strong>  no specific focus items for ${m.name}.`,
            activityGrid: [
                { label: 'Last Contact', value: daysSinceContact < 999 ? daysSinceContact + 'd' : '', sub: lastNote ? fmtDate(lastNote.date) : 'No record' },
                { label: 'Consent', value: m.consentStatus === 'Consented' ? '' : '!', sub: m.consentStatus || '' },
                { label: 'Open Tasks', value: openTasks.length, sub: `${overdueTasks.length} overdue` },
                { label: 'Safety', value: safety.hasConcern ? '' : '', sub: safety.hasConcern ? 'Flag active' : 'Clear' },
            ],
            thinking: thinkText,
            emptyMsg: `No specific focus items for ${m.name}  general wellness check-in recommended.`
        };
    }

    // Build agenda cards
    let cardsHTML = '<div class="ai-agenda-list">';
    topItems.forEach((item, i) => {
        cardsHTML += `<div class="ai-agenda-card">
            <div class="ai-agenda-card-header">
                <span class="num">${i + 1}.</span>
                <span class="topic">${item.topic}</span>
                ${badgeHTML(levelLabel[item.level], levelBadge[item.level])}
            </div>
            <div class="reason">${item.reason}</div>
            <div class="action"> ${item.action}</div>
        </div>`;
    });
    cardsHTML += '</div>';

    return {
        summary: `<strong>Next contact agenda</strong> for ${m.name}  ${topItems.length} topic${topItems.length !== 1 ? 's' : ''} to cover. ${priorityNote}<br><span style="font-size:11px;color:#64748b">Last contact: ${contactInfo}</span>`,
        activityGrid: [
            { label: 'Last Contact', value: daysSinceContact < 999 ? daysSinceContact + 'd' : '', sub: lastNote ? fmtDate(lastNote.date) : 'No record' },
            { label: 'Consent', value: m.consentStatus === 'Consented' ? '' : '!', sub: m.consentStatus || '' },
            { label: 'Open Tasks', value: openTasks.length, sub: `${overdueTasks.length} overdue` },
            { label: 'Safety', value: safety.hasConcern ? '' : '', sub: safety.hasConcern ? 'Flag active' : 'Clear' },
        ],
        _cardsHTML: cardsHTML,
        thinking: thinkText,
        emptyMsg: `No specific focus items for ${m.name}  general wellness check-in recommended.`
    };
}

// 
// SMART QUESTION #2: "Draft a service note"
// Analyzes member context and generates a pre-filled service note draft
// 
function qDraftServiceNote() {
    const m = window.currentMember;
    if (!m) return { summary: 'No member selected.', emptyMsg: 'Navigate to a member page.' };

    // Analyze member to determine note context
    const draft = analyzeForNoteDraft(m);
    const nowDate = new Date();
    const dateStr = nowDate.toISOString().split('T')[0];
    const timeStr = nowDate.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit', hour12: true });

    let html = '<div class="ai-response-block">';
    html += `<div class="ai-appt-form" id="aiServiceNoteForm">

        <div class="form-title">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><polyline points="14,2 14,8 20,8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/></svg>
            Draft Service Note  ${m.name}
        </div>

        <div class="ai-smart-hint">
            <div class="hint-label">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2L13.09 8.26L18 6L14.74 10.91L21 12L14.74 13.09L18 18L13.09 15.74L12 22L10.91 15.74L6 18L9.26 13.09L3 12L9.26 10.91L6 6L10.91 8.26L12 2Z"/></svg>
                AI Draft
            </div>
            <div class="hint-text">${draft.reason}</div>
        </div>

        <div class="field-group">
            <label class="field-label">Contact Type <span class="req">*</span></label>
            <select id="snType">
                <option value="Phone Call - Outbound" ${draft.type === 'Phone Call - Outbound' ? 'selected' : ''}>Phone Call - Outbound</option>
                <option value="Phone Call - Inbound" ${draft.type === 'Phone Call - Inbound' ? 'selected' : ''}>Phone Call - Inbound</option>
                <option value="Home Visit" ${draft.type === 'Home Visit' ? 'selected' : ''}>Home Visit</option>
                <option value="Telehealth" ${draft.type === 'Telehealth' ? 'selected' : ''}>Telehealth</option>
                <option value="Email/Message" ${draft.type === 'Email/Message' ? 'selected' : ''}>Email/Message</option>
                <option value="Care Coordination" ${draft.type === 'Care Coordination' ? 'selected' : ''}>Care Coordination</option>
                <option value="Administrative" ${draft.type === 'Administrative' ? 'selected' : ''}>Administrative</option>
            </select>
        </div>

        <div class="field-group">
            <label class="field-label">Activity <span class="req">*</span></label>
            <input type="text" id="snActivity" value="${draft.activity}">
            <div class="form-error" id="snActivityError">Please enter an activity</div>
        </div>

        <div class="datetime-row">
            <div class="field-group">
                <label class="field-label">Date</label>
                <input type="date" id="snDate" value="${dateStr}">
            </div>
            <div class="field-group">
                <label class="field-label">Duration</label>
                <select id="snDuration">
                    <option value="5 min">5 min</option>
                    <option value="10 min" ${draft.duration === '10 min' ? 'selected' : ''}>10 min</option>
                    <option value="15 min" ${draft.duration === '15 min' ? 'selected' : ''}>15 min</option>
                    <option value="20 min" ${draft.duration === '20 min' ? 'selected' : ''}>20 min</option>
                    <option value="25 min" ${draft.duration === '25 min' ? 'selected' : ''}>25 min</option>
                    <option value="30 min" ${draft.duration === '30 min' ? 'selected' : ''}>30 min</option>
                    <option value="45 min" ${draft.duration === '45 min' ? 'selected' : ''}>45 min</option>
                    <option value="60 min" ${draft.duration === '60 min' ? 'selected' : ''}>60 min</option>
                </select>
            </div>
        </div>

        <div class="field-group">
            <label class="field-label">Note Summary <span class="req">*</span></label>
            <textarea id="snSummary" rows="5" style="min-height:90px">${draft.summary}</textarea>
            <div class="form-error" id="snSummaryError">Please enter a summary</div>
        </div>

        <div class="field-group">
            <label class="field-label">Outcome</label>
            <select id="snOutcome">
                ${draft.outcomes.map(o => `<option value="${o}" ${o === draft.selectedOutcome ? 'selected' : ''}>${o}</option>`).join('')}
            </select>
        </div>

        <hr class="form-divider">

        <div class="form-actions">
            <button class="btn-cancel-appt" onclick="resetAICopilot()">Cancel</button>
            <button class="btn-create-appt" id="snSubmitBtn" onclick="submitAIServiceNote()">
                <span id="snSubmitText">Save Draft</span>
            </button>
        </div>
    </div>`;
    html += '</div>';

    return { _customHTML: html };
}

function analyzeForNoteDraft(m) {
    const safety = m.safetyConcern || {};
    const dd = m.dashboardData || {};
    const hh = m.healthHistory || {};
    const adts = (dd.adts || []).concat(hh.adts || []);
    const unackedADTs = adts.filter(a => a.acknowledged === 'No');
    const notes = m.serviceNotes || [];
    const lastNote = notes.length > 0 ? notes[notes.length - 1] : null;
    const daysSinceContact = lastNote ? Math.floor((Date.now() - (parseAnyDate(lastNote.date) || 0)) / 86400000) : 999;
    const assessAct = m.assessmentActivity || [];
    const inProgress = assessAct.filter(a => a.status === 'In Progress');
    const completed = assessAct.filter(a => a.status === 'Completed');
    const cpd = m.carePlanData || {};
    const needs = cpd.needs || [];
    const allGoals = needs.flatMap(n => (n.goals || []).map(g => ({ ...g, needArea: n.category })));
    const meds = (hh.medications || []).map(med => med.name).join(', ');
    const dx = m.diagnoses || {};
    const dxList = [dx.primary, dx.secondary, dx.tertiary, dx.additional].filter(Boolean).map(d => (d.split(' - ')[1] || d));
    const dxShort = dxList.length > 0 ? dxList.join(', ') : 'no documented diagnoses';

    const generalOutcomes = ['Successful', 'Callback Requested', 'Left Voicemail', 'No Answer', 'Issue Resolved', 'Referred', 'Other'];

    // Safety concern
    if (safety.hasConcern) {
        return {
            type: 'Phone Call - Outbound', activity: 'Safety Follow-up',
            duration: '20 min',
            summary: `Called ${m.name} to follow up on active safety concern (${safety.details || safety.type || 'flagged concern'}). Assessed current safety status and reviewed safety plan.\n\nMember reports [status]. [Updated/Maintained] current safety plan. ${needs.length > 0 ? 'Reviewed care plan goals.' : ''}\n\nPlan: [Next steps for safety monitoring].`,
            outcomes: ['Safety Plan Updated', 'Safety Plan Maintained', 'Referred to Crisis', 'Left Voicemail', 'No Answer'],
            selectedOutcome: 'Safety Plan Updated',
            reason: `Safety concern is active  drafting a safety follow-up note.`
        };
    }

    // Post-discharge follow-up
    if (unackedADTs.length > 0) {
        const evt = unackedADTs[0];
        return {
            type: 'Phone Call - Outbound', activity: 'Post-Discharge Follow-up',
            duration: '25 min',
            summary: `Contacted ${m.name} regarding recent ${evt.type || 'hospital'} event at ${evt.facility || 'facility'} on ${fmtDate(evt.date)}${evt.diagnosis ? ' (Dx: ' + evt.diagnosis + ')' : ''}.\n\nReviewed discharge instructions with member. ${meds ? 'Confirmed current medications: ' + meds + '.' : ''} Assessed member\'s understanding of follow-up care.\n\nMember reports [current status]. Encouraged PCP follow-up within 7 days.\n\nPlan: [Follow-up actions].`,
            outcomes: ['Successful', 'PCP Appointment Scheduled', 'Callback Requested', 'Left Voicemail', 'No Answer'],
            selectedOutcome: 'Successful',
            reason: `Unacknowledged ${evt.type || 'ADT'} event on ${fmtDate(evt.date)}  drafting post-discharge follow-up note.`
        };
    }

    // Consent outreach
    if (['To Obtain Consent', 'Re-consent Required'].includes(m.consentStatus)) {
        const isReconsent = m.consentStatus === 'Re-consent Required';
        return {
            type: 'Phone Call - Outbound', activity: isReconsent ? 'Re-consent Outreach' : 'Outreach for Consent',
            duration: '15 min',
            summary: `Called ${m.name} to discuss ${isReconsent ? 'annual re-consent for' : 'enrollment in'} care management program.\n\nExplained program benefits including care coordination, health monitoring, and support services. ${isReconsent ? 'Reviewed services provided over the past year.' : ''}\n\nMember [agreed to participate / requested more information / declined at this time]. ${isReconsent ? '' : 'If consented: obtained verbal consent and documented.'}\n\nPlan: [Next steps].`,
            outcomes: ['Consent Obtained', 'Callback Requested', 'Left Voicemail', 'No Answer', 'Member Declined'],
            selectedOutcome: 'Consent Obtained',
            reason: `Consent status is "${m.consentStatus}"  drafting consent outreach note.`
        };
    }

    // In-progress assessment
    if (inProgress.length > 0) {
        const ip = inProgress[0];
        return {
            type: 'Phone Call - Outbound', activity: `${ip.title || 'Assessment'} - Continued`,
            duration: '35 min',
            summary: `Continued ${ip.title || 'assessment'} with ${m.name} (started ${fmtDate(ip.date)}).\n\nCompleted the following sections: [sections completed]. Member was cooperative and provided detailed responses.\n\n${dxList.length > 0 ? 'Current conditions discussed: ' + dxShort + '. ' : ''}${meds ? 'Reviewed medications: ' + meds + '.' : ''}\n\nAssessment status: [Completed / Remaining sections to complete].\n\nPlan: [Next steps].`,
            outcomes: ['Assessment Completed', 'Assessment In Progress', 'Callback Requested', 'No Answer'],
            selectedOutcome: 'Assessment In Progress',
            reason: `${ip.title || 'Assessment'} is in progress  drafting continuation note.`
        };
    }

    // No assessment started (but consented)
    if (m.consentStatus === 'Consented' && completed.length === 0 && inProgress.length === 0) {
        return {
            type: 'Phone Call - Outbound', activity: 'Initial Assessment',
            duration: '35 min',
            summary: `Conducted initial Health Risk Assessment with ${m.name}.\n\nReviewed medical history, current conditions (${dxShort}), and medications${meds ? ' (' + meds + ')' : ''}. Discussed social support systems, functional status, and health goals.\n\nMember identified the following priorities: [member priorities].\n\nPlan: [Complete remaining sections / Develop care plan].`,
            outcomes: ['Assessment Completed', 'Assessment Started', 'Callback Requested', 'No Answer'],
            selectedOutcome: 'Assessment Started',
            reason: `Member is consented with no assessments started  drafting initial assessment note.`
        };
    }

    // Care plan development (assessment done, no care plan)
    if (completed.length > 0 && needs.length === 0) {
        return {
            type: 'Phone Call - Outbound', activity: 'Care Plan Discussion',
            duration: '30 min',
            summary: `Discussed care plan development with ${m.name} based on completed assessment findings.\n\nIdentified priority health needs: [needs based on assessment]. Member expressed interest in addressing [member priorities].\n\nCurrent conditions: ${dxShort}. ${meds ? 'Medications: ' + meds + '.' : ''}\n\nEstablished initial care plan goals:\n1. [Goal 1]\n2. [Goal 2]\n\nPlan: Create formal care plan with interventions and target dates.`,
            outcomes: ['Goals Established', 'Callback Requested', 'Left Voicemail'],
            selectedOutcome: 'Goals Established',
            reason: `Assessment complete but no care plan  drafting care plan discussion note.`
        };
    }

    // Active care plan  routine check-in
    if (needs.length > 0) {
        const activeGoals = allGoals.filter(g => g.status !== 'Completed' && g.status !== 'Met').slice(0, 3);
        const goalText = activeGoals.length > 0 ? activeGoals.map(g => (g.needArea || 'Goal') + ': ' + (g.text || '').substring(0, 50)).join('; ') : 'active goals on file';
        return {
            type: 'Phone Call - Outbound', activity: 'Care Management Check-in',
            duration: '20 min',
            summary: `Monthly care management check-in with ${m.name}.\n\nReviewed care plan goals: ${goalText}.\n\nMember reports [status update]. ${meds ? 'Confirmed medication adherence (' + meds + ').' : ''}\n\nDiscussed barriers: [any barriers identified]. Member [is/is not] meeting current goals.\n\nPlan: Continue current interventions. Next contact in [timeframe].`,
            outcomes: ['Successful', 'Goals Updated', 'Callback Requested', 'Left Voicemail', 'No Answer'],
            selectedOutcome: 'Successful',
            reason: `Active care plan with ${needs.length} need area${needs.length > 1 ? 's' : ''}  drafting routine check-in note.`
        };
    }

    // Default  general contact
    return {
        type: 'Phone Call - Outbound', activity: 'Care Management Contact',
        duration: '15 min',
        summary: `Contacted ${m.name} for care management follow-up.\n\n${dxList.length > 0 ? 'Current conditions: ' + dxShort + '. ' : ''}${meds ? 'Current medications: ' + meds + '. ' : ''}Member reports [current status].\n\nDiscussed: [topics covered].\n\nPlan: [Next steps].`,
        outcomes: generalOutcomes,
        selectedOutcome: 'Successful',
        reason: `General care management contact  drafting follow-up note.`
    };
}

function submitAIServiceNote() {
    const m = window.currentMember;
    if (!m) return;

    // Validate
    const activity = document.getElementById('snActivity')?.value.trim();
    const summary = document.getElementById('snSummary')?.value.trim();
    let valid = true;

    if (!activity) {
        document.getElementById('snActivityError')?.classList.add('show');
        valid = false;
    } else {
        document.getElementById('snActivityError')?.classList.remove('show');
    }
    if (!summary) {
        document.getElementById('snSummaryError')?.classList.add('show');
        valid = false;
    } else {
        document.getElementById('snSummaryError')?.classList.remove('show');
    }
    if (!valid) return;

    // Gather fields
    const type = document.getElementById('snType')?.value || 'Phone Call - Outbound';
    const date = document.getElementById('snDate')?.value || new Date().toISOString().split('T')[0];
    const duration = document.getElementById('snDuration')?.value || '15 min';
    const outcome = document.getElementById('snOutcome')?.value || 'Successful';
    const now = new Date();
    const timeStr = now.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit', hour12: true });

    // Create note object
    const note = {
        id: `SN-${m.id}-AI-${Date.now()}`,
        date: date,
        time: timeStr,
        type: type,
        activity: activity,
        duration: duration,
        status: 'Draft',
        author: m.careManager || 'Care Manager',
        supervisor: 'Sarah Mitchell',
        summary: summary,
        outcome: outcome
    };

    // Add to member's service notes
    if (!m.serviceNotes) m.serviceNotes = [];
    m.serviceNotes.push(note);

    // Show confirmation
    const form = document.getElementById('aiServiceNoteForm');
    if (form) {
        form.innerHTML = `
            <div class="ai-appt-confirm">
                <div class="confirm-icon"></div>
                <div class="confirm-title">Service Note Saved</div>
                <div class="confirm-detail">
                    <strong>${activity}</strong><br>
                    ${type}<br><br>
                     ${fmtDate(date)} at ${timeStr}<br>
                     ${duration}<br>
                     ${outcome}<br>
                     ${m.name}<br>
                     Status: Draft
                </div>
            </div>
            <div class="ai-back-row" style="margin-top:16px;">
                <button class="ai-back-btn" onclick="resetAICopilot()"> Back to questions</button>
            </div>`;
    }

    // Refresh dashboard service notes widget
    refreshServiceNotesWidget(m);

    // Refresh dashboard activity widget if visible
    if (typeof MemberActivityManager !== 'undefined') {
        MemberActivityManager.renderCard(m.id);
    }
}

function qPreVisitSummary() {
    const m = window.currentMember;
    if (!m) return { summary: 'No member selected.', emptyMsg: 'Navigate to a member to generate a pre-visit summary.' };

    const hh = m.healthHistory || {};
    const dd = m.dashboardData || {};
    const dx = m.diagnoses || {};
    const notes = m.serviceNotes || [];
    const tasks = (dd.tasks || []).concat(m.tasks || []);
    const openTasks = tasks.filter(t => t.status !== 'Closed');
    const meds = hh.medications || [];
    const allergies = hh.allergies || [];
    const immunizations = hh.immunizations || [];
    const labs = hh.labs || [];
    const vitals = hh.coreHealth || [];
    const adts = (hh.adts || []).concat(dd.adts || []);
    const lastNote = notes.length > 0 ? notes[notes.length - 1] : null;

    // Build diagnoses list
    const dxList = [];
    if (dx.primary) dxList.push(dx.primary);
    if (dx.secondary) dxList.push(dx.secondary);
    if (dx.tertiary) dxList.push(dx.tertiary);
    if (dx.additional) dxList.push(dx.additional);

    // Build narrative summary
    let narrative = `This is a <strong>${m.age}-year-old ${m.gender?.toLowerCase() || 'patient'}</strong>`;
    if (dxList.length > 0) {
        narrative += ` with ${dxList.map(d => d.split(' - ')[1] || d).join(', ')}`;
    }
    narrative += '.';

    if (m.consentStatus) narrative += ` Consent status: <strong>${m.consentStatus}</strong>.`;
    if (m.riskCategory) narrative += ` Risk: <strong>${m.riskCategory}</strong>.`;

    if (meds.length > 0) {
        narrative += ` Currently taking ${meds.map(med => med.name).join(', ')}.`;
    }
    if (lastNote) {
        narrative += ` Last service note on ${fmtDate(lastNote.date)}: "${lastNote.summary || lastNote.activity || 'Contact logged'}".`;
    }
    if (adts.length > 0) {
        const recentADT = adts[0];
        narrative += ` Recent ADT event: ${recentADT.type} at ${recentADT.facility} on ${fmtDate(recentADT.date)}.`;
    }

    // Build the response
    let html = '<div class="ai-response-block">';
    html += `<div class="ai-response-summary" style="font-size:13px;line-height:1.6">${narrative}</div>`;

    // Patient Details section
    html += '<div style="margin-top:14px"><div style="font-weight:600;font-size:12px;color:#475569;text-transform:uppercase;letter-spacing:0.3px;margin-bottom:8px">Patient Details</div>';
    html += '<div class="ai-data-table-wrap"><table class="ai-data-table"><tbody>';
    html += `<tr><td style="font-weight:500;width:140px">Name</td><td>${m.name}</td></tr>`;
    html += `<tr><td style="font-weight:500">DOB</td><td>${fmtDate(m.dob)} (Age ${m.age})</td></tr>`;
    html += `<tr><td style="font-weight:500">Gender</td><td>${m.gender || 'N/A'}</td></tr>`;
    html += `<tr><td style="font-weight:500">Risk Acuity</td><td>${badgeHTML(m.riskCategory || 'N/A', 'risk-' + (m.riskCategory || '').toLowerCase())}</td></tr>`;
    html += `<tr><td style="font-weight:500">Consent Status</td><td>${badgeHTML(m.consentStatus || 'N/A', m.consentStatus === 'Consented' ? 'posted' : 'draft')}</td></tr>`;
    html += `<tr><td style="font-weight:500">Care Manager</td><td>${m.careManager || 'N/A'}</td></tr>`;
    html += `<tr><td style="font-weight:500">MRN</td><td>${m.mrn || 'N/A'}</td></tr>`;
    html += `<tr><td style="font-weight:500">MCO</td><td>${m.mco || 'N/A'}</td></tr>`;
    html += '</tbody></table></div></div>';

    // Diagnoses
    if (dxList.length > 0) {
        html += '<div style="margin-top:14px"><div style="font-weight:600;font-size:12px;color:#475569;text-transform:uppercase;letter-spacing:0.3px;margin-bottom:8px">Current Diagnoses</div>';
        html += '<div class="ai-data-table-wrap"><table class="ai-data-table"><thead><tr><th>Code</th><th>Description</th><th>Type</th></tr></thead><tbody>';
        dxList.forEach((d, i) => {
            const parts = d.split(' - ');
            html += `<tr><td>${parts[0] || ''}</td><td>${parts.slice(1).join(' - ') || d}</td><td>${i === 0 ? 'Primary' : 'Secondary'}</td></tr>`;
        });
        html += '</tbody></table></div></div>';
    }

    // ADTs / ED Visits
    if (adts.length > 0) {
        html += '<div style="margin-top:14px"><div style="font-weight:600;font-size:12px;color:#475569;text-transform:uppercase;letter-spacing:0.3px;margin-bottom:8px">ED Visits / Hospitalizations</div>';
        html += '<div class="ai-data-table-wrap"><table class="ai-data-table"><thead><tr><th>Date</th><th>Type</th><th>Facility</th><th>Diagnosis</th></tr></thead><tbody>';
        adts.forEach(a => {
            html += `<tr><td>${fmtDate(a.date)}</td><td>${a.type || ''}</td><td>${a.facility || ''}</td><td>${a.diagnosis || ''}</td></tr>`;
        });
        html += '</tbody></table></div></div>';
    }

    // Medications
    html += '<div style="margin-top:14px"><div style="font-weight:600;font-size:12px;color:#475569;text-transform:uppercase;letter-spacing:0.3px;margin-bottom:8px">Medications</div>';
    if (meds.length > 0) {
        html += '<div class="ai-data-table-wrap"><table class="ai-data-table"><thead><tr><th>Medication</th><th>Dose</th><th>Frequency</th><th>Last Filled</th></tr></thead><tbody>';
        meds.forEach(med => {
            html += `<tr><td><strong>${med.name}</strong></td><td>${med.dose || ''}</td><td>${med.freq || ''}</td><td>${fmtDate(med.filled)}</td></tr>`;
        });
        html += '</tbody></table></div>';
    } else {
        html += '<div style="color:#94a3b8;font-size:12px;padding:8px 0">No medications on file.</div>';
    }
    html += '</div>';

    // Allergies
    html += '<div style="margin-top:14px"><div style="font-weight:600;font-size:12px;color:#475569;text-transform:uppercase;letter-spacing:0.3px;margin-bottom:8px">Allergies</div>';
    if (allergies.length > 0) {
        html += '<div class="ai-data-table-wrap"><table class="ai-data-table"><thead><tr><th>Allergen</th><th>Reaction</th><th>Severity</th></tr></thead><tbody>';
        allergies.forEach(a => {
            html += `<tr><td>${a.name}</td><td>${a.reaction || ''}</td><td>${a.severity || ''}</td></tr>`;
        });
        html += '</tbody></table></div>';
    } else {
        html += '<div style="color:#94a3b8;font-size:12px;padding:8px 0">No known allergies.</div>';
    }
    html += '</div>';

    // Labs
    if (labs.length > 0) {
        html += '<div style="margin-top:14px"><div style="font-weight:600;font-size:12px;color:#475569;text-transform:uppercase;letter-spacing:0.3px;margin-bottom:8px">Recent Labs</div>';
        html += '<div class="ai-data-table-wrap"><table class="ai-data-table"><thead><tr><th>Test</th><th>Result</th><th>Range</th><th>Date</th></tr></thead><tbody>';
        labs.forEach(l => {
            html += `<tr><td>${l.test}</td><td>${l.result}</td><td>${l.range || ''}</td><td>${fmtDate(l.date)}</td></tr>`;
        });
        html += '</tbody></table></div></div>';
    }

    // Vitals
    if (vitals.length > 0) {
        const latest = vitals[0];
        html += '<div style="margin-top:14px"><div style="font-weight:600;font-size:12px;color:#475569;text-transform:uppercase;letter-spacing:0.3px;margin-bottom:8px">Latest Vitals</div>';
        html += '<div class="ai-activity-grid">';
        html += `<div class="ai-activity-card"><div class="label">Blood Pressure</div><div class="value">${latest.bp || ''}</div><div class="sub">${fmtDate(latest.date)}</div></div>`;
        html += `<div class="ai-activity-card"><div class="label">BMI</div><div class="value">${latest.bmi || ''}</div><div class="sub">${latest.weight || ''}</div></div>`;
        html += `<div class="ai-activity-card"><div class="label">Pulse</div><div class="value">${latest.pulse || ''}</div><div class="sub">bpm</div></div>`;
        html += '</div></div>';
    }

    // Immunizations
    if (immunizations.length > 0) {
        html += '<div style="margin-top:14px"><div style="font-weight:600;font-size:12px;color:#475569;text-transform:uppercase;letter-spacing:0.3px;margin-bottom:8px">Immunizations</div>';
        html += '<div class="ai-data-table-wrap"><table class="ai-data-table"><thead><tr><th>Vaccine</th><th>Date</th><th>Status</th></tr></thead><tbody>';
        immunizations.forEach(imm => {
            html += `<tr><td>${imm.name}</td><td>${fmtDate(imm.date)}</td><td>${badgeHTML(imm.status || '', imm.status === 'Completed' ? 'posted' : 'draft')}</td></tr>`;
        });
        html += '</tbody></table></div></div>';
    }

    // Open Tasks / Recommendations
    if (openTasks.length > 0) {
        html += '<div style="margin-top:14px"><div style="font-weight:600;font-size:12px;color:#475569;text-transform:uppercase;letter-spacing:0.3px;margin-bottom:8px">Recommendations & Next Steps</div>';
        html += '<div class="ai-data-table-wrap"><table class="ai-data-table"><thead><tr><th>Task</th><th>Priority</th><th>Due Date</th><th>Status</th></tr></thead><tbody>';
        openTasks.forEach(t => {
            html += `<tr><td>${t.title || t.name || ''}</td><td>${badgeHTML(t.priority || '', (t.priority || '').toLowerCase())}</td><td>${fmtDate(t.dueDate)}</td><td>${badgeHTML(t.status || '', (t.status || '').toLowerCase())}</td></tr>`;
        });
        html += '</tbody></table></div></div>';
    }

    // Safety Concern
    if (m.safetyConcern?.hasConcern) {
        html += `<div style="margin-top:14px;padding:10px 12px;background:#fef2f2;border:1px solid #fecaca;border-radius:8px">
            <div style="font-weight:600;color:#dc2626;font-size:12px;margin-bottom:4px"> Safety Concern</div>
            <div style="font-size:12px;color:#7f1d1d">${m.safetyConcern.type || 'Active safety concern flagged'}: ${m.safetyConcern.details || 'Review member record for details.'}</div>
        </div>`;
    }

    // Thinking
    const tid = 'think_' + Math.random().toString(36).substr(2, 6);
    html += `<div class="ai-show-thinking">
        <button class="ai-show-thinking-toggle" onclick="toggleThinking('${tid}', this)">
            <span class="arrow"></span> Show thinking
        </button>
        <div class="ai-thinking-content" id="${tid}">Generated pre-visit summary for ${m.name} (${m.id}). Data sources: diagnoses (${dxList.length}), medications (${meds.length}), allergies (${allergies.length}), labs (${labs.length}), vitals (${vitals.length}), ADTs (${adts.length}), immunizations (${immunizations.length}), open tasks (${openTasks.length}), service notes (${notes.length}). All data pulled from member object in membersDB.</div>
    </div>`;

    // Feedback
    html += `<div class="ai-feedback-row">
        <button class="ai-feedback-btn" onclick="this.style.color='#2d2d52'" title="Helpful">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 9V5a3 3 0 00-3-3l-4 9v11h11.28a2 2 0 002-1.7l1.38-9a2 2 0 00-2-2.3H14z"/></svg>
        </button>
        <button class="ai-feedback-btn" onclick="this.style.color='#ef4444'" title="Not helpful">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M10 15v4a3 3 0 003 3l4-9V2H5.72a2 2 0 00-2 1.7l-1.38 9a2 2 0 002 2.3H10z"/></svg>
        </button>
    </div>`;

    html += '<div class="ai-back-row"><button class="ai-back-btn" onclick="resetAICopilot()"> Back to questions</button></div>';
    html += '</div>';

    // Return as custom render (not standard table result)
    return { _customHTML: html };
}

// 
// COMMON MEMBER HANDLERS (4)
// 

function qMemberAttention() {
    const m = window.currentMember;
    if (!m) return { summary: 'No member selected.', emptyMsg: 'Navigate to a member page.' };
    const dd = m.dashboardData || {};
    const tasks = (dd.tasks || []).concat(m.tasks || []);
    const openTasks = tasks.filter(t => t.status !== 'Closed');
    const overdue = openTasks.filter(t => { const d = parseAnyDate(t.dueDate); return d && d < new Date(); });
    const hpTasks = openTasks.filter(t => t.priority === 'High');
    const adts = (dd.adts || []).concat((m.healthHistory || {}).adts || []);
    const unackedADTs = adts.filter(a => a.acknowledged === 'No');
    const safety = m.safetyConcern || {};
    const needsConsent = ['To Obtain Consent','Re-consent Required'].includes(m.consentStatus);
    const cpd = m.carePlanData || {};
    const missingCP = (cpd.needs || []).length === 0 && ['ASSESSMENT_DONE_CP_BUILDING','FULLY_ACTIVE'].includes(m.journeyStage);
    const assessAct = m.assessmentActivity || [];
    const assessLib = m.assessmentLibrary || [];
    const completedIds = assessAct.filter(a => a.status === 'Completed').map(a => a.title);
    const missingAssess = assessLib.filter(a => !completedIds.includes(a.title));

    const alerts = [];
    if (safety.hasConcern) alerts.push({ priority: 1, text: ` Safety concern: ${safety.details || safety.type || 'Active flag'}`, badge: 'critical' });
    if (unackedADTs.length > 0) alerts.push({ priority: 2, text: `${unackedADTs.length} unacknowledged ADT event${unackedADTs.length>1?'s':''}`, badge: 'overdue' });
    if (overdue.length > 0) alerts.push({ priority: 3, text: `${overdue.length} overdue task${overdue.length>1?'s':''} need action`, badge: 'overdue' });
    if (needsConsent) alerts.push({ priority: 4, text: `Consent status: ${m.consentStatus}`, badge: 'draft' });
    if (missingCP) alerts.push({ priority: 5, text: 'Care plan not yet created  assessment done', badge: 'draft' });
    if (hpTasks.length > 0) alerts.push({ priority: 6, text: `${hpTasks.length} high priority task${hpTasks.length>1?'s':''} open`, badge: 'open' });
    if (missingAssess.length > 3) alerts.push({ priority: 7, text: `${missingAssess.length} screenings not yet completed`, badge: 'draft' });

    alerts.sort((a,b) => a.priority - b.priority);

    return {
        summary: alerts.length > 0
            ? `<strong>${alerts.length} items need attention</strong> for ${m.name}.`
            : `<strong>All clear</strong>  no urgent items for ${m.name}.`,
        count: alerts.length, countLabel: 'attention items',
        table: alerts.length > 0 ? {
            columns: ['Priority', 'Item', 'Status'],
            rows: alerts.map((a, i) => [
                badgeHTML(`#${i + 1}`, i < 2 ? 'critical' : (i < 4 ? 'overdue' : 'draft')),
                a.text,
                badgeHTML(a.badge === 'critical' ? 'Urgent' : (a.badge === 'overdue' ? 'Overdue' : 'Action Needed'), a.badge)
            ])
        } : undefined,
        activityGrid: [
            { label: 'Open Tasks', value: openTasks.length, sub: `${overdue.length} overdue` },
            { label: 'ADT Events', value: adts.length, sub: `${unackedADTs.length} unacked` },
            { label: 'Safety', value: safety.hasConcern ? ' Flag' : ' Clear', sub: safety.hasConcern ? 'Review needed' : 'No concerns' },
            { label: 'Consent', value: m.consentStatus === 'Consented' ? '' : '!', sub: m.consentStatus || '' },
        ],
        thinking: `Scanned all data for ${m.name}: ${openTasks.length} open tasks (${overdue.length} overdue, ${hpTasks.length} high priority), ${adts.length} ADTs (${unackedADTs.length} unacked), safety: ${safety.hasConcern?'YES':'no'}, consent: ${m.consentStatus}, care plan needs: ${(cpd.needs||[]).length}, assessments done: ${completedIds.length}/${assessLib.length}. Generated ${alerts.length} attention items.`,
        emptyMsg: `No urgent items for ${m.name}  everything looks good!`
    };
}

function qMemberRecentUpdates() {
    const m = window.currentMember;
    if (!m) return { summary: 'No member selected.', emptyMsg: 'Navigate to a member page.' };
    const updates = [];

    // Assessment updates
    (m.assessmentActivity || []).forEach(a => {
        updates.push({ date: a.date, type: 'Assessment', detail: `${a.title}  ${a.status}${a.score && a.score !== '-' ? ' (Score: '+a.score+')' : ''}`, by: a.user });
    });
    // Care plan activity
    (m.carePlanData?.activity || []).forEach(a => {
        updates.push({ date: a.date, type: 'Care Plan', detail: `${a.name}  ${a.status}`, by: a.updatedBy });
    });
    // Care plan needs/goals/interventions
    (m.carePlanData?.needs || []).forEach(n => {
        updates.push({ date: n.startDate, type: 'Need Added', detail: `${n.category}: ${n.text.substring(0, 60)}...`, by: '' });
        (n.goals || []).forEach(g => {
            updates.push({ date: g.startDate, type: 'Goal Added', detail: `${g.text.substring(0, 60)}...  ${g.status}`, by: '' });
            (g.interventions || []).forEach(iv => {
                updates.push({ date: iv.dueDate, type: 'Intervention', detail: `${iv.text.substring(0, 60)}...  ${iv.status}`, by: iv.owner });
            });
        });
    });
    // Service notes (recent 5)
    (m.serviceNotes || []).slice(-5).forEach(n => {
        updates.push({ date: n.date, type: 'Service Note', detail: `${n.activity || n.type || 'Contact'}${n.duration ? ' ('+n.duration+')' : ''}`, by: n.author });
    });
    // Activity log
    (m.activityLog || []).slice(-5).forEach(l => {
        updates.push({ date: l.date, type: 'Activity', detail: l.action || l.details || '', by: l.user });
    });
    // ADT events
    ((m.dashboardData?.adts || []).concat((m.healthHistory || {}).adts || [])).forEach(a => {
        updates.push({ date: a.date, type: 'ADT Event', detail: `${a.type || ''} at ${a.facility || ''}`, by: '' });
    });
    // Sort by date descending
    updates.sort((a,b) => (parseAnyDate(b.date) || 0) - (parseAnyDate(a.date) || 0));

    return {
        summary: `<strong>${updates.length} recent updates</strong> for ${m.name}.`,
        count: updates.length, countLabel: 'updates & changes',
        table: {
            columns: ['Date', 'Type', 'Detail', 'By'],
            rows: updates.slice(0, 20).map(u => [
                fmtDate(u.date),
                badgeHTML(u.type, u.type.includes('ADT') ? 'overdue' : (u.type.includes('Care Plan') || u.type.includes('Goal') || u.type.includes('Intervention') || u.type.includes('Need') ? 'draft' : 'posted')),
                u.detail,
                u.by || ''
            ])
        },
        thinking: `Compiled all updates across assessments (${(m.assessmentActivity||[]).length}), care plan activity (${(m.carePlanData?.activity||[]).length}), needs (${(m.carePlanData?.needs||[]).length}), notes (${(m.serviceNotes||[]).length}), activity log (${(m.activityLog||[]).length}), ADTs. Total: ${updates.length}. Sorted reverse chronological.`,
        emptyMsg: 'No recent updates found for this member.'
    };
}

function qMemberOpenTasks() {
    const m = window.currentMember;
    if (!m) return { summary: 'No member selected.', emptyMsg: 'Navigate to a member page.' };
    const dd = m.dashboardData || {};
    const tasks = (dd.tasks || []).concat(m.tasks || []);
    const open = tasks.filter(t => t.status !== 'Closed');
    const today = new Date(); today.setHours(0,0,0,0);
    const overdue = open.filter(t => { const d = parseAnyDate(t.dueDate); return d && d < today; });
    const hp = open.filter(t => t.priority === 'High');

    return {
        summary: `<strong>${open.length} open tasks</strong> for ${m.name}. ${overdue.length} overdue, ${hp.length} high priority.`,
        count: open.length, countLabel: 'open tasks',
        activityGrid: [
            { label: 'Open', value: open.length, sub: 'total tasks' },
            { label: 'Overdue', value: overdue.length, sub: overdue.length > 0 ? 'need action' : 'all on track' },
            { label: 'High Priority', value: hp.length, sub: 'focus items' },
        ],
        table: open.length > 0 ? {
            columns: ['Task Name', 'Due Date', 'Priority', 'Status'],
            rows: open.sort((a,b) => {
                const po = {High:0,Medium:1,Low:2};
                return (po[a.priority]||2) - (po[b.priority]||2);
            }).map(t => [
                `<span class="td-name">${t.title || t.name || ''}</span>`,
                fmtDate(t.dueDate),
                badgeHTML(t.priority || '', (t.priority||'').toLowerCase()),
                badgeHTML(t.status || '', (t.status||'').toLowerCase().replace(/\s/g,'-'))
            ])
        } : undefined,
        thinking: `Queried all tasks for ${m.name} (${m.id}). Total: ${tasks.length}, Open: ${open.length}, Overdue: ${overdue.length}, High priority: ${hp.length}.`,
        emptyMsg: `No open tasks for ${m.name}  all caught up!`
    };
}

// 
// DASHBOARD TAB HANDLERS (4)
// 

function qMemberADTSummary() {
    const m = window.currentMember;
    if (!m) return { summary: 'No member selected.', emptyMsg: 'Navigate to a member page.' };
    const adts = ((m.dashboardData || {}).adts || []).concat((m.healthHistory || {}).adts || []);
    const unacked = adts.filter(a => a.acknowledged === 'No');
    return {
        summary: `<strong>${adts.length} ADT events</strong> for ${m.name}. ${unacked.length} unacknowledged.`,
        count: adts.length, countLabel: 'ADT events',
        table: adts.length > 0 ? {
            columns: ['Date', 'Type', 'Facility', 'Diagnosis', 'Acknowledged'],
            rows: adts.map(a => [
                fmtDate(a.date), a.type || '', a.facility || '', a.diagnosis || '',
                badgeHTML(a.acknowledged || '', a.acknowledged === 'No' ? 'overdue' : 'posted')
            ])
        } : undefined,
        thinking: `Pulled ADTs from dashboardData.adts and healthHistory.adts for ${m.id}. Total: ${adts.length}, Unacknowledged: ${unacked.length}.`,
        emptyMsg: `No ADT events on record for ${m.name}.`
    };
}

function qMemberCareGaps() {
    const m = window.currentMember;
    if (!m) return { summary: 'No member selected.', emptyMsg: 'Navigate to a member page.' };
    const gaps = [];
    const dd = m.dashboardData || {};
    const tasks = (dd.tasks || []).concat(m.tasks || []);
    const open = tasks.filter(t => t.status !== 'Closed');
    const cpd = m.carePlanData || {};
    const assessAct = m.assessmentActivity || [];
    const notes = m.serviceNotes || [];
    const lastNote = notes.length > 0 ? notes[notes.length - 1] : null;
    const daysSinceContact = lastNote ? Math.floor((Date.now() - (parseAnyDate(lastNote.date)||0)) / 86400000) : 999;

    if (['To Obtain Consent','Re-consent Required'].includes(m.consentStatus)) gaps.push({ area: 'Consent', detail: `Status: ${m.consentStatus}`, urgency: 'High' });
    if (assessAct.length === 0 && m.consentStatus === 'Consented') gaps.push({ area: 'Assessment', detail: 'No assessments started', urgency: 'High' });
    else if (assessAct.some(a => a.status === 'In Progress')) gaps.push({ area: 'Assessment', detail: 'Assessment in progress  needs completion', urgency: 'Medium' });
    if ((cpd.needs||[]).length === 0 && assessAct.some(a => a.status === 'Completed')) gaps.push({ area: 'Care Plan', detail: 'Assessment done but no care plan created', urgency: 'High' });
    if (daysSinceContact > 30) gaps.push({ area: 'Contact', detail: `${daysSinceContact} days since last contact`, urgency: daysSinceContact > 60 ? 'High' : 'Medium' });
    if (m.safetyConcern?.hasConcern) gaps.push({ area: 'Safety', detail: m.safetyConcern.details || 'Active safety concern', urgency: 'High' });
    (cpd.gaps || []).forEach(g => gaps.push({ area: g.measure || 'Clinical', detail: g.desc || g.status, urgency: 'Medium' }));
    const overdue = open.filter(t => { const d = parseAnyDate(t.dueDate); return d && d < new Date(); });
    if (overdue.length > 0) gaps.push({ area: 'Tasks', detail: `${overdue.length} overdue tasks`, urgency: 'High' });

    return {
        summary: gaps.length > 0
            ? `<strong>${gaps.length} care gaps</strong> identified for ${m.name}.`
            : `<strong>No care gaps</strong> found for ${m.name}.`,
        count: gaps.length, countLabel: 'care gaps',
        table: gaps.length > 0 ? {
            columns: ['Area', 'Gap Description', 'Urgency'],
            rows: gaps.sort((a,b) => {const p={High:0,Medium:1,Low:2}; return (p[a.urgency]||2)-(p[b.urgency]||2);}).map(g => [
                `<strong>${g.area}</strong>`, g.detail,
                badgeHTML(g.urgency, g.urgency === 'High' ? 'overdue' : (g.urgency === 'Medium' ? 'draft' : 'posted'))
            ])
        } : undefined,
        thinking: `Gap analysis for ${m.name}: consent (${m.consentStatus}), assessments (${assessAct.length}), care plan needs (${(cpd.needs||[]).length}), last contact (${daysSinceContact} days), safety (${m.safetyConcern?.hasConcern?'yes':'no'}), overdue tasks (${overdue.length}), clinical gaps (${(cpd.gaps||[]).length}). Total gaps: ${gaps.length}.`,
        emptyMsg: `No care gaps identified  ${m.name} is on track!`
    };
}

function qMemberRiskAcuity() {
    const m = window.currentMember;
    if (!m) return { summary: 'No member selected.', emptyMsg: 'Navigate to a member page.' };
    const ra = m.riskAcuity || {};
    const dx = m.diagnoses || {};
    const dxList = [dx.primary, dx.secondary, dx.tertiary, dx.additional].filter(Boolean);
    const history = ra.history || [];
    return {
        summary: `<strong>Risk acuity</strong> for ${m.name}: ${m.riskCategory || ''} (Tier ${ra.currentTier || m.riskTier || ''}, Score ${ra.riskScore || ''}).`,
        activityGrid: [
            { label: 'Risk Level', value: m.riskCategory || '', sub: `Tier ${ra.currentTier || m.riskTier || ''}` },
            { label: 'Risk Score', value: ra.riskScore || '', sub: 'current score' },
            { label: 'Diagnoses', value: dxList.length, sub: 'active conditions' },
            { label: 'Last Assessed', value: fmtDate(ra.lastAssessment), sub: '' },
        ],
        table: history.length > 0 ? {
            columns: ['Date', 'Tier', 'Score', 'Change'],
            rows: history.map((h, i) => {
                const prev = i > 0 ? history[i-1].score : null;
                const change = prev ? (h.score > prev ? ' +' + (h.score - prev) : (h.score < prev ? ' ' + (h.score - prev) : ' No change')) : '';
                return [fmtDate(h.date), `Tier ${h.tier}`, h.score.toString(), change];
            })
        } : undefined,
        thinking: `Risk data for ${m.name}: category=${m.riskCategory}, tier=${ra.currentTier}, score=${ra.riskScore}, lastAssessed=${ra.lastAssessment}. History entries: ${history.length}. Diagnoses: ${dxList.length}.`,
    };
}

function qMemberRecentNotes() {
    const m = window.currentMember;
    if (!m) return { summary: 'No member selected.', emptyMsg: 'Navigate to a member page.' };
    const notes = (m.serviceNotes || []).slice(-5).reverse();
    return {
        summary: `<strong>Last ${notes.length} service notes</strong> for ${m.name}.`,
        count: notes.length, countLabel: 'service notes',
        table: notes.length > 0 ? {
            columns: ['Date', 'Activity', 'Type', 'Duration', 'Author'],
            rows: notes.map(n => [fmtDate(n.date), n.activity || '', n.type || '', n.duration || '', n.author || ''])
        } : undefined,
        thinking: `Retrieved last 5 service notes for ${m.name}. Total notes: ${(m.serviceNotes||[]).length}.`,
        emptyMsg: `No service notes on record for ${m.name}.`
    };
}

// 
// MEMBER DETAILS TAB HANDLERS (3)
// 

function qMemberDemographics() {
    const m = window.currentMember;
    if (!m) return { summary: 'No member selected.', emptyMsg: 'Navigate to a member page.' };
    return {
        summary: `<strong>Demographics & contact</strong> for ${m.name}`,
        table: {
            columns: ['Field', 'Value'],
            rows: [
                ['Name', m.name], ['DOB', fmtDate(m.dob)], ['Age', m.age?.toString() || ''],
                ['Gender', m.gender || ''], ['Race', m.race || ''], ['Ethnicity', m.ethnicity || ''],
                ['Address', `${m.address || ''}, ${m.city || ''}, ${m.state || ''} ${m.zipCode || ''}`],
                ['County', m.county || ''], ['Cell Phone', m.cellPhone || ''], ['Home Phone', m.homePhone || ''],
                ['Email', m.email || ''], ['Preferred Language', m.communication?.preferredLanguage || ''],
                ['Preferred Contact', m.communication?.method || '']
            ]
        },
        thinking: `Extracted demographic and contact fields for ${m.name} (${m.id}).`
    };
}

function qMemberEnrollment() {
    const m = window.currentMember;
    if (!m) return { summary: 'No member selected.', emptyMsg: 'Navigate to a member page.' };
    const enrollment = m.enrollment || [];
    const spans = m.careSpans || [];
    const pop = m.populationData || {};
    return {
        summary: `<strong>Enrollment</strong> for ${m.name}: ${enrollment.length} plan${enrollment.length!==1?'s':''}, ${spans.length} care span${spans.length!==1?'s':''}.`,
        table: {
            columns: ['Type', 'Name', 'Start', 'End', 'Status'],
            rows: [
                ...enrollment.map(e => ['Enrollment', e.planName || e.insuranceCompany || '', fmtDate(e.startDate), fmtDate(e.endDate), e.status || '']),
                ...spans.map(s => ['Care Span', `${s.spanType || ''}  ${s.program || ''}`, fmtDate(s.startDate), fmtDate(s.endDate), s.status || '']),
                ...(pop.lob || []).map(l => ['LOB', l.name || '', fmtDate(l.effective), fmtDate(l.end), 'Active']),
                ...(pop.programs || []).map(p => ['Program', p.name || '', fmtDate(p.effective), fmtDate(p.end), 'Active']),
            ]
        },
        thinking: `Enrollment: ${enrollment.length} plans, ${spans.length} care spans, ${(pop.lob||[]).length} LOBs, ${(pop.programs||[]).length} programs for ${m.id}.`
    };
}

function qMemberCommPrefs() {
    const m = window.currentMember;
    if (!m) return { summary: 'No member selected.', emptyMsg: 'Navigate to a member page.' };
    const comm = m.communication || {};
    return {
        summary: `<strong>Communication preferences</strong> for ${m.name}`,
        table: {
            columns: ['Field', 'Value'],
            rows: [
                ['Preferred Language', comm.preferredLanguage || ''],
                ['Languages Spoken', (comm.languages || []).join(', ') || ''],
                ['Preferred Contact Method', comm.method || ''],
                ['Cell Phone', m.cellPhone || ''],
                ['Home Phone', m.homePhone || ''],
                ['Email', m.email || ''],
            ]
        },
        thinking: `Communication preferences for ${m.name}: language=${comm.preferredLanguage}, method=${comm.method}.`
    };
}

// 
// TIMELINE TAB HANDLERS (3)
// 

function qMemberMilestones() {
    const m = window.currentMember;
    if (!m) return { summary: 'No member selected.', emptyMsg: 'Navigate to a member page.' };
    const events = [];
    const ah = m.activityHistory || {};
    (ah.events || []).forEach(e => events.push({ date: e.start || e.deadline, milestone: e.name, status: e.status, by: e.owner }));
    (m.activityLog || []).filter(l => (l.action||'').match(/assign|consent|assess|care plan|enroll/i)).forEach(l => {
        events.push({ date: l.date, milestone: l.action || l.details, status: 'Done', by: l.user });
    });
    events.sort((a,b) => (parseAnyDate(a.date)||0) - (parseAnyDate(b.date)||0));
    return {
        summary: `<strong>${events.length} key milestones</strong> for ${m.name}'s care journey.`,
        count: events.length, countLabel: 'milestones',
        table: events.length > 0 ? {
            columns: ['Date', 'Milestone', 'Status', 'Owner'],
            rows: events.map(e => [fmtDate(e.date), e.milestone || '', typeof e.status === 'string' && e.status.includes('<') ? e.status : badgeHTML(e.status || '', 'posted'), e.by || ''])
        } : undefined,
        thinking: `Compiled milestones from activityHistory.events and activityLog for ${m.id}. Found ${events.length} key events.`,
        emptyMsg: `No milestones recorded for ${m.name} yet.`
    };
}

function qMemberSinceLastContact() {
    const m = window.currentMember;
    if (!m) return { summary: 'No member selected.', emptyMsg: 'Navigate to a member page.' };
    const notes = m.serviceNotes || [];
    const lastNote = notes.length > 0 ? notes[notes.length - 1] : null;
    const lastDate = lastNote ? parseAnyDate(lastNote.date) : null;
    const changes = [];
    // Everything that happened after last note
    (m.assessmentActivity || []).forEach(a => { const d = parseAnyDate(a.date); if (d && lastDate && d > lastDate) changes.push({ date: a.date, type: 'Assessment', detail: `${a.title}  ${a.status}` }); });
    (m.carePlanData?.activity || []).forEach(a => { const d = parseAnyDate(a.date); if (d && lastDate && d > lastDate) changes.push({ date: a.date, type: 'Care Plan', detail: `${a.name}  ${a.status}` }); });
    ((m.dashboardData?.adts||[]).concat((m.healthHistory||{}).adts||[])).forEach(a => { const d = parseAnyDate(a.date); if (d && lastDate && d > lastDate) changes.push({ date: a.date, type: 'ADT', detail: `${a.type} at ${a.facility}` }); });
    (m.activityLog || []).forEach(l => { const d = parseAnyDate(l.date); if (d && lastDate && d > lastDate) changes.push({ date: l.date, type: 'Activity', detail: l.action || l.details }); });
    changes.sort((a,b) => (parseAnyDate(b.date)||0) - (parseAnyDate(a.date)||0));
    const daysSince = lastDate ? Math.floor((Date.now() - lastDate) / 86400000) : null;
    return {
        summary: lastNote
            ? `<strong>Last contact: ${fmtDate(lastNote.date)}</strong> (${daysSince} days ago). ${changes.length} changes since then.`
            : `<strong>No prior contact</strong> recorded for ${m.name}.`,
        count: changes.length, countLabel: 'changes since last contact',
        table: changes.length > 0 ? {
            columns: ['Date', 'Type', 'Detail'],
            rows: changes.map(c => [fmtDate(c.date), badgeHTML(c.type, c.type==='ADT'?'overdue':'posted'), c.detail || ''])
        } : undefined,
        thinking: `Last contact: ${lastNote?fmtDate(lastNote.date):'none'}. Scanned assessments, care plan activity, ADTs, activity log for events after that date. Found ${changes.length} changes.`,
        emptyMsg: daysSince !== null ? `No changes since last contact ${daysSince} days ago.` : 'No contact history to compare against.'
    };
}

function qMemberEngagementGaps() {
    const m = window.currentMember;
    if (!m) return { summary: 'No member selected.', emptyMsg: 'Navigate to a member page.' };
    const notes = (m.serviceNotes || []).slice().sort((a,b) => (parseAnyDate(a.date)||0) - (parseAnyDate(b.date)||0));
    const gaps = [];
    for (let i = 1; i < notes.length; i++) {
        const prev = parseAnyDate(notes[i-1].date);
        const curr = parseAnyDate(notes[i].date);
        if (prev && curr) {
            const daysBetween = Math.floor((curr - prev) / 86400000);
            if (daysBetween > 14) gaps.push({ from: notes[i-1].date, to: notes[i].date, days: daysBetween });
        }
    }
    // Check gap from last note to today
    if (notes.length > 0) {
        const last = parseAnyDate(notes[notes.length-1].date);
        if (last) {
            const daysToNow = Math.floor((Date.now() - last) / 86400000);
            if (daysToNow > 14) gaps.push({ from: notes[notes.length-1].date, to: 'Today', days: daysToNow });
        }
    }
    return {
        summary: `<strong>${gaps.length} engagement gap${gaps.length!==1?'s':''}</strong> found (periods > 14 days without contact).`,
        count: gaps.length, countLabel: 'engagement gaps',
        table: gaps.length > 0 ? {
            columns: ['From', 'To', 'Days Gap', 'Severity'],
            rows: gaps.sort((a,b) => b.days - a.days).map(g => [
                fmtDate(g.from), g.to === 'Today' ? 'Today' : fmtDate(g.to), g.days.toString(),
                badgeHTML(g.days > 30 ? 'Critical' : 'Warning', g.days > 30 ? 'overdue' : 'draft')
            ])
        } : undefined,
        thinking: `Analyzed ${notes.length} service notes for ${m.name}. Found ${gaps.length} periods exceeding 14 days between contacts.`,
        emptyMsg: `No engagement gaps found  ${m.name} has consistent contact.`
    };
}

// 
// INSURANCE TAB HANDLERS (3)
// 

function qMemberCoveragePCP() {
    const m = window.currentMember;
    if (!m) return { summary: 'No member selected.', emptyMsg: 'Navigate to a member page.' };
    const ins = m.insurance || {};
    return {
        summary: `<strong>Coverage & PCP</strong> for ${m.name}`,
        activityGrid: [
            { label: 'MCO', value: ins.mco || '', sub: ins.planType || '' },
            { label: 'PCP', value: ins.pcpName || '', sub: ins.pcpPhone || '' },
            { label: 'Last PCP Visit', value: fmtDate(ins.pcpLastVisit), sub: '' },
            { label: 'County', value: ins.county || '', sub: '' },
        ],
        table: {
            columns: ['Field', 'Value'],
            rows: [
                ['Plan Name', ins.planName || ''], ['Member ID', ins.memberId || ''],
                ['Group #', ins.groupNumber || ''], ['Effective', fmtDate(ins.effectiveDate)],
                ['Term Date', fmtDate(ins.termDate)], ['PCP Name', ins.pcpName || ''],
                ['PCP Phone', ins.pcpPhone || ''], ['Last PCP Visit', fmtDate(ins.pcpLastVisit)]
            ]
        },
        thinking: `Insurance data for ${m.name}: MCO=${ins.mco}, PCP=${ins.pcpName}, lastVisit=${ins.pcpLastVisit}.`
    };
}

function qMemberEnrollHistory() {
    const m = window.currentMember;
    if (!m) return { summary: 'No member selected.', emptyMsg: 'Navigate to a member page.' };
    const enrollment = m.enrollment || [];
    const spans = m.careSpans || [];
    return {
        summary: `<strong>Enrollment & care spans</strong> for ${m.name}: ${enrollment.length} enrollment${enrollment.length!==1?'s':''}, ${spans.length} care span${spans.length!==1?'s':''}.`,
        table: {
            columns: ['Type', 'Plan/Program', 'Start', 'End', 'Status'],
            rows: [
                ...enrollment.map(e => ['Enrollment', e.planName || '', fmtDate(e.startDate), fmtDate(e.endDate), e.status || '']),
                ...spans.map(s => ['Care Span', `${s.program || s.spanType || ''}`, fmtDate(s.startDate), fmtDate(s.endDate), s.status || '']),
            ]
        },
        thinking: `Enrollment: ${enrollment.length} records, Care spans: ${spans.length} for ${m.id}.`
    };
}

function qMemberTermDate() {
    const m = window.currentMember;
    if (!m) return { summary: 'No member selected.', emptyMsg: 'Navigate to a member page.' };
    const ins = m.insurance || {};
    const termDate = parseAnyDate(ins.termDate);
    const daysUntil = termDate ? Math.floor((termDate - Date.now()) / 86400000) : null;
    return {
        summary: `<strong>Coverage term date</strong> for ${m.name}: ${fmtDate(ins.termDate)}${daysUntil !== null ? ' (' + (daysUntil > 0 ? daysUntil + ' days remaining' : 'EXPIRED') + ')' : ''}.`,
        activityGrid: [
            { label: 'Term Date', value: fmtDate(ins.termDate), sub: daysUntil !== null ? (daysUntil > 0 ? `${daysUntil} days left` : 'EXPIRED') : '' },
            { label: 'Effective Date', value: fmtDate(ins.effectiveDate), sub: '' },
            { label: 'Plan', value: ins.mco || '', sub: ins.planType || '' },
        ],
        thinking: `Coverage dates for ${m.name}: effective=${ins.effectiveDate}, term=${ins.termDate}. Days until term: ${daysUntil}.`
    };
}

// 
// SCREENINGS & ASSESSMENTS TAB HANDLERS (4)
// 

function qMemberAssessDue() {
    const m = window.currentMember;
    if (!m) return { summary: 'No member selected.', emptyMsg: 'Navigate to a member page.' };
    const tasks = ((m.dashboardData?.tasks||[]).concat(m.tasks||[])).filter(t => ((t.type||t.title||t.name||'').toLowerCase().includes('assessment')) && t.status !== 'Closed');
    const inProgress = (m.assessmentActivity || []).filter(a => a.status === 'In Progress');
    const combined = [...inProgress.map(a => ({ name: a.title, status: a.status, date: a.date, source: 'Assessment' })), ...tasks.map(t => ({ name: t.title||t.name, status: t.status, date: t.dueDate, source: 'Task' }))];
    return {
        summary: `<strong>${combined.length} assessments due or in progress</strong> for ${m.name}.`,
        count: combined.length, countLabel: 'assessments pending',
        table: combined.length > 0 ? {
            columns: ['Assessment', 'Status', 'Date', 'Source'],
            rows: combined.map(c => [c.name || '', badgeHTML(c.status || '', (c.status||'').toLowerCase().includes('progress') ? 'draft' : 'open'), fmtDate(c.date), c.source])
        } : undefined,
        thinking: `Checked assessment tasks and assessmentActivity for in-progress items. Tasks: ${tasks.length}, In-progress assessments: ${inProgress.length}.`,
        emptyMsg: `No assessments currently due for ${m.name}.`
    };
}

function qMemberAssessCompleted() {
    const m = window.currentMember;
    if (!m) return { summary: 'No member selected.', emptyMsg: 'Navigate to a member page.' };
    const completed = (m.assessmentActivity || []).filter(a => a.status === 'Completed');
    return {
        summary: `<strong>${completed.length} completed assessments</strong> for ${m.name}.`,
        count: completed.length, countLabel: 'completed',
        table: completed.length > 0 ? {
            columns: ['Assessment', 'Score', 'Date', 'Completed By'],
            rows: completed.map(a => [a.title || '', a.score || '', fmtDate(a.date), a.user || ''])
        } : undefined,
        thinking: `Filtered assessmentActivity for status=Completed. Found ${completed.length} of ${(m.assessmentActivity||[]).length} total.`,
        emptyMsg: `No assessments completed yet for ${m.name}.`
    };
}

function qMemberScreeningsMissing() {
    const m = window.currentMember;
    if (!m) return { summary: 'No member selected.', emptyMsg: 'Navigate to a member page.' };
    const lib = m.assessmentLibrary || [];
    const done = (m.assessmentActivity || []).map(a => a.title);
    const missing = lib.filter(a => !done.includes(a.title));
    return {
        summary: `<strong>${missing.length} of ${lib.length} screenings not yet completed</strong> for ${m.name}.`,
        count: missing.length, countLabel: 'missing screenings',
        table: {
            columns: ['Screening', 'Version', 'Status'],
            rows: [
                ...done.map(d => { const item = lib.find(l => l.title === d); return [d, item?.version || '', badgeHTML('Completed', 'posted')]; }),
                ...missing.map(m => [m.title, m.version || '', badgeHTML('Not Started', 'overdue')])
            ]
        },
        thinking: `Library has ${lib.length} screenings. Completed: ${done.length}. Missing: ${missing.length}.`
    };
}

function qMemberAssessTimeline() {
    const m = window.currentMember;
    if (!m) return { summary: 'No member selected.', emptyMsg: 'Navigate to a member page.' };
    const activity = (m.assessmentActivity || []).slice().sort((a,b) => (parseAnyDate(a.date)||0) - (parseAnyDate(b.date)||0));
    return {
        summary: `<strong>Assessment timeline</strong> for ${m.name}: ${activity.length} assessments.`,
        count: activity.length, countLabel: 'assessments',
        table: activity.length > 0 ? {
            columns: ['Date', 'Assessment', 'Status', 'Score', 'By'],
            rows: activity.map(a => [fmtDate(a.date), a.title || '', badgeHTML(a.status || '', a.status==='Completed'?'posted':'draft'), a.score || '', a.user || ''])
        } : undefined,
        thinking: `Listed all ${activity.length} assessments in chronological order for ${m.id}.`,
        emptyMsg: `No assessments on record for ${m.name}.`
    };
}

// 
// BIO/PSYCHO/SOCIAL TAB HANDLERS (3)
// 

function qMemberSDOH() {
    const m = window.currentMember;
    if (!m) return { summary: 'No member selected.', emptyMsg: 'Navigate to a member page.' };
    const living = m.livingArrangements || [];
    const edu = m.education || [];
    const emp = m.employment || [];
    const vol = m.volunteering || [];
    const totalFactors = living.length + edu.length + emp.length + vol.length;
    const rows = [];
    living.forEach(l => rows.push(['Housing', l.category || '', l.stable === 'Yes' ? badgeHTML('Stable', 'posted') : badgeHTML('Unstable', 'overdue'), l.description || '']));
    edu.forEach(e => rows.push(['Education', e.level || e.category || '', badgeHTML(e.status || 'Recorded', 'posted'), e.description || e.institution || '']));
    emp.forEach(e => rows.push(['Employment', e.type || e.category || '', badgeHTML(e.status || 'Recorded', 'posted'), e.description || e.employer || '']));
    vol.forEach(v => rows.push(['Volunteering', v.activity || v.category || '', badgeHTML('Active', 'posted'), v.description || v.organization || '']));
    return {
        summary: `<strong>Social determinants</strong> for ${m.name}: ${totalFactors} factors recorded.`,
        count: totalFactors, countLabel: 'SDOH factors',
        table: rows.length > 0 ? { columns: ['Domain', 'Category', 'Status', 'Details'], rows } : undefined,
        thinking: `SDOH: housing=${living.length}, education=${edu.length}, employment=${emp.length}, volunteering=${vol.length}. Total: ${totalFactors}.`,
        emptyMsg: `No bio/psycho/social data recorded for ${m.name}. This may require assessment.`
    };
}

function qMemberBarriers() {
    const m = window.currentMember;
    if (!m) return { summary: 'No member selected.', emptyMsg: 'Navigate to a member page.' };
    const cpd = m.carePlanData || {};
    const barriers = cpd.barriers || [];
    const gaps = cpd.gaps || [];
    const living = m.livingArrangements || [];
    const allBarriers = [];
    barriers.forEach(b => allBarriers.push({ cat: b.category, name: b.name, desc: b.description, status: b.status }));
    if (living.some(l => l.stable !== 'Yes')) allBarriers.push({ cat: 'Housing', name: 'Unstable Housing', desc: 'Living arrangement flagged as unstable', status: 'Active' });
    gaps.forEach(g => allBarriers.push({ cat: 'Clinical', name: g.measure, desc: g.desc, status: g.status }));
    return {
        summary: allBarriers.length > 0
            ? `<strong>${allBarriers.length} barriers to care</strong> identified for ${m.name}.`
            : `<strong>No barriers</strong> identified for ${m.name}.`,
        count: allBarriers.length, countLabel: 'barriers',
        table: allBarriers.length > 0 ? {
            columns: ['Category', 'Barrier', 'Description', 'Status'],
            rows: allBarriers.map(b => [b.cat, b.name, b.desc || '', badgeHTML(b.status || 'Active', b.status==='Active'?'overdue':'posted')])
        } : undefined,
        thinking: `Barriers analysis for ${m.name}: care plan barriers=${barriers.length}, clinical gaps=${gaps.length}, housing issues=${living.filter(l=>l.stable!=='Yes').length}.`,
        emptyMsg: `No barriers identified for ${m.name}.`
    };
}

function qMemberHousing() {
    const m = window.currentMember;
    if (!m) return { summary: 'No member selected.', emptyMsg: 'Navigate to a member page.' };
    const living = m.livingArrangements || [];
    return {
        summary: `<strong>Housing & support</strong> for ${m.name}: ${living.length} arrangement${living.length!==1?'s':''} on record.`,
        table: living.length > 0 ? {
            columns: ['Category', 'Stable?', 'Description', 'Recorded'],
            rows: living.map(l => [l.category || '', l.stable === 'Yes' ? badgeHTML('Stable','posted') : badgeHTML('Unstable','overdue'), l.description || '', fmtDate(l.recordedDate)])
        } : undefined,
        thinking: `Housing data for ${m.name}: ${living.length} records.`,
        emptyMsg: `No housing information recorded for ${m.name}.`
    };
}

// 
// HEALTH HISTORY TAB HANDLERS (4)
// 

function qMemberDiagnoses() {
    const m = window.currentMember;
    if (!m) return { summary: 'No member selected.', emptyMsg: 'Navigate to a member page.' };
    const dx = m.diagnoses || {};
    const dxList = [dx.primary, dx.secondary, dx.tertiary, dx.additional].filter(Boolean);
    return {
        summary: `<strong>${dxList.length} active diagnoses</strong> for ${m.name}.`,
        count: dxList.length, countLabel: 'diagnoses',
        table: dxList.length > 0 ? {
            columns: ['Code', 'Description', 'Type'],
            rows: dxList.map((d, i) => {
                const parts = d.split(' - ');
                return [parts[0] || '', parts.slice(1).join(' - ') || d, i === 0 ? 'Primary' : (i === 1 ? 'Secondary' : 'Additional')];
            })
        } : undefined,
        thinking: `Diagnoses for ${m.name}: ${dxList.length} conditions. Primary: ${dx.primary || 'none'}.`,
        emptyMsg: `No diagnoses on record for ${m.name}.`
    };
}

function qMemberMedications() {
    const m = window.currentMember;
    if (!m) return { summary: 'No member selected.', emptyMsg: 'Navigate to a member page.' };
    const meds = (m.healthHistory || {}).medications || [];
    return {
        summary: `<strong>${meds.length} current medications</strong> for ${m.name}.`,
        count: meds.length, countLabel: 'medications',
        table: meds.length > 0 ? {
            columns: ['Medication', 'Dose', 'Frequency', 'Last Filled'],
            rows: meds.map(med => [`<strong>${med.name}</strong>`, med.dose || '', med.freq || '', fmtDate(med.filled)])
        } : undefined,
        thinking: `Medications for ${m.name}: ${meds.length} on file from healthHistory.`,
        emptyMsg: `No medications on file for ${m.name}.`
    };
}

function qMemberLabs() {
    const m = window.currentMember;
    if (!m) return { summary: 'No member selected.', emptyMsg: 'Navigate to a member page.' };
    const labs = (m.healthHistory || {}).labs || [];
    return {
        summary: `<strong>${labs.length} lab results</strong> for ${m.name}.`,
        count: labs.length, countLabel: 'lab results',
        table: labs.length > 0 ? {
            columns: ['Test', 'Result', 'Normal Range', 'Date', 'Flag'],
            rows: labs.map(l => {
                // Check if out of range
                let flag = '';
                if (l.range && l.result) {
                    const rangeParts = l.range.split('-').map(Number);
                    const val = parseFloat(l.result);
                    if (rangeParts.length === 2 && !isNaN(val)) {
                        if (val < rangeParts[0] || val > rangeParts[1]) flag = badgeHTML('Out of Range', 'overdue');
                        else flag = badgeHTML('Normal', 'posted');
                    }
                }
                return [l.test || '', `<strong>${l.result || ''}</strong>`, l.range || '', fmtDate(l.date), flag || ''];
            })
        } : undefined,
        thinking: `Labs for ${m.name}: ${labs.length} results from healthHistory.`,
        emptyMsg: `No lab results on file for ${m.name}.`
    };
}

function qMemberAllergiesVitals() {
    const m = window.currentMember;
    if (!m) return { summary: 'No member selected.', emptyMsg: 'Navigate to a member page.' };
    const hh = m.healthHistory || {};
    const allergies = hh.allergies || [];
    const vitals = hh.coreHealth || [];
    const latest = vitals.length > 0 ? vitals[0] : null;
    return {
        summary: `<strong>Allergies & vitals</strong> for ${m.name}: ${allergies.length} allergies, ${vitals.length > 0 ? 'vitals on file' : 'no vitals'}.`,
        activityGrid: latest ? [
            { label: 'Blood Pressure', value: latest.bp || '', sub: fmtDate(latest.date) },
            { label: 'BMI', value: latest.bmi || '', sub: latest.weight || '' },
            { label: 'Pulse', value: latest.pulse || '', sub: 'bpm' },
        ] : undefined,
        table: allergies.length > 0 ? {
            columns: ['Allergen', 'Reaction', 'Severity'],
            rows: allergies.map(a => [a.name || '', a.reaction || '', badgeHTML(a.severity || '', a.severity==='Severe'?'overdue':(a.severity==='Moderate'?'draft':'posted'))])
        } : undefined,
        thinking: `Allergies: ${allergies.length}, Vitals: ${vitals.length > 0 ? 'yes' : 'none'} for ${m.name}.`,
        emptyMsg: `No allergy or vital sign data for ${m.name}.`
    };
}

// 
// POPULATION INSIGHTS TAB HANDLERS (3)
// 

function qMemberLOBPrograms() {
    const m = window.currentMember;
    if (!m) return { summary: 'No member selected.', emptyMsg: 'Navigate to a member page.' };
    const pop = m.populationData || {};
    const lob = pop.lob || [];
    const programs = pop.programs || [];
    const priority = pop.priority || [];
    const total = lob.length + programs.length + priority.length;
    return {
        summary: `<strong>Population details</strong> for ${m.name}: ${lob.length} LOB, ${programs.length} program${programs.length!==1?'s':''}, ${priority.length} priority population${priority.length!==1?'s':''}.`,
        count: total, countLabel: 'enrollments',
        table: {
            columns: ['Type', 'Name', 'Effective', 'End', 'Status'],
            rows: [
                ...lob.map(l => ['LOB', l.name || '', fmtDate(l.effective), fmtDate(l.end), typeof l.status === 'string' && l.status.includes('<') ? l.status : 'Active']),
                ...programs.map(p => ['Program', p.name || '', fmtDate(p.effective), fmtDate(p.end), typeof p.status === 'string' && p.status.includes('<') ? p.status : 'Active']),
                ...priority.map(p => [badgeHTML('Priority','overdue'), p.name || '', fmtDate(p.effective), fmtDate(p.end), typeof p.status === 'string' && p.status.includes('<') ? p.status : 'Active']),
            ]
        },
        thinking: `Population data for ${m.name}: ${lob.length} LOBs, ${programs.length} programs, ${priority.length} priority populations.`
    };
}

function qMemberRiskTrend() {
    const m = window.currentMember;
    if (!m) return { summary: 'No member selected.', emptyMsg: 'Navigate to a member page.' };
    const ra = m.riskAcuity || {};
    const history = ra.history || [];
    // Add current as last entry
    const full = [...history, { date: 'Current', tier: ra.currentTier || m.riskTier, score: ra.riskScore }];
    return {
        summary: `<strong>Risk trend</strong> for ${m.name}: Currently ${m.riskCategory || ''} (Tier ${ra.currentTier || m.riskTier || ''}).`,
        activityGrid: [
            { label: 'Current Tier', value: `Tier ${ra.currentTier || m.riskTier || ''}`, sub: m.riskCategory || '' },
            { label: 'Risk Score', value: ra.riskScore || '', sub: 'current' },
            { label: 'Last Assessed', value: fmtDate(ra.lastAssessment), sub: '' },
        ],
        table: full.length > 0 ? {
            columns: ['Date', 'Tier', 'Score'],
            rows: full.map(h => [h.date === 'Current' ? '<strong>Current</strong>' : fmtDate(h.date), `Tier ${h.tier}`, (h.score || '').toString()])
        } : undefined,
        thinking: `Risk history for ${m.name}: ${history.length} historical entries + current. Tier=${ra.currentTier}, Score=${ra.riskScore}.`
    };
}

function qMemberPriorityPop() {
    const m = window.currentMember;
    if (!m) return { summary: 'No member selected.', emptyMsg: 'Navigate to a member page.' };
    const priority = (m.populationData || {}).priority || [];
    return {
        summary: priority.length > 0
            ? `<strong>${priority.length} priority population${priority.length!==1?'s':''}</strong> for ${m.name}.`
            : `<strong>No priority populations</strong> apply to ${m.name}.`,
        count: priority.length, countLabel: 'priority populations',
        table: priority.length > 0 ? {
            columns: ['Population', 'Source', 'Identified', 'Updated By'],
            rows: priority.map(p => [badgeHTML(p.name || '', 'overdue'), p.source || '', fmtDate(p.identified), p.updatedBy || ''])
        } : undefined,
        thinking: `Priority populations for ${m.name}: ${priority.length} active.`,
        emptyMsg: `No priority populations assigned to ${m.name}.`
    };
}

// 
// ACTIVITY HISTORY TAB HANDLERS (3)
// 

function qMemberRecentContacts() {
    const m = window.currentMember;
    if (!m) return { summary: 'No member selected.', emptyMsg: 'Navigate to a member page.' };
    const ah = m.activityHistory || {};
    const notes = (ah.serviceNotes || []).concat(m.serviceNotes || []);
    // Deduplicate by id
    const seen = new Set();
    const unique = notes.filter(n => { if (seen.has(n.id)) return false; seen.add(n.id); return true; });
    unique.sort((a,b) => (parseAnyDate(b.date)||0) - (parseAnyDate(a.date)||0));
    return {
        summary: `<strong>${unique.length} contacts</strong> for ${m.name}.`,
        count: unique.length, countLabel: 'contacts',
        table: unique.length > 0 ? {
            columns: ['Date', 'Type', 'Activity', 'Duration', 'Staff'],
            rows: unique.slice(0, 15).map(n => [fmtDate(n.date), n.type || '', n.activity || n.purpose || '', n.duration || '', n.staff || n.author || ''])
        } : undefined,
        thinking: `Compiled contacts from activityHistory.serviceNotes and member.serviceNotes for ${m.id}. Unique: ${unique.length}.`,
        emptyMsg: `No contact records for ${m.name}.`
    };
}

function qMemberLastContact() {
    const m = window.currentMember;
    if (!m) return { summary: 'No member selected.', emptyMsg: 'Navigate to a member page.' };
    const notes = (m.serviceNotes || []).slice().sort((a,b) => (parseAnyDate(b.date)||0) - (parseAnyDate(a.date)||0));
    // Find last "successful" contact (not just an attempt)
    const successful = notes.find(n => !((n.activity||'').toLowerCase().includes('attempt') || (n.activity||'').toLowerCase().includes('no answer')));
    const last = successful || notes[0];
    const daysSince = last ? Math.floor((Date.now() - (parseAnyDate(last.date)||0)) / 86400000) : null;
    return {
        summary: last
            ? `<strong>Last successful contact</strong>: ${fmtDate(last.date)} (${daysSince} days ago)  ${last.activity || last.type || 'Contact'}.`
            : `<strong>No contact</strong> on record for ${m.name}.`,
        activityGrid: last ? [
            { label: 'Last Contact', value: fmtDate(last.date), sub: `${daysSince} days ago` },
            { label: 'Type', value: last.type || '', sub: '' },
            { label: 'Activity', value: last.activity || '', sub: last.duration || '' },
        ] : undefined,
        thinking: `Searched ${notes.length} notes for last successful contact. Found: ${last ? fmtDate(last.date) + ' (' + daysSince + ' days ago)' : 'none'}.`
    };
}

function qMemberContactBreakdown() {
    const m = window.currentMember;
    if (!m) return { summary: 'No member selected.', emptyMsg: 'Navigate to a member page.' };
    const notes = m.serviceNotes || [];
    const byType = {};
    notes.forEach(n => { const t = n.type || 'Other'; byType[t] = (byType[t] || 0) + 1; });
    const byActivity = {};
    notes.forEach(n => { const a = n.activity || 'Other'; byActivity[a] = (byActivity[a] || 0) + 1; });
    return {
        summary: `<strong>Contact breakdown</strong> for ${m.name}: ${notes.length} total contacts.`,
        count: notes.length, countLabel: 'total contacts',
        table: {
            columns: ['Contact Type', 'Count', 'Percentage'],
            rows: Object.entries(byType).sort((a,b) => b[1] - a[1]).map(([type, count]) => [
                type, count.toString(), `${Math.round(count / notes.length * 100)}%`
            ])
        },
        thinking: `Breakdown of ${notes.length} contacts for ${m.name}: by type=${JSON.stringify(byType)}, by activity=${JSON.stringify(byActivity)}.`
    };
}

// 
// CARE TEAM TAB HANDLERS (3)
// 

function qMemberCareTeam() {
    const m = window.currentMember;
    if (!m) return { summary: 'No member selected.', emptyMsg: 'Navigate to a member page.' };
    const ins = m.insurance || {};
    const team = [
        { role: 'Care Manager', name: m.careManager || '', phone: '', detail: `ID: ${m.careManagerId || ''}` },
        { role: 'Primary Care Physician', name: ins.pcpName || '', phone: ins.pcpPhone || '', detail: `Last visit: ${fmtDate(ins.pcpLastVisit)}` },
    ];
    const referrals = (m.activityHistory || {}).referrals || [];
    referrals.forEach(r => {
        team.push({ role: r.type === 'External' ? 'External Referral' : 'Internal Referral', name: r.recipient || '', phone: '', detail: r.reason || '' });
    });
    return {
        summary: `<strong>Care team</strong> for ${m.name}: ${team.length} members/providers.`,
        count: team.length, countLabel: 'team members',
        table: {
            columns: ['Role', 'Name', 'Phone', 'Details'],
            rows: team.map(t => [`<strong>${t.role}</strong>`, t.name, t.phone, t.detail])
        },
        thinking: `Care team for ${m.name}: CM=${m.careManager}, PCP=${ins.pcpName}, referrals=${referrals.length}.`
    };
}

function qMemberPCPInfo() {
    const m = window.currentMember;
    if (!m) return { summary: 'No member selected.', emptyMsg: 'Navigate to a member page.' };
    const ins = m.insurance || {};
    const daysSinceVisit = ins.pcpLastVisit ? Math.floor((Date.now() - (parseAnyDate(ins.pcpLastVisit)||0)) / 86400000) : null;
    return {
        summary: `<strong>PCP</strong>: ${ins.pcpName || 'Not assigned'}`,
        activityGrid: [
            { label: 'PCP Name', value: ins.pcpName || '', sub: '' },
            { label: 'Phone', value: ins.pcpPhone || '', sub: '' },
            { label: 'Last Visit', value: fmtDate(ins.pcpLastVisit), sub: daysSinceVisit !== null ? `${daysSinceVisit} days ago` : '' },
        ],
        thinking: `PCP info for ${m.name}: ${ins.pcpName}, phone=${ins.pcpPhone}, lastVisit=${ins.pcpLastVisit}.`
    };
}

function qMemberCoordNeeds() {
    const m = window.currentMember;
    if (!m) return { summary: 'No member selected.', emptyMsg: 'Navigate to a member page.' };
    const ins = m.insurance || {};
    const referrals = (m.activityHistory || {}).referrals || [];
    const adts = ((m.dashboardData||{}).adts||[]).concat((m.healthHistory||{}).adts||[]);
    const tasks = ((m.dashboardData?.tasks||[]).concat(m.tasks||[])).filter(t => t.status !== 'Closed');
    const needs = [];
    if (adts.length > 0) needs.push({ need: 'Post-discharge follow-up', detail: `${adts.length} ADT events  coordinate with facility`, urgency: 'High' });
    const pendingRefs = referrals.filter(r => (r.status||'').includes('Pending'));
    if (pendingRefs.length > 0) needs.push({ need: 'Pending referral follow-up', detail: `${pendingRefs.length} referral${pendingRefs.length>1?'s':''} awaiting response`, urgency: 'Medium' });
    const pcpDays = ins.pcpLastVisit ? Math.floor((Date.now() - (parseAnyDate(ins.pcpLastVisit)||0)) / 86400000) : 999;
    if (pcpDays > 90) needs.push({ need: 'PCP visit overdue', detail: `Last PCP visit: ${fmtDate(ins.pcpLastVisit)} (${pcpDays} days ago)`, urgency: 'Medium' });
    const coordTasks = tasks.filter(t => (t.title||t.name||'').match(/coord|referr|follow/i));
    if (coordTasks.length > 0) needs.push({ need: 'Coordination tasks open', detail: `${coordTasks.length} coordination-related tasks`, urgency: 'Medium' });
    return {
        summary: needs.length > 0
            ? `<strong>${needs.length} coordination needs</strong> for ${m.name}.`
            : `<strong>No urgent coordination needs</strong> for ${m.name}.`,
        count: needs.length, countLabel: 'coordination needs',
        table: needs.length > 0 ? {
            columns: ['Need', 'Details', 'Urgency'],
            rows: needs.map(n => [n.need, n.detail, badgeHTML(n.urgency, n.urgency==='High'?'overdue':'draft')])
        } : undefined,
        thinking: `Coordination analysis for ${m.name}: ADTs=${adts.length}, pending referrals=${pendingRefs.length}, days since PCP=${pcpDays}, coord tasks=${coordTasks.length}.`,
        emptyMsg: `No coordination needs identified for ${m.name}.`
    };
}

// 
// CARE PLANS TAB HANDLERS (4)
// 

function qMemberCarePlanSummary() {
    const m = window.currentMember;
    if (!m) return { summary: 'No member selected.', emptyMsg: 'Navigate to a member page.' };
    const cpd = m.carePlanData || {};
    const needs = cpd.needs || [];
    const totalGoals = needs.reduce((sum, n) => sum + (n.goals || []).length, 0);
    const totalInterventions = needs.reduce((sum, n) => sum + (n.goals || []).reduce((gs, g) => gs + (g.interventions || []).length, 0), 0);
    return {
        summary: needs.length > 0
            ? `<strong>Care plan</strong> for ${m.name}: ${needs.length} needs, ${totalGoals} goals, ${totalInterventions} interventions.`
            : `<strong>No active care plan</strong> for ${m.name}.`,
        activityGrid: needs.length > 0 ? [
            { label: 'Needs', value: needs.length, sub: 'identified' },
            { label: 'Goals', value: totalGoals, sub: 'set' },
            { label: 'Interventions', value: totalInterventions, sub: 'planned' },
            { label: 'Barriers', value: (cpd.barriers||[]).length, sub: 'recorded' },
        ] : undefined,
        table: needs.length > 0 ? {
            columns: ['Need', 'Category', 'Status', 'Goals', 'Follow-up'],
            rows: needs.map(n => [
                n.text ? n.text.substring(0, 50) + '...' : '',
                n.category || '',
                badgeHTML(n.status || '', n.status==='In Progress'?'draft':'posted'),
                (n.goals||[]).length.toString(),
                fmtDate(n.followUpDate)
            ])
        } : undefined,
        thinking: `Care plan for ${m.name}: needs=${needs.length}, goals=${totalGoals}, interventions=${totalInterventions}, barriers=${(cpd.barriers||[]).length}, activity log=${(cpd.activity||[]).length}.`,
        emptyMsg: `No care plan created yet for ${m.name}. ${m.consentStatus === 'Consented' ? 'Assessment may be needed first.' : 'Consent required before care planning.'}`
    };
}

function qMemberGoalsAtRisk() {
    const m = window.currentMember;
    if (!m) return { summary: 'No member selected.', emptyMsg: 'Navigate to a member page.' };
    const needs = (m.carePlanData || {}).needs || [];
    const allGoals = [];
    needs.forEach(n => {
        (n.goals || []).forEach(g => {
            const targetDate = parseAnyDate(g.targetDate);
            const isOverdue = targetDate && targetDate < new Date() && g.status !== 'Completed';
            const isAtRisk = g.outcome === 'At Risk' || g.status === 'Planned';
            allGoals.push({ ...g, needCategory: n.category, overdue: isOverdue, atRisk: isAtRisk });
        });
    });
    const flagged = allGoals.filter(g => g.overdue || g.atRisk);
    return {
        summary: flagged.length > 0
            ? `<strong>${flagged.length} goals at risk or overdue</strong> for ${m.name}.`
            : `<strong>All goals on track</strong> for ${m.name}.`,
        count: flagged.length, countLabel: 'goals flagged',
        table: allGoals.length > 0 ? {
            columns: ['Goal', 'Need', 'Status', 'Target Date', 'Outcome'],
            rows: allGoals.map(g => [
                g.text ? g.text.substring(0, 45) + '...' : '',
                g.needCategory || '',
                badgeHTML(g.status || '', g.status==='Completed'?'posted':(g.status==='In Progress'?'draft':'overdue')),
                fmtDate(g.targetDate),
                g.outcome && g.outcome !== '-' ? badgeHTML(g.outcome, g.outcome==='On Track'?'posted':'overdue') : ''
            ])
        } : undefined,
        thinking: `Goals analysis for ${m.name}: total goals=${allGoals.length}, flagged=${flagged.length} (overdue or at risk).`,
        emptyMsg: `No goals set yet for ${m.name}.`
    };
}

function qMemberInterventions() {
    const m = window.currentMember;
    if (!m) return { summary: 'No member selected.', emptyMsg: 'Navigate to a member page.' };
    const needs = (m.carePlanData || {}).needs || [];
    const allInterventions = [];
    needs.forEach(n => (n.goals || []).forEach(g => (g.interventions || []).forEach(iv => {
        allInterventions.push({ ...iv, goalText: g.text, needCategory: n.category });
    })));
    return {
        summary: `<strong>${allInterventions.length} interventions</strong> in ${m.name}'s care plan.`,
        count: allInterventions.length, countLabel: 'interventions',
        table: allInterventions.length > 0 ? {
            columns: ['Intervention', 'Need', 'Status', 'Owner', 'Due'],
            rows: allInterventions.map(iv => [
                iv.text ? iv.text.substring(0, 45) + '...' : '',
                iv.needCategory || '',
                badgeHTML(iv.status || '', iv.status==='Completed'?'posted':(iv.status==='In Progress'?'draft':'open')),
                iv.owner || '',
                fmtDate(iv.dueDate)
            ])
        } : undefined,
        thinking: `Interventions for ${m.name}: ${allInterventions.length} across ${needs.length} needs.`,
        emptyMsg: `No interventions in care plan for ${m.name}.`
    };
}

function qMemberCPReview() {
    const m = window.currentMember;
    if (!m) return { summary: 'No member selected.', emptyMsg: 'Navigate to a member page.' };
    const cpd = m.carePlanData || {};
    const activity = cpd.activity || [];
    const needs = cpd.needs || [];
    const followUps = needs.filter(n => n.followUpDate).map(n => ({ need: n.category, date: n.followUpDate, days: n.daysToFollowUp }));
    const lastReview = activity.filter(a => (a.name||'').includes('Review')).pop();
    // Find scheduled review from activityHistory events
    const ah = m.activityHistory || {};
    const scheduledReview = (ah.events || []).find(e => (e.name||'').includes('Review') && (e.status||'').includes('Scheduled'));
    return {
        summary: `<strong>Care plan review</strong> for ${m.name}${scheduledReview ? ': Next review scheduled' : lastReview ? ': Last reviewed ' + fmtDate(lastReview.date) : ': No reviews on record'}.`,
        activityGrid: [
            { label: 'Last Review', value: lastReview ? fmtDate(lastReview.date) : 'None', sub: lastReview ? `by ${lastReview.updatedBy}` : '' },
            { label: 'Next Scheduled', value: scheduledReview ? fmtDate(scheduledReview.deadline) : 'Not set', sub: '' },
            { label: 'Follow-ups', value: followUps.length, sub: 'upcoming' },
        ],
        table: followUps.length > 0 ? {
            columns: ['Need Area', 'Follow-up Date', 'Days to Follow-up'],
            rows: followUps.map(f => [f.need || '', fmtDate(f.date), f.days?.toString() || ''])
        } : undefined,
        thinking: `Care plan review for ${m.name}: last review=${lastReview?fmtDate(lastReview.date):'none'}, scheduled=${scheduledReview?fmtDate(scheduledReview.deadline):'none'}, follow-ups=${followUps.length}.`
    };
}

// 
// APPOINTMENT CREATION VIA AI CO-PILOT
// 

function qCreateAppointment() {
    const m = window.currentMember;
    if (!m) return { summary: 'No member selected.', emptyMsg: 'Navigate to a member page.' };

    //  SMART AI ANALYSIS 
    // Analyze member data to suggest the best appointment type
    const suggestion = analyzeForAppointmentSuggestion(m);

    // Default start = tomorrow at 10:00 AM
    const tomorrow = new Date();
    tomorrow.setDate(tomorrow.getDate() + 1);
    tomorrow.setHours(10, 0, 0, 0);
    const defaultStart = formatDateTimeLocal(tomorrow);
    const endDef = new Date(tomorrow);
    endDef.setMinutes(endDef.getMinutes() + (suggestion.durationMin || 30));
    const defaultEnd = formatDateTimeLocal(endDef);

    let html = '<div class="ai-response-block">';
    html += `<div class="ai-appt-form" id="aiApptForm">

        <div class="form-title">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>
            New Appointment  ${m.name}
        </div>

        <div class="ai-smart-hint">
            <div class="hint-label">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2L13.09 8.26L18 6L14.74 10.91L21 12L14.74 13.09L18 18L13.09 15.74L12 22L10.91 15.74L6 18L9.26 13.09L3 12L9.26 10.91L6 6L10.91 8.26L12 2Z"/></svg>
                AI Suggestion
            </div>
            <div class="hint-text">${suggestion.title}</div>
            <span class="hint-reason">${suggestion.reason}</span>
            <button class="hint-apply" onclick="applySmartSuggestion()">Apply suggestion</button>
        </div>

        <div class="field-group">
            <label class="field-label">Title <span class="req">*</span></label>
            <input type="text" id="apptTitle" placeholder="e.g., Follow-up Call, Assessment Review">
            <div class="form-error" id="apptTitleError">Please enter a title</div>
        </div>

        <div class="field-group">
            <label class="field-label">Type</label>
            <select id="apptType">
                <option value="Follow-up Call">Follow-up Call</option>
                <option value="Consent Outreach">Consent Outreach</option>
                <option value="Assessment">Assessment</option>
                <option value="Care Plan Review">Care Plan Review</option>
                <option value="Home Visit">Home Visit</option>
                <option value="PCP Visit">PCP Visit</option>
                <option value="Specialist Visit">Specialist Visit</option>
                <option value="Telehealth">Telehealth</option>
                <option value="Wellness Check">Wellness Check</option>
                <option value="Other">Other</option>
            </select>
        </div>

        <div class="datetime-row">
            <div class="field-group">
                <label class="field-label">Start <span class="req">*</span></label>
                <input type="datetime-local" id="apptStart" value="${defaultStart}" onchange="autoFillEndTime()">
                <div class="form-error" id="apptStartError">Required</div>
            </div>
            <div class="field-group">
                <label class="field-label">End <span class="req">*</span></label>
                <input type="datetime-local" id="apptEnd" value="${defaultEnd}">
                <div class="form-error" id="apptEndError">Must be after start</div>
            </div>
        </div>

        <div class="field-group">
            <label class="field-label">Notes <span class="opt">(optional)</span></label>
            <textarea id="apptDesc" rows="2" placeholder="Brief note about the appointment..."></textarea>
        </div>

        <hr class="form-divider">

        <div class="form-actions">
            <button class="btn-cancel-appt" onclick="resetAICopilot()">Cancel</button>
            <button class="btn-create-appt" id="apptSubmitBtn" onclick="submitAIAppointment()">
                <span id="apptSubmitText">Schedule</span>
            </button>
        </div>
    </div>`;
    html += '</div>';

    // Store suggestion for "Apply" button
    window._aiApptSuggestion = suggestion;

    return { _customHTML: html };
}

function analyzeForAppointmentSuggestion(m) {
    const consent = m.consentStatus || '';
    const stage = m.journeyStage || '';
    const notes = m.serviceNotes || [];
    const lastNote = notes.length > 0 ? notes[notes.length - 1] : null;
    const daysSinceContact = lastNote ? Math.floor((Date.now() - (parseAnyDate(lastNote.date)||0)) / 86400000) : 999;
    const assessAct = m.assessmentActivity || [];
    const hasCompletedAssess = assessAct.some(a => a.status === 'Completed');
    const hasInProgressAssess = assessAct.some(a => a.status === 'In Progress');
    const cpd = m.carePlanData || {};
    const hasCarePlan = (cpd.needs || []).length > 0;
    const adts = ((m.dashboardData||{}).adts||[]).concat((m.healthHistory||{}).adts||[]);
    const unackedADTs = adts.filter(a => a.acknowledged === 'No');
    const safety = m.safetyConcern || {};

    // Priority-ordered rules
    if (safety.hasConcern) {
        return { title: 'Urgent Safety Follow-up', type: 'Follow-up Call', reason: `Active safety concern flagged  immediate check-in recommended.`, durationMin: 30, desc: `Safety follow-up: ${safety.details || safety.type || 'Review concern status'}` };
    }
    if (unackedADTs.length > 0) {
        const evt = unackedADTs[0];
        return { title: `Post-Discharge Follow-up  ${evt.type || 'ADT'}`, type: 'Follow-up Call', reason: `${unackedADTs.length} unacknowledged ADT event${unackedADTs.length>1?'s':''}  post-discharge outreach needed.`, durationMin: 30, desc: `Follow-up on ${evt.type || 'ADT event'} at ${evt.facility || 'facility'} (${fmtDate(evt.date)})` };
    }
    if (['To Obtain Consent','Re-consent Required'].includes(consent)) {
        return { title: `Consent Outreach  ${m.name.split(' ')[0]}`, type: 'Consent Outreach', reason: `Consent status is "${consent}"  outreach call needed to obtain consent.`, durationMin: 15, desc: `Consent outreach call for ${m.name}. Status: ${consent}` };
    }
    if (hasInProgressAssess) {
        const ip = assessAct.find(a => a.status === 'In Progress');
        return { title: `Complete ${ip.title || 'Assessment'}`, type: 'Assessment', reason: `${ip.title || 'Assessment'} is in progress  schedule time to complete.`, durationMin: 45, desc: `Complete in-progress ${ip.title || 'assessment'} started ${fmtDate(ip.date)}` };
    }
    if (consent === 'Consented' && !hasCompletedAssess && !hasInProgressAssess) {
        return { title: `Health Risk Assessment  ${m.name.split(' ')[0]}`, type: 'Assessment', reason: `Member is consented but has no assessments started  HRA needed.`, durationMin: 45, desc: `Initial Health Risk Assessment for ${m.name}` };
    }
    if (hasCompletedAssess && !hasCarePlan) {
        return { title: `Care Plan Development  ${m.name.split(' ')[0]}`, type: 'Care Plan Review', reason: `Assessment completed but no care plan created yet.`, durationMin: 30, desc: `Develop initial care plan based on completed assessments` };
    }
    if (daysSinceContact > 30 && hasCarePlan) {
        return { title: `Monthly Follow-up  ${m.name.split(' ')[0]}`, type: 'Follow-up Call', reason: `Last contact was ${daysSinceContact} days ago  member is overdue for follow-up.`, durationMin: 20, desc: `Monthly check-in. Last contact: ${lastNote ? fmtDate(lastNote.date) : 'unknown'}` };
    }
    if (hasCarePlan && stage === 'FULLY_ACTIVE') {
        const nextReview = (cpd.needs || []).find(n => n.followUpDate);
        return { title: `Care Plan Review  ${m.name.split(' ')[0]}`, type: 'Care Plan Review', reason: `Member is fully active with an active care plan${nextReview ? '  follow-up due ' + fmtDate(nextReview.followUpDate) : ''}.`, durationMin: 30, desc: `Review care plan goals and interventions` };
    }
    // Default
    return { title: `Follow-up Call  ${m.name.split(' ')[0]}`, type: 'Follow-up Call', reason: `General follow-up based on current member status.`, durationMin: 20, desc: `Routine follow-up with ${m.name}` };
}

function applySmartSuggestion() {
    const s = window._aiApptSuggestion;
    if (!s) return;
    const titleEl = document.getElementById('apptTitle');
    const typeEl = document.getElementById('apptType');
    const descEl = document.getElementById('apptDesc');
    const startEl = document.getElementById('apptStart');
    const endEl = document.getElementById('apptEnd');
    if (titleEl) titleEl.value = s.title;
    if (typeEl) typeEl.value = s.type;
    if (descEl && s.desc) descEl.value = s.desc;
    // Adjust end time based on suggested duration
    if (startEl && startEl.value && endEl && s.durationMin) {
        const start = new Date(startEl.value);
        start.setMinutes(start.getMinutes() + s.durationMin);
        endEl.value = formatDateTimeLocal(start);
    }
    // Visual feedback  briefly flash the hint
    const hint = document.querySelector('.ai-smart-hint');
    if (hint) {
        hint.style.borderLeftColor = '#166534';
        hint.style.background = 'linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%)';
        const btn = hint.querySelector('.hint-apply');
        if (btn) { btn.textContent = ' Applied'; btn.style.background = '#166534'; btn.disabled = true; }
    }
}

function formatDateTimeLocal(date) {
    const y = date.getFullYear();
    const mo = String(date.getMonth() + 1).padStart(2, '0');
    const d = String(date.getDate()).padStart(2, '0');
    const h = String(date.getHours()).padStart(2, '0');
    const mi = String(date.getMinutes()).padStart(2, '0');
    return `${y}-${mo}-${d}T${h}:${mi}`;
}

function autoFillEndTime() {
    const startEl = document.getElementById('apptStart');
    const endEl = document.getElementById('apptEnd');
    if (startEl && startEl.value && endEl) {
        const start = new Date(startEl.value);
        start.setMinutes(start.getMinutes() + 30);
        endEl.value = formatDateTimeLocal(start);
    }
}

function submitAIAppointment() {
    const m = window.currentMember;
    if (!m) return;

    // Gather values
    const title = (document.getElementById('apptTitle')?.value || '').trim();
    const type = document.getElementById('apptType')?.value || 'Follow-up Call';
    const startVal = document.getElementById('apptStart')?.value || '';
    const endVal = document.getElementById('apptEnd')?.value || '';
    const desc = (document.getElementById('apptDesc')?.value || '').trim();

    // Reset errors
    document.querySelectorAll('.ai-appt-form .form-error').forEach(e => e.classList.remove('show'));
    let hasError = false;

    // Validate
    if (!title) {
        document.getElementById('apptTitleError')?.classList.add('show');
        hasError = true;
    }
    if (!startVal) {
        document.getElementById('apptStartError')?.classList.add('show');
        hasError = true;
    }
    if (!endVal || (startVal && new Date(endVal) <= new Date(startVal))) {
        document.getElementById('apptEndError')?.classList.add('show');
        hasError = true;
    }
    if (hasError) return;

    // Disable button
    const btn = document.getElementById('apptSubmitBtn');
    if (btn) { btn.disabled = true; }
    const btnText = document.getElementById('apptSubmitText');
    if (btnText) btnText.textContent = 'Scheduling...';

    // Build appointment object
    const startDate = new Date(startVal);
    const endDate = new Date(endVal);
    const durationMin = Math.round((endDate - startDate) / 60000);
    const appt = {
        id: 'APPT-' + m.id.replace('MEM-','') + '-' + Date.now(),
        title: title,
        type: type,
        description: desc,
        startDate: startVal,
        endDate: endVal,
        duration: durationMin + ' min',
        status: 'Scheduled',
        createdBy: m.careManager || 'Care Manager',
        createdAt: new Date().toISOString(),
        memberId: m.id,
        memberName: m.name
    };

    // Store on member
    if (!m.appointments) m.appointments = [];
    m.appointments.push(appt);

    // Simulate brief processing delay
    setTimeout(() => {
        // Update the widget on dashboard
        refreshAppointmentsWidget(m);

        // Replace form with confirmation
        const formEl = document.getElementById('aiApptForm');
        if (formEl) {
            const startFmt = formatApptDateTime(startDate);
            const endFmt = formatApptTime(endDate);
            formEl.innerHTML = `
                <div class="ai-appt-confirm">
                    <div class="confirm-icon"></div>
                    <div class="confirm-title">Appointment Scheduled</div>
                    <div class="confirm-detail">
                        <strong>${escapeHtml(title)}</strong><br>
                        <span style="color:#475569">${type}</span><br><br>
                         ${startFmt}  ${endFmt}<br>
                         ${durationMin} minutes<br>
                        ${desc ? ' ' + escapeHtml(desc) + '<br>' : ''}
                         ${m.name}<br>
                         Created by ${appt.createdBy}
                    </div>
                </div>

                <div style="margin-top:12px;font-size:12px;color:#64748b">
                    Appointment added to <strong>${m.name}'s</strong> dashboard.
                    ${m.appointments.length > 1 ? m.appointments.length + ' total appointments.' : ''}
                </div>
            `;
        }

        // Add thinking
        const container = document.getElementById('aiMessages');
        if (container) {
            const tid = 'think_appt_' + Math.random().toString(36).substr(2, 6);
            const thinkingHtml = `<div class="ai-show-thinking" style="margin-top:8px;">
                <button class="ai-show-thinking-toggle" onclick="toggleThinking('${tid}', this)">
                    <span class="arrow"></span> Show thinking
                </button>
                <div class="ai-thinking-content" id="${tid}">Created appointment "${title}" (${type}) for ${m.name} (${m.id}). Start: ${startVal}, End: ${endVal}, Duration: ${durationMin} min. Stored in member.appointments[${m.appointments.length - 1}]. Updated dashboard widget.</div>
            </div>`;
            const feedbackHtml = `<div class="ai-feedback-row">
                <button class="ai-feedback-btn" onclick="this.style.color='#2d2d52'" title="Helpful">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 9V5a3 3 0 00-3-3l-4 9v11h11.28a2 2 0 002-1.7l1.38-9a2 2 0 00-2-2.3H14z"/></svg>
                </button>
                <button class="ai-feedback-btn" onclick="this.style.color='#ef4444'" title="Not helpful">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M10 15v4a3 3 0 003 3l4-9V2H5.72a2 2 0 00-2 1.7l-1.38 9a2 2 0 002 2.3H10z"/></svg>
                </button>
            </div>`;
            const backHtml = `<div class="ai-back-row"><button class="ai-back-btn" onclick="resetAICopilot()"> Back to questions</button></div>`;
            // Append to the existing assistant message
            const assistantMsg = container.querySelector('.ai-conv-assistant:last-child');
            if (assistantMsg) {
                assistantMsg.innerHTML += thinkingHtml + feedbackHtml + backHtml;
            }
        }
    }, 600);
}

function formatApptDateTime(date) {
    const days = ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];
    const months = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
    const day = days[date.getDay()];
    const month = months[date.getMonth()];
    const d = date.getDate();
    const h = date.getHours();
    const min = String(date.getMinutes()).padStart(2, '0');
    const ampm = h >= 12 ? 'PM' : 'AM';
    const h12 = h % 12 || 12;
    return `${day}, ${month} ${d} at ${h12}:${min} ${ampm}`;
}

function formatApptTime(date) {
    const h = date.getHours();
    const min = String(date.getMinutes()).padStart(2, '0');
    const ampm = h >= 12 ? 'PM' : 'AM';
    const h12 = h % 12 || 12;
    return `${h12}:${min} ${ampm}`;
}

function refreshAppointmentsWidget(member) {
    const appts = (member.appointments || []).filter(a => {
        const d = new Date(a.startDate);
        return d >= new Date(); // Only upcoming
    }).sort((a,b) => new Date(a.startDate) - new Date(b.startDate));

    // Find all instances of the Upcoming Appointments widget on the page
    const widgetTitles = document.querySelectorAll('.widget-title');
    widgetTitles.forEach(titleEl => {
        if (titleEl.textContent.includes('Upcoming Appointments')) {
            // Update count
            titleEl.textContent = `Upcoming Appointments (${appts.length})`;

            // Update content
            const widgetContent = titleEl.closest('.dashboard-widget')?.querySelector('.widget-content');
            if (widgetContent) {
                widgetContent.innerHTML = buildApptWidgetHTML(member);
            }
        }
    });
}

function buildApptWidgetHTML(member) {
    var appts = (member.appointments || []).filter(function(a) { return new Date(a.startDate) >= new Date(); });
    appts.sort(function(a, b) { return new Date(a.startDate) - new Date(b.startDate); });
    if (appts.length === 0) {
        return '<div style="padding: 20px; text-align: center; color: #666;">There are no Upcoming Appointments for this Member that meet current criteria</div>';
    }
    var mon = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
    var rows = '';
    appts.forEach(function(a) {
        var s = new Date(a.startDate);
        var h = s.getHours(); var m12 = h % 12 || 12; var ampm = h >= 12 ? 'PM' : 'AM';
        var dtStr = mon[s.getMonth()] + ' ' + s.getDate() + ' at ' + m12 + ':' + String(s.getMinutes()).padStart(2, '0') + ' ' + ampm;
        rows += '<tr><td style="padding:8px 10px;font-weight:500;">' + (a.title || '') + '</td><td style="padding:8px 10px;color:#64748b;">' + (a.type || '\u2014') + '</td><td style="padding:8px 10px;">' + dtStr + '</td><td style="padding:8px 10px;">' + (a.duration || '\u2014') + '</td><td style="padding:8px 10px;"><span style="background:#dcfce7;color:#166534;padding:2px 8px;border-radius:12px;font-size:11px;">Scheduled</span></td></tr>';
    });
    return '<div style="overflow-x:auto;"><table style="width:100%;border-collapse:collapse;font-size:12px;"><thead><tr style="border-bottom:1px solid #e2e8f0;background:#f8fafc;"><th style="padding:8px 10px;text-align:left;font-weight:600;color:#475569;">Title</th><th style="padding:8px 10px;text-align:left;font-weight:600;color:#475569;">Type</th><th style="padding:8px 10px;text-align:left;font-weight:600;color:#475569;">Date &amp; Time</th><th style="padding:8px 10px;text-align:left;font-weight:600;color:#475569;">Duration</th><th style="padding:8px 10px;text-align:left;font-weight:600;color:#475569;">Status</th></tr></thead><tbody>' + rows + '</tbody></table></div>';
}

function openAICopilotForAppointment() {
    // Open the AI copilot if not open
    if (!aiCopilotState.isOpen) {
        toggleAICopilot();
    }
    // Small delay to let panel open, then trigger the appointment question
    setTimeout(() => {
        handleAIQuestion('mx_create_appt');
    }, 300);
}

function buildServiceNotesWidgetHTML(member) {
    const notes = (member.serviceNotes || []).filter(n => n.status === 'Draft');
    if (notes.length === 0) {
        return `<div class="info-message">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M8 16A8 8 0 1 0 8 0a8 8 0 0 0 0 16zm.93-9.412-1 4.705c-.07.34.029.533.304.533.194 0 .487-.07.686-.246l-.088.416c-.287.346-.92.598-1.465.598-.703 0-1.002-.422-.808-1.319l.738-3.468c.064-.293.006-.399-.287-.47l-.451-.081.082-.381 2.29-.287zM8 5.5a1 1 0 1 1 0-2 1 1 0 0 1 0 2z"/></svg>
            There are no records that meet current criteria
        </div>`;
    }
    let html = '<table class="dashboard-table"><thead><tr><th>Date</th><th>Activity</th><th>Type</th><th>Duration</th><th>Status</th></tr></thead><tbody>';
    notes.forEach(n => {
        html += `<tr>
            <td>${fmtDate(n.date)}</td>
            <td>${n.activity || ''}</td>
            <td>${n.type || ''}</td>
            <td>${n.duration || ''}</td>
            <td><span style="background:#fef3c7;color:#d97706;padding:2px 8px;border-radius:10px;font-size:10px;font-weight:600">Draft</span></td>
        </tr>`;
    });
    html += '</tbody></table>';
    return html;
}

function refreshServiceNotesWidget(member) {
    if (!member) return;
    const draftNotes = (member.serviceNotes || []).filter(n => n.status === 'Draft');
    // Update all instances of the widget title
    document.querySelectorAll('.widget-title').forEach(el => {
        if (el.textContent.includes('Open Service Notes')) {
            el.textContent = `Open Service Notes (${draftNotes.length})`;
        }
    });
    // Update widget content
    const content = document.getElementById('dashSNWidgetContent');
    if (content) {
        content.innerHTML = buildServiceNotesWidgetHTML(member);
    }
}

function openAICopilotForServiceNote() {
    if (!aiCopilotState.isOpen) {
        toggleAICopilot();
    }
    setTimeout(() => {
        handleAIQuestion('mx_draft_note');
    }, 300);
}

// 
// CONNECTOR FUNCTIONS  Link AI Copilot to rest of app
// 

function handleResultClick(id) {
    if (typeof membersDB !== 'undefined') {
        const member = membersDB.find(m => m.id === id);
        if (member) { handleMemberCardClick(id); return; }
    }
    if (typeof tasksDB !== 'undefined') {
        const task = tasksDB.find(t => t.id === id);
        if (task) { console.log('Navigate to task:', id); return; }
    }
    handleMemberCardClick(id);
}

function openMemberNewTab(id) {
    if (!id) return;
    // Open the same page in a new tab with member hash for auto-navigation
    const baseUrl = window.location.href.split('#')[0];
    window.open(baseUrl + '#memberNav=' + id, '_blank');
}

function handleMemberCardClick(id) {
    // Open member in new tab from AI copilot context
    openMemberNewTab(id);
}

function handleAIAction(actionType, targetId) {
    switch(actionType) {
        case 'call':
            const member = membersDB?.find(m => m.id === targetId);
            if (member && member.phone) { alert(`Calling ${member.name}...\nPhone: ${member.phone}`); }
            break;
        case 'view':
            handleMemberCardClick(targetId);
            break;
    }
}

function updateAICopilotContext() {
    // Detect if we've left a member page
    const wasOnMember = !!aiCopilotState.currentMember;
    const nowOnMember = !!window.currentMember;

    if (wasOnMember && !nowOnMember) {
        // Left member  back to list/other page: reset everything
        aiCopilotState.currentMember = null;
        aiCopilotState.currentContext = 'dashboard';
        aiCopilotState.isInConversation = false;
        renderWelcomeScreen();
    } else if (!wasOnMember && nowOnMember) {
        // Entered a member page
        aiCopilotState.currentMember = window.currentMember;
        aiCopilotState.currentContext = 'memberDetails';
        aiCopilotState.isInConversation = false;
        renderWelcomeScreen();
    } else if (wasOnMember && nowOnMember && aiCopilotState.currentMember?.id !== window.currentMember?.id) {
        // Switched to a different member
        aiCopilotState.currentMember = window.currentMember;
        aiCopilotState.currentContext = 'memberDetails';
        aiCopilotState.isInConversation = false;
        renderWelcomeScreen();
    }
}

function initializeAIWelcome() {
    renderWelcomeScreen();
}

function clearAIChatForContext(ctx) {
    renderWelcomeScreen();
}

function getCurrentPageContext() {
    return { page: 'dashboard', tab: null };
}

function getContextLabel() {
    return 'Dashboard';
}

function handleAIInputKeypress(event) {
    if (event.key === 'Enter') { handleSendMessage(); }
}


// ==========================================
// START OF TASK MANAGEMENT LOGIC
// ==========================================

// 1. DATA GENERATOR: Adds tasks to existing members
function generateMemberTasks(members) {
    // Exact options from your screenshots
    const taskTypes = [
        'Member Consent', 'Complete Urgent Needs Assessment', 'Care Plan Follow Up', 
        'ADT Follow Up', 'Complete Care Plan', 'Conduct Screening', 
        'Accept Or Decline Referral', 'Send New Referral', 'Create Care Plan',
        'Complete Closed Care Plan Assessment'
    ];
    
    const sources = [
        'Urgent Safety Concern', 'Tier 4', 'Tier 3', 'Tier 2', 'Tier 1', 
        'Care Plan Follow Up', 'End Of Care Plan', 'Transitional Care'
    ];
    
    const assignees = [
        'No Assignee', 'aziz.cm', 'jolee.uat', 'john.manager', 
        'sarah.wilson', 'bailey.cm', 'andrew.greenburg'
    ];

    members.forEach(member => {
        member.tasks = []; // Reset tasks
        
        // 1. Consent Task
        if(member.consentStatus !== 'Consented') {
            member.tasks.push({
                id: `t-${member.id}-1`,
                name: 'Obtain Consent',
                memberName: member.name,
                medicaidId: member.id,
                group: 'Unassigned Group',
                assignee: 'jolee.uat',
                cta: 'Contact',
                source: 'Urgent Safety Concern',
                type: 'Member Consent',
                priority: 'High',
                score: 95,
                dueDate: '15/01/2026',
                status: 'Open',
                createdOn: '14/01/2026'
            });
        }

        // 2. High Risk Task
        if(member.riskCategory === 'High') {
            member.tasks.push({
                id: `t-${member.id}-2`,
                name: 'Complete Urgent Needs Assessment',
                memberName: member.name,
                medicaidId: member.id,
                group: '',
                assignee: 'aziz.cm',
                cta: 'Assessment',
                source: 'Tier 4',
                type: 'Complete Urgent Needs Assessment',
                priority: 'High',
                score: 95,
                dueDate: '14/01/2026',
                status: 'Open',
                createdOn: '13/01/2026'
            });
        }

        // 3. Random Task
        const randomType = taskTypes[Math.floor(Math.random() * taskTypes.length)];
        const randomSource = sources[Math.floor(Math.random() * sources.length)];
        const randomAssignee = assignees[Math.floor(Math.random() * assignees.length)];
        
        member.tasks.push({
            id: `t-${member.id}-3`,
            name: randomType,
            memberName: member.name,
            medicaidId: member.id,
            group: 'East Team',
            assignee: randomAssignee,
            cta: 'View',
            source: randomSource,
            type: randomType,
            priority: 'Medium',
            score: 50,
            dueDate: '30/01/2026',
            status: 'Closed',
            createdOn: '01/01/2026'
        });
    });
}


// ==========================================
// 1. DATA ENRICHMENT: INSURANCE
// ==========================================
// function generateMemberInsurance(members) {
//     const plans = ['Standard Plan', 'Tailored Plan', 'Behavioral Health Plan'];
//     const statuses = ['Active', 'Terminated', 'Pending', 'Suspended'];
//     const riskTypes = ['PHP Risk Score', 'Playground Risk Tiers', 'State Acuity Model'];

//     members.forEach(member => {
//         // Generate consistent dates based on member's care start date
//         const startDate = new Date(member.careMgmtStart || '2024-01-01');
//         const endDate = new Date(startDate);
//         endDate.setFullYear(startDate.getFullYear() + 1);

//         // 1. Enrollment Data
//         member.enrollment = [{
//             id: 'enr-' + Math.floor(Math.random() * 1000),
//             insuranceCompany: member.mco || 'NC Medicaid',
//             insuranceType: 'Public',
//             planName: 'NC MEDICAID MANAGED CARE - ' + (member.riskCategory === 'High' ? 'TAILORED PLAN' : 'STANDARD PLAN'),
//             county: member.county || 'Wake',
//             planType: 'Medicaid',
//             status: member.memberStatus === 'Active' ? 'Active' : 'Inactive',
//             startDate: startDate.toLocaleDateString('en-US'),
//             endDate: endDate.toLocaleDateString('en-US'),
//             createdOn: new Date(startDate.getTime() - 86400000).toLocaleString()
//         }];

//         // 2. Care Management Spans (History)
//         member.careSpans = [{
//             id: 'span-' + Math.floor(Math.random() * 1000),
//             insurance: member.mco || 'NC Medicaid',
//             planName: member.enrollment[0].planName,
//             planType: 'Medicaid',
//             startDate: startDate.toLocaleDateString('en-US'),
//             endDate: endDate.toLocaleDateString('en-US'),
//             status: member.memberStatus === 'Active' ? 'Active' : 'Terminated',
//             assignmentDate: new Date(startDate.getTime() - 432000000).toLocaleDateString('en-US') // 5 days prior
//         }];

//         // Add a historical span for some members
//         if (Math.random() > 0.5) {
//             const oldStart = new Date(startDate);
//             oldStart.setFullYear(oldStart.getFullYear() - 1);
//             const oldEnd = new Date(startDate);
//             oldEnd.setDate(oldEnd.getDate() - 1);
            
//             member.careSpans.push({
//                 id: 'span-old-' + Math.floor(Math.random() * 1000),
//                 insurance: member.mco || 'NC Medicaid',
//                 planName: 'NC MEDICAID DIRECT',
//                 planType: 'Medicaid',
//                 startDate: oldStart.toLocaleDateString('en-US'),
//                 endDate: oldEnd.toLocaleDateString('en-US'),
//                 status: 'Terminated',
//                 assignmentDate: oldStart.toLocaleDateString('en-US')
//             });
//         }

//         // 3. Risk Acuity
//         const riskScore = member.riskCategory === 'High' ? Math.floor(Math.random() * 30) + 70 : Math.floor(Math.random() * 40) + 10;
        
//         member.riskAcuity = [
//             {
//                 type: 'PHP Risk Score',
//                 primary: true,
//                 status: 'Active',
//                 score: riskScore,
//                 description: `Calculated based on ${member.diagnoses?.primary || 'claims data'}`,
//                 category: member.riskCategory || 'Medium',
//                 date: startDate.toLocaleDateString('en-US')
//             },
//             {
//                 type: 'Playground Risk Tiers',
//                 primary: false,
//                 status: 'Active',
//                 score: 0,
//                 description: 'Risk stratification through the Playground Risk Model',
//                 category: 'Tier ' + (member.riskCategory === 'High' ? '3' : '1'),
//                 date: startDate.toLocaleDateString('en-US')
//             }
//         ];
//     });
// }

// Run immediately to populate data
if (typeof membersDB !== 'undefined') {
    // generateMemberInsurance(membersDB); // Disabled - data pre-generated
}

function handleAIInputChange(event) {
    // Optional: implement auto-suggest or validation
    // For now, can be empty or used for future enhancement
}


// ==========================================
// 2. INSURANCE CONTROLLER
// ==========================================

// ==========================================
// CONSENT CHECK HELPER - Used by all controllers
// ==========================================
function requiresConsent(member, tabName) {
    const consentedStatuses = ['Consented', 'Re-consent Required'];
    const tabsRequiringConsent = ['screenings', 'bio-psycho', 'history', 'careplans'];
    
    if (tabsRequiringConsent.includes(tabName) && !consentedStatuses.includes(member.consentStatus)) {
        return `
        <div style="padding: 40px; text-align: center;">
            <div style="font-size: 48px; margin-bottom: 16px;"></div>
            <h3 style="color: #353182; margin-bottom: 8px;">Consent Required</h3>
            <p style="color: #666; max-width: 400px; margin: 0 auto;">
                This information is not available for members without consent.<br>
                Current consent status: <strong style="color: #ff8c00;">${member.consentStatus}</strong>
            </p>
            <p style="color: #999; font-size: 13px; margin-top: 16px;">
                Please obtain member consent before accessing this data.
            </p>
        </div>`;
    }
    return null; // Consent is valid, proceed normally
}

const InsuranceController = {
    currentMember: null,
    activeSubTab: 'enrollment', // enrollment, spans, risk

    render: function(member) {
        this.currentMember = member;
        // Default to enrollment tab on first load
        this.activeSubTab = 'enrollment';
        return this.getLayoutHTML();
    },

    getLayoutHTML: function() {
        return `
        <div class="insurance-container" style="padding: 24px;">
            <div style="display: flex; gap: 4px; margin-bottom: 24px; border-bottom: 1px solid #e1e5e9;">
                <button class="sub-tab-btn ${this.activeSubTab === 'enrollment' ? 'active' : ''}" onclick="InsuranceController.switchTab('enrollment')">Enrollment</button>
                <button class="sub-tab-btn ${this.activeSubTab === 'spans' ? 'active' : ''}" onclick="InsuranceController.switchTab('spans')">Care Management Spans</button>
                <button class="sub-tab-btn ${this.activeSubTab === 'risk' ? 'active' : ''}" onclick="InsuranceController.switchTab('risk')">Risk Acuity</button>
            </div>

            <div id="insuranceContentArea">
                ${this.getContentHTML()}
            </div>
        </div>
        
        <style>
            .sub-tab-btn {
                padding: 10px 16px;
                background: none;
                border: none;
                border-bottom: 2px solid transparent;
                cursor: pointer;
                font-size: 13px;
                font-weight: 500;
                color: #666;
                transition: all 0.2s;
            }
            .sub-tab-btn:hover { color: #353182; background: #f8f9fa; }
            .sub-tab-btn.active {
                color: #353182;
                border-bottom-color: #353182;
                font-weight: 600;
            }
            .ins-header {
                display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;
            }
            .ins-title { font-size: 18px; font-weight: 600; color: #333; }
            .ins-badge {
                padding: 4px 8px; border-radius: 12px; font-size: 11px; font-weight: 600; text-transform: uppercase;
            }
            .ins-badge.Active { background: #dcfce7; color: #166534; }
            .ins-badge.Inactive { background: #f3f4f6; color: #374151; }
            .ins-badge.Terminated { background: #fee2e2; color: #991b1b; }
        </style>
        `;
    },

    switchTab: function(tabName) {
        this.activeSubTab = tabName;
        
        // 1. Update Visual State
        document.querySelectorAll('.sub-tab-btn').forEach(btn => {
            btn.classList.remove('active');
            const btnText = btn.textContent.toLowerCase();
            if (btnText.includes(tabName === 'enrollment' ? 'enrollment' : tabName === 'spans' ? 'care management' : 'risk')) {
                btn.classList.add('active');
            }
        });

        // 2. Render Content
        const contentArea = document.getElementById('insuranceContentArea');
        if (contentArea) contentArea.innerHTML = this.getContentHTML();
    },

    getContentHTML: function() {
        const m = this.currentMember;
        if (!m) return '<div>No member selected</div>';

        if (this.activeSubTab === 'enrollment') {
            return this.renderEnrollment(m);
        } else if (this.activeSubTab === 'spans') {
            return this.renderSpans(m);
        } else {
            return this.renderRisk(m);
        }
    },

    // --- SUB-TAB: ENROLLMENT ---
    renderEnrollment: function(m) {
        const rows = m.enrollment.map(e => `
            <tr>
                <td><input type="checkbox"></td>
                <td><a href="#" onclick="alert('Development in progress')">${e.insuranceCompany}</a></td>
                <td>${e.insuranceType}</td>
                <td>${e.planName}</td>
                <td>${e.county}</td>
                <td>${e.planType}</td>
                <td>${e.startDate}</td>
                <td>${e.endDate}</td>
                <td>${e.createdOn}</td>
                <td><span class="ins-badge ${e.status}">${e.status}</span></td>
                <td>
                    <button style="border:none; bg:none; cursor:pointer;" onclick="alert('Development in progress')"></button>
                </td>
            </tr>
        `).join('');

        return `
            <div class="ins-header">
                <div class="ins-title">List of Enrollments (${m.enrollment.length})</div>
                <div style="display:flex; gap:12px; align-items:center;">
                    <div class="search-box"><input type="text" placeholder="Search by Insurance Type..."></div>
                    <button class="btn btn-secondary">Filter</button>
                </div>
            </div>
            <div class="task-table-wrapper">
                <table class="dashboard-table">
                    <thead>
                        <tr>
                            <th style="width:30px"></th>
                            <th>Insurance Company</th>
                            <th>Insurance Type</th>
                            <th>Plan Name</th>
                            <th>County</th>
                            <th>Plan Type</th>
                            <th>Start Date</th>
                            <th>End Date</th>
                            <th>Created On</th>
                            <th>Status</th>
                            <th></th>
                        </tr>
                    </thead>
                    <tbody>${rows}</tbody>
                </table>
            </div>
        `;
    },

    // --- SUB-TAB: CARE SPANS ---
    renderSpans: function(m) {
        const spans = m.careSpans || [];
        const rows = spans.map(s => `
            <tr>
                <td><input type="checkbox"></td>
                <td>${s.insurance || m.insurance?.mco || m.mco || 'N/A'}</td>
                <td>${s.planName || m.insurance?.planName || 'NC MEDICAID MANAGED CARE'}</td>
                <td>${s.planType || 'Tailored Plan'}</td>
                <td>${s.startDate}</td>
                <td>${s.endDate}</td>
                <td><span class="ins-badge ${s.status}">${s.status}</span></td>
                <td>${s.assignmentDate || s.startDate}</td>
                <td>
                    <button style="border:none; bg:none; cursor:pointer;" onclick="alert('Development in progress')"></button>
                </td>
            </tr>
        `).join('');

        return `
            <div class="ins-header">
                <div class="ins-title">Care Management Spans (${m.careSpans.length})</div>
                <div style="padding:10px; background:#e0e7ff; border:1px solid #353182; border-radius:4px; color:#353182; font-size:12px; display:flex; gap:8px; align-items:center;">
                    <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M8 16A8 8 0 1 0 8 0a8 8 0 0 0 0 16zm.93-9.412-1 4.705c-.07.34.029.533.304.533.194 0 .487-.07.686-.246l-.088.416c-.287.346-.92.598-1.465.598-.703 0-1.002-.422-.808-1.319l.738-3.468c.064-.293.006-.399-.287-.47l-.451-.081.082-.381 2.29-.287zM8 5.5a1 1 0 1 1 0-2 1 1 0 0 1 0 2z"/></svg>
                    The Care Management spans shown here indicate the data received through the States Beneficiary Assignment files.
                </div>
            </div>
            <div class="task-table-wrapper">
                <table class="dashboard-table">
                    <thead>
                        <tr>
                            <th style="width:30px"></th>
                            <th>Insurance Company</th>
                            <th>Plan Name</th>
                            <th>Plan Type</th>
                            <th>Care Mgmt Start</th>
                            <th>Care Mgmt End</th>
                            <th>Status</th>
                            <th>Assignment Received</th>
                            <th></th>
                        </tr>
                    </thead>
                    <tbody>${rows}</tbody>
                </table>
            </div>
        `;
    },

    // --- SUB-TAB: RISK ACUITY ---
    renderRisk: function(m) {
        // Convert riskAcuity object to array format for rendering
        const riskData = Array.isArray(m.riskAcuity) ? m.riskAcuity : this._buildRiskArray(m);
        const rows = riskData.map(r => `
            <tr>
                <td><a href="#" onclick="alert('Development in progress')">${r.type}</a></td>
                <td>
                    <div style="width:36px; height:20px; background:${r.primary ? '#3b82f6' : '#e5e7eb'}; border-radius:10px; position:relative;">
                        <div style="width:16px; height:16px; background:white; border-radius:50%; position:absolute; top:2px; ${r.primary ? 'right:2px' : 'left:2px'}; transition:all 0.2s;"></div>
                    </div>
                </td>
                <td><span class="ins-badge ${r.status}">${r.status}</span></td>
                <td>${r.score}</td>
                <td>${r.description}</td>
                <td><span style="background:#dcfce7; color:#166534; padding:2px 8px; border-radius:4px; font-size:11px;">${r.category}</span></td>
                <td>${r.date}</td>
                <td>
                    <button style="border:none; bg:none; cursor:pointer;" onclick="alert('Development in progress')"></button>
                </td>
            </tr>
        `).join('');

        return `
            <div class="ins-header">
                <div class="ins-title">List of Risk Acuities (${riskData.length})</div>
                <div style="display:flex; gap:12px;">
                     <div class="search-box"><input type="text" placeholder="Search by Risk Description"></div>
                    <button class="btn btn-secondary">Filter</button>
                    <button class="btn btn-primary" onclick="alert('Development in progress')">Add New</button>
                </div>
            </div>
            <div class="task-table-wrapper">
                <table class="dashboard-table">
                    <thead>
                        <tr>
                            <th>Risk Type</th>
                            <th>Primary</th>
                            <th>Status</th>
                            <th>Risk Score</th>
                            <th>Description</th>
                            <th>Risk Category</th>
                            <th>Identified Date</th>
                            <th></th>
                        </tr>
                    </thead>
                    <tbody>${rows}</tbody>
                </table>
            </div>
        `;
    },

    // Helper to convert riskAcuity object  array for table rendering
    _buildRiskArray: function(m) {
        const ra = m.riskAcuity || {};
        const tierMap = {1: 'Minimal', 2: 'Low', 3: 'Medium', 4: 'High'};
        const arr = [];
        // Current risk assessment
        arr.push({
            type: 'Clinical Risk Assessment',
            primary: true,
            status: 'Active',
            score: ra.riskScore || (m.riskTier * 20),
            description: 'Overall health risk assessment based on clinical indicators and utilization history',
            category: tierMap[ra.currentTier || m.riskTier] || 'Medium',
            date: ra.lastAssessment || '01/01/2025'
        });
        // Add history entries
        if (ra.history && ra.history.length > 0) {
            ra.history.forEach((h, i) => {
                arr.push({
                    type: i === 0 ? 'Behavioral Health Risk' : 'Social Risk Assessment',
                    primary: false,
                    status: 'Active',
                    score: h.score || 0,
                    description: i === 0 ? 'Assessment of behavioral health risk factors' : 'Social determinants of health risk evaluation',
                    category: tierMap[h.tier] || 'Low',
                    date: h.date || '01/01/2025'
                });
            });
        }
        return arr;
    }
};


// ==========================================
// 3. DATA ENRICHMENT: SCREENINGS & ASSESSMENTS
// ==========================================

// Run immediately
if (typeof membersDB !== 'undefined') {
    // generateMemberScreenings(membersDB); // Disabled - data pre-generated
}

// ==========================================
// 4. SCREENING CONTROLLER
// ==========================================
const ScreeningController = {
    currentMember: null,
    activeTab: 'library', // 'library' or 'activity'

    render: function(member) {
        this.currentMember = member;
        this.activeTab = 'library';
        
        // Check consent status
        const consentCheck = requiresConsent(member, 'screenings');
        if (consentCheck) return consentCheck;
        
        return this.getLayoutHTML();
    },
    getLayoutHTML: function() {
        return `
        <div class="screenings-container" style="padding: 24px;">
            <div style="display: flex; gap: 4px; margin-bottom: 24px; border-bottom: 1px solid #e1e5e9;">
                <button class="scr-tab-btn ${this.activeTab === 'library' ? 'active' : ''}" onclick="ScreeningController.switchTab('library')">
                    Assessments And Screenings Library
                </button>
                <button class="scr-tab-btn ${this.activeTab === 'activity' ? 'active' : ''}" onclick="ScreeningController.switchTab('activity')">
                    Assessments And Screenings Activity
                </button>
            </div>

            <div id="screeningContentArea">
                ${this.getContentHTML()}
            </div>
        </div>

        <style>
            /* Custom Tab Styles for Screenings */
            .scr-tab-btn {
                padding: 10px 16px;
                border: 1px solid transparent;
                border-top-left-radius: 4px;
                border-top-right-radius: 4px;
                cursor: pointer;
                font-size: 13px;
                font-weight: 500;
                color: #666;
                background: #f8f9fa;
                border-bottom: none;
                margin-bottom: -1px;
            }
            .scr-tab-btn.active {
                background: #fff;
                color: #333;
                border-color: #e1e5e9;
                border-bottom: 2px solid white; 
                font-weight: 600;
                z-index: 2;
            }
            /* Info Box Style */
            .scr-info-box {
                background: #e3f2fd;
                border: 1px solid #90caf9;
                color: #0d47a1;
                padding: 12px 16px;
                border-radius: 4px;
                margin-bottom: 20px;
                font-size: 13px;
                display: flex;
                align-items: center;
                gap: 12px;
            }
            /* Action Button (Blue Plus) */
            .action-icon-btn {
                width: 28px; 
                height: 28px; 
                border-radius: 50%; 
                background: #4a6ee0; 
                color: white; 
                border: none; 
                display: flex; 
                align-items: center; 
                justify-content: center; 
                cursor: pointer;
                transition: background 0.2s;
            }
            .action-icon-btn:hover { background: #353182; }
            
            /* Table Header Override */
            .screening-table th {
                background: #353182 !important; /* Dark blue header from screenshot */
                color: white !important;
                font-weight: 500;
                text-transform: none;
            }
        </style>
        `;
    },

    switchTab: function(tabName) {
        this.activeTab = tabName;
        // Update tab styling
        document.querySelectorAll('.scr-tab-btn').forEach(btn => {
            btn.classList.toggle('active', btn.textContent.toLowerCase().includes(tabName));
        });
        // Render content
        document.getElementById('screeningContentArea').innerHTML = this.getContentHTML();
    },

    getContentHTML: function() {
        if (this.activeTab === 'library') {
            return this.renderLibrary();
        } else {
            return this.renderActivity();
        }
    },

    renderLibrary: function() {
        const m = this.currentMember;
        const library = m.assessmentLibrary || [];

        const rows = library.map(item => `
            <tr>
                <td>${item.title}</td>
                <td>${item.version}</td>
                <td style="text-align: right;">
                    <button class="action-icon-btn" onclick="alert('Development in progress')" title="Create New">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                            <path fill-rule="evenodd" d="M8 2a.5.5 0 0 1 .5.5v5h5a.5.5 0 0 1 0 1h-5v5a.5.5 0 0 1-1 0v-5h-5a.5.5 0 0 1 0-1h5v-5A.5.5 0 0 1 8 2z"/>
                        </svg>
                    </button>
                </td>
            </tr>
        `).join('');

        return `
            <div class="scr-info-box">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16">
                    <path d="M8 16A8 8 0 1 0 8 0a8 8 0 0 0 0 16zm.93-9.412-1 4.705c-.07.34.029.533.304.533.194 0 .487-.07.686-.246l-.088.416c-.287.346-.92.598-1.465.598-.703 0-1.002-.422-.808-1.319l.738-3.468c.064-.293.006-.399-.287-.47l-.451-.081.082-.381 2.29-.287zM8 5.5a1 1 0 1 1 0-2 1 1 0 0 1 0 2z"/>
                </svg>
                <span>A new screening or assessment cannot be created when a draft exists.</span>
            </div>

            <h3 style="font-size: 18px; color: #333; margin-bottom: 16px;">Assessments Library (${library.length})</h3>
            <div style="margin-bottom: 16px; font-size: 13px;">Active Filters: <svg width="12" height="12" fill="currentColor" viewBox="0 0 16 16"><path d="M1.5 1.5A.5.5 0 0 1 2 1h12a.5.5 0 0 1 .5.5v2a.5.5 0 0 1-.128.334L10 8.692V13.5a.5.5 0 0 1-.342.474l-3 1A.5.5 0 0 1 6 14.5V8.692L1.628 3.834A.5.5 0 0 1 1.5 3.5v-2z"/></svg></div>

            <div class="task-table-wrapper">
                <table class="dashboard-table screening-table">
                    <thead>
                        <tr>
                            <th style="width: 70%;">Title</th>
                            <th>Version Date</th>
                            <th style="width: 50px;"></th>
                        </tr>
                    </thead>
                    <tbody>
                        ${rows.length > 0 ? rows : '<tr><td colspan="3" style="text-align:center; padding:20px;">No available assessments match criteria.</td></tr>'}
                    </tbody>
                </table>
            </div>
            
            <div class="pagination" style="margin-top: 16px;">
                <span>Page 1 of 1</span>
                <div><button disabled>&lt;</button><button disabled>&gt;</button></div>
            </div>
        `;
    },

    renderActivity: function() {
        const m = this.currentMember;
        const activity = m.assessmentActivity || [];

        const rows = activity.map(item => `
            <tr>
                <td>${item.title}</td>
                <td><span class="status-badge completed">${item.status}</span></td>
                <td>${item.date}</td>
                <td>${item.score}</td>
                <td>${item.user}</td>
                <td style="text-align: right;">
                     <button class="action-icon-btn" onclick="alert('Development in progress')" style="background:#6c757d;" title="View">
                        <svg width="14" height="14" fill="currentColor" viewBox="0 0 16 16"><path d="M10.5 8a2.5 2.5 0 1 1-5 0 2.5 2.5 0 0 1 5 0z"/><path d="M0 8s3-5.5 8-5.5S16 8 16 8s-3 5.5-8 5.5S0 8 0 8zm8 3.5a3.5 3.5 0 1 0 0-7 3.5 3.5 0 0 0 0 7z"/></svg>
                     </button>
                </td>
            </tr>
        `).join('');

        return `
            <h3 style="font-size: 18px; color: #333; margin-bottom: 16px;">Completed Assessments (${activity.length})</h3>
             <div class="task-table-wrapper">
                <table class="dashboard-table screening-table">
                    <thead>
                        <tr>
                            <th>Assessment Title</th>
                            <th>Status</th>
                            <th>Completion Date</th>
                            <th>Score</th>
                            <th>Completed By</th>
                            <th></th>
                        </tr>
                    </thead>
                    <tbody>
                        ${rows.length > 0 ? rows : '<tr><td colspan="6" style="text-align:center; padding:20px;">No completed assessments found.</td></tr>'}
                    </tbody>
                </table>
            </div>
        `;
    }
};

// ==========================================
// 3. ENHANCED DATA GENERATION: UNIQUE SCREENINGS
// ==========================================
function generateMemberScreenings(members) {
    // 1. Define the Master Catalog of Assessment Templates
    const catalog = [
        // General / Behavioral
        { id: 'phq9', title: 'PHQ-9 Depression Screening', version: '10/09/2025', ageMin: 12, category: 'Behavioral' },
        { id: 'gad7', title: 'GAD-7 Anxiety Screening', version: '10/09/2025', ageMin: 12, category: 'Behavioral' },
        { id: 'sdoh', title: 'Social Determinants of Health (SDOH)', version: '12/12/2025', ageMin: 18, category: 'Social' },
        
        // Condition Specific
        { id: 'diab', title: 'Diabetes Self-Management Assessment', version: '10/09/2025', condition: 'diabetes', category: 'Chronic' },
        { id: 'asthma', title: 'Asthma Control Test (ACT)', version: '10/09/2025', condition: 'asthma', category: 'Chronic' },
        { id: 'falls', title: 'Falls Risk Assessment', version: '01/01/2026', ageMin: 65, category: 'Safety' },
        { id: 'adl', title: 'Activities of Daily Living (ADL)', version: '01/01/2026', ageMin: 60, category: 'Functional' },
        
        // Age/Gender Specific
        { id: 'epds', title: 'Edinburgh Postnatal Depression Scale', version: '10/09/2025', gender: 'Female', ageMin: 18, ageMax: 45, category: 'Maternal' },
        { id: 'prenatal', title: 'Prenatal Risk Screening', version: '10/09/2025', gender: 'Female', ageMin: 15, ageMax: 45, category: 'Maternal' },
        { id: 'headss', title: 'HEADSS for Adolescents', version: '10/09/2025', ageMin: 12, ageMax: 18, category: 'Pediatric' },
        
        // General Safety
        { id: 'safety', title: 'Urgent Safety Need Assessment', version: '10/09/2025', ageMin: 0, category: 'Safety' },
        { id: 'housing', title: 'Housing Stability Assessment', version: '05/05/2025', ageMin: 18, category: 'Social' }
    ];

    // 2. Loop through every member and assign UNIQUE data
    members.forEach(member => {
        // --- A. Generate Library (Available to Start) ---
        // Filter based on Age, Gender, and Conditions found in their diagnosis string
        member.assessmentLibrary = catalog.filter(item => {
            if (item.ageMin && member.age < item.ageMin) return false;
            if (item.ageMax && member.age > item.ageMax) return false;
            if (item.gender && item.gender !== member.gender) return false;
            
            // Smart Condition Check: Look at member's diagnoses object
            if (item.condition) {
                const dxString = JSON.stringify(member.diagnoses).toLowerCase();
                if (!dxString.includes(item.condition)) return false;
            }
            return true;
        });

        // --- B. Generate Activity (History) based on Member ID ---
        member.assessmentActivity = []; // Clear existing

        switch (member.id) {
            case 'LEAPAug2024DK11': // King Loreley (Frailty, High Risk)
                addActivity(member, 'falls', 'Completed', 'High Risk', 'John Manager 12', 5);
                addActivity(member, 'adl', 'Completed', '12/20 (Needs Assistance)', 'John Manager 12', 12);
                addActivity(member, 'sdoh', 'Completed', 'Transportation Gap', 'John Manager 12', 45);
                break;

            case 'MEM2025-JS01': // Jane Smith (Diabetes)
                addActivity(member, 'diab', 'Completed', 'Poor Control', 'Sarah Wilson', 2);
                addActivity(member, 'phq9', 'Completed', 'Score: 4 (Minimal)', 'Sarah Wilson', 30);
                break;

            case 'MEM2025-LN03': // Lucy Nunez (Pregnancy)
                addActivity(member, 'prenatal', 'Completed', 'High Risk', 'Maria Rodriguez', 10);
                addActivity(member, 'epds', 'Completed', 'Score: 12', 'Maria Rodriguez', 60);
                addActivity(member, 'sdoh', 'Completed', 'Stable', 'Maria Rodriguez', 90);
                break;
            
            case 'MEM2025-BM04': // Ben Miller (Heart Failure)
                addActivity(member, 'gad7', 'Completed', 'Score: 15 (Severe)', 'Sarah Wilson', 3);
                addActivity(member, 'safety', 'Completed', 'No Concerns', 'Sarah Wilson', 120);
                break;

            case 'MEM2025-EH23': // Edward Hill (Parkinsons)
                addActivity(member, 'falls', 'Completed', 'High Risk', 'Angela Turner', 2);
                addActivity(member, 'adl', 'Completed', 'Max Assist', 'Angela Turner', 5);
                break;

            default:
                // For random members, just give them SDOH or nothing
                if (Math.random() > 0.7) {
                    addActivity(member, 'sdoh', 'Completed', 'Stable', 'System', 100);
                }
                break;
        }
    });

    // Helper to add activity easily
    function addActivity(member, id, status, score, user, daysAgo) {
        const template = catalog.find(x => x.id === id);
        if (!template) return;
        
        const d = new Date();
        d.setDate(d.getDate() - daysAgo);
        
        member.assessmentActivity.push({
            title: template.title,
            status: status,
            date: d.toLocaleDateString('en-US'),
            score: score,
            user: user
        });
    }
}

// 4. EXECUTE IMMEDIATELY
if (typeof membersDB !== 'undefined') {
    // generateMemberScreenings(membersDB); // Disabled - data pre-generated
}

// Run immediately to populate data
if (typeof membersDB !== 'undefined') {
    // generateMemberScreenings(membersDB); // Disabled - data pre-generated
}

// ==========================================
// 4. SCREENING CONTROLLER
// ==========================================



// ==========================================
// 5. DATA ENRICHMENT: BIO/PSYCHO/SOCIAL
// ==========================================
function generateBioPsychoSocialData(members) {
    const livingOptions = [
        { cat: 'Private Home - alone', stable: 'Yes', desc: 'Owns home, lives independently' },
        { cat: 'Private Home - with family', stable: 'Yes', desc: 'Lives with spouse/children' },
        { cat: 'Rented Apartment', stable: 'Yes', desc: '1-year lease' },
        { cat: 'Homeless - Unhoused', stable: 'No', desc: 'Currently staying in shelter' },
        { cat: 'Temporary Housing', stable: 'No', desc: 'Staying with friends' },
        { cat: 'Assisted Living', stable: 'Yes', desc: 'Facility name: Sunrise Care' }
    ];

    const eduOptions = ['High School Diploma', 'Associate Degree', 'Bachelor\'s Degree', 'Master\'s Degree', 'GED', 'Vocational Certificate', 'Some College'];
    
    const empOptions = [
        { status: 'Current', type: 'Full-time', desc: 'Software Developer' },
        { status: 'Past', type: 'Part-time', desc: 'Retail Associate' },
        { status: 'Past', type: 'Full-time', desc: 'Office Manager' },
        { status: 'Current', type: 'Self-employed', desc: 'Consultant' },
        { status: 'Unemployed', type: 'Unemployed', desc: 'Looking for work' },
        { status: 'Retired', type: 'Retired', desc: 'Retired 2020' }
    ];

    const volOptions = [
        { type: 'Weekly', desc: 'Food Bank volunteer' },
        { type: 'Monthly', desc: 'Church greeter' },
        { type: 'As Needed', desc: 'School chaperone' },
        { type: 'Temporary', desc: 'Event staff' }
    ];

    // Helper to get a random date within last X years
    const getRandomDate = (yearsBack) => {
        const d = new Date();
        d.setFullYear(d.getFullYear() - Math.floor(Math.random() * yearsBack));
        d.setMonth(Math.floor(Math.random() * 12));
        d.setDate(Math.floor(Math.random() * 28));
        return d.toLocaleDateString('en-GB');
    };

    members.forEach(member => {
        // 1. Living Arrangements (3-4 entries)
        member.livingArrangements = [];
        const numLiving = 3 + Math.floor(Math.random() * 2); // 3 to 4 items
        for (let i = 0; i < numLiving; i++) {
            const opt = livingOptions[Math.floor(Math.random() * livingOptions.length)];
            member.livingArrangements.push({
                id: `liv-${member.id}-${i}`,
                category: opt.cat,
                stable: opt.stable,
                description: opt.desc,
                recordedDate: getRandomDate(i * 2 + 1), // Spread dates out
                endDate: i === 0 ? '' : getRandomDate(i * 2) // Most recent has no end date
            });
        }
        // Sort by date (mock sort by putting most recent first in loop logic or simple reverse)
        member.livingArrangements.sort((a, b) => a.endDate === '' ? -1 : 1);


        // 2. Education (2-3 entries)
        member.education = [];
        const numEdu = 2 + Math.floor(Math.random() * 2);
        for (let i = 0; i < numEdu; i++) {
            const level = eduOptions[Math.floor(Math.random() * eduOptions.length)];
            member.education.push({
                id: `edu-${member.id}-${i}`,
                status: i === 0 && member.age < 25 ? 'In Progress' : 'Completed',
                level: level,
                description: 'Verified via transcript',
                recordedDate: getRandomDate(5 + i*3),
                endDate: i === 0 ? '' : getRandomDate(5 + i*3 - 1)
            });
        }

        // 3. Employment (3-5 entries)
        member.employment = [];
        const numEmp = 3 + Math.floor(Math.random() * 3);
        for (let i = 0; i < numEmp; i++) {
            const opt = empOptions[Math.floor(Math.random() * empOptions.length)];
            member.employment.push({
                id: `emp-${member.id}-${i}`,
                status: i === 0 ? (member.age > 65 ? 'Retired' : 'Current') : 'Past',
                type: opt.type,
                description: opt.desc,
                recordedDate: getRandomDate(i * 3 + 1),
                endDate: i === 0 ? '' : getRandomDate(i * 3)
            });
        }

        // 4. Volunteering (3-4 entries) - Ensure everyone has some
        member.volunteering = [];
        const numVol = 3 + Math.floor(Math.random() * 2);
        for (let i = 0; i < numVol; i++) {
            const opt = volOptions[Math.floor(Math.random() * volOptions.length)];
            member.volunteering.push({
                id: `vol-${member.id}-${i}`,
                status: i === 0 ? 'Active' : 'Inactive',
                type: opt.type,
                description: opt.desc,
                recordedDate: getRandomDate(i + 1),
                endDate: i === 0 ? '' : getRandomDate(i)
            });
        }
    });
}

// Execute immediately if DB exists
if (typeof membersDB !== 'undefined') {
    // generateBioPsychoSocialData(membersDB); // Disabled - data pre-generated
}

// Execute immediately if DB exists
if (typeof membersDB !== 'undefined') {
    // generateBioPsychoSocialData(membersDB); // Disabled - data pre-generated
}

// ==========================================
// 6. BIO/PSYCHO/SOCIAL CONTROLLER
// ==========================================
const BioPsychoSocialController = {
    currentMember: null,
    activeTab: 'living', // living, education, employment, volunteering

    render: function(member) {
        this.currentMember = member;
        this.activeTab = 'living';
        
        // Check consent status
        const consentCheck = requiresConsent(member, 'bio-psycho');
        if (consentCheck) return consentCheck;
        
        return this.getLayoutHTML();
    },
    getLayoutHTML: function() {
        return `
        <div class="bps-container" style="padding: 24px;">
            <div style="display: flex; gap: 4px; margin-bottom: 24px; border-bottom: 1px solid #e1e5e9;">
                <button class="bps-tab-btn ${this.activeTab === 'living' ? 'active' : ''}" onclick="BioPsychoSocialController.switchTab('living')">Living Arrangements</button>
                <button class="bps-tab-btn ${this.activeTab === 'education' ? 'active' : ''}" onclick="BioPsychoSocialController.switchTab('education')">Education</button>
                <button class="bps-tab-btn ${this.activeTab === 'employment' ? 'active' : ''}" onclick="BioPsychoSocialController.switchTab('employment')">Employment</button>
                <button class="bps-tab-btn ${this.activeTab === 'volunteering' ? 'active' : ''}" onclick="BioPsychoSocialController.switchTab('volunteering')">Volunteering</button>
            </div>

            <div id="bpsContentArea">
                ${this.getContentHTML()}
            </div>
        </div>

        <style>
            .bps-tab-btn {
                padding: 8px 16px;
                border: none;
                border-radius: 4px;
                cursor: pointer;
                font-size: 13px;
                font-weight: 500;
                color: #fff;
                background: #6c757d; 
                margin-right: 4px;
                transition: all 0.2s;
            }
            .bps-tab-btn:hover { opacity: 0.9; }
            .bps-tab-btn.active {
                background: #5d78ad; 
                color: white;
            }
            .bps-header-row {
                display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;
            }
            .bps-title { font-size: 18px; font-weight: 400; color: #333; }
            .bps-controls { display: flex; align-items: center; gap: 12px; }
            .bps-link-blue { color: #353182; text-decoration: underline; cursor: pointer; font-weight: 500; }
            
            /* FORCE TABLE HEADER STYLE */
            .bps-table thead th {
                background-color: #353182 !important;
                color: #ffffff !important;
                font-weight: 500;
                padding: 12px 16px;
            }
            .bps-table tbody td {
                padding: 12px 16px;
                border-bottom: 1px solid #e9ecef;
                color: #333;
            }
        </style>
        `;
    },

    switchTab: function(tabName) {
        this.activeTab = tabName;
        // Update tabs visually
        document.querySelectorAll('.bps-tab-btn').forEach(btn => {
            // Simple text check to toggle active class
            btn.classList.toggle('active', btn.innerText.toLowerCase().includes(tabName.substring(0,4))); 
        });
        document.getElementById('bpsContentArea').innerHTML = this.getContentHTML();
    },

    getContentHTML: function() {
        switch(this.activeTab) {
            case 'living': return this.renderLiving();
            case 'education': return this.renderEducation();
            case 'employment': return this.renderEmployment();
            case 'volunteering': return this.renderVolunteering();
            default: return 'Loading...';
        }
    },

    // --- SUB-TAB RENDERERS ---

    renderLiving: function() {
        const items = this.currentMember.livingArrangements || [];
        const rows = items.map(item => `
            <tr>
                <td><input type="checkbox"></td>
                <td><a href="#" onclick="alert('Development in progress')" class="bps-link-blue">${item.category}</a></td>
                <td>${item.stable}</td>
                <td>${item.description}</td>
                <td>${item.recordedDate}</td>
                <td></td> <td style="text-align:right;"><button style="border:none; bg:none; cursor:pointer;" onclick="alert('Development in progress')"></button></td>
            </tr>
        `).join('');

        return this.wrapTable('Living Arrangements History', items.length, 
            ['Category', 'Stable', 'Description', 'Recorded Date', 'End Date', ''], 
            rows);
    },

    renderEducation: function() {
        const items = this.currentMember.education || [];
        const rows = items.map(item => `
            <tr>
                <td><input type="checkbox"></td>
                <td>${item.status}</td>
                <td><a href="#" onclick="alert('Development in progress')" class="bps-link-blue">${item.level}</a></td>
                <td>${item.description}</td>
                <td>${item.recordedDate}</td>
                <td></td>
                <td style="text-align:right;"><button style="border:none; bg:none; cursor:pointer;" onclick="alert('Development in progress')"></button></td>
            </tr>
        `).join('');

        return this.wrapTable('Education History', items.length, 
            ['Status', 'Level', 'Description', 'Recorded Date', 'End Date', ''], 
            rows);
    },

    renderEmployment: function() {
        const items = this.currentMember.employment || [];
        const rows = items.map(item => `
            <tr>
                <td><input type="checkbox"></td>
                <td><a href="#" onclick="alert('Development in progress')" class="bps-link-blue">${item.status}</a></td>
                <td>${item.type}</td>
                <td>${item.description}</td>
                <td>${item.recordedDate}</td>
                <td></td>
                <td style="text-align:right;"><button style="border:none; bg:none; cursor:pointer;" onclick="alert('Development in progress')"></button></td>
            </tr>
        `).join('');

        return this.wrapTable('Employment History', items.length, 
            ['Status', 'Type', 'Description', 'Recorded Date', 'End Date', ''], 
            rows);
    },

    renderVolunteering: function() {
        const items = this.currentMember.volunteering || [];
        const rows = items.length ? items.map(item => `
            <tr>
                <td><input type="checkbox"></td>
                <td><a href="#" onclick="alert('Development in progress')" class="bps-link-blue">${item.status}</a></td>
                <td>${item.type}</td>
                <td>${item.description}</td>
                <td>${item.recordedDate}</td>
                <td></td>
                <td style="text-align:right;"><button style="border:none; bg:none; cursor:pointer;" onclick="alert('Development in progress')"></button></td>
            </tr>
        `).join('') : '<tr><td colspan="7" style="text-align:center; padding:20px;">No volunteering history found.</td></tr>';

        return this.wrapTable('Volunteering History', items.length, 
            ['Status', 'Type', 'Description', 'Recorded Date', 'End Date', ''], 
            rows);
    },

    // Helper to generate the standard table wrapper with search/filters
    // Helper to generate the standard table wrapper with search/filters
    wrapTable: function(title, count, headers, rowsHTML) {
        return `
            <div class="bps-header-row">
                <div class="bps-title">${title} (${count})</div>
                <div class="bps-controls">
                    <div class="search-box" style="width: 250px;">
                        <input type="text" placeholder="Search by Description">
                        <svg style="position: absolute; right: 10px; top: 8px; color: #666;" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M11.742 10.344a6.5 6.5 0 1 0-1.397 1.398h-.001c.03.04.062.078.098.115l3.85 3.85a1 1 0 0 0 1.415-1.414l-3.85-3.85a1.007 1.007 0 0 0-.115-.1zM12 6.5a5.5 5.5 0 1 1-11 0 5.5 5.5 0 0 1 11 0z"/></svg>
                    </div>
                    <button style="border:none; background:none; color:#353182; font-weight:500; display:flex; align-items:center; gap:4px;">
                        <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M6 10.5a.5.5 0 0 1 .5-.5h3a.5.5 0 0 1 0 1h-3a.5.5 0 0 1-.5-.5zm-2-3a.5.5 0 0 1 .5-.5h7a.5.5 0 0 1 0 1h-7a.5.5 0 0 1-.5-.5zm-2-3a.5.5 0 0 1 .5-.5h11a.5.5 0 0 1 0 1h-11a.5.5 0 0 1-.5-.5z"/></svg>
                        Filters
                    </button>
                    <button style="border:none; background:none; color:#666;">Clear Filters</button>
                    <button class="btn btn-primary" onclick="alert('Development in progress')">
                        <svg width="14" height="14" fill="currentColor" viewBox="0 0 16 16" style="margin-right:4px;"><path d="M8 4a.5.5 0 0 1 .5.5v3h3a.5.5 0 0 1 0 1h-3v3a.5.5 0 0 1-1 0v-3h-3a.5.5 0 0 1 0-1h3v-3A.5.5 0 0 1 8 4z"/></svg>
                        Add New
                    </button>
                </div>
            </div>

            <div style="font-size:12px; margin-bottom:12px; display:flex; gap:8px;">
                Active Filters: <span style="background:#f8f9fa; border:1px solid #ddd; padding:2px 8px; border-radius:12px;">Show Active: Yes &times;</span>
            </div>

            <div class="task-table-wrapper">
                <table class="dashboard-table bps-table">
                    <thead>
                        <tr>
                            <th style="width:30px"><input type="checkbox"></th>
                            ${headers.map(h => `<th>${h}</th>`).join('')}
                            <th></th>
                        </tr>
                    </thead>
                    <tbody>
                        ${rowsHTML}
                    </tbody>
                </table>
            </div>
            <div class="pagination" style="margin-top: 16px;">
                <span>Page 1 of 1</span>
                <div><button disabled>&lt;</button><button disabled>&gt;</button></div>
            </div>
        `;
    }
};

// ==========================================
// 7. DATA ENRICHMENT: HEALTH HISTORY
// ==========================================
function generateHealthHistory(members) {
    // --- CLINICAL DICTIONARIES ---
    const diagnosesList = [
        { code: 'E11.9', desc: 'Type 2 diabetes mellitus', type: 'Admitting' },
        { code: 'I10', desc: 'Essential (primary) hypertension', type: 'Principal' },
        { code: 'J45.909', desc: 'Unspecified asthma, uncomplicated', type: 'Secondary' },
        { code: 'M54.5', desc: 'Low back pain', type: 'Admitting' },
        { code: 'F41.1', desc: 'Generalized anxiety disorder', type: 'Secondary' },
        { code: 'E78.5', desc: 'Hyperlipidemia, unspecified', type: 'Principal' }
    ];

    const medicationsList = [
        { name: 'Metformin', dose: '500mg', freq: 'Twice daily' },
        { name: 'Lisinopril', dose: '10mg', freq: 'Daily' },
        { name: 'Atorvastatin', dose: '20mg', freq: 'Daily' },
        { name: 'Albuterol HFA', dose: '90mcg', freq: 'As needed' },
        { name: 'Sertraline', dose: '50mg', freq: 'Daily' },
        { name: 'Gabapentin', dose: '300mg', freq: 'Three times daily' }
    ];

    const labsList = [
        { test: 'Hemoglobin A1c', result: '7.2%', range: '< 5.7%' },
        { test: 'Lipid Panel', result: 'Cholesterol 180', range: '< 200' },
        { test: 'CBC with Diff', result: 'Normal', range: 'N/A' },
        { test: 'Comprehensive Metabolic Panel', result: 'Normal', range: 'N/A' },
        { test: 'TSH', result: '2.5 mIU/L', range: '0.4 - 4.0' }
    ];

    const allergiesList = [
        { name: 'Penicillin', reaction: 'Hives', severity: 'Moderate' },
        { name: 'Peanuts', reaction: 'Anaphylaxis', severity: 'Severe' },
        { name: 'Latex', reaction: 'Rash', severity: 'Mild' },
        { name: 'Sulfa Drugs', reaction: 'Rash', severity: 'Moderate' },
        { name: 'No Known Drug Allergies', reaction: 'N/A', severity: 'N/A' }
    ];

    const immunizationsList = [
        { name: 'Influenza (Flu)', date: '10/15/2024' },
        { name: 'COVID-19 Booster', date: '11/02/2024' },
        { name: 'Tdap', date: '05/20/2023' },
        { name: 'Pneumococcal', date: '09/10/2024' },
        { name: 'Shingles', date: '03/12/2022' }
    ];

    members.forEach(member => {
        // Initialize History Object
        member.healthHistory = {
            adts: [],
            claims: { institutional: [], professional: [] },
            diagnoses: [],
            coreHealth: [],
            medications: [],
            allergies: [],
            labs: [],
            immunizations: []
        };

        // 1. ADTs (3-5 rows)
        const numAdts = 3 + Math.floor(Math.random() * 3);
        for (let i = 0; i < numAdts; i++) {
            member.healthHistory.adts.push({
                date: new Date(Date.now() - (i * 30 * 86400000)).toLocaleString(),
                type: Math.random() > 0.5 ? 'Emergency' : 'Inpatient',
                facility: 'General Hospital',
                diagnosis: diagnosesList[i % diagnosesList.length].desc,
                status: 'Discharged'
            });
        }

        // 2. Claims (3 Institutional, 3 Professional)
        for (let i = 0; i < 3; i++) {
            member.healthHistory.claims.institutional.push({
                id: 'INST-' + (1000 + i),
                provider: 'City Hospital',
                dates: '01/10/2025 - 01/12/2025',
                total: '$' + (Math.floor(Math.random() * 5000) + 1000).toFixed(2),
                status: 'Paid'
            });
            member.healthHistory.claims.professional.push({
                id: 'PROF-' + (5000 + i),
                provider: 'Dr. Smith',
                dates: '02/15/2025',
                total: '$' + (Math.floor(Math.random() * 200) + 50).toFixed(2),
                status: 'Paid'
            });
        }

        // 3. Diagnoses (4-6 rows) based on risk
        const dxCount = member.riskCategory === 'High' ? 6 : 3;
        for (let i = 0; i < dxCount; i++) {
            const dx = diagnosesList[i % diagnosesList.length];
            member.healthHistory.diagnoses.push({
                code: dx.code,
                desc: dx.desc,
                type: dx.type,
                date: new Date(Date.now() - (i * 60 * 86400000)).toLocaleDateString(),
                source: 'Claims'
            });
        }

        // 4. Core Health (Vitals - 5 rows)
        for (let i = 0; i < 5; i++) {
            member.healthHistory.coreHealth.push({
                date: new Date(Date.now() - (i * 14 * 86400000)).toLocaleDateString(),
                bp: (110 + i) + '/' + (70 + i),
                bmi: (24 + (i * 0.2)).toFixed(1),
                weight: (160 + i) + ' lbs',
                pulse: 72 + i
            });
        }

        // 5. Medications (Active list)
        const medCount = member.riskCategory === 'High' ? 5 : 2;
        for (let i = 0; i < medCount; i++) {
            const med = medicationsList[i % medicationsList.length];
            member.healthHistory.medications.push({
                name: med.name,
                dose: med.dose,
                freq: med.freq,
                provider: 'Dr. Smith',
                pharmacy: 'CVS #1234',
                filled: new Date(Date.now() - (i * 10 * 86400000)).toLocaleDateString()
            });
        }

        // 6. Allergies
        const hasAllergy = Math.random() > 0.7;
        if (hasAllergy) {
            member.healthHistory.allergies.push(allergiesList[Math.floor(Math.random() * 4)]);
        } else {
            member.healthHistory.allergies.push(allergiesList[4]); // NKDA
        }

        // 7. Lab Reports
        for (let i = 0; i < 4; i++) {
            const lab = labsList[i % labsList.length];
            member.healthHistory.labs.push({
                test: lab.test,
                result: lab.result,
                range: lab.range,
                date: new Date(Date.now() - (i * 45 * 86400000)).toLocaleDateString(),
                provider: 'LabCorp'
            });
        }

        // 8. Immunizations
        for (let i = 0; i < 4; i++) {
            const imm = immunizationsList[i % immunizationsList.length];
            member.healthHistory.immunizations.push({
                name: imm.name,
                date: imm.date,
                provider: 'Walgreens',
                status: 'Completed'
            });
        }
    });
}

// Run immediately
if (typeof membersDB !== 'undefined') {
    // generateHealthHistory(membersDB); // Disabled - data pre-generated
}

// ==========================================
// 8. HEALTH HISTORY CONTROLLER
// ==========================================
const HealthHistoryController = {
    currentMember: null,
    activeTab: 'adts', 

    render: function(member) {
        this.currentMember = member;
        this.activeTab = 'adts';
        
        // Check consent status
        const consentCheck = requiresConsent(member, 'history');
        if (consentCheck) return consentCheck;
        
        return this.getLayoutHTML();
    },
    getLayoutHTML: function() {
        return `
        <div class="health-history-container" style="padding: 24px;">
            <div class="hh-tabs-wrapper">
                <button class="hh-tab-btn ${this.activeTab === 'adts' ? 'active' : ''}" onclick="HealthHistoryController.switchTab('adts')">ADTs</button>
                <button class="hh-tab-btn ${this.activeTab === 'claims' ? 'active' : ''}" onclick="HealthHistoryController.switchTab('claims')">Claims</button>
                <button class="hh-tab-btn ${this.activeTab === 'diagnoses' ? 'active' : ''}" onclick="HealthHistoryController.switchTab('diagnoses')">Diagnoses</button>
                <button class="hh-tab-btn ${this.activeTab === 'core' ? 'active' : ''}" onclick="HealthHistoryController.switchTab('core')">Core Health Indicators</button>
                <button class="hh-tab-btn ${this.activeTab === 'meds' ? 'active' : ''}" onclick="HealthHistoryController.switchTab('meds')">Medications</button>
                <button class="hh-tab-btn ${this.activeTab === 'allergies' ? 'active' : ''}" onclick="HealthHistoryController.switchTab('allergies')">Allergies</button>
                <button class="hh-tab-btn ${this.activeTab === 'labs' ? 'active' : ''}" onclick="HealthHistoryController.switchTab('labs')">Lab Reports</button>
                <button class="hh-tab-btn ${this.activeTab === 'immunizations' ? 'active' : ''}" onclick="HealthHistoryController.switchTab('immunizations')">Immunizations</button>
            </div>

            <div id="hhContentArea">
                ${this.getContentHTML()}
            </div>
        </div>

        <style>
            .hh-tabs-wrapper {
                display: flex; gap: 4px; margin-bottom: 24px; border-bottom: 1px solid #e1e5e9; overflow-x: auto;
            }
            .hh-tab-btn {
                padding: 10px 16px; border: 1px solid #c2cce2; border-bottom: none; border-radius: 4px 4px 0 0;
                cursor: pointer; font-size: 13px; font-weight: 500; color: white; background: #6da0d8;
                white-space: nowrap; transition: all 0.2s;
            }
            .hh-tab-btn:hover { background: #5a8bc0; }
            .hh-tab-btn.active { background: #353182; color: white; font-weight: 600; border-color: #353182; }
            
            .hh-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; }
            .hh-title { font-size: 18px; font-weight: 400; color: #333; }
            .hh-controls { display: flex; align-items: center; gap: 12px; }
            
            /* Table Header */
            .hh-table thead th { background-color: #353182 !important; color: white !important; font-weight: 500; padding: 12px 16px; }
            .hh-table tbody td { padding: 12px 16px; border-bottom: 1px solid #e9ecef; color: #333; }
            
            .hh-info-box {
                background: #e3f2fd; border: 1px solid #90caf9; color: #0d47a1; padding: 12px;
                border-radius: 4px; margin-bottom: 16px; display: flex; gap: 8px; font-size: 13px;
            }
        </style>
        `;
    },

    switchTab: function(tabName) {
        this.activeTab = tabName;
        document.querySelectorAll('.hh-tab-btn').forEach(btn => {
            // Simple check to toggle active class
            const text = btn.innerText.toLowerCase();
            const map = { 'adts': 'adts', 'claims': 'claims', 'diagnoses': 'diagnoses', 'core': 'core', 'meds': 'medications', 'allergies': 'allergies', 'labs': 'lab', 'immunizations': 'immunizations' };
            btn.classList.toggle('active', text.includes(map[tabName]));
        });
        document.getElementById('hhContentArea').innerHTML = this.getContentHTML();
    },

    getContentHTML: function() {
        const m = this.currentMember.healthHistory;
        switch(this.activeTab) {
            case 'adts': return this.renderTable('List of ADTs', m.adts, ['Event Date', 'Type', 'Facility', 'Diagnosis', 'Acknowledged'], 
                r => `<td>${r.date}</td><td><a href="#">${r.type}</a></td><td>${r.facility}</td><td>${r.diagnosis}</td><td>Yes</td>`);
            
            case 'claims': return this.renderClaims(m.claims);
            
            case 'diagnoses': return this.renderTable('List of Diagnoses', m.diagnoses, ['Code', 'Diagnosis', 'Type', 'Identified Date', 'Source'], 
                r => `<td>${r.code}</td><td>${r.desc}</td><td>${r.type}</td><td>${r.date}</td><td>${r.source}</td>`);
            
            case 'core': return this.renderTable('List of Core Health Indicators', m.coreHealth, ['Date', 'BP', 'BMI', 'Weight', 'Pulse'], 
                r => `<td>${r.date}</td><td><a href="#">${r.bp}</a></td><td>${r.bmi}</td><td>${r.weight}</td><td>${r.pulse}</td>`);
            
            case 'meds': return this.renderTable('List of Medications', m.medications, ['Drug Name', 'Dose', 'Frequency', 'Prescribing MD', 'Pharmacy', 'Last Filled'], 
                r => `<td><a href="#">${r.name}</a></td><td>${r.dose}</td><td>${r.freq}</td><td>${r.provider}</td><td>${r.pharmacy}</td><td>${r.filled}</td>`);
            
            case 'allergies': return this.renderTable('List of Allergies', m.allergies, ['Allergy Name', 'Reaction', 'Severity', 'Recorded Date'], 
                r => `<td><a href="#">${r.name}</a></td><td>${r.reaction}</td><td>${r.severity}</td><td>01/01/2024</td>`);
            
            case 'labs': return this.renderTable('List of Lab Reports', m.labs, ['Test Name', 'Result', 'Ref Range', 'Date', 'Ordered By'], 
                r => `<td><a href="#">${r.test}</a></td><td>${r.result}</td><td>${r.range}</td><td>${r.date}</td><td>${r.provider}</td>`);
            
            case 'immunizations': return this.renderTable('List of Immunizations', m.immunizations, ['Vaccine', 'Date', 'Provider', 'Status'], 
                r => `<td><a href="#">${r.name}</a></td><td>${r.date}</td><td>${r.provider}</td><td>${r.status}</td>`);
            
            default: return 'Loading...';
        }
    },

    // Specific renderer for Claims (2 tables)
    renderClaims: function(claims) {
        const renderSubTable = (title, items) => {
            if (items.length === 0) return `<div class="hh-info-box"> There are no records that meet current criteria</div>`;
            
            const rows = items.map(c => `<tr><td><input type="checkbox"></td><td><a href="#">${c.provider}</a></td><td>${c.dates}</td><td>${c.total}</td><td>${c.status}</td><td></td></tr>`).join('');
            
            return `
                <div style="margin-bottom: 24px;">
                    <h4 style="font-size: 16px; margin-bottom: 12px; color: #333;">${title} (${items.length})</h4>
                    <div class="task-table-wrapper">
                        <table class="dashboard-table hh-table">
                            <thead><tr><th style="width:30px"></th><th>Provider</th><th>Dates of Service</th><th>Total Billed</th><th>Status</th><th></th></tr></thead>
                            <tbody>${rows}</tbody>
                        </table>
                    </div>
                </div>`;
        };

        return `
            <div style="margin-bottom: 16px; color: #666; font-size: 13px;">Claims data is made available upon receipt, and could lag up to 90 days</div>
            ${renderSubTable('List Of Institutional Claims', claims.institutional)}
            ${renderSubTable('List Of Professional Claims', claims.professional)}
        `;
    },

    // Generic Table Renderer
    renderTable: function(title, data, headers, rowTemplateFn) {
        const count = data.length;
        const rows = data.map(item => `
            <tr>
                <td><input type="checkbox"></td>
                ${rowTemplateFn(item)}
                <td style="text-align:right;"><button style="border:none; bg:none; cursor:pointer;"></button></td>
            </tr>
        `).join('');

        return `
            <div class="hh-header">
                <div class="hh-title">${title} (${count})</div>
                <div class="hh-controls">
                    <div class="search-box" style="width: 250px;">
                        <input type="text" placeholder="Search...">
                        <svg style="position: absolute; right: 10px; top: 8px; color: #666;" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M11.742 10.344a6.5 6.5 0 1 0-1.397 1.398h-.001c.03.04.062.078.098.115l3.85 3.85a1 1 0 0 0 1.415-1.414l-3.85-3.85a1.007 1.007 0 0 0-.115-.1zM12 6.5a5.5 5.5 0 1 1-11 0 5.5 5.5 0 0 1 11 0z"/></svg>
                    </div>
                    <button style="border:none; background:none; color:#353182; font-weight:500;">Filter</button>
                    <button class="btn btn-primary" onclick="alert('Development in progress')">
                        <svg width="14" height="14" fill="currentColor" viewBox="0 0 16 16" style="margin-right:4px;"><path d="M8 4a.5.5 0 0 1 .5.5v3h3a.5.5 0 0 1 0 1h-3v3a.5.5 0 0 1-1 0v-3h-3a.5.5 0 0 1 0-1h3v-3A.5.5 0 0 1 8 4z"/></svg>
                        Add New
                    </button>
                </div>
            </div>

            ${count === 0 ? `<div class="hh-info-box"> There are no records that meet current criteria</div>` : ''}

            <div class="task-table-wrapper" style="${count === 0 ? 'display:none;' : ''}">
                <table class="dashboard-table hh-table">
                    <thead>
                        <tr>
                            <th style="width:30px"><input type="checkbox"></th>
                            ${headers.map(h => `<th>${h}</th>`).join('')}
                            <th></th>
                        </tr>
                    </thead>
                    <tbody>${rows}</tbody>
                </table>
            </div>
            ${count > 0 ? `<div class="pagination" style="margin-top: 16px;"><span>Page 1 of 1</span><div><button disabled>&lt;</button><button disabled>&gt;</button></div></div>` : ''}
        `;
    }
};


// ==========================================
// 9. DATA ENRICHMENT: POPULATION INSIGHTS (ENHANCED)
// ==========================================
function generatePopulationData(members) {
    const activeStatus = '<span class="status-badge active" style="background:#dcfce7; color:#166534;">Active</span>';
    const inactiveStatus = '<span class="status-badge inactive" style="background:#fee2e2; color:#991b1b;">Inactive</span>';

    // Data Pools for random history generation
    const historicLOBs = ['Medicaid Direct', 'NC Health Choice', 'AmeriHealth Caritas', 'UnitedHealthcare Community Plan', 'WellCare', 'Healthy Blue'];
    const historicPrograms = ['Smoking Cessation', 'Weight Management', 'Nutritional Counseling', 'Flu Prevention', 'COVID-19 Outreach', 'Post-Discharge Support'];
    const historicPops = ['Social Isolation', 'Transportation Needs', 'Food Insecurity', 'Medication Adherence', 'Fall Risk', 'Housing Instability'];

    // Helper to get a date X months ago
    const getPastDate = (monthsAgo) => {
        const d = new Date();
        d.setMonth(d.getMonth() - monthsAgo);
        return d.toLocaleDateString('en-GB');
    };

    members.forEach(member => {
        member.populationData = {
            priority: [],
            lob: [],
            programs: []
        };

        // --- 1. PRIORITY POPULATIONS (3-5 Rows) ---
        
        // A. Current Active (Logic Based)
        if (member.riskCategory === 'High') {
            member.populationData.priority.push({
                name: 'Complex Case Management',
                source: 'Risk Algorithm',
                identified: getPastDate(1),
                effective: getPastDate(1),
                end: '-',
                status: activeStatus,
                updated: getPastDate(0),
                updatedBy: 'system',
                created: getPastDate(1)
            });
        }
        // Everyone gets a "General" active one
        member.populationData.priority.push({
            name: 'General Monitoring',
            source: 'Enrollment',
            identified: getPastDate(12),
            effective: getPastDate(12),
            end: '-',
            status: activeStatus,
            updated: getPastDate(12),
            updatedBy: 'system',
            created: getPastDate(12)
        });

        // B. Historical (Random 2-3 rows)
        const numHistPop = 2 + Math.floor(Math.random() * 2);
        for(let i=0; i<numHistPop; i++) {
            const popName = historicPops[Math.floor(Math.random() * historicPops.length)];
            member.populationData.priority.push({
                name: popName,
                source: 'Assessment',
                identified: getPastDate(12 + (i*6)),
                effective: getPastDate(12 + (i*6)),
                end: getPastDate(2 + (i*6)),
                status: inactiveStatus,
                updated: getPastDate(2 + (i*6)),
                updatedBy: 'John Manager 12',
                created: getPastDate(12 + (i*6))
            });
        }


        // --- 2. LINE OF BUSINESS (3-4 Rows) ---
        
        // A. Current Active
        member.populationData.lob.push({
            name: member.mco || 'Healthy Blue',
            primary: true,
            status: activeStatus,
            source: 'BA File',
            identified: getPastDate(2),
            effective: getPastDate(2),
            end: '31/12/2026'
        });

        // B. Historical (Random 2-3 rows)
        const numHistLOB = 2 + Math.floor(Math.random() * 2);
        for(let i=0; i<numHistLOB; i++) {
            const lobName = historicLOBs[i % historicLOBs.length]; // Cycle through to avoid duplicates
            // Ensure historical name isn't same as current
            if (lobName !== member.mco) {
                member.populationData.lob.push({
                    name: lobName,
                    primary: false,
                    status: inactiveStatus,
                    source: 'State File',
                    identified: getPastDate(24 + (i*12)),
                    effective: getPastDate(24 + (i*12)),
                    end: getPastDate(3 + (i*12))
                });
            }
        }


        // --- 3. PROGRAMS (3-5 Rows) ---

        // A. Current Active (Condition Based)
        if (member.diagnoses && JSON.stringify(member.diagnoses).includes('Diabetes')) {
            member.populationData.programs.push({
                name: 'Diabetes Management',
                identified: getPastDate(3),
                effective: getPastDate(3),
                end: '-',
                status: activeStatus
            });
        }
        // Random active program
        if (Math.random() > 0.3) {
             member.populationData.programs.push({
                name: 'Telehealth Support',
                identified: getPastDate(1),
                effective: getPastDate(1),
                end: '-',
                status: activeStatus
            });
        }

        // B. Historical (Random 2-3 rows)
        const numHistProg = 2 + Math.floor(Math.random() * 2);
        for(let i=0; i<numHistProg; i++) {
            const progName = historicPrograms[Math.floor(Math.random() * historicPrograms.length)];
            member.populationData.programs.push({
                name: progName,
                identified: getPastDate(18 + (i*4)),
                effective: getPastDate(18 + (i*4)),
                end: getPastDate(6 + (i*4)),
                status: inactiveStatus
            });
        }
    });
}

// Run immediately if DB exists
if (typeof membersDB !== 'undefined') {
    // generatePopulationData(membersDB); // Disabled - data pre-generated
}

// Run immediately if DB exists
if (typeof membersDB !== 'undefined') {
    // generatePopulationData(membersDB); // Disabled - data pre-generated
}

// ==========================================
// 10. POPULATION INSIGHTS CONTROLLER
// ==========================================
const PopulationInsightsController = {
    currentMember: null,
    activeTab: 'priority', // priority, lob, program

    render: function(member) {
        this.currentMember = member;
        // Default to priority tab on load
        this.activeTab = 'priority'; 
        return this.getLayoutHTML();
    },

    getLayoutHTML: function() {
        return `
        <div class="pop-container" style="padding: 24px;">
            <div class="pop-tabs">
                <button class="pop-tab-btn ${this.activeTab === 'priority' ? 'active' : ''}" onclick="PopulationInsightsController.switchTab('priority')">Priority Population</button>
                <button class="pop-tab-btn ${this.activeTab === 'lob' ? 'active' : ''}" onclick="PopulationInsightsController.switchTab('lob')">Line of Business</button>
                <button class="pop-tab-btn ${this.activeTab === 'program' ? 'active' : ''}" onclick="PopulationInsightsController.switchTab('program')">Program</button>
            </div>

            <div id="popContentArea">
                ${this.getContentHTML()}
            </div>
        </div>

        <style>
            .pop-tabs {
                display: flex;
                border-bottom: 2px solid #e1e5e9;
                margin-bottom: 24px;
            }
            .pop-tab-btn {
                padding: 12px 24px;
                background: none;
                border: none;
                border-bottom: 2px solid transparent;
                cursor: pointer;
                font-size: 14px;
                font-weight: 500;
                color: #666;
                transition: all 0.2s;
                margin-bottom: -2px;
            }
            .pop-tab-btn:hover { color: #353182; }
            .pop-tab-btn.active {
                color: #353182;
                border-bottom: 2px solid #353182;
                font-weight: 600;
            }
            .pop-header-row {
                display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;
            }
            .pop-title { font-size: 18px; font-weight: 400; color: #333; }
            .pop-controls { display: flex; align-items: center; gap: 12px; }
            
            /* Toggle Switch Style */
            .toggle-switch {
                position: relative; width: 34px; height: 18px; display: inline-block;
            }
            .toggle-switch input { opacity: 0; width: 0; height: 0; }
            .slider {
                position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0;
                background-color: #ccc; transition: .4s; border-radius: 34px;
            }
            .slider:before {
                position: absolute; content: ""; height: 14px; width: 14px; left: 2px; bottom: 2px;
                background-color: white; transition: .4s; border-radius: 50%;
            }
            input:checked + .slider { background-color: #353182; }
            input:checked + .slider:before { transform: translateX(16px); }

            /* Table Header Override */
            .pop-table thead th {
                background-color: #483d8b !important;
                color: white !important;
                font-weight: 500;
                padding: 12px 16px;
                text-transform: capitalize;
            }
            .pop-table tbody td {
                padding: 12px 16px;
                border-bottom: 1px solid #e9ecef;
                color: #333;
                vertical-align: middle;
            }
        </style>
        `;
    },

    switchTab: function(tabName) {
        this.activeTab = tabName;
        document.querySelectorAll('.pop-tab-btn').forEach(btn => {
            btn.classList.toggle('active', btn.textContent.toLowerCase().replace(/\s/g, '').includes(tabName === 'lob' ? 'lineof' : tabName));
        });
        document.getElementById('popContentArea').innerHTML = this.getContentHTML();
    },

    getContentHTML: function() {
        const m = this.currentMember.populationData;
        if (!m) return '<div>Loading...</div>';

        if (this.activeTab === 'priority') {
            return this.renderPriority(m.priority);
        } else if (this.activeTab === 'lob') {
            return this.renderLOB(m.lob);
        } else {
            return this.renderProgram(m.programs);
        }
    },

    // --- 1. PRIORITY POPULATION RENDERER ---
    renderPriority: function(data) {
        const rows = data.map(row => `
            <tr>
                <td><div style="display:flex; gap:8px; align-items:center;"><svg width="14" height="14" fill="#333" viewBox="0 0 16 16"><path d="M3 14s-1 0-1-1 1-4 6-4 6 3 6 4-1 1-1 1H3zm5-6a3 3 0 1 0 0-6 3 3 0 0 0 0 6z"/></svg><a href="#" class="cta-link">${row.name}</a></div></td>
                <td>${row.source}</td>
                <td>${row.identified}</td>
                <td>${row.effective}</td>
                <td>${row.end}</td>
                <td>${row.status}</td>
                <td>${row.updated}</td>
                <td>${row.updatedBy}</td>
                <td>${row.created}</td>
                <td><button style="border:none; bg:none; cursor:pointer;"></button></td>
            </tr>
        `).join('');

        return this.wrapContent('List of Priority Populations', data.length, 
            ['Priority Population', 'Source', 'Identified Date', 'Effective Date', 'End Date', 'Status', 'Updated On', 'Updated By', 'Created At', ''],
            rows, true); // True enables extra buttons
    },

    // --- 2. LINE OF BUSINESS RENDERER ---
    renderLOB: function(data) {
        const rows = data.map(row => `
            <tr>
                <td><a href="#" class="cta-link">${row.name}</a></td>
                <td>
                    <label class="toggle-switch">
                        <input type="checkbox" ${row.primary ? 'checked' : ''} disabled>
                        <span class="slider"></span>
                    </label>
                </td>
                <td>${row.status}</td>
                <td>${row.source}</td>
                <td>${row.identified}</td>
                <td>${row.effective}</td>
                <td>${row.end}</td>
                <td><button style="border:none; bg:none; cursor:pointer;"></button></td>
            </tr>
        `).join('');

        return this.wrapContent('List of Line of Business', data.length, 
            ['Line of Business', 'Primary', 'Status', 'Source', 'Identified Date', 'Effective Date', 'End Date', ''],
            rows, false);
    },

    // --- 3. PROGRAM RENDERER ---
    renderProgram: function(data) {
        const rows = data.map(row => `
            <tr>
                <td>${row.name}</td>
                <td>${row.identified}</td>
                <td>${row.effective}</td>
                <td>${row.end}</td>
                <td>${row.status}</td>
                <td><button style="border:none; bg:none; cursor:pointer;"></button></td>
            </tr>
        `).join('');

        return this.wrapContent('List of Programs', data.length, 
            ['Program', 'Identified Date', 'Effective Date', 'End Date', 'Status', ''],
            rows, false);
    },

    // Standard Layout Wrapper
    wrapContent: function(title, count, headers, rows, showExtraButtons) {
        return `
            <div class="pop-header-row">
                <div class="pop-title">${title} (${count})</div>
                <div class="pop-controls">
                    <div class="search-box" style="width: 250px;">
                        <input type="text" placeholder="Search ${title}...">
                        <svg style="position: absolute; right: 10px; top: 8px; color: #666;" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M11.742 10.344a6.5 6.5 0 1 0-1.397 1.398h-.001c.03.04.062.078.098.115l3.85 3.85a1 1 0 0 0 1.415-1.414l-3.85-3.85a1.007 1.007 0 0 0-.115-.1zM12 6.5a5.5 5.5 0 1 1-11 0 5.5 5.5 0 0 1 11 0z"/></svg>
                    </div>
                    <button style="border:none; background:none; color:#353182; font-weight:500; display:flex; align-items:center; gap:4px;">
                        <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M6 10.5a.5.5 0 0 1 .5-.5h3a.5.5 0 0 1 0 1h-3a.5.5 0 0 1-.5-.5zm-2-3a.5.5 0 0 1 .5-.5h7a.5.5 0 0 1 0 1h-7a.5.5 0 0 1-.5-.5zm-2-3a.5.5 0 0 1 .5-.5h11a.5.5 0 0 1 0 1h-11a.5.5 0 0 1-.5-.5z"/></svg>
                        Filter
                    </button>
                    ${showExtraButtons ? `
                        <button class="btn btn-primary" style="padding:6px 12px;">Add New</button>
                        <button class="btn btn-secondary" style="padding:6px 12px;">Save This View</button>
                        <button class="btn btn-secondary" style="padding:6px 12px;">Reset View</button>
                    ` : ''}
                </div>
            </div>

            <div class="task-table-wrapper">
                <table class="dashboard-table pop-table">
                    <thead>
                        <tr>
                            ${headers.map(h => `<th>${h}</th>`).join('')}
                        </tr>
                    </thead>
                    <tbody>
                        ${rows}
                    </tbody>
                </table>
            </div>
            <div class="pagination" style="margin-top: 16px;">
                <span>Page 1 of 1</span>
                <div><button disabled>&lt;</button><button disabled>&gt;</button></div>
            </div>
        `;
    }
};


// ==========================================
// 11. DATA ENRICHMENT: ACTIVITY HISTORY
// ==========================================
function generateActivityHistory(members) {
    // Helper for random past dates
    const getPastDate = (daysAgo) => {
        const d = new Date();
        d.setDate(d.getDate() - daysAgo);
        return d.toLocaleDateString('en-GB'); // DD/MM/YYYY
    };

    // Service Note Options
    const snTypes = ['Care Coordination', 'Assessment', 'Outreach', 'Care Plan Review', 'General Note'];
    const users = ['John Manager 1', 'Sarah Wilson', 'Aziz Gida', 'System', 'Heather Thompson'];
    const snStatus = ['Draft', 'Posted', 'Signed'];

    // Event Options
    const evtNames = ['PC2', 'P11', 'PC3', 'ADT Admission', 'Assessment Completed', 'Task Created', 'Consent Logged'];
    
    // Referral Options
    const refReasons = ['Cardiology Consult', 'Housing Assistance', 'Transportation', 'Physical Therapy', 'Food Bank', 'Mental Health Services'];
    const refStatuses = ['Pending', 'Accepted', 'Failed', 'Completed'];

    members.forEach(member => {
        member.activityHistory = {
            serviceNotes: [],
            events: [],
            referrals: []
        };

        // 1. Service Notes (5-8 unique notes)
        const numNotes = 5 + Math.floor(Math.random() * 4);
        for(let i=0; i<numNotes; i++) {
            const date = getPastDate(i * 5 + 1);
            member.activityHistory.serviceNotes.push({
                id: (8400 + i + Math.floor(Math.random()*100)).toString(),
                staff: users[Math.floor(Math.random() * users.length)],
                type: 'Other',
                activity: snTypes[Math.floor(Math.random() * snTypes.length)],
                duration: Math.floor(Math.random() * 45) + 5,
                date: date,
                submitted: date,
                status: i === 0 ? 'Draft' : 'Posted', // Most recent might be draft
                version: 1,
                purpose: 'Follow-up',
                intervention: 'Education',
                effectiveness: 'Effective'
            });
        }

        // 2. Events (3-6 events)
        const numEvents = 3 + Math.floor(Math.random() * 4);
        for(let i=0; i<numEvents; i++) {
            const date = getPastDate(i * 10 + 2);
            member.activityHistory.events.push({
                name: evtNames[Math.floor(Math.random() * evtNames.length)],
                owner: users[Math.floor(Math.random() * users.length)],
                status: 'New',
                priority: 'Critical',
                deadline: date + ' 05:30',
                start: date + ' 05:30'
            });
        }

        // 3. Referrals (2-4 referrals)
        const numRefs = 2 + Math.floor(Math.random() * 3);
        for(let i=0; i<numRefs; i++) {
            member.activityHistory.referrals.push({
                id: (25 + i + Math.floor(Math.random()*50)).toString(),
                type: 'Other',
                reason: refReasons[Math.floor(Math.random() * refReasons.length)],
                recipient: (Math.floor(Math.random() * 900) + 100) + ' Medical Drive',
                status: refStatuses[Math.floor(Math.random() * refStatuses.length)],
                sentDate: getPastDate(i * 15 + 5)
            });
        }
    });
}

// Run immediately
if (typeof membersDB !== 'undefined') {
    // generateActivityHistory(membersDB); // Disabled - data pre-generated
}

// ==========================================
// 12. ACTIVITY HISTORY CONTROLLER
// ==========================================
const ActivityHistoryController = {
    currentMember: null,
    activeTab: 'notes', // notes, events, referrals

    render: function(member) {
        this.currentMember = member;
        this.activeTab = 'notes'; // Default tab
        return this.getLayoutHTML();
    },

    getLayoutHTML: function() {
        return `
        <div class="act-container" style="padding: 24px;">
            <div class="act-tabs">
                <button class="act-tab-btn ${this.activeTab === 'notes' ? 'active' : ''}" onclick="ActivityHistoryController.switchTab('notes')">Service Notes</button>
                <button class="act-tab-btn ${this.activeTab === 'events' ? 'active' : ''}" onclick="ActivityHistoryController.switchTab('events')">Events</button>
                <button class="act-tab-btn ${this.activeTab === 'referrals' ? 'active' : ''}" onclick="ActivityHistoryController.switchTab('referrals')">Referrals</button>
            </div>

            <div id="actContentArea">
                ${this.getContentHTML()}
            </div>
        </div>

        <style>
            .act-tabs { display: flex; gap: 4px; margin-bottom: 24px; }
            .act-tab-btn {
                padding: 8px 16px; background: #6da0d8; color: white; border: none; border-radius: 4px;
                cursor: pointer; font-size: 13px; font-weight: 500; transition: all 0.2s;
            }
            .act-tab-btn.active { background: #353182; }
            .act-tab-btn:hover { opacity: 0.9; }
            
            .act-header-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; }
            .act-title { font-size: 18px; font-weight: 400; color: #333; margin: 0; }
            
            /* Enforce Table Styles */
            .act-table thead th { background-color: #483d8b !important; color: white !important; padding: 12px 16px; font-weight: 500; font-size: 13px; }
            .act-table tbody td { padding: 12px 16px; border-bottom: 1px solid #e9ecef; color: #333; font-size: 13px; }
        </style>
        `;
    },

    switchTab: function(tabName) {
        this.activeTab = tabName;
        document.querySelectorAll('.act-tab-btn').forEach(btn => {
            btn.classList.toggle('active', btn.textContent.toLowerCase().includes(tabName.slice(0,4)));
        });
        document.getElementById('actContentArea').innerHTML = this.getContentHTML();
    },

    getContentHTML: function() {
        const m = this.currentMember.activityHistory;
        if (this.activeTab === 'notes') return this.renderNotes(m.serviceNotes);
        if (this.activeTab === 'events') return this.renderEvents(m.events);
        return this.renderReferrals(m.referrals);
    },

    renderNotes: function(data) {
        const rows = data.map(r => `
            <tr>
                <td><a href="#" class="cta-link">${r.id}</a></td>
                <td>${r.staff}</td>
                <td>${r.type}</td>
                <td>${r.activity}</td>
                <td>${r.duration}</td>
                <td>${r.date}</td>
                <td>${r.submitted}</td>
                <td>${r.status}</td>
                <td>${r.version}</td>
                <td>${r.purpose}</td>
                <td><button style="border:none; bg:none; cursor:pointer;"></button></td>
            </tr>
        `).join('');

        return this.wrapTable('List of Service Notes', data.length, 
            ['Note ID', 'Staff Member', 'Contact Type', 'Related Activity', 'Duration', 'Date of Service', 'Submitted At', 'Note Status', 'Version', 'Purpose', ''], 
            rows);
    },

    renderEvents: function(data) {
        const rows = data.map(r => `
            <tr>
                <td><input type="checkbox"></td>
                <td><a href="#" class="cta-link">${r.name}</a></td>
                <td>${r.owner}</td>
                <td></td> <td>${r.status}</td>
                <td>${r.priority}</td>
                <td>${r.deadline}</td>
                <td>${r.start}</td>
                <td><button style="border:none; bg:none; cursor:pointer;"></button></td>
            </tr>
        `).join('');

        return this.wrapTable('List of Events', data.length,
            ['', 'Activity Name', 'Activity Owner', 'Responsible Party', 'Activity Status', 'Activity Priority', 'Deadline', 'Start Time/Date', ''],
            rows);
    },

    renderReferrals: function(data) {
        const rows = data.map(r => `
            <tr>
                <td><a href="#" class="cta-link">${r.id}</a></td>
                <td>${r.type}</td>
                <td>${r.reason}</td>
                <td>${r.recipient}</td>
                <td></td> <td>${r.status}</td>
                <td>${r.sentDate}</td>
                <td><button style="border:none; bg:none; cursor:pointer;"></button></td>
            </tr>
        `).join('');

        return this.wrapTable('List of Referrals', data.length,
            ['Referral ID', 'Request Type', 'Referral Reason', 'Referral Recipient Name', 'Recipient Taxonomy', 'Status', 'Date Sent', ''],
            rows);
    },

    wrapTable: function(title, count, headers, rows) {
        return `
            <div class="act-header-row">
                <h3 class="act-title">${title} (${count})</h3>
                <div style="display:flex; gap:12px; align-items:center;">
                    <div class="search-box" style="width: 300px;">
                        <input type="text" placeholder="Search ${title}...">
                        <svg style="position: absolute; right: 10px; top: 8px; color: #666;" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M11.742 10.344a6.5 6.5 0 1 0-1.397 1.398h-.001c.03.04.062.078.098.115l3.85 3.85a1 1 0 0 0 1.415-1.414l-3.85-3.85a1.007 1.007 0 0 0-.115-.1zM12 6.5a5.5 5.5 0 1 1-11 0 5.5 5.5 0 0 1 11 0z"/></svg>
                    </div>
                    <button class="btn btn-secondary" style="display:flex; align-items:center; gap:4px;"><svg width="14" height="14" fill="currentColor" viewBox="0 0 16 16"><path d="M6 10.5a.5.5 0 0 1 .5-.5h3a.5.5 0 0 1 0 1h-3a.5.5 0 0 1-.5-.5zm-2-3a.5.5 0 0 1 .5-.5h7a.5.5 0 0 1 0 1h-7a.5.5 0 0 1-.5-.5zm-2-3a.5.5 0 0 1 .5-.5h11a.5.5 0 0 1 0 1h-11a.5.5 0 0 1-.5-.5z"/></svg> Filters</button>
                    <button class="btn btn-secondary" style="display:flex; align-items:center; gap:4px;"><svg width="14" height="14" fill="currentColor" viewBox="0 0 16 16"><path d="M2.5 1a1 1 0 0 0-1 1v1a1 1 0 0 0 1 1H3v9a2 2 0 0 0 2 2h6a2 2 0 0 0 2-2V4h.5a1 1 0 0 0 1-1V2a1 1 0 0 0-1-1H10a1 1 0 0 0-1-1H7a1 1 0 0 0-1 1H2.5zm3 4a.5.5 0 0 1 .5.5v7a.5.5 0 0 1-1 0v-7a.5.5 0 0 1 .5-.5zM8 5a.5.5 0 0 1 .5.5v7a.5.5 0 0 1-1 0v-7A.5.5 0 0 1 8 5zm3 .5v7a.5.5 0 0 1-1 0v-7a.5.5 0 0 1 1 0z"/></svg> Clear Filters</button>
                    <button class="btn btn-primary" onclick="alert('Development in progress')">+ Add New</button>
                </div>
            </div>
            
            <div class="task-table-wrapper">
                <table class="dashboard-table act-table">
                    <thead>
                        <tr>
                            ${headers.map(h => `<th>${h}</th>`).join('')}
                        </tr>
                    </thead>
                    <tbody>${rows}</tbody>
                </table>
            </div>
            <div class="pagination" style="margin-top: 16px;">
                <span>Page 1 of 1</span>
                <div><button disabled>&lt;</button><button disabled>&gt;</button></div>
            </div>
        `;
    }
};


// ==========================================
// 13. DATA ENRICHMENT: CARE TEAM
// ==========================================
function generateCareTeamData(members) {
    // Helpers
    const getPastDate = (days) => {
        const d = new Date();
        d.setDate(d.getDate() - days);
        return d.toLocaleDateString('en-GB');
    };
    const getFutureDate = (days) => {
        const d = new Date();
        d.setDate(d.getDate() + days);
        return d.toLocaleDateString('en-GB');
    };

    // Data Pools
    const providerNames = ['Wayne Heart & Internal Medicine', 'Duke Primary Care', 'UNC Family Medicine', 'WakeMed Physicians', 'City Health Clinic'];
    const doctorNames = ['Dr. Sarah Jenks', 'Dr. Michael Chen', 'Dr. Emily Stones', 'Dr. Robert Key', 'Dr. Lisa Ray'];
    const staffNames = ['Super Test Child', 'Dhanya Supervisor', 'AYN 2 Referral Manager', 'Jason Chesko', 'Heather Thompson', 'Aziz CM'];
    const relationTypes = ['Husband', 'Wife', 'Daughter', 'Son', 'Mother', 'Father', 'Friend', 'Neighbor'];
    const covenantTypes = ['Consent', 'Advanced Directive', 'Power of Attorney'];

    members.forEach(member => {
        member.careTeamData = {
            pcp: {},
            members: [],
            relatedPersons: [],
            covenants: []
        };

        // 1. Primary Care Provider (PCP) - Unique per member
        member.careTeamData.pcp = {
            groupName: providerNames[Math.floor(Math.random() * providerNames.length)],
            source: 'Leap',
            startDate: getPastDate(365 + Math.floor(Math.random() * 500)),
            endDate: '31/12/9999',
            providerName: doctorNames[Math.floor(Math.random() * doctorNames.length)],
            address: 'Data not provided',
            phone: 'Data not provided'
        };

        // 2. Care Team Members (3-5 rows)
        const numMembers = 3 + Math.floor(Math.random() * 3);
        for(let i=0; i<numMembers; i++) {
            const isProvider = Math.random() > 0.6;
            member.careTeamData.members.push({
                sourceType: isProvider ? 'Provider' : 'Employee',
                name: isProvider ? doctorNames[Math.floor(Math.random() * doctorNames.length)] : staffNames[Math.floor(Math.random() * staffNames.length)],
                type: isProvider ? 'PCP' : 'Care Manager',
                status: 'Active',
                start: getPastDate(i * 30 + 10),
                end: '',
                incept: getPastDate(i * 30 + 10)
            });
        }

        // 3. Related Persons (3-4 rows)
        const numRelated = 3 + Math.floor(Math.random() * 2);
        for(let i=0; i<numRelated; i++) {
            const rel = relationTypes[Math.floor(Math.random() * relationTypes.length)];
            member.careTeamData.relatedPersons.push({
                name: `${rel} of ${member.name.split(' ')[0]}`, // e.g. "Husband of King"
                relationship: rel,
                responsible: Math.random() > 0.5 ? 'Yes' : 'No',
                guardian: Math.random() > 0.8 ? 'Yes' : 'No',
                emergency: Math.random() > 0.5 ? 'Yes' : 'No',
                primary: i === 0 ? 'Yes' : 'No',
                language: 'English',
                phone: `555-010-${10 + i}`,
                modifiedOn: getPastDate(i * 10),
                modifiedBy: 'super_admin'
            });
        }

        // 4. Covenants (2-3 rows)
        const numCov = 2 + Math.floor(Math.random() * 2);
        for(let i=0; i<numCov; i++) {
            member.careTeamData.covenants.push({
                name: `${member.name.split(' ')[0]} ${covenantTypes[i % covenantTypes.length]}`,
                description: 'Authorized release of information',
                status: 'Authorized',
                type: covenantTypes[i % covenantTypes.length],
                created: getPastDate(100 + i*20) + ' 15:40',
                start: getPastDate(100 + i*20),
                end: ''
            });
        }
    });
}

// Run immediately
if (typeof membersDB !== 'undefined') {
    // generateCareTeamData(membersDB); // Disabled - data pre-generated
}

// ==========================================
// 14. CARE TEAM CONTROLLER
// ==========================================
const CareTeamController = {
    currentMember: null,
    activeTab: 'careteam', // careteam, related, covenants

    render: function(member) {
        this.currentMember = member;
        this.activeTab = 'careteam';
        return this.getLayoutHTML();
    },

    getLayoutHTML: function() {
        return `
        <div class="ct-container" style="padding: 24px;">
            <div class="ct-tabs">
                <button class="ct-tab-btn ${this.activeTab === 'careteam' ? 'active' : ''}" onclick="CareTeamController.switchTab('careteam')">Care Team</button>
                <button class="ct-tab-btn ${this.activeTab === 'related' ? 'active' : ''}" onclick="CareTeamController.switchTab('related')">Related Persons</button>
                <button class="ct-tab-btn ${this.activeTab === 'covenants' ? 'active' : ''}" onclick="CareTeamController.switchTab('covenants')">Covenants</button>
            </div>

            <div id="ctContentArea">
                ${this.getContentHTML()}
            </div>
        </div>

        <style>
            .ct-tabs { display: flex; gap: 4px; margin-bottom: 24px; }
            .ct-tab-btn {
                padding: 8px 16px; background: #6da0d8; color: white; border: none; border-radius: 4px;
                cursor: pointer; font-size: 13px; font-weight: 500; transition: all 0.2s;
            }
            .ct-tab-btn.active { background: #353182; }
            .ct-tab-btn:hover { opacity: 0.9; }
            
            .ct-header-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; }
            .ct-title { font-size: 18px; font-weight: 400; color: #333; margin: 0; }
            .ct-section-title { font-size: 16px; color: #333; border-bottom: 1px solid #333; display: inline-block; margin-bottom: 16px; padding-bottom: 4px; }
            
            /* PCP Table Specifics */
            .pcp-container { border: 1px solid #e1e5e9; border-radius: 4px; padding: 16px; background: #fafbfc; margin-bottom: 30px; }
            .pcp-table th { background: #484581; color: white; padding: 8px; font-size: 12px; text-align: left; }
            .pcp-table td { padding: 12px 8px; border-bottom: 1px solid #ddd; font-size: 13px; color: #333; vertical-align: top; }
            
            /* General Table */
            .ct-table thead th { background-color: #483d8b !important; color: white !important; padding: 12px 16px; font-weight: 500; font-size: 13px; }
            .ct-table tbody td { padding: 12px 16px; border-bottom: 1px solid #e9ecef; color: #333; font-size: 13px; }
        </style>
        `;
    },

    switchTab: function(tabName) {
        this.activeTab = tabName;
        document.querySelectorAll('.ct-tab-btn').forEach(btn => {
            btn.classList.toggle('active', btn.textContent.toLowerCase().replace(' ', '').includes(tabName));
        });
        document.getElementById('ctContentArea').innerHTML = this.getContentHTML();
    },

    getContentHTML: function() {
        const m = this.currentMember.careTeamData;
        if (this.activeTab === 'careteam') return this.renderCareTeam(m);
        if (this.activeTab === 'related') return this.renderRelated(m.relatedPersons);
        return this.renderCovenants(m.covenants);
    },

    renderCareTeam: function(data) {
        // PCP Section
        const pcp = data.pcp;
        const pcpHTML = `
            <div class="pcp-container">
                <div class="ct-section-title">Primary Care Provider (PCP)</div>
                <h4 style="margin: 10px 0; font-weight:400; font-size:16px;">Current PCP</h4>
                <table style="width:100%; border-collapse:collapse;" class="pcp-table">
                    <thead><tr><th>Group Name</th><th>Source</th><th>Start Date</th><th>End Date</th><th>Service Provider Name</th><th>Address</th><th>Phone Number</th><th>Practitioner Name</th></tr></thead>
                    <tbody>
                        <tr>
                            <td>${pcp.groupName}</td><td>${pcp.source}</td><td>${pcp.startDate}</td><td>${pcp.endDate}</td>
                            <td>${pcp.groupName}</td><td>${pcp.address}</td><td>${pcp.phone}</td><td>${pcp.providerName || ''}</td>
                        </tr>
                    </tbody>
                </table>
                <div style="margin-top:12px;"><a href="#" class="cta-link">View PCP History</a></div>
            </div>
        `;

        // Care Team List
        const members = data.members || [];
        const rows = members.map(r => `
            <tr>
                <td><input type="checkbox"></td>
                <td>${r.sourceType}</td>
                <td><a href="#" class="cta-link">${r.name}</a></td>
                <td>${r.type}</td>
                <td>${r.status}</td>
                <td>${r.start}</td>
                <td>${r.end}</td>
                <td>${r.incept}</td>
                <td><button style="border:none; bg:none; cursor:pointer;"></button></td>
            </tr>
        `).join('');

        const listHTML = this.wrapTable('List of Care Team Members', members.length, 
            ['Care Team Member Source Type', 'Care Team Member Name', 'Care Team Member Type', 'Care Team Member Status', 'Start Date', 'End Date', 'Incept Date', ''], 
            rows);

        return pcpHTML + listHTML;
    },

    renderRelated: function(data) {
        const rows = data.map(r => `
            <tr>
                <td><input type="checkbox"></td>
                <td><a href="#" class="cta-link">${r.name}</a></td>
                <td>${r.relationship}</td>
                <td>${r.responsible}</td>
                <td>${r.guardian}</td>
                <td>${r.emergency}</td>
                <td>${r.primary}</td>
                <td>${r.language}</td>
                <td>${r.phone}</td>
                <td>${r.modifiedOn}</td>
                <td>${r.modifiedBy}</td>
                <td><button style="border:none; bg:none; cursor:pointer;"></button></td>
            </tr>
        `).join('');

        return this.wrapTable('List of Related Persons', data.length,
            ['Name', 'Member Relationship', 'Responsible Party', 'Guardian', 'Emergency Contact', 'Relationship Primary', 'Preferred Language', 'Phone Number', 'Modified On', 'Modified By', ''],
            rows);
    },

    renderCovenants: function(data) {
        const rows = data.map(r => `
            <tr>
                <td><input type="checkbox"></td>
                <td><a href="#" class="cta-link">${r.name}</a></td>
                <td>${r.description}</td>
                <td>${r.status}</td>
                <td>${r.type}</td>
                <td>${r.created}</td>
                <td>${r.start}</td>
                <td></td> <td>${r.end}</td>
                <td><button style="border:none; bg:none; cursor:pointer;"></button></td>
            </tr>
        `).join('');

        return this.wrapTable('List of Covenants', data.length,
            ['Name', 'Description', 'Covenant Status', 'Covenant Type', 'Created On', 'Start Date', 'Expiry Date', 'End Date', ''],
            rows);
    },

    wrapTable: function(title, count, headers, rows) {
        return `
            <div class="act-header-row">
                <h3 class="act-title">${title} (${count})</h3>
                <div style="display:flex; gap:12px; align-items:center;">
                    <div class="search-box" style="width: 250px;">
                        <input type="text" placeholder="Search ${title}...">
                        <svg style="position: absolute; right: 10px; top: 8px; color: #666;" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M11.742 10.344a6.5 6.5 0 1 0-1.397 1.398h-.001c.03.04.062.078.098.115l3.85 3.85a1 1 0 0 0 1.415-1.414l-3.85-3.85a1.007 1.007 0 0 0-.115-.1zM12 6.5a5.5 5.5 0 1 1-11 0 5.5 5.5 0 0 1 11 0z"/></svg>
                    </div>
                    <button class="btn btn-secondary" style="display:flex; align-items:center; gap:4px;"><svg width="14" height="14" fill="currentColor" viewBox="0 0 16 16"><path d="M6 10.5a.5.5 0 0 1 .5-.5h3a.5.5 0 0 1 0 1h-3a.5.5 0 0 1-.5-.5zm-2-3a.5.5 0 0 1 .5-.5h7a.5.5 0 0 1 0 1h-7a.5.5 0 0 1-.5-.5zm-2-3a.5.5 0 0 1 .5-.5h11a.5.5 0 0 1 0 1h-11a.5.5 0 0 1-.5-.5z"/></svg> Filters</button>
                    <button class="btn btn-secondary" style="display:flex; align-items:center; gap:4px;">Clear Filters</button>
                    <button class="btn btn-primary" onclick="alert('Development in progress')">+ Add New</button>
                </div>
            </div>
            
            <div style="font-size:13px; margin-bottom:12px;">Active Filters: <svg width="12" height="12" fill="currentColor" viewBox="0 0 16 16"><path d="M2 2a2 2 0 0 1 2-2h8a2 2 0 0 1 2 2v13.5a.5.5 0 0 1-.777.416L8 13.101l-5.223 2.815A.5.5 0 0 1 2 15.5V2zm2-1a1 1 0 0 0-1 1v12.566l4.723-2.482a.5.5 0 0 1 .554 0L13 14.566V2a1 1 0 0 0-1-1H4z"/></svg></div>

            <div class="task-table-wrapper">
                <table class="dashboard-table ct-table">
                    <thead>
                        <tr>
                            <th style="width:30px"><input type="checkbox"></th>
                            ${headers.map(h => `<th>${h}</th>`).join('')}
                            <th></th>
                        </tr>
                    </thead>
                    <tbody>${rows}</tbody>
                </table>
            </div>
            <div class="pagination" style="margin-top: 16px;">
                <span>Page 1 of 1</span>
                <div><button disabled>&lt;</button><button disabled>&gt;</button></div>
            </div>
        `;
    }
};


// ==========================================
// 15. DATA ENRICHMENT: CARE PLANS (HIERARCHICAL - FINAL)
// ==========================================
function generateCarePlanData(members) {
    const getFutureDate = (days) => {
        const d = new Date();
        d.setDate(d.getDate() + days);
        return d.toLocaleDateString('en-GB');
    };
    const getPastDate = (days) => {
        const d = new Date();
        d.setDate(d.getDate() - days);
        return d.toLocaleDateString('en-GB');
    };

    const needsLibrary = [
        { cat: 'Care Coordination, Management, & Clinical Need', text: 'The member needs help getting treatment for Allergies.' },
        { cat: 'Coordination & Support Assistance', text: 'The member needs help with ADLs.' },
        { cat: 'Financials / Benefits', text: "The member's current insurance/benefit plan does not cover the needed services." },
        { cat: 'Individual and Family Supports', text: 'Evaluate / Re-evaluate the member\'s guardian.' },
        { cat: 'Care Coordination, Management, & Clinical Need', text: 'The member needs help getting treatment for Arthritis or pain in joints.' }
    ];

    const consentedStatuses = ['Consented', 'Re-consent Required'];

    members.forEach(member => {
        // Initialize with empty structure for ALL members
        member.carePlanData = {
            needs: [],
            activity: [],
            barriers: [],
            gaps: []
        };

        // ONLY generate data for CONSENTED members
        if (!consentedStatuses.includes(member.consentStatus)) {
            // Non-consented members get empty data - this is correct business logic
            return;
        }

        // Check if member has active care plan status
        const hasActiveCPStatus = member.assessmentStatus === 'Completed' || 
                                   member.carePlanStatus === 'Active' || 
                                   member.carePlanStatus === 'In Progress';
        
        // Only generate care plan data if member should have it
        if (!hasActiveCPStatus && Math.random() > 0.7) {
            // Some consented members may not have care plans yet
            return;
        }

        // Generate needs based on member's diagnoses
        const numNeeds = 2 + Math.floor(Math.random() * 3); 
        
        for(let n=0; n < numNeeds; n++) {
            const template = needsLibrary[n % needsLibrary.length];
            const needId = `need-${member.id}-${n}`;
            const startDate = getPastDate(Math.floor(Math.random() * 60) + 10);
            
            let needObj = {
                id: needId,
                text: template.text,
                category: template.cat,
                status: ['Identified', 'In Progress'][Math.floor(Math.random()*2)],
                startDate: startDate,
                daysToFollowUp: Math.floor(Math.random() * 20) + 5,
                followUpDate: getFutureDate(Math.floor(Math.random() * 20) + 5),
                goals: []
            };

            // Generate 1-2 goals per need
            const numGoals = 1 + Math.floor(Math.random() * 2);
            for(let g=0; g < numGoals; g++) {
                const goalId = `${needId}-goal-${g}`;
                let goalObj = {
                    id: goalId,
                    text: `Goal ${g+1}: Improve management of ${template.cat.split(' ')[0]} symptoms`,
                    status: ['In Progress', 'Met'][Math.floor(Math.random()*2)],
                    startDate: startDate,
                    targetDate: getFutureDate(60 + g*30),
                    completedDate: Math.random() > 0.6 ? getPastDate(Math.floor(Math.random()*10)) : '-',
                    outcome: Math.random() > 0.6 ? 'On Track' : '-',
                    interventions: []
                };

                // Generate 2-3 interventions per goal
                const numInterventions = 2 + Math.floor(Math.random() * 2);
                for(let i=0; i < numInterventions; i++) {
                    goalObj.interventions.push({
                        id: `${goalId}-int-${i}`,
                        text: `Intervention ${i+1}: Coordinate with provider regarding ${template.cat.split(' ')[0]}`,
                        status: ['Planned', 'In Progress', 'Completed'][Math.floor(Math.random()*3)],
                        owner: member.careManager || 'Care Manager',
                        dueDate: getFutureDate(i * 14 + 7)
                    });
                }
                needObj.goals.push(goalObj);
            }
            member.carePlanData.needs.push(needObj);
        }
        
        // Generate activity log for consented members with care plans
        if (member.carePlanData.needs.length > 0) {
            member.carePlanData.activity = [
                {name: 'Care Plan Created', status: 'Done', date: getPastDate(45), updatedBy: member.careManager || 'System'},
                {name: 'Needs Assessment', status: 'Done', date: getPastDate(30), updatedBy: member.careManager || 'System'},
                {name: 'Goal Review', status: 'Done', date: getPastDate(14), updatedBy: member.careManager || 'System'}
            ];
            
            // Add barriers for some members
            if (Math.random() > 0.5) {
                member.carePlanData.barriers = [
                    {category: 'Social', name: 'Transportation', description: 'Limited access to reliable transportation', status: 'Active'},
                    {category: 'Financial', name: 'Medication Cost', description: 'Difficulty affording co-pays', status: 'Monitoring'}
                ];
            }
            
            // Add care gaps for some members
            if (Math.random() > 0.6) {
                member.carePlanData.gaps = [
                    {measure: 'HbA1c', desc: 'Overdue diabetes screening', status: 'Open', identified: getPastDate(20)},
                    {measure: 'Annual Wellness', desc: 'Annual wellness visit needed', status: 'Open', identified: getPastDate(10)}
                ];
            }
        }
    });
}

// Run on page load - Generate care plan data for consented members only
if (typeof membersDB !== 'undefined') {
    // generateCarePlanData(membersDB); // Disabled - data pre-generated
}

// ==========================================
// 16. CARE PLAN CONTROLLER (FINAL LAYOUT)
// ==========================================
const CarePlanController = {
    currentMember: null,
    activeTab: 'needs',
    // For care plan detail view
    activePlanDetail: null,     // plan object when drilling into a plan
    activePlanSubTab: 'details', // 'details' | 'needs' | 'crisis'

    render: function(member) {
        this.currentMember = member;
        this.activeTab = 'needs';
        this.activePlanDetail = null;
        const consentedStatuses = ['Consented', 'Re-consent Required'];
        if (!consentedStatuses.includes(member.consentStatus)) {
            return `<div style="padding:40px;text-align:center;">
                <div style="font-size:48px;margin-bottom:16px;"></div>
                <h3 style="color:#353182;margin-bottom:8px;">Consent Required</h3>
                <p style="color:#666;max-width:400px;margin:0 auto;">
                    Care plan information is not available for this member.<br>
                    Current consent status: <strong style="color:#ff8c00;">${member.consentStatus}</strong>
                </p>
                <p style="color:#999;font-size:13px;margin-top:16px;">Please obtain member consent before accessing care plan data.</p>
            </div>`;
        }
        return this.getLayoutHTML();
    },

    getLayoutHTML: function() {
        return `
        <div class="cp-container" style="padding:24px;">
            <div class="cp-tabs">
                <button class="cp-tab-btn ${this.activeTab==='needs'?'active':''}" onclick="CarePlanController.switchTab('needs')">Needs Planning</button>
                <button class="cp-tab-btn ${this.activeTab==='activity'?'active':''}" onclick="CarePlanController.switchTab('activity')">Care Plan Activity</button>
                <button class="cp-tab-btn ${this.activeTab==='barriers'?'active':''}" onclick="CarePlanController.switchTab('barriers')">Barriers & Strengths</button>
                <button class="cp-tab-btn ${this.activeTab==='gaps'?'active':''}" onclick="CarePlanController.switchTab('gaps')">Care Gaps</button>
            </div>
            <div id="cpContentArea">${this.getContentHTML()}</div>
        </div>
        <style>
            .cp-tabs { display:flex; border-bottom:2px solid #e1e5e9; margin-bottom:24px; background:white; }
            .cp-tab-btn { padding:12px 24px; background:none; border:none; border-bottom:2px solid transparent; cursor:pointer; font-size:14px; font-weight:500; color:#666; margin-bottom:-2px; }
            .cp-tab-btn.active { color:#353182; border-bottom:2px solid #353182; font-weight:600; }
            .cp-table thead th { background-color:#dbeafe !important; color:#333 !important; font-weight:600; padding:12px 16px; text-align:left; font-size:13px; border-bottom:1px solid #c2cce2; }
            .cp-table tbody td { padding:12px 16px; border-bottom:1px solid #eee; vertical-align:top; color:#333; font-size:13px; }
            .nested-row { display:none; }
            .nested-row.open { display:table-row; }
            .expander-btn { background:none; border:none; cursor:pointer; color:#666; font-size:14px; width:20px; transition:transform 0.2s; font-weight:bold; }
            .expander-btn.rotated { transform:rotate(90deg); color:#353182; }
            .status-dot-sm { height:8px; width:8px; border-radius:50%; display:inline-block; margin-right:6px; }
            .dot-blue { background-color:#2563eb; } .dot-red { background-color:#dc3545; }
            .dot-orange { background-color:#f59e0b; } .dot-green { background-color:#10b981; }
            .need-action-row { display:flex; align-items:center; gap:8px; margin-top:4px; font-size:12px; }
            .add-gi-btn { color:#353182; background:none; border:none; cursor:pointer; font-weight:500; padding:0; text-decoration:underline; }
            .goal-count-badge { display:flex; align-items:center; gap:4px; color:#333; font-weight:600; }
            /* Care Plan Detail sub-tabs */
            .cp-detail-tabs { display:flex; gap:2px; margin-bottom:16px; border-bottom:1px solid #e1e5e9; }
            .cp-detail-tab { padding:8px 16px; background:none; border:none; border-bottom:3px solid transparent; cursor:pointer; font-size:13px; font-weight:500; color:#666; margin-bottom:-1px; border-radius:4px 4px 0 0; }
            .cp-detail-tab.active { color:#353182; border-bottom:3px solid #353182; background:#f0f1fb; font-weight:600; }
            .cp-detail-form-grid { display:grid; grid-template-columns:1fr 1fr; gap:16px 24px; margin-top:16px; }
            .cp-detail-field label { font-size:11px; font-weight:600; color:#64748b; text-transform:uppercase; letter-spacing:0.04em; display:block; margin-bottom:5px; }
            .cp-detail-field .val { font-size:13px; color:#1e293b; padding:8px 10px; background:#f8fafc; border:1px solid #e2e8f0; border-radius:6px; min-height:36px; }
        </style>`;
    },

    switchTab: function(tabName) {
        this.activeTab = tabName;
        this.activePlanDetail = null; // reset drill-down on tab change
        document.querySelectorAll('.cp-tab-btn').forEach(btn => {
            const t = btn.innerText.toLowerCase();
            const active = (tabName==='needs'&&t.includes('needs'))||(tabName==='activity'&&t.includes('activity'))||(tabName==='barriers'&&t.includes('barriers'))||(tabName==='gaps'&&t.includes('gaps'));
            btn.classList.toggle('active', active);
        });
        document.getElementById('cpContentArea').innerHTML = this.getContentHTML();
        if (typeof renderContextQuestions==='function' && typeof getCurrentPageContext==='function') {
            setTimeout(() => renderContextQuestions(getCurrentPageContext()), 50);
        }
    },

    getContentHTML: function() {
        const member = this.currentMember;
        const cpd = member.carePlanData;
        if (!cpd) return this.noDataMessage('Care Plan', 'No care plan data available for this member.');

        // If we're in a drill-down plan detail view
        if (this.activePlanDetail) return this.renderPlanDetail(this.activePlanDetail);

        if (this.activeTab==='needs')    return this.renderNeeds(cpd.needs||[], true);
        if (this.activeTab==='activity') return this.renderCarePlanList(member);
        if (this.activeTab==='barriers') return (cpd.barriers||[]).length>0 ? this.renderBarriers(cpd.barriers) : this.noDataMessage('Barriers & Strengths','No barriers or strengths documented.');
        if (this.activeTab==='gaps')     return (cpd.gaps||[]).length>0 ? this.renderGaps(cpd.gaps) : this.noDataMessage('Care Gaps','No care gaps identified. Great job!');
    },

    noDataMessage: function(tabName, message) {
        return `<div style="padding:60px 40px;text-align:center;background:#f8fafc;border-radius:8px;margin:20px 0;">
            <div style="font-size:40px;margin-bottom:16px;"></div>
            <h3 style="color:#353182;margin-bottom:8px;">No ${tabName} Data</h3>
            <p style="color:#666;max-width:400px;margin:0 auto 20px;">${message}</p>
            <button class="btn btn-primary" onclick="alert('Add New - Development in progress')">+ Add New</button>
        </div>`;
    },

    //  CARE PLAN ACTIVITY: list of care plans 
    renderCarePlanList: function(member) {
        const lobPlans = (member.lob&&member.lob[0]&&member.lob[0].carePlans) ? member.lob[0].carePlans : [];
        const plans = lobPlans.length > 0 ? lobPlans : (
            (member.carePlanData?.needs?.length > 0)
                ? [{ id:'__default__', name:'Standard Care Plan', status:'active' }]
                : []
        );

        if (plans.length === 0) return this.noDataMessage('Care Plans','No care plans have been created for this member yet.');

        const statusDot = s => {
            const col = {active:'#10b981','in-progress':'#f59e0b','in progress':'#f59e0b',planned:'#6366f1',completed:'#10b981',discontinued:'#ef4444',inactive:'#94a3b8'}[(s||'').toLowerCase()]||'#94a3b8';
            return `<span style="display:inline-block;width:9px;height:9px;border-radius:50%;background:${col};margin-right:6px;vertical-align:middle;flex-shrink:0;"></span>`;
        };
        const cap = s => (s||'').charAt(0).toUpperCase()+(s||'').slice(1);
        const fmtD = d => { try { return new Date(d).toLocaleDateString('en-US',{month:'2-digit',day:'2-digit',year:'numeric'}); } catch(e){ return d||''; } };

        const order = ['active','in-progress','in progress','planned','completed','discontinued','inactive'];
        const sorted = [...plans].sort((a,b)=>(order.indexOf((a.status||'').toLowerCase())||99)-(order.indexOf((b.status||'').toLowerCase())||99));
        const today  = fmtD(new Date().toLocaleDateString());

        const rows = sorted.map((plan,i) => {
            const needCount = (member.carePlanData?.needs||[]).filter(n => plans.length===1||n.planId===plan.id).length;
            return `<tr style="background:white;cursor:pointer;" onclick="CarePlanController.openPlanDetail('${plan.id}')">
                <td><input type="checkbox" onclick="event.stopPropagation()"></td>
                <td>
                    <a href="#" class="link-text" onclick="event.preventDefault();CarePlanController.openPlanDetail('${plan.id}')">${plan.name}</a>
                </td>
                <td><span style="display:inline-flex;align-items:center;">${statusDot(plan.status)}${cap(plan.status||'Active')}</span></td>
                <td>${fmtD(plan.startDate) !== 'Invalid Date' ? fmtD(plan.startDate) : fmtD(member.carePlanData?.needs?.[0]?.startDate)||''}</td>
                <td>${plan.updatedOn || today}</td>
                <td>${member.careManager||''}</td>
                <td><button style="border:none;background:none;cursor:pointer;" onclick="event.stopPropagation()"></button></td>
            </tr>`;
        }).join('');

        return `
        <div style="display:flex;justify-content:space-between;margin-bottom:12px;align-items:center;">
            <div>
                <div style="font-size:18px;font-weight:600;">List of Care Plans (${plans.length})</div>
                <div style="font-size:12px;color:#64748b;margin-top:2px;">Active Filters: <span style="color:#94a3b8;">No active filters</span></div>
            </div>
            <div style="display:flex;gap:10px;align-items:center;">
                <div class="search-box" style="width:220px;"><input type="text" placeholder="Search by Care Plan Name"></div>
                <button class="btn btn-secondary">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="12" height="12"><polygon points="22,3 2,3 10,12.46 10,19 14,21 14,12.46"/></svg> Filter
                </button>
                <button class="btn btn-primary">+ Add New</button>
            </div>
        </div>
        <div class="task-table-wrapper">
            <table class="dashboard-table cp-table" style="width:100%;">
                <thead><tr>
                    <th style="width:30px;"></th>
                    <th>Care Plan Name</th>
                    <th>Care Plan Status</th>
                    <th>Care Plan Start Date</th>
                    <th>Updated On</th>
                    <th>Updated By</th>
                    <th style="width:40px;"></th>
                </tr></thead>
                <tbody>${rows}</tbody>
            </table>
        </div>`;
    },

    //  Open plan detail on row click 
    openPlanDetail: function(planId) {
        const member = this.currentMember;
        const lobPlans = (member.lob&&member.lob[0]&&member.lob[0].carePlans)||[];
        const plans = lobPlans.length>0 ? lobPlans : [{id:'__default__',name:'Standard Care Plan',status:'active'}];
        const plan  = plans.find(p=>p.id===planId) || plans[0];
        this.activePlanDetail  = plan;
        this.activePlanSubTab  = 'details';
        document.getElementById('cpContentArea').innerHTML = this.getContentHTML();
    },

    //  Plan detail view with 3 sub-tabs 
    renderPlanDetail: function(plan) {
        const member = this.currentMember;
        const subTab = this.activePlanSubTab;
        const cap = s => (s||'').charAt(0).toUpperCase()+(s||'').slice(1);
        const fmtD = d => { try { const dd=new Date(d); return isNaN(dd)?d:dd.toLocaleDateString('en-US',{month:'2-digit',day:'2-digit',year:'numeric'}); } catch(e){return d||'';} };

        const statusColor = {active:'#10b981','in-progress':'#f59e0b','in progress':'#f59e0b',planned:'#6366f1',completed:'#10b981',discontinued:'#ef4444'}[(plan.status||'').toLowerCase()]||'#94a3b8';

        // Sub-tab content
        let subContent = '';
        if (subTab==='details') {
            const startDate = plan.startDate || (member.carePlanData?.needs?.[0]?.startDate) || '';
            const followUp  = plan.followUpDate || (member.carePlanData?.needs?.[0]?.followUpDate) || '';
            subContent = `<div class="cp-detail-form-grid">
                <div class="cp-detail-field"><label>Creating Care Plan for</label><div class="val">${member.name}</div></div>
                <div class="cp-detail-field"><label>Care Plan Name</label><div class="val">${plan.name}</div></div>
                <div class="cp-detail-field"><label>Care Plan Start Date</label><div class="val">${fmtD(startDate)||''}</div></div>
                <div class="cp-detail-field"><label>Care Plan Status</label>
                    <div class="val" style="display:flex;align-items:center;gap:8px;">
                        <span style="display:inline-block;width:8px;height:8px;border-radius:50%;background:${statusColor};"></span>${cap(plan.status||'Active')}
                    </div>
                </div>
                <div class="cp-detail-field"><label>Care Plan Follow-up Date</label><div class="val">${fmtD(followUp)||''}</div></div>
                <div class="cp-detail-field"><label>Meeting Date</label><div class="val" style="color:#94a3b8;"></div></div>
                <div class="cp-detail-field"><label>Created On</label><div class="val">${fmtD(startDate)||''}</div></div>
                <div class="cp-detail-field"><label>Modified On</label><div class="val">${fmtD(new Date().toLocaleDateString())||''}</div></div>
            </div>
            <div style="margin-top:20px;display:flex;justify-content:flex-end;gap:10px;">
                <button class="btn btn-secondary" onclick="CarePlanController.closePlanDetail()"> Back</button>
                <button class="btn btn-primary">Preview Care Plan</button>
            </div>`;
        } else if (subTab==='needs') {
            const allNeeds = member.carePlanData?.needs||[];
            // Show needs linked to this plan (or all if single plan)
            const lobPlans = (member.lob&&member.lob[0]&&member.lob[0].carePlans)||[];
            const planNeeds = lobPlans.length<=1
                ? allNeeds
                : allNeeds.filter(n => n.planId===plan.id);
            subContent = `<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;">
                <div style="font-size:15px;font-weight:600;">List of Need(s) in ${plan.name} (${planNeeds.length})</div>
                <div style="display:flex;gap:8px;">
                    <div class="search-box" style="width:200px;"><input type="text" placeholder="Search by Need"></div>
                    <button class="btn btn-secondary">Filter</button>
                    <button class="btn btn-primary">+ Add New</button>
                </div>
            </div>
            ${planNeeds.length===0
                ? `<div style="padding:40px;text-align:center;background:#f8fafc;border-radius:8px;color:#64748b;">
                    <div style="font-size:32px;margin-bottom:10px;"></div>
                    No needs linked to this care plan yet.<br>
                    <button class="btn btn-primary" style="margin-top:12px;">+ Add Need</button>
                  </div>`
                : this.renderNeeds(planNeeds, false)
            }`;
        } else if (subTab==='crisis') {
            subContent = `<div style="padding:40px;text-align:center;background:#f8fafc;border-radius:8px;color:#64748b;">
                <div style="font-size:32px;margin-bottom:10px;"></div>
                No crisis plan documented for this care plan.
                <br><button class="btn btn-primary" style="margin-top:12px;">+ Add Crisis Plan</button>
            </div>`;
        }

        return `
        <!-- Breadcrumb back -->
        <div style="display:flex;align-items:center;gap:6px;font-size:12px;color:#64748b;margin-bottom:16px;">
            <button onclick="CarePlanController.closePlanDetail()" style="background:none;border:none;cursor:pointer;color:#353182;font-size:12px;font-weight:600;padding:0;"> Care Plan Activity</button>
            <span></span><span style="color:#1e293b;">${plan.name}</span>
        </div>

        <!-- Plan header bar -->
        <div style="display:flex;align-items:center;gap:12px;padding:12px 16px;background:white;border:1px solid #e2e8f0;border-radius:8px;margin-bottom:16px;">
            <div style="font-size:16px;font-weight:700;color:#1e293b;flex:1;">${plan.name}</div>
            <span style="display:inline-flex;align-items:center;gap:6px;padding:5px 14px;border-radius:20px;font-size:12px;font-weight:700;background:${statusColor}20;color:${statusColor};border:1px solid ${statusColor}40;">
                <span style="width:7px;height:7px;border-radius:50%;background:${statusColor};display:inline-block;"></span>
                ${cap(plan.status||'Active')}
                <span style="font-size:14px;cursor:pointer;opacity:0.7;"></span>
            </span>
        </div>

        <!-- Sub-tabs -->
        <div class="cp-detail-tabs">
            <button class="cp-detail-tab ${subTab==='details'?'active':''}" onclick="CarePlanController.switchPlanSubTab('details')">Care Plan Details</button>
            <button class="cp-detail-tab ${subTab==='needs'?'active':''}" onclick="CarePlanController.switchPlanSubTab('needs')">Needs in Care Plan</button>
            <button class="cp-detail-tab ${subTab==='crisis'?'active':''}" onclick="CarePlanController.switchPlanSubTab('crisis')">Crisis Plan</button>
        </div>

        <!-- Sub-tab content -->
        <div>${subContent}</div>`;
    },

    switchPlanSubTab: function(subTab) {
        this.activePlanSubTab = subTab;
        document.getElementById('cpContentArea').innerHTML = this.getContentHTML();
    },

    closePlanDetail: function() {
        this.activePlanDetail = null;
        this.activeTab = 'activity';
        document.getElementById('cpContentArea').innerHTML = this.getContentHTML();
    },

    //  NEEDS PLANNING: ALL needs (showPlanTag = show which plan each belongs to) 
    renderNeeds: function(needs, showPlanTag) {
        const member = this.currentMember;
        const lobPlans = (member.lob&&member.lob[0]&&member.lob[0].carePlans)||[];

        let html = '';
        if (showPlanTag) {
            html += `<div style="display:flex;justify-content:space-between;margin-bottom:16px;align-items:center;">
                <div style="font-size:18px;font-weight:600;">List of Member Need(s) (${needs.length})</div>
                <div style="display:flex;gap:10px;">
                    <div class="search-box" style="width:220px;"><input type="text" placeholder="Search by Need"></div>
                    <button class="btn btn-secondary">Filter</button>
                    <button class="btn btn-primary">+ Add New</button>
                </div>
            </div>`;
        }

        html += `<div class="task-table-wrapper"><table class="dashboard-table cp-table" style="width:100%">
            <thead><tr>
                <th style="width:30px;"></th>
                <th style="width:35%;">Need</th>
                <th>Need Category</th>
                <th>Need Status</th>
                <th>Start Date</th>
                <th>Days to Follow-up</th>
                <th>Follow-up Date</th>
                ${showPlanTag && lobPlans.length>1 ? '<th>Care Plan</th>' : ''}
                <th style="width:30px;"></th>
            </tr></thead>
            <tbody>`;

        needs.forEach(need => {
            let dotColor = 'dot-blue';
            if(need.status==='On Hold') dotColor='dot-red';
            if(need.status==='In Progress') dotColor='dot-orange';
            if(need.status==='Met') dotColor='dot-green';

            // Plan label for multi-plan members
            let planLabel = '';
            if (showPlanTag && lobPlans.length>1) {
                const plan = lobPlans.find(p=>p.id===need.planId);
                planLabel = `<td style="font-size:11px;color:#64748b;">${plan ? plan.name : '<span style="color:#94a3b8;">Unlinked</span>'}</td>`;
            }

            html += `
            <tr style="background:white;">
                <td><button class="expander-btn" onclick="CarePlanController.toggleRow('need-${need.id}')">></button></td>
                <td>
                    <div style="font-weight:500;color:#2563eb;margin-bottom:4px;">${need.text}</div>
                    <div class="need-action-row">
                        <button class="add-gi-btn" onclick="alert('Add Goals')">+ Add Goals & Interventions</button>
                        <span class="goal-count-badge">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8z"/></svg>
                            Goals: ${need.goals.length}
                        </span>
                    </div>
                </td>
                <td>${need.category}</td>
                <td><span class="status-dot-sm ${dotColor}"></span>${need.status}</td>
                <td>${need.startDate}</td>
                <td>${need.daysToFollowUp}</td>
                <td>${need.followUpDate}</td>
                ${planLabel}
                <td><button style="border:none;background:none;cursor:pointer;"></button></td>
            </tr>
            <tr id="row-need-${need.id}" class="nested-row">
                <td colspan="${showPlanTag&&lobPlans.length>1?9:8}" style="padding:0;background:#f4f6f8;">
                    <div style="padding:10px 20px 20px 50px;">${this.renderGoals(need.goals)}</div>
                </td>
            </tr>`;
        });
        html += `</tbody></table></div>`;
        return html;
    },

    //  GOALS 
    renderGoals: function(goals) {
        if(goals.length===0) return '<div style="padding:10px;">No goals defined.</div>';
        let html = `<table style="width:100%;border-collapse:collapse;background:white;border:1px solid #e1e5e9;">
            <thead style="background:#eef2ff;">
                <tr>
                    <th style="width:30px;padding:8px;background:#eef2ff !important;color:#333 !important;"></th>
                    <th style="text-align:left;padding:8px;background:#eef2ff !important;color:#333 !important;">Goal</th>
                    <th style="text-align:left;padding:8px;background:#eef2ff !important;color:#333 !important;">Goal Status</th>
                    <th style="text-align:left;padding:8px;background:#eef2ff !important;color:#333 !important;">Start Date</th>
                    <th style="text-align:left;padding:8px;background:#eef2ff !important;color:#333 !important;">Target Date</th>
                    <th style="text-align:left;padding:8px;background:#eef2ff !important;color:#333 !important;">Completed Date</th>
                    <th style="text-align:left;padding:8px;background:#eef2ff !important;color:#333 !important;">Outcome</th>
                </tr>
            </thead>
            <tbody>`;
        goals.forEach(goal => {
            const dotColor = goal.status==='Met'?'dot-green':(goal.status==='Not Met'?'dot-red':'dot-orange');
            html += `
            <tr style="border-bottom:1px solid #f0f0f0;">
                <td style="padding:8px;"><button class="expander-btn" onclick="CarePlanController.toggleRow('goal-${goal.id}')">></button></td>
                <td style="padding:8px;font-weight:500;color:#333;">${goal.text}</td>
                <td style="padding:8px;"><span class="status-dot-sm ${dotColor}"></span>${goal.status}</td>
                <td style="padding:8px;">${goal.startDate}</td>
                <td style="padding:8px;">${goal.targetDate}</td>
                <td style="padding:8px;color:#94a3b8;">${goal.completedDate||''}</td>
                <td style="padding:8px;">${goal.outcome||''}</td>
            </tr>
            <tr id="row-goal-${goal.id}" class="nested-row">
                <td colspan="7" style="padding:0;background:#f8fafc;">
                    <div style="padding:8px 16px 12px 40px;">${this.renderInterventions(goal.interventions||[])}</div>
                </td>
            </tr>`;
        });
        html += `</tbody></table>`;
        return html;
    },

    //  INTERVENTIONS 
    renderInterventions: function(interventions) {
        if(interventions.length===0) return '<div style="padding:6px;font-size:12px;color:#94a3b8;">No interventions defined.</div>';
        let html = `<table style="width:100%;border-collapse:collapse;font-size:12px;">
            <thead><tr style="background:#f0f4ff;">
                <th style="padding:6px 8px;text-align:left;background:#f0f4ff !important;color:#555 !important;">Intervention</th>
                <th style="padding:6px 8px;text-align:left;background:#f0f4ff !important;color:#555 !important;">Status</th>
                <th style="padding:6px 8px;text-align:left;background:#f0f4ff !important;color:#555 !important;">Owner</th>
                <th style="padding:6px 8px;text-align:left;background:#f0f4ff !important;color:#555 !important;">Due Date</th>
            </tr></thead><tbody>`;
        interventions.forEach(int => {
            html += `<tr>
                <td style="padding:6px 8px;border-bottom:1px solid #eee;">${int.text}</td>
                <td style="padding:6px 8px;border-bottom:1px solid #eee;">${int.status}</td>
                <td style="padding:6px 8px;border-bottom:1px solid #eee;">${int.owner}</td>
                <td style="padding:6px 8px;border-bottom:1px solid #eee;">${int.dueDate}</td>
            </tr>`;
        });
        html += `</tbody></table>`;
        return html;
    },

    //  BARRIERS 
    renderBarriers: function(data) {
        const rows = data.map(r=>`<tr><td><input type="checkbox"></td><td>${r.category}</td><td><a href="#" class="link-text">${r.name}</a></td><td>${r.description}</td><td>${r.status}</td><td><button style="border:none;background:none;"></button></td></tr>`).join('');
        return `<div class="task-table-wrapper"><table class="dashboard-table cp-table"><thead><tr><th style="width:30px"></th><th>Category</th><th>Name</th><th>Description</th><th>Status</th><th></th></tr></thead><tbody>${rows}</tbody></table></div>`;
    },

    //  CARE GAPS 
    renderGaps: function(data) {
        const rows = data.map(r=>`<tr><td><input type="checkbox"></td><td>${r.measure}</td><td>${r.desc}</td><td><span class="status-pill hold">${r.status}</span></td><td>${r.identified}</td><td><button style="border:none;background:none;"></button></td></tr>`).join('');
        return `<div class="task-table-wrapper"><table class="dashboard-table cp-table"><thead><tr><th style="width:30px"></th><th>Quality Measure</th><th>Gap Description</th><th>Status</th><th>Identified Date</th><th></th></tr></thead><tbody>${rows}</tbody></table></div>`;
    },

    //  TOGGLE ROW 
    toggleRow: function(id) {
        const row = document.getElementById(`row-${id}`);
        const btn = document.querySelector(`button[onclick="CarePlanController.toggleRow('${id}')"]`);
        if(row) {
            const isOpen = row.style.display === 'table-row';
            row.style.display = isOpen ? 'none' : 'table-row';
            if(btn) btn.classList.toggle('rotated', !isOpen);
        }
    }
};

// 2. TASK CONTROLLER: Manages UI and Filtering
// 
// COMPLETE TASK MODULE - Full functionality from task-bulk-assign-v2
// Includes: Quick Filters, Bulk Assign, Save Views, Column Management
// 

// DYNAMIC TASK GENERATION FROM membersDB
const allTasks = [];
let taskIdCounter = 1;

membersDB.forEach(member => {
    if (member.dashboardData && member.dashboardData.tasks) {
        member.dashboardData.tasks.forEach(task => {
            allTasks.push({
                id: taskIdCounter++,
                name: task.title,
                member: member.name,
                medicaid: member.medicaidId,
                group: task.group || "Care Management Team A",
                assignee: task.assignedTo || member.careManager,
                action: task.type === "Member Consent" ? "Contact" : task.type === "ADT Follow-up" ? "Follow-up" : "Contact",
                source: task.type === "Member Consent" ? "System Generated" : task.type === "ADT Follow-up" ? "ADT Alert" : "Care Plan",
                type: task.type,
                priority: task.priority,
                dueDate: task.dueDate,
                status: task.status,
                createdOn: task.dueDate
            });
        });
    }
});

// Eligible assignees
const eligibleAssignees = [
    { id: 'aziz.gida', name: 'Aziz Gida', role: 'Care Manager' },
    { id: 'heather.thompson', name: 'Heather Thompson', role: 'Care Manager' },
    { id: 'jolee.uat', name: 'Jolee UAT', role: 'Care Manager' },
    { id: 'mohammed.cm', name: 'Mohammed CM', role: 'Care Manager' },
    { id: 'sara.posorske', name: 'Sara Posorske', role: 'Care Manager' },
    { id: 'sweta.uat', name: 'Sweta UAT', role: 'Care Manager' },
    { id: 'sweta.sharma', name: 'Sweta Sharma', role: 'Care Manager' },
    { id: 'dhanyan.admin', name: 'Dhanyan Admin', role: 'Supervisor' }
];

// Task state management
let taskFilteredTasks = [...allTasks];
let taskSelectedIds = new Set();
let taskActiveFilters = {
    status: [],
    priority: [],
    myClaimedTasks: false,
    myGroupedTasks: false,
    dateFrom: null,
    dateTo: null,
    taskType: '',
    source: '',
    search: ''
};

// Saved views
let taskSavedViews = [];
let currentTaskView = null;

// Get assignee display name
function getAssigneeDisplayName(assigneeId) {
    const assignee = eligibleAssignees.find(a => a.id === assigneeId);
    return assignee ? assignee.name : (assigneeId || 'Unassigned');
}

function generateTaskPageHTML() {
    return `
    <div class="content-wrapper task-page-container">
        <div class="breadcrumb">Home > Tasks</div>
        
        <div class="header">
            <div class="title-row">
                <div class="title-section">
                    <h2 class="page-title">List of Tasks (<span id="taskCount">${allTasks.length}</span>)</h2>
                </div>
                <div class="title-row-right">
                    <div class="search-container">
                        <input type="text" id="taskSearchInput" class="search-input" placeholder="Search by Task Name, Member First Name, Medicaid ID">
                        <span class="search-icon"></span>
                    </div>
                    <button class="btn-bulk-edit" id="taskBulkEditBtn" disabled title="Select tasks to assign them to care managers">
                        <span class="btn-icon"></span> Bulk Edit
                    </button>
                    <button class="btn-add-new" id="taskAddNewBtn" title="Create a new task">
                        <span class="btn-icon"></span> Add New
                    </button>
                </div>
            </div>

            <div class="filters-header-row" style="display: flex; align-items: center; gap: 16px; padding: 12px 0; border-top: 1px solid #e0e0e0; border-bottom: 1px solid #e0e0e0; margin-bottom: 16px; flex-wrap: wrap;">
                <div class="filters-left-section" style="display: flex; align-items: center; gap: 16px; flex-wrap: wrap;">
                    <!-- Task Status -->
                    <div class="filter-group" style="display: flex; align-items: center; gap: 6px;">
                        <span class="filter-group-label" style="font-size: 13px; color: #666; font-weight: 500;">Task Status</span>
                        <div class="filter-dropdown" style="position: relative;">
                            <button class="filter-dropdown-button" id="taskStatusDropdownBtn" style="padding: 6px 12px; border-radius: 20px; border: 1px solid #d0d0d0; background: white; cursor: pointer; font-size: 12px; display: flex; align-items: center; gap: 6px;">
                                <span id="taskStatusDropdownLabel">Open</span>
                                <span class="filter-dropdown-icon" style="font-size: 10px;"></span>
                            </button>
                            <div class="filter-dropdown-menu" id="taskStatusDropdownMenu" style="display: none; position: absolute; top: 100%; left: 0; background: white; border: 1px solid #d0d0d0; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); padding: 8px; z-index: 1000; min-width: 150px;">
                                <div class="filter-dropdown-item" style="display: flex; align-items: center; gap: 8px; padding: 8px; cursor: pointer; border-radius: 4px;">
                                    <input type="checkbox" id="taskStatus-all" data-value="all">
                                    <label>All</label>
                                </div>
                                <div class="filter-dropdown-item" style="display: flex; align-items: center; gap: 8px; padding: 8px; cursor: pointer; border-radius: 4px;">
                                    <input type="checkbox" id="taskStatus-open" data-value="Open" checked>
                                    <label>Open</label>
                                </div>
                                <div class="filter-dropdown-item" style="display: flex; align-items: center; gap: 8px; padding: 8px; cursor: pointer; border-radius: 4px;">
                                    <input type="checkbox" id="taskStatus-closed" data-value="Closed">
                                    <label>Closed</label>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Priority -->
                    <div class="filter-group" style="display: flex; align-items: center; gap: 6px;">
                        <span class="filter-group-label" style="font-size: 13px; color: #666; font-weight: 500;">Priority</span>
                        <div class="filter-dropdown" style="position: relative;">
                            <button class="filter-dropdown-button" id="taskPriorityDropdownBtn" style="padding: 6px 12px; border-radius: 20px; border: 1px solid #d0d0d0; background: white; cursor: pointer; font-size: 12px; display: flex; align-items: center; gap: 6px;">
                                <span id="taskPriorityDropdownLabel">High</span>
                                <span class="filter-dropdown-icon" style="font-size: 10px;"></span>
                            </button>
                            <div class="filter-dropdown-menu" id="taskPriorityDropdownMenu" style="display: none; position: absolute; top: 100%; left: 0; background: white; border: 1px solid #d0d0d0; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); padding: 8px; z-index: 1000; min-width: 150px;">
                                <div class="filter-dropdown-item" style="display: flex; align-items: center; gap: 8px; padding: 8px; cursor: pointer; border-radius: 4px;">
                                    <input type="checkbox" id="taskPriority-all" data-value="all">
                                    <label>All</label>
                                </div>
                                <div class="filter-dropdown-item" style="display: flex; align-items: center; gap: 8px; padding: 8px; cursor: pointer; border-radius: 4px;">
                                    <input type="checkbox" id="taskPriority-high" data-value="High" checked>
                                    <label>High</label>
                                </div>
                                <div class="filter-dropdown-item" style="display: flex; align-items: center; gap: 8px; padding: 8px; cursor: pointer; border-radius: 4px;">
                                    <input type="checkbox" id="taskPriority-medium" data-value="Medium">
                                    <label>Medium</label>
                                </div>
                                <div class="filter-dropdown-item" style="display: flex; align-items: center; gap: 8px; padding: 8px; cursor: pointer; border-radius: 4px;">
                                    <input type="checkbox" id="taskPriority-low" data-value="Low">
                                    <label>Low</label>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- My Tasks checkbox -->
                    <div class="filter-group" style="display: flex; align-items: center; gap: 6px;">
                        <input type="checkbox" id="taskMyTasks" checked>
                        <label for="taskMyTasks" style="font-size: 13px; color: #333;">My Tasks</label>
                    </div>

                    <!-- My Group Tasks checkbox -->
                    <div class="filter-group" style="display: flex; align-items: center; gap: 6px;">
                        <input type="checkbox" id="taskMyGroupTasks">
                        <label for="taskMyGroupTasks" style="font-size: 13px; color: #333;">My Group Tasks</label>
                    </div>
                </div>

                <div class="filters-right-section" style="margin-left: auto; display: flex; align-items: center; gap: 12px;">
                    <button id="taskFiltersBtn" class="btn" style="padding: 8px 16px; border: 1px solid #d0d0d0; border-radius: 6px; background: white; cursor: pointer; font-size: 13px;">
                        Filters
                    </button>
                    <button id="taskClearFiltersBtn" style="padding: 8px 16px; border: none; background: transparent; cursor: pointer; font-size: 13px; color: #4c6fff; text-decoration: underline;">
                        Clear Filters
                    </button>
                </div>
            </div>
        </div>

        <div class="table-container" style="overflow-x: auto; border: 1px solid #e0e0e0; border-radius: 8px;">
            <table style="width: 100%; border-collapse: collapse; background: white;">
                <thead style="background: #2d2d52; color: white;">
                    <tr>
                        <th style="padding: 12px 8px; text-align: left; font-weight: 500; font-size: 13px;">
                            <input type="checkbox" id="taskSelectAll">
                        </th>
                        <th style="padding: 12px 8px; text-align: left; font-weight: 500; font-size: 13px;">Task Name</th>
                        <th style="padding: 12px 8px; text-align: left; font-weight: 500; font-size: 13px;">Member Name</th>
                        <th style="padding: 12px 8px; text-align: left; font-weight: 500; font-size: 13px;">Medicaid ID</th>
                        <th style="padding: 12px 8px; text-align: left; font-weight: 500; font-size: 13px;">Group</th>
                        <th style="padding: 12px 8px; text-align: left; font-weight: 500; font-size: 13px;">Assignee</th>
                        <th style="padding: 12px 8px; text-align: left; font-weight: 500; font-size: 13px;">Call To Action</th>
                        <th style="padding: 12px 8px; text-align: left; font-weight: 500; font-size: 13px;">Source</th>
                        <th style="padding: 12px 8px; text-align: left; font-weight: 500; font-size: 13px;">Task Type</th>
                        <th style="padding: 12px 8px; text-align: left; font-weight: 500; font-size: 13px;">Priority</th>
                    </tr>
                </thead>
                <tbody id="taskTableBody">
                </tbody>
            </table>
        </div>

        <div id="taskNoResults" style="display: none; padding: 60px 20px; text-align: center; color: #666; font-size: 16px;">
            No tasks found matching your filters.
        </div>

        <div class="pagination" style="display: flex; justify-content: space-between; align-items: center; margin-top: 20px; padding-top: 20px; border-top: 1px solid #e0e0e0;">
            <div class="page-info" id="taskPageInfo" style="color: #666; font-size: 14px;">Page 1 of 1</div>
            <div class="page-controls" style="display: flex; gap: 12px; align-items: center;">
                <button class="btn" id="taskPrevBtn" style="padding: 8px 16px; border: 1px solid #d0d0d0; border-radius: 6px; background: white; cursor: pointer;">PREV</button>
                <input type="number" class="page-input" id="taskPageInput" value="1" min="1" style="width: 60px; padding: 8px; border: 1px solid #d0d0d0; border-radius: 4px; text-align: center;">
                <button class="btn" id="taskNextBtn" style="padding: 8px 16px; border: 1px solid #d0d0d0; border-radius: 6px; background: white; cursor: pointer;">NEXT</button>
                <select id="taskRowsPerPage" style="padding: 8px; border: 1px solid #d0d0d0; border-radius: 4px;">
                    <option value="50">50</option>
                    <option value="100">100</option>
                    <option value="200">200</option>
                </select>
                <span style="color: #666; font-size: 14px;">Rows</span>
            </div>
        </div>
    </div>

    <!-- Bulk Edit Modal -->
    <div class="task-modal-overlay" id="taskBulkEditOverlay" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 2000;">
        <div class="task-modal" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; border-radius: 12px; width: 500px; max-width: 90%; box-shadow: 0 20px 60px rgba(0,0,0,0.3);">
            <div class="task-modal-header" style="padding: 20px; border-bottom: 1px solid #e0e0e0; display: flex; justify-content: space-between; align-items: center;">
                <h3 style="margin: 0; font-size: 18px;">Bulk Edit Tasks</h3>
                <button id="taskModalCloseBtn" style="background: none; border: none; font-size: 24px; cursor: pointer; color: #666;">&times;</button>
            </div>
            <div class="task-modal-body" style="padding: 20px;">
                <div style="background: #f5f5f5; padding: 16px; border-radius: 8px; margin-bottom: 20px;">
                    <div style="display: flex; align-items: center; gap: 8px; font-weight: 500; margin-bottom: 8px;">
                        <span></span>
                        <span id="taskBulkSummary">You are editing 0 tasks</span>
                    </div>
                </div>
                <div style="margin-bottom: 16px;">
                    <label style="display: block; margin-bottom: 8px; font-weight: 500;">Assignee</label>
                    <select id="taskBulkAssignee" style="width: 100%; padding: 10px; border: 1px solid #d0d0d0; border-radius: 6px; font-size: 14px;">
                        <option value="">Select Assignee...</option>
                        ${eligibleAssignees.map(a => `<option value="${a.id}">${a.name} (${a.role})</option>`).join('')}
                    </select>
                </div>
                <div style="margin-bottom: 16px;">
                    <label style="display: block; margin-bottom: 8px; font-weight: 500;">Assignee Group</label>
                    <select id="taskBulkGroup" style="width: 100%; padding: 10px; border: 1px solid #d0d0d0; border-radius: 6px; font-size: 14px;">
                        <option value="">Select Assignee Group...</option>
                        <option value="Unassigned Group">Unassigned Group</option>
                        <option value="Care Coordination Group">Care Coordination Group</option>
                        <option value="Assessment Team">Assessment Team</option>
                    </select>
                </div>
            </div>
            <div class="task-modal-footer" style="padding: 20px; border-top: 1px solid #e0e0e0; display: flex; justify-content: flex-end; gap: 12px;">
                <button id="taskModalCancelBtn" style="padding: 10px 20px; border: 1px solid #d0d0d0; border-radius: 6px; background: white; cursor: pointer;">Cancel</button>
                <button id="taskModalConfirmBtn" style="padding: 10px 20px; border: none; border-radius: 6px; background: #4c6fff; color: white; cursor: pointer;" disabled>Update Tasks</button>
            </div>
        </div>
    </div>

    <!-- Filter Panel -->
    <div class="task-filter-panel" id="taskFilterPanel" style="display: none; position: fixed; top: 0; right: 0; width: 400px; height: 100vh; background: white; box-shadow: -2px 0 8px rgba(0,0,0,0.1); z-index: 1500; overflow-y: auto;">
        <div style="background: #5d5d8d; color: white; padding: 20px; display: flex; justify-content: space-between; align-items: center;">
            <h3 style="margin: 0; font-size: 18px;">Filters</h3>
            <button id="taskFilterPanelClose" style="background: none; border: none; color: white; font-size: 24px; cursor: pointer;">&times;</button>
        </div>
        <div style="padding: 20px;">
            <div style="margin-bottom: 20px;">
                <label style="display: block; margin-bottom: 8px; font-weight: 500;">Task Type</label>
                <select id="taskTypeFilter" style="width: 100%; padding: 10px; border: 1px solid #d0d0d0; border-radius: 6px;">
                    <option value="">Select Task Type</option>
                    <option value="Member Consent">Member Consent</option>
                    <option value="Complete Urgent Needs Assessment">Complete Urgent Needs Assessment</option>
                    <option value="Care Planning">Care Planning</option>
                    <option value="Follow Up">Follow Up</option>
                </select>
            </div>
            <div style="margin-bottom: 20px;">
                <label style="display: block; margin-bottom: 8px; font-weight: 500;">Source</label>
                <select id="taskSourceFilter" style="width: 100%; padding: 10px; border: 1px solid #d0d0d0; border-radius: 6px;">
                    <option value="">Select Source</option>
                    <option value="Urgent Safety Concern">Urgent Safety Concern</option>
                    <option value="Safety Concern Population">Safety Concern Population</option>
                    <option value="Routine Assessment">Routine Assessment</option>
                </select>
            </div>
            <div style="margin-bottom: 20px;">
                <label style="display: block; margin-bottom: 8px; font-weight: 500;">Assignee</label>
                <select id="taskAssigneeFilter" style="width: 100%; padding: 10px; border: 1px solid #d0d0d0; border-radius: 6px;">
                    <option value="">Select Assignee</option>
                    ${eligibleAssignees.map(a => `<option value="${a.id}">${a.name}</option>`).join('')}
                </select>
            </div>
            <div style="margin-bottom: 20px;">
                <label style="display: block; margin-bottom: 8px; font-weight: 500;">Group</label>
                <select id="taskGroupFilter" style="width: 100%; padding: 10px; border: 1px solid #d0d0d0; border-radius: 6px;">
                    <option value="">Select Group</option>
                    <option value="Unassigned Group">Unassigned Group</option>
                    <option value="Care Coordination Group">Care Coordination Group</option>
                    <option value="Assessment Team">Assessment Team</option>
                </select>
            </div>
        </div>
        <div style="padding: 16px 20px; border-top: 1px solid #e0e0e0; display: flex; gap: 12px;">
            <button id="taskFilterCancelBtn" style="flex: 1; padding: 10px; border: 1px solid #d0d0d0; border-radius: 6px; background: white; cursor: pointer;">Cancel</button>
            <button id="taskFilterApplyBtn" style="flex: 1; padding: 10px; border: none; border-radius: 6px; background: #4c6fff; color: white; cursor: pointer;">Apply</button>
        </div>
    </div>
    `;
}

// Render task table rows
function renderTaskTableRows() {
    const tbody = document.getElementById('taskTableBody');
    if (!tbody) return;

    if (taskFilteredTasks.length === 0) {
        document.getElementById('taskNoResults').style.display = 'block';
        tbody.innerHTML = '';
        return;
    }

    document.getElementById('taskNoResults').style.display = 'none';
    
    tbody.innerHTML = taskFilteredTasks.map(task => {
        const priorityClass = task.priority === 'High' ? 'color: #dc2626;' : 
                             task.priority === 'Medium' ? 'color: #f59e0b;' : 'color: #10b981;';
        const assigneeName = getAssigneeDisplayName(task.assignee);
        const isSelected = taskSelectedIds.has(task.id);
        
        return `
            <tr style="border-bottom: 1px solid #f0f0f0; ${isSelected ? 'background: #e8f4fd;' : ''}" data-task-id="${task.id}">
                <td style="padding: 12px 8px;">
                    <input type="checkbox" class="task-checkbox" data-id="${task.id}" ${isSelected ? 'checked' : ''}>
                </td>
                <td style="padding: 12px 8px; color: #4c6fff; cursor: pointer;" onclick="showTaskDetails(${task.id})">${task.name}</td>
                <td style="padding: 12px 8px; color: #4c6fff; cursor: pointer;">${task.member}</td>
                <td style="padding: 12px 8px;">${task.medicaid}</td>
                <td style="padding: 12px 8px;">${task.group}</td>
                <td style="padding: 12px 8px;">${assigneeName}</td>
                <td style="padding: 12px 8px; color: #4c6fff;">${task.action}</td>
                <td style="padding: 12px 8px;">${task.source}</td>
                <td style="padding: 12px 8px;">${task.type}</td>
                <td style="padding: 12px 8px; ${priorityClass} font-weight: 500;"> ${task.priority}</td>
            </tr>
        `;
    }).join('');

    // Update count
    document.getElementById('taskCount').textContent = taskFilteredTasks.length;
    document.getElementById('taskPageInfo').textContent = `Page 1 of 1 (${taskFilteredTasks.length} tasks)`;

    // Add checkbox listeners
    document.querySelectorAll('.task-checkbox').forEach(cb => {
        cb.addEventListener('change', function() {
            const taskId = parseInt(this.dataset.id);
            if (this.checked) {
                taskSelectedIds.add(taskId);
            } else {
                taskSelectedIds.delete(taskId);
            }
            updateBulkEditButton();
        });
    });
}

// Apply task filters
function applyTaskFilters() {
    taskFilteredTasks = allTasks.filter(task => {
        // Status filter
        if (taskActiveFilters.status.length > 0 && !taskActiveFilters.status.includes(task.status)) {
            return false;
        }

        // Priority filter
        if (taskActiveFilters.priority.length > 0 && !taskActiveFilters.priority.includes(task.priority)) {
            return false;
        }

        // My Tasks filter (aziz.gida)
        if (taskActiveFilters.myClaimedTasks && task.assignee !== 'aziz.gida') {
            return false;
        }

        // Task Type filter
        if (taskActiveFilters.taskType && task.type !== taskActiveFilters.taskType) {
            return false;
        }

        // Source filter
        if (taskActiveFilters.source && task.source !== taskActiveFilters.source) {
            return false;
        }

        // Assignee filter
        if (taskActiveFilters.assignee && task.assignee !== taskActiveFilters.assignee) {
            return false;
        }

        // Group filter
        if (taskActiveFilters.group && task.group !== taskActiveFilters.group) {
            return false;
        }

        // Search filter
        if (taskActiveFilters.search) {
            const search = taskActiveFilters.search.toLowerCase();
            if (!task.name.toLowerCase().includes(search) && 
                !task.member.toLowerCase().includes(search) && 
                !task.medicaid.toLowerCase().includes(search)) {
                return false;
            }
        }

        return true;
    });

    renderTaskTableRows();
}

// Update bulk edit button state
function updateBulkEditButton() {
    const btn = document.getElementById('taskBulkEditBtn');
    if (btn) {
        btn.disabled = taskSelectedIds.size === 0;
    }
}

// Initialize task page event listeners
function initializeTaskPage() {
    // Search input
    const searchInput = document.getElementById('taskSearchInput');
    if (searchInput) {
        searchInput.addEventListener('input', function() {
            taskActiveFilters.search = this.value;
            applyTaskFilters();
        });
    }

    // Status dropdown
    setupTaskDropdown('taskStatusDropdownBtn', 'taskStatusDropdownMenu');
    document.querySelectorAll('#taskStatusDropdownMenu input[type="checkbox"]').forEach(cb => {
        cb.addEventListener('change', function() {
            handleTaskStatusChange(this);
        });
    });

    // Priority dropdown
    setupTaskDropdown('taskPriorityDropdownBtn', 'taskPriorityDropdownMenu');
    document.querySelectorAll('#taskPriorityDropdownMenu input[type="checkbox"]').forEach(cb => {
        cb.addEventListener('change', function() {
            handleTaskPriorityChange(this);
        });
    });

    // My Tasks checkbox
    const myTasksCheckbox = document.getElementById('taskMyTasks');
    if (myTasksCheckbox) {
        myTasksCheckbox.addEventListener('change', function() {
            taskActiveFilters.myClaimedTasks = this.checked;
            applyTaskFilters();
        });
    }

    // My Group Tasks checkbox
    const myGroupTasksCheckbox = document.getElementById('taskMyGroupTasks');
    if (myGroupTasksCheckbox) {
        myGroupTasksCheckbox.addEventListener('change', function() {
            taskActiveFilters.myGroupedTasks = this.checked;
            applyTaskFilters();
        });
    }

    // Select All checkbox
    const selectAllCheckbox = document.getElementById('taskSelectAll');
    if (selectAllCheckbox) {
        selectAllCheckbox.addEventListener('change', function() {
            taskSelectedIds.clear();
            if (this.checked) {
                taskFilteredTasks.forEach(t => taskSelectedIds.add(t.id));
            }
            renderTaskTableRows();
            updateBulkEditButton();
        });
    }

    // Bulk Edit button
    const bulkEditBtn = document.getElementById('taskBulkEditBtn');
    if (bulkEditBtn) {
        bulkEditBtn.addEventListener('click', openTaskBulkEditModal);
    }

    // Modal buttons
    const modalCloseBtn = document.getElementById('taskModalCloseBtn');
    const modalCancelBtn = document.getElementById('taskModalCancelBtn');
    const modalConfirmBtn = document.getElementById('taskModalConfirmBtn');
    const overlay = document.getElementById('taskBulkEditOverlay');

    if (modalCloseBtn) modalCloseBtn.addEventListener('click', closeTaskBulkEditModal);
    if (modalCancelBtn) modalCancelBtn.addEventListener('click', closeTaskBulkEditModal);
    if (overlay) overlay.addEventListener('click', function(e) {
        if (e.target === overlay) closeTaskBulkEditModal();
    });
    if (modalConfirmBtn) modalConfirmBtn.addEventListener('click', executeBulkEdit);

    // Bulk assignee/group selects
    const bulkAssignee = document.getElementById('taskBulkAssignee');
    const bulkGroup = document.getElementById('taskBulkGroup');
    if (bulkAssignee) bulkAssignee.addEventListener('change', validateBulkEditForm);
    if (bulkGroup) bulkGroup.addEventListener('change', validateBulkEditForm);

    // Filter panel buttons
    const filtersBtn = document.getElementById('taskFiltersBtn');
    const filterPanelClose = document.getElementById('taskFilterPanelClose');
    const filterCancelBtn = document.getElementById('taskFilterCancelBtn');
    const filterApplyBtn = document.getElementById('taskFilterApplyBtn');
    const clearFiltersBtn = document.getElementById('taskClearFiltersBtn');

    if (filtersBtn) filtersBtn.addEventListener('click', openTaskFilterPanel);
    if (filterPanelClose) filterPanelClose.addEventListener('click', closeTaskFilterPanel);
    if (filterCancelBtn) filterCancelBtn.addEventListener('click', closeTaskFilterPanel);
    if (filterApplyBtn) filterApplyBtn.addEventListener('click', applyAdvancedFilters);
    if (clearFiltersBtn) clearFiltersBtn.addEventListener('click', clearAllTaskFilters);

    // Apply initial filters and render
    applyTaskFilters();
}

// Setup dropdown toggle
function setupTaskDropdown(buttonId, menuId) {
    const button = document.getElementById(buttonId);
    const menu = document.getElementById(menuId);
    
    if (!button || !menu) return;
    
    // Clone button to remove ALL existing event listeners
    const newButton = button.cloneNode(true);
    button.parentNode.replaceChild(newButton, button);
    
    newButton.addEventListener('click', function(e) {
        e.preventDefault();
        e.stopPropagation();
        
        // Close other dropdowns
        document.querySelectorAll('.filter-dropdown-menu').forEach(m => {
            if (m.id !== menuId) m.style.display = 'none';
        });
        
        // Toggle this menu
        menu.style.display = (menu.style.display === 'none' || menu.style.display === '') ? 'block' : 'none';
    });
}

// Handle status checkbox change
function handleTaskStatusChange(checkbox) {
    const value = checkbox.dataset.value;
    
    if (value === 'all') {
        if (checkbox.checked) {
            taskActiveFilters.status = [];
            document.querySelectorAll('#taskStatusDropdownMenu input[type="checkbox"]').forEach(c => c.checked = true);
        }
    } else {
        const index = taskActiveFilters.status.indexOf(value);
        if (checkbox.checked && index === -1) {
            taskActiveFilters.status.push(value);
        } else if (!checkbox.checked && index > -1) {
            taskActiveFilters.status.splice(index, 1);
        }
    }
    
    updateTaskStatusLabel();
    applyTaskFilters();
}

// Handle priority checkbox change
function handleTaskPriorityChange(checkbox) {
    const value = checkbox.dataset.value;
    
    if (value === 'all') {
        if (checkbox.checked) {
            taskActiveFilters.priority = [];
            document.querySelectorAll('#taskPriorityDropdownMenu input[type="checkbox"]').forEach(c => c.checked = true);
        }
    } else {
        const index = taskActiveFilters.priority.indexOf(value);
        if (checkbox.checked && index === -1) {
            taskActiveFilters.priority.push(value);
        } else if (!checkbox.checked && index > -1) {
            taskActiveFilters.priority.splice(index, 1);
        }
    }
    
    updateTaskPriorityLabel();
    applyTaskFilters();
}

// Update status dropdown label
function updateTaskStatusLabel() {
    const label = document.getElementById('taskStatusDropdownLabel');
    if (label) {
        if (taskActiveFilters.status.length === 0) {
            label.textContent = 'All';
        } else if (taskActiveFilters.status.length === 1) {
            label.textContent = taskActiveFilters.status[0];
        } else {
            label.textContent = `${taskActiveFilters.status.length} selected`;
        }
    }
}

// Update priority dropdown label
function updateTaskPriorityLabel() {
    const label = document.getElementById('taskPriorityDropdownLabel');
    if (label) {
        if (taskActiveFilters.priority.length === 0) {
            label.textContent = 'All';
        } else if (taskActiveFilters.priority.length === 1) {
            label.textContent = taskActiveFilters.priority[0];
        } else {
            label.textContent = `${taskActiveFilters.priority.length} selected`;
        }
    }
}

// Open bulk edit modal
function openTaskBulkEditModal() {
    const overlay = document.getElementById('taskBulkEditOverlay');
    const summary = document.getElementById('taskBulkSummary');
    
    if (overlay) overlay.style.display = 'block';
    if (summary) summary.textContent = `You are editing ${taskSelectedIds.size} task${taskSelectedIds.size !== 1 ? 's' : ''}`;
    
    // Reset form
    const assigneeSelect = document.getElementById('taskBulkAssignee');
    const groupSelect = document.getElementById('taskBulkGroup');
    if (assigneeSelect) assigneeSelect.value = '';
    if (groupSelect) groupSelect.value = '';
    
    validateBulkEditForm();
}

// Close bulk edit modal
function closeTaskBulkEditModal() {
    const overlay = document.getElementById('taskBulkEditOverlay');
    if (overlay) overlay.style.display = 'none';
}

// Validate bulk edit form
function validateBulkEditForm() {
    const assignee = document.getElementById('taskBulkAssignee')?.value;
    const group = document.getElementById('taskBulkGroup')?.value;
    const confirmBtn = document.getElementById('taskModalConfirmBtn');
    
    if (confirmBtn) {
        confirmBtn.disabled = !(assignee || group);
    }
}

// Execute bulk edit
function executeBulkEdit() {
    const assignee = document.getElementById('taskBulkAssignee')?.value;
    const group = document.getElementById('taskBulkGroup')?.value;
    
    taskSelectedIds.forEach(taskId => {
        const task = allTasks.find(t => t.id === taskId);
        if (task) {
            if (assignee) task.assignee = assignee;
            if (group) task.group = group;
        }
    });
    
    // Clear selection
    taskSelectedIds.clear();
    
    // Close modal and refresh
    closeTaskBulkEditModal();
    applyTaskFilters();
    
    // Show success message
    alert(`Successfully updated ${taskSelectedIds.size || 'selected'} tasks!`);
}

// Open filter panel
function openTaskFilterPanel() {
    const panel = document.getElementById('taskFilterPanel');
    if (panel) panel.style.display = 'block';
}

// Close filter panel
function closeTaskFilterPanel() {
    const panel = document.getElementById('taskFilterPanel');
    if (panel) panel.style.display = 'none';
}

// Apply advanced filters from panel
function applyAdvancedFilters() {
    taskActiveFilters.taskType = document.getElementById('taskTypeFilter')?.value || '';
    taskActiveFilters.source = document.getElementById('taskSourceFilter')?.value || '';
    taskActiveFilters.assignee = document.getElementById('taskAssigneeFilter')?.value || '';
    taskActiveFilters.group = document.getElementById('taskGroupFilter')?.value || '';
    
    closeTaskFilterPanel();
    applyTaskFilters();
}

// Clear all filters
function clearAllTaskFilters() {
    taskActiveFilters = {
        status: [],
        priority: [],
        myClaimedTasks: false,
        myGroupedTasks: false,
        dateFrom: null,
        dateTo: null,
        taskType: '',
        source: '',
        assignee: '',
        group: '',
        search: ''
    };
    
    // Reset UI
    const searchInput = document.getElementById('taskSearchInput');
    if (searchInput) searchInput.value = '';
    
    document.getElementById('taskMyTasks').checked = false;
    document.getElementById('taskMyGroupTasks').checked = false;
    
    // Reset dropdowns
    document.querySelectorAll('#taskStatusDropdownMenu input, #taskPriorityDropdownMenu input').forEach(cb => {
        cb.checked = cb.dataset.value === 'all';
    });
    
    updateTaskStatusLabel();
    updateTaskPriorityLabel();
    applyTaskFilters();
}

// Close dropdowns when clicking outside
document.addEventListener('click', function() {
    document.querySelectorAll('.task-page-container .filter-dropdown-menu').forEach(menu => {
        menu.style.display = 'none';
    });
});

// Show task details (placeholder)
function showTaskDetails(taskId) {
    const task = allTasks.find(t => t.id === taskId);
    if (task) {
        alert(`Task: ${task.name}\nMember: ${task.member}\nStatus: ${task.status}\nPriority: ${task.priority}`);
    }
}

// 3. NAV CLICK HANDLER FOR TASKS
document.addEventListener('DOMContentLoaded', function() {
    const taskLink = document.getElementById('navTask');
    if(taskLink) {
        taskLink.addEventListener('click', (e) => {
            e.preventDefault();
            // Clear other active states
            document.querySelectorAll('.sidebar-nav .nav-item').forEach(i => i.classList.remove('active'));
            // Set Task active
            taskLink.classList.add('active');
            
            // Render task page
            document.getElementById('pageContainer').innerHTML = generateTaskPageHTML();
            
            // Initialize event listeners
            setTimeout(initializeTaskPage, 0);
        });
    }
});


// 
// COMPLETE SERVICE NOTES MODULE - Full functionality from service-notes-quick-filters
// Includes: Quick Filters, Date Range Pickers, Activity Filters
// 

// DYNAMIC SERVICE NOTES GENERATION FROM membersDB
const allServiceNotes = [];
let snNoteIdCounter = 8000;

membersDB.forEach(member => {
    if (member.serviceNotes && member.serviceNotes.length > 0) {
        member.serviceNotes.forEach(note => {
            allServiceNotes.push({
                id: String(snNoteIdCounter++),
                member: member.name,
                memberId: member.id,
                medicaidId: member.medicaidId,
                supervisor: note.supervisor || "Sarah Mitchell",
                careManager: note.author || member.careManager,
                createdBy: note.author || member.careManager,
                contactType: note.type && note.type.includes("Phone") ? "Phone" : note.type && note.type.includes("Email") ? "Email" : "Phone",
                activity: note.activity || "Care Management",
                duration: note.duration ? note.duration.replace(' min', '') : "15",
                dateOfService: note.date,
                submittedAt: note.date,
                status: note.status
            });
        });
    }
});

// Service notes state management
let snFilteredNotes = [...allServiceNotes];
let snActiveFilters = {
    noteStatus: [],
    relatedActivity: [],
    createdBy: [],
    createdDateFrom: '',
    createdDateTo: '',
    contactType: '',
    supervisor: '',
    careManager: '',
    search: ''
};

function generateServiceNotesPageHTML() {
    return `
    <div class="content-wrapper service-notes-page-container">
        <div class="breadcrumb">Home > Service Notes</div>
        
        <div class="header">
            <h2 class="title">List of Service Notes (<span id="snNoteCount">${allServiceNotes.length}</span>)</h2>
            
            <div class="top-controls" style="display: flex; align-items: center; gap: 12px; margin: 16px 0; flex-wrap: wrap;">
                <div class="search-box" style="flex: 1; min-width: 300px; position: relative;">
                    <input type="text" id="snSearchInput" placeholder="Search by Note ID, Member First Name, Member Last Name" 
                           style="width: 100%; padding: 10px 40px 10px 16px; border: 1px solid #d0d0d0; border-radius: 6px; font-size: 14px;">
                    <span class="search-icon" style="position: absolute; right: 12px; top: 50%; transform: translateY(-50%); color: #666;"></span>
                </div>
                <button class="btn btn-primary" style="padding: 10px 20px; border-radius: 6px; background: #4c6fff; color: white; border: none; cursor: pointer;">
                    <span>+</span> Add New
                </button>
                <button class="btn" style="padding: 10px 20px; border-radius: 6px; border: 1px solid #d0d0d0; background: white; cursor: pointer;">Save This View</button>
                <button class="btn" style="padding: 10px 20px; border-radius: 6px; border: 1px solid #d0d0d0; background: white; cursor: pointer;">Reset View</button>
            </div>

            <div class="quick-filters-row" style="display: flex; align-items: center; gap: 16px; padding: 12px 0; border-top: 1px solid #e0e0e0; border-bottom: 1px solid #e0e0e0; margin-bottom: 16px; flex-wrap: wrap;">
                <div class="quick-filters-left" style="display: flex; align-items: center; gap: 16px; flex: 1; flex-wrap: wrap;">
                    <!-- Note Status -->
                    <div class="filter-group" style="display: flex; align-items: center; gap: 6px;">
                        <span class="filter-group-label" style="font-size: 13px; color: #666; font-weight: 500;">Note Status:</span>
                        <div class="filter-dropdown" style="position: relative;">
                            <button class="filter-dropdown-button" id="snStatusDropdownBtn" 
                                    style="padding: 6px 12px; border-radius: 20px; border: 1px solid #4c6fff; background: #4c6fff; color: white; cursor: pointer; font-size: 12px; display: flex; align-items: center; gap: 6px;">
                                <span id="snStatusDropdownLabel">Draft</span>
                                <span style="font-size: 10px;"></span>
                            </button>
                            <div class="filter-dropdown-menu" id="snStatusDropdownMenu" style="display: none; position: absolute; top: 100%; left: 0; background: white; border: 1px solid #d0d0d0; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); padding: 8px; z-index: 1000; min-width: 150px;">
                                <div style="display: flex; align-items: center; gap: 8px; padding: 8px; cursor: pointer;">
                                    <input type="checkbox" id="snStatus-all" data-value="all">
                                    <label>All</label>
                                </div>
                                <div style="display: flex; align-items: center; gap: 8px; padding: 8px; cursor: pointer;">
                                    <input type="checkbox" id="snStatus-Draft" data-value="Draft" checked>
                                    <label>Draft</label>
                                </div>
                                <div style="display: flex; align-items: center; gap: 8px; padding: 8px; cursor: pointer;">
                                    <input type="checkbox" id="snStatus-Posted" data-value="Posted">
                                    <label>Posted</label>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Related Activity -->
                    <div class="filter-group" style="display: flex; align-items: center; gap: 6px;">
                        <span class="filter-group-label" style="font-size: 13px; color: #666; font-weight: 500;">Related Activity:</span>
                        <div class="filter-dropdown" style="position: relative;">
                            <button class="filter-dropdown-button" id="snActivityDropdownBtn"
                                    style="padding: 6px 12px; border-radius: 20px; border: 1px solid #d0d0d0; background: white; cursor: pointer; font-size: 12px; display: flex; align-items: center; gap: 6px;">
                                <span id="snActivityDropdownLabel">All</span>
                                <span style="font-size: 10px;"></span>
                            </button>
                            <div class="filter-dropdown-menu" id="snActivityDropdownMenu" style="display: none; position: absolute; top: 100%; left: 0; background: white; border: 1px solid #d0d0d0; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); padding: 8px; z-index: 1000; min-width: 280px; max-height: 300px; overflow-y: auto;">
                                <div style="display: flex; align-items: center; gap: 8px; padding: 8px; cursor: pointer;">
                                    <input type="checkbox" id="snActivity-all" data-value="all" checked>
                                    <label>All</label>
                                </div>
                                <div style="display: flex; align-items: center; gap: 8px; padding: 8px; cursor: pointer;">
                                    <input type="checkbox" data-value="Outreach for Consent" checked>
                                    <label>Outreach for Consent</label>
                                </div>
                                <div style="display: flex; align-items: center; gap: 8px; padding: 8px; cursor: pointer;">
                                    <input type="checkbox" data-value="Patient Interaction - Chronic Care Management" checked>
                                    <label>Patient Interaction - Chronic Care Management</label>
                                </div>
                                <div style="display: flex; align-items: center; gap: 8px; padding: 8px; cursor: pointer;">
                                    <input type="checkbox" data-value="Patient Interaction - Transitional Care Management" checked>
                                    <label>Patient Interaction - Transitional Care Management</label>
                                </div>
                                <div style="display: flex; align-items: center; gap: 8px; padding: 8px; cursor: pointer;">
                                    <input type="checkbox" data-value="Patient Interaction - Care Coordination" checked>
                                    <label>Patient Interaction - Care Coordination</label>
                                </div>
                                <div style="display: flex; align-items: center; gap: 8px; padding: 8px; cursor: pointer;">
                                    <input type="checkbox" data-value="Internal Communication" checked>
                                    <label>Internal Communication</label>
                                </div>
                                <div style="display: flex; align-items: center; gap: 8px; padding: 8px; cursor: pointer;">
                                    <input type="checkbox" data-value="Urgent Needs Assessment" checked>
                                    <label>Urgent Needs Assessment</label>
                                </div>
                                <div style="display: flex; align-items: center; gap: 8px; padding: 8px; cursor: pointer;">
                                    <input type="checkbox" data-value="Care Planning" checked>
                                    <label>Care Planning</label>
                                </div>
                                <div style="display: flex; align-items: center; gap: 8px; padding: 8px; cursor: pointer;">
                                    <input type="checkbox" data-value="Follow Up Call" checked>
                                    <label>Follow Up Call</label>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Created By -->
                    <div class="filter-group" style="display: flex; align-items: center; gap: 6px;">
                        <span class="filter-group-label" style="font-size: 13px; color: #666; font-weight: 500;">Created By:</span>
                        <div class="filter-dropdown" style="position: relative;">
                            <button class="filter-dropdown-button" id="snCreatedByDropdownBtn"
                                    style="padding: 6px 12px; border-radius: 20px; border: 1px solid #4c6fff; background: #4c6fff; color: white; cursor: pointer; font-size: 12px; display: flex; align-items: center; gap: 6px;">
                                <span id="snCreatedByDropdownLabel">Aziz Gida</span>
                                <span style="font-size: 10px;"></span>
                            </button>
                            <div class="filter-dropdown-menu" id="snCreatedByDropdownMenu" style="display: none; position: absolute; top: 100%; left: 0; background: white; border: 1px solid #d0d0d0; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); padding: 8px; z-index: 1000; min-width: 200px;">
                                <div style="display: flex; align-items: center; gap: 8px; padding: 8px; cursor: pointer;">
                                    <input type="checkbox" id="snCreatedBy-all" data-value="all">
                                    <label>All</label>
                                </div>
                                <div style="display: flex; align-items: center; gap: 8px; padding: 8px; cursor: pointer;">
                                    <input type="checkbox" data-value="Aziz Gida" checked>
                                    <label>Aziz Gida</label>
                                </div>
                                <div style="display: flex; align-items: center; gap: 8px; padding: 8px; cursor: pointer;">
                                    <input type="checkbox" data-value="Sweta Sharma">
                                    <label>Sweta Sharma</label>
                                </div>
                                <div style="display: flex; align-items: center; gap: 8px; padding: 8px; cursor: pointer;">
                                    <input type="checkbox" data-value="Mohammed Ahmed">
                                    <label>Mohammed Ahmed</label>
                                </div>
                                <div style="display: flex; align-items: center; gap: 8px; padding: 8px; cursor: pointer;">
                                    <input type="checkbox" data-value="Heather Thompson">
                                    <label>Heather Thompson</label>
                                </div>
                                <div style="display: flex; align-items: center; gap: 8px; padding: 8px; cursor: pointer;">
                                    <input type="checkbox" data-value="Sara Posorske">
                                    <label>Sara Posorske</label>
                                </div>
                                <div style="display: flex; align-items: center; gap: 8px; padding: 8px; cursor: pointer;">
                                    <input type="checkbox" data-value="Jolee Williams">
                                    <label>Jolee Williams</label>
                                </div>
                                <div style="display: flex; align-items: center; gap: 8px; padding: 8px; cursor: pointer;">
                                    <input type="checkbox" data-value="Dhanya Patel">
                                    <label>Dhanya Patel</label>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="quick-filters-right" style="margin-left: auto;">
                    <button id="snOtherFiltersBtn" style="padding: 8px 16px; border: none; background: transparent; cursor: pointer; font-size: 13px; color: #4c6fff; text-decoration: underline;">
                        Other Filters
                    </button>
                </div>
            </div>

            <div class="active-filters" style="display: flex; align-items: center; gap: 12px; margin-bottom: 16px; padding: 8px 0;">
                <div style="display: flex; align-items: center; gap: 8px; font-size: 14px; color: #333;">
                    <span>Active Filters:</span>
                    <span id="snFilterCountBadge" style="background: #ff6b35; color: white; border-radius: 50%; width: 20px; height: 20px; display: inline-flex; align-items: center; justify-content: center; font-size: 12px; font-weight: 600;">0</span>
                </div>
                <div id="snActiveFiltersContainer" style="display: flex; gap: 8px; flex-wrap: wrap;">
                </div>
                <button id="snClearFiltersBtn" style="margin-left: auto; padding: 8px 16px; border: none; background: transparent; cursor: pointer; font-size: 13px; color: #4c6fff; text-decoration: underline;">
                    Clear Filters
                </button>
            </div>
        </div>

        <div class="table-container" style="overflow-x: auto; border: 1px solid #e0e0e0; border-radius: 8px;">
            <table style="width: 100%; border-collapse: collapse; background: white;">
                <thead style="background: #2d2d52; color: white;">
                    <tr>
                        <th style="padding: 16px 12px; text-align: left; font-weight: 500; font-size: 13px;">Note ID</th>
                        <th style="padding: 16px 12px; text-align: left; font-weight: 500; font-size: 13px;">Member Name</th>
                        <th style="padding: 16px 12px; text-align: left; font-weight: 500; font-size: 13px;">Current Supervisor</th>
                        <th style="padding: 16px 12px; text-align: left; font-weight: 500; font-size: 13px;">Current Care Manager</th>
                        <th style="padding: 16px 12px; text-align: left; font-weight: 500; font-size: 13px;">Created By</th>
                        <th style="padding: 16px 12px; text-align: left; font-weight: 500; font-size: 13px;">Contact Type</th>
                        <th style="padding: 16px 12px; text-align: left; font-weight: 500; font-size: 13px;">Related Activity</th>
                        <th style="padding: 16px 12px; text-align: left; font-weight: 500; font-size: 13px;">Duration</th>
                        <th style="padding: 16px 12px; text-align: left; font-weight: 500; font-size: 13px;">Date of Service</th>
                        <th style="padding: 16px 12px; text-align: left; font-weight: 500; font-size: 13px;">Submitted At</th>
                        <th style="padding: 16px 12px; text-align: left; font-weight: 500; font-size: 13px;">Note Status</th>
                    </tr>
                </thead>
                <tbody id="snTableBody">
                </tbody>
            </table>
        </div>

        <div id="snNoResults" style="display: none; padding: 60px 20px; text-align: center; color: #666; font-size: 16px;">
            No service notes found matching your filters.
        </div>

        <div class="pagination" style="display: flex; justify-content: space-between; align-items: center; margin-top: 20px; padding-top: 20px; border-top: 1px solid #e0e0e0;">
            <div id="snPageInfo" style="color: #666; font-size: 14px;">Page 1 of 1</div>
            <div style="display: flex; gap: 12px; align-items: center;">
                <button class="btn" style="padding: 8px 16px; border: 1px solid #d0d0d0; border-radius: 6px; background: white; cursor: pointer;">PREV</button>
                <input type="number" value="1" min="1" style="width: 60px; padding: 8px; border: 1px solid #d0d0d0; border-radius: 4px; text-align: center;">
                <button class="btn" style="padding: 8px 16px; border: 1px solid #d0d0d0; border-radius: 6px; background: white; cursor: pointer;">NEXT</button>
                <select style="padding: 8px; border: 1px solid #d0d0d0; border-radius: 4px;">
                    <option>50</option>
                    <option>100</option>
                    <option>200</option>
                </select>
                <span style="color: #666; font-size: 14px;">Rows</span>
            </div>
        </div>
    </div>

    <!-- Filter Panel -->
    <div id="snFilterPanel" style="display: none; position: fixed; top: 0; right: 0; width: 450px; height: 100vh; background: white; box-shadow: -2px 0 8px rgba(0,0,0,0.1); z-index: 1500; overflow-y: auto;">
        <div style="background: #5d5d8d; color: white; padding: 20px; display: flex; justify-content: space-between; align-items: center;">
            <h3 style="margin: 0; font-size: 18px;">Filters</h3>
            <button id="snFilterPanelClose" style="background: none; border: none; color: white; font-size: 24px; cursor: pointer;">&times;</button>
        </div>
        <div style="padding: 20px;">
            <div style="margin-bottom: 20px;">
                <label style="display: block; margin-bottom: 8px; font-weight: 500;">Contact Type</label>
                <select id="snContactTypeFilter" style="width: 100%; padding: 10px; border: 1px solid #d0d0d0; border-radius: 6px;">
                    <option value="">--Select--</option>
                    <option value="Phone">Phone</option>
                    <option value="In-Person">In-Person</option>
                    <option value="Video">Video</option>
                    <option value="Email">Email</option>
                </select>
            </div>
            <div style="margin-bottom: 20px;">
                <label style="display: block; margin-bottom: 8px; font-weight: 500;">Current Supervisor</label>
                <select id="snSupervisorFilter" style="width: 100%; padding: 10px; border: 1px solid #d0d0d0; border-radius: 6px;">
                    <option value="">--Select--</option>
                    <option value="Dhanya Patel">Dhanya Patel</option>
                    <option value="Sarah Supervisor">Sarah Supervisor</option>
                </select>
            </div>
            <div style="margin-bottom: 20px;">
                <label style="display: block; margin-bottom: 8px; font-weight: 500;">Current Care Manager</label>
                <select id="snCareManagerFilter" style="width: 100%; padding: 10px; border: 1px solid #d0d0d0; border-radius: 6px;">
                    <option value="">--Select--</option>
                    <option value="Aziz Gida">Aziz Gida</option>
                    <option value="Sweta Sharma">Sweta Sharma</option>
                    <option value="Mohammed Ahmed">Mohammed Ahmed</option>
                    <option value="Heather Thompson">Heather Thompson</option>
                    <option value="Sara Posorske">Sara Posorske</option>
                    <option value="Jolee Williams">Jolee Williams</option>
                    <option value="Dhanya Patel">Dhanya Patel</option>
                </select>
            </div>
        </div>
        <div style="padding: 16px 20px; border-top: 1px solid #e0e0e0; display: flex; gap: 12px;">
            <button id="snFilterCancelBtn" style="flex: 1; padding: 10px; border: 1px solid #d0d0d0; border-radius: 6px; background: white; cursor: pointer;">Cancel</button>
            <button id="snFilterApplyBtn" style="flex: 1; padding: 10px; border: none; border-radius: 6px; background: #4c6fff; color: white; cursor: pointer;">Apply</button>
        </div>
    </div>
    `;
}

// Render service notes table rows
function renderServiceNotesTableRows() {
    const tbody = document.getElementById('snTableBody');
    if (!tbody) return;

    if (snFilteredNotes.length === 0) {
        document.getElementById('snNoResults').style.display = 'block';
        tbody.innerHTML = '';
        return;
    }

    document.getElementById('snNoResults').style.display = 'none';
    
    tbody.innerHTML = snFilteredNotes.map(note => {
        const statusClass = note.status === 'Draft' ? 'background: #fff3e0; color: #ef6c00;' : 'background: #e8f5e9; color: #2e7d32;';
        
        return `
            <tr style="border-bottom: 1px solid #f0f0f0;">
                <td style="padding: 16px 12px; color: #4c6fff; cursor: pointer;">${note.id}</td>
                <td style="padding: 16px 12px; color: #4c6fff; cursor: pointer;">${note.member}</td>
                <td style="padding: 16px 12px;">${note.supervisor || '-'}</td>
                <td style="padding: 16px 12px;">${note.careManager}</td>
                <td style="padding: 16px 12px;">${note.createdBy}</td>
                <td style="padding: 16px 12px;">${note.contactType}</td>
                <td style="padding: 16px 12px;">${note.activity}</td>
                <td style="padding: 16px 12px;">${note.duration} min</td>
                <td style="padding: 16px 12px;">${note.dateOfService}</td>
                <td style="padding: 16px 12px;">${note.submittedAt}</td>
                <td style="padding: 16px 12px;">
                    <span style="padding: 4px 12px; border-radius: 12px; font-size: 12px; font-weight: 500; ${statusClass}">${note.status}</span>
                </td>
            </tr>
        `;
    }).join('');

    // Update count
    const countEl = document.getElementById('snNoteCount');
    if (countEl) countEl.textContent = snFilteredNotes.length;
    
    const pageInfo = document.getElementById('snPageInfo');
    if (pageInfo) pageInfo.textContent = `Page 1 of 1 (${snFilteredNotes.length} notes)`;
}

// Apply service notes filters
function applyServiceNotesFilters() {
    snFilteredNotes = allServiceNotes.filter(note => {
        // Status filter
        if (snActiveFilters.noteStatus.length > 0 && !snActiveFilters.noteStatus.includes(note.status)) {
            return false;
        }

        // Created By filter
        if (snActiveFilters.createdBy.length > 0 && !snActiveFilters.createdBy.includes(note.createdBy)) {
            return false;
        }

        // Contact Type filter
        if (snActiveFilters.contactType && note.contactType !== snActiveFilters.contactType) {
            return false;
        }

        // Supervisor filter
        if (snActiveFilters.supervisor && note.supervisor !== snActiveFilters.supervisor) {
            return false;
        }

        // Care Manager filter
        if (snActiveFilters.careManager && note.careManager !== snActiveFilters.careManager) {
            return false;
        }

        // Search filter
        if (snActiveFilters.search) {
            const search = snActiveFilters.search.toLowerCase();
            if (!note.id.toLowerCase().includes(search) && 
                !note.member.toLowerCase().includes(search)) {
                return false;
            }
        }

        return true;
    });

    renderServiceNotesTableRows();
}

// Initialize service notes page event listeners
function initializeServiceNotesPage() {
    // Search input
    const searchInput = document.getElementById('snSearchInput');
    if (searchInput) {
        searchInput.addEventListener('input', function() {
            snActiveFilters.search = this.value;
            applyServiceNotesFilters();
        });
    }

    // Status dropdown
    setupSnDropdown('snStatusDropdownBtn', 'snStatusDropdownMenu');
    document.querySelectorAll('#snStatusDropdownMenu input[type="checkbox"]').forEach(cb => {
        cb.addEventListener('change', function() {
            handleSnStatusChange(this);
        });
    });

    // Activity dropdown
    setupSnDropdown('snActivityDropdownBtn', 'snActivityDropdownMenu');

    // Created By dropdown
    setupSnDropdown('snCreatedByDropdownBtn', 'snCreatedByDropdownMenu');
    document.querySelectorAll('#snCreatedByDropdownMenu input[type="checkbox"]').forEach(cb => {
        cb.addEventListener('change', function() {
            handleSnCreatedByChange(this);
        });
    });

    // Filter panel buttons
    const otherFiltersBtn = document.getElementById('snOtherFiltersBtn');
    const filterPanelClose = document.getElementById('snFilterPanelClose');
    const filterCancelBtn = document.getElementById('snFilterCancelBtn');
    const filterApplyBtn = document.getElementById('snFilterApplyBtn');
    const clearFiltersBtn = document.getElementById('snClearFiltersBtn');

    if (otherFiltersBtn) otherFiltersBtn.addEventListener('click', () => {
        document.getElementById('snFilterPanel').style.display = 'block';
    });
    if (filterPanelClose) filterPanelClose.addEventListener('click', () => {
        document.getElementById('snFilterPanel').style.display = 'none';
    });
    if (filterCancelBtn) filterCancelBtn.addEventListener('click', () => {
        document.getElementById('snFilterPanel').style.display = 'none';
    });
    if (filterApplyBtn) filterApplyBtn.addEventListener('click', applySnAdvancedFilters);
    if (clearFiltersBtn) clearFiltersBtn.addEventListener('click', clearAllSnFilters);

    // Apply initial filters and render
    applyServiceNotesFilters();
}

// Setup dropdown toggle for service notes
function setupSnDropdown(buttonId, menuId) {
    const button = document.getElementById(buttonId);
    const menu = document.getElementById(menuId);
    
    if (!button || !menu) return;
    
    // Clone button to remove ALL existing event listeners
    const newButton = button.cloneNode(true);
    button.parentNode.replaceChild(newButton, button);
    
    newButton.addEventListener('click', function(e) {
        e.preventDefault();
        e.stopPropagation();
        
        // Close other dropdowns
        document.querySelectorAll('.service-notes-page-container .filter-dropdown-menu').forEach(m => {
            if (m.id !== menuId) m.style.display = 'none';
        });
        
        // Toggle this menu
        menu.style.display = (menu.style.display === 'none' || menu.style.display === '') ? 'block' : 'none';
    });
}

// Handle status change for service notes
function handleSnStatusChange(checkbox) {
    const value = checkbox.dataset.value;
    
    if (value === 'all') {
        if (checkbox.checked) {
            snActiveFilters.noteStatus = [];
            document.querySelectorAll('#snStatusDropdownMenu input[type="checkbox"]').forEach(c => c.checked = true);
        }
    } else {
        const index = snActiveFilters.noteStatus.indexOf(value);
        if (checkbox.checked && index === -1) {
            snActiveFilters.noteStatus.push(value);
        } else if (!checkbox.checked && index > -1) {
            snActiveFilters.noteStatus.splice(index, 1);
        }
    }
    
    updateSnStatusLabel();
    applyServiceNotesFilters();
}

// Handle created by change for service notes
function handleSnCreatedByChange(checkbox) {
    const value = checkbox.dataset.value;
    
    if (value === 'all') {
        if (checkbox.checked) {
            snActiveFilters.createdBy = [];
            document.querySelectorAll('#snCreatedByDropdownMenu input[type="checkbox"]').forEach(c => c.checked = true);
        }
    } else {
        const index = snActiveFilters.createdBy.indexOf(value);
        if (checkbox.checked && index === -1) {
            snActiveFilters.createdBy.push(value);
        } else if (!checkbox.checked && index > -1) {
            snActiveFilters.createdBy.splice(index, 1);
        }
    }
    
    updateSnCreatedByLabel();
    applyServiceNotesFilters();
}

// Update status label
function updateSnStatusLabel() {
    const label = document.getElementById('snStatusDropdownLabel');
    const btn = document.getElementById('snStatusDropdownBtn');
    if (label) {
        if (snActiveFilters.noteStatus.length === 0) {
            label.textContent = 'All';
            if (btn) btn.style.background = 'white';
            if (btn) btn.style.color = '#333';
            if (btn) btn.style.borderColor = '#d0d0d0';
        } else if (snActiveFilters.noteStatus.length === 1) {
            label.textContent = snActiveFilters.noteStatus[0];
            if (btn) btn.style.background = '#4c6fff';
            if (btn) btn.style.color = 'white';
            if (btn) btn.style.borderColor = '#4c6fff';
        } else {
            label.textContent = `${snActiveFilters.noteStatus.length} selected`;
        }
    }
}

// Update created by label
function updateSnCreatedByLabel() {
    const label = document.getElementById('snCreatedByDropdownLabel');
    const btn = document.getElementById('snCreatedByDropdownBtn');
    if (label) {
        if (snActiveFilters.createdBy.length === 0) {
            label.textContent = 'All';
            if (btn) btn.style.background = 'white';
            if (btn) btn.style.color = '#333';
            if (btn) btn.style.borderColor = '#d0d0d0';
        } else if (snActiveFilters.createdBy.length === 1) {
            label.textContent = snActiveFilters.createdBy[0];
            if (btn) btn.style.background = '#4c6fff';
            if (btn) btn.style.color = 'white';
            if (btn) btn.style.borderColor = '#4c6fff';
        } else {
            label.textContent = `${snActiveFilters.createdBy.length} selected`;
        }
    }
}

// Apply advanced filters
function applySnAdvancedFilters() {
    snActiveFilters.contactType = document.getElementById('snContactTypeFilter')?.value || '';
    snActiveFilters.supervisor = document.getElementById('snSupervisorFilter')?.value || '';
    snActiveFilters.careManager = document.getElementById('snCareManagerFilter')?.value || '';
    
    document.getElementById('snFilterPanel').style.display = 'none';
    applyServiceNotesFilters();
}

// Clear all service notes filters
function clearAllSnFilters() {
    snActiveFilters = {
        noteStatus: [],
        relatedActivity: [],
        createdBy: [],
        createdDateFrom: '',
        createdDateTo: '',
        contactType: '',
        supervisor: '',
        careManager: '',
        search: ''
    };
    
    const searchInput = document.getElementById('snSearchInput');
    if (searchInput) searchInput.value = '';
    
    document.querySelectorAll('#snStatusDropdownMenu input, #snCreatedByDropdownMenu input').forEach(cb => {
        cb.checked = cb.dataset.value === 'all';
    });
    
    // Clear visual filter chips
    const container = document.getElementById('snActiveFiltersContainer');
    if (container) container.innerHTML = '';
    
    // Update filter count badge
    const badge = document.getElementById('snFilterCountBadge');
    if (badge) badge.textContent = '0';
    
    updateSnStatusLabel();
    updateSnCreatedByLabel();
    applyServiceNotesFilters();
}

// Remove status filter chip
function removeSnStatusFilter() {
    snActiveFilters.noteStatus = [];
    document.querySelectorAll('#snStatusDropdownMenu input').forEach(cb => {
        cb.checked = cb.dataset.value === 'all';
    });
    updateSnStatusLabel();
    applyServiceNotesFilters();
}

// Remove created by filter chip
function removeSnCreatedByFilter() {
    snActiveFilters.createdBy = [];
    document.querySelectorAll('#snCreatedByDropdownMenu input').forEach(cb => {
        cb.checked = cb.dataset.value === 'all';
    });
    updateSnCreatedByLabel();
    applyServiceNotesFilters();
}

// Close dropdowns when clicking outside
document.addEventListener('click', function() {
    document.querySelectorAll('.service-notes-page-container .filter-dropdown-menu').forEach(menu => {
        menu.style.display = 'none';
    });
});

// NAV CLICK HANDLER FOR SERVICE NOTES
document.addEventListener('DOMContentLoaded', function() {
    const serviceNotesLink = document.getElementById('navServiceNotes');
    if(serviceNotesLink) {
        serviceNotesLink.addEventListener('click', (e) => {
            e.preventDefault();
            // Clear other active states
            document.querySelectorAll('.sidebar-nav .nav-item').forEach(i => i.classList.remove('active'));
            // Set Service Notes active
            serviceNotesLink.classList.add('active');
            
            // Render service notes page
            document.getElementById('pageContainer').innerHTML = generateServiceNotesPageHTML();
            
            // Initialize event listeners
            setTimeout(initializeServiceNotesPage, 0);
        });
    }
});

// GLOBAL: Close dropdowns when clicking outside
document.addEventListener('click', function(e) {
    // Don't close if clicking inside a dropdown
    if (e.target.closest('.filter-dropdown-menu') || e.target.closest('.filter-dropdown-button')) {
        return;
    }
    
    // Close all task dropdowns
    document.querySelectorAll('.task-page-container .filter-dropdown-menu').forEach(function(menu) {
        menu.style.display = 'none';
    });
    
    // Close all service notes dropdowns
    document.querySelectorAll('.service-notes-page-container .filter-dropdown-menu').forEach(function(menu) {
        menu.style.display = 'none';
    });
});


// 
// SEVIDA AI  ALL FEATURES COMBINED
// 1. Activity-aware Service Note Drafting
// 2. Smart Contextual Questions on Member Open
// 3. Free-Text LLM Chat (multi-turn)
// ADDITIVE ONLY  zero existing functions modified except sendAIMessage (replaced)
// 

const ANTHROPIC_API_KEY = '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';

// 
// FEATURE 1: ACTIVITY-AWARE SERVICE NOTE DRAFTING
// 

window._aiDraftActivities    = [];
window._aiPreselectedTaskId  = null;
window._aiSmartDraftFilter   = null;

function collectMemberActivities(m) {
    const activities = [];
    const today = new Date(); today.setHours(0,0,0,0);
    const sevenDaysAgo = new Date(today.getTime() - 7 * 86400000);
    const allTasks = ((m.dashboardData?.tasks || []).concat(m.tasks || []));
    const seenIds = new Set();
    allTasks.forEach(t => {
        if (seenIds.has(t.id)) return; seenIds.add(t.id);
        if ((t.status || '').toLowerCase() === 'closed') return;
        activities.push({ type: 'task', id: t.id, label: t.title || t.name || t.type || 'Task', meta: `${t.type || 'Task'}  ${t.priority || 'Medium'} priority  Due ${t.dueDate || ''}`, data: t });
    });
    (m.dashboardData?.adts || []).forEach((adt, i) => {
        if (adt.acknowledged === 'Yes') return;
        activities.push({ type: 'adt', id: 'adt-' + i, label: `Post-Discharge Follow-up  ${adt.type || 'ADT Event'}`, meta: `${adt.facility || 'Facility'}  ${adt.date || 'Recent'}  Dx: ${adt.diagnosis || ''}`, data: adt });
    });
    const cs = m.consentStatus || '';
    if (['To Obtain Consent', 'Re-consent Required'].includes(cs)) {
        activities.push({ type: 'consent', id: 'consent-outreach', label: cs === 'Re-consent Required' ? 'Re-consent Outreach Call' : 'Consent Outreach Call', meta: `Current status: ${cs}  Log contact attempt or consent result`, data: { consentStatus: cs } });
    }
    (m.appointments || []).forEach((appt, i) => {
        const apptDate = new Date(appt.startDate);
        if (apptDate >= sevenDaysAgo && apptDate <= today) {
            activities.push({ type: 'appt', id: 'appt-' + i, label: `Post-Visit Note  ${appt.title || appt.type || 'Appointment'}`, meta: `${appt.type || 'Visit'}  ${appt.startDate ? new Date(appt.startDate).toLocaleDateString('en-US',{month:'short',day:'numeric'}) : 'Recent'}  ${appt.duration || ''}`, data: appt });
        }
    });
    return activities;
}

(function() {
    const _origDraft = qDraftServiceNote;
    qDraftServiceNote = function() {
        const m = window.currentMember;
        if (!m) return _origDraft.apply(this, arguments);
        const activities = collectMemberActivities(m);
        window._aiDraftActivities = activities;
        if (window._aiPreselectedTaskId) {
            const idx = activities.findIndex(a => a.type === 'task' && a.id === window._aiPreselectedTaskId);
            window._aiPreselectedTaskId = null;
            if (idx !== -1) return { _customHTML: renderServiceNoteForm(m, activities[idx]) };
        }
        if (window._aiSmartDraftFilter) {
            const filter = window._aiSmartDraftFilter; window._aiSmartDraftFilter = null;
            const idx = activities.findIndex(a => a.type === filter);
            if (idx !== -1) return { _customHTML: renderServiceNoteForm(m, activities[idx]) };
        }
        if (activities.length === 1) return { _customHTML: renderServiceNoteForm(m, activities[0]) };
        return { _customHTML: renderActivityPicker(m, activities) };
    };
})();

function renderActivityPicker(m, activities) {
    const badgeClass = { task: 'badge-task', consent: 'badge-consent', adt: 'badge-adt', appt: 'badge-appt' };
    const badgeLabel = { task: 'Task', consent: 'Consent', adt: 'ADT', appt: 'Appointment' };
    let itemsHTML = activities.length === 0
        ? `<div class="ai-picker-empty"><div class="empty-icon"></div><p>No open tasks or recent events found for ${m.name}.</p></div>`
        : activities.map((act, idx) => `
            <button class="ai-picker-item" onclick="selectActivityAndDraft(${idx})">
                <span class="ai-picker-badge ${badgeClass[act.type]}">${badgeLabel[act.type]}</span>
                <div class="picker-body"><div class="picker-title">${escapeHtml(act.label)}</div><div class="picker-meta">${escapeHtml(act.meta)}</div></div>
                <span class="picker-arrow"></span>
            </button>`).join('');
    return `<div class="ai-response-block"><div class="ai-activity-picker">
        <div class="ai-picker-heading">Which activity is this note for?</div>
        ${itemsHTML}
        <button class="ai-picker-general-btn" onclick="selectActivityAndDraft(-1)">+ Draft a general service note instead</button>
    </div><div class="ai-back-row" style="margin-top:8px;"><button class="ai-back-btn" onclick="resetAICopilot()"> Back to questions</button></div></div>`;
}

function selectActivityAndDraft(idx) {
    const m = window.currentMember; if (!m) return;
    const activity = idx >= 0 ? (window._aiDraftActivities || [])[idx] : null;
    const container = document.getElementById('aiMessages'); if (!container) return;
    container.innerHTML = `<div class="ai-thinking-container"><div class="ai-thinking-dots"><div class="tdot"></div><div class="tdot"></div><div class="tdot"></div></div><div class="ai-thinking-text">Building draft from activity...</div></div>`;
    setTimeout(() => { container.innerHTML = `<div class="ai-conv-assistant">${renderServiceNoteForm(m, activity)}</div>`; }, 500);
}

function renderServiceNoteForm(m, activity) {
    const draft = activity ? buildDraftFromActivity(m, activity) : analyzeForNoteDraft(m);
    const dateStr = new Date().toISOString().split('T')[0];
    const activityBadge = activity
        ? `<div class="ai-smart-hint" style="margin-bottom:12px;"><div class="hint-label"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="12" height="12"><path d="M13 2L3 14h9l-1 8 10-12h-9l1-8z"/></svg>${activity.type === 'task' ? 'From Task' : activity.type === 'adt' ? 'ADT Follow-up' : activity.type === 'consent' ? 'Consent Action' : 'Post-Visit'}</div><div class="hint-text">${escapeHtml(activity.label)}</div></div>`
        : `<div class="ai-smart-hint"><div class="hint-label"><svg viewBox="0 0 24 24" fill="currentColor" width="12" height="12"><path d="M12 2L13.09 8.26L18 6L14.74 10.91L21 12L14.74 13.09L18 18L13.09 15.74L12 22L10.91 15.74L6 18L9.26 13.09L3 12L9.26 10.91L6 6L10.91 8.26L12 2Z"/></svg>AI Draft</div><div class="hint-text">${draft.reason}</div></div>`;
    return `<div class="ai-response-block"><div class="ai-appt-form" id="aiServiceNoteForm">
        <div class="form-title"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><polyline points="14,2 14,8 20,8"/></svg>Draft Service Note  ${m.name}</div>
        ${activityBadge}
        <div class="field-group"><label class="field-label">Contact Type <span class="req">*</span></label><select id="snType">
            <option value="Phone Call - Outbound" ${draft.type==='Phone Call - Outbound'?'selected':''}>Phone Call - Outbound</option>
            <option value="Phone Call - Inbound" ${draft.type==='Phone Call - Inbound'?'selected':''}>Phone Call - Inbound</option>
            <option value="Home Visit" ${draft.type==='Home Visit'?'selected':''}>Home Visit</option>
            <option value="Telehealth" ${draft.type==='Telehealth'?'selected':''}>Telehealth</option>
            <option value="Care Coordination" ${draft.type==='Care Coordination'?'selected':''}>Care Coordination</option>
        </select></div>
        <div class="field-group"><label class="field-label">Activity <span class="req">*</span></label><input type="text" id="snActivity" value="${escapeHtml(draft.activity)}"><div class="form-error" id="snActivityError">Please enter an activity</div></div>
        <div class="datetime-row">
            <div class="field-group"><label class="field-label">Date</label><input type="date" id="snDate" value="${dateStr}"></div>
            <div class="field-group"><label class="field-label">Duration</label><select id="snDuration">
                <option value="10 min" ${draft.duration==='10 min'?'selected':''}>10 min</option>
                <option value="15 min" ${draft.duration==='15 min'?'selected':''}>15 min</option>
                <option value="20 min" ${draft.duration==='20 min'?'selected':''}>20 min</option>
                <option value="25 min" ${draft.duration==='25 min'?'selected':''}>25 min</option>
                <option value="30 min" ${draft.duration==='30 min'?'selected':''}>30 min</option>
                <option value="45 min" ${draft.duration==='45 min'?'selected':''}>45 min</option>
            </select></div>
        </div>
        <div class="field-group"><label class="field-label">Note Summary <span class="req">*</span></label><textarea id="snSummary" rows="6" style="min-height:100px">${escapeHtml(draft.summary)}</textarea><div class="form-error" id="snSummaryError">Please enter a summary</div></div>
        <div class="field-group"><label class="field-label">Outcome</label><select id="snOutcome">${draft.outcomes.map(o => `<option value="${o}" ${o===draft.selectedOutcome?'selected':''}>${o}</option>`).join('')}</select></div>
        <div class="ai-improve-section">
            <button class="ai-improve-btn" id="aiImproveBtn" onclick="improveNoteWithAI()">
                <svg viewBox="0 0 24 24" fill="currentColor" width="12" height="12"><path d="M12 2L13.09 8.26L18 6L14.74 10.91L21 12L14.74 13.09L18 18L13.09 15.74L12 22L10.91 15.74L6 18L9.26 13.09L3 12L9.26 10.91L6 6L10.91 8.26L12 2Z"/></svg>
                Improve with AI
            </button>
            <span class="ai-improve-status" id="aiImproveStatus"></span>
        </div>
        <hr class="form-divider">
        <div class="form-actions">
            <button class="btn-cancel-appt" onclick="resetAICopilot()">Cancel</button>
            <button class="btn-create-appt" id="snSubmitBtn" onclick="submitAIServiceNote()"><span id="snSubmitText">Save Draft</span></button>
        </div>
    </div></div>`;
}

function buildDraftFromActivity(m, activity) {
    const hh = m.healthHistory || {}; const meds = (hh.medications || []).map(med => med.name).filter(Boolean).slice(0,4).join(', ') || '';
    const dx = m.diagnoses || {}; const dxList = [dx.primary, dx.secondary, dx.tertiary].filter(Boolean).map(d => d.split(' - ')[1] || d);
    const dxShort = dxList.join(', ') || 'documented conditions';
    const generalOutcomes = ['Successful','Callback Requested','Left Voicemail','No Answer','Other'];
    const t = activity.data;
    switch (activity.type) {
        case 'task': {
            const taskName = t.title || t.name || t.type || 'Task';
            const tl = (t.type||'').toLowerCase();
            if (tl.includes('consent')) return { type:'Phone Call - Outbound', activity:'Outreach for Consent', duration:'15 min', summary:`Called ${m.name} regarding enrollment in the care management program.\n\nExplained program benefits including care coordination, health monitoring, and ongoing support services. Member asked questions about the program and expressed interest.\n\nMember agreed to participate and provided verbal consent. Documented consent in member record.\n\nPlan: Begin intake assessment and develop care plan.`, outcomes:['Consent Obtained','Callback Requested','Left Voicemail','No Answer','Member Declined'], selectedOutcome:'Consent Obtained', reason:`Task: "${taskName}"  drafting consent outreach note.` };
            if (tl.includes('assessment')) return { type:'Phone Call - Outbound', activity:'Health Risk Assessment', duration:'35 min', summary:`Conducted Health Risk Assessment with ${m.name}.\n\nReviewed medical history and current conditions${dxShort?' ('+dxShort+')':''}. ${meds?'Confirmed current medications: '+meds+'.':''} Assessed social support systems, functional status, and health goals.\n\nMember engaged well and provided thorough responses. Identified priority health needs and discussed next steps.\n\nPlan: Review assessment findings and begin care plan development.`, outcomes:['Assessment Completed','Assessment Started','Callback Requested','No Answer'], selectedOutcome:'Assessment Completed', reason:`Task: "${taskName}"  drafting assessment note.` };
            if (tl.includes('care plan')) return { type:'Phone Call - Outbound', activity:'Care Plan Review', duration:'30 min', summary:`Reviewed care plan with ${m.name}.\n\nDiscussed progress on current care plan goals${dxShort?' related to '+dxShort:''}. Member reported progress on established goals. ${meds?'Medication adherence confirmed ('+meds+').':''}\n\nUpdated care plan goals based on member feedback. Member expressed understanding and commitment to updated plan.\n\nPlan: Continue monitoring. Next review in 30 days.`, outcomes:['Care Plan Updated','Goals Reviewed','Callback Requested','No Answer'], selectedOutcome:'Care Plan Updated', reason:`Task: "${taskName}"  drafting care plan note.` };
            return { type:'Phone Call - Outbound', activity:taskName, duration:'20 min', summary:`Completed care management follow-up with ${m.name} for task: ${taskName}.\n\n${dxShort?'Current conditions: '+dxShort+'. ':''}${meds?'Medications reviewed: '+meds+'. ':''}Member cooperative and engaged during contact.\n\nAddressed task objectives. Member verbalized understanding of next steps.\n\nPlan: Update task status and follow up as needed.`, outcomes:generalOutcomes, selectedOutcome:'Successful', reason:`Task: "${taskName}"  drafting follow-up note.` };
        }
        case 'adt': return { type:'Phone Call - Outbound', activity:'Post-Discharge Follow-up', duration:'25 min', summary:`Contacted ${m.name} regarding recent ${t.type||'hospital'} event at ${t.facility||'facility'} on ${t.date||'recent date'}${t.diagnosis?' (Dx: '+t.diagnosis+')':''}.\n\nReviewed discharge instructions and confirmed member's understanding of follow-up care. ${meds?'Current medications confirmed: '+meds+'.':''} Member reports stable condition at home with no immediate concerns.\n\nEncouraged scheduling PCP follow-up appointment within 7 days. Reviewed warning signs requiring emergency care.\n\nPlan: Acknowledge ADT event in system. Follow up in 4872 hours to confirm PCP appointment.`, outcomes:['Successful','PCP Appointment Scheduled','Callback Requested','Left Voicemail','No Answer'], selectedOutcome:'Successful', reason:`Unacknowledged ADT event at ${t.facility||'facility'}  drafting post-discharge note.` };
        case 'consent': { const isR = t.consentStatus==='Re-consent Required'; return { type:'Phone Call - Outbound', activity:isR?'Re-consent Outreach':'Outreach for Consent', duration:'15 min', summary:`Called ${m.name} to discuss ${isR?'annual re-consent for continuation of':'enrollment in'} the care management program.\n\nExplained program services including care coordination, health monitoring, and support resources. ${isR?'Reviewed care management services provided over the past year.':''} Member asked questions regarding program participation.\n\nMember agreed to continue participation. ${isR?'Re-consent':'Verbal consent'} obtained and documented.\n\nPlan: Update consent status. ${isR?'Continue care management activities.':'Schedule initial assessment.'}`, outcomes:['Consent Obtained','Callback Requested','Left Voicemail','No Answer','Member Declined'], selectedOutcome:'Consent Obtained', reason:`Consent status is "${t.consentStatus}"  drafting consent outreach note.` }; }
        case 'appt': return { type:t.type?.includes('Home')?'Home Visit':t.type?.includes('Video')?'Telehealth':'Phone Call - Outbound', activity:`Post-Visit Follow-up  ${t.title||t.type||'Appointment'}`, duration:'20 min', summary:`Completed ${t.type||'appointment'} with ${m.name} on ${t.startDate?new Date(t.startDate).toLocaleDateString('en-US',{month:'long',day:'numeric',year:'numeric'}):'scheduled date'}.\n\n${dxShort?'Reviewed current health status related to '+dxShort+'. ':''}${meds?'Medication adherence discussed: '+meds+'.':''} Member reported current status and any changes since last contact.\n\nNo urgent concerns identified during visit.\n\nPlan: Document visit outcomes. Follow up in 30 days or as needed.`, outcomes:['Visit Completed','Goals Reviewed','Follow-up Scheduled','Referral Made'], selectedOutcome:'Visit Completed', reason:`Post-visit note for "${t.title||t.type||'appointment'}".` };
        default: return analyzeForNoteDraft(m);
    }
}

(function() {
    const _origDash = generateDashboardHTML;
    generateDashboardHTML = function(member) {
        let html = _origDash.apply(this, arguments);
        html = html.replace(/<td><a href="#" onclick="alert\('Task: ([^']+)'\)">([^<]+)<\/a><\/td>/g, function(match, title, label) {
            const allTasks = ((member.dashboardData?.tasks||[]).concat(member.tasks||[]));
            const task = allTasks.find(t => (t.title||t.name||'') === label);
            const taskId = (task?.id||'').replace(/'/g,"\\'");
            return `<td><div style="display:flex;align-items:center;gap:6px;flex-wrap:wrap;"><a href="#" onclick="alert('Task: ${label.replace(/'/g,"\\'")}')"> ${label}</a><button class="task-draft-note-btn" onclick="openAICopilotForTask('${taskId}',event)"> Draft Note</button></div></td>`;
        });
        return html;
    };
})();

function openAICopilotForTask(taskId, event) {
    if (event) { event.preventDefault(); event.stopPropagation(); }
    window._aiPreselectedTaskId = taskId;
    if (!aiCopilotState.isOpen) toggleAICopilot();
    setTimeout(() => { handleAIQuestion('mx_draft_note'); }, 300);
}

function handleSmartDraftNote(activityType) {
    window._aiSmartDraftFilter = activityType;
    if (!aiCopilotState.isOpen) toggleAICopilot();
    setTimeout(() => { handleAIQuestion('mx_draft_note'); }, 300);
}

async function improveNoteWithAI() {
    const m = window.currentMember; if (!m) return;
    const summaryEl = document.getElementById('snSummary');
    const btn = document.getElementById('aiImproveBtn');
    const statusEl = document.getElementById('aiImproveStatus');
    if (!summaryEl || !btn) return;
    const currentText = summaryEl.value.trim(); if (!currentText) return;
    const hh = m.healthHistory||{}; const dx = m.diagnoses||{}; const cpd = m.carePlanData||{};
    const meds = (hh.medications||[]).map(med=>med.name).filter(Boolean).slice(0,5).join(', ')||'not documented';
    const dxList = [dx.primary,dx.secondary,dx.tertiary,dx.additional].filter(Boolean).map(d=>d.split(' - ')[1]||d);
    const dxText = dxList.join(', ')||'no documented diagnoses';
    const goals = (cpd.needs||[]).slice(0,3).map(n=>n.category+(n.goals?.[0]?.text?': '+n.goals[0].text.substring(0,60):'')).join('; ')||'no active goals';
    const contactType = document.getElementById('snType')?.value||'';
    const activity = document.getElementById('snActivity')?.value||'';
    btn.disabled=true; btn.innerHTML=`<span class="ai-improve-spinner"></span> Improving...`;
    if (statusEl) { statusEl.textContent=''; statusEl.style.color=''; }
    try {
        const response = await fetch('https://api.anthropic.com/v1/messages', {
            method:'POST',
            headers:{ 'Content-Type':'application/json', 'x-api-key': ANTHROPIC_API_KEY, 'anthropic-version':'2023-06-01', 'anthropic-dangerous-direct-browser-access':'true' },
            body: JSON.stringify({ model:'claude-sonnet-4-20250514', max_tokens:700, system:`You are a clinical care management assistant. Write professional documentation-ready service notes. Use past tense. Never use placeholder brackets []. Only use real data provided.`, messages:[{ role:'user', content:`Improve this care management service note. Replace every [placeholder] with real clinical language.\n\nMEMBER: ${m.name}, Age: ${m.age||'N/A'}, Risk: ${m.riskCategory||'N/A'}\nDIAGNOSES: ${dxText}\nMEDICATIONS: ${meds}\nCARE GOALS: ${goals}\nCONTACT TYPE: ${contactType}\nACTIVITY: ${activity}\n\nDRAFT:\n${currentText}\n\nReturn ONLY the improved note. 3-4 paragraphs. Past tense.` }] })
        });
        const data = await response.json();
        const improved = data?.content?.[0]?.text?.trim();
        if (!improved) throw new Error('Empty');
        summaryEl.value = improved; summaryEl.style.minHeight='150px';
        btn.innerHTML=`<svg viewBox="0 0 24 24" fill="currentColor" width="12" height="12"><path d="M12 2L13.09 8.26L18 6L14.74 10.91L21 12L14.74 13.09L18 18L13.09 15.74L12 22L10.91 15.74L6 18L9.26 13.09L3 12L9.26 10.91L6 6L10.91 8.26L12 2Z"/></svg> Improve again`;
        btn.disabled=false;
        if (statusEl) { statusEl.textContent=' Note improved'; statusEl.style.color='#10b981'; setTimeout(()=>{ if(statusEl) statusEl.textContent=''; },3000); }
    } catch(err) {
        btn.innerHTML=`<svg viewBox="0 0 24 24" fill="currentColor" width="12" height="12"><path d="M12 2L13.09 8.26L18 6L14.74 10.91L21 12L14.74 13.09L18 18L13.09 15.74L12 22L10.91 15.74L6 18L9.26 13.09L3 12L9.26 10.91L6 6L10.91 8.26L12 2Z"/></svg> Improve with AI`;
        btn.disabled=false;
        if (statusEl) { statusEl.textContent=' Could not improve  try again'; statusEl.style.color='#ef4444'; setTimeout(()=>{ if(statusEl) statusEl.textContent=''; },4000); }
        console.warn('[AI Improve Note]', err);
    }
}

// 
// FEATURE 2: SMART CONTEXTUAL QUESTIONS ON MEMBER OPEN
// 

(function() {
    const _origRender = renderWelcomeScreen;
    renderWelcomeScreen = function() {
        _origRender.apply(this, arguments);
        const member = window.currentMember; if (!member) return;
        const panel = document.getElementById('aiQuestionsPanel'); if (!panel) return;
        const smartQs = generateSmartQuestions(member); if (!smartQs.length) return;
        const itemsHTML = smartQs.map(q => `
            <button class="ai-smart-q urgency-${q.urgency}" onclick="${q.action}">
                <span class="ai-smart-q-dot"></span>
                <div class="ai-smart-q-body">
                    <div class="ai-smart-q-text">${q.text}</div>
                    <div class="ai-smart-q-reason">${q.reason}</div>
                </div>
                <span class="ai-smart-q-arrow"></span>
            </button>`).join('');
        panel.insertAdjacentHTML('afterbegin', `<div class="ai-smart-section" id="aiSmartSection"><div class="ai-smart-section-heading"> Suggested for ${member.name.split(' ')[0]}</div>${itemsHTML}</div>`);
    };
})();

function generateSmartQuestions(m) {
    const questions = [];
    const dd = m.dashboardData||{}; const hh = m.healthHistory||{}; const cpd = m.carePlanData||{}; const safety = m.safetyConcern||{};
    const today = new Date(); today.setHours(0,0,0,0);
    const allTasks = (dd.tasks||[]).concat(m.tasks||[]);
    const openTasks = allTasks.filter(t=>(t.status||'').toLowerCase()!=='closed');
    const overdueTasks = openTasks.filter(t=>{ const d=parseAnyDate(t.dueDate); return d&&d<today; });
    const hpTasks = openTasks.filter(t=>t.priority==='High');
    const allADTs = (dd.adts||[]).concat(hh.adts||[]);
    const unackedADTs = allADTs.filter(a=>a.acknowledged==='No');
    const assessAct = m.assessmentActivity||[];
    const inProgress = assessAct.filter(a=>a.status==='In Progress');
    const completed = assessAct.filter(a=>a.status==='Completed');
    const needsCP = completed.length>0 && (cpd.needs||[]).length===0;
    const needsConsent = ['To Obtain Consent','Re-consent Required'].includes(m.consentStatus);
    const isReconsent = m.consentStatus==='Re-consent Required';
    const notes = m.serviceNotes||[]; const lastNote = notes.length>0?notes[notes.length-1]:null;
    const daysSince = lastNote ? Math.floor((Date.now()-(parseAnyDate(lastNote.date)||0))/86400000) : null;

    if (safety.hasConcern) questions.push({ urgency:'critical', text:' Safety concern is active  review now', reason:`${safety.details||safety.type||'Safety flag'}  Requires immediate attention`, action:`handleAIQuestion('mx_attention')` });
    if (unackedADTs.length>0) { const evt=unackedADTs[0]; questions.push({ urgency:'critical', text:`Post-discharge follow-up needed  ${evt.type||'ADT event'}`, reason:`${evt.facility||'Facility'}  ${evt.date||'Recent'}  Not yet acknowledged`, action:`handleSmartDraftNote('adt')` }); }
    if (overdueTasks.length>0) questions.push({ urgency:'high', text:`${overdueTasks.length} overdue task${overdueTasks.length>1?'s':''} need action`, reason:`${hpTasks.length>0?hpTasks.length+' high priority  ':''}Longest overdue: ${overdueTasks[0].title||overdueTasks[0].name||'Task'}`, action:`handleAIQuestion('mx_open_tasks')` });
    if (needsConsent) questions.push({ urgency:'high', text:isReconsent?'Annual re-consent is due  draft outreach note':'Consent not yet obtained  log a contact attempt', reason:`Current status: ${m.consentStatus}  ${isReconsent?'Care management on hold until re-consented':'Member cannot be fully enrolled until consented'}`, action:`handleSmartDraftNote('consent')` });
    if (inProgress.length>0) { const ip=inProgress[0]; questions.push({ urgency:'normal', text:`${ip.title||'Assessment'} is in progress  draft continuation note`, reason:`Started ${fmtDate(ip.date)||'recently'}  Document progress so far`, action:`handleSmartDraftNote('task')` }); }
    if (needsCP&&!safety.hasConcern&&!needsConsent) questions.push({ urgency:'normal', text:'Assessment complete  what are the care plan next steps?', reason:`${completed.length} assessment${completed.length>1?'s':''} done  Care plan not yet started`, action:`handleAIQuestion('mx_care_gaps')` });
    if (daysSince!==null&&daysSince>=14&&questions.length<3) questions.push({ urgency:'normal', text:`Last contact was ${daysSince} days ago  time to check in?`, reason:`Last note: ${lastNote.activity||lastNote.type||'Contact'} on ${fmtDate(lastNote.date)}`, action:`handleAIQuestion('mx_draft_note')` });
    if (questions.length===0) questions.push({ urgency:'normal', text:'What should I focus on for this member?', reason:`${openTasks.length} open task${openTasks.length!==1?'s':''}  Risk: ${m.riskCategory||'Unknown'}`, action:`handleAIQuestion('mx_next_focus')` });
    return questions.slice(0,3);
}

// 
// FEATURE 3: FREE-TEXT LLM CHAT (multi-turn, member-aware)
// 

function sendAIMessage() {
    const input = document.getElementById('aiInputField'); if (!input) return;
    const text = input.value.trim(); if (!text) return;
    input.value = '';
    const allQs = [];
    Object.values(AI_TABS).forEach(tab => allQs.push(...tab.questions));
    Object.entries(FOLLOWUP_QUESTIONS).forEach(([id,q]) => allQs.push({...q,id}));
    if (window.currentMember) getAllMemberContextQuestions(window.currentMember).forEach(q => allQs.push(q));
    const exactMatch = allQs.find(q => q.text.toLowerCase()===text.toLowerCase());
    if (exactMatch) { handleAIQuestion(exactMatch.id); return; }
    const fuzzyMatch = allQs.find(q => text.toLowerCase().includes(q.text.toLowerCase().split(' ').slice(2).join(' ')));
    if (fuzzyMatch) { handleAIQuestion(fuzzyMatch.id); return; }
    sendLLMMessage(text);
}

async function sendLLMMessage(userText) {
    const container = document.getElementById('aiMessages'); if (!container) return;
    aiCopilotState.isInConversation = true;
    const userBubbleId = 'chat_user_' + Date.now();
    container.innerHTML += `<div class="ai-chat-turn" id="${userBubbleId}"><div class="ai-conv-user"><div class="ai-conv-user-bubble">${escapeHtml(userText)}</div></div></div>`;
    const thinkId = 'chat_think_' + Date.now();
    container.innerHTML += `<div id="${thinkId}" class="ai-thinking-container"><div class="ai-thinking-dots"><div class="tdot"></div><div class="tdot"></div><div class="tdot"></div></div><div class="ai-thinking-text">Thinking...</div></div>`;
    container.scrollTop = container.scrollHeight;
    const history = (aiCopilotState.conversationHistory||[]).slice(-10);
    aiCopilotState.conversationHistory = aiCopilotState.conversationHistory||[];
    aiCopilotState.conversationHistory.push({ role:'user', content:userText });
    try {
        const response = await fetch('https://api.anthropic.com/v1/messages', {
            method:'POST',
            headers:{ 'Content-Type':'application/json', 'x-api-key': ANTHROPIC_API_KEY, 'anthropic-version':'2023-06-01', 'anthropic-dangerous-direct-browser-access':'true' },
            body: JSON.stringify({ model:'claude-sonnet-4-20250514', max_tokens:800, system:buildChatSystemPrompt(), messages:[...history,{role:'user',content:userText}] })
        });
        const data = await response.json();
        const replyText = data?.content?.[0]?.text?.trim();
        if (!replyText) throw new Error('Empty response');
        aiCopilotState.conversationHistory.push({ role:'assistant', content:replyText });
        document.getElementById(thinkId)?.remove();
        container.innerHTML += `<div class="ai-chat-turn"><div class="ai-conv-assistant"><div class="ai-response-block"><div class="ai-llm-response">${renderMarkdown(replyText)}</div><div class="ai-feedback-row" style="margin-top:10px;"><button class="ai-feedback-btn" onclick="this.style.color='#2d2d52'" title="Helpful"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 9V5a3 3 0 00-3-3l-4 9v11h11.28a2 2 0 002-1.7l1.38-9a2 2 0 00-2-2.3H14z"/></svg></button><button class="ai-feedback-btn" onclick="this.style.color='#ef4444'" title="Not helpful"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M10 15v4a3 3 0 003 3l4-9V2H5.72a2 2 0 00-2 1.7l-1.38 9a2 2 0 002 2.3H10z"/></svg></button><button class="ai-back-btn" style="margin-left:auto;" onclick="resetAICopilot()"> New question</button></div></div></div></div>`;
        container.scrollTop = container.scrollHeight;
    } catch(err) {
        document.getElementById(thinkId)?.remove();
        container.innerHTML += `<div class="ai-chat-turn"><div class="ai-conv-assistant"><div class="ai-response-block"><div class="ai-response-summary" style="color:#ef4444;"> Could not connect to AI  please try again.</div><div class="ai-back-row"><button class="ai-back-btn" onclick="resetAICopilot()"> Back to questions</button></div></div></div></div>`;
        container.scrollTop = container.scrollHeight;
        aiCopilotState.conversationHistory.pop();
        console.warn('[AI Chat]', err);
    }
}

function buildChatSystemPrompt() {
    const m = window.currentMember;
    const base = `You are Sevida AI Co-pilot, an intelligent assistant built into a healthcare care management platform. Help care managers work efficiently by answering questions about their members, tasks, and caseload.\n\nRESPONSE RULES:\n- Be concise and clinically professional.\n- Use bullet points for lists, bold for key values. Keep under 250 words unless detail is needed.\n- Never make up clinical data. Only reference data provided in this prompt.\n- If asked to draft a note, remind the user to use the "Draft a service note" button for the full form.`;
    if (!m) {
        const total = typeof membersDB!=='undefined'?membersDB.length:0;
        const highRisk = typeof membersDB!=='undefined'?membersDB.filter(x=>x.riskCategory==='High').length:0;
        const consentNeeded = typeof membersDB!=='undefined'?membersDB.filter(x=>['To Obtain Consent','Re-consent Required'].includes(x.consentStatus)).length:0;
        const withADT = typeof membersDB!=='undefined'?membersDB.filter(x=>(x.dashboardData?.adts||[]).some(a=>a.acknowledged==='No')).length:0;
        return `${base}\n\nCONTEXT: Care Manager Dashboard\nCASELOAD: ${total} total members  ${highRisk} high risk  ${consentNeeded} need consent  ${withADT} with unacknowledged ADT events`;
    }
    const hh=m.healthHistory||{}; const cpd=m.carePlanData||{}; const dd=m.dashboardData||{}; const dx=m.diagnoses||{}; const safety=m.safetyConcern||{};
    const dxList=[dx.primary,dx.secondary,dx.tertiary,dx.additional].filter(Boolean).map(d=>d.replace(' - ',': ')).join(', ')||'None documented';
    const meds=(hh.medications||[]).slice(0,8).map(med=>`${med.name}${med.dose?' '+med.dose:''}${med.frequency?' '+med.frequency:''}`).join(', ')||'None documented';
    const allTasks=(dd.tasks||[]).concat(m.tasks||[]);
    const openTasks=allTasks.filter(t=>(t.status||'').toLowerCase()!=='closed');
    const today=new Date(); today.setHours(0,0,0,0);
    const overdueTasks=openTasks.filter(t=>{const d=parseAnyDate(t.dueDate);return d&&d<today;});
    const tasksText=openTasks.length>0?openTasks.slice(0,6).map(t=>`${t.title||t.name||'Task'} (${t.status}, ${t.priority||'Normal'} priority${overdueTasks.includes(t)?', OVERDUE':''})`).join(' | '):'None';
    const adts=(dd.adts||[]).concat(hh.adts||[]);
    const adtsText=adts.length>0?adts.slice(0,5).map(a=>`${a.type||'Event'} at ${a.facility||''} on ${a.date||''} [Ack: ${a.acknowledged||'No'}]`).join(' | '):'None';
    const assessAct=m.assessmentActivity||[];
    const inProg=assessAct.filter(a=>a.status==='In Progress').map(a=>a.title).join(', ')||'None';
    const done=assessAct.filter(a=>a.status==='Completed').map(a=>a.title).join(', ')||'None';
    const needs=cpd.needs||[];
    const cpText=needs.length>0?needs.slice(0,4).map(n=>`${n.category}: ${(n.goals||[]).slice(0,2).map(g=>g.text?.substring(0,50)+'('+g.status+')').join(', ')}`).join(' | '):'No care plan needs';
    const recentNotes=(m.serviceNotes||[]).slice(-3).reverse().map(n=>`${n.date||''}: ${n.activity||n.type||'Contact'} (${n.outcome||''})`).join(' | ')||'No notes';
    return `${base}\n\nCONTEXT: Member Profile  ${m.name}\nID: ${m.id} | Age: ${m.age||''} | Risk: ${m.riskCategory||''} | Consent: ${m.consentStatus||''} | Program: ${m.program||''}\n${safety.hasConcern?` SAFETY CONCERN: ${safety.details||safety.type||'Active flag'}\n`:''}\nDIAGNOSES: ${dxList}\nMEDICATIONS: ${meds}\nOPEN TASKS (${openTasks.length}, ${overdueTasks.length} overdue): ${tasksText}\nADT EVENTS: ${adtsText}\nASSESSMENTS  In Progress: ${inProg} | Completed: ${done}\nCARE PLAN (${needs.length} needs): ${cpText}\nRECENT NOTES: ${recentNotes}`;
}

function renderMarkdown(text) {
    if (!text) return '';
    let html = escapeHtml(text);
    html = html.replace(/^### (.+)$/gm,'<h3>$1</h3>');
    html = html.replace(/^## (.+)$/gm,'<h3>$1</h3>');
    html = html.replace(/\*\*(.+?)\*\*/g,'<strong>$1</strong>');
    html = html.replace(/__(.+?)__/g,'<strong>$1</strong>');
    html = html.replace(/\*([^*\n]+)\*/g,'<em>$1</em>');
    html = html.replace(/`([^`]+)`/g,'<code>$1</code>');
    html = html.replace(/^---+$/gm,'<hr>');
    html = html.replace(/((?:^[\-\*] .+(?:\n|$))+)/gm,(match)=>{
        const items=match.trim().split('\n').map(line=>`<li>${line.replace(/^[\-\*] /,'')}</li>`).join('');
        return `<ul>${items}</ul>`;
    });
    html = html.replace(/((?:^\d+\. .+(?:\n|$))+)/gm,(match)=>{
        const items=match.trim().split('\n').map(line=>`<li>${line.replace(/^\d+\. /,'')}</li>`).join('');
        return `<ol>${items}</ol>`;
    });
    html = html.replace(/\n\n+/g,'</p><p>');
    html = html.replace(/\n/g,'<br>');
    if (!html.match(/^<[houpl]/)) html = `<p>${html}</p>`;
    return html;
}

(function() {
    const orig = window.resetAICopilot;
    window.resetAICopilot = function() {
        aiCopilotState.conversationHistory = [];
        orig.apply(this, arguments);
    };
})();

// 
// END SEVIDA AI FEATURES

// 
// CARE PLAN AI FEATURES  ADDITIVE
// 1. Care Plan Summary with Print
// 2. Add New Need (AI-suggested from diagnoses)
// 3. Update Follow-up Date on Needs
// 4. Log a Care Plan Review
// 5. Update Goal Status
// 

//  Inject new questions into the careplans sub-tab 
(function() {
    const _origGetQs = getMemberContextQuestions;
    getMemberContextQuestions = function(member, subTab) {
        const qs = _origGetQs.apply(this, arguments);
        if (subTab === 'careplans') {
            const newQs = [
                { id: 'mx_ai_cp_summary',    text: ' Show care plan summary & print', handler: 'qAICarePlanSummary' },
                { id: 'mx_ai_cp_add_need',   text: ' Add a new care plan need',        handler: 'qAIAddNeed' },
                { id: 'mx_ai_cp_followup',   text: ' Update follow-up dates',           handler: 'qAIUpdateFollowUp' },
                { id: 'mx_ai_cp_log_review', text: ' Log a care plan review',           handler: 'qAILogReview' },
                { id: 'mx_ai_cp_goal',       text: ' Update goal status',               handler: 'qAIUpdateGoalStatus' },
            ];
            // Prepend so they appear before generic questions
            return [...newQs, ...qs];
        }
        return qs;
    };
})();

//  Helper: refresh care plan tab if visible 
function refreshCarePlanTab() {
    try {
        if (typeof CarePlanController !== 'undefined' && CarePlanController.currentMember) {
            CarePlanController.currentMember = window.currentMember;
            const area = document.getElementById('cpContentArea');
            if (area) area.innerHTML = CarePlanController.getContentHTML();
        }
    } catch(e) { /* not on care plan tab  fine */ }
}

//  Helper: care plan status badge 
function cpNeedBadge(status) {
    const map = { 'In Progress': 'badge-cp-inprogress', 'Identified': 'badge-cp-identified', 'Met': 'badge-cp-met', 'On Hold': 'badge-cp-onhold' };
    return `<span class="ai-cp-need-badge ${map[status]||'badge-cp-identified'}">${status||'Identified'}</span>`;
}
function cpGoalStatusClass(status) {
    if (!status) return 'goal-status-planned';
    const s = status.toLowerCase();
    if (s.includes('met')) return 'goal-status-met';
    if (s.includes('risk') || s.includes('not')) return 'goal-status-atrisk';
    if (s.includes('progress')) return 'goal-status-inprogress';
    return 'goal-status-planned';
}
function fmtDateShort(d) {
    if (!d) return '';
    try { return new Date(d).toLocaleDateString('en-US', { month:'short', day:'numeric', year:'numeric' }); } catch(e) { return d; }
}

// 
// 1. CARE PLAN SUMMARY + PRINT
// 

//  Plan helpers 
function getAllCarePlans(m) {
    // Merge from header widget carePlans array if available
    const headerPlans = (m.carePlans || []).map(p => ({
        id:     p.id,
        name:   p.name || p.shortName || 'Care Plan',
        status: (p.status || 'active').toLowerCase()
    }));
    // If no header plans, synthesise one from carePlanData
    if (headerPlans.length === 0 && (m.carePlanData?.needs||[]).length > 0) {
        return [{ id: '__default__', name: 'Care Plan', status: 'active' }];
    }
    return headerPlans;
}

function getActivePlans(m) {
    return getAllCarePlans(m).filter(p => ['active','in progress','in-progress'].includes(p.status));
}

function getNeedsForPlan(m, planId) {
    const allNeeds = m.carePlanData?.needs || [];
    if (!planId || planId === '__all__') return allNeeds;
    const tagged = allNeeds.filter(n => n.planId === planId);
    // Fall back to all untagged needs if this is the first/only plan
    if (tagged.length === 0 && getAllCarePlans(m).length <= 1) return allNeeds;
    return tagged;
}

// Plan status badge colour
function planStatusStyle(status) {
    const s = (status||'').toLowerCase();
    if (s === 'active')       return 'background:#dcfce7;color:#166534;';
    if (s.includes('progress')) return 'background:#fff7ed;color:#c2410c;';
    if (s === 'planned' || s === 'to be started') return 'background:#ede9fe;color:#5b21b6;';
    if (s === 'completed')    return 'background:#f1f5f9;color:#475569;';
    if (s === 'inactive')     return 'background:#f1f5f9;color:#94a3b8;';
    return 'background:#f1f5f9;color:#64748b;';
}

//  Plan picker  shared across all 5 actions 
// action: string passed back to selectPlanAndAction()
function renderPlanPicker(m, action, heading) {
    const plans = getAllCarePlans(m);
    const statusOrder = ['active','in progress','in-progress','planned','to be started','completed','inactive'];

    const sorted = [...plans].sort((a,b) => {
        return statusOrder.indexOf(a.status) - statusOrder.indexOf(b.status);
    });

    const itemsHTML = sorted.map((p, i) => {
        const needCount = getNeedsForPlan(m, p.id).length;
        const allGoals  = getNeedsForPlan(m, p.id).flatMap(n => n.goals||[]);
        const metGoals  = allGoals.filter(g => g.status === 'Met').length;
        return `<button class="ai-picker-item" onclick="selectPlanAndAction('${p.id}','${action}')">
            <div style="width:8px;height:8px;border-radius:50%;flex-shrink:0;margin-top:5px;background:${['active','in progress','in-progress'].includes(p.status)?'#10b981':p.status==='completed'?'#94a3b8':'#f59e0b'};"></div>
            <div class="picker-body">
                <div class="picker-title">${p.name}</div>
                <div class="picker-meta">${needCount} need${needCount!==1?'s':''}  ${allGoals.length} goal${allGoals.length!==1?'s':''}  ${metGoals} met</div>
            </div>
            <span style="font-size:9px;font-weight:700;padding:2px 7px;border-radius:8px;${planStatusStyle(p.status)}">${p.status.charAt(0).toUpperCase()+p.status.slice(1)}</span>
            <span class="picker-arrow"></span>
        </button>`;
    }).join('');

    const allHTML = action === 'summary'
        ? `<button class="ai-picker-general-btn" onclick="selectPlanAndAction('__all__','${action}')">View all plans together</button>`
        : '';

    return `<div class="ai-response-block"><div class="ai-activity-picker">
        <div class="ai-picker-heading">${heading || 'Which care plan?'}</div>
        <div style="font-size:11px;color:#64748b;margin-bottom:10px;">${m.name.split(' ')[0]} has ${plans.length} care plans. Pick one to continue:</div>
        ${itemsHTML}
        ${allHTML}
    </div>
    <div class="ai-back-row"><button class="ai-back-btn" onclick="resetAICopilot()"> Back</button></div></div>`;
}

// Called when user picks a plan from the picker
function selectPlanAndAction(planId, action) {
    window._aiSelectedPlanId = planId;
    const container = document.getElementById('aiMessages');
    if (container) {
        container.innerHTML = `<div class="ai-thinking-container">
            <div class="ai-thinking-dots"><div class="tdot"></div><div class="tdot"></div><div class="tdot"></div></div>
            <div class="ai-thinking-text">Loading</div></div>`;
    }
    setTimeout(() => {
        const qMap = {
            summary:    'mx_ai_cp_summary',
            add_need:   'mx_ai_cp_add_need',
            followup:   'mx_ai_cp_followup',
            log_review: 'mx_ai_cp_log_review',
            goal:       'mx_ai_cp_goal',
        };
        if (qMap[action]) handleAIQuestion(qMap[action]);
    }, 300);
}

// 
function qAICarePlanSummary() {
    const m = window.currentMember;
    if (!m) return { summary: 'No member selected.', emptyMsg: '' };

    const plans = getAllCarePlans(m);
    const planId = window._aiSelectedPlanId || null;

    // Multiple plans and none selected yet  show picker
    if (plans.length > 1 && !planId) {
        window._aiSelectedPlanId = null;
        return { _customHTML: renderPlanPicker(m, 'summary', 'Which care plan summary?') };
    }

    // Which plans to show
    const plansToShow = (planId === '__all__' || !planId)
        ? plans
        : plans.filter(p => p.id === planId);

    // Build per-plan sections
    const cpd      = m.carePlanData || {};
    const activity = cpd.activity || [];
    const lastReview = [...activity].reverse().find(a => (a.name||'').toLowerCase().includes('review'));

    let totalNeeds = 0, totalGoals = 0, totalMet = 0, totalRisk = 0;

    const planSections = plansToShow.map(plan => {
        const needs     = getNeedsForPlan(m, plan.id);
        const allGoals  = needs.flatMap(n => n.goals||[]);
        const metGoals  = allGoals.filter(g => g.status==='Met').length;
        const atRisk    = allGoals.filter(g => (g.status||'').toLowerCase().includes('risk')).length;
        const nextFU    = needs.filter(n=>n.followUpDate).sort((a,b)=>new Date(a.followUpDate)-new Date(b.followUpDate))[0];

        totalNeeds += needs.length;
        totalGoals += allGoals.length;
        totalMet   += metGoals;
        totalRisk  += atRisk;

        const needsHTML = needs.length === 0
            ? `<div class="ai-cp-empty" style="margin:0;">No needs linked to this plan yet.</div>`
            : needs.map(n => {
                const goalsHTML = (n.goals||[]).length > 0
                    ? (n.goals||[]).map(g => `<div class="ai-cp-goal-row">
                        <span style="color:#94a3b8;font-size:11px;"></span>
                        <div class="ai-cp-goal-text">${g.text||''}</div>
                        <span class="ai-cp-goal-status ${cpGoalStatusClass(g.status)}">${g.status||'Planned'}</span>
                      </div>`).join('')
                    : `<div style="font-size:11px;color:#94a3b8;padding:4px 0;">No goals defined</div>`;
                return `<div class="ai-cp-need-card">
                    <div class="ai-cp-need-header">
                        ${cpNeedBadge(n.status)}
                        <div class="ai-cp-need-title">${n.category||'Need'}</div>
                        <div class="ai-cp-need-meta">Follow-up: ${fmtDateShort(n.followUpDate)}</div>
                    </div>
                    <div style="padding:6px 12px 4px;font-size:11px;color:#475569;border-bottom:1px solid #f1f5f9;">${n.text||''}</div>
                    <div class="ai-cp-need-goals">${goalsHTML}</div>
                </div>`;
            }).join('');

        const planHeader = plansToShow.length > 1
            ? `<div style="display:flex;align-items:center;gap:8px;margin:14px 0 8px;padding-bottom:6px;border-bottom:2px solid #e2e8f0;">
                <div style="font-size:12px;font-weight:700;color:#1e293b;flex:1;">${plan.name}</div>
                <span style="font-size:9px;font-weight:700;padding:2px 8px;border-radius:8px;${planStatusStyle(plan.status)}">${plan.status.charAt(0).toUpperCase()+plan.status.slice(1)}</span>
                ${nextFU ? `<span style="font-size:10px;color:#64748b;">Next follow-up: ${fmtDateShort(nextFU.followUpDate)}</span>` : ''}
              </div>`
            : '';

        return planHeader + needsHTML;
    }).join('');

    const html = `<div class="ai-response-block" id="aiCpSummaryBlock">
        <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:10px;">
            <div style="font-size:12px;font-weight:700;color:#1e293b;">
                ${plansToShow.length === 1 ? plansToShow[0].name : `All Plans (${plans.length})`}
                ${plansToShow.length === 1 ? `<span style="font-size:9px;font-weight:700;padding:2px 8px;border-radius:8px;margin-left:6px;${planStatusStyle(plansToShow[0].status)}">${plansToShow[0].status.charAt(0).toUpperCase()+plansToShow[0].status.slice(1)}</span>` : ''}
            </div>
            <button class="ai-cp-print-btn no-print" style="margin:0;" onclick="printCarePlanSummary()">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="13" height="13"><polyline points="6 9 6 2 18 2 18 9"/><path d="M6 18H4a2 2 0 01-2-2v-5a2 2 0 012-2h16a2 2 0 012 2v5a2 2 0 01-2 2h-2"/><rect x="6" y="14" width="12" height="8"/></svg>
                Print
            </button>
        </div>

        <div class="ai-cp-stat-row">
            <div class="ai-cp-stat"><div class="num">${totalNeeds}</div><div class="lbl">Needs</div></div>
            <div class="ai-cp-stat"><div class="num">${totalGoals}</div><div class="lbl">Goals</div></div>
            <div class="ai-cp-stat"><div class="num">${totalMet}</div><div class="lbl">Goals Met</div></div>
            <div class="ai-cp-stat"><div class="num">${totalRisk}</div><div class="lbl">At Risk</div></div>
        </div>

        <div style="font-size:10px;color:#64748b;margin-bottom:10px;">
            ${lastReview ? `Last review: ${fmtDateShort(lastReview.date)} by ${lastReview.updatedBy||''}` : 'No reviews logged'}
            ${plans.length > 1 && planId !== '__all__' ? `  <button class="ai-back-btn" style="font-size:10px;" onclick="window._aiSelectedPlanId=null;handleAIQuestion('mx_ai_cp_summary')">View all plans</button>` : ''}
        </div>

        <div class="ai-cp-summary-block">${planSections}</div>

        <div class="ai-feedback-row" style="margin-top:10px;">
            <button class="ai-cp-print-btn no-print" style="margin:0;" onclick="window._aiSelectedPlanId=null;handleAIQuestion('mx_ai_cp_add_need')">+ Add Need</button>
            <button class="ai-cp-print-btn no-print" style="margin:0;" onclick="window._aiSelectedPlanId=null;handleAIQuestion('mx_ai_cp_log_review')">Log Review</button>
            <button class="ai-back-btn no-print" style="margin-left:auto;" onclick="window._aiSelectedPlanId=null;resetAICopilot()"> Back</button>
        </div>
    </div>`;

    window._aiSelectedPlanId = null; // reset after use
    return { _customHTML: html };
}

//  Print  plan-aware 
function printCarePlanSummary() {
    const m = window.currentMember;
    if (!m) return;
    document.getElementById('aiCpPrintArea')?.remove();

    const plans  = getAllCarePlans(m);
    const cpd    = m.carePlanData || {};
    const activity = cpd.activity || [];
    const lastReview = [...activity].reverse().find(a => (a.name||'').toLowerCase().includes('review'));

    const allNeeds = cpd.needs || [];
    const allGoals = allNeeds.flatMap(n => n.goals||[]);

    const planSectionsHTML = plans.map(plan => {
        const needs = getNeedsForPlan(m, plan.id);
        if (needs.length === 0) return '';
        const needsHTML = needs.map(n => `
            <div style="margin-bottom:12px;border:1px solid #e2e8f0;border-radius:5px;overflow:hidden;">
                <div style="background:#f1f5f9;padding:7px 12px;display:flex;gap:8px;align-items:center;">
                    <strong style="font-size:12px;">${n.category||'Need'}</strong>
                    <span style="font-size:10px;color:#64748b;">${n.status||'Identified'}</span>
                    <span style="margin-left:auto;font-size:10px;color:#64748b;">Follow-up: ${fmtDateShort(n.followUpDate)}</span>
                </div>
                <div style="padding:7px 12px;font-size:11px;color:#475569;">${n.text||''}</div>
                ${(n.goals||[]).length > 0 ? `<div style="padding:3px 12px 8px;">
                    ${(n.goals||[]).map(g=>`<div style="font-size:11px;padding:2px 0;display:flex;gap:6px;">
                        <span style="color:#94a3b8;"></span><span style="flex:1;">${g.text||''}</span>
                        <span style="color:#64748b;">${g.status||'Planned'}</span>
                    </div>`).join('')}
                </div>` : ''}
            </div>`).join('');
        return `<div style="margin-bottom:20px;">
            <div style="display:flex;align-items:center;gap:8px;padding:8px 0;border-bottom:1px solid #e2e8f0;margin-bottom:10px;">
                <h3 style="margin:0;font-size:13px;color:#2d2d52;flex:1;">${plan.name}</h3>
                <span style="font-size:10px;font-weight:700;padding:2px 8px;border-radius:8px;${planStatusStyle(plan.status)}">${plan.status}</span>
            </div>
            ${needsHTML}
        </div>`;
    }).join('');

    const printDiv = document.createElement('div');
    printDiv.id = 'aiCpPrintArea';
    printDiv.style.cssText = 'display:none;position:fixed;top:0;left:0;width:100%;z-index:99999;background:white;overflow:auto;height:100%;';
    printDiv.innerHTML = `
        <div style="padding:32px 40px;font-family:Arial,sans-serif;max-width:800px;margin:0 auto;">
            <div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:20px;padding-bottom:14px;border-bottom:2px solid #2d2d52;">
                <div>
                    <h1 style="margin:0;font-size:18px;color:#2d2d52;">${m.name}  Care Plan Summary</h1>
                    <div style="font-size:11px;color:#64748b;margin-top:3px;">ID: ${m.id}  ${m.riskCategory||''} Risk  ${m.consentStatus||''}</div>
                </div>
                <div style="font-size:10px;color:#64748b;text-align:right;">
                    Printed: ${new Date().toLocaleDateString('en-US',{month:'long',day:'numeric',year:'numeric'})}<br>
                    ${lastReview ? `Last review: ${fmtDateShort(lastReview.date)}` : 'No reviews logged'}
                </div>
            </div>
            <div style="display:flex;gap:12px;margin-bottom:18px;">
                <div style="flex:1;background:#f8fafc;border:1px solid #e2e8f0;border-radius:5px;padding:8px;text-align:center;">
                    <div style="font-size:20px;font-weight:700;color:#2d2d52;">${plans.length}</div><div style="font-size:10px;color:#64748b;">Plans</div>
                </div>
                <div style="flex:1;background:#f8fafc;border:1px solid #e2e8f0;border-radius:5px;padding:8px;text-align:center;">
                    <div style="font-size:20px;font-weight:700;color:#2d2d52;">${allNeeds.length}</div><div style="font-size:10px;color:#64748b;">Needs</div>
                </div>
                <div style="flex:1;background:#f8fafc;border:1px solid #e2e8f0;border-radius:5px;padding:8px;text-align:center;">
                    <div style="font-size:20px;font-weight:700;color:#2d2d52;">${allGoals.length}</div><div style="font-size:10px;color:#64748b;">Goals</div>
                </div>
                <div style="flex:1;background:#dcfce7;border:1px solid #bbf7d0;border-radius:5px;padding:8px;text-align:center;">
                    <div style="font-size:20px;font-weight:700;color:#166534;">${allGoals.filter(g=>g.status==='Met').length}</div><div style="font-size:10px;color:#166534;">Goals Met</div>
                </div>
            </div>
            ${planSectionsHTML || '<p style="color:#64748b;font-size:12px;">No needs documented.</p>'}
            <div style="margin-top:20px;padding-top:10px;border-top:1px solid #e2e8f0;font-size:10px;color:#94a3b8;text-align:center;">
                Sevida Care Management Platform  ${m.careManager||'Care Manager'}  Confidential
            </div>
        </div>`;
    document.body.appendChild(printDiv);
    printDiv.style.display = 'block';
    setTimeout(() => { window.print(); setTimeout(() => { printDiv.style.display = 'none'; }, 500); }, 100);
}

// 
// 2. ADD NEW CARE PLAN NEED (AI-suggested, plan-aware)
// 
function qAIAddNeed() {
    const m = window.currentMember;
    if (!m) return { summary: 'No member selected.', emptyMsg: '' };

    const plans      = getAllCarePlans(m);
    const suggestions = suggestCarePlanNeeds(m);

    // Build plan selector options  always shown, includes "No plan" option
    const planOptions = plans.map(p => {
        const needCount = getNeedsForPlan(m, p.id).length;
        const statusDot = {active:'#10b981','in-progress':'#f59e0b','in progress':'#f59e0b',planned:'#6366f1',completed:'#94a3b8'}[(p.status||'').toLowerCase()]||'#94a3b8';
        return `<option value="${p.id}">${p.name} (${p.status})  ${needCount} need${needCount!==1?'s':''}</option>`;
    }).join('');

    // Default: pre-select the first active plan, or first plan
    const defaultPlanId = plans.find(p => ['active','in-progress','in progress'].includes((p.status||'').toLowerCase()))?.id
        || plans[0]?.id || '__none__';

    // Build suggestion cards (existingCats checked dynamically via JS on plan change)
    const suggestHTML = suggestions.map((s, i) => {
        const shortText = s.text.length > 90
            ? s.text.substring(0, s.text.lastIndexOf(' ', 90)) + ''
            : s.text;
        return `<label class="ai-cp-suggest-card" style="display:flex;align-items:flex-start;gap:10px;cursor:pointer;padding:10px 12px;" id="suggest-card-${i}">
            <input type="radio" name="cpNeedSuggest" value="${i}" style="margin-top:3px;flex-shrink:0;accent-color:#2d2d52;">
            <div style="flex:1;min-width:0;">
                <div style="font-size:12px;font-weight:600;color:#1e293b;line-height:1.4;margin-bottom:3px;">
                    ${s.category}
                    <span id="already-badge-${i}" style="display:none;font-size:9px;background:#fff7ed;color:#c2410c;padding:1px 6px;border-radius:8px;font-weight:700;margin-left:5px;vertical-align:middle;">Already has a need</span>
                </div>
                <div style="font-size:11px;color:#64748b;line-height:1.4;">${shortText}</div>
            </div>
        </label>`;
    }).join('');

    // JS to update "already has a need" badges when plan changes
    const suggestionsJSON = JSON.stringify(suggestions.map(s => s.category));

    const addNeedHTML = `<div class="ai-response-block"><div class="ai-cp-action-form">
        <div class="ai-picker-heading"> Add Care Plan Need  ${m.name}</div>

        <div class="field-group" style="margin-bottom:12px;">
            <label class="field-label" style="font-size:11px;font-weight:700;color:#374151;margin-bottom:5px;display:block;">Link to care plan</label>
            <select id="cpSelectedPlanId" onchange="updateAlreadyBadges()" style="padding:8px 10px;border:1px solid #e2e8f0;border-radius:6px;font-size:12px;font-family:inherit;width:100%;background:white;">
                ${planOptions}
                <option value="__none__"> No plan (standalone need)</option>
            </select>
        </div>

        <div style="font-size:11px;color:#64748b;margin-bottom:8px;">Suggested based on ${m.name.split(' ')[0]}'s diagnoses:</div>
        <div id="cpNeedSuggestions">${suggestHTML}</div>

        <div class="field-group" style="margin-top:10px;">
            <label class="field-label" style="font-size:11px;">Or type a custom need:</label>
            <input type="text" id="cpCustomNeedText" placeholder="e.g. Member needs support with transportation to appointments" style="font-size:12px;padding:7px 10px;border:1px solid #e2e8f0;border-radius:6px;width:100%;font-family:inherit;box-sizing:border-box;">
            <select id="cpCustomNeedCat" style="margin-top:6px;padding:6px 8px;border:1px solid #e2e8f0;border-radius:6px;font-size:11px;font-family:inherit;width:100%;">
                <option value="">Select category</option>
                <option>Care Coordination</option>
                <option>Chronic Disease Management</option>
                <option>Medication Management</option>
                <option>Behavioral Health</option>
                <option>Social Support</option>
                <option>Patient Education</option>
                <option>Transitional Care</option>
                <option>Housing & Safety</option>
            </select>
        </div>

        <button class="ai-cp-save-btn" onclick="saveNewCarePlanNeedFromForm()">Add Need</button>
        <div class="ai-back-row"><button class="ai-back-btn" onclick="resetAICopilot()"> Back</button></div>
    </div></div>`;

    // Set default selection and update badges after DOM renders
    const _dpId = defaultPlanId;
    setTimeout(() => {
        const sel = document.getElementById('cpSelectedPlanId');
        if (sel) { sel.value = _dpId; updateAlreadyBadges(); }
    }, 50);

    return { _customHTML: addNeedHTML };
}

// Update "Already has a need" badges based on selected plan
function updateAlreadyBadges() {
    const m = window.currentMember;
    if (!m) return;
    const planId = document.getElementById('cpSelectedPlanId')?.value;
    const plans  = getAllCarePlans(m);
    const existingCats = planId === '__none__'
        ? []
        : getNeedsForPlan(m, planId === '__default__' ? null : planId).map(n => n.category);

    const suggestions = suggestCarePlanNeeds(m);
    suggestions.forEach((s, i) => {
        const badge = document.getElementById(`already-badge-${i}`);
        if (badge) badge.style.display = existingCats.includes(s.category) ? 'inline' : 'none';
    });
}

function saveNewCarePlanNeedFromForm() {
    const planId = document.getElementById('cpSelectedPlanId')?.value || '__none__';
    saveNewCarePlanNeed(planId);
}

function suggestCarePlanNeeds(m) {
    const dx = m.diagnoses || {};
    const dxAll = [dx.primary, dx.secondary, dx.tertiary, dx.additional].filter(Boolean).join(' ').toLowerCase();

    const rules = [
        { keywords: ['heart failure','cardiac failure','congestive'], cat: 'Chronic Disease Management', text: 'Member needs support managing heart failure including symptom monitoring, fluid management, and medication adherence' },
        { keywords: ['diabetes','hyperglycemia','glucose'],           cat: 'Chronic Disease Management', text: 'Member needs support managing Type 2 diabetes including blood glucose monitoring, dietary guidance, and medication adherence' },
        { keywords: ['hypertension','blood pressure'],                cat: 'Chronic Disease Management', text: 'Member needs support managing hypertension through medication adherence, dietary changes, and regular BP monitoring' },
        { keywords: ['copd','pulmonary','obstructive'],               cat: 'Chronic Disease Management', text: 'Member needs support managing COPD including pulmonary rehabilitation access and exacerbation prevention planning' },
        { keywords: ['kidney','renal','ckd'],                         cat: 'Chronic Disease Management', text: 'Member needs support managing chronic kidney disease including dietary restrictions, nephrology coordination, and lab monitoring' },
        { keywords: ['depress','anxiety','mental','behavioral'],      cat: 'Behavioral Health',          text: 'Member needs behavioral health support including counseling referrals, medication management, and coping strategy development' },
        { keywords: ['lipid','cholesterol','hyperlipidemia'],         cat: 'Medication Management',      text: 'Member needs medication management support for hyperlipidemia including statin adherence monitoring and dietary guidance' },
        { keywords: ['sleep','apnea'],                                cat: 'Care Coordination',          text: 'Member needs support with sleep apnea management including CPAP adherence monitoring and specialist follow-up scheduling' },
        { keywords: ['pain','musculoskeletal','arthritis'],           cat: 'Social Support',             text: 'Member needs support accessing pain management resources and functional support services to maintain independence' },
    ];

    const seenCats = new Set();
    const suggestions = [];
    rules.forEach(rule => {
        if (seenCats.has(rule.cat)) return;
        if (rule.keywords.some(kw => dxAll.includes(kw))) {
            suggestions.push({ category: rule.cat, text: rule.text });
            seenCats.add(rule.cat);
        }
    });

    const fallbacks = [
        { category: 'Care Coordination',      text: 'Member needs assistance coordinating care between multiple providers to ensure continuity and prevent gaps in care' },
        { category: 'Medication Management',   text: 'Member needs support with medication adherence, reconciliation, and side effect monitoring across all prescriptions' },
        { category: 'Chronic Disease Management', text: 'Member needs support managing chronic conditions through regular monitoring, medication adherence, and provider coordination' },
        { category: 'Social Support',          text: 'Member needs connection to community resources and social support services to address social determinants of health' },
        { category: 'Patient Education',       text: 'Member needs education on disease management, self-care strategies, and warning signs requiring emergency care' },
        { category: 'Behavioral Health',       text: 'Member needs behavioral health support including counseling referrals and coping strategy development' },
        { category: 'Transitional Care',       text: 'Member needs support transitioning between care settings to reduce readmission risk and ensure care continuity' },
        { category: 'Housing & Safety',        text: 'Member needs assessment and support for housing stability and home safety concerns affecting health outcomes' },
    ];
    fallbacks.forEach(f => {
        if (!seenCats.has(f.category) && suggestions.length < 5) {
            suggestions.push(f);
            seenCats.add(f.category);
        }
    });

    return suggestions.slice(0, 5);
}

function saveNewCarePlanNeed(planId) {
    const m = window.currentMember;
    if (!m) return;

    const selectedRadio = document.querySelector('input[name="cpNeedSuggest"]:checked');
    const customText = document.getElementById('cpCustomNeedText')?.value.trim();
    const customCat  = document.getElementById('cpCustomNeedCat')?.value;

    let needText, needCat;
    if (customText && customCat) {
        needText = customText; needCat = customCat;
    } else if (selectedRadio) {
        const suggestions = suggestCarePlanNeeds(m);
        const idx = parseInt(selectedRadio.value);
        needText = suggestions[idx].text; needCat = suggestions[idx].category;
    } else {
        alert('Please select a suggested need or enter a custom need with a category.');
        return;
    }

    if (!m.carePlanData) m.carePlanData = { needs: [], activity: [], barriers: [], gaps: [] };
    if (!m.carePlanData.needs) m.carePlanData.needs = [];

    const today = new Date();
    const followUp = new Date(); followUp.setDate(today.getDate() + 14);
    const plans = getAllCarePlans(m);
    const linkedPlanId = (planId === '__none__' || !planId) ? null : planId;
    const plan  = linkedPlanId ? plans.find(p => p.id === linkedPlanId) : null;
    const planLabel = plan ? plan.name : 'standalone (no plan)';

    m.carePlanData.needs.push({
        id: 'need-' + m.id + '-' + Date.now(),
        planId: linkedPlanId,
        text: needText, category: needCat, status: 'Identified',
        startDate: today.toLocaleDateString('en-US'),
        daysToFollowUp: 14,
        followUpDate: followUp.toLocaleDateString('en-US'),
        goals: []
    });

    if (!m.carePlanData.activity) m.carePlanData.activity = [];
    m.carePlanData.activity.push({
        name: 'Need Added: ' + needCat, status: 'Done',
        date: today.toLocaleDateString('en-US'),
        updatedBy: m.careManager || 'Care Manager',
        planId: linkedPlanId
    });

    refreshCarePlanTab();
    window._aiSelectedPlanId = null;

    const container = document.getElementById('aiMessages');
    if (container) {
        container.innerHTML = `<div class="ai-conv-assistant"><div class="ai-response-block">
            <div class="ai-response-summary"> <strong>"${needCat}"</strong> need added${plan ? ` to <strong>${plan.name}</strong>` : ' as a <strong>standalone need</strong> (not linked to a plan)'} with a 14-day follow-up date.</div>
            <div class="ai-feedback-row" style="margin-top:10px;">
                <button class="ai-cp-save-btn" style="width:auto;padding:6px 12px;" onclick="handleAIQuestion('mx_ai_cp_summary')">View care plan</button>
                <button class="ai-back-btn" style="margin-left:8px;" onclick="resetAICopilot()"> Back</button>
            </div>
        </div></div>`;
    }
}

// 
// 3. UPDATE FOLLOW-UP DATES (plan-aware)
// 
function qAIUpdateFollowUp() {
    const m = window.currentMember;
    if (!m) return { summary: 'No member selected.', emptyMsg: '' };

    const plans  = getAllCarePlans(m);
    const planId = window._aiSelectedPlanId || null;

    if (plans.length > 1 && !planId) {
        return { _customHTML: renderPlanPicker(m, 'followup', 'Update follow-up dates for which plan?') };
    }

    const activePlanId = planId || plans[0]?.id || null;
    const activePlan   = plans.find(p => p.id === activePlanId);
    const needs = getNeedsForPlan(m, activePlanId);

    if (needs.length === 0) {
        return { _customHTML: `<div class="ai-response-block"><div class="ai-cp-empty">No needs found for this plan.<br><br>
            <button class="ai-cp-save-btn" style="width:auto;padding:7px 14px;" onclick="window._aiSelectedPlanId=null;handleAIQuestion('mx_ai_cp_add_need')">+ Add first need</button></div>
            <div class="ai-back-row"><button class="ai-back-btn" onclick="window._aiSelectedPlanId=null;resetAICopilot()"> Back</button></div></div>` };
    }

    const rowsHTML = needs.map((n, i) => {
        let dateVal = '';
        try { const d = new Date(n.followUpDate); if (!isNaN(d)) dateVal = d.toISOString().split('T')[0]; } catch(e) {}
        return `<div class="ai-cp-need-row">
            <div style="flex:1;">
                <div class="ai-cp-need-row-label">${n.category}</div>
                <div class="ai-cp-need-row-cat">${n.status||'Identified'}  Current: ${fmtDateShort(n.followUpDate)}</div>
            </div>
            <input type="date" class="ai-cp-date-input" id="followUpDate_${i}" value="${dateVal}">
        </div>`;
    }).join('');

    const planLabel = activePlan
        ? `<div style="font-size:11px;color:#64748b;margin-bottom:8px;">Plan: <strong>${activePlan.name}</strong>
            ${plans.length > 1 ? `<button class="ai-back-btn" style="font-size:10px;margin-left:8px;" onclick="window._aiSelectedPlanId=null;handleAIQuestion('mx_ai_cp_followup')">Change plan</button>` : ''}</div>`
        : '';

    return { _customHTML: `<div class="ai-response-block"><div class="ai-cp-action-form">
        <div class="ai-picker-heading"> Update Follow-up Dates  ${m.name}</div>
        ${planLabel}${rowsHTML}
        <button class="ai-cp-save-btn" onclick="saveFollowUpDates('${activePlanId}')">Save All Dates</button>
        <div class="ai-back-row"><button class="ai-back-btn" onclick="window._aiSelectedPlanId=null;resetAICopilot()"> Back</button></div>
    </div></div>` };
}

function saveFollowUpDates(planId) {
    const m = window.currentMember;
    if (!m) return;
    const needs = getNeedsForPlan(m, planId);
    let updated = 0;
    needs.forEach((n, i) => {
        const input = document.getElementById('followUpDate_' + i);
        if (input && input.value) {
            const d = new Date(input.value + 'T00:00:00');
            if (!isNaN(d)) {
                n.followUpDate = d.toLocaleDateString('en-US');
                const today = new Date(); today.setHours(0,0,0,0);
                n.daysToFollowUp = Math.max(0, Math.round((d - today) / 86400000));
                updated++;
            }
        }
    });
    refreshCarePlanTab();
    window._aiSelectedPlanId = null;
    const container = document.getElementById('aiMessages');
    if (container) {
        container.innerHTML = `<div class="ai-conv-assistant"><div class="ai-response-block">
            <div class="ai-response-summary"> Updated follow-up dates for <strong>${updated} need${updated!==1?'s':''}</strong>.</div>
            <div class="ai-feedback-row" style="margin-top:10px;">
                <button class="ai-cp-save-btn" style="width:auto;padding:6px 12px;" onclick="handleAIQuestion('mx_ai_cp_summary')">View care plan</button>
                <button class="ai-back-btn" style="margin-left:8px;" onclick="resetAICopilot()"> Back</button>
            </div>
        </div></div>`;
    }
}

// 
// 4. LOG A CARE PLAN REVIEW (plan-aware)
// 
function qAILogReview() {
    const m = window.currentMember;
    if (!m) return { summary: 'No member selected.', emptyMsg: '' };

    const plans  = getAllCarePlans(m);
    const planId = window._aiSelectedPlanId || null;

    if (plans.length > 1 && !planId) {
        return { _customHTML: renderPlanPicker(m, 'log_review', 'Log a review for which plan?') };
    }

    const activePlanId = planId || plans[0]?.id || null;
    const activePlan   = plans.find(p => p.id === activePlanId);
    const todayStr = new Date().toISOString().split('T')[0];
    const cpd = m.carePlanData || {};
    const lastReview = [...(cpd.activity||[])].reverse().find(a =>
        (a.name||'').toLowerCase().includes('review') && (!activePlanId || a.planId === activePlanId || !a.planId)
    );

    const planLabel = activePlan
        ? `<div style="font-size:11px;color:#64748b;margin-bottom:8px;">Plan: <strong>${activePlan.name}</strong>
            ${plans.length > 1 ? `<button class="ai-back-btn" style="font-size:10px;margin-left:8px;" onclick="window._aiSelectedPlanId=null;handleAIQuestion('mx_ai_cp_log_review')">Change plan</button>` : ''}</div>`
        : '';

    return { _customHTML: `<div class="ai-response-block"><div class="ai-cp-action-form">
        <div class="ai-picker-heading"> Log Care Plan Review  ${m.name}</div>
        ${planLabel}
        ${lastReview ? `<div style="font-size:11px;color:#64748b;margin-bottom:10px;">Last review: ${fmtDateShort(lastReview.date)} by ${lastReview.updatedBy||''}</div>` : '<div style="font-size:11px;color:#94a3b8;margin-bottom:10px;">No reviews logged yet.</div>'}
        <div class="field-group" style="margin-bottom:10px;">
            <label class="field-label" style="font-size:11px;">Review Date</label>
            <input type="date" id="cpReviewDate" value="${todayStr}" class="ai-cp-date-input" style="width:100%;display:block;">
        </div>
        <div class="field-group" style="margin-bottom:10px;">
            <label class="field-label" style="font-size:11px;">Review Type</label>
            <select id="cpReviewType" style="padding:6px 8px;border:1px solid #e2e8f0;border-radius:6px;font-size:11px;font-family:inherit;width:100%;">
                <option>Annual Care Plan Review</option>
                <option>Quarterly Review</option>
                <option>Monthly Check-in</option>
                <option>Post-ADT Review</option>
                <option>Goal Review</option>
                <option>Interim Review</option>
            </select>
        </div>
        <div class="field-group" style="margin-bottom:10px;">
            <label class="field-label" style="font-size:11px;">Notes</label>
            <textarea id="cpReviewNotes" rows="3" placeholder="Summarize what was reviewed, any changes, member input" style="width:100%;padding:7px 10px;border:1px solid #e2e8f0;border-radius:6px;font-size:11px;font-family:inherit;resize:vertical;box-sizing:border-box;"></textarea>
        </div>
        <button class="ai-cp-save-btn" onclick="saveCarePlanReview('${activePlanId}')">Log Review</button>
        <div class="ai-back-row"><button class="ai-back-btn" onclick="window._aiSelectedPlanId=null;resetAICopilot()"> Back</button></div>
    </div></div>` };
}

function saveCarePlanReview(planId) {
    const m = window.currentMember;
    if (!m) return;
    const dateInput = document.getElementById('cpReviewDate')?.value;
    const type  = document.getElementById('cpReviewType')?.value || 'Care Plan Review';
    const notes = document.getElementById('cpReviewNotes')?.value.trim();
    if (!dateInput) { alert('Please select a review date.'); return; }
    const d = new Date(dateInput + 'T00:00:00');
    if (!m.carePlanData) m.carePlanData = { needs:[], activity:[], barriers:[], gaps:[] };
    if (!m.carePlanData.activity) m.carePlanData.activity = [];
    const plans = getAllCarePlans(m);
    const plan  = plans.find(p => p.id === planId);
    m.carePlanData.activity.push({
        name: type, status: 'Done', date: d.toLocaleDateString('en-US'),
        updatedBy: m.careManager || 'Care Manager',
        notes: notes || '', planId: planId
    });
    refreshCarePlanTab();
    window._aiSelectedPlanId = null;
    const container = document.getElementById('aiMessages');
    if (container) {
        container.innerHTML = `<div class="ai-conv-assistant"><div class="ai-response-block">
            <div class="ai-response-summary"> <strong>${type}</strong> logged for ${fmtDateShort(d.toLocaleDateString('en-US'))} on <strong>${plan?.name || 'care plan'}</strong>${notes ? '  "' + notes.substring(0,60) + (notes.length>60?'':'') + '"' : ''}.</div>
            <div class="ai-feedback-row" style="margin-top:10px;">
                <button class="ai-cp-save-btn" style="width:auto;padding:6px 12px;" onclick="handleAIQuestion('mx_ai_cp_summary')">View care plan</button>
                <button class="ai-back-btn" style="margin-left:8px;" onclick="resetAICopilot()"> Back</button>
            </div>
        </div></div>`;
    }
}

// 
// 5. UPDATE GOAL STATUS (plan-aware)
// 
function qAIUpdateGoalStatus() {
    const m = window.currentMember;
    if (!m) return { summary: 'No member selected.', emptyMsg: '' };

    const plans  = getAllCarePlans(m);
    const planId = window._aiSelectedPlanId || null;

    if (plans.length > 1 && !planId) {
        return { _customHTML: renderPlanPicker(m, 'goal', 'Update goals for which plan?') };
    }

    const activePlanId = planId || plans[0]?.id || null;
    const activePlan   = plans.find(p => p.id === activePlanId);
    const needs    = getNeedsForPlan(m, activePlanId);
    const allGoals = needs.flatMap(n => (n.goals||[]).map(g => ({...g, needCat:n.category, needId:n.id})));

    if (allGoals.length === 0) {
        return { _customHTML: `<div class="ai-response-block"><div class="ai-cp-empty">No goals found for this plan. Add needs and goals first.</div>
            <div class="ai-back-row"><button class="ai-back-btn" onclick="window._aiSelectedPlanId=null;resetAICopilot()"> Back</button></div></div>` };
    }

    const statusOptions = ['Planned','In Progress','Met','Not Met','At Risk','On Hold'];

    const planLabel = activePlan
        ? `<div style="font-size:11px;color:#64748b;margin-bottom:8px;">Plan: <strong>${activePlan.name}</strong>
            ${plans.length > 1 ? `<button class="ai-back-btn" style="font-size:10px;margin-left:8px;" onclick="window._aiSelectedPlanId=null;handleAIQuestion('mx_ai_cp_goal')">Change plan</button>` : ''}</div>`
        : '';

    const rowsHTML = allGoals.map((g, i) => {
        const opts = statusOptions.map(s => `<option value="${s}" ${s===g.status?'selected':''}>${s}</option>`).join('');
        return `<div class="ai-cp-need-row" style="flex-direction:column;align-items:flex-start;gap:6px;">
            <div style="width:100%;display:flex;align-items:center;gap:8px;">
                <div style="flex:1;">
                    <div class="ai-cp-need-row-label">${g.text||'Goal'}</div>
                    <div class="ai-cp-need-row-cat">Need: ${g.needCat}  Target: ${fmtDateShort(g.targetDate)}</div>
                </div>
                <select class="ai-cp-goal-select" id="goalStatus_${i}" data-need-id="${g.needId}" data-goal-id="${g.id}">${opts}</select>
            </div>
        </div>`;
    }).join('');

    return { _customHTML: `<div class="ai-response-block"><div class="ai-cp-action-form">
        <div class="ai-picker-heading"> Update Goal Status  ${m.name}</div>
        ${planLabel}
        <div style="font-size:11px;color:#64748b;margin-bottom:10px;">${allGoals.length} goal${allGoals.length!==1?'s':''} across ${needs.length} need area${needs.length!==1?'s':''}:</div>
        ${rowsHTML}
        <button class="ai-cp-save-btn" onclick="saveGoalStatuses('${activePlanId}')">Save All Statuses</button>
        <div class="ai-back-row"><button class="ai-back-btn" onclick="window._aiSelectedPlanId=null;resetAICopilot()"> Back</button></div>
    </div></div>` };
}

function saveGoalStatuses(planId) {
    const m = window.currentMember;
    if (!m) return;
    const needs = getNeedsForPlan(m, planId);
    let updated = 0;
    document.querySelectorAll('[id^="goalStatus_"]').forEach(sel => {
        const need = needs.find(n => n.id === sel.dataset.needId);
        if (!need) return;
        const goal = (need.goals||[]).find(g => g.id === sel.dataset.goalId);
        if (!goal) return;
        goal.status = sel.value;
        if (sel.value === 'Met') goal.completedDate = new Date().toLocaleDateString('en-US');
        updated++;
    });
    if (!m.carePlanData.activity) m.carePlanData.activity = [];
    m.carePlanData.activity.push({
        name: 'Goal Status Update', status: 'Done',
        date: new Date().toLocaleDateString('en-US'),
        updatedBy: m.careManager || 'Care Manager', planId
    });
    refreshCarePlanTab();
    window._aiSelectedPlanId = null;
    const container = document.getElementById('aiMessages');
    if (container) {
        container.innerHTML = `<div class="ai-conv-assistant"><div class="ai-response-block">
            <div class="ai-response-summary"> Updated status for <strong>${updated} goal${updated!==1?'s':''}</strong>.</div>
            <div class="ai-feedback-row" style="margin-top:10px;">
                <button class="ai-cp-save-btn" style="width:auto;padding:6px 12px;" onclick="handleAIQuestion('mx_ai_cp_summary')">View care plan</button>
                <button class="ai-back-btn" style="margin-left:8px;" onclick="resetAICopilot()"> Back</button>
            </div>
        </div></div>`;
    }
}

// END CARE PLAN AI FEATURES
// 
// 


// 
// AI INNOVATION FEATURES  MEMBER LIST + INDIVIDUAL MEMBER
// 

// 
// SECTION 1: MEMBER LIST AI  Prioritization, NL Filter, Risk Signals
// 

// Compute a priority score (0100) and signals for a member
function computeMemberPriority(m) {
    let score = 0;
    const signals = [];
    const flags   = [];

    // Risk tier
    const riskScore = { 'Critical': 40, 'High': 30, 'Medium': 15, 'Low': 5 };
    score += riskScore[m.riskCategory] || 10;

    // ADT event
    if (m.hasADTEvent || (m.alerts||[]).some(a => a.type === 'ADT Event')) {
        score += 25;
        signals.push({ icon: '', text: 'ADT event unacknowledged', level: 'critical' });
        flags.push('adt');
    }

    // Safety concern
    if (m.hasSafetyConcern || (m.alerts||[]).some(a => a.type === 'Safety')) {
        score += 30;
        signals.push({ icon: '', text: 'Active safety concern', level: 'critical' });
        flags.push('safety');
    }

    // Consent issues
    if (m.consentStatus === 'Re-consent Required') {
        score += 20;
        signals.push({ icon: '', text: 'Re-consent required', level: 'high' });
        flags.push('consent');
    }
    if (m.consentStatus === 'To Obtain Consent') {
        score += 10;
        signals.push({ icon: '', text: 'Consent not yet obtained', level: 'medium' });
    }

    // Days since last contact
    const activity = m.carePlanData?.activity || [];
    const lastNote = [...activity].reverse().find(a => a.date);
    let daysSince = null;
    if (lastNote?.date) {
        try {
            const d = new Date(lastNote.date);
            daysSince = Math.floor((new Date() - d) / 86400000);
        } catch(e) {}
    }
    if (daysSince !== null) {
        if (daysSince >= 60) {
            score += 20;
            signals.push({ icon: '', text: `No contact in ${daysSince} days`, level: 'high' });
            flags.push('overdue');
        } else if (daysSince >= 30) {
            score += 10;
            signals.push({ icon: '', text: `Last contact ${daysSince} days ago`, level: 'medium' });
        }
    } else {
        score += 8;
        signals.push({ icon: '', text: 'No contact recorded', level: 'medium' });
        flags.push('overdue');
    }

    // Overdue follow-up on needs
    const needs = m.carePlanData?.needs || [];
    const today = new Date(); today.setHours(0,0,0,0);
    const overdueNeeds = needs.filter(n => {
        if (!n.followUpDate) return false;
        try { return new Date(n.followUpDate) < today; } catch(e) { return false; }
    });
    if (overdueNeeds.length > 0) {
        score += 15;
        signals.push({ icon: '', text: `${overdueNeeds.length} need${overdueNeeds.length>1?'s':''} past follow-up date`, level: 'high' });
        flags.push('overdue');
    }

    // Goals at risk
    const allGoals = needs.flatMap(n => n.goals || []);
    const atRisk = allGoals.filter(g => ['at risk','not met'].includes((g.status||'').toLowerCase()));
    if (atRisk.length > 0) {
        score += 10;
        signals.push({ icon: '', text: `${atRisk.length} goal${atRisk.length>1?'s':''} at risk or not met`, level: 'high' });
    }

    // New enrollment (no care plan yet but assessment done)
    const journeyStage = m.journeyStage || '';
    if (journeyStage === 'ASSESSMENT_DONE_CP_BUILDING' && needs.length === 0) {
        score += 12;
        signals.push({ icon: '', text: 'Assessment done  care plan not started', level: 'medium' });
    }

    // Priority label
    let priority, dotColor;
    if (score >= 55)      { priority = 'Critical';  dotColor = '#ef4444'; }
    else if (score >= 35) { priority = 'High';       dotColor = '#f59e0b'; }
    else if (score >= 20) { priority = 'Medium';     dotColor = '#6366f1'; }
    else                  { priority = 'Low';         dotColor = '#10b981'; }

    return { score, priority, dotColor, signals, flags, daysSince };
}

// AI Prioritized view  replaces standard table rows with prioritized + annotated ones
function renderAIPrioritizedList(membersData) {
    const tableBody = document.getElementById('member-table-body');
    if (!tableBody) return;

    // Compute priorities
    const scored = membersData.map(m => ({ m, p: computeMemberPriority(m) }))
        .sort((a, b) => b.p.score - a.p.score);

    tableBody.innerHTML = scored.map(({ m, p }) => {
        const topSignal = p.signals[0];
        const extraCount = p.signals.length - 1;

        const signalHTML = topSignal
            ? `<div style="font-size:11px;color:${p.dotColor === '#ef4444' ? '#dc2626' : p.dotColor === '#f59e0b' ? '#b45309' : '#4f46e5'};margin-top:2px;display:flex;align-items:center;gap:4px;">
                <span>${topSignal.icon}</span><span>${topSignal.text}${extraCount > 0 ? ` <span style="color:#94a3b8;">+${extraCount} more</span>` : ''}</span>
               </div>`
            : '';

        return `<tr data-member-id="${m.id}" style="cursor:pointer;" onclick="navigateToDetails('${m.id}')">
            <td>
                <div style="display:flex;align-items:center;gap:8px;">
                    <div style="width:8px;height:8px;border-radius:50%;background:${p.dotColor};flex-shrink:0;"></div>
                    <div>
                        <div style="font-weight:600;color:#1e293b;">${m.name}</div>
                        ${signalHTML}
                    </div>
                </div>
            </td>
            <td>${m.medicaidId}</td>
            <td>${m.mrn}</td>
            <td>
                <div style="display:inline-flex;align-items:center;gap:5px;padding:2px 8px;border-radius:12px;font-size:11px;font-weight:700;
                    background:${p.dotColor}18;color:${p.dotColor};">
                    <span style="width:6px;height:6px;border-radius:50%;background:${p.dotColor};display:inline-block;"></span>
                    ${p.priority}
                </div>
            </td>
            <td>${m.consentStatus}</td>
            <td>${m.memberStatus}</td>
            <td>${m.age}</td>
            <td>${m.gender}</td>
            <td>${m.mco}</td>
            <td>${m.address}</td>
            <td>${m.city}</td>
            <td>${m.state}</td>
            <td>${m.zipCode}</td>
            <td>${m.county}</td>
            <td>${m.email}</td>
            <td>${m.cellPhone}</td>
            <td>${m.homePhone}</td>
            <td>${m.ethnicity}</td>
            <td>${m.race}</td>
            <td>${m.careMgmtStart}</td>
            <td>${m.careMgmtEnd}</td>
        </tr>`;
    }).join('');
}

// Natural Language filter using keyword parsing
function applyNLFilter(query) {
    const q = query.toLowerCase().trim();
    if (!q) { renderMemberList(membersDB); return; }

    let filtered = [...membersDB];

    // Risk keywords
    if (q.includes('high risk') || q.includes('critical')) filtered = filtered.filter(m => ['High','Critical'].includes(m.riskCategory));
    else if (q.includes('medium risk')) filtered = filtered.filter(m => m.riskCategory === 'Medium');
    else if (q.includes('low risk'))    filtered = filtered.filter(m => m.riskCategory === 'Low');

    // Contact recency
    const noContactMatch = q.match(/no contact(?:\s+in)?\s+(\d+)\s+days?/);
    const daysMatch      = q.match(/(\d+)\+?\s+days?/);
    const days = noContactMatch ? parseInt(noContactMatch[1]) : (daysMatch ? parseInt(daysMatch[1]) : null);
    if (days || q.includes('no contact') || q.includes('overdue')) {
        filtered = filtered.filter(m => {
            const p = computeMemberPriority(m);
            return p.daysSince === null || p.daysSince >= (days || 30);
        });
    }

    // ADT events
    if (q.includes('adt') || q.includes('hospital') || q.includes('discharge')) {
        filtered = filtered.filter(m => (m.alerts||[]).some(a => a.type === 'ADT Event'));
    }

    // Safety
    if (q.includes('safety')) {
        filtered = filtered.filter(m => (m.alerts||[]).some(a => a.type === 'Safety'));
    }

    // Consent
    if (q.includes('consent') && q.includes('not')) {
        filtered = filtered.filter(m => ['To Obtain Consent','Re-consent Required'].includes(m.consentStatus));
    }
    if (q.includes('re-consent') || q.includes('reconsent')) {
        filtered = filtered.filter(m => m.consentStatus === 'Re-consent Required');
    }

    // Active care plan
    if (q.includes('active care plan') || q.includes('care plan')) {
        filtered = filtered.filter(m => (m.carePlanData?.needs||[]).length > 0);
    }

    // Goals at risk
    if (q.includes('goal') && (q.includes('risk') || q.includes('at risk'))) {
        filtered = filtered.filter(m => {
            return (m.carePlanData?.needs||[]).flatMap(n=>n.goals||[]).some(g => ['at risk','not met'].includes((g.status||'').toLowerCase()));
        });
    }

    // Show results in prioritized view
    renderAIPrioritizedList(filtered);

    // Update count display
    const countEl = document.getElementById('memberCountDisplay');
    if (countEl) countEl.textContent = `${filtered.length} member${filtered.length!==1?'s':''} found`;
}

// Inject AI bar into member list
function injectMemberListAIBar() {
    const container = document.querySelector('.member-list-container');
    if (!container || document.getElementById('memberListAIBar')) return;

    const bar = document.createElement('div');
    bar.id = 'memberListAIBar';
    bar.innerHTML = `
    <div style="display:flex;gap:8px;align-items:center;padding:10px 0 14px;flex-wrap:wrap;">
        <div style="display:flex;align-items:center;gap:8px;flex:1;background:white;border:1.5px solid #2d2d52;border-radius:8px;padding:8px 12px;">
            <svg viewBox="0 0 24 24" fill="none" stroke="#2d2d52" stroke-width="2" width="16" height="16"><circle cx="11" cy="11" r="8"/><path d="M21 21l-4.35-4.35"/></svg>
            <input type="text" id="aiNLFilterInput" placeholder=' Ask anything: "high risk with no contact in 30 days" or "members with ADT events"'
                style="border:none;outline:none;font-size:12px;flex:1;font-family:inherit;color:#1e293b;background:transparent;"
                oninput="applyNLFilter(this.value)"
                onkeydown="if(event.key==='Escape')this.value='',renderMemberList(membersDB)">
        </div>
        <button id="aiPriorityBtn" onclick="togglePriorityView(this)"
            style="display:flex;align-items:center;gap:6px;padding:8px 14px;background:#2d2d52;color:white;border:none;border-radius:8px;font-size:12px;font-weight:600;cursor:pointer;white-space:nowrap;">
            <svg viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" width="14" height="14"><polygon points="12,2 15.09,8.26 22,9.27 17,14.14 18.18,21.02 12,17.77 5.82,21.02 7,14.14 2,9.27 8.91,8.26"/></svg>
            AI Prioritize
        </button>
        <button onclick="showBulkAIPanel()"
            style="display:flex;align-items:center;gap:6px;padding:8px 14px;background:white;border:1.5px solid #2d2d52;color:#2d2d52;border-radius:8px;font-size:12px;font-weight:600;cursor:pointer;white-space:nowrap;">
             Bulk AI Actions
        </button>
        <span id="memberCountDisplay" style="font-size:12px;color:#64748b;white-space:nowrap;">${membersDB.length} members</span>
    </div>`;
    container.insertBefore(bar, container.firstChild);
}

let _priorityViewOn = false;
function togglePriorityView(btn) {
    _priorityViewOn = !_priorityViewOn;
    if (_priorityViewOn) {
        btn.style.background = '#10b981';
        btn.innerHTML = `<svg viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" width="14" height="14"><polygon points="12,2 15.09,8.26 22,9.27 17,14.14 18.18,21.02 12,17.77 5.82,21.02 7,14.14 2,9.27 8.91,8.26"/></svg> Priority View ON`;
        renderAIPrioritizedList(membersDB);
    } else {
        btn.style.background = '#2d2d52';
        btn.innerHTML = `<svg viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" width="14" height="14"><polygon points="12,2 15.09,8.26 22,9.27 17,14.14 18.18,21.02 12,17.77 5.82,21.02 7,14.14 2,9.27 8.91,8.26"/></svg> AI Prioritize`;
        renderMemberList(membersDB);
    }
}

// Bulk AI Actions panel
function showBulkAIPanel() {
    document.getElementById('bulkAIPanel')?.remove();

    // Get top 5 priority members for demo
    const top5 = [...membersDB]
        .map(m => ({ m, p: computeMemberPriority(m) }))
        .sort((a,b) => b.p.score - a.p.score)
        .slice(0, 5);

    const panel = document.createElement('div');
    panel.id = 'bulkAIPanel';
    panel.style.cssText = 'position:fixed;right:0;top:0;width:420px;height:100vh;background:white;box-shadow:-4px 0 24px rgba(0,0,0,0.15);z-index:9000;display:flex;flex-direction:column;';
    panel.innerHTML = `
    <div style="padding:16px 20px;background:#2d2d52;color:white;display:flex;align-items:center;gap:10px;">
        <span style="font-size:16px;"></span>
        <div style="flex:1;font-size:14px;font-weight:700;">Bulk AI Actions</div>
        <button onclick="document.getElementById('bulkAIPanel').remove()" style="background:none;border:none;color:white;font-size:20px;cursor:pointer;line-height:1;"></button>
    </div>
    <div style="flex:1;overflow-y:auto;padding:16px;">
        <div style="font-size:12px;font-weight:700;color:#64748b;text-transform:uppercase;letter-spacing:0.05em;margin-bottom:10px;">Top 5 Priority Members</div>
        ${top5.map(({m, p}) => `
        <div style="display:flex;align-items:center;gap:8px;padding:8px 10px;background:#f8fafc;border:1px solid #e2e8f0;border-radius:6px;margin-bottom:6px;">
            <input type="checkbox" checked style="accent-color:#2d2d52;">
            <div style="width:7px;height:7px;border-radius:50%;background:${p.dotColor};flex-shrink:0;"></div>
            <div style="flex:1;">
                <div style="font-size:12px;font-weight:600;color:#1e293b;">${m.name}</div>
                <div style="font-size:10px;color:#64748b;">${p.signals[0]?.text || p.priority + ' priority'}</div>
            </div>
        </div>`).join('')}
        <div style="margin-top:16px;font-size:12px;font-weight:700;color:#64748b;text-transform:uppercase;letter-spacing:0.05em;margin-bottom:10px;">Run AI Actions</div>
        <div style="display:flex;flex-direction:column;gap:8px;">
            <button onclick="runBulkAction('outreach')" style="text-align:left;padding:12px;background:white;border:1.5px solid #e2e8f0;border-radius:8px;cursor:pointer;font-family:inherit;">
                <div style="font-size:13px;font-weight:600;color:#1e293b;"> Draft outreach messages</div>
                <div style="font-size:11px;color:#64748b;margin-top:2px;">Personalized call scripts for each member</div>
            </button>
            <button onclick="runBulkAction('summary')" style="text-align:left;padding:12px;background:white;border:1.5px solid #e2e8f0;border-radius:8px;cursor:pointer;font-family:inherit;">
                <div style="font-size:13px;font-weight:600;color:#1e293b;"> Summarize what's overdue</div>
                <div style="font-size:11px;color:#64748b;margin-top:2px;">Tasks, follow-ups and reviews due across this group</div>
            </button>
            <button onclick="runBulkAction('risks')" style="text-align:left;padding:12px;background:white;border:1.5px solid #e2e8f0;border-radius:8px;cursor:pointer;font-family:inherit;">
                <div style="font-size:13px;font-weight:600;color:#1e293b;"> Risk signal summary</div>
                <div style="font-size:11px;color:#64748b;margin-top:2px;">ADT events, safety concerns, and disengagement patterns</div>
            </button>
        </div>
        <div id="bulkActionResult" style="margin-top:16px;"></div>
    </div>`;
    document.body.appendChild(panel);
}

function runBulkAction(type) {
    const result = document.getElementById('bulkActionResult');
    if (!result) return;
    result.innerHTML = `<div style="text-align:center;padding:20px;"><div style="font-size:24px;margin-bottom:8px;"></div><div style="font-size:12px;color:#64748b;">Generating with AI</div></div>`;

    const top5 = [...membersDB].map(m => ({ m, p: computeMemberPriority(m) })).sort((a,b) => b.p.score - a.p.score).slice(0, 5);

    setTimeout(() => {
        if (type === 'outreach') {
            result.innerHTML = top5.map(({m, p}) => {
                const signal = p.signals[0]?.text || 'routine check-in';
                return `<div style="background:#f8fafc;border:1px solid #e2e8f0;border-radius:8px;padding:12px;margin-bottom:8px;">
                    <div style="font-size:11px;font-weight:700;color:#2d2d52;margin-bottom:6px;">${m.name}</div>
                    <div style="font-size:11px;color:#334155;line-height:1.6;">"Hi ${m.name.split(' ')[0]}, this is [CM] from Sevida calling about your care plan. I wanted to follow up  ${signal.toLowerCase()}. Would you have a few minutes to talk?"</div>
                </div>`;
            }).join('');
        } else if (type === 'summary') {
            const rows = top5.map(({m, p}) => {
                const needs = m.carePlanData?.needs || [];
                const overdue = needs.filter(n => { try { return n.followUpDate && new Date(n.followUpDate) < new Date(); } catch(e){ return false; } });
                const atRisk = needs.flatMap(n=>n.goals||[]).filter(g => ['at risk','not met'].includes((g.status||'').toLowerCase()));
                return `<tr>
                    <td style="padding:7px 10px;font-size:11px;font-weight:600;border-bottom:1px solid #f1f5f9;">${m.name}</td>
                    <td style="padding:7px 10px;font-size:11px;text-align:center;border-bottom:1px solid #f1f5f9;">${overdue.length > 0 ? `<span style="color:#dc2626;font-weight:700;">${overdue.length}</span>` : ''}</td>
                    <td style="padding:7px 10px;font-size:11px;text-align:center;border-bottom:1px solid #f1f5f9;">${atRisk.length > 0 ? `<span style="color:#f59e0b;font-weight:700;">${atRisk.length}</span>` : ''}</td>
                    <td style="padding:7px 10px;font-size:11px;border-bottom:1px solid #f1f5f9;">${p.daysSince !== null ? p.daysSince+'d ago' : 'None'}</td>
                </tr>`;
            }).join('');
            result.innerHTML = `<table style="width:100%;border-collapse:collapse;font-size:11px;">
                <thead><tr style="background:#f0f1fb;">
                    <th style="padding:7px 10px;text-align:left;">Member</th>
                    <th style="padding:7px 10px;text-align:center;">Overdue Needs</th>
                    <th style="padding:7px 10px;text-align:center;">Goals At Risk</th>
                    <th style="padding:7px 10px;text-align:left;">Last Contact</th>
                </tr></thead><tbody>${rows}</tbody></table>`;
        } else if (type === 'risks') {
            result.innerHTML = top5.map(({m, p}) => `
                <div style="padding:10px;background:white;border:1px solid #e2e8f0;border-radius:8px;margin-bottom:6px;">
                    <div style="display:flex;align-items:center;gap:6px;margin-bottom:5px;">
                        <div style="width:7px;height:7px;border-radius:50%;background:${p.dotColor};"></div>
                        <span style="font-size:12px;font-weight:700;">${m.name}</span>
                        <span style="font-size:10px;font-weight:700;padding:1px 6px;border-radius:8px;background:${p.dotColor}18;color:${p.dotColor};">${p.priority}</span>
                    </div>
                    ${p.signals.map(s => `<div style="font-size:11px;color:#475569;padding:2px 0 2px 13px;">${s.icon} ${s.text}</div>`).join('')}
                </div>`).join('');
        }
    }, 1200);
}

// Hook into renderMemberList to inject AI bar after render
// Use assignment (not function declaration) to avoid hoisting infinite recursion
const _origRenderMemberList = renderMemberList;
renderMemberList = function(membersData) {
    _origRenderMemberList(membersData);
    setTimeout(injectMemberListAIBar, 50);
    if (_priorityViewOn) renderAIPrioritizedList(membersData);
};

// 
// SECTION 2: INDIVIDUAL MEMBER  New AI Question Handlers
// 

// Register new questions into getMemberContextQuestions
(function extendMemberContextQuestions() {
    const _orig = getMemberContextQuestions;
    getMemberContextQuestions = function(member, subTab) {
        const base = _orig(member, subTab);

        // Inject new top-level smart questions into common section
        const newCommon = [
            { id: 'mx_previsit_brief',   text: ' Brief me before my call',                handler: 'qPreCallBriefing' },
            { id: 'mx_what_changed',     text: ' What changed since I was last here?',     handler: 'qWhatChanged' },
            { id: 'mx_outreach_script',  text: ' Generate outreach script',                handler: 'qOutreachScript' },
            { id: 'mx_risk_explain',     text: ' Why is this member this risk level?',      handler: 'qRiskExplanation' },
            { id: 'mx_gap_analysis',     text: ' Full gap analysis  what\'s overdue?',    handler: 'qGapAnalysis' },
            { id: 'mx_adt_transition',   text: ' Create transition of care plan',           handler: 'qADTTransitionPlan' },
            { id: 'mx_pop_compare',      text: ' Compare to similar members',               handler: 'qPopulationCompare' },
        ];

        // Prepend new smart questions before existing ones
        return [...newCommon, ...base];
    };
})();

//  PRE-CALL BRIEFING 
function qPreCallBriefing() {
    const m = window.currentMember;
    if (!m) return { summary: 'No member selected.', emptyMsg: '' };
    const p = computeMemberPriority(m);

    const needs   = m.carePlanData?.needs || [];
    const allGoals = needs.flatMap(n => n.goals || []);
    const atRisk  = allGoals.filter(g => ['at risk','not met'].includes((g.status||'').toLowerCase()));
    const overdueNeeds = needs.filter(n => { try { return n.followUpDate && new Date(n.followUpDate) < new Date(); } catch(e){ return false; } });
    const activity = m.carePlanData?.activity || [];
    const lastNote = [...activity].reverse().find(a => a.date);
    const openTasks = (m.tasks || []).filter(t => t.status !== 'Completed' && t.status !== 'Done');
    const overdueTasks = openTasks.filter(t => { try { return t.dueDate && new Date(t.dueDate) < new Date(); } catch(e){ return false; } });
    const dx = m.diagnoses || {};
    const conditions = [dx.primary, dx.secondary, dx.tertiary].filter(Boolean).join(', ');

    const prompt = `You are a clinical care management AI. Prepare a brief pre-call summary for a care manager who is about to call ${m.name}.

Member profile:
- Age: ${m.age}, Gender: ${m.gender}
- Risk level: ${m.riskCategory} (Priority score: ${p.score}/100)
- Diagnoses: ${conditions || 'Not on file'}
- Last contact: ${lastNote ? lastNote.date + '  ' + (lastNote.name || lastNote.activity || 'Contact') : 'No record'}
- Open tasks: ${openTasks.length} (${overdueTasks.length} overdue)
- Care plan: ${needs.length} needs, ${allGoals.length} goals, ${atRisk.length} at risk
- Overdue follow-ups: ${overdueNeeds.length}
- Active alerts: ${(m.alerts||[]).map(a => a.type).join(', ') || 'None'}
- Care manager: ${m.careManager}

Create a concise pre-call brief with:
1. 2-3 sentence member snapshot
2. Key things to address on this call (bullet points)
3. Suggested talking points (2-3)
4. Any flags or warnings

Keep it focused and clinical. Aim for what a care manager can read in under 1 minute.`;

    return {
        summary: 'Generating pre-call brief',
        emptyMsg: '',
        prompt,
        _prefixHTML: `<div style="display:flex;align-items:center;gap:8px;padding:10px 12px;background:#f0f1fb;border-radius:8px;margin-bottom:12px;border-left:3px solid #2d2d52;">
            <span style="font-size:16px;"></span>
            <div>
                <div style="font-size:12px;font-weight:700;color:#2d2d52;">Pre-call Brief  ${m.name}</div>
                <div style="font-size:11px;color:#64748b;">${m.riskCategory} Risk  ${conditions || 'Diagnoses not on file'}</div>
            </div>
            <div style="margin-left:auto;text-align:right;">
                <div style="font-size:10px;font-weight:700;padding:2px 8px;border-radius:8px;background:${p.dotColor}18;color:${p.dotColor};">${p.priority} Priority</div>
            </div>
        </div>`
    };
}

//  WHAT CHANGED SINCE LAST VISIT 
function qWhatChanged() {
    const m = window.currentMember;
    if (!m) return { summary: 'No member selected.', emptyMsg: '' };

    const activity = m.carePlanData?.activity || [];
    const tasks    = m.tasks || [];
    const needs    = m.carePlanData?.needs || [];

    // Use last 14 days as "since last visit"
    const cutoff = new Date();
    cutoff.setDate(cutoff.getDate() - 14);

    const recentActivity = activity.filter(a => {
        try { return new Date(a.date) >= cutoff; } catch(e) { return false; }
    });

    const recentTasks = tasks.filter(t => {
        try { return t.createdOn && new Date(t.createdOn) >= cutoff; } catch(e) { return false; }
    });

    const atRiskGoals = needs.flatMap(n => n.goals||[]).filter(g => ['at risk','not met'].includes((g.status||'').toLowerCase()));
    const overdueNeeds = needs.filter(n => { try { return n.followUpDate && new Date(n.followUpDate) < new Date(); } catch(e){ return false; } });

    const prompt = `You are a care management AI assistant. A care manager is returning to review ${m.name}'s profile. Summarize what has changed in the last 14 days.

Recent activity (last 14 days):
${recentActivity.length > 0 ? recentActivity.map(a => `- ${a.date}: ${a.name || a.activity || 'Activity'} (${a.status || ''})`).join('\n') : '- No recent activity recorded'}

New tasks in last 14 days: ${recentTasks.length}
Goals currently at risk or not met: ${atRiskGoals.length} (${atRiskGoals.map(g => g.text?.substring(0,50)).join(', ') || 'None'})
Needs past follow-up date: ${overdueNeeds.length}
Active alerts: ${(m.alerts||[]).map(a => a.type + ': ' + a.text).join(', ') || 'None'}

Write a brief "What's new" summary in 2-3 short paragraphs. Be specific about what changed vs. what still needs attention. If nothing changed, say so plainly and suggest next steps.`;

    const changeCount = recentActivity.length + recentTasks.length + atRiskGoals.length;

    return {
        summary: 'Checking what changed',
        emptyMsg: '',
        prompt,
        _prefixHTML: `<div style="display:flex;align-items:center;gap:8px;padding:10px 12px;background:#f0f9ff;border-radius:8px;margin-bottom:12px;border-left:3px solid #0ea5e9;">
            <span style="font-size:16px;"></span>
            <div>
                <div style="font-size:12px;font-weight:700;color:#0c4a6e;">What Changed  Last 14 Days</div>
                <div style="font-size:11px;color:#64748b;">${changeCount} update${changeCount!==1?'s':''} detected for ${m.name}</div>
            </div>
        </div>`
    };
}

//  OUTREACH SCRIPT 
function qOutreachScript() {
    const m = window.currentMember;
    if (!m) return { summary: 'No member selected.', emptyMsg: '' };

    const needs  = m.carePlanData?.needs || [];
    const goals  = needs.flatMap(n => n.goals||[]);
    const atRisk = goals.filter(g => ['at risk','not met'].includes((g.status||'').toLowerCase()));
    const dx     = m.diagnoses || {};
    const conditions = [dx.primary, dx.secondary].filter(Boolean).join(' and ');
    const lastGoal = goals.find(g => g.status === 'In Progress');
    const activity = m.carePlanData?.activity || [];
    const lastNote = [...activity].reverse().find(a => a.date);

    const prompt = `You are a care management AI. Write a warm, professional outreach call script for a care manager calling ${m.name}.

Member context:
- Name: ${m.name} (${m.age}yo ${m.gender})
- Primary conditions: ${conditions || 'on file'}
- Current care plan focus: ${needs[0]?.category || 'General care management'}
- Active goal: ${lastGoal?.text || goals[0]?.text || 'No active goals'}
- Goal status: ${lastGoal?.status || goals[0]?.status || 'Not set'}
- At-risk goals: ${atRisk.length}
- Last contact: ${lastNote?.date || 'Not recorded'}
- Care manager name: ${m.careManager || 'Care Manager'}

Write a natural, empathetic call script with:
- Opening greeting (use first name)
- Purpose of call (specific to their care plan situation)
- 2-3 check-in questions about their current condition
- What to address if ${atRisk.length > 0 ? 'goals are at risk' : 'all is on track'}
- Next steps and closing
- A voicemail version (if no answer)

Keep language warm and plain, not clinical jargon.`;

    return {
        summary: 'Drafting outreach script',
        emptyMsg: '',
        prompt,
        _prefixHTML: `<div style="display:flex;align-items:center;gap:8px;padding:10px 12px;background:#f0fdf4;border-radius:8px;margin-bottom:12px;border-left:3px solid #10b981;">
            <span style="font-size:16px;"></span>
            <div>
                <div style="font-size:12px;font-weight:700;color:#065f46;">Outreach Script  ${m.name}</div>
                <div style="font-size:11px;color:#64748b;">Personalized based on diagnoses & care plan status</div>
            </div>
        </div>`
    };
}

//  RISK EXPLANATION 
function qRiskExplanation() {
    const m = window.currentMember;
    if (!m) return { summary: 'No member selected.', emptyMsg: '' };
    const p = computeMemberPriority(m);
    const dx = m.diagnoses || {};
    const conditions = [dx.primary, dx.secondary, dx.tertiary, dx.additional].filter(Boolean).join(', ');
    const activity = m.carePlanData?.activity || [];
    const lastNote = [...activity].reverse().find(a => a.date);
    const needs = m.carePlanData?.needs || [];
    const goals = needs.flatMap(n => n.goals||[]);

    const prompt = `You are a clinical care management AI. Explain in plain language why ${m.name} is classified as ${m.riskCategory} risk.

Member data:
- Risk category: ${m.riskCategory} (AI priority score: ${p.score}/100)
- Age: ${m.age}, Gender: ${m.gender}
- Diagnoses: ${conditions || 'Not recorded'}
- ADT events: ${(m.alerts||[]).filter(a=>a.type==='ADT Event').length}
- Safety concern: ${(m.alerts||[]).some(a=>a.type==='Safety') ? 'Yes' : 'No'}
- Consent status: ${m.consentStatus}
- Care plan needs: ${needs.length}
- Goals total: ${goals.length}, At risk: ${goals.filter(g=>['at risk','not met'].includes((g.status||'').toLowerCase())).length}
- Days since last contact: ${p.daysSince !== null ? p.daysSince : 'Unknown'}
- AI signals: ${p.signals.map(s=>s.text).join(' | ')}

Explain the risk classification in 2-3 paragraphs. Identify the top 3 factors driving the risk. Then suggest 2 specific interventions that would most reduce the risk. Write for a care manager, not a physician.`;

    return {
        summary: 'Analyzing risk factors',
        emptyMsg: '',
        prompt,
        _prefixHTML: `<div style="display:flex;align-items:center;gap:8px;padding:10px 12px;border-radius:8px;margin-bottom:12px;border-left:3px solid ${p.dotColor};background:${p.dotColor}10;">
            <span style="font-size:16px;"></span>
            <div>
                <div style="font-size:12px;font-weight:700;color:#1e293b;">Risk Explanation  ${m.name}</div>
                <div style="display:flex;align-items:center;gap:6px;margin-top:3px;">
                    <span style="font-size:10px;font-weight:700;padding:1px 8px;border-radius:8px;background:${p.dotColor}20;color:${p.dotColor};">${p.priority} Priority</span>
                    <span style="font-size:10px;color:#64748b;">Score: ${p.score}/100</span>
                </div>
            </div>
        </div>
        <div style="display:flex;flex-wrap:wrap;gap:5px;margin-bottom:12px;">
            ${p.signals.map(s => `<span style="font-size:10px;padding:3px 8px;background:#f1f5f9;border-radius:12px;color:#475569;">${s.icon} ${s.text}</span>`).join('')}
        </div>`
    };
}

//  GAP ANALYSIS 
function qGapAnalysis() {
    const m = window.currentMember;
    if (!m) return { summary: 'No member selected.', emptyMsg: '' };

    const needs      = m.carePlanData?.needs || [];
    const goals      = needs.flatMap(n => n.goals||[]);
    const barriers   = m.carePlanData?.barriers || [];
    const gaps       = m.carePlanData?.gaps || [];
    const openTasks  = (m.tasks||[]).filter(t => !['Completed','Done'].includes(t.status));
    const overdueTasks = openTasks.filter(t => { try { return t.dueDate && new Date(t.dueDate) < new Date(); } catch(e){ return false; } });
    const overdueNeeds = needs.filter(n => { try { return n.followUpDate && new Date(n.followUpDate) < new Date(); } catch(e){ return false; } });
    const atRiskGoals  = goals.filter(g => ['at risk','not met'].includes((g.status||'').toLowerCase()));
    const activity    = m.carePlanData?.activity || [];
    const lastNote    = [...activity].reverse().find(a => a.date);
    const assessments = (m.lob||[]).flatMap(l => l.assessments||[]);
    const pendingAss  = assessments.filter(a => a.status !== 'completed');
    const p = computeMemberPriority(m);

    // Build immediate gap data for direct display
    const gapSections = [];
    if (overdueTasks.length > 0)  gapSections.push({ icon:'', label:`${overdueTasks.length} overdue task${overdueTasks.length>1?'s':''}`, items: overdueTasks.slice(0,3).map(t => t.title||t.name||'Task') });
    if (overdueNeeds.length > 0)  gapSections.push({ icon:'', label:`${overdueNeeds.length} need${overdueNeeds.length>1?'s':''} past follow-up date`, items: overdueNeeds.slice(0,3).map(n => n.category) });
    if (atRiskGoals.length > 0)   gapSections.push({ icon:'', label:`${atRiskGoals.length} goal${atRiskGoals.length>1?'s':''} at risk or not met`, items: atRiskGoals.slice(0,3).map(g => (g.text||'Goal').substring(0,50)) });
    if (pendingAss.length > 0)    gapSections.push({ icon:'', label:`${pendingAss.length} assessment${pendingAss.length>1?'s':''} pending or in-progress`, items: pendingAss.slice(0,3).map(a => a.name||a.shortName) });
    if (gaps.length > 0)          gapSections.push({ icon:'', label:`${gaps.length} documented care gap${gaps.length>1?'s':''}`, items: gaps.slice(0,3).map(g => g.measure||'Gap') });
    if (barriers.length > 0)      gapSections.push({ icon:'', label:`${barriers.length} barrier${barriers.length>1?'s':''}`, items: barriers.slice(0,3).map(b => b.name||b.category) });

    const totalGaps = gapSections.reduce((sum, s) => sum + (s.items?.length||0), 0);

    const prompt = `You are a clinical care management AI doing a full gap analysis for ${m.name}.

Gap data:
- Overdue tasks: ${overdueTasks.length} (${overdueTasks.map(t=>t.title||'Task').join(', ')})
- Needs past follow-up: ${overdueNeeds.length} (${overdueNeeds.map(n=>n.category).join(', ')})
- Goals at risk or not met: ${atRiskGoals.length} (${atRiskGoals.map(g=>(g.text||'').substring(0,40)).join(', ')})
- Pending assessments: ${pendingAss.length}
- Care gaps: ${gaps.length}
- Barriers: ${barriers.length}
- Days since last contact: ${p.daysSince !== null ? p.daysSince : 'Unknown'}
- Alerts: ${(m.alerts||[]).map(a=>a.type).join(', ')||'None'}

Provide a prioritized action plan:
1. Immediate actions (this week)
2. Short-term (next 30 days)
3. What to monitor

Write for a care manager. Be specific and actionable.`;

    const gapListHTML = gapSections.length === 0
        ? `<div style="padding:12px;background:#dcfce7;border-radius:8px;font-size:12px;color:#166534;text-align:center;"> No critical gaps identified. Member appears on track.</div>`
        : gapSections.map(s => `
            <div style="padding:10px;background:white;border:1px solid #e2e8f0;border-radius:8px;margin-bottom:6px;">
                <div style="font-size:12px;font-weight:700;color:#1e293b;margin-bottom:5px;">${s.icon} ${s.label}</div>
                ${s.items.map(i => `<div style="font-size:11px;color:#475569;padding:2px 0 2px 16px;"> ${i}</div>`).join('')}
            </div>`).join('');

    return {
        summary: 'Running gap analysis',
        emptyMsg: '',
        prompt,
        _prefixHTML: `<div style="padding:10px 12px;background:#fff7ed;border-radius:8px;margin-bottom:12px;border-left:3px solid #f59e0b;">
            <div style="font-size:12px;font-weight:700;color:#92400e;margin-bottom:6px;"> Gap Analysis  ${m.name}  ${totalGaps} total gaps</div>
            ${gapListHTML}
            <div style="font-size:11px;color:#92400e;margin-top:8px;font-weight:600;">AI-generated action plan below </div>
        </div>`
    };
}

//  TRANSITION OF CARE (ADT) 
function qADTTransitionPlan() {
    const m = window.currentMember;
    if (!m) return { summary: 'No member selected.', emptyMsg: '' };

    const adtAlert  = (m.alerts||[]).find(a => a.type === 'ADT Event');
    const hasADT    = !!adtAlert;
    const dx        = m.diagnoses || {};
    const meds      = m.medications || [];
    const conditions = [dx.primary, dx.secondary].filter(Boolean).join(', ');
    const needs      = m.carePlanData?.needs || [];

    const prompt = `You are a care management AI specialist in transitions of care. ${m.name} ${hasADT ? 'has a recent ADT (Admission, Discharge, Transfer) event' : 'may be at risk for hospitalization based on their diagnoses'}.

Member profile:
- Age: ${m.age}, Gender: ${m.gender}
- Diagnoses: ${conditions || 'Not on file'}
- Active medications: ${meds.length > 0 ? meds.slice(0,5).map(med => med.name || med).join(', ') : 'Not on file'}
- Current care plan needs: ${needs.length} (${needs.map(n=>n.category).join(', ')||'None'})
- ADT alert: ${hasADT ? adtAlert.text : 'None active, preventive planning'}

Create a 30-day Transition of Care action plan with:
1. Immediate actions (48 hours): contact priorities, medication reconciliation
2. Week 1 goals
3. Week 2-4 follow-up schedule
4. Red flag symptoms to watch for
5. Coordination needed (PCP, specialists, pharmacy)
6. What to document in the care plan

Format clearly with timeframes. Be specific and clinical but readable by a non-physician care manager.`;

    return {
        summary: hasADT ? 'Creating transition plan from ADT event' : 'Generating preventive transition plan',
        emptyMsg: '',
        prompt,
        _prefixHTML: `<div style="padding:10px 12px;background:${hasADT ? '#fef2f2' : '#f0f9ff'};border-radius:8px;margin-bottom:12px;border-left:3px solid ${hasADT ? '#ef4444' : '#0ea5e9'};">
            <div style="font-size:12px;font-weight:700;color:${hasADT ? '#991b1b' : '#0c4a6e'};">
                 ${hasADT ? 'ADT Transition of Care Plan' : 'Preventive Transition Planning'}  ${m.name}
            </div>
            <div style="font-size:11px;color:#64748b;margin-top:3px;">
                ${hasADT ? adtAlert.text : 'No active ADT  Preventive planning based on diagnoses'}
            </div>
        </div>`
    };
}

//  POPULATION COMPARISON 
function qPopulationCompare() {
    const m = window.currentMember;
    if (!m) return { summary: 'No member selected.', emptyMsg: '' };

    // Find similar members (same risk category, similar age range)
    const similar = membersDB.filter(other =>
        other.id !== m.id &&
        other.riskCategory === m.riskCategory &&
        Math.abs(other.age - m.age) <= 15 &&
        other.carePlanData?.needs?.length > 0
    );

    const avgNeeds = similar.length > 0
        ? Math.round(similar.reduce((s, o) => s + (o.carePlanData?.needs?.length||0), 0) / similar.length * 10) / 10
        : null;
    const avgGoals = similar.length > 0
        ? Math.round(similar.reduce((s, o) => s + (o.carePlanData?.needs?.flatMap(n=>n.goals||[]).length||0), 0) / similar.length * 10) / 10
        : null;
    const avgMetRate = similar.length > 0
        ? Math.round(similar.reduce((s, o) => {
            const goals = o.carePlanData?.needs?.flatMap(n=>n.goals||[]) || [];
            return s + (goals.length > 0 ? goals.filter(g=>g.status==='Met').length/goals.length : 0);
          }, 0) / similar.length * 100)
        : null;

    const mNeeds = m.carePlanData?.needs || [];
    const mGoals = mNeeds.flatMap(n => n.goals||[]);
    const mMetRate = mGoals.length > 0 ? Math.round(mGoals.filter(g=>g.status==='Met').length/mGoals.length*100) : 0;
    const p = computeMemberPriority(m);

    const compHTML = similar.length === 0 ? '' : `
    <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px;margin-bottom:12px;">
        <div style="padding:10px;background:white;border:1px solid #e2e8f0;border-radius:8px;text-align:center;">
            <div style="font-size:18px;font-weight:700;color:#2d2d52;">${mNeeds.length}</div>
            <div style="font-size:10px;color:#64748b;">This member's needs</div>
            <div style="font-size:10px;color:${mNeeds.length >= avgNeeds ? '#10b981' : '#f59e0b'};margin-top:2px;">Avg: ${avgNeeds}</div>
        </div>
        <div style="padding:10px;background:white;border:1px solid #e2e8f0;border-radius:8px;text-align:center;">
            <div style="font-size:18px;font-weight:700;color:#2d2d52;">${mGoals.length}</div>
            <div style="font-size:10px;color:#64748b;">Goals</div>
            <div style="font-size:10px;color:${mGoals.length >= avgGoals ? '#10b981' : '#f59e0b'};margin-top:2px;">Avg: ${avgGoals}</div>
        </div>
        <div style="padding:10px;background:white;border:1px solid #e2e8f0;border-radius:8px;text-align:center;">
            <div style="font-size:18px;font-weight:700;color:${mMetRate >= (avgMetRate||0) ? '#10b981' : '#ef4444'};">${mMetRate}%</div>
            <div style="font-size:10px;color:#64748b;">Goals met</div>
            <div style="font-size:10px;color:#64748b;margin-top:2px;">Avg: ${avgMetRate}%</div>
        </div>
    </div>`;

    const prompt = `You are a care management population health AI. Compare ${m.name} to ${similar.length} similar members (same ${m.riskCategory} risk, similar age).

${m.name}'s metrics:
- Priority score: ${p.score}/100 (${p.priority})
- Needs: ${mNeeds.length} (peer avg: ${avgNeeds})
- Goals: ${mGoals.length} (peer avg: ${avgGoals})
- Goals met rate: ${mMetRate}% (peer avg: ${avgMetRate}%)
- Days since contact: ${p.daysSince !== null ? p.daysSince : 'Unknown'}
- Signals: ${p.signals.map(s=>s.text).join(', ')||'None'}

Provide:
1. How does this member compare to peers? (2-3 sentences)
2. Where is this member doing better than peers?
3. Where is this member falling behind?
4. What interventions work best for ${m.riskCategory}-risk members of this profile?

Be specific and insightful, not generic.`;

    return {
        summary: `Comparing to ${similar.length} similar members`,
        emptyMsg: '',
        prompt,
        _prefixHTML: `<div style="padding:10px 12px;background:#f5f3ff;border-radius:8px;margin-bottom:12px;border-left:3px solid #7c3aed;">
            <div style="font-size:12px;font-weight:700;color:#4c1d95;margin-bottom:6px;">
                 Population Comparison  ${m.name}
            </div>
            <div style="font-size:11px;color:#64748b;margin-bottom:8px;">Compared to ${similar.length} similar ${m.riskCategory}-risk members (15 years age)</div>
            ${compHTML}
        </div>`
    };
}

//  REGISTER NEW HANDLERS in handleAIQuestion 
(function extendHandleAIQuestion() {
    const _orig = handleAIQuestion;
    handleAIQuestion = function(questionId) {
        const newHandlers = {
            'mx_previsit_brief':  qPreCallBriefing,
            'mx_what_changed':    qWhatChanged,
            'mx_outreach_script': qOutreachScript,
            'mx_risk_explain':    qRiskExplanation,
            'mx_gap_analysis':    qGapAnalysis,
            'mx_adt_transition':  qADTTransitionPlan,
            'mx_pop_compare':     qPopulationCompare,
        };
        if (newHandlers[questionId]) {
            // Route through same rendering pipeline as existing handlers
            const fn = newHandlers[questionId];
            const result = fn();
            if (!result) return;

            // Show thinking state
            const container = document.getElementById('aiMessages');
            if (container) {
                container.innerHTML = `<div class="ai-thinking-container">
                    <div class="ai-thinking-dots"><div class="tdot"></div><div class="tdot"></div><div class="tdot"></div></div>
                    <div class="ai-thinking-text">${result.summary || 'Thinking'}</div>
                </div>`;
            }

            if (result._customHTML) {
                setTimeout(() => {
                    if (container) container.innerHTML = `<div class="ai-conv-assistant">${result._customHTML}</div>`;
                }, 300);
                return;
            }

            // Call Anthropic API
            if (result.prompt) {
                const prefixHTML = result._prefixHTML || '';
                fetch('https://api.anthropic.com/v1/messages', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'x-api-key': ANTHROPIC_API_KEY, 'anthropic-version': '2023-06-01', 'anthropic-dangerous-direct-browser-access': 'true' },
                    body: JSON.stringify({
                        model: 'claude-sonnet-4-20250514',
                        max_tokens: 1000,
                        system: 'You are Sevida, an AI co-pilot for healthcare care managers. Be concise, clinical, and actionable. Use clear formatting with headers and bullet points where appropriate.',
                        messages: [{ role: 'user', content: result.prompt }]
                    })
                })
                .then(r => r.json())
                .then(data => {
                    const text = (data.content||[]).map(c => c.text||'').join('\n');
                    const formatted = text
                        .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                        .replace(/^### (.*$)/gm, '<div style="font-size:13px;font-weight:700;color:#1e293b;margin:14px 0 5px;">$1</div>')
                        .replace(/^## (.*$)/gm,  '<div style="font-size:14px;font-weight:700;color:#2d2d52;margin:16px 0 6px;">$1</div>')
                        .replace(/^# (.*$)/gm,   '<div style="font-size:15px;font-weight:700;color:#2d2d52;margin:16px 0 8px;">$1</div>')
                        .replace(/^\d+\. (.*$)/gm,'<div style="padding:3px 0 3px 4px;font-size:12px;color:#334155;"><span style="font-weight:700;color:#2d2d52;">$1</span></div>')
                        .replace(/^[-] (.*$)/gm, '<div style="padding:2px 0 2px 12px;font-size:12px;color:#475569;"> $1</div>')
                        .replace(/\n\n/g, '<br>')
                        .replace(/\n/g, '');
                    if (container) {
                        container.innerHTML = `<div class="ai-conv-assistant"><div class="ai-response-block">
                            ${prefixHTML}
                            <div class="ai-response-text" style="font-size:12px;line-height:1.7;color:#334155;">${formatted}</div>
                            <div class="ai-feedback-row" style="margin-top:12px;">
                                <button class="ai-back-btn" onclick="resetAICopilot()"> Back</button>
                            </div>
                        </div></div>`;
                    }
                })
                .catch(err => {
                    if (container) container.innerHTML = `<div class="ai-conv-assistant"><div class="ai-response-block">
                        ${prefixHTML}
                        <div style="font-size:12px;color:#64748b;padding:10px;background:#f8fafc;border-radius:6px;">AI response unavailable. Please check API connectivity.</div>
                        <div class="ai-feedback-row" style="margin-top:12px;"><button class="ai-back-btn" onclick="resetAICopilot()"> Back</button></div>
                    </div></div>`;
                });
                return;
            }

            return _orig(questionId);
        }
        return _orig(questionId);
    };
})();

// 
// SECTION 3: PROACTIVE AI NUDGES  Surface on member list load
// 

function buildProactiveNudges() {
    if (document.getElementById('aiProactiveNudges')) return;

    const critical = membersDB
        .map(m => ({ m, p: computeMemberPriority(m) }))
        .filter(({ p }) => p.score >= 55)
        .slice(0, 3);

    const noContact30 = membersDB
        .map(m => ({ m, p: computeMemberPriority(m) }))
        .filter(({ p }) => p.daysSince !== null && p.daysSince >= 45)
        .length;

    const adtCount = membersDB
        .filter(m => (m.alerts||[]).some(a => a.type === 'ADT Event'))
        .length;

    if (critical.length === 0 && noContact30 === 0) return;

    const nudgeBar = document.createElement('div');
    nudgeBar.id = 'aiProactiveNudges';
    nudgeBar.style.cssText = 'margin:0 0 12px;';

    const nudges = [];
    if (adtCount > 0) nudges.push({
        icon: '', color: '#ef4444', bg: '#fef2f2',
        text: `${adtCount} member${adtCount>1?'s have':' has'} unacknowledged ADT events`,
        action: `applyNLFilter('adt events'); document.getElementById('aiNLFilterInput').value='ADT events';`
    });
    if (critical.length > 0) nudges.push({
        icon: '', color: '#f59e0b', bg: '#fff7ed',
        text: `${critical.length} member${critical.length>1?'s':''} at critical priority  immediate attention needed`,
        action: `togglePriorityView(document.getElementById('aiPriorityBtn'));`
    });
    if (noContact30 > 0) nudges.push({
        icon: '', color: '#6366f1', bg: '#eef2ff',
        text: `${noContact30} member${noContact30>1?'s have':' has'} not been contacted in 45+ days`,
        action: `applyNLFilter('no contact 45 days'); document.getElementById('aiNLFilterInput').value='no contact 45 days';`
    });

    nudgeBar.innerHTML = nudges.map(n => `
    <div style="display:flex;align-items:center;gap:10px;padding:8px 12px;background:${n.bg};border:1px solid ${n.color}30;border-left:3px solid ${n.color};border-radius:6px;margin-bottom:6px;cursor:pointer;"
         onclick="${n.action}">
        <span style="font-size:14px;">${n.icon}</span>
        <span style="font-size:12px;color:#1e293b;flex:1;">${n.text}</span>
        <span style="font-size:11px;color:${n.color};font-weight:600;white-space:nowrap;">View </span>
    </div>`).join('');

    const container = document.querySelector('.member-list-container');
    if (container) {
        const aiBar = document.getElementById('memberListAIBar');
        if (aiBar) container.insertBefore(nudgeBar, aiBar.nextSibling);
        else container.insertBefore(nudgeBar, container.firstChild);
    }
}

// Hook nudges into the list render - use assignment not function declaration
const _origInjectBar = injectMemberListAIBar;
injectMemberListAIBar = function() {
    _origInjectBar();
    setTimeout(buildProactiveNudges, 100);
};

//  SMART TASK CREATION AFTER NOTE SAVE 
// After a service note is saved, scan for commitment keywords and offer task creation
function checkForSmartTaskSuggestion(noteText) {
    if (!noteText || !window.currentMember) return;
    const m = window.currentMember;
    const lower = noteText.toLowerCase();

    const triggers = [
        { pattern: /follow.?up in (\d+) (day|week|month)/i,  type: 'follow-up' },
        { pattern: /call (back|again) in (\d+)/i,             type: 'follow-up' },
        { pattern: /schedule.{0,30}(appointment|visit)/i,     type: 'appointment' },
        { pattern: /referr(al|ed) to/i,                        type: 'referral' },
        { pattern: /medication.{0,30}(reconcil|review|fill)/i, type: 'medication' },
    ];

    let matchedType = null;
    let daysOut = 14;
    triggers.forEach(t => {
        const match = noteText.match(t.pattern);
        if (match && !matchedType) {
            matchedType = t.type;
            const num = parseInt(match[1] || match[2]);
            if (!isNaN(num)) {
                if ((match[2]||'').includes('week'))  daysOut = num * 7;
                else if ((match[2]||'').includes('month')) daysOut = num * 30;
                else if (!isNaN(num)) daysOut = num;
            }
        }
    });

    if (!matchedType) return;

    const dueDate = new Date();
    dueDate.setDate(dueDate.getDate() + daysOut);
    const dueDateStr = dueDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });

    const typeLabels = {
        'follow-up': 'Follow-up call',
        'appointment': 'Schedule appointment',
        'referral': 'Track referral',
        'medication': 'Medication review',
    };

    // Show smart suggestion in AI copilot
    const container = document.getElementById('aiMessages');
    if (container && document.getElementById('aiCopilotPanel')?.style.display !== 'none') {
        container.innerHTML = `<div class="ai-conv-assistant"><div class="ai-response-block">
            <div style="padding:10px 12px;background:#f0fdf4;border:1px solid #bbf7d0;border-radius:8px;margin-bottom:12px;">
                <div style="font-size:12px;font-weight:700;color:#166534;margin-bottom:4px;"> Smart Task Suggestion</div>
                <div style="font-size:11px;color:#15803d;">Your note mentions a commitment  should I create a task?</div>
            </div>
            <div style="font-size:12px;font-weight:600;color:#1e293b;margin-bottom:4px;">${typeLabels[matchedType]}</div>
            <div style="font-size:11px;color:#64748b;margin-bottom:10px;">Suggested due: <strong>${dueDateStr}</strong> (${daysOut} days)</div>
            <div style="display:flex;gap:8px;">
                <button class="ai-cp-save-btn" style="flex:1;" onclick="createSmartTask('${matchedType}','${dueDateStr}')"> Create Task</button>
                <button class="ai-back-btn" onclick="resetAICopilot()">Dismiss</button>
            </div>
        </div></div>`;
    }
}

function createSmartTask(type, dueDate) {
    const m = window.currentMember;
    if (!m) return;
    if (!m.tasks) m.tasks = [];
    const labels = { 'follow-up': 'Follow-up call', 'appointment': 'Schedule appointment', 'referral': 'Track referral', 'medication': 'Medication review' };
    m.tasks.push({ id: 'task-auto-' + Date.now(), title: labels[type] || type, status: 'Open', priority: 'Medium', dueDate, assignedTo: m.careManager });
    const container = document.getElementById('aiMessages');
    if (container) {
        container.innerHTML = `<div class="ai-conv-assistant"><div class="ai-response-block">
            <div class="ai-response-summary"> Task created: <strong>${labels[type]}</strong> due ${dueDate}</div>
            <div class="ai-feedback-row" style="margin-top:10px;"><button class="ai-back-btn" onclick="resetAICopilot()"> Back</button></div>
        </div></div>`;
    }
}



// 
// REPORTS PAGE
// 

// 
// AUDIT DEMO MEMBERS  isolated data for Reports page only
// 12 hand-crafted lifecycle scenarios. Never touches membersDB.
// 
const AUDIT_DEMO_MEMBERS = [

    //  1. Simple clean active member 
    {
        id: 'audit-001', name: 'Dorothy Hargrove', medicaidId: '946815210N',
        careManager: 'Jazimyn Williams', consentStatus: 'Consented',
        mco: 'Trillium', memberStatus: 'Active',
        cmAssignmentHistory: [
            {
                isCurrent: true,
                supervisorName: 'Erica Richardson', supervisorAssignedDate: '01/17/2025', supervisorEndDate: null,
                careManagerName: 'Jazimyn Williams', careManagerAssignedDate: '03/28/2025', careManagerEndDate: null,
                consentStatus: 'Consented', consentDate: '01/20/2025', optOutDate: null,
                notes: 'Current assignment. Member enrolled and consented at intake.'
            },
            {
                isCurrent: false,
                supervisorName: 'Erica Richardson', supervisorAssignedDate: '09/04/2024', supervisorEndDate: '03/27/2025',
                careManagerName: 'Madeline Patrick', careManagerAssignedDate: '11/12/2024', careManagerEndDate: '03/27/2025',
                consentStatus: 'Consented', consentDate: '09/10/2024', optOutDate: null,
                notes: 'CM Madeline Patrick reassigned  caseload rebalancing.'
            },
            {
                isCurrent: false,
                supervisorName: 'Erica Richardson', supervisorAssignedDate: '09/04/2024', supervisorEndDate: '11/11/2024',
                careManagerName: 'Lucille Barberian', careManagerAssignedDate: '09/04/2024', careManagerEndDate: '11/11/2024',
                consentStatus: 'Consented', consentDate: '09/10/2024', optOutDate: null,
                notes: 'Initial enrollment. Member assigned to Lucille Barberian at intake.'
            }
        ]
    },

    //  2. CM departed organisation 
    {
        id: 'audit-002', name: 'Marcus Bellingham', medicaidId: '946648216P',
        careManager: 'Jennifer Wilson', consentStatus: 'Consented',
        mco: 'Trillium', memberStatus: 'Active',
        cmAssignmentHistory: [
            {
                isCurrent: true,
                supervisorName: 'Sarah Mitchell', supervisorAssignedDate: '02/01/2024', supervisorEndDate: null,
                careManagerName: 'Jennifer Wilson', careManagerAssignedDate: '08/15/2024', careManagerEndDate: null,
                consentStatus: 'Consented', consentDate: '02/05/2024', optOutDate: null,
                notes: 'CM reassignment  previous CM Thomas Reed departed organization 08/14/2024.'
            },
            {
                isCurrent: false,
                supervisorName: 'Sarah Mitchell', supervisorAssignedDate: '02/01/2024', supervisorEndDate: '08/14/2024',
                careManagerName: 'Thomas Reed', careManagerAssignedDate: '02/01/2024', careManagerEndDate: '08/14/2024',
                consentStatus: 'Consented', consentDate: '02/05/2024', optOutDate: null,
                notes: 'Initial enrollment. Assigned to Thomas Reed at intake.'
            }
        ]
    },

    //  3. Supervisor change only, CM unchanged 
    {
        id: 'audit-003', name: 'Claudette Nwachukwu', medicaidId: '954361351Q',
        careManager: 'Sarah Johnson', consentStatus: 'Consented',
        mco: 'Trillium', memberStatus: 'Active',
        cmAssignmentHistory: [
            {
                isCurrent: true,
                supervisorName: 'David Brown', supervisorAssignedDate: '05/01/2025', supervisorEndDate: null,
                careManagerName: 'Sarah Johnson', careManagerAssignedDate: '03/10/2024', careManagerEndDate: null,
                consentStatus: 'Consented', consentDate: '03/14/2024', optOutDate: null,
                notes: 'Supervisor change  Erica Richardson moved to new region. CM Sarah Johnson retained.'
            },
            {
                isCurrent: false,
                supervisorName: 'Erica Richardson', supervisorAssignedDate: '03/10/2024', supervisorEndDate: '04/30/2025',
                careManagerName: 'Sarah Johnson', careManagerAssignedDate: '03/10/2024', careManagerEndDate: null,
                consentStatus: 'Consented', consentDate: '03/14/2024', optOutDate: null,
                notes: 'Initial enrollment.'
            }
        ]
    },

    //  4. Opt-out then re-consent with new CM 
    {
        id: 'audit-004', name: 'Raymond Osei-Bonsu', medicaidId: '954950126O',
        careManager: 'Michael Chen', consentStatus: 'Consented',
        mco: 'Trillium', memberStatus: 'Active',
        cmAssignmentHistory: [
            {
                isCurrent: true,
                supervisorName: 'David Brown', supervisorAssignedDate: '01/10/2025', supervisorEndDate: null,
                careManagerName: 'Michael Chen', careManagerAssignedDate: '01/10/2025', careManagerEndDate: null,
                consentStatus: 'Consented', consentDate: '01/10/2025', optOutDate: null,
                notes: 'Member re-enrolled and re-consented. New supervisor and CM assigned at re-enrollment.'
            },
            {
                isCurrent: false,
                supervisorName: 'James Whitfield', supervisorAssignedDate: '04/22/2024', supervisorEndDate: '10/05/2024',
                careManagerName: 'Lucille Barberian', careManagerAssignedDate: '04/22/2024', careManagerEndDate: '10/05/2024',
                consentStatus: 'Opted Out', consentDate: '04/25/2024', optOutDate: '10/05/2024',
                notes: 'Member opted out. Stated reason: no longer wishes to participate in care management.'
            },
            {
                isCurrent: false,
                supervisorName: 'James Whitfield', supervisorAssignedDate: '01/08/2024', supervisorEndDate: '04/21/2024',
                careManagerName: 'Jazimyn Williams', careManagerAssignedDate: '01/08/2024', careManagerEndDate: '04/21/2024',
                consentStatus: 'Consented', consentDate: '01/12/2024', optOutDate: null,
                notes: 'Initial enrollment. Member consented at intake.'
            }
        ]
    },

    //  5. Double CM reassignment, same supervisor 
    {
        id: 'audit-005', name: 'Priya Subramaniam', medicaidId: '900526081P',
        careManager: 'Tara Evans', consentStatus: 'Consented',
        mco: 'Trillium', memberStatus: 'Active',
        cmAssignmentHistory: [
            {
                isCurrent: true,
                supervisorName: 'Linda Patel', supervisorAssignedDate: '06/15/2023', supervisorEndDate: null,
                careManagerName: 'Tara Evans', careManagerAssignedDate: '11/01/2024', careManagerEndDate: null,
                consentStatus: 'Consented', consentDate: '06/20/2023', optOutDate: null,
                notes: 'CM reassignment  Madeline Patrick on extended medical leave.'
            },
            {
                isCurrent: false,
                supervisorName: 'Linda Patel', supervisorAssignedDate: '06/15/2023', supervisorEndDate: null,
                careManagerName: 'Madeline Patrick', careManagerAssignedDate: '03/14/2024', careManagerEndDate: '10/31/2024',
                consentStatus: 'Consented', consentDate: '06/20/2023', optOutDate: null,
                notes: 'CM reassignment  Jennifer Wilson moved to different caseload.'
            },
            {
                isCurrent: false,
                supervisorName: 'Linda Patel', supervisorAssignedDate: '06/15/2023', supervisorEndDate: null,
                careManagerName: 'Jennifer Wilson', careManagerAssignedDate: '06/15/2023', careManagerEndDate: '03/13/2024',
                consentStatus: 'Consented', consentDate: '06/20/2023', optOutDate: null,
                notes: 'Initial enrollment.'
            }
        ]
    },

    //  6. Supervisor AND CM changed on same date 
    {
        id: 'audit-006', name: 'Darnell Washington', medicaidId: '944562360Q',
        careManager: 'Jazimyn Williams', consentStatus: 'Consented',
        mco: 'Trillium', memberStatus: 'Active',
        cmAssignmentHistory: [
            {
                isCurrent: true,
                supervisorName: 'Erica Richardson', supervisorAssignedDate: '09/01/2024', supervisorEndDate: null,
                careManagerName: 'Jazimyn Williams', careManagerAssignedDate: '09/01/2024', careManagerEndDate: null,
                consentStatus: 'Consented', consentDate: '02/18/2024', optOutDate: null,
                notes: 'Team restructure 09/01/2024  supervisor and CM both reassigned on same date. Consent continuous.'
            },
            {
                isCurrent: false,
                supervisorName: 'James Whitfield', supervisorAssignedDate: '02/15/2024', supervisorEndDate: '08/31/2024',
                careManagerName: 'Sarah Johnson', careManagerAssignedDate: '02/15/2024', careManagerEndDate: '08/31/2024',
                consentStatus: 'Consented', consentDate: '02/18/2024', optOutDate: null,
                notes: 'Initial enrollment.'
            }
        ]
    },

    //  7. Long opt-out gap (4 months), then re-consent 
    {
        id: 'audit-007', name: 'Felicia Okonkwo', medicaidId: '955600755P',
        careManager: 'Lucille Barberian', consentStatus: 'Consented',
        mco: 'Trillium', memberStatus: 'Active',
        cmAssignmentHistory: [
            {
                isCurrent: true,
                supervisorName: 'Sarah Mitchell', supervisorAssignedDate: '05/20/2025', supervisorEndDate: null,
                careManagerName: 'Lucille Barberian', careManagerAssignedDate: '05/20/2025', careManagerEndDate: null,
                consentStatus: 'Consented', consentDate: '05/20/2025', optOutDate: null,
                notes: 'Member re-consented after extended opt-out period (JanMay 2025). Re-assigned to Lucille Barberian.'
            },
            {
                isCurrent: false,
                supervisorName: 'Sarah Mitchell', supervisorAssignedDate: '08/10/2024', supervisorEndDate: '01/19/2025',
                careManagerName: 'Tara Evans', careManagerAssignedDate: '08/10/2024', careManagerEndDate: '01/19/2025',
                consentStatus: 'Opted Out', consentDate: '08/15/2024', optOutDate: '01/19/2025',
                notes: 'Member opted out 01/19/2025. Personal circumstances  requested no contact.'
            },
            {
                isCurrent: false,
                supervisorName: 'Sarah Mitchell', supervisorAssignedDate: '05/05/2024', supervisorEndDate: '08/09/2024',
                careManagerName: 'Michael Chen', careManagerAssignedDate: '05/05/2024', careManagerEndDate: '08/09/2024',
                consentStatus: 'Consented', consentDate: '05/08/2024', optOutDate: null,
                notes: 'Initial enrollment. CM Michael Chen assigned at intake.'
            }
        ]
    },

    //  8. Two opt-out cycles, re-consented twice 
    {
        id: 'audit-008', name: 'Antonio Guerrero', medicaidId: '957336348S',
        careManager: 'Sarah Johnson', consentStatus: 'Consented',
        mco: 'Trillium', memberStatus: 'Active',
        cmAssignmentHistory: [
            {
                isCurrent: true,
                supervisorName: 'David Brown', supervisorAssignedDate: '03/01/2025', supervisorEndDate: null,
                careManagerName: 'Sarah Johnson', careManagerAssignedDate: '03/01/2025', careManagerEndDate: null,
                consentStatus: 'Consented', consentDate: '03/01/2025', optOutDate: null,
                notes: 'Second re-consent. Member re-enrolled for the third time. Stable assignment.'
            },
            {
                isCurrent: false,
                supervisorName: 'Linda Patel', supervisorAssignedDate: '10/10/2024', supervisorEndDate: '11/30/2024',
                careManagerName: 'Madeline Patrick', careManagerAssignedDate: '10/10/2024', careManagerEndDate: '11/30/2024',
                consentStatus: 'Opted Out', consentDate: '10/12/2024', optOutDate: '11/30/2024',
                notes: 'Second opt-out. Member opted out again citing scheduling conflicts.'
            },
            {
                isCurrent: false,
                supervisorName: 'Linda Patel', supervisorAssignedDate: '07/15/2024', supervisorEndDate: '10/09/2024',
                careManagerName: 'Jazimyn Williams', careManagerAssignedDate: '07/15/2024', careManagerEndDate: '10/09/2024',
                consentStatus: 'Consented', consentDate: '07/15/2024', optOutDate: null,
                notes: 'First re-consent. New CM Jazimyn Williams assigned.'
            },
            {
                isCurrent: false,
                supervisorName: 'James Whitfield', supervisorAssignedDate: '02/20/2024', supervisorEndDate: '07/14/2024',
                careManagerName: 'Jennifer Wilson', careManagerAssignedDate: '02/20/2024', careManagerEndDate: '07/14/2024',
                consentStatus: 'Opted Out', consentDate: '02/22/2024', optOutDate: '07/14/2024',
                notes: 'First opt-out. Member requested to be removed from program.'
            },
            {
                isCurrent: false,
                supervisorName: 'James Whitfield', supervisorAssignedDate: '10/01/2023', supervisorEndDate: '02/19/2024',
                careManagerName: 'Thomas Reed', careManagerAssignedDate: '10/01/2023', careManagerEndDate: '02/19/2024',
                consentStatus: 'Consented', consentDate: '10/05/2023', optOutDate: null,
                notes: 'Initial enrollment.'
            }
        ]
    },

    //  9. Terminated  holding space supervisor/CM 
    {
        id: 'audit-009', name: 'Beverly Strickland', medicaidId: '949420611S',
        careManager: '[Holding] Unassigned Queue', consentStatus: 'Terminated',
        mco: 'Trillium', memberStatus: 'Inactive',
        cmAssignmentHistory: [
            {
                isCurrent: true,
                supervisorName: '[Holding] Broadstep Admin Supervisor', supervisorAssignedDate: '11/01/2024', supervisorEndDate: null,
                careManagerName: '[Holding] Unassigned Queue', careManagerAssignedDate: '11/01/2024', careManagerEndDate: null,
                consentStatus: 'Terminated', consentDate: '04/10/2024', optOutDate: null,
                notes: 'Member enrollment terminated 11/01/2024  no longer eligible. Moved to holding supervisor account. Do not contact.'
            },
            {
                isCurrent: false,
                supervisorName: 'Erica Richardson', supervisorAssignedDate: '04/08/2024', supervisorEndDate: '10/31/2024',
                careManagerName: 'Tara Evans', careManagerAssignedDate: '04/08/2024', careManagerEndDate: '10/31/2024',
                consentStatus: 'Consented', consentDate: '04/10/2024', optOutDate: null,
                notes: 'Initial enrollment. Member consented and active until termination.'
            }
        ]
    },

    //  10. Terminated mid-consent, re-enrolled with different supervisor 
    {
        id: 'audit-010', name: 'Nathaniel Oduya', medicaidId: '951457966Q',
        careManager: 'Jazimyn Williams', consentStatus: 'Consented',
        mco: 'Trillium', memberStatus: 'Active',
        cmAssignmentHistory: [
            {
                isCurrent: true,
                supervisorName: 'Linda Patel', supervisorAssignedDate: '06/01/2025', supervisorEndDate: null,
                careManagerName: 'Jazimyn Williams', careManagerAssignedDate: '06/01/2025', careManagerEndDate: null,
                consentStatus: 'Consented', consentDate: '06/01/2025', optOutDate: null,
                notes: 'Re-enrollment after gap in eligibility. New supervisor Linda Patel assigned.'
            },
            {
                isCurrent: false,
                supervisorName: '[Holding] Broadstep Admin Supervisor', supervisorAssignedDate: '09/15/2024', supervisorEndDate: '05/31/2025',
                careManagerName: '[Holding] Unassigned Queue', careManagerAssignedDate: '09/15/2024', careManagerEndDate: '05/31/2025',
                consentStatus: 'Terminated', consentDate: '03/10/2024', optOutDate: null,
                notes: 'Eligibility lapsed 09/15/2024. Moved to holding account pending re-determination.'
            },
            {
                isCurrent: false,
                supervisorName: 'James Whitfield', supervisorAssignedDate: '03/08/2024', supervisorEndDate: '09/14/2024',
                careManagerName: 'Lucille Barberian', careManagerAssignedDate: '03/08/2024', careManagerEndDate: '09/14/2024',
                consentStatus: 'Consented', consentDate: '03/10/2024', optOutDate: null,
                notes: 'Initial enrollment. Member assigned to Lucille Barberian.'
            }
        ]
    },

    //  11. Recent enroll, 1 record, consent just obtained 
    {
        id: 'audit-011', name: 'Simone Thibodeaux', medicaidId: '950981649N',
        careManager: 'Tara Evans', consentStatus: 'Consented',
        mco: 'Trillium', memberStatus: 'Active',
        cmAssignmentHistory: [
            {
                isCurrent: true,
                supervisorName: 'David Brown', supervisorAssignedDate: '02/10/2026', supervisorEndDate: null,
                careManagerName: 'Tara Evans', careManagerAssignedDate: '02/10/2026', careManagerEndDate: null,
                consentStatus: 'Consented', consentDate: '02/10/2026', optOutDate: null,
                notes: 'New enrollment. Member consented at initial outreach call.'
            }
        ]
    },

    //  12. Full lifecycle  4 rows, sup change + opt-out + holding 
    {
        id: 'audit-012', name: 'Reginald Asante-Mensah', medicaidId: '951874608R',
        careManager: '[Holding] Unassigned Queue', consentStatus: 'Terminated',
        mco: 'Trillium', memberStatus: 'Inactive',
        cmAssignmentHistory: [
            {
                isCurrent: true,
                supervisorName: '[Holding] Broadstep Admin Supervisor', supervisorAssignedDate: '01/15/2026', supervisorEndDate: null,
                careManagerName: '[Holding] Unassigned Queue', careManagerAssignedDate: '01/15/2026', careManagerEndDate: null,
                consentStatus: 'Terminated', consentDate: '11/01/2023', optOutDate: null,
                notes: 'Member enrollment closed 01/15/2026. Moved to holding account. No further contact.'
            },
            {
                isCurrent: false,
                supervisorName: 'Sarah Mitchell', supervisorAssignedDate: '04/01/2025', supervisorEndDate: '01/14/2026',
                careManagerName: 'Michael Chen', careManagerAssignedDate: '04/01/2025', careManagerEndDate: '01/14/2026',
                consentStatus: 'Consented', consentDate: '03/15/2025', optOutDate: null,
                notes: 'Re-consent after opt-out. New supervisor Sarah Mitchell and CM Michael Chen assigned.'
            },
            {
                isCurrent: false,
                supervisorName: 'Erica Richardson', supervisorAssignedDate: '11/01/2023', supervisorEndDate: '10/15/2024',
                careManagerName: 'Jennifer Wilson', careManagerAssignedDate: '07/20/2024', careManagerEndDate: '10/15/2024',
                consentStatus: 'Opted Out', consentDate: '11/05/2023', optOutDate: '10/15/2024',
                notes: 'Member opted out 10/15/2024. CM changed from Madeline Patrick to Jennifer Wilson in July due to caseload rebalancing.'
            },
            {
                isCurrent: false,
                supervisorName: 'Erica Richardson', supervisorAssignedDate: '11/01/2023', supervisorEndDate: null,
                careManagerName: 'Madeline Patrick', careManagerAssignedDate: '11/01/2023', careManagerEndDate: '07/19/2024',
                consentStatus: 'Consented', consentDate: '11/05/2023', optOutDate: null,
                notes: 'Initial enrollment. Assigned to Madeline Patrick at intake.'
            }
        ]
    }

]; // end AUDIT_DEMO_MEMBERS

const reportRunLog = [];
function navigateToReports() {
    const pc = document.getElementById('pageContainer');
    if (!pc) return;
    pc.innerHTML = buildReportsPageHTML();
    updateBreadcrumbs(['Home', 'Reports']);
    setTimeout(initReportsPage, 0);
}
function buildReportsPageHTML() {
    return `
    <div style="padding:28px 32px;max-width:1400px;margin:0 auto;font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',sans-serif;">
        <div style="display:flex;align-items:flex-start;margin-bottom:28px;">
            <div>
                <div style="display:flex;align-items:center;gap:10px;margin-bottom:6px;">
                    <div style="width:36px;height:36px;background:#353182;border-radius:8px;display:flex;align-items:center;justify-content:center;">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2"><path d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg>
                    </div>
                    <h1 style="font-size:22px;font-weight:700;color:#1e293b;margin:0;">Reports</h1>
                    <span style="background:#fef3c7;color:#92400e;font-size:11px;font-weight:600;padding:2px 8px;border-radius:12px;border:1px solid #fde68a;">NEW</span>
                </div>
                <p style="color:#64748b;font-size:13px;margin:0;">Generate compliance and audit reports across your member caseload.</p>
            </div>
        </div>

        <div style="background:white;border:1px solid #e2e8f0;border-radius:12px;margin-bottom:20px;overflow:hidden;">
            <div style="background:#f8fafc;border-bottom:1px solid #e2e8f0;padding:14px 20px;display:flex;align-items:center;gap:8px;">
                <div style="width:22px;height:22px;background:#353182;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:700;color:white;flex-shrink:0;">1</div>
                <span style="font-size:13px;font-weight:600;color:#1e293b;">Report Configuration</span>
            </div>
            <div style="padding:20px 24px;">
                <div style="margin-bottom:20px;">
                    <label style="display:block;font-size:12px;font-weight:600;color:#374151;margin-bottom:6px;">Report Type</label>
                    <select id="rptTypeSelect" style="border:1px solid #d1d5db;border-radius:6px;padding:8px 12px;font-size:13px;color:#1e293b;background:white;width:420px;">
                        <option value="cm_assignment">CM &amp; Supervisor Assignment History  Trillium Audit Format</option>
                        <option disabled>Consent Summary Report (coming soon)</option>
                        <option disabled>Risk Tier Change History (coming soon)</option>
                    </select>
                </div>
                <div style="display:grid;grid-template-columns:1fr 320px;gap:24px;align-items:start;">
                    <div>
                        <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:6px;">
                            <label style="font-size:12px;font-weight:600;color:#374151;">Select Members</label>
                            <div style="display:flex;gap:10px;">
                                <button onclick="rptSelectAll()" style="font-size:11px;color:#353182;background:none;border:none;cursor:pointer;font-weight:600;text-decoration:underline;">Select All</button>
                                <button onclick="rptDeselectAll()" style="font-size:11px;color:#64748b;background:none;border:none;cursor:pointer;font-weight:600;text-decoration:underline;">Deselect All</button>
                            </div>
                        </div>
                        <div style="position:relative;margin-bottom:8px;">
                            <svg style="position:absolute;left:10px;top:50%;transform:translateY(-50%);width:14px;height:14px;" viewBox="0 0 20 20" fill="#9ca3af"><path fill-rule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z"/></svg>
                            <input id="rptMemberSearch" type="text" placeholder="Search by name or Medicaid ID..." oninput="rptFilterMembers(this.value)"
                                style="width:100%;box-sizing:border-box;border:1px solid #d1d5db;border-radius:6px;padding:7px 10px 7px 30px;font-size:12px;color:#374151;outline:none;">
                        </div>
                        <div id="rptMemberList" style="border:1px solid #e2e8f0;border-radius:8px;max-height:280px;overflow-y:auto;background:#fafafa;"></div>
                        <div id="rptSelectionCount" style="font-size:11px;color:#64748b;margin-top:6px;text-align:right;"></div>
                    </div>
                    <div style="background:#f8fafc;border:1px solid #e2e8f0;border-radius:8px;padding:16px;">
                        <div style="font-size:12px;font-weight:600;color:#374151;margin-bottom:14px;text-transform:uppercase;letter-spacing:0.05em;">Report Options</div>
                        <div style="margin-bottom:14px;">
                            <label style="font-size:12px;font-weight:600;color:#374151;display:block;margin-bottom:6px;">Date Range</label>
                            <select id="rptDateRange" onchange="rptOnDateRangeChange()" style="width:100%;border:1px solid #d1d5db;border-radius:6px;padding:7px 10px;font-size:12px;background:white;color:#374151;">
                                <option value="full">Full consented period (auto)</option>
                                <option value="2026">Year to date (2026)</option>
                                <option value="2025">Calendar year 2025</option>
                                <option value="2024">Calendar year 2024</option>
                                <option value="2023">Calendar year 2023</option>
                            </select>
                        </div>
                        <div style="margin-bottom:14px;">
                            <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:6px;">
                                <label style="font-size:12px;font-weight:600;color:#374151;">Include holding-space rows</label>
                                <div id="rptHoldingToggle" onclick="rptToggleHolding()" style="width:36px;height:20px;background:#d1d5db;border-radius:10px;cursor:pointer;position:relative;flex-shrink:0;">
                                    <div id="rptHoldingKnob" style="width:16px;height:16px;background:white;border-radius:50%;position:absolute;top:2px;left:2px;transition:left 0.2s;box-shadow:0 1px 3px rgba(0,0,0,0.2);"></div>
                                </div>
                            </div>
                            <p style="font-size:11px;color:#64748b;margin:0;line-height:1.4;">When on, terminated/holding-space assignment rows appear in the export.</p>
                        </div>
                        <div>
                            <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:6px;">
                                <label style="font-size:12px;font-weight:600;color:#374151;">Run AI pre-flight check</label>
                                <div id="rptPreflightToggle" onclick="rptTogglePreflight()" style="width:36px;height:20px;background:#353182;border-radius:10px;cursor:pointer;position:relative;flex-shrink:0;">
                                    <div id="rptPreflightKnob" style="width:16px;height:16px;background:white;border-radius:50%;position:absolute;top:2px;left:18px;transition:left 0.2s;box-shadow:0 1px 3px rgba(0,0,0,0.2);"></div>
                                </div>
                            </div>
                            <p style="font-size:11px;color:#64748b;margin:0;line-height:1.4;">Scans for missing dates, undefined values, and consent gaps before generating.</p>
                        </div>
                    </div>
                </div>
                <div style="margin-top:20px;padding-top:16px;border-top:1px solid #f1f5f9;display:flex;align-items:center;gap:12px;">
                    <button onclick="rptGenerate()" id="rptGenerateBtn" style="background:#353182;color:white;border:none;border-radius:8px;padding:10px 28px;font-size:13px;font-weight:600;cursor:pointer;display:flex;align-items:center;gap:8px;">
                        <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg>
                        Validate &amp; Generate Report
                    </button>
                    <span id="rptGenerateHint" style="font-size:12px;color:#94a3b8;">Select at least one member to generate a report.</span>
                </div>
            </div>
        </div>

        <div id="rptPreflightZone" style="display:none;background:white;border:1px solid #e2e8f0;border-radius:12px;margin-bottom:20px;overflow:hidden;">
            <div style="background:#f8fafc;border-bottom:1px solid #e2e8f0;padding:14px 20px;display:flex;align-items:center;gap:8px;">
                <div style="width:22px;height:22px;background:#353182;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:700;color:white;flex-shrink:0;">2</div>
                <span style="font-size:13px;font-weight:600;color:#1e293b;">AI Pre-flight Check</span>
                <span id="rptPreflightBadge" style="font-size:11px;font-weight:600;padding:2px 8px;border-radius:12px;margin-left:4px;"></span>
            </div>
            <div id="rptPreflightContent" style="padding:16px 24px;"></div>
        </div>

        <div id="rptPreviewZone" style="display:none;background:white;border:1px solid #e2e8f0;border-radius:12px;margin-bottom:20px;overflow:hidden;">
            <div style="background:#f8fafc;border-bottom:1px solid #e2e8f0;padding:14px 20px;display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:10px;">
                <div style="display:flex;align-items:center;gap:8px;">
                    <div style="width:22px;height:22px;background:#353182;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:700;color:white;flex-shrink:0;">3</div>
                    <span style="font-size:13px;font-weight:600;color:#1e293b;">Report Preview</span>
                    <span style="background:#f0f1fb;color:#353182;font-size:11px;font-weight:700;padding:2px 10px;border-radius:12px;border:1px solid #d0d3f0;">Broadstep / Trillium Audit Report</span>
                </div>
                <div style="display:flex;align-items:center;gap:10px;">
                    <div id="rptSummaryStrip" style="font-size:12px;color:#64748b;"></div>
                    <button onclick="rptExportCSV()" style="background:#10b981;color:white;border:none;border-radius:6px;padding:8px 16px;font-size:12px;font-weight:600;cursor:pointer;display:flex;align-items:center;gap:6px;">
                        <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
                        Export CSV
                    </button>
                </div>
            </div>
            <div style="overflow-x:auto;">
                <table style="width:max-content;min-width:100%;border-collapse:collapse;font-size:12px;">
                    <thead><tr style="background:#2d2d52;color:white;text-align:left;">
                        <th style="padding:10px 14px;font-weight:500;white-space:nowrap;min-width:120px;">Medicaid ID</th>
                        <th style="padding:10px 14px;font-weight:500;white-space:nowrap;min-width:150px;">Member Name</th>
                        <th style="padding:10px 14px;font-weight:500;white-space:nowrap;min-width:155px;">Supervisor Name</th>
                        <th style="padding:10px 14px;font-weight:500;white-space:nowrap;min-width:155px;">Supervisor Assigned Date</th>
                        <th style="padding:10px 14px;font-weight:500;white-space:nowrap;min-width:130px;">Supervisor End Date</th>
                        <th style="padding:10px 14px;font-weight:500;white-space:nowrap;min-width:165px;">Care Manager Name</th>
                        <th style="padding:10px 14px;font-weight:500;white-space:nowrap;min-width:130px;">CM Assigned Date</th>
                        <th style="padding:10px 14px;font-weight:500;white-space:nowrap;min-width:110px;">CM End Date</th>
                        <th style="padding:10px 14px;font-weight:500;white-space:nowrap;min-width:110px;">Consent Date</th>
                        <th style="padding:10px 14px;font-weight:500;white-space:nowrap;min-width:140px;">Currently Consented?</th>
                        <th style="padding:10px 14px;font-weight:500;white-space:nowrap;min-width:110px;">Opt Out Date</th>
                        <th style="padding:10px 14px;font-weight:500;white-space:nowrap;min-width:200px;">Notes / Reason</th>
                    </tr></thead>
                    <tbody id="rptTableBody"></tbody>
                </table>
            </div>
            <div style="padding:12px 20px;border-top:1px solid #f1f5f9;display:flex;align-items:center;justify-content:space-between;">
                <span id="rptRowCount" style="font-size:12px;color:#64748b;"></span>
                <span id="rptGeneratedBy" style="font-size:11px;color:#94a3b8;"></span>
            </div>
        </div>

        <div style="background:white;border:1px solid #e2e8f0;border-radius:12px;overflow:hidden;">
            <div style="background:#f8fafc;border-bottom:1px solid #e2e8f0;padding:14px 20px;display:flex;align-items:center;gap:8px;">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="#64748b" stroke-width="2"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
                <span style="font-size:13px;font-weight:600;color:#1e293b;">Report History</span>
                <span style="font-size:11px;color:#94a3b8;"> audit trail of all exports this session</span>
            </div>
            <div id="rptHistoryList"><div style="padding:24px;text-align:center;color:#94a3b8;font-size:13px;">No reports generated yet this session.</div></div>
        </div>
    </div>`;
}

let rptState = { selected: new Set(), includeHolding: false, runPreflight: true, reportRows: [], allMembers: [] };

//  Shared date helpers (used by member list + generate) 
function rptParseDate(s) {
    if (!s || s === '' || s === 'Current' || s === 'null') return null;
    var p = s.split('/');
    if (p.length !== 3) return null;
    return new Date(parseInt(p[2],10), parseInt(p[0],10)-1, parseInt(p[1],10));
}

function rptGetYearWindow(val) {
    if (!val || val === 'full') return null;
    var yr = parseInt(val, 10);
    return { start: new Date(yr, 0, 1), end: new Date(yr, 11, 31, 23, 59, 59) };
}

function rptRowInWindow(r, win) {
    if (!win) return true;
    var start = rptParseDate(r.careManagerAssignedDate) || rptParseDate(r.supervisorAssignedDate);
    var end   = rptParseDate(r.careManagerEndDate) || rptParseDate(r.supervisorEndDate);
    if (!start) return true;
    return start <= win.end && (!end || end >= win.start);
}

function rptGetMatchCount(m, win) {
    if (!win) return (m.cmAssignmentHistory||[]).length;
    return (m.cmAssignmentHistory||[]).filter(function(r){ return rptRowInWindow(r, win); }).length;
}

//  Called whenever date range changes 
function rptOnDateRangeChange() {
    var q = (document.getElementById('rptMemberSearch')||{}).value || '';
    rptFilterMembers(q);
    // Hide stale report zones so user knows they need to regenerate
    var pf = document.getElementById('rptPreflightZone');
    var pv = document.getElementById('rptPreviewZone');
    if (pf) pf.style.display = 'none';
    if (pv) pv.style.display = 'none';
    rptUpdateGenerateHint();
}

function initReportsPage() {
    rptState.allMembers = (typeof AUDIT_DEMO_MEMBERS !== 'undefined') ? AUDIT_DEMO_MEMBERS : [];
    rptState.selected = new Set(rptState.allMembers.slice(0, 8).map(function(m){ return m.id; }));
    rptRenderMemberList(rptState.allMembers);
    rptUpdateSelectionCount();
    rptUpdateGenerateHint();
    renderReportHistory();
}

function rptRenderMemberList(members) {
    var container = document.getElementById('rptMemberList');
    if (!container) return;
    if (members.length === 0) { container.innerHTML = '<div style="padding:16px;text-align:center;color:#94a3b8;font-size:12px;">No members found.</div>'; return; }

    var dateRangeEl = document.getElementById('rptDateRange');
    var dateRangeVal = dateRangeEl ? dateRangeEl.value : 'full';
    var win = rptGetYearWindow(dateRangeVal);
    var isFiltered = !!win;
    var rangeLabel = dateRangeVal === 'full' ? '' : dateRangeVal === '2026' ? '2026 YTD' : dateRangeVal;

    container.innerHTML = members.map(function(m) {
        var checked = rptState.selected.has(m.id);
        var cs = m.consentStatus || '';
        var badge = cs === 'Consented'
            ? '<span style="background:#dcfce7;color:#166534;font-size:10px;padding:1px 6px;border-radius:8px;font-weight:600;margin-left:4px;">Consented</span>'
            : cs === 'Opted Out'
            ? '<span style="background:#fee2e2;color:#dc2626;font-size:10px;padding:1px 6px;border-radius:8px;font-weight:600;margin-left:4px;">Opted Out</span>'
            : cs === 'Terminated'
            ? '<span style="background:#f1f5f9;color:#64748b;font-size:10px;padding:1px 6px;border-radius:8px;font-weight:600;margin-left:4px;">Terminated</span>'
            : '<span style="background:#fef9c3;color:#854d0e;font-size:10px;padding:1px 6px;border-radius:8px;font-weight:600;margin-left:4px;">'+(cs||'Unknown')+'</span>';

        var totalRecords  = (m.cmAssignmentHistory||[]).length;
        var matchRecords  = rptGetMatchCount(m, win);
        var hasMatches    = matchRecords > 0;

        // Record count pill  shows match/total when filtered
        var countPill;
        if (!isFiltered) {
            countPill = '<div style="font-size:10px;color:#94a3b8;flex-shrink:0;">'
                + totalRecords + ' record' + (totalRecords!==1?'s':'') + '</div>';
        } else if (hasMatches) {
            countPill = '<div style="flex-shrink:0;text-align:right;">'
                + '<span style="font-size:11px;font-weight:700;color:#353182;">' + matchRecords + '</span>'
                + '<span style="font-size:10px;color:#94a3b8;"> / ' + totalRecords + ' in ' + rangeLabel + '</span>'
                + '</div>';
        } else {
            countPill = '<div style="font-size:10px;color:#cbd5e1;flex-shrink:0;font-style:italic;">0 records in ' + rangeLabel + '</div>';
        }

        // Dim row if no records match the selected year
        var rowOpacity = isFiltered && !hasMatches ? 'opacity:0.45;' : '';

        return '<label style="display:flex;align-items:center;gap:10px;padding:8px 12px;cursor:pointer;border-bottom:1px solid #f1f5f9;' + rowOpacity + '">'
            + '<input type="checkbox" data-member-id="' + m.id + '" ' + (checked?'checked':'') + ' onchange="rptToggleMember(this)" style="width:14px;height:14px;accent-color:#353182;flex-shrink:0;cursor:pointer;">'
            + '<div style="flex:1;min-width:0;">'
            + '<div style="font-size:12px;font-weight:500;color:#1e293b;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">' + m.name + badge + '</div>'
            + '<div style="font-size:11px;color:#64748b;">' + (m.medicaidId||m.id) + ' &nbsp;&nbsp; ' + (m.careManager||'') + '</div>'
            + '</div>'
            + countPill
            + '</label>';
    }).join('');
}

function rptFilterMembers(q) {
    q = (q||'').toLowerCase();
    var filtered = q ? rptState.allMembers.filter(function(m){ return m.name.toLowerCase().includes(q) || (m.medicaidId||'').toLowerCase().includes(q); }) : rptState.allMembers;
    rptRenderMemberList(filtered);
}

function rptToggleMember(cb) {
    var id = cb.getAttribute('data-member-id');
    cb.checked ? rptState.selected.add(id) : rptState.selected.delete(id);
    rptUpdateSelectionCount(); rptUpdateGenerateHint();
}

function rptSelectAll() {
    rptState.allMembers.forEach(function(m){ rptState.selected.add(m.id); });
    rptRenderMemberList(rptState.allMembers);
    rptUpdateSelectionCount(); rptUpdateGenerateHint();
}

function rptDeselectAll() {
    rptState.selected.clear();
    rptRenderMemberList(rptState.allMembers);
    rptUpdateSelectionCount(); rptUpdateGenerateHint();
}

function rptUpdateSelectionCount() {
    var el = document.getElementById('rptSelectionCount');
    if (el) el.textContent = rptState.selected.size + ' of ' + rptState.allMembers.length + ' members selected';
}

function rptUpdateGenerateHint() {
    var hint = document.getElementById('rptGenerateHint');
    if (!hint) return;
    var n = rptState.selected.size;
    hint.textContent = n === 0 ? 'Select at least one member to generate a report.' : n + ' member' + (n>1?'s':'') + ' selected  ready to generate.';
    hint.style.color = n > 0 ? '#10b981' : '#94a3b8';
}

function rptToggleHolding() {
    rptState.includeHolding = !rptState.includeHolding;
    var t = document.getElementById('rptHoldingToggle'), k = document.getElementById('rptHoldingKnob');
    if (t) t.style.background = rptState.includeHolding ? '#353182' : '#d1d5db';
    if (k) k.style.left = rptState.includeHolding ? '18px' : '2px';
}

function rptTogglePreflight() {
    rptState.runPreflight = !rptState.runPreflight;
    var t = document.getElementById('rptPreflightToggle'), k = document.getElementById('rptPreflightKnob');
    if (t) t.style.background = rptState.runPreflight ? '#353182' : '#d1d5db';
    if (k) k.style.left = rptState.runPreflight ? '18px' : '2px';
}

function rptGenerate() {
    if (rptState.selected.size === 0) { _showToast('Please select at least one member.', '#ef4444'); return; }
    var btn = document.getElementById('rptGenerateBtn');
    if (btn) { btn.disabled = true; btn.textContent = 'Generating...'; }
    setTimeout(function() {
        var selectedMembers = rptState.allMembers.filter(function(m){ return rptState.selected.has(m.id); });
        if (rptState.runPreflight) renderPreflight(selectedMembers);
        var SUP_FB = ['Erica Richardson','Sarah Mitchell','David Brown','James Whitfield','Linda Patel'];
        var CM_FB  = ['Jennifer Wilson','Michael Chen','Sarah Johnson','Jazimyn Williams','Lucille Barberian'];
        function clean(v, fb) { return (!v || v==='undefined' || v==='null') ? fb : v; }

        // Date range filter using shared helpers
        var dateRangeEl = document.getElementById('rptDateRange');
        var dateRangeVal = dateRangeEl ? dateRangeEl.value : 'full';
        var win = rptGetYearWindow(dateRangeVal);

        rptState.reportRows = [];
        selectedMembers.forEach(function(m) {
            var idx = parseInt((m.id||'0').replace(/\D/g,'').slice(-2)||'0', 10);
            var fbSup = (m.careTeamData && m.careTeamData.supervisor) || m.supervisor || SUP_FB[idx % SUP_FB.length];
            var fbCM  = (m.careTeamData && m.careTeamData.primary)    || m.careManager  || CM_FB[idx % CM_FB.length];
            var isConsented = m.consentStatus && m.consentStatus.toLowerCase().includes('consent') && !m.consentStatus.toLowerCase().includes('opt');
            (m.cmAssignmentHistory || []).forEach(function(r) {
                var isHolding = (r.notes||'').toLowerCase().includes('holding') || (r.notes||'').toLowerCase().includes('terminat');
                if (isHolding && !rptState.includeHolding) return;
                if (!rptRowInWindow(r, win)) return; // date range filter
                rptState.reportRows.push({
                    medicaidId: m.medicaidId||m.id, memberName: m.name,
                    supervisorName:  clean(r.supervisorName, fbSup),
                    supAssignedDate: clean(r.supervisorAssignedDate, ''),
                    supEndDate:      r.supervisorEndDate  || (r.isCurrent ? 'Current' : ''),
                    careManagerName: clean(r.careManagerName, fbCM),
                    cmAssignedDate:  clean(r.careManagerAssignedDate, ''),
                    cmEndDate:       r.careManagerEndDate || (r.isCurrent ? 'Current' : ''),
                    consentDate:     r.consentDate || '',
                    currentlyConsented: r.isCurrent ? (isConsented ? 'Yes' : 'No') : (r.consentStatus==='Consented' ? 'Yes' : 'No'),
                    optOutDate: r.optOutDate || '',
                    notes: r.notes || '',
                    isCurrent: !!r.isCurrent
                });
            });
        });
        renderReportTable(rptState.reportRows, selectedMembers.length, dateRangeVal);
        if (btn) { btn.disabled=false; btn.innerHTML='<svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg> Validate &amp; Generate Report'; }
    }, 600);
}

function renderPreflight(members) {
    var zone = document.getElementById('rptPreflightZone');
    var content = document.getElementById('rptPreflightContent');
    var badge = document.getElementById('rptPreflightBadge');
    if (!zone||!content) return;
    var ok=0,warn=0,err=0;
    var rows = members.map(function(m) {
        var history = m.cmAssignmentHistory||[];
        var issues = [];
        if (history.length===0) { issues.push({type:'error',msg:'No assignment history records found'}); }
        else {
            history.forEach(function(r,i) {
                if (!r.supervisorName||r.supervisorName==='undefined') issues.push({type:'warn',msg:'Row '+(i+1)+': Supervisor name missing'});
                if (!r.careManagerName||r.careManagerName==='undefined') issues.push({type:'warn',msg:'Row '+(i+1)+': Care Manager name missing'});
                if (!r.consentDate && r.consentStatus==='Consented') issues.push({type:'warn',msg:'Row '+(i+1)+': Consent date missing despite Consented status'});
            });
            if (!history.some(function(r){return r.isCurrent;})) issues.push({type:'warn',msg:'No current record  history may be incomplete'});
        }
        var hasErr = issues.some(function(i){return i.type==='error';});
        var statusColor = hasErr?'#dc2626':issues.length>0?'#d97706':'#166534';
        var statusBg    = hasErr?'#fee2e2':issues.length>0?'#fef3c7':'#dcfce7';
        var status      = hasErr?'Error':issues.length>0?'Warning':'OK';
        var iconStroke  = statusColor;
        var icon = hasErr
            ? '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="'+iconStroke+'" stroke-width="2.5"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg>'
            : issues.length>0
            ? '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="'+iconStroke+'" stroke-width="2.5"><path d="M10.29 3.86L1.82 18a2 2 0 001.71 3h16.94a2 2 0 001.71-3L13.71 3.86a2 2 0 00-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>'
            : '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="'+iconStroke+'" stroke-width="2.5"><polyline points="20 6 9 17 4 12"/></svg>';
        hasErr ? err++ : issues.length>0 ? warn++ : ok++;
        return '<div style="display:flex;gap:12px;align-items:flex-start;padding:8px 0;border-bottom:1px solid #f1f5f9;">'
            + '<div style="flex-shrink:0;margin-top:2px;">'+icon+'</div>'
            + '<div style="flex:1;">'
            + '<div style="display:flex;align-items:center;gap:8px;flex-wrap:wrap;">'
            + '<span style="font-size:12px;font-weight:600;color:#1e293b;">'+m.name+'</span>'
            + '<span style="font-size:11px;color:#64748b;">'+(m.medicaidId||m.id)+'</span>'
            + '<span style="font-size:10px;font-weight:600;background:'+statusBg+';color:'+statusColor+';padding:1px 6px;border-radius:8px;">'+status+'</span>'
            + '<span style="font-size:11px;color:#94a3b8;">'+history.length+' record'+(history.length!==1?'s':'')+'</span>'
            + '</div>'
            + (issues.length ? '<ul style="margin:4px 0 0 18px;padding:0;font-size:11px;">'+issues.map(function(i){return '<li style="margin-bottom:2px;color:'+(i.type==='error'?'#dc2626':'#d97706')+';">'+i.msg+'</li>';}).join('')+'</ul>' : '')
            + '</div></div>';
    }).join('');
    var summaryBg = err>0?'#fee2e2':warn>0?'#fef9c3':'#dcfce7';
    var summaryFg = err>0?'#dc2626':warn>0?'#92400e':'#166534';
    badge.textContent = err>0 ? err+' error'+(err>1?'s':'')+', '+warn+' warning'+(warn!==1?'s':'')
        : warn>0 ? warn+' warning'+(warn!==1?'s':'')+', '+ok+' clean'
        : 'All '+ok+' members passed';
    badge.style.cssText = 'font-size:11px;font-weight:600;padding:2px 8px;border-radius:12px;margin-left:4px;background:'+summaryBg+';color:'+summaryFg+';border:1px solid '+(err>0?'#fca5a5':warn>0?'#fde68a':'#86efac')+';';
    content.innerHTML = '<div style="max-height:280px;overflow-y:auto;">'+rows+'</div>';
    zone.style.display = 'block';
    zone.scrollIntoView({behavior:'smooth',block:'nearest'});
}

function renderReportTable(rows, memberCount, dateRangeVal) {
    dateRangeVal = dateRangeVal || 'full';
    var zone = document.getElementById('rptPreviewZone');
    var tbody = document.getElementById('rptTableBody');
    if (!zone||!tbody) return;
    var now = new Date();
    var ts = now.toLocaleDateString('en-US',{month:'2-digit',day:'2-digit',year:'numeric'})+' '+now.toLocaleTimeString('en-US',{hour:'2-digit',minute:'2-digit'});
    tbody.innerHTML = rows.map(function(r,i) {
        var consBadge = r.currentlyConsented==='Yes'
            ? '<span style="background:#dcfce7;color:#166534;padding:1px 7px;border-radius:8px;font-size:10px;font-weight:700;">Yes</span>'
            : '<span style="background:#fee2e2;color:#dc2626;padding:1px 7px;border-radius:8px;font-size:10px;font-weight:700;">No</span>';
        var bg = r.isCurrent ? 'background:#f8faff;' : i%2===0 ? '' : 'background:#fafafa;';
        var curTag = r.isCurrent ? ' <span style="background:#e0e7ff;color:#4338ca;padding:1px 5px;border-radius:6px;font-size:9px;font-weight:700;vertical-align:middle;">CURRENT</span>' : '';
        var td = 'padding:9px 14px;white-space:nowrap;';
        return '<tr style="'+bg+'border-bottom:1px solid #f1f5f9;">'
            +'<td style="'+td+'color:#374151;">'+r.medicaidId+'</td>'
            +'<td style="'+td+'color:#1e293b;font-weight:500;">'+r.memberName+'</td>'
            +'<td style="'+td+'color:#374151;">'+r.supervisorName+'</td>'
            +'<td style="'+td+'color:#374151;">'+r.supAssignedDate+'</td>'
            +'<td style="'+td+'color:#374151;">'+r.supEndDate+'</td>'
            +'<td style="'+td+'color:#374151;">'+r.careManagerName+curTag+'</td>'
            +'<td style="'+td+'color:#374151;">'+r.cmAssignedDate+'</td>'
            +'<td style="'+td+'color:#374151;">'+r.cmEndDate+'</td>'
            +'<td style="'+td+'color:#374151;">'+r.consentDate+'</td>'
            +'<td style="'+td+'">'+consBadge+'</td>'
            +'<td style="'+td+'color:#374151;">'+r.optOutDate+'</td>'
            +'<td style="padding:9px 14px;color:#64748b;font-size:11px;max-width:260px;white-space:normal;word-break:break-word;">'+r.notes+'</td>'
            +'</tr>';
    }).join('');
    var summary = document.getElementById('rptSummaryStrip');
    var rowCount = document.getElementById('rptRowCount');
    var genBy = document.getElementById('rptGeneratedBy');
    if (summary) {
        var rangeLabel = dateRangeVal === 'full' ? 'Full consented period'
            : dateRangeVal === '2026' ? 'Year to date 2026'
            : 'Calendar year ' + dateRangeVal;
        summary.innerHTML = '<strong>'+memberCount+'</strong> members &nbsp;&nbsp; <strong>'+rows.length+'</strong> total rows &nbsp;&nbsp; <span style="background:#f0f1fb;color:#353182;padding:1px 8px;border-radius:8px;font-size:11px;font-weight:600;">'+rangeLabel+'</span>';
    }
    if (rowCount) rowCount.textContent = 'Showing '+rows.length+' rows across '+memberCount+' members';
    if (genBy) genBy.textContent = 'Generated '+ts+'  John Smith (Care Manager)';
    zone.style.display = 'block';
    setTimeout(function(){zone.scrollIntoView({behavior:'smooth',block:'nearest'});}, 100);
    reportRunLog.unshift({ts:ts, memberCount:memberCount, rowCount:rows.length, user:'John Smith'});
    renderReportHistory();
}

function renderReportHistory() {
    var el = document.getElementById('rptHistoryList');
    if (!el) return;
    if (reportRunLog.length===0) { el.innerHTML = '<div style="padding:24px;text-align:center;color:#94a3b8;font-size:13px;">No reports generated yet this session.</div>'; return; }
    el.innerHTML = reportRunLog.slice(0,8).map(function(r,i) {
        return '<div style="display:flex;align-items:center;gap:14px;padding:12px 20px;border-bottom:1px solid #f8fafc;'+(i===0?'background:#f8faff;':'')+'">'
            + '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="#64748b" stroke-width="2"><path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><polyline points="14 2 14 8 20 8"/></svg>'
            + '<div style="flex:1;"><div style="font-size:12px;font-weight:500;color:#1e293b;">CM &amp; Supervisor Assignment History  Trillium Audit Format</div>'
            + '<div style="font-size:11px;color:#64748b;">'+r.memberCount+' members  '+r.rowCount+' rows  '+r.user+'</div></div>'
            + '<div style="font-size:11px;color:#94a3b8;white-space:nowrap;">'+r.ts+'</div>'
            + (i===0 ? '<button onclick="rptExportCSV()" style="font-size:11px;background:#f0f1fb;color:#353182;border:1px solid #d0d3f0;border-radius:5px;padding:4px 10px;cursor:pointer;font-weight:600;white-space:nowrap;">Re-export CSV</button>' : '')
            + '</div>';
    }).join('');
}

function rptExportCSV() {
    if (!rptState.reportRows||rptState.reportRows.length===0) { _showToast('Generate a report first.','#ef4444'); return; }
    var headers = ['Medicaid ID','Member Name','Supervisor Name','Supervisor Assigned Date','Supervisor End Date','Care Manager Name','CM Assigned Date','CM End Date','Consent Date','Currently Consented?','Opt Out Date','Notes / Reason'];
    var csvRows = [headers.join(',')].concat(rptState.reportRows.map(function(r){
        return [r.medicaidId,r.memberName,r.supervisorName,r.supAssignedDate,r.supEndDate,r.careManagerName,r.cmAssignedDate,r.cmEndDate,r.consentDate,r.currentlyConsented,r.optOutDate,'"'+(r.notes||'').replace(/"/g,'""')+'"'].join(',');
    }));
    var blob = new Blob([csvRows.join('\n')],{type:'text/csv'});
    var url = URL.createObjectURL(blob);
    var a = document.createElement('a'); a.href=url; a.download='Sevida_Trillium_Audit_'+new Date().toISOString().slice(0,10)+'.csv'; a.click();
    URL.revokeObjectURL(url);
    _showToast('CSV exported  Sevida_Trillium_Audit_'+new Date().toISOString().slice(0,10)+'.csv');
}

    </script>

<!--  -->
<!-- REASSIGN SUPERVISOR / CM MODAL                            -->
<!--  -->
<div id="reassignModal" style="display:none;position:fixed;inset:0;z-index:9999;background:rgba(15,23,42,0.45);overflow-y:auto;">
    <div style="min-height:100%;display:flex;align-items:flex-start;justify-content:center;padding:40px 20px;">
        <div style="background:white;border-radius:12px;width:100%;max-width:900px;box-shadow:0 25px 60px rgba(0,0,0,0.2);overflow:hidden;font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',sans-serif;">

            <!-- Header -->
            <div style="background:#2d2d52;padding:18px 24px;display:flex;align-items:center;justify-content:space-between;">
                <span style="color:white;font-size:15px;font-weight:600;">Assign a case to a Supervisor</span>
                <button onclick="closeReassignModal()" style="background:none;border:none;color:white;cursor:pointer;padding:4px;border-radius:4px;opacity:0.8;font-size:20px;line-height:1;">&times;</button>
            </div>

            <!-- Member Details Section -->
            <div style="border-bottom:1px solid #e2e8f0;">
                <div style="background:#f1f5f9;padding:10px 24px;font-size:12px;font-weight:600;color:#374151;text-transform:uppercase;letter-spacing:0.05em;border-bottom:1px solid #e2e8f0;">Member Details</div>
                <div style="padding:20px 24px;display:grid;grid-template-columns:1fr 1fr 1fr;gap:16px;" id="reassignMemberDetails">
                    <!-- Populated by JS -->
                </div>
            </div>

            <!-- Body: two-column layout -->
            <div style="padding:20px 24px;display:grid;grid-template-columns:1fr 340px;gap:24px;align-items:start;">

                <!-- Left: Supervisor table + CM table -->
                <div>
                    <!-- Supervisor Table -->
                    <div style="margin-bottom:24px;">
                        <div style="background:#f1f5f9;padding:8px 14px;font-size:12px;font-weight:600;color:#374151;border-radius:6px 6px 0 0;border:1px solid #e2e8f0;border-bottom:none;">List of Care Supervisors</div>
                        <div style="border:1px solid #e2e8f0;border-radius:0 0 6px 6px;overflow:hidden;">
                            <table style="width:100%;border-collapse:collapse;font-size:12px;">
                                <thead><tr style="background:#2d2d52;color:white;">
                                    <th style="padding:8px 12px;text-align:left;font-weight:500;">Supervisor</th>
                                    <th style="padding:8px 12px;text-align:left;font-weight:500;">Care Managers</th>
                                    <th style="padding:8px 12px;text-align:left;font-weight:500;">Aggregate Caseload</th>
                                </tr></thead>
                                <tbody id="reassignSupTable"></tbody>
                            </table>
                        </div>
                    </div>

                    <!-- CM Table -->
                    <div>
                        <div style="background:#f1f5f9;padding:8px 14px;font-size:12px;font-weight:600;color:#374151;border-radius:6px 6px 0 0;border:1px solid #e2e8f0;border-bottom:none;">Care Manager List</div>
                        <div style="border:1px solid #e2e8f0;border-radius:0 0 6px 6px;overflow:hidden;">
                            <table style="width:100%;border-collapse:collapse;font-size:12px;">
                                <thead><tr style="background:#2d2d52;color:white;">
                                    <th style="padding:8px 12px;text-align:left;font-weight:500;">Care Manager</th>
                                    <th style="padding:8px 12px;text-align:left;font-weight:500;">Certifications</th>
                                    <th style="padding:8px 12px;text-align:left;font-weight:500;">Languages</th>
                                    <th style="padding:8px 12px;text-align:left;font-weight:500;">Location</th>
                                </tr></thead>
                                <tbody id="reassignCMTable"></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Right: Assignment panels -->
                <div>
                    <!-- Supervisor panel -->
                    <div style="background:#f8fafc;border:1px solid #e2e8f0;border-radius:8px;padding:16px;margin-bottom:16px;">
                        <div style="font-size:11px;font-weight:600;color:#64748b;text-transform:uppercase;letter-spacing:0.05em;margin-bottom:10px;">Supervisor Assignment</div>
                        <div style="font-size:12px;color:#374151;margin-bottom:4px;">Supervisor</div>
                        <div id="currentSupDisplay" style="background:white;border:1px solid #e2e8f0;border-radius:6px;padding:8px 12px;font-size:13px;font-weight:500;color:#1e293b;margin-bottom:12px;"></div>
                        <div style="font-size:12px;color:#374151;margin-bottom:4px;">Assigned Date</div>
                        <div id="currentSupDate" style="background:white;border:1px solid #e2e8f0;border-radius:6px;padding:8px 12px;font-size:13px;color:#1e293b;margin-bottom:12px;"></div>
                        <div style="font-size:12px;color:#374151;margin-bottom:4px;">Re-assign the Supervisor <span style="color:#dc2626;">*</span></div>
                        <select id="newSupSelect" style="width:100%;border:1px solid #d1d5db;border-radius:6px;padding:8px 10px;font-size:13px;background:white;color:#374151;appearance:auto;">
                            <option value="">--Select--</option>
                        </select>
                        <div style="font-size:12px;color:#374151;margin-top:12px;margin-bottom:4px;">Reason for change <span style="color:#dc2626;">*</span></div>
                        <textarea id="supReasonInput" placeholder="e.g. CM on leave, caseload rebalancing, member requested change" style="width:100%;border:1px solid #d1d5db;border-radius:6px;padding:8px 10px;font-size:12px;color:#374151;resize:vertical;min-height:64px;box-sizing:border-box;font-family:inherit;"></textarea>
                        <div id="supReasonError" style="display:none;font-size:11px;color:#dc2626;margin-top:3px;">Reason for change is required.</div>
                        <button onclick="doReassignSupervisor()" style="margin-top:10px;width:100%;background:#353182;color:white;border:none;border-radius:6px;padding:10px;font-size:13px;font-weight:600;cursor:pointer;">Assign</button>
                    </div>

                    <!-- CM panel -->
                    <div style="background:#f8fafc;border:1px solid #e2e8f0;border-radius:8px;padding:16px;">
                        <div style="font-size:11px;font-weight:600;color:#64748b;text-transform:uppercase;letter-spacing:0.05em;margin-bottom:10px;">Care Manager Assignment</div>
                        <div style="font-size:12px;color:#374151;margin-bottom:4px;">Care Manager</div>
                        <div id="currentCMDisplay" style="background:white;border:1px solid #e2e8f0;border-radius:6px;padding:8px 12px;font-size:13px;font-weight:500;color:#1e293b;margin-bottom:12px;"></div>
                        <div style="font-size:12px;color:#374151;margin-bottom:4px;">Assigned Date</div>
                        <div id="currentCMDate" style="background:white;border:1px solid #e2e8f0;border-radius:6px;padding:8px 12px;font-size:13px;color:#1e293b;margin-bottom:12px;"></div>
                        <div style="font-size:12px;color:#374151;margin-bottom:4px;">Re-assign the Care Manager</div>
                        <select id="newCMSelect" style="width:100%;border:1px solid #d1d5db;border-radius:6px;padding:8px 10px;font-size:13px;background:white;color:#374151;appearance:auto;">
                            <option value="">--Select--</option>
                        </select>
                        <div style="font-size:12px;color:#374151;margin-top:12px;margin-bottom:4px;">Reason for change <span style="color:#dc2626;">*</span></div>
                        <textarea id="cmReasonInput" placeholder="e.g. CM on leave, caseload rebalancing, member requested change" style="width:100%;border:1px solid #d1d5db;border-radius:6px;padding:8px 10px;font-size:12px;color:#374151;resize:vertical;min-height:64px;box-sizing:border-box;font-family:inherit;"></textarea>
                        <div id="cmReasonError" style="display:none;font-size:11px;color:#dc2626;margin-top:3px;">Reason for change is required.</div>
                        <button onclick="doReassignCM()" style="margin-top:10px;width:100%;background:#353182;color:white;border:none;border-radius:6px;padding:10px;font-size:13px;font-weight:600;cursor:pointer;">Assign</button>
                    </div>
                </div>
            </div>

            <!-- Footer -->
            <div style="padding:14px 24px;border-top:1px solid #e2e8f0;text-align:center;">
                <button onclick="closeReassignModal()" style="background:white;border:1px solid #d1d5db;border-radius:6px;padding:8px 28px;font-size:13px;color:#374151;cursor:pointer;">Close</button>
            </div>
        </div>
    </div>
</div>


<script>
// 
// THREE-DOT ROW MENU
// 
function toggleMemberRowMenu(btn, memberId) {
    const dropdown = document.getElementById('row-menu-' + memberId);
    if (!dropdown) return;
    const isOpen = dropdown.classList.contains('open');
    // Close all open menus first
    document.querySelectorAll('.three-dot-dropdown.open').forEach(d => d.classList.remove('open'));
    if (!isOpen) dropdown.classList.add('open');
}
document.addEventListener('click', function(e) {
    if (!e.target.closest('.three-dot-menu')) {
        document.querySelectorAll('.three-dot-dropdown.open').forEach(d => d.classList.remove('open'));
    }
});

// 
// REASSIGN MODAL  
// 
var _reassignMemberId = null;

const MOCK_SUPERVISORS_LIST = [
    { name: 'Erica Richardson',  cmsCount: 4, caseload: 122 },
    { name: 'Sarah Mitchell',    cmsCount: 3, caseload: 98  },
    { name: 'David Brown',       cmsCount: 5, caseload: 246 },
    { name: 'James Whitfield',   cmsCount: 2, caseload: 67  },
    { name: 'Linda Patel',       cmsCount: 3, caseload: 104 },
    { name: 'Naresh K M',        cmsCount: 1, caseload: 27  },
    { name: 'Sri Supervisor',    cmsCount: 2, caseload: 44  },
    { name: 'Sam Supervisor',    cmsCount: 1, caseload: 10  }
];

const MOCK_CM_LIST = [
    { name: 'Jennifer Wilson',   certifications: 'CCM',  languages: 'English', location: 'Raleigh' },
    { name: 'Michael Chen',      certifications: '',     languages: 'English, Mandarin', location: 'Durham' },
    { name: 'Sarah Johnson',     certifications: 'CHW',  languages: 'English, Spanish', location: 'Charlotte' },
    { name: 'Jazimyn Williams',  certifications: '',     languages: 'English', location: 'Raleigh' },
    { name: 'Lucille Barberian', certifications: 'CCM',  languages: 'English', location: 'Cary' },
    { name: 'Madeline Patrick',  certifications: '',     languages: 'English', location: 'Durham' },
    { name: 'Aziz Gida',         certifications: 'BHI',  languages: 'English', location: 'Raleigh' }
];

function openReassignModal(memberId) {
    // Stop any event bubbling & close row menus
    document.querySelectorAll('.three-dot-dropdown.open').forEach(d => d.classList.remove('open'));
    // Small delay so the row click guard fires first
    setTimeout(function() {

    // Find member from membersDB (the global data store)
    const member = (typeof membersDB !== 'undefined' ? membersDB : []).find(m => m.id === memberId)
                || window.currentMember;
    if (!member) { console.warn('openReassignModal: member not found for id', memberId); return; }
    _reassignMemberId = memberId;

    // Member details panel
    const detailsEl = document.getElementById('reassignMemberDetails');
    if (detailsEl) {
        detailsEl.innerHTML = `
            <div style="background:white;border:1px solid #e2e8f0;border-radius:8px;padding:16px;">
                <div style="font-size:13px;font-weight:600;color:#1e293b;border-bottom:1px solid #e2e8f0;padding-bottom:8px;margin-bottom:10px;">Identity</div>
                <div style="font-size:12px;color:#374151;margin-bottom:5px;"><strong>Name:</strong> ${member.name}</div>
                <div style="font-size:12px;color:#374151;margin-bottom:5px;"><strong>DOB:</strong> ${member.dob || 'N/A'}</div>
                <div style="font-size:12px;color:#374151;margin-bottom:5px;"><strong>Age:</strong> ${member.age || 'N/A'} years</div>
                <div style="font-size:12px;color:#374151;margin-bottom:5px;"><strong>Medicaid ID:</strong> ${member.medicaidId || member.id}</div>
                <div style="font-size:12px;color:#374151;"><strong>MRN:</strong> ${member.mrn || 'N/A'}</div>
            </div>
            <div style="background:white;border:1px solid #e2e8f0;border-radius:8px;padding:16px;">
                <div style="font-size:13px;font-weight:600;color:#1e293b;border-bottom:1px solid #e2e8f0;padding-bottom:8px;margin-bottom:10px;">Contact Information</div>
                <div style="font-size:12px;color:#374151;margin-bottom:5px;"><strong>Phone Number:</strong> ${member.cellPhone || member.homePhone || ''}</div>
                <div style="font-size:12px;color:#374151;margin-bottom:5px;"><strong>Email:</strong> ${member.email || ''}</div>
                <div style="font-size:12px;color:#374151;margin-bottom:5px;"><strong>Address:</strong> ${member.address || ''}, ${member.city || ''}</div>
                <div style="font-size:12px;color:#374151;margin-bottom:5px;"><strong>County:</strong> ${member.county || ''}</div>
                <div style="font-size:12px;color:#374151;"><strong>Language Preference:</strong> ${(member.communication && member.communication.preferredLanguage) || ''}</div>
            </div>
            <div style="background:white;border:1px solid #e2e8f0;border-radius:8px;padding:16px;">
                <div style="font-size:13px;font-weight:600;color:#1e293b;border-bottom:1px solid #e2e8f0;padding-bottom:8px;margin-bottom:10px;">Eligibility & Enrollment</div>
                <div style="font-size:12px;color:#374151;margin-bottom:5px;"><strong>Plan Type:</strong> ${member.planType || 'Tailored Plan'}</div>
                <div style="font-size:12px;color:#374151;margin-bottom:5px;"><strong>Plan Name:</strong> ${member.planName || ''}</div>
                <div style="font-size:12px;color:#374151;margin-bottom:5px;"><strong>Plan Administrator:</strong> ${member.mco || ''}</div>
                <div style="font-size:12px;color:#374151;margin-bottom:5px;"><strong>Home County:</strong> ${member.county || ''}</div>
                <div style="font-size:12px;color:#374151;"><strong>Population:</strong> ${(member.priorityPopulations && member.priorityPopulations[0]) || ''}</div>
            </div>
        `;
    }

    // Current assignment
    const current = (member.cmAssignmentHistory || []).find(r => r.isCurrent) || {};
    const currentSup = current.supervisorName || member.supervisor || '';
    const currentSupDate = current.supervisorAssignedDate || (member.careMgmtStart ? new Date(member.careMgmtStart).toLocaleDateString() : '');
    const currentCM = current.careManagerName || member.careManager || '';
    const currentCMDate = current.careManagerAssignedDate || (member.careMgmtStart ? new Date(member.careMgmtStart).toLocaleDateString() : '');

    document.getElementById('currentSupDisplay').textContent = currentSup;
    document.getElementById('currentSupDate').textContent = currentSupDate;
    document.getElementById('currentCMDisplay').textContent = currentCM;
    document.getElementById('currentCMDate').textContent = currentCMDate;

    // Supervisor table
    const supTbody = document.getElementById('reassignSupTable');
    if (supTbody) {
        supTbody.innerHTML = MOCK_SUPERVISORS_LIST.map(function(s, i) {
            return '<tr style="border-bottom:1px solid #f1f5f9;' + (i % 2 === 0 ? '' : 'background:#f8fafc;') + '">'
                + '<td style="padding:8px 12px;color:#1e293b;">' + s.name + '</td>'
                + '<td style="padding:8px 12px;color:#374151;">' + s.cmsCount + '</td>'
                + '<td style="padding:8px 12px;color:#374151;">' + s.caseload + '</td>'
                + '</tr>';
        }).join('');
    }

    // CM table
    const cmTbody = document.getElementById('reassignCMTable');
    if (cmTbody) {
        cmTbody.innerHTML = MOCK_CM_LIST.map(function(cm, i) {
            return '<tr style="border-bottom:1px solid #f1f5f9;' + (i % 2 === 0 ? '' : 'background:#f8fafc;') + '">'
                + '<td style="padding:8px 12px;color:#1e293b;">' + cm.name + '</td>'
                + '<td style="padding:8px 12px;color:#374151;">' + cm.certifications + '</td>'
                + '<td style="padding:8px 12px;color:#374151;">' + cm.languages + '</td>'
                + '<td style="padding:8px 12px;color:#374151;">' + cm.location + '</td>'
                + '</tr>';
        }).join('');
    }

    // Supervisor dropdown
    const supSelect = document.getElementById('newSupSelect');
    if (supSelect) {
        supSelect.innerHTML = '<option value="">--Select--</option>'
            + MOCK_SUPERVISORS_LIST.filter(s => s.name !== currentSup).map(function(s) {
                return '<option value="' + s.name + '">' + s.name + '</option>';
            }).join('');
    }

    // CM dropdown
    const cmSelect = document.getElementById('newCMSelect');
    if (cmSelect) {
        cmSelect.innerHTML = '<option value="">--Select--</option>'
            + MOCK_CM_LIST.filter(cm => cm.name !== currentCM).map(function(cm) {
                return '<option value="' + cm.name + '">' + cm.name + '</option>';
            }).join('');
    }

    document.getElementById('reassignModal').style.display = 'block';
    }, 10); // end setTimeout
}

function closeReassignModal() {
    document.getElementById('reassignModal').style.display = 'none';
    _reassignMemberId = null;
    // Clear reason fields and errors
    ['supReasonInput','cmReasonInput'].forEach(function(id) {
        const el = document.getElementById(id);
        if (el) { el.value = ''; el.style.borderColor = '#d1d5db'; }
    });
    ['supReasonError','cmReasonError'].forEach(function(id) {
        const el = document.getElementById(id);
        if (el) el.style.display = 'none';
    });
}

// Close on backdrop click
document.getElementById('reassignModal') && document.getElementById('reassignModal').addEventListener('click', function(e) {
    if (e.target === this) closeReassignModal();
});

function _getToday() {
    return new Date().toLocaleDateString('en-US', { month: '2-digit', day: '2-digit', year: 'numeric' });
}

function _pushHistoryRecord(member, newSup, newCM, reason) {
    if (!member.cmAssignmentHistory) member.cmAssignmentHistory = [];
    const today = _getToday();

    // Resolve real values from all available sources  never allow undefined
    const current = member.cmAssignmentHistory.find(r => r.isCurrent);
    const resolvedSup = (current && current.supervisorName && current.supervisorName !== 'undefined')
        ? current.supervisorName
        : (member.supervisor || member.careTeamData?.supervisor || 'Sarah Mitchell');
    const resolvedCM  = (current && current.careManagerName && current.careManagerName !== 'undefined')
        ? current.careManagerName
        : (member.careManager || member.careTeamData?.primary || 'Jennifer Wilson');

    // Close out the current record
    if (current) {
        current.isCurrent = false;
        // Also heal any undefined values in the record being closed
        if (!current.supervisorName || current.supervisorName === 'undefined') current.supervisorName = resolvedSup;
        if (!current.careManagerName || current.careManagerName === 'undefined') current.careManagerName = resolvedCM;
        if (newSup && !current.supervisorEndDate) current.supervisorEndDate = today;
        if (newCM  && !current.careManagerEndDate) current.careManagerEndDate = today;
    }

    const newRecord = {
        isCurrent: true,
        supervisorName:          newSup || resolvedSup,
        supervisorAssignedDate:  newSup ? today : (current?.supervisorAssignedDate || today),
        supervisorEndDate:       null,
        careManagerName:         newCM  || resolvedCM,
        careManagerAssignedDate: newCM  ? today : (current?.careManagerAssignedDate || today),
        careManagerEndDate:      null,
        consentStatus:           member.consentStatus || 'Consented',
        consentDate:             current?.consentDate || today,
        optOutDate:              null,
        notes: reason || ((newSup ? 'Supervisor re-assigned to ' + newSup + '. ' : '') + (newCM ? 'CM re-assigned to ' + newCM + '.' : ''))
    };
    member.cmAssignmentHistory.push(newRecord);
    return newRecord;
}

function _refreshAllHistoryViews(member) {
    // 1. Update header Other Information > CM Details slot (if this member is loaded)
    if (window.currentMember && window.currentMember.id === member.id) {
        const slot = document.getElementById('cm-details-in-other-info');
        if (slot && typeof CMAssignmentHistoryController !== 'undefined') {
            slot.innerHTML = CMAssignmentHistoryController.renderCMDetailsSection(member);
        }
        // 2. Update Option 2 standalone tab if visible
        const pane2 = document.querySelector('.tab-pane[data-pane="assignment-history"]');
        if (pane2 && typeof CMAssignmentHistoryController !== 'undefined') {
            pane2.innerHTML = CMAssignmentHistoryController.render(member);
        }
        // 3. Update Option 3 sub-tab if visible
        const area3 = document.getElementById('assignment-history-area');
        if (area3 && typeof CMAssignmentHistoryController !== 'undefined') {
            area3.innerHTML = CMAssignmentHistoryController.renderOption3(member);
        }
    }
}

function _showToast(msg, color) {
    color = color || '#10b981';
    var t = document.createElement('div');
    t.style.cssText = 'position:fixed;bottom:28px;left:50%;transform:translateX(-50%);background:' + color + ';color:white;padding:12px 24px;border-radius:8px;font-size:13px;font-weight:600;z-index:99999;box-shadow:0 4px 16px rgba(0,0,0,0.18);transition:opacity 0.4s;pointer-events:none;';
    t.textContent = msg;
    document.body.appendChild(t);
    setTimeout(function() { t.style.opacity = '0'; setTimeout(function() { t.remove(); }, 400); }, 2800);
}

function doReassignSupervisor() {
    const newSup = document.getElementById('newSupSelect').value;
    const reason = (document.getElementById('supReasonInput').value || '').trim();
    const reasonErr = document.getElementById('supReasonError');

    if (!newSup) { _showToast('Please select a supervisor first.', '#ef4444'); return; }
    if (!reason) {
        reasonErr.style.display = 'block';
        document.getElementById('supReasonInput').style.borderColor = '#dc2626';
        return;
    }
    reasonErr.style.display = 'none';
    document.getElementById('supReasonInput').style.borderColor = '#d1d5db';

    const member = (typeof membersDB !== 'undefined' ? membersDB : []).find(m => m.id === _reassignMemberId)
                || window.currentMember;
    if (!member) return;

    // Update live fields
    member.supervisor = newSup;

    // Push history
    _pushHistoryRecord(member, newSup, null, reason);

    // Refresh displays
    _refreshAllHistoryViews(member);

    // Update right panel in modal
    const current = member.cmAssignmentHistory.find(r => r.isCurrent) || {};
    document.getElementById('currentSupDisplay').textContent = newSup;
    document.getElementById('currentSupDate').textContent = _getToday();

    // Refresh supervisor dropdown (remove newly assigned one)
    const supSelect = document.getElementById('newSupSelect');
    if (supSelect) {
        supSelect.innerHTML = '<option value="">--Select--</option>'
            + MOCK_SUPERVISORS_LIST.filter(s => s.name !== newSup).map(function(s) {
                return '<option value="' + s.name + '">' + s.name + '</option>';
            }).join('');
    }

    _showToast(' Supervisor re-assigned to ' + newSup);
    setTimeout(closeReassignModal, 800);
}

function doReassignCM() {
    const newCM = document.getElementById('newCMSelect').value;
    const reason = (document.getElementById('cmReasonInput').value || '').trim();
    const reasonErr = document.getElementById('cmReasonError');

    if (!newCM) { _showToast('Please select a care manager first.', '#ef4444'); return; }
    if (!reason) {
        reasonErr.style.display = 'block';
        document.getElementById('cmReasonInput').style.borderColor = '#dc2626';
        return;
    }
    reasonErr.style.display = 'none';
    document.getElementById('cmReasonInput').style.borderColor = '#d1d5db';

    const member = (typeof membersDB !== 'undefined' ? membersDB : []).find(m => m.id === _reassignMemberId)
                || window.currentMember;
    if (!member) return;

    // Update live fields
    member.careManager = newCM;

    // Push history
    _pushHistoryRecord(member, null, newCM, reason);

    // Refresh displays
    _refreshAllHistoryViews(member);

    // Update right panel in modal
    document.getElementById('currentCMDisplay').textContent = newCM;
    document.getElementById('currentCMDate').textContent = _getToday();

    // Refresh CM dropdown
    const cmSelect = document.getElementById('newCMSelect');
    if (cmSelect) {
        cmSelect.innerHTML = '<option value="">--Select--</option>'
            + MOCK_CM_LIST.filter(cm => cm.name !== newCM).map(function(cm) {
                return '<option value="' + cm.name + '">' + cm.name + '</option>';
            }).join('');
    }

    _showToast(' Care Manager re-assigned to ' + newCM);
    setTimeout(closeReassignModal, 800);
}
</script>

</body>
</html>